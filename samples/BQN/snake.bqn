# ============================================================
# This code is part of the "rayed-lib" open source project avaiable at:
#
#      https://github.com/Brian-ED/rayed-bqn
#
# This code is licensed under the MIT License.  You may obtain a
# copy of the License at:
#
#      https://spdx.org/licenses/MIT.html
# ============================================================

# My highscore is 112... beat that!
âŸ¨câ‡color,window,draw,kâ‡keyâŸ©â†râ†â€¢Import "../../raylib.bqn"
textSize â† 100
size â† 15
nonDarkModeâ€¿darkMode â† {
  âŸ¨text, fruit, snake, lines, backgroundâŸ© â‡ ğ•©
}Â¨{
  yellow â† 255â€¿200â€¿0â€¿255
  âŸ¨c.blackâ€¿c.redâ€¿c.blue â€¿c.whiteâ€¿yellow
   âŒˆc.whiteâ€¿c.redâ€¿c.greenâ€¿c.whiteâ€¿c.blackÃ·1.3âŸ© # divided to lower intencity
}

LoadConsts â† {ğ•Š:{
  winSize       â‡ window.GetSize@
  textPixelSize â‡ r.rayFFI.MeasureTextÂ¨textSizeâ‹ˆËœÂ¨"Paused"â€¿"GAME OVER"
  tileSize      â‡ âŒŠwinSizeâŒŠÂ´âŠ¸Ã·size+2
  lines         â‡ â‰Â´Ë˜âŒ½Â¨âŠ¸âˆ¾(âŠ¢âˆ¾âŒœ2â†‘1âŒ½â¼âŠ¢)tileSizeÃ—1+â†•1+size # Line drawing positions
  font          â‡ r.font.LoadBQN 100
}}
OnStart â† {ğ•¤
  frame â† 0 â‹„ speed â† 10
  # 0 is gameOver, 1 is playing, 2 is paused
  gameState â† 1
  # List of xâ€¿y positions of the snake
  snake â† [0â€¿0]
  fruit â† 2 â€¢rand.Range size
  # 0â€¿1 up, 1â€¿0 right, 0â€¿Â¯1 down, Â¯1â€¿0 left
  # first in list is the current facing, pressing right 1âŒ½ pressing left 1âŒ½â¼
  facing â† [1â€¿0, 0â€¿Â¯1, Â¯1â€¿0, 0â€¿1]
  # buffer for key presses
  buffer â† âŸ¨âŸ©
  palete â† nonDarkMode
  gameStateâ€¿frameâ€¿snakeâ€¿fruitâ€¿facingâ€¿speedâ€¿bufferâ€¿palete
}
PerGameFrame â† {ğ•ŠgameStateâ€¿snakeâ€¿fruitâ€¿facingâ€¿buffer:
  SpawnFruit    â† {â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘(<Ë˜ğ•¨)(Â¬âˆ˜âˆŠËœ/âŠ¢)â¥Šâ†•2â¥Šsize}
  nowFacing     â† facingâŒ½Ëœ-Â´k.leftâ€¿k.right=âŠ‘1â†‘buffer
  extendedSnake â† nowfacing(âŠ¢âˆ¾Ëœsize|+â—‹âŠ)snake
  newFruit      â† extendedSnake SpawnFruitâŸ(âŠâŠ¸â‰¡) fruit
  cutSnake      â† Â¯1âŠ¸â†“âŸ(newFruitâ‰¡fruit)extendedSnake
  âŸ¨
    gameStateÃ—â·âŠ¸â‰¡cutSnake # gameState
    cutSnake              # snake
    newFruit              # fruit
    nowFacing             # facing
    1â†“2â†‘buffer            # reset buffer
  âŸ©
}âŒ¾(0â€¿2â€¿3â€¿4â€¿6âŠ¸âŠ)
PerFrame â†{conğ•ŠâŸ¨gameState,frame,snake,fruit,facing,speed,buffer,palâŸ©:
  pauseP â† k.right_shift = key â† k.PressedKey@
  c.blackâ€¿con.fontâ€¿40 draw.Text 10â€¿10â‹ˆâ€¢Repr Â¯1+â‰ snake
  âŠ‘â—¶âŸ¨ # each function is one scene
    {
      pal.textâ€¿con.fontâ€¿textSize draw.Text "GAME OVER"â‹ˆËœ2â¥Š2Ã·Ëœcon.winSize-1âŠ‘con.textPixelSize
      palâŒ¾(7âŠ‘âŠ¢)OnStartâŸpauseP ğ•© # nums mean values to reset
    }
    PerGameFrameâŸ(1=speed|frame) {ğ•¤
      c.whiteâŠ¸draw.LineË˜con.lines
      pal.fruit draw.Rectangle +`(1+con.tileSizeÃ—1+fruit)â‰2â¥Šcon.tileSize-2
      pal.snakeâŠ¸draw.RectangleâŸœâ‰Ë˜(con.tileSize-2)(â‰+â‰âŠ¢)Ë˜1+con.tileSizeÃ—1+snake
      âŸ¨frame+1
       2âŒˆspeed+-Â´key=k.downâ€¿k.up        # speed
       keyâˆ¾âŸ(âŠ‘âˆŠâŸœk.leftâ€¿k.right) bufferâŸ© # Key buffer
    }âŒ¾(1â€¿5â€¿6âŠ¸âŠ)
    {
      pauseTextâ†"Paused, d for dark"
      pal.textâ€¿con.fontâ€¿(textSize) draw.Text (2Ã·Ëœcon.winSize-con.textPixelSizeâŠ‘âŠ¸âˆ¾textSize)â€¿pauseText

      {ğ•©â‰¡nonDarkMode?darkMode;nonDarkMode}âŒ¾(7âŠ‘âŠ¢)âŸ(key=k.d)ğ•©
    }
  âŸ©  {1:2;2:1;ğ•©}âŸpausePâŒ¾âŠ‘ ğ•©
} draw._withCanvas_ {(7âŠ‘ğ•©).background}

Game â† LoadConsts PerFrameâ€¢_While_(Â¬window.ShouldClose) OnStart
Game window._openAs "Snake"
