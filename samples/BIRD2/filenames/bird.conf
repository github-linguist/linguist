# Basic BIRD2 configuration file for BIRD 2

router id 192.168.1.1;
log    syslog all;
debug  protocols all;

# Community list definition
define LOCAL_PREF_HIGH = [(65001,100), (65001,200)];
define AS_PATH_FILTER = [= 65001 65002 * =];
define MY_ASN = 65001;
define TEST_STR = "test";
define PREFIX_LIST = [
  10.0.0.0/8+,
  172.16.0.0/12+,
  192.168.0.0/16+,
  2001::/32{33,128}
];

# Define a protocol
protocol static static_routes {
  ipv4 {
    table  master4;
    export all;
    import none;
  }

  route 10.0.0.0/8 via 192.168.1.254;
  route 172.16.0.0/12 blackhole;
}

# BGP protocol with AS path filtering
protocol bgp peer1 {
  local    as 65001;
  neighbor 192.168.1.2 as 65002;

  ipv4 {
    export filter {
      if     bgp_path ~ [= * 65003 * =] then reject;
      accept;
    }

    import all;
  }
}

# OSPF protocol
protocol ospf v2 ospf1 {
  ipv4 {
    export all;
  }

  area 0 {
    interface "eth0" {
      hello 10;
    }
  }
}

protocol bgp Upstream {
  local    as 65001;
  neighbor 203.0.113.1 as 174;

  ipv4 {
    import filter {
      if     bgp_path ~ AS_PATH_FILTER then reject;
      accept;
    }

    export filter export_filter;
  }
}

protocol kernel Kernel {
  ipv4;
  scan time 10;
}

# Filter and function definitions
function is_private_network() -> bool {
  if     net ~ [ 10.0.0.0/8+, 172.16.0.0/12+, 192.168.0.0/16+ ] then return true;
  return false;
}

filter export_filter {
  if is_private_network() then reject;
  if bgp_path.len > 10 then reject;

  if bgp_community ~ [(65001,100)] then {
    bgp_local_pref = 200;
    accept;
  }

  accept;
}

protocol bgp uplink {
  local    as 65001;
  neighbor 203.0.113.1 as 174;

  ipv4 {
    import filter {
      if     bgp_path ~ AS_PATH_FILTER then reject;
      accept;
    }

    export filter export_filter;
  }
}

# ================================================================
# Basic BIRD2 configuration file for BIRD 2 & function definitions

define BOGON_ASNS = [
  0,                      # RFC 7607
  23456,                  # RFC 4893 AS_TRANS
  64496..64511,           # RFC 5398 and documentation/example ASNs
  64512..65534,           # RFC 6996 Private ASNs
  65535,                  # RFC 7300 Last 16 bit ASN
  65536..65551,           # RFC 5398 and documentation/example ASNs
  65552..131071,          # RFC IANA reserved ASNs
  4200000000..4294967294, # Private ASNs
  4294967295              # RFC 7300 Last 32 bit ASN
];
define TIER_1_ASNS = [
  174, # Cogent
  701, # Verizon
  1299, # Telia
  2914, # NTT
  3257, # GTT
  3356, # Level3 (CenturyLink), Lumen
  3320, # DTAG
  3491, # PCCW Global
  5511, # Orange
  6453, # Tata
  6461, # Zayo
  6762, # Sparkle
  6830, # Liberty Global
  6939, # Hurricane Electric (IPv6 only)
  7018, # AT&T
  7922, # Comcast
  12956 # Telefonica
];
define BOGON_PREFIXES_V4 = [
  0.0.0.0/8+,             # RFC 1122 'this' network
  10.0.0.0/8+,            # RFC 1918 private space
  100.64.0.0/10+,         # RFC 6598 Carrier grade nat space
  127.0.0.0/8+,           # RFC 1122 localhost
  169.254.0.0/16+,        # RFC 3927 link local
  172.16.0.0/12+,         # RFC 1918 private space
  192.0.2.0/24,           # RFC 5737 TEST-NET-1
  192.88.99.0/24,         # RFC 7526 deprecated 6to4 relay anycast.
  192.168.0.0/16+,        # RFC 1918 private space
  198.18.0.0/15+,         # RFC 2544 benchmarking
  198.51.100.0/24,        # RFC 5737 TEST-NET-2
  203.0.113.0/24,         # RFC 5737 TEST-NET-3
  224.0.0.0/4+,           # multicast
  240.0.0.0/4+            # reserved
];
define BOGON_PREFIXES_V6 = [
  ::/8+,                  # RFC 4291 IPv4-compatible, loopback, et al
  0064:ff9b::/96+,        # RFC 6052 IPv4/IPv6 Translation
  0064:ff9b:1::/48+,      # RFC 8215 Local-Use IPv4/IPv6 Translation
  0100::/64+,             # RFC 6666 Discard-Only
  2001::/32{33,12},
  2001:2::/48+,           # RFC 5180 BMWG
  2001:10::/28+,          # RFC 4843 ORCHID
  2001:db8::/32+,         # RFC 3849 documentation
  2002::/16+,             # RFC 7526 deprecated 6to4 relay anycast.
  3ffe::/16+,
  5f00::/8+,              # RFC 3701 old 6bone
  fc00::/7+,              # RFC 4193 unique local unicast
  fe80::/10+,             # RFC 4291 link local unicast
  fec0::/10+,             # RFC 3879 old site local unicast
  ff00::/8+               # RFC 4291 multicast
];

function is_bogon_prefix() -> bool {
  case net.type {
    NET_IP4: return net ~ BOGON_PREFIXES_V4;
    NET_IP6: return net ~ BOGON_PREFIXES_V6;
    else:    print "is_bogon_prefix: unexpected net.type ", net.type, " ", net;
    return   false;
  }
}

function net_len_too_long() -> bool {
  case net.type {
    NET_IP4: return net.len > 24;
    NET_IP6: return net.len > 48;
    else:    print "net_len_too_long: unexpected net.type ", net.type, " ", net;
    return   false;
  }
}

function is_bogon_asn() -> bool {
  if     bgp_path ~ BOGON_ASNS then return true;
  return false;
}

function is_no_tier1_asn() -> bool {
  if     bgp_path ~ TIER_1_ASNS then return false;
  return true;
}

function is_bogon() -> bool {
  if net_len_too_long() then return true;
  if is_bogon_prefix() then return true;
  if source = RTS_BGP && is_bogon_asn() then return true;
}

# =====================================================================
# Advanced BGP configuration test file for BIRD 1 & IPv6 (`bird6.conf`)

protocol bgp pub_Tier1_v6 from pub_ebgp_v6 {
    source address 2001:db8::1;
    neighbor 2001:db8::2 % 'ens19' as 65000;
    cost 10;
    import filter {
        if !ebgp_import(65000, "upstream", 2, prefix_all_v6, [0]) then reject;
        accept;
    };
    export where ebgp_export(65000, "upstream", 2, prefix_all_v6, [0]);
    import limit 99999999 action block;
};

protocol bgp pub_IXP_v6 from pub_ebgp_v6 {
    source address 2001:db8::100;
    neighbor 2001:db8::101 % 'ens19' as 65001;
    cost 15;
    import filter {
        if bgp_path ~ [65000] then reject;
        ebgp_import(65001, "upstream", 1, prefix_all_v6, [0]);
        accept;
    };
    export where ebgp_export(65001, "upstream", 1, prefix_all_v6, [0]);
    import limit 99999999 action block;
};