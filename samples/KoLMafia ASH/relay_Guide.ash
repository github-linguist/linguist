//This script and its support scripts are in the public domain.

since 20.6;
//These settings are for development. Don't worry about editing them.
string __version = "2.0.2";

//Debugging:
boolean __setting_debug_mode = false;
boolean debug = __setting_debug_mode; //if (debug)
boolean __setting_debug_enable_example_mode_in_aftercore = false; //for testing. Will give false information, so don't enable
boolean __setting_debug_show_all_internal_states = false; //displays usable images/__misc_state/__misc_state_string/__misc_state_int/__quest_state

//Display settings:
boolean __setting_entire_area_clickable = false;
boolean __setting_side_negative_space_is_dark = true;
boolean __setting_newstyle_navbars = true;
boolean __setting_fill_vertical = true;
int __setting_image_width_large = 50;
int __setting_image_width_medium = 50;
int __setting_image_width_small = 30;

boolean __show_importance_bar = true;
boolean __setting_show_navbar = true;
boolean __setting_navbar_has_proportional_widths = false; //doesn't look very good, remove?
boolean __setting_gray_navbar = true;
boolean __use_table_based_layouts = false; //backup implementation. not compatible with media queries. consider removing?
boolean __use_flexbox_on_checklists = true;
boolean __enable_showhide_feature = true;

boolean __setting_use_kol_css = false; //images/styles.css
boolean __setting_show_location_bar = true;
boolean __setting_enable_location_popup_box = true;
boolean __setting_location_bar_uses_last_location = false; //nextAdventure otherwise
boolean __setting_location_bar_fixed_layout = true;
boolean __setting_location_bar_limit_max_width = true;
float __setting_location_bar_max_width_per_entry = 0.35;
boolean __setting_small_size_uses_full_width = false; //implemented, but disabled - doesn't look amazing. reduced indention width instead to compensate
boolean __setting_enable_outputting_all_numberology_options = true;

string __setting_unavailable_colour = "#7F7F7F";
string __setting_line_colour = "#B2B2B2";
string __setting_dark_colour = "#C0C0C0";
string __setting_modifier_colour = "#404040";
string __setting_navbar_background_colour = "#FFFFFF";
string __setting_page_background_colour = "#F7F7F7";

string __setting_media_query_large_size = "@media (min-width: 500px)";
string __setting_media_query_medium_size = "@media (min-width: 350px) and (max-width: 500px)";
string __setting_media_query_small_size = "@media (max-width: 350px) and (min-width: 225px)";
string __setting_media_query_tiny_size = "@media (max-width: 225px)";

float __setting_navbar_height_in_em = 2.3;
string __setting_navbar_height = __setting_navbar_height_in_em + "em";
int __setting_horizontal_width = 600;
boolean __setting_ios_appearance = false; //no don't
string __relay_filename;

//Allows error checking. The intention behind this design is Errors are passed in to a method. The method then sets the error if anything went wrong.
record Error
{
	boolean was_error;
	string explanation;
};

Error ErrorMake(boolean was_error, string explanation)
{
	Error err;
	err.was_error = was_error;
	err.explanation = explanation;
	return err;
}

Error ErrorMake()
{
	return ErrorMake(false, "");
}

void ErrorSet(Error err, string explanation)
{
	err.was_error = true;
	err.explanation = explanation;
}

void ErrorSet(Error err)
{
	ErrorSet(err, "Unknown");
}

//Coordinate system is upper-left origin.

int INT32_MAX = 2147483647;



float clampf(float v, float min_value, float max_value)
{
	if (v > max_value)
		return max_value;
	if (v < min_value)
		return min_value;
	return v;
}

float clampNormalf(float v)
{
	return clampf(v, 0.0, 1.0);
}

int clampi(int v, int min_value, int max_value)
{
	if (v > max_value)
		return max_value;
	if (v < min_value)
		return min_value;
	return v;
}

float clampNormali(int v)
{
	return clampi(v, 0, 1);
}

//random() will halt the script if range is <= 1, which can happen when picking a random object out of a variable-sized list.
//There's also a hidden bug where values above 2147483647 will be treated as zero.
int random_safe(int range)
{
	if (range < 2 || range > 2147483647)
		return 0;
	return random(range);
}

float randomf()
{
    return random_safe(2147483647).to_float() / 2147483647.0;
}

//to_int will print a warning, but not halt, if you give it a non-int value.
//This function prevents the warning message.
//err is set if value is not an integer.
int to_int_silent(string value, Error err)
{
    //to_int() supports floating-point values. is_integer() will return false.
    //So manually strip out everything past the dot.
    //We probably should just ask for to_int() to be silent in the first place.
    int dot_position = value.index_of(".");
    if (dot_position != -1 && dot_position > 0) //two separate concepts - is it valid, and is it past the first position. I like testing against both, for safety against future changes.
    {
        value = value.substring(0, dot_position);
    }
    
	if (is_integer(value))
        return to_int(value);
    ErrorSet(err, "Unknown integer \"" + value + "\".");
	return 0;
}

int to_int_silent(string value)
{
	return to_int_silent(value, ErrorMake());
}

//Silly conversions in case we chose the wrong function, removing the need for a int -> string -> int hit.
int to_int_silent(int value)
{
    return value;
}

int to_int_silent(float value)
{
    return value;
}


float sqrt(float v, Error err)
{
    if (v < 0.0)
    {
        ErrorSet(err, "Cannot take square root of value " + v + " less than 0.0");
        return -1.0; //mathematically incorrect, but prevents halting. should return NaN
    }
	return square_root(v);
}

float sqrt(float v)
{
    return sqrt(v, ErrorMake());
}

float fabs(float v)
{
    if (v < 0.0)
        return -v;
    return v;
}

int abs(int v)
{
    if (v < 0)
        return -v;
    return v;
}

int ceiling(float v)
{
	return ceil(v);
}

int pow2i(int v)
{
	return v * v;
}

float pow2f(float v)
{
	return v * v;
}

//x^p
float powf(float x, float p)
{
    return x ** p;
}

//x^p
int powi(int x, int p)
{
    return x ** p;
}

record Vec2i
{
	int x; //or width
	int y; //or height
};

Vec2i Vec2iMake(int x, int y)
{
	Vec2i result;
	result.x = x;
	result.y = y;
	
	return result;
}

Vec2i Vec2iCopy(Vec2i v)
{
    return Vec2iMake(v.x, v.y);
}

Vec2i Vec2iZero()
{
	return Vec2iMake(0,0);
}

boolean Vec2iValueInInterval(Vec2i v, int value)
{
    if (value >= v.x && value <= v.y)
        return true;
    return false;
}

boolean Vec2iValueInRange(Vec2i v, int value)
{
	return Vec2iValueInInterval(v, value);
}

boolean Vec2iEquals(Vec2i a, Vec2i b)
{
    if (a.x != b.x) return false;
    if (a.y != b.y) return false;
    return true;
}

string Vec2iDescription(Vec2i v)
{
    buffer out;
    out.append("[");
    out.append(v.x);
    out.append(", ");
    out.append(v.y);
    out.append("]");
    return out.to_string();
}

Vec2i Vec2iIntersection(Vec2i a, Vec2i b)
{
    Vec2i result;
    result.x = max(a.x, b.x);
    result.y = min(a.y, b.y);
    return result;
}

boolean Vec2iIntersectsWithVec2i(Vec2i a, Vec2i b)
{
    //Assumed [min, max]:
    if (a.y < b.x) return false;
    if (a.x > b.y) return false;
    return true;
}

record Vec2f
{
	float x; //or width
	float y; //or height
};

Vec2f Vec2fMake(float x, float y)
{
	Vec2f result;
	result.x = x;
	result.y = y;
	
	return result;
}

Vec2f Vec2fCopy(Vec2f v)
{
    return Vec2fMake(v.x, v.y);
}

Vec2f Vec2fZero()
{
	return Vec2fMake(0.0, 0.0);
}

boolean Vec2fValueInRange(Vec2f v, float value)
{
    if (value >= v.x && value <= v.y)
        return true;
    return false;
}

Vec2f Vec2fMultiply(Vec2f v, float c)
{
	return Vec2fMake(v.x * c, v.y * c);
}
Vec2f Vec2fAdd(Vec2f v, float c)
{
    return Vec2fMake(v.x + c, v.y + c);
}
float Vec2fAverage(Vec2f v)
{
    return (v.x + v.y) * 0.5;
}



string Vec2fDescription(Vec2f v)
{
    buffer out;
    out.append("[");
    out.append(v.x);
    out.append(", ");
    out.append(v.y);
    out.append("]");
    return out.to_string();
}


record Rect
{
	Vec2i min_coordinate;
	Vec2i max_coordinate;
};

Rect RectMake(Vec2i min_coordinate, Vec2i max_coordinate)
{
	Rect result;
	result.min_coordinate = Vec2iCopy(min_coordinate);
	result.max_coordinate = Vec2iCopy(max_coordinate);
	return result;
}

Rect RectCopy(Rect r)
{
    return RectMake(r.min_coordinate, r.max_coordinate);
}

Rect RectMake(int min_x, int min_y, int max_x, int max_y)
{
	return RectMake(Vec2iMake(min_x, min_y), Vec2iMake(max_x, max_y));
}

Rect RectZero()
{
	return RectMake(Vec2iZero(), Vec2iZero());
}


void listAppend(Rect [int] list, Rect entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

//Allows for fractional digits, not just whole numbers. Useful for preventing "+233.333333333333333% item"-type output.
//Outputs 3.0, 3.1, 3.14, etc.
float round(float v, int additional_fractional_digits)
{
	if (additional_fractional_digits < 1)
		return v.round().to_float();
	float multiplier = powf(10.0, additional_fractional_digits);
	return to_float(round(v * multiplier)) / multiplier;
}

//Similar to round() addition above, but also converts whole float numbers into integers for output
string roundForOutput(float v, int additional_fractional_digits)
{
	v = round(v, additional_fractional_digits);
	int vi = v.to_int();
	if (vi.to_float() == v)
		return vi.to_string();
	else
		return v.to_string();
}


float floor(float v, int additional_fractional_digits)
{
	if (additional_fractional_digits < 1)
		return v.floor().to_float();
	float multiplier = powf(10.0, additional_fractional_digits);
	return to_float(floor(v * multiplier)) / multiplier;
}

string floorForOutput(float v, int additional_fractional_digits)
{
	v = floor(v, additional_fractional_digits);
	int vi = v.to_int();
	if (vi.to_float() == v)
		return vi.to_string();
	else
		return v.to_string();
}


float TriangularDistributionCalculateCDF(float x, float min, float max, float centre)
{
    //piecewise function:
    if (x < min) return 0.0;
    else if (x > max) return 1.0;
    else if (x >= min && x <= centre)
    {
        float divisor = (max - min) * (centre - min);
        if (divisor == 0.0)
            return 0.0;
        
        return pow2f(x - min) / divisor;
    }
    else if (x <= max && x > centre)
    {
        float divisor = (max - min) * (max - centre);
        if (divisor == 0.0)
            return 0.0;
        
            
        return 1.0 - pow2f(max - x) / divisor;
    }
    else //probably only happens with weird floating point values, assume chance of zero:
        return 0.0;
}

//assume a centre equidistant from min and max
float TriangularDistributionCalculateCDF(float x, float min, float max)
{
    return TriangularDistributionCalculateCDF(x, min, max, (min + max) * 0.5);
}

float averagef(float a, float b)
{
    return (a + b) * 0.5;
}

boolean numberIsInRangeInclusive(int v, int min, int max)
{
    if (v < min) return false;
    if (v > max) return false;
    return true;
}
//WARNING: All listAppend functions are flawed.
//Specifically, there's a possibility of a hole that causes order to be incorrect.
//But, the only way to fix that is to traverse the list to determine the maximum key.
//That would take forever...

string listLastObject(string [int] list)
{
    if (list.count() == 0)
        return "";
    return list[list.count() - 1];
}

void listAppend(string [int] list, string entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppendList(string [int] list, string [int] entries)
{
	foreach key in entries
		list.listAppend(entries[key]);
}

string [int] listUnion(string [int] list, string [int] list2)
{
    string [int] result;
    foreach key, s in list
        result.listAppend(s);
    foreach key, s in list2
        result.listAppend(s);
    return result;
}

void listAppendList(boolean [item] destination, boolean [item] source)
{
    foreach it, value in source
        destination[it] = value;
}

void listAppendList(boolean [string] destination, boolean [string] source)
{
    foreach key, value in source
        destination[key] = value;
}

void listAppendList(boolean [skill] destination, boolean [skill] source)
{
    foreach key, value in source
        destination[key] = value;
}

void listAppend(item [int] list, item entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppendList(item [int] list, item [int] entries)
{
	foreach key in entries
        list.listAppend(entries[key]);
}



void listAppend(int [int] list, int entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(float [int] list, float entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(location [int] list, location entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(element [int] list, element entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppendList(location [int] list, location [int] entries)
{
	foreach key in entries
        list.listAppend(entries[key]);
}

void listAppend(effect [int] list, effect entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(skill [int] list, skill entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(familiar [int] list, familiar entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(monster [int] list, monster entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(phylum [int] list, phylum entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(buffer [int] list, buffer entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(slot [int] list, slot entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(thrall [int] list, thrall entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}





void listAppend(string [int][int] list, string [int] entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(skill [int][int] list, skill [int] entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(familiar [int][int] list, familiar [int] entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(int [int][int] list, int [int] entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(item [int][int] list, item [int] entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listAppend(skill [int] list, boolean [skill] entry)
{
    foreach v in entry
        list.listAppend(v);
}

void listAppend(item [int] list, boolean [item] entry)
{
    foreach v in entry
        list.listAppend(v);
}

void listPrepend(string [int] list, string entry)
{
	int position = 0;
	while (list contains position)
		position -= 1;
	list[position] = entry;
}

void listPrepend(skill [int] list, skill entry)
{
	int position = 0;
	while (list contains position)
		position -= 1;
	list[position] = entry;
}

void listAppendList(skill [int] list, skill [int] entries)
{
	foreach key in entries
        list.listAppend(entries[key]);
}

void listPrepend(location [int] list, location entry)
{
	int position = 0;
	while (list contains position)
		position -= 1;
	list[position] = entry;
}

void listPrepend(item [int] list, item entry)
{
    int position = 0;
    while (list contains position)
        position -= 1;
    list[position] = entry;
}


void listClear(string [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}

void listClear(int [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}

void listClear(item [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}

void listClear(location [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}

void listClear(monster [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}

void listClear(skill [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}


void listClear(boolean [string] list)
{
	foreach i in list
	{
		remove list[i];
	}
}


string [int] listMakeBlankString()
{
	string [int] result;
	return result;
}

item [int] listMakeBlankItem()
{
	item [int] result;
	return result;
}

skill [int] listMakeBlankSkill()
{
	skill [int] result;
	return result;
}

location [int] listMakeBlankLocation()
{
	location [int] result;
	return result;
}

monster [int] listMakeBlankMonster()
{
	monster [int] result;
	return result;
}

familiar [int] listMakeBlankFamiliar()
{
	familiar [int] result;
	return result;
}

int [int] listMakeBlankInt()
{
    int [int] result;
    return result;
}




string [int] listMake(string e1)
{
	string [int] result;
	result.listAppend(e1);
	return result;
}

string [int] listMake(string e1, string e2)
{
	string [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	return result;
}

string [int] listMake(string e1, string e2, string e3)
{
	string [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	return result;
}

string [int] listMake(string e1, string e2, string e3, string e4)
{
	string [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	return result;
}

string [int] listMake(string e1, string e2, string e3, string e4, string e5)
{
	string [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	return result;
}

string [int] listMake(string e1, string e2, string e3, string e4, string e5, string e6)
{
	string [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	result.listAppend(e6);
	return result;
}

int [int] listMake(int e1)
{
	int [int] result;
	result.listAppend(e1);
	return result;
}

int [int] listMake(int e1, int e2)
{
	int [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	return result;
}

int [int] listMake(int e1, int e2, int e3)
{
	int [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	return result;
}

int [int] listMake(int e1, int e2, int e3, int e4)
{
	int [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	return result;
}

int [int] listMake(int e1, int e2, int e3, int e4, int e5)
{
	int [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	return result;
}

item [int] listMake(item e1)
{
	item [int] result;
	result.listAppend(e1);
	return result;
}

item [int] listMake(item e1, item e2)
{
	item [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	return result;
}

item [int] listMake(item e1, item e2, item e3)
{
	item [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	return result;
}

item [int] listMake(item e1, item e2, item e3, item e4)
{
	item [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	return result;
}

item [int] listMake(item e1, item e2, item e3, item e4, item e5)
{
	item [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	return result;
}

skill [int] listMake(skill e1)
{
	skill [int] result;
	result.listAppend(e1);
	return result;
}

skill [int] listMake(skill e1, skill e2)
{
	skill [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	return result;
}

skill [int] listMake(skill e1, skill e2, skill e3)
{
	skill [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	return result;
}

skill [int] listMake(skill e1, skill e2, skill e3, skill e4)
{
	skill [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	return result;
}

skill [int] listMake(skill e1, skill e2, skill e3, skill e4, skill e5)
{
	skill [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	return result;
}


monster [int] listMake(monster e1)
{
	monster [int] result;
	result.listAppend(e1);
	return result;
}

monster [int] listMake(monster e1, monster e2)
{
	monster [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	return result;
}

monster [int] listMake(monster e1, monster e2, monster e3)
{
	monster [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	return result;
}

monster [int] listMake(monster e1, monster e2, monster e3, monster e4)
{
	monster [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	return result;
}

monster [int] listMake(monster e1, monster e2, monster e3, monster e4, monster e5)
{
	monster [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	return result;
}

monster [int] listMake(monster e1, monster e2, monster e3, monster e4, monster e5, monster e6)
{
	monster [int] result;
	result.listAppend(e1);
	result.listAppend(e2);
	result.listAppend(e3);
	result.listAppend(e4);
	result.listAppend(e5);
	result.listAppend(e6);
	return result;
}

string listJoinComponents(string [int] list, string joining_string, string and_string)
{
	buffer result;
	boolean first = true;
	int number_seen = 0;
	foreach i, value in list
	{
		if (first)
		{
			result.append(value);
			first = false;
		}
		else
		{
			if (!(list.count() == 2 && and_string != ""))
				result.append(joining_string);
			if (and_string != "" && number_seen == list.count() - 1)
			{
				result.append(" ");
				result.append(and_string);
				result.append(" ");
			}
			result.append(value);
		}
		number_seen = number_seen + 1;
	}
	return result.to_string();
}

string listJoinComponents(string [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}

string listJoinComponents(item [int] list, string joining_string, string and_string)
{
	//lazy:
	//convert items to strings, join that
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(item [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}

string listJoinComponents(monster [int] list, string joining_string, string and_string)
{
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}
string listJoinComponents(monster [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}

string listJoinComponents(effect [int] list, string joining_string, string and_string)
{
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(effect [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}


string listJoinComponents(familiar [int] list, string joining_string, string and_string)
{
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(familiar [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}



string listJoinComponents(location [int] list, string joining_string, string and_string)
{
	//lazy:
	//convert locations to strings, join that
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(location [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}

string listJoinComponents(phylum [int] list, string joining_string, string and_string)
{
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(phylum [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}



string listJoinComponents(skill [int] list, string joining_string, string and_string)
{
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(skill [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}

string listJoinComponents(int [int] list, string joining_string, string and_string)
{
	//lazy:
	//convert ints to strings, join that
	string [int] list_string;
	foreach key in list
		list_string.listAppend(list[key].to_string());
	return listJoinComponents(list_string, joining_string, and_string);
}

string listJoinComponents(int [int] list, string joining_string)
{
	return listJoinComponents(list, joining_string, "");
}


void listRemoveKeys(string [int] list, int [int] keys_to_remove)
{
	foreach i in keys_to_remove
	{
		int key = keys_to_remove[i];
		if (!(list contains key))
			continue;
		remove list[key];
	}
}

int listSum(int [int] list)
{
    int v = 0;
    foreach key in list
    {
        v += list[key];
    }
    return v;
}


string [int] listCopy(string [int] l)
{
    string [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

int [int] listCopy(int [int] l)
{
    int [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

item [int] listCopy(item [int] l)
{
    item [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}


monster [int] listCopy(monster [int] l)
{
    monster [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

element [int] listCopy(element [int] l)
{
    element [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

skill [int] listCopy(skill [int] l)
{
    skill [int] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

boolean [monster] listCopy(boolean [monster] l)
{
    boolean [monster] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

int [item] listCopy(int [item] l)
{
    int [item] result;
    foreach key in l
        result[key] = l[key];
    return result;
}

//Strict, in this case, means the keys start at 0, and go up by one per entry. This allows easy consistent access
boolean listKeysMeetStrictRequirements(string [int] list)
{
    int expected_value = 0;
    foreach key in list
    {
        if (key != expected_value)
            return false;
        expected_value += 1;
    }
    return true;
}
string [int] listCopyStrictRequirements(string [int] list)
{
    string [int] result;
    foreach key in list
        result.listAppend(list[key]);
    return result;
}

string [string] mapMake()
{
	string [string] result;
	return result;
}

string [string] mapMake(string key1, string value1)
{
	string [string] result;
	result[key1] = value1;
	return result;
}

string [string] mapMake(string key1, string value1, string key2, string value2)
{
	string [string] result;
	result[key1] = value1;
	result[key2] = value2;
	return result;
}

string [string] mapMake(string key1, string value1, string key2, string value2, string key3, string value3)
{
	string [string] result;
	result[key1] = value1;
	result[key2] = value2;
	result[key3] = value3;
	return result;
}

string [string] mapMake(string key1, string value1, string key2, string value2, string key3, string value3, string key4, string value4)
{
	string [string] result;
	result[key1] = value1;
	result[key2] = value2;
	result[key3] = value3;
	result[key4] = value4;
	return result;
}

string [string] mapMake(string key1, string value1, string key2, string value2, string key3, string value3, string key4, string value4, string key5, string value5)
{
	string [string] result;
	result[key1] = value1;
	result[key2] = value2;
	result[key3] = value3;
	result[key4] = value4;
	result[key5] = value5;
	return result;
}


string [string] mapMake(string key1, string value1, string key2, string value2, string key3, string value3, string key4, string value4, string key5, string value5, string key6, string value6)
{
	string [string] result;
	result[key1] = value1;
	result[key2] = value2;
	result[key3] = value3;
	result[key4] = value4;
	result[key5] = value5;
	result[key6] = value6;
	return result;
}

string [string] mapCopy(string [string] map)
{
    string [string] result;
    foreach key in map
        result[key] = map[key];
    return result;
}

boolean mapsAreEqual(string [string] map1, string [string] map2)
{
	if (map1.count() != map2.count())
	{
        //print_html("map1.c = " + map1.count() + " which is not " + map2.count());
		return false;
    }
	foreach key1, v in map1
	{
		if (!(map2 contains key1))
        {
        	//print_html("map2 lacks " + key1);
        	return false;
        }
        if (map2[key1] != v)
        {
            //print_html("map2 v(" + map2[key1] + " does not equal " + key1 + " (" + v + ")");
        	return false;
        }
	}
	return true;
}

boolean [string] listInvert(string [int] list)
{
	boolean [string] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}


boolean [int] listInvert(int [int] list)
{
	boolean [int] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}

boolean [location] listInvert(location [int] list)
{
	boolean [location] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}

boolean [item] listInvert(item [int] list)
{
	boolean [item] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}

boolean [monster] listInvert(monster [int] list)
{
	boolean [monster] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}

boolean [familiar] listInvert(familiar [int] list)
{
	boolean [familiar] result;
	foreach key in list
	{
		result[list[key]] = true;
	}
	return result;
}

int [int] listConvertToInt(string [int] list)
{
	int [int] result;
	foreach key in list
		result[key] = list[key].to_int();
	return result;
}

item [int] listConvertToItem(string [int] list)
{
	item [int] result;
	foreach key in list
		result[key] = list[key].to_item();
	return result;
}

string listFirstObject(string [int] list)
{
    foreach key in list
        return list[key];
    return "";
}

//(I'm assuming maps have a consistent enumeration order, which may not be the case)
int listKeyForIndex(string [int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

int listKeyForIndex(location [int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

int listKeyForIndex(familiar [int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

int listKeyForIndex(item [int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

int listKeyForIndex(monster [int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

int listKeyForIndex(int [int] list, int index)
{
    int i = 0;
    foreach key in list
    {
        if (i == index)
            return key;
        i += 1;
    }
    return -1;
}

int llistKeyForIndex(string [int][int] list, int index)
{
	int i = 0;
	foreach key in list
	{
		if (i == index)
			return key;
		i += 1;
	}
	return -1;
}

string listGetRandomObject(string [int] list)
{
    if (list.count() == 0)
        return "";
    if (list.count() == 1)
    	return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}

item listGetRandomObject(item [int] list)
{
    if (list.count() == 0)
        return $item[none];
    if (list.count() == 1)
    	return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}

location listGetRandomObject(location [int] list)
{
    if (list.count() == 0)
        return $location[none];
    if (list.count() == 1)
    	return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}

familiar listGetRandomObject(familiar [int] list)
{
    if (list.count() == 0)
        return $familiar[none];
    if (list.count() == 1)
    	return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}

monster listGetRandomObject(monster [int] list)
{
    if (list.count() == 0)
        return $monster[none];
    if (list.count() == 1)
    	return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}

int listGetRandomObject(int [int] list)
{
    if (list.count() == 0)
        return -1;
    if (list.count() == 1)
        return list[listKeyForIndex(list, 0)];
    return list[listKeyForIndex(list, random(list.count()))];
}


boolean listContainsValue(monster [int] list, monster vo)
{
    foreach key, v2 in list
    {
        if (v2 == vo)
            return true;
    }
    return false;
}

string [int] listInvert(boolean [string] list)
{
    string [int] out;
    foreach m, value in list
    {
        if (value)
            out.listAppend(m);
    }
    return out;
}

int [int] listInvert(boolean [int] list)
{
    int [int] out;
    foreach m, value in list
    {
        if (value)
            out.listAppend(m);
    }
    return out;
}

skill [int] listInvert(boolean [skill] list)
{
    skill [int] out;
    foreach m, value in list
    {
        if (value)
            out.listAppend(m);
    }
    return out;
}

monster [int] listInvert(boolean [monster] monsters)
{
    monster [int] out;
    foreach m, value in monsters
    {
        if (value)
            out.listAppend(m);
    }
    return out;
}

location [int] listInvert(boolean [location] list)
{
    location [int] out;
    foreach k, value in list
    {
        if (value)
            out.listAppend(k);
    }
    return out;
}

familiar [int] listInvert(boolean [familiar] list)
{
    familiar [int] out;
    foreach k, value in list
    {
        if (value)
            out.listAppend(k);
    }
    return out;
}

item [int] listInvert(boolean [item] list)
{
    item [int] out;
    foreach k, value in list
    {
        if (value)
            out.listAppend(k);
    }
    return out;
}

skill [int] listConvertStringsToSkills(string [int] list)
{
    skill [int] out;
    foreach key, s in list
    {
        out.listAppend(s.to_skill());
    }
    return out;
}

monster [int] listConvertStringsToMonsters(string [int] list)
{
    monster [int] out;
    foreach key, s in list
    {
        out.listAppend(s.to_monster());
    }
    return out;
}

int [int] stringToIntIntList(string input, string delimiter)
{
	int [int] out;
	if (input == "")
		return out;
	foreach key, v in input.split_string(delimiter)
	{
		if (v == "") continue;
		out.listAppend(v.to_int());
	}
	return out;
}

int [int] stringToIntIntList(string input)
{
	return stringToIntIntList(input, ",");
}

boolean [location] locationToLocationMap(location l)
{
	boolean [location] map;
	map[l] = true;
	return map;
}



buffer to_buffer(string str)
{
	buffer result;
	result.append(str);
	return result;
}

buffer copyBuffer(buffer buf)
{
    buffer result;
    result.append(buf);
    return result;
}

//split_string returns an immutable array, which will error on certain edits
//Use this function - it converts to an editable map.
string [int] split_string_mutable(string source, string delimiter)
{
	string [int] result;
	string [int] immutable_array = split_string(source, delimiter);
	foreach key in immutable_array
		result[key] = immutable_array[key];
	return result;
}

//This returns [] for empty strings. This isn't standard for split(), but is more useful for passing around lists. Hacky, I suppose.
string [int] split_string_alternate(string source, string delimiter)
{
    if (source.length() == 0)
        return listMakeBlankString();
    return split_string_mutable(source, delimiter);
}
string [int] split_string_alternate_immutable(string source, string delimiter)
{
    if (source.length() == 0)
        return listMakeBlankString();
    return split_string(source, delimiter);
}

string slot_to_string(slot s)
{
    if (s == $slot[acc1] || s == $slot[acc2] || s == $slot[acc3])
        return "accessory";
    else if (s == $slot[sticker1] || s == $slot[sticker2] || s == $slot[sticker3])
        return "sticker";
    else if (s == $slot[folder1] || s == $slot[folder2] || s == $slot[folder3] || s == $slot[folder4] || s == $slot[folder5])
        return "folder";
    else if (s == $slot[fakehand])
        return "fake hand";
    else if (s == $slot[crown-of-thrones])
        return "crown of thrones";
    else if (s == $slot[buddy-bjorn])
        return "buddy bjorn";
    return s;
}

string slot_to_plural_string(slot s)
{
    if (s == $slot[acc1] || s == $slot[acc2] || s == $slot[acc3])
        return "accessories";
    else if (s == $slot[hat])
        return "hats";
    else if (s == $slot[weapon])
        return "weapons";
    else if (s == $slot[off-hand])
        return "off-hands";
    else if (s == $slot[shirt])
        return "shirts";
    else if (s == $slot[back])
        return "back items";
    
    return s.slot_to_string();
}


string format_today_to_string(string desired_format)
{
    return format_date_time("yyyyMMdd", today_to_string(), desired_format);
}


string [int] __int_to_wordy_map;
string int_to_wordy(int v) //Not complete, only supports a handful:
{
    if (__int_to_wordy_map.count() == 0)
    {
        __int_to_wordy_map = split_string("zero,one,two,three,four,five,six,seven,eight,nine,ten,eleven,twelve,thirteen,fourteen,fifteen,sixteen,seventeen,eighteen,nineteen,twenty,twenty-one,twenty-two,twenty-three,twenty-four,twenty-five,twenty-six,twenty-seven,twenty-eight,twenty-nine,thirty,thirty-one", ",");
    }
    if (__int_to_wordy_map contains v)
        return __int_to_wordy_map[v];
    return v.to_string();
}


boolean stringHasPrefix(string s, string prefix)
{
	if (s.length() < prefix.length())
		return false;
	else if (s.length() == prefix.length())
		return (s == prefix);
	else if (substring(s, 0, prefix.length()) == prefix)
		return true;
	return false;
}

boolean stringHasSuffix(string s, string suffix)
{
	if (s.length() < suffix.length())
		return false;
	else if (s.length() == suffix.length())
		return (s == suffix);
	else if (substring(s, s.length() - suffix.length()) == suffix)
		return true;
	return false;
}

string capitaliseFirstLetter(string v)
{
	buffer buf = v.to_buffer();
	if (v.length() <= 0)
		return v;
	buf.replace(0, 1, buf.char_at(0).to_upper_case());
	return buf.to_string();
}

//shadowing; this may override ints
string pluralise(float value, string non_plural, string plural)
{
	string value_out = "";
	if (value.to_int() == value)
		value_out = value.to_int();
    else
    	value_out = value;
	if (value == 1.0)
		return value_out + " " + non_plural;
	else
		return value_out + " " + plural;
}

string pluralise(int value, string non_plural, string plural)
{
	if (value == 1)
		return value + " " + non_plural;
	else
		return value + " " + plural;
}

string pluralise(int value, item i)
{
	return pluralise(value, i.to_string(), i.plural);
}

string pluralise(item i) //whatever we have around
{
	return pluralise(i.available_amount(), i);
}

string pluralise(effect e)
{
    return pluralise(e.have_effect(), "turn", "turns") + " of " + e;
}

string pluraliseWordy(int value, string non_plural, string plural)
{
	if (value == 1)
    {
        if (non_plural == "more time") //we're gonna celebrate
            return "One More Time";
        else if (non_plural == "more turn")
            return "One More Turn";
		return value.int_to_wordy() + " " + non_plural;
    }
	else
		return value.int_to_wordy() + " " + plural;
}

string pluraliseWordy(int value, item i)
{
	return pluraliseWordy(value, i.to_string(), i.plural);
}

string pluraliseWordy(item i) //whatever we have around
{
	return pluraliseWordy(i.available_amount(), i);
}


//Additions to standard API:
//Auto-conversion property functions:
boolean get_property_boolean(string property)
{
	return get_property(property).to_boolean();
}

int get_property_int(string property)
{
	return get_property(property).to_int_silent();
}

location get_property_location(string property)
{
	return get_property(property).to_location();
}

float get_property_float(string property)
{
	return get_property(property).to_float();
}

monster get_property_monster(string property)
{
	return get_property(property).to_monster();
}

//Returns true if the propery is equal to my_ascensions(). Commonly used in mafia properties.
boolean get_property_ascension(string property)
{
    return get_property_int(property) == my_ascensions();
}

element get_property_element(string property)
{
    return get_property(property).to_element();
}

item get_property_item(string property)
{
    return get_property(property).to_item();
}


/*
Discovery - get_ingredients() takes up to 5.8ms per call, scaling to inventory size. Fixing the code in mafia might be possible, but it's old and looks complicated.
This implementation is not 1:1 compatible, as it doesn't take into account your current status, but we don't generally need that information(?).
*/

//Relevant prototype:
//int [item] get_ingredients_fast(item it)


Record Recipe
{
	item creating_item;
	string type;
	int [item] source_items;
	
	Coinmaster source_coinmaster;
	
	string coinmaster_row_id;
};

static
{
	Recipe [item][int] __item_recipes;
	
    boolean [item] __item_is_purchasable_from_a_store;
    boolean [item] __items_that_craft_food;
}

Recipe [int] recipes_for_item(item it)
{
	return __item_recipes[it];
}

Recipe recipe_for_item(item it)
{
	if (__item_recipes[it].count() == 0)
	{
		Recipe blank;
        return blank;
	}
	return __item_recipes[it][0];
}

int [item] get_ingredients_fast(item it)
{
	Recipe [int] recipes = __item_recipes[it];
	if (recipes.count() == 0)
	{
		//use get_ingredient?
        //mafia appears to have various items that return get_ingredients but do not show up in the datafiles
        int [item] mafia_response = it.get_ingredients();
        return mafia_response;
	}
	return recipes[0].source_items;
}

boolean item_is_purchasable_from_a_store(item it)
{
    return __item_is_purchasable_from_a_store[it];
}

boolean item_cannot_be_asdon_martined_because_it_was_purchased_from_a_store(item it)
{
	if ($items[wasabi pocky,tobiko pocky,natto pocky,wasabi-infused sake,tobiko-infused sake,natto-infused sake] contains it) return false;
	return it.item_is_purchasable_from_a_store();
}



//Initialisation code, ignore:
boolean parseDatafileItem(int [item] out, string item_name)
{
    if (item_name == "") return false;
    
    item it = item_name.to_item();
    if (it != $item[none])
    {
        out[it] += 1;
    }
    else if (item_name.contains_text("("))
    {
        //Do complicated parsing.
        //NOTE: "CRIMBCO Employee Handbook (chapter 1)" and "snow berries (7)" are both valid entries that mean different things.
        //optional space between the item name and parenthesis because the CRIMBO12 items (BittyCar MeatCar) have no space there
        string [int][int] matches = item_name.group_string("(.*?)[ ]*\\(([0-9]*)\\)");
        if (matches[0].count() == 3)
        {
            it = matches[0][1].to_item();
            if (it == $item[none]) return false;
            int amount = matches[0][2].to_int();
            if (amount > 0)
            {
                out[it] += amount;
            }
            else
            	return false;
        }
    }
    return true;
}


void InternalAddRecipe(Recipe r)
{
	if (!(__item_recipes contains r.creating_item))
	{
		Recipe [int] blank;
        __item_recipes[r.creating_item] = blank;
	}
	__item_recipes[r.creating_item][__item_recipes[r.creating_item].count()] = r;
	if (r.type == "COOK" || r.type == "COOK_FANCY")
    {
    	foreach it in r.source_items
        	__items_that_craft_food[it] = true;
    }
}

void InternalParseConcoctionEntry(string entry)
{
	string [int] split_entry = entry.split_string_alternate_immutable("\t");
	//crafting_thing, crafting_type, mixing_item_1, mixing_item_2, mixing_item_3, mixing_item_4, mixing_item_5, mixing_item_6, mixing_item_7, mixing_item_8, mixing_item_9, mixing_item_10, mixing_item_11, mixing_item_12, mixing_item_13, mixing_item_14, mixing_item_15, mixing_item_16, mixing_item_17, mixing_item_18
	if (split_entry.count() < 3) return;
	Recipe r;
	
	r.creating_item = split_entry[0].to_item();
	r.type = split_entry[1];
	if (r.creating_item == $item[none])
	{
		//print_html("Unknown item " + split_entry[0]);
        return;
	}
	for i from 2 to split_entry.count() - 1
	{
		string value = split_entry[i];
		int [item] out;
        parseDatafileItem(out, value);
        if (out.count() > 0)
        {
        	foreach it, amount in out
            {
            	r.source_items[it] += amount;
            }
        }
	}
    if (r.type.contains_text("ROW"))
        __item_is_purchasable_from_a_store[r.creating_item] = true;
	
	if (r.source_items.count() == 0)
	{
		//print_html(r.creating_item + " has no source items, entry is \"" + entry + "\"");
        return;
	}
	InternalAddRecipe(r);
	
	
	//print_html("Added " + r.creating_item + " of type " + r.type + " which requires " + r.source_items.to_json());
}

void InternalParseConcoctions()
{
	string [int] file_lines = file_to_array("data/concoctions.txt");
	foreach key, entry in file_lines
	{
		//Note that FileUtilities.java appears to only ignore lines starting exactly with #.
        //So that is what we will do.
        if (entry == "") continue;
        if (entry.char_at(0) == "#") continue;
        InternalParseConcoctionEntry(entry);
	}
	
	if (false)
	{
		foreach it in __item_recipes
        {
        	if (__item_recipes[it].count() <= 1) continue;
            print_html(it + " has " + __item_recipes[it].count() + " recipes: " + __item_recipes[it].to_json()); 
        }
	}
}

void InternalParseCoinmasterEntry(string entry)
{
	//shop name, buy or sell, currency amount, item acquired, row
	
	string [int] split_entry = entry.split_string_alternate_immutable("\t");
	if (split_entry.count() < 4) return;
	if (split_entry[1] != "buy") return;
	
	Recipe r;
	r.source_coinmaster = split_entry[0].to_coinmaster();
	if (r.source_coinmaster == $coinmaster[none])
	{
		//print_html("Unknown coinmaster for " + entry);
        return;
	}
	r.creating_item = split_entry[3].to_item();
	if (r.creating_item == $item[none])
	{
		//print_html("Unknown item for " + entry);
        return;
	}
	
	int currency_amount = split_entry[2].to_int();
	item store_item = r.source_coinmaster.item;
	
	if (store_item != $item[none])
		r.source_items[store_item] = currency_amount;
	
	__item_is_purchasable_from_a_store[r.creating_item] = true;
	
	if (split_entry.count() >= 5)
		r.coinmaster_row_id = split_entry[4];
	if (r.source_items.count() == 0)
	{
		//print_html(r.creating_item + " has no source items, entry is \"" + entry + "\"");
        return;
	}
	InternalAddRecipe(r);
	//print_html(r.creating_item + ": " + r.to_json());
}

void InternalParseCoinmasters()
{
	//coinmasters.txt has improper format for actual game; it assumes a "store" currency which is not accurate, stores can have multiple currencies
	
	string [int] file_lines = file_to_array("data/coinmasters.txt");
	foreach key, entry in file_lines
	{
        if (entry == "") continue;
        if (entry.char_at(0) == "#") continue;
        InternalParseCoinmasterEntry(entry);
	}
}


void initialiseItemIngredients()
{
    if (__item_recipes.count() > 0) return;
    
    //Parse concoctions:
    InternalParseConcoctions();
    
    //Parse coinmasters:
    InternalParseCoinmasters();
    
}
initialiseItemIngredients();





void testItemIngredients()
{
    print_html(__item_recipes.count() + " recipes known.");
    foreach it in $items[]
    {
        int [item] ground_truth_ingredients = it.get_ingredients();
        int [item] our_ingredients = get_ingredients_fast(it);
        if (ground_truth_ingredients.count() == 0 && our_ingredients.count() == 0) continue;
        
        boolean passes = true;
        if (ground_truth_ingredients.count() != our_ingredients.count())
        {
            passes = false;
            if (ground_truth_ingredients.count() == 0 && our_ingredients.count() > 0) //probably just a coinmaster
                continue;
        }
        else
        {
            foreach it2, amount in ground_truth_ingredients
            {
                if (our_ingredients[it2] != amount)
                {
                    passes = false;
                    break;
                }
            }
        }
        if (!passes)
        {
            print_html(it + ": " + ground_truth_ingredients.to_json() + " vs " + our_ingredients.to_json());
        }
    }
}

/*void main()
{
    testItemIngredients();
}*/



static
{
    int PATH_UNKNOWN = -1;
    int PATH_NONE = 0;
    int PATH_BOOZETAFARIAN = 1;
    int PATH_TEETOTALER = 2;
    int PATH_OXYGENARIAN = 3;

    int PATH_BEES_HATE_YOU = 4;
    int PATH_WAY_OF_THE_SURPRISING_FIST = 6;
    int PATH_TRENDY = 7;
    int PATH_AVATAR_OF_BORIS = 8;
    int PATH_BUGBEAR_INVASION = 9;
    int PATH_ZOMBIE_SLAYER = 10;
    int PATH_CLASS_ACT = 11;
    int PATH_AVATAR_OF_JARLSBERG = 12;
    int PATH_BIG = 14;
    int PATH_KOLHS = 15;
    int PATH_CLASS_ACT_2 = 16;
    int PATH_AVATAR_OF_SNEAKY_PETE = 17;
    int PATH_SLOW_AND_STEADY = 18;
    int PATH_HEAVY_RAINS = 19;
    int PATH_PICKY = 21;
    int PATH_STANDARD = 22;
    int PATH_ACTUALLY_ED_THE_UNDYING = 23;
    int PATH_ONE_CRAZY_RANDOM_SUMMER = 24;
    int PATH_COMMUNITY_SERVICE = 25;
    int PATH_AVATAR_OF_WEST_OF_LOATHING = 26;
    int PATH_THE_SOURCE = 27;
    int PATH_NUCLEAR_AUTUMN = 28;
    int PATH_GELATINOUS_NOOB = 29;
    int PATH_LICENSE_TO_ADVENTURE = 30;
    int PATH_LIVE_ASCEND_REPEAT = 31;
    int PATH_POCKET_FAMILIARS = 32;
    int PATH_G_LOVER = 33;
    int PATH_DISGUISES_DELIMIT = 34;
    int PATH_DEMIGUISE = 34;
    int PATH_DARK_GYFFTE = 35;
    int PATH_DARK_GIFT = 35;
    int PATH_VAMPIRE = 35;
    int PATH_2CRS = 36;
    int PATH_KINGDOM_OF_EXPLOATHING = 37;
    int PATH_EXPLOSION = 37;
    int PATH_EXPLOSIONS = 37;
    int PATH_EXPLODING = 37;
    int PATH_EXPLODED = 37;
    int PATH_OF_THE_PLUMBER = 38;
    int PATH_PLUMBER = 38;
    int PATH_LUIGI = 38;
    int PATH_MAMA_LUIGI = 38;
    int PATH_MARIO = 38;
    int PATH_LOW_KEY_SUMMER = 39;
    int PATH_LOKI = 39;
    int PATH_GREY_GOO = 40;
    int PATH_ROBOT = 41;
}

float numeric_modifier_replacement(item it, string modifier)
{
    string modifier_lowercase = modifier.to_lower_case();
    float additional = 0;
    if (my_path_id() == PATH_G_LOVER && !it.contains_text("g") && !it.contains_text("G"))
    	return 0.0;
    if (it == $item[your cowboy boots])
    {
        if (modifier_lowercase == "monster level" && $slot[bootskin].equipped_item() == $item[diamondback skin])
        {
            return 20.0;
        }
        if (modifier_lowercase == "initiative" && $slot[bootspur].equipped_item() == $item[quicksilver spurs])
            return 30;
        if (modifier_lowercase == "item drop" && $slot[bootspur].equipped_item() == $item[nicksilver spurs])
            return 30;
        if (modifier_lowercase == "muscle percent" && $slot[bootskin].equipped_item() == $item[grizzled bearskin])
            return 50.0;
        if (modifier_lowercase == "mysticality percent" && $slot[bootskin].equipped_item() == $item[frontwinder skin])
            return 50.0;
        if (modifier_lowercase == "moxie percent" && $slot[bootskin].equipped_item() == $item[mountain lion skin])
            return 50.0;
        //FIXME deal with rest (resistance, etc)
    }
    //so, when we don't have the smithsness items equipped, they have a numeric modifier of zero.
    //but, they always have an inherent value of five. so give them that.
    //FIXME do other smithsness items
    if (it == $item[a light that never goes out] && modifier_lowercase == "item drop")
    {
    	if (it.equipped_amount() == 0)
     	   additional += 5;
    }
    return numeric_modifier(it, modifier) + additional;
}


static
{
    skill [class][int] __skills_by_class;
    
    void initialiseSkillsByClass()
    {
        if (__skills_by_class.count() > 0) return;
        foreach s in $skills[]
        {
            if (s.class != $class[none])
            {
                if (!(__skills_by_class contains s.class))
                {
                    skill [int] blank;
                    __skills_by_class[s.class] = blank;
                }
                __skills_by_class[s.class].listAppend(s);
            }
        }
    }
    initialiseSkillsByClass();
}


static
{
    boolean [skill] __libram_skills;
    
    void initialiseLibramSkills()
    {
        foreach s in $skills[]
        {
            if (s.libram)
                __libram_skills[s] = true;
        }
    }
    initialiseLibramSkills();
}


static
{
    boolean [item] __minus_combat_equipment;
    boolean [item] __equipment;
    boolean [item] __items_in_outfits;
    boolean [string][item] __equipment_by_numeric_modifier;
    void initialiseItems()
    {
        foreach it in $items[]
        {
            //Crafting:
            //moved to ingredients.ash:
            /*string craft_type = it.craft_type();
            if (craft_type.contains_text("Cooking"))
            {
                foreach ingredient in it.get_ingredients_fast()
                {
                    __items_that_craft_food[ingredient] = true;
                }
            }*/
            
            //Equipment:
            if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3,familiar] contains it.to_slot())
            {
                __equipment[it] = true;
                if (it.numeric_modifier("combat rate") < 0)
                    __minus_combat_equipment[it] = true;
            }
        }
        foreach key, outfit_name in all_normal_outfits()
        {
            foreach key, it in outfit_pieces(outfit_name)
                __items_in_outfits[it] = true;
        }
    }
    initialiseItems();
}

boolean [item] equipmentWithNumericModifier(string modifier)
{
	modifier = modifier.to_lower_case();
    boolean [item] dynamic_items;
    dynamic_items[to_item("kremlin's greatest briefcase")] = true;
    dynamic_items[$item[your cowboy boots]] = true;
    dynamic_items[$item[a light that never goes out]] = true; //FIXME all smithsness items
    if (!(__equipment_by_numeric_modifier contains modifier))
    {
        //Build it:
        boolean [item] blank;
        __equipment_by_numeric_modifier[modifier] = blank;
        foreach it in __equipment
        {
            if (dynamic_items contains it) continue;
            if (it.numeric_modifier(modifier) != 0.0)
                __equipment_by_numeric_modifier[modifier][it] = true;
        }
    }
    //Certain equipment is dynamic. Inspect them dynamically:
    boolean [item] extra_results;
    foreach it in dynamic_items
    {
        if (it.numeric_modifier_replacement(modifier) != 0.0)
        {
            extra_results[it] = true;
        }
    }
    //damage + spell damage is basically the same for most things
    string secondary_modifier = "";
    foreach e in $elements[hot,cold,spooky,stench,sleaze]
    {
        if (modifier == e + " damage")
            secondary_modifier = e + " spell damage";
    }
    if (secondary_modifier != "")
    {
    	foreach it in equipmentWithNumericModifier(secondary_modifier)
        	extra_results[it] = true;
    }
    
    if (extra_results.count() == 0)
        return __equipment_by_numeric_modifier[modifier];
    else
    {
        //Add extras:
        foreach it in __equipment_by_numeric_modifier[modifier]
        {
            extra_results[it] = true;
        }
        return extra_results;
    }
}

static
{
    boolean [item] __beancannon_source_items = $items[Heimz Fortified Kidney Beans,Hellfire Spicy Beans,Mixed Garbanzos and Chickpeas,Pork 'n' Pork 'n' Pork 'n' Beans,Shrub's Premium Baked Beans,Tesla's Electroplated Beans,Frigid Northern Beans,Trader Olaf's Exotic Stinkbeans,World's Blackest-Eyed Peas];
}

static
{
    //This would be a good mafia proxy value. Feature request?
    boolean [skill] __combat_skills_that_are_spells;
    void initialiseCombatSkillsThatAreSpells()
    {
    	//Saucecicle,Surge of Icing are guesses
        foreach s in $skills[Awesome Balls of Fire,Bake,Blend,Blinding Flash,Boil,Candyblast,Cannelloni Cannon,Carbohydrate Cudgel,Chop,CLEESH,Conjure Relaxing Campfire,Creepy Lullaby,Curdle,Doubt Shackles,Eggsplosion,Fear Vapor,Fearful Fettucini,Freeze,Fry,Grease Lightning,Grill,Haggis Kick,Inappropriate Backrub,K&auml;seso&szlig;esturm,Mudbath,Noodles of Fire,Rage Flame,Raise Backup Dancer,Ravioli Shurikens,Salsaball,Saucegeyser,Saucemageddon,Saucestorm,Saucy Salve,Shrap,Slice,Snowclone,Spaghetti Spear,Stream of Sauce,Stringozzi Serpent,Stuffed Mortar Shell,Tear Wave,Toynado,Volcanometeor Showeruption,Wassail,Wave of Sauce,Weapon of the Pastalord,Saucecicle,Surge of Icing]
        {
            __combat_skills_that_are_spells[s] = true;
        }
        foreach s in $skills[Lavafava,Pungent Mung,Beanstorm] //FIXME cowcall? snakewhip?
            __combat_skills_that_are_spells[s] = true;
    }
    initialiseCombatSkillsThatAreSpells();
}

static
{
    boolean [monster] __snakes;
    void initialiseSnakes()
    {
        __snakes = $monsters[aggressive grass snake,Bacon snake,Batsnake,Black adder,Burning Snake of Fire,Coal snake,Diamondback rattler,Frontwinder,Frozen Solid Snake,King snake,Licorice snake,Mutant rattlesnake,Prince snake,Sewer snake with a sewer snake in it,Snakeleton,The Snake With Like Ten Heads,Tomb asp,Trouser Snake,Whitesnake];
    }
    initialiseSnakes();
}

item lookupAWOLOilForMonster(monster m)
{
    if (__snakes contains m)
        return $item[snake oil];
    else if ($phylums[beast,dude,hippy,humanoid,orc,pirate] contains m.phylum)
        return $item[skin oil];
    else if ($phylums[bug,construct,constellation,demon,elemental,elf,fish,goblin,hobo,horror,mer-kin,penguin,plant,slime,weird] contains m.phylum)
        return $item[unusual oil];
    else if ($phylums[undead] contains m.phylum)
        return $item[eldritch oil];
    return $item[none];
}

static
{
    monster [location] __protonic_monster_for_location {$location[Cobb's Knob Treasury]:$monster[The ghost of Ebenoozer Screege], $location[The Haunted Conservatory]:$monster[The ghost of Lord Montague Spookyraven], $location[The Haunted Gallery]:$monster[The ghost of Waldo the Carpathian], $location[The Haunted Kitchen]:$monster[The Icewoman], $location[The Haunted Wine Cellar]:$monster[The ghost of Jim Unfortunato], $location[The Icy Peak]:$monster[The ghost of Sam McGee], $location[Inside the Palindome]:$monster[Emily Koops, a spooky lime], $location[Madness Bakery]:$monster[the ghost of Monsieur Baguelle], $location[The Old Landfill]:$monster[The ghost of Vanillica "Trashblossom" Gorton], $location[The Overgrown Lot]:$monster[the ghost of Oily McBindle], $location[The Skeleton Store]:$monster[boneless blobghost], $location[The Smut Orc Logging Camp]:$monster[The ghost of Richard Cockingham], $location[The Spooky Forest]:$monster[The Headless Horseman]};
}



static
{
	boolean [monster][location] __monsters_natural_habitats;
}
boolean [location] getPossibleLocationsMonsterCanAppearInNaturally(monster m)
{
	if (__monsters_natural_habitats.count() == 0)
	{
		//initialise:
        foreach l in $locations[]
        {
        	foreach key, m in l.get_monsters()
            	__monsters_natural_habitats[m][l] = true;
        }
	}
	return __monsters_natural_habitats[m];
}

boolean mafiaIsPastRevision(int revision_number)
{
    if (get_revision() <= 0) //get_revision reports zero in certain cases; assume they're on a recent version
        return true;
    return (get_revision() >= revision_number);
}


boolean have_familiar_replacement(familiar f)
{
    //have_familiar bugs in avatar of sneaky pete for now, so:
    if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE)
        return false;
    return f.have_familiar();
}

//Similar to have_familiar, except it also checks trendy (not sure if have_familiar supports trendy) and 100% familiar runs
boolean familiar_is_usable(familiar f)
{
    //r13998 has most of these
    if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_LICENSE_TO_ADVENTURE || my_path_id() == PATH_POCKET_FAMILIARS || my_path_id() == PATH_VAMPIRE)
        return false;
    if (!is_unrestricted(f))
        return false;
    if (my_path_id() == PATH_G_LOVER && !f.contains_text("g") && !f.contains_text("G"))
        return false;
    //On second thought, this is terrible:
	/*int single_familiar_run = get_property_int("singleFamiliarRun");
	if (single_familiar_run != -1 && my_turncount() >= 30) //after 30 turns, they're probably sure
	{
		if (f == single_familiar_run.to_familiar())
			return true;
		return false;
	}*/
	if (my_path_id() == PATH_TRENDY)
	{
		if (!is_trendy(f))
			return false;
	}
	else if (my_path_id() == PATH_BEES_HATE_YOU)
	{
		if (f.to_string().contains_text("b") || f.to_string().contains_text("B")) //bzzzz!
			return false; //so not green
	}
	return have_familiar(f);
}

//inigo's used to show up as have_skill while under restrictions, possibly others
boolean skill_is_usable(skill s)
{
    if (!s.have_skill())
        return false;
    if (!s.is_unrestricted())
        return false;
    if (my_path_id() == PATH_G_LOVER && (!s.passive || s == $skill[meteor lore]) && !s.contains_text("g") && !s.contains_text("G"))
    	return false;
    if ($skills[rapid prototyping] contains s)
        return $item[hand turkey outline].is_unrestricted();
    return true;
}

boolean a_skill_is_usable(boolean [skill] skills)
{
	foreach s in skills
	{
		if (s.skill_is_usable()) return true;
	}
	return false;
}

boolean skill_is_currently_castable(skill s)
{
	//FIXME accordion thief songs, MP, a lot of things
    if (s == $skill[Utensil Twist] && $slot[weapon].equipped_item().item_type() != "utensil")
    {
        return false;
    }
    return true;
}

boolean item_is_usable(item it)
{
    if (!it.is_unrestricted())
        return false;
    if (my_path_id() == PATH_G_LOVER && !it.contains_text("g") && !it.contains_text("G"))
        return false;
    if (my_path_id() == PATH_BEES_HATE_YOU && (it.contains_text("b") || it.contains_text("B")))
    	return false;
	return true;
}

//available_amount() except it tests against item_is_usable()
int usable_amount(item it)
{
	if (!it.item_is_usable()) return 0;
	return it.available_amount();
}

boolean effect_is_usable(effect e)
{
    if (my_path_id() == PATH_G_LOVER && !e.contains_text("g") && !e.contains_text("G"))
        return false;
    return true;
}

boolean in_ronin()
{
	return !can_interact();
}


boolean [item] makeConstantItemArrayMutable(boolean [item] array)
{
    boolean [item] result;
    foreach k in array
        result[k] = array[k];
    
    return result;
}

boolean [location] makeConstantLocationArrayMutable(boolean [location] locations)
{
    boolean [location] result;
    foreach k in locations
        result[k] = locations[k];
    
    return result;
}

boolean [skill] makeConstantSkillArrayMutable(boolean [skill] array)
{
    boolean [skill] result;
    foreach k in array
        result[k] = array[k];
    
    return result;
}

boolean [effect] makeConstantEffectArrayMutable(boolean [effect] array)
{
    boolean [effect] result;
    foreach k in array
        result[k] = array[k];
    
    return result;
}

//Same as my_primestat(), except refers to substat
stat my_primesubstat()
{
	if (my_primestat() == $stat[muscle])
		return $stat[submuscle];
	else if (my_primestat() == $stat[mysticality])
		return $stat[submysticality];
	else if (my_primestat() == $stat[moxie])
		return $stat[submoxie];
	return $stat[none];
}

item [int] items_missing(boolean [item] items)
{
    item [int] result;
    foreach it in items
    {
        if (it.available_amount() == 0)
            result.listAppend(it);
    }
    return result;
}

skill [int] skills_missing(boolean [skill] skills)
{
    skill [int] result;
    foreach s in skills
    {
        if (!s.have_skill())
            result.listAppend(s);
    }
    return result;
}

int storage_amount(boolean [item] items)
{
    int count = 0;
    foreach it in items
    {
        count += it.storage_amount();
    }
    return count;
}

int available_amount(boolean [item] items)
{
    //Usage:
    //$items[disco ball, corrupted stardust].available_amount()
    //Returns the total number of all items.
    int count = 0;
    foreach it in items
    {
        count += it.available_amount();
    }
    return count;
}

int creatable_amount(boolean [item] items)
{
    //Usage:
    //$items[disco ball, corrupted stardust].available_amount()
    //Returns the total number of all items.
    int count = 0;
    foreach it in items
    {
        count += it.creatable_amount();
    }
    return count;
}

int item_amount(boolean [item] items)
{
    int count = 0;
    foreach it in items
    {
        count += it.item_amount();
    }
    return count;
}

int have_effect(boolean [effect] effects)
{
    int count = 0;
    foreach e in effects
        count += e.have_effect();
    return count;
}

int available_amount(item [int] items)
{
    int count = 0;
    foreach key in items
    {
        count += items[key].available_amount();
    }
    return count;
}

int available_amount_ignoring_storage(item it)
{
    if (!in_ronin())
        return it.available_amount() - it.storage_amount();
    else
        return it.available_amount();
}

int available_amount_ignoring_closet(item it)
{
    if (get_property_boolean("autoSatisfyWithCloset"))
        return it.available_amount() - it.closet_amount();
    else
        return it.available_amount();
}

int available_amount_including_closet(item it)
{
    if (get_property_boolean("autoSatisfyWithCloset"))
        return it.available_amount();
    else
        return it.available_amount() + it.closet_amount();
}

//Display case, etc
//WARNING: Does not take into account your shop. Conceptually, the shop is things you're getting rid of... and they might be gone already.
int item_amount_almost_everywhere(item it)
{
    return it.closet_amount() + it.display_amount() + it.equipped_amount() + it.item_amount() + it.storage_amount();
}

//Similar to item_amount_almost_everywhere, but won't trigger a display case load unless it has to:
boolean haveAtLeastXOfItemEverywhere(item it, int amount)
{
    int total = 0;
    total += it.item_amount();
    if (total >= amount) return true;
    total += it.equipped_amount();
    if (total >= amount) return true;
    total += it.closet_amount();
    if (total >= amount) return true;
    total += it.storage_amount();
    if (total >= amount) return true;
    total += it.display_amount();
    if (total >= amount) return true;
    
    return false;
}

int equipped_amount(boolean [item] items)
{
    int count = 0;
    foreach it in items
    {
        count += it.equipped_amount();
    }
    return count;
}

int [item] creatable_items(boolean [item] items)
{
    int [item] creatable_items;
    foreach it in items
    {
        if (it.creatable_amount() == 0)
            continue;
        creatable_items[it] = it.creatable_amount();
    }
    return creatable_items;
}


item [slot] equipped_items()
{
    item [slot] result;
    foreach s in $slots[]
    {
        item it = s.equipped_item();
        if (it == $item[none])
            continue;
        result[s] = it;
    }
    return result;
}

//Have at least one of these familiars:
boolean have_familiar_replacement(boolean [familiar] familiars)
{
    foreach f in familiars
    {
        if (f.have_familiar())
            return true;
    }
    return false;
}

item [int] missing_outfit_components(string outfit_name)
{
    item [int] outfit_pieces = outfit_pieces(outfit_name);
    item [int] missing_components;
    foreach key in outfit_pieces
    {
        item it = outfit_pieces[key];
        if (it.available_amount() == 0)
            missing_components.listAppend(it);
    }
    return missing_components;
}


//have_outfit() will tell you if you have an outfit, but only if you pass stat checks. This does not stat check:
boolean have_outfit_components(string outfit_name)
{
    return (outfit_name.missing_outfit_components().count() == 0);
}

//Non-API-related functions:

boolean playerIsLoggedIn()
{
    return !(my_hash().length() == 0 || my_id() == 0);
}

int substatsForLevel(int level)
{
	if (level == 1)
		return 0;
	return pow2i(pow2i(level - 1) + 4);
}

int availableFullness()
{
	int limit = fullness_limit();
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING && limit == 0 && $skill[Replacement Stomach].have_skill())
    {
        limit += 5;
    }
	return limit - my_fullness();
}

int availableDrunkenness()
{
    int limit = inebriety_limit();
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING && limit == 0 && $skill[Replacement Liver].have_skill())
    {
    	limit += 5;
    }
    if (limit == 0) return 0; //certain edge cases
	return limit - my_inebriety();
}

int availableSpleen()
{
	int limit = spleen_limit();
	if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING && limit == 0)
	{
        limit += 5; //always true
		//mafia resets the limits to zero in the underworld because it does, so anti-mafia:
        foreach s in $skills[Extra Spleen,Another Extra Spleen,Yet Another Extra Spleen,Still Another Extra Spleen,Just One More Extra Spleen,Okay Seriously\, This is the Last Spleen]
        {
        	if (s.have_skill())
         		limit += 5;
        }
	} 
	return limit - my_spleen_use();
}

item [int] missingComponentsToMakeItemPrivateImplementation(item it, int it_amounted_needed, int recursion_limit_remaining)
{
	item [int] result;
    if (recursion_limit_remaining <= 0) //possible loop
        return result;
    if ($items[dense meat stack,meat stack] contains it) return listMake(it); //meat from yesterday + fairy gravy boat? hmm... no
	if (it.available_amount() >= it_amounted_needed)
        return result;
	int [item] ingredients = get_ingredients_fast(it);
	if (ingredients.count() == 0)
    {
        for i from 1 to (it_amounted_needed - it.available_amount())
            result.listAppend(it);
    }
	foreach ingredient in ingredients
	{
		int ingredient_amounted_needed = ingredients[ingredient];
		if (ingredient.available_amount() >= ingredient_amounted_needed) //have enough
            continue;
		//split:
		item [int] r = missingComponentsToMakeItemPrivateImplementation(ingredient, ingredient_amounted_needed, recursion_limit_remaining - 1);
        if (r.count() > 0)
        {
            result.listAppendList(r);
        }
	}
	return result;
}

item [int] missingComponentsToMakeItem(item it, int it_amounted_needed)
{
    return missingComponentsToMakeItemPrivateImplementation(it, it_amounted_needed, 30);
}


item [int] missingComponentsToMakeItem(item it)
{
    return missingComponentsToMakeItem(it, 1);
}

string [int] missingComponentsToMakeItemInHumanReadableFormat(item it)
{
    item [int] parts = missingComponentsToMakeItem(it);
    
    int [item] parts_inverted;
    foreach key, it2 in parts
    {
        parts_inverted[it2] += 1;
    }
    string [int] result;
    foreach it2, amount in parts_inverted
    {
        string line = amount;
        line += " more ";
        if (amount > 1)
            line += it2.plural;
        else
            line += it2.to_string();
        result.listAppend(line);
    }
    return result;
}

//For tracking time deltas. Won't accurately compare across day boundaries and isn't monotonic (be wary of negative deltas), but still useful for temporal rate limiting.
int getMillisecondsOfToday()
{
    //To replicate value in GCLI:
    //ash (now_to_string("H").to_int() * 60 * 60 * 1000 + now_to_string("m").to_int() * 60 * 1000 + now_to_string("s").to_int() * 1000 + now_to_string("S").to_int())
    return now_to_string("H").to_int_silent() * 60 * 60 * 1000 + now_to_string("m").to_int_silent() * 60 * 1000 + now_to_string("s").to_int_silent() * 1000 + now_to_string("S").to_int_silent();
}

//WARNING: Only accurate for up to five turns.
//It also will not work properly in certain areas, and possibly across day boundaries. Actually, it's kind of a hack.
//But now we have turns_spent so no need to worry.
int combatTurnsAttemptedInLocation(location place)
{
    int count = 0;
    if (place.combat_queue != "")
        count += place.combat_queue.split_string_alternate("; ").count();
    return count;
}

int noncombatTurnsAttemptedInLocation(location place)
{
    int count = 0;
    if (place.noncombat_queue != "")
        count += place.noncombat_queue.split_string_alternate("; ").count();
    return count;
}

int turnsAttemptedInLocation(location place)
{
    return place.turns_spent;
}

int turnsAttemptedInLocation(boolean [location] places)
{
    int count = 0;
    foreach place in places
        count += place.turnsAttemptedInLocation();
    return count;
}

string [int] locationSeenNoncombats(location place)
{
    return place.noncombat_queue.split_string_alternate("; ");
}

string [int] locationSeenCombats(location place)
{
    return place.combat_queue.split_string_alternate("; ");
}

string lastNoncombatInLocation(location place)
{
    if (place.noncombat_queue != "")
        return place.locationSeenNoncombats().listLastObject();
    return "";
}

string lastCombatInLocation(location place)
{
    if (place.noncombat_queue != "")
        return place.locationSeenCombats().listLastObject();
    return "";
}

static
{
    int [location] __place_delays;
    __place_delays[$location[the spooky forest]] = 5;
    __place_delays[$location[the haunted bedroom]] = 6; //a guess from spading
    __place_delays[$location[the boss bat's lair]] = 4;
    __place_delays[$location[the oasis]] = 5;
    __place_delays[$location[the hidden park]] = 6; //6? does turkey blaster give four turns sometimes...?
    __place_delays[$location[the haunted gallery]] = 5; //FIXME this is a guess, spade
    __place_delays[$location[the haunted bathroom]] = 5;
    __place_delays[$location[the haunted ballroom]] = 5; //FIXME rumored
    __place_delays[$location[the penultimate fantasy airship]] = 25;
    __place_delays[$location[the "fun" house]] = 10;
    __place_delays[$location[The Castle in the Clouds in the Sky (Ground Floor)]] = 10;
    __place_delays[$location[the outskirts of cobb's knob]] = 10;
    __place_delays[$location[the hidden apartment building]] = 8;
    __place_delays[$location[the hidden office building]] = 10;
    __place_delays[$location[the upper chamber]] = 5;
}

int totalDelayForLocation(location place)
{
    //the haunted billiards room does not contain delay
    //also failure at 16 skill
    
    if (__place_delays contains place)
        return __place_delays[place];
    return -1;
}

int delayRemainingInLocation(location place)
{
    int delay_for_place = place.totalDelayForLocation();
    
    if (delay_for_place == -1)
        return -1;
    
    int turns_attempted = place.turns_spent;
    
    return MAX(0, delay_for_place - turns_attempted);
}

int turnsCompletedInLocation(location place)
{
    return place.turnsAttemptedInLocation(); //FIXME make this correct
}

//Backwards compatibility:
//We want to be able to support new content with daily builds. But, we don't want to ask users to run a daily build.
//So these act as replacements for new content. Unknown lookups are given as $type[none] The goal is to have compatibility with the last major release.
//We use this instead of to_item() conversion functions, so we can easily identify them in the source.
item lookupItem(string name)
{
    return name.to_item();
}

boolean [item] lookupItems(string names) //CSV input
{
    boolean [item] result;
    string [int] item_names = split_string_alternate(names, ",");
    foreach key in item_names
    {
        item it = item_names[key].to_item();
        if (it == $item[none])
            continue;
        result[it] = true;
    }
    return result;
}

boolean [item] lookupItemsArray(boolean [string] names)
{
    boolean [item] result;
    
    foreach item_name in names
    {
        item it = item_name.to_item();
        if (it == $item[none])
            continue;
        result[it] = true;
    }
    return result;
}

skill lookupSkill(string name)
{
    return name.to_skill();
}

boolean [skill] lookupSkills(string names) //CSV input
{
    boolean [skill] result;
    string [int] skill_names = split_string_alternate(names, ",");
    foreach key in skill_names
    {
        skill s = skill_names[key].to_skill();
        if (s == $skill[none])
            continue;
        result[s] = true;
    }
    return result;
}


//lookupSkills(string) will be called instead if we keep the same name, so use a different name:
boolean [skill] lookupSkillsInt(boolean [int] skill_ids)
{
    boolean [skill] result;
    foreach skill_id in skill_ids
    {
        skill s = skill_id.to_skill();
        if (s == $skill[none])
            continue;
        result[s] = true;
    }
    return result;
}

effect lookupEffect(string name)
{
    return name.to_effect();
}

familiar lookupFamiliar(string name)
{
    return name.to_familiar();
}

location lookupLocation(string name)
{
    return name.to_location();
    /*l = name.to_location();
    if (__setting_debug_mode && l == $location[none])
        print_html("Unable to find location \"" + name + "\"");
    return l;*/
}

boolean [location] lookupLocations(string names_string)
{
    boolean [location] result;
    
    string [int] names = names_string.split_string(",");
    foreach key, name in names
    {
        if (name.length() == 0)
            continue;
        location l = name.to_location();
        if (l != $location[none])
            result[l] = true;
    }
    
    return result;
}

monster lookupMonster(string name)
{
    return name.to_monster();
}

boolean [monster] lookupMonsters(string names_string)
{
    boolean [monster] result;
    
    string [int] names = names_string.split_string(",");
    foreach key, name in names
    {
        if (name.length() == 0)
            continue;
        monster m = name.to_monster();
        if (m != $monster[none])
            result[m] = true;
    }
    
    return result;
}

class lookupClass(string name)
{
    return name.to_class();
}

boolean monsterDropsItem(monster m, item it)
{
	//record [int] drops = m.item_drops_array();
	foreach key in m.item_drops_array()
	{
		if (m.item_drops_array()[key].drop == it)
			return true;
	}
	return false;
}


Record StringHandle
{
    string s;
};

Record FloatHandle
{
    float f;
};


buffer generateTurnsToSeeNoncombat(int combat_rate, int noncombats_in_zone, string task, int max_turns_between_nc, int extra_starting_turns)
{
    float turn_estimation = -1.0;
    float combat_rate_modifier = combat_rate_modifier();
    float noncombat_rate = 1.0 - (combat_rate + combat_rate_modifier).to_float() / 100.0;
    
    
    if (noncombats_in_zone > 0)
    {
        float minimum_nc_rate = 0.0;
        if (max_turns_between_nc != 0)
            minimum_nc_rate = 1.0 / max_turns_between_nc.to_float();
        if (noncombat_rate < minimum_nc_rate)
            noncombat_rate = minimum_nc_rate;
        
        if (noncombat_rate > 0.0)
            turn_estimation = noncombats_in_zone.to_float() / noncombat_rate;
    }
    else
        turn_estimation = 0.0;
    
    turn_estimation += extra_starting_turns;
    
    
    buffer result;
    
    if (turn_estimation == -1.0)
    {
        result.append("Impossible");
    }
    else
    {
        result.append("~");
        result.append(turn_estimation.roundForOutput(1));
        if (turn_estimation == 1.0)
            result.append(" turn");
        else
            result.append(" turns");
    }
    
    if (task != "")
    {
        result.append(" to ");
        result.append(task);
    }
    else
    {
        if (turn_estimation == -1.0)
        {
        }
        else if (turn_estimation == 1.0)
            result.append(" remains");
        else
            result.append(" remain");
    }
    if (noncombats_in_zone > 0)
    {
        result.append(" at ");
        result.append(combat_rate_modifier.floor());
        result.append("% combat rate");
    }
    result.append(".");
    
    return result;
}

buffer generateTurnsToSeeNoncombat(int combat_rate, int noncombats_in_zone, string task, int max_turns_between_nc)
{
    return generateTurnsToSeeNoncombat(combat_rate, noncombats_in_zone, task, max_turns_between_nc, 0);
}

buffer generateTurnsToSeeNoncombat(int combat_rate, int noncombats_in_zone, string task)
{
    return generateTurnsToSeeNoncombat(combat_rate, noncombats_in_zone, task, 0);
}


int damageTakenByElement(int base_damage, float elemental_resistance)
{
    if (base_damage < 0)
        return 1;
    
    float effective_base_damage = MAX(30, base_damage).to_float();
    
    return MAX(1, ceil(base_damage.to_float() - effective_base_damage * elemental_resistance));
}

int damageTakenByElement(int base_damage, element e)
{
    float elemental_resistance = e.elemental_resistance() / 100.0;
    
    //mafia might already do this for us already, but I haven't checked:
    
    if (e == $element[cold] && $effect[coldform].have_effect() > 0)
        elemental_resistance = 1.0;
    else if (e == $element[hot] && $effect[hotform].have_effect() > 0)
        elemental_resistance = 1.0;
    else if (e == $element[sleaze] && $effect[sleazeform].have_effect() > 0)
        elemental_resistance = 1.0;
    else if (e == $element[spooky] && $effect[spookyform].have_effect() > 0)
        elemental_resistance = 1.0;
    else if (e == $element[stench] && $effect[stenchform].have_effect() > 0)
        elemental_resistance = 1.0;
        
        
    return damageTakenByElement(base_damage, elemental_resistance);
}

boolean locationHasPlant(location l, string plant_name)
{
    string [int] plants_in_place = get_florist_plants()[l];
    foreach key in plants_in_place
    {
        if (plants_in_place[key] == plant_name)
            return true;
    }
    return false;
}

float initiative_modifier_ignoring_plants()
{
    //FIXME strange bug here, investigate
    //seen in cyrpt
    float init = initiative_modifier();
    
    location my_location = my_location();
    if (my_location != $location[none] && (my_location.locationHasPlant("Impatiens") || my_location.locationHasPlant("Shuffle Truffle")))
        init -= 25.0;
    
    return init;
}

float item_drop_modifier_ignoring_plants()
{
    float modifier = item_drop_modifier();
    
    location my_location = my_location();
    if (my_location != $location[none])
    {
        if (my_location.locationHasPlant("Rutabeggar") || my_location.locationHasPlant("Stealing Magnolia"))
            modifier -= 25.0;
        if (my_location.locationHasPlant("Kelptomaniac"))
            modifier -= 40.0;
    }
    return modifier;
}

int monster_level_adjustment_ignoring_plants() //this is unsafe to use in heavy rains
{
    //FIXME strange bug possibly here, investigate
    int ml = monster_level_adjustment();
    
    location my_location = my_location();
    
    if (my_location != $location[none])
    {
        string [3] location_plants = get_florist_plants()[my_location];
        foreach key in location_plants
        {
            string plant = location_plants[key];
            if (plant == "Rabid Dogwood" || plant == "War Lily"  || plant == "Blustery Puffball")
            {
                ml -= 30;
                break;
            }
        }
        
    }
    return ml;
}

int water_level_of_location(location l)
{
    int water_level = 1;
    if (l.recommended_stat >= 40) //FIXME is this threshold spaded?
        water_level += 1;
    if (l.environment == "indoor")
        water_level += 2;
    if (l.environment == "underground" || l == $location[the lower chambers]) //per-location fix
        water_level += 4;
    water_level += numeric_modifier("water level");
    
    water_level = clampi(water_level, 1, 6);
    if (l.environment == "underwater") //or does the water get the rain instead? nobody knows, rain man
        water_level = 0; //the aquaman hates rain man, they have a fight, aquaman wins
    return water_level;
}

float washaway_rate_of_location(location l)
{
    //Calculate washaway chance:
    int current_water_level = l.water_level_of_location();
    
    int washaway_chance = current_water_level * 5;
    if ($item[fishbone catcher's mitt].equipped_amount() > 0)
        washaway_chance -= 15; //GUESS
    
    if ($effect[Fishy Whiskers].have_effect() > 0)
    {
        //washaway_chance -= ?; //needs spading
    }
    return clampNormalf(washaway_chance / 100.0);
}

int monster_level_adjustment_for_location(location l)
{
    int ml = monster_level_adjustment_ignoring_plants();
    
    if (l.locationHasPlant("Rabid Dogwood") || l.locationHasPlant("War Lily") || l.locationHasPlant("Blustery Puffball"))
    {
        ml += 30;
    }
    
    if (my_path_id() == PATH_HEAVY_RAINS)
    {
        //complicated:
        //First, cancel out the my_location() rain:
        int my_location_water_level_ml = monster_level_adjustment() - numeric_modifier("Monster Level");
        ml -= my_location_water_level_ml;
        
        //Now, calculate the water level for the location:
        int water_level = water_level_of_location(l);
        
        //Add that as ML:
        if (!($locations[oil peak,the typical tavern cellar] contains l)) //kind of hacky to put this here, sorry
        {
            ml += water_level * 10;
        }
    }
    
    return ml;
}

float initiative_modifier_for_location(location l)
{
    float base = initiative_modifier_ignoring_plants();
    
    if (l.locationHasPlant("Impatiens") || l.locationHasPlant("Shuffle Truffle"))
        base += 25.0;
    return base;
}

float item_drop_modifier_for_location(location l)
{
    int base = item_drop_modifier_ignoring_plants();
    if (l.locationHasPlant("Rutabeggar") || l.locationHasPlant("Stealing Magnolia"))
        base += 25.0;
    if (l.locationHasPlant("Kelptomaniac"))
        base += 40.0;
    return base;
}

int monsterExtraInitForML(int ml)
{
	if (ml < 21)
		return 0.0;
	else if (ml < 41)
		return 0.0 + 1.0 * (ml - 20.0);
	else if (ml < 61)
		return 20.0 + 2.0 * (ml - 40.0);
	else if (ml < 81)
		return 60.0 + 3.0 * (ml - 60.0);
	else if (ml < 101)
		return 120.0 + 4.0 * (ml - 80.0);
	else
		return 200.0 + 5.0 * (ml - 100.0);
}

int stringCountSubstringMatches(string str, string substring)
{
    int count = 0;
    int position = 0;
    int breakout = 100;
    int str_length = str.length(); //uncertain whether this is a constant time operation
    while (breakout > 0 && position + 1 < str_length)
    {
        position = str.index_of(substring, position + 1);
        if (position != -1)
            count += 1;
        else
            break;
        breakout -= 1;
    }
    return count;
}

effect to_effect(item it)
{
	return it.effect_modifier("effect");
}



boolean weapon_is_club(item it)
{
    if (it.to_slot() != $slot[weapon]) return false;
    if (it.item_type() == "club")
        return true;
    if (it.item_type() == "sword" && $effect[Iron Palms].have_effect() > 0)
        return true;
    return false;
}

buffer prepend(buffer in_buffer, buffer value)
{
    buffer result;
    result.append(value);
    result.append(in_buffer);
    in_buffer.set_length(0);
    in_buffer.append(result);
    return result;
}

buffer prepend(buffer in_buffer, string value)
{
    return prepend(in_buffer, value.to_buffer());
}

float pressurePenaltyForLocation(location l, Error could_get_value)
{
    float pressure_penalty = 0.0;
    
    if (my_location() != l)
    {
        ErrorSet(could_get_value);
        return -1.0;
    }
    
    pressure_penalty = MAX(0, -numeric_modifier("item drop penalty"));
    return pressure_penalty;
}

int XiblaxianHoloWristPuterTurnsUntilNextItem()
{
    int drops = get_property_int("_holoWristDrops");
    int progress = get_property_int("_holoWristProgress");
    
    //_holoWristProgress resets when drop happens
    int next_turn_hit = 5 * (drops + 1) + 6;
    return MAX(0, next_turn_hit - progress);
}

int ka_dropped(monster m)
{
    if (m.phylum == $phylum[dude] || m.phylum == $phylum[hobo] || m.phylum == $phylum[hippy] || m.phylum == $phylum[pirate])
        return 2;
    if (m.phylum == $phylum[goblin] || m.phylum == $phylum[humanoid] || m.phylum == $phylum[beast] || m.phylum == $phylum[bug] || m.phylum == $phylum[orc] || m.phylum == $phylum[elemental] || m.phylum == $phylum[elf] || m.phylum == $phylum[penguin])
        return 1;
    return 0;
}


boolean is_underwater_familiar(familiar f)
{
    return $familiars[Barrrnacle,Emo Squid,Cuddlefish,Imitation Crab,Magic Dragonfish,Midget Clownfish,Rock Lobster,Urchin Urchin,Grouper Groupie,Squamous Gibberer,Dancing Frog,Adorable Space Buddy] contains f;
}

float calculateCurrentNinjaAssassinMaxDamage()
{
    
	//float assassin_ml = 155.0 + monster_level_adjustment();
    float assassin_ml = $monster[ninja snowman assassin].base_attack + 5.0;
	float damage_absorption = raw_damage_absorption();
	float damage_reduction = damage_reduction();
	float moxie = my_buffedstat($stat[moxie]);
	float cold_resistance = numeric_modifier("cold resistance");
	float v = 0.0;
	
	//spaded by yojimboS_LAW
	//also by soirana
    
	float myst_class_extra_cold_resistance = 0.0;
	if (my_class() == $class[pastamancer] || my_class() == $class[sauceror] || my_class() == $class[avatar of jarlsberg])
		myst_class_extra_cold_resistance = 0.05;
	//Direct from the spreadsheet:
	if (cold_resistance < 9)
		v = ((((MAX((assassin_ml - moxie), 0.0) - damage_reduction) + 120.0) * MAX(0.1, MIN((1.1 - sqrt((damage_absorption/1000.0))), 1.0))) * ((1.0 - myst_class_extra_cold_resistance) - ((0.1) * MAX((cold_resistance - 5.0), 0.0))));
	else
		v = ((((MAX((assassin_ml - moxie), 0.0) - damage_reduction) + 120.0) * MAX(0.1, MIN((1.1 - sqrt((damage_absorption/1000.0))), 1.0))) * (0.1 - myst_class_extra_cold_resistance + (0.5 * (powf((5.0/6.0), (cold_resistance - 9.0))))));
	
    
    
	return v;
}

float calculateCurrentNinjaAssassinMaxEnvironmentalDamage()
{
    float v = 0.0;
    int ml_level = monster_level_adjustment_ignoring_plants();
    if (ml_level >= 25)
    {
        float expected_assassin_damage = 0.0;
        
        expected_assassin_damage = ((150 + ml_level) * (ml_level - 25)).to_float() / 500.0;
        
        expected_assassin_damage = expected_assassin_damage + ceiling(expected_assassin_damage / 11.0); //upper limit
        
        //FIXME add in resists later
        //Resists don't work properly. They have an effect, but it's different. I don't know how much exactly, so for now, ignore this:
        //I think they're probably just -5 like above
        //expected_assassin_damage = damageTakenByElement(expected_assassin_damage, $element[cold]);
        
        expected_assassin_damage = ceil(expected_assassin_damage);
        
        v += expected_assassin_damage;
    }
    return v;
}

//mafia describes "merkin" for the "mer-kin" phylum, which "to_phylum()" does not interpret
//hmm... maybe file a request for to_phylum() to parse that
phylum getDNASyringePhylum()
{
    string phylum_text = get_property("dnaSyringe");
    if (phylum_text == "merkin")
        return $phylum[mer-kin];
    else
        return phylum_text.to_phylum();
}

int nextLibramSummonMPCost()
{
    int libram_summoned = get_property_int("libramSummons");
    int next_libram_summoned = libram_summoned + 1;
    int libram_mp_cost = MAX(1 + (next_libram_summoned * (next_libram_summoned - 1)/2) + mana_cost_modifier(), 1);
    return libram_mp_cost;
}

int maximumSimultaneous1hWeaponsEquippable()
{
    int weapon_maximum = 1;
    if ($skill[double-fisted skull smashing].skill_is_usable())
        weapon_maximum += 1;
    if (my_familiar() == $familiar[disembodied hand])
        weapon_maximum += 1;
    return weapon_maximum;
}

int equippable_amount(item it)
{
    if (!it.can_equip()) return it.equipped_amount();
    if (it.available_amount() == 0) return 0;
    if ($slots[acc1, acc2, acc3] contains it.to_slot() && it.available_amount() > 1 && !it.boolean_modifier("Single equip"))
        return MIN(3, it.available_amount());
    if (it.to_slot() == $slot[weapon] && it.weapon_hands() == 1)
    {
        return MIN(maximumSimultaneous1hWeaponsEquippable(), it.available_amount());
    }
    return 1;
}

boolean haveSeenBadMoonEncounter(int encounter_id)
{
    if (!get_property_ascension("lastBadMoonReset")) //badMoonEncounter values are not reset when you ascend
        return false;
    return get_property_boolean("badMoonEncounter" + encounter_id);
}

//FIXME make this use static etc. Probably extend Item Filter.ash to support equipment.
item [int] generateEquipmentForExtraExperienceOnStat(stat desired_stat, boolean require_can_equip_currently)
{
    //boolean [item] experience_percent_modifiers;
    /*string numeric_modifier_string;
    if (desired_stat == $stat[muscle])
    {
        //experience_percent_modifiers = $items[trench lighter,fake washboard];
        numeric_modifier_string = "Muscle";
    }
    else if (desired_stat == $stat[mysticality])
    {
        //experience_percent_modifiers = lookupItems("trench lighter,basaltamander buckler");
        numeric_modifier_string = "Mysticality";
    }
    else if (desired_stat == $stat[moxie])
    {
        //experience_percent_modifiers = $items[trench lighter,backwoods banjo];
        numeric_modifier_string = "Moxie";
    }
    else
        return listMakeBlankItem();
    if (numeric_modifier_string != "")
        numeric_modifier_string += " Experience Percent";*/
        
    item [slot] item_slots;
    string numeric_modifier_string = desired_stat + " Experience Percent";

    //foreach it in experience_percent_modifiers
    foreach it in equipmentWithNumericModifier(numeric_modifier_string)
    {
    	slot s = it.to_slot();
        if (s == $slot[shirt] && !(lookupSkill("Torso Awareness").have_skill() || $skill[Best Dressed].have_skill()))
        	continue;
        if (it.available_amount() > 0 && (!require_can_equip_currently || it.can_equip()) && item_slots[it.to_slot()].numeric_modifier(numeric_modifier_string) < it.numeric_modifier(numeric_modifier_string))
        {
            item_slots[it.to_slot()] = it;
        }
    }
    
    item [int] items_could_equip;
    foreach s, it in item_slots
        items_could_equip.listAppend(it);
    return items_could_equip;
}


item [int] generateEquipmentToEquipForExtraExperienceOnStat(stat desired_stat)
{
    item [int] items_could_equip = generateEquipmentForExtraExperienceOnStat(desired_stat, true);
    item [int] items_equipping;
    foreach key, it in items_could_equip
    {
        if (it.equipped_amount() == 0)
        {
            items_equipping.listAppend(it);
        }
    }
    return items_equipping;
}



float averageAdventuresForConsumable(item it, boolean assume_monday)
{
	float adventures = 0.0;
	string [int] adventures_string = it.adventures.split_string("-");
	foreach key, v in adventures_string
	{
		float a = v.to_float();
		if (a < 0)
			continue;
		adventures += a * (1.0 / to_float(adventures_string.count()));
	}
    if (it == $item[affirmation cookie])
        adventures += 3;
    if (it == $item[White Citadel burger])
    {
        if (in_bad_moon())
            adventures = 2; //worst case scenario
        else
            adventures = 9; //saved across lifetimes
    }
	
	if ($skill[saucemaven].have_skill() && ($items[hot hi mein,cold hi mein,sleazy hi mein,spooky hi mein,stinky hi mein,Hell ramen,fettucini Inconnu,gnocchetti di Nietzsche,spaghetti with Skullheads,spaghetti con calaveras,Fleetwood mac 'n' cheese,haunted hell ramen] contains it))
	{
		if ($classes[sauceror,pastamancer] contains my_class())
			adventures += 5;
		else
			adventures += 3;
	}
	
    
	if ($skill[pizza lover].have_skill() && it.to_lower_case().contains_text("pizza"))
	{
		adventures += it.fullness;
	}
	if (it.to_lower_case().contains_text("lasagna") && !assume_monday)
		adventures += 5;
	//FIXME lasagna properly
	return adventures;
}

float averageAdventuresForConsumable(item it)
{
    return averageAdventuresForConsumable(it, false);
}

boolean [string] getInstalledSourceTerminalSingleChips()
{
    string [int] chips = get_property("sourceTerminalChips").split_string_alternate(",");
    boolean [string] result;
    foreach key, s in chips
        result[s] = true;
    return result;
}

boolean [skill] getActiveSourceTerminalSkills()
{
    string skill_1_name = get_property("sourceTerminalEducate1");
    string skill_2_name = get_property("sourceTerminalEducate2");
    
    boolean [skill] skills_have;
    if (skill_1_name != "")
        skills_have[skill_1_name.replace_string(".edu", "").to_skill()] = true;
    if (skill_2_name != "")
        skills_have[skill_2_name.replace_string(".edu", "").to_skill()] = true;
    return skills_have;
}

boolean monsterIsGhost(monster m)
{
    if (m.attributes.contains_text("GHOST"))
        return true;
    /*if ($monsters[Ancient ghost,Ancient protector spirit,Banshee librarian,Battlie Knight Ghost,Bettie Barulio,Chalkdust wraith,Claybender Sorcerer Ghost,Cold ghost,Contemplative ghost,Dusken Raider Ghost,Ghost,Ghost miner,Hot ghost,Lovesick ghost,Marcus Macurgeon,Marvin J. Sunny,Mayor Ghost,Mayor Ghost (Hard Mode),Model skeleton,Mortimer Strauss,Plaid ghost,Protector Spectre,Sexy sorority ghost,Sheet ghost,Sleaze ghost,Space Tourist Explorer Ghost,Spirit of New Wave (Inner Sanctum),Spooky ghost,Stench ghost,The ghost of Phil Bunion,Whatsian Commando Ghost,Wonderful Winifred Wongle] contains m)
        return true;
    if ($monsters[boneless blobghost,the ghost of Vanillica \"Trashblossom\" Gorton,restless ghost,The Icewoman,the ghost of Monsieur Baguelle,The ghost of Lord Montague Spookyraven,The Headless Horseman,The ghost of Ebenoozer Screege,The ghost of Sam McGee,The ghost of Richard Cockingham,The ghost of Jim Unfortunato,The ghost of Waldo the Carpathian,the ghost of Oily McBindle] contains m)
        return true;
    if ($monster[Emily Koops, a spooky lime] == m)
        return true;*/
    return false;
}

boolean item_is_pvp_stealable(item it)
{
	if (it == $item[amulet of yendor])
		return true;
	if (!it.tradeable)
		return false;
	if (!it.discardable)
		return false;
	if (it.quest)
		return false;
	if (it.gift)
		return false;
	return true;
}

int effective_familiar_weight(familiar f)
{
	if (f == $familiar[none]) return 0;
    int weight = f.familiar_weight();
    
    boolean is_moved = false;
    string [int] familiars_used_on = get_property("_feastedFamiliars").split_string_alternate(";");
    foreach key, f_name in familiars_used_on
    {
        if (f_name.to_familiar() == f)
        {
            is_moved = true;
            break;
        }
    }
    if (is_moved)
        weight += 10;
    return weight;
}

boolean year_is_leap_year(int year)
{
    if (year % 4 != 0) return false;
    if (year % 100 != 0) return true;
    if (year % 400 != 0) return false;
    return true;
}

boolean today_is_pvp_season_end()
{
    string today = format_today_to_string("MMdd");
    if (today == "0228")
    {
        int year = format_today_to_string("yyyy").to_int();
        boolean is_leap_year = year_is_leap_year(year);
        if (!is_leap_year)
            return true;
    }
    else if (today == "0229") //will always be true, but won't always be there
        return true;
    else if (today == "0430")
        return true;
    else if (today == "0630")
        return true;
    else if (today == "0831")
        return true;
    else if (today == "1031")
        return true;
    else if (today == "1231")
        return true;
    return false;
}

boolean monster_has_zero_turn_cost(monster m)
{
    if (m.attributes.contains_text("FREE"))
        return true;
    if (m == $monster[sausage goblin] && m != $monster[none]) return true;
    if ($monsters[LOV Engineer,LOV Enforcer,LOV Equivocator] contains m) return true;
        
    if ($monsters[lynyrd] contains m) return true; //not marked as FREE in attributes
    //if ($monsters[Black Crayon Beast,Black Crayon Beetle,Black Crayon Constellation,Black Crayon Golem,Black Crayon Demon,Black Crayon Man,Black Crayon Elemental,Black Crayon Crimbo Elf,Black Crayon Fish,Black Crayon Goblin,Black Crayon Hippy,Black Crayon Hobo,Black Crayon Shambling Monstrosity,Black Crayon Manloid,Black Crayon Mer-kin,Black Crayon Frat Orc,Black Crayon Penguin,Black Crayon Pirate,Black Crayon Flower,Black Crayon Slime,Black Crayon Undead Thing,Black Crayon Spiraling Shape,broodling seal,Centurion of Sparky,heat seal,hermetic seal,navy seal,Servant of Grodstank,shadow of Black Bubbles,Spawn of Wally,watertight seal,wet seal,lynyrd,BRICKO airship,BRICKO bat,BRICKO cathedral,BRICKO elephant,BRICKO gargantuchicken,BRICKO octopus,BRICKO ooze,BRICKO oyster,BRICKO python,BRICKO turtle,BRICKO vacuum cleaner,Witchess Bishop,Witchess King,Witchess Knight,Witchess Ox,Witchess Pawn,Witchess Queen,Witchess Rook,Witchess Witch,The ghost of Ebenoozer Screege,The ghost of Lord Montague Spookyraven,The ghost of Waldo the Carpathian,The Icewoman,The ghost of Jim Unfortunato,the ghost of Sam McGee,the ghost of Monsieur Baguelle,the ghost of Vanillica "Trashblossom" Gorton,the ghost of Oily McBindle,boneless blobghost,The ghost of Richard Cockingham,The Headless Horseman,Emily Koops\, a spooky lime,time-spinner prank,random scenester,angry bassist,blue-haired girl,evil ex-girlfriend,peeved roommate] contains m)
        //return true;
    if (m == $monster[X-32-F Combat Training Snowman] && get_property_int("_snojoFreeFights") < 10)
        return true;
    if (my_familiar() == $familiar[machine elf] && my_location() == $location[the deep machine tunnels] && get_property_int("_machineTunnelsAdv") < 5)
        return true;
    if ($monsters[terrible mutant,slime blob,government bureaucrat,angry ghost,annoyed snake] contains m && get_property_int("_voteFreeFights") < 3)
    	return true;
    if ($monsters[biker,burnout,jock,party girl,"plain" girl] contains m && get_property_int("_neverendingPartyFreeTurns") < 10)
    	return true;
    return false;
}

static
{
    int [location] __location_combat_rates;
}
void initialiseLocationCombatRates()
{
    if (__location_combat_rates.count() > 0)
        return;
    int [location] rates;
    file_to_map("data/combats.txt", __location_combat_rates);
    //needs spading:
    foreach l in $locations[the spooky forest]
        __location_combat_rates[l] = 85;
    __location_combat_rates[$location[the black forest]] = 95; //can't remember if this is correct
    __location_combat_rates[$location[inside the palindome]] = 80; //this is not accurate, there's probably a turn cap or something
    __location_combat_rates[$location[The Haunted Billiards Room]] = 85; //completely and absolutely wrong and unspaded; just here to make another script work
    foreach l in $locations[the haunted gallery, the haunted bathroom, the haunted ballroom]
        __location_combat_rates[l] = 90; //or 95? can't remember
    __location_combat_rates[$location[Twin Peak]] = 90; //FIXME assumption
    //print_html("__location_combat_rates = " + __location_combat_rates.to_json());
}
//initialiseLocationCombatRates();
int combatRateOfLocation(location l)
{
    initialiseLocationCombatRates();
    //Some revamps changed the combat rate; here we have some not-quite-true-but-close assumptions:
    if (l == $location[the haunted ballroom])
        return 95;
    if (__location_combat_rates contains l)
    {
        int rate = __location_combat_rates[l];
        if (rate < 0)
            rate = 100;
        return rate;
    }
    return 100; //Unknown
    
    /*float base_rate = l.appearance_rates()[$monster[none]];
    if (base_rate == 0.0)
        return 0;
    return base_rate + combat_rate_modifier();*/
}

//Specifically checks whether you can eat this item right now - fullness/drunkenness, meat, etc.
boolean CafeItemEdible(item it)
{
    //Mafia does not seem to support accessing its cafe data via ASH.
    //So, do the same thing. There's four mafia supports - Chez Snootee, Crimbo Cafe, Hell's Kitchen, and MicroBrewery.
    if (it.fullness > availableFullness())
        return false;
    if (it.inebriety > availableDrunkenness())
        return false;
    //FIXME rest
    if (it == $item[Jumbo Dr. Lucifer] && in_bad_moon() && my_meat() >= 150)
        return true;
    return false;
}

static
{
    int [string] __lta_social_capital_purchases;
    void initialiseLTASocialCapitalPurchases()
    {
        __lta_social_capital_purchases["bondAdv"] = 1;
        __lta_social_capital_purchases["bondBeach"] = 1;
        __lta_social_capital_purchases["bondBeat"] = 1;
        __lta_social_capital_purchases["bondBooze"] = 2;
        __lta_social_capital_purchases["bondBridge"] = 3;
        __lta_social_capital_purchases["bondDR"] = 1;
        __lta_social_capital_purchases["bondDesert"] = 5;
        __lta_social_capital_purchases["bondDrunk1"] = 2;
        __lta_social_capital_purchases["bondDrunk2"] = 3;
        __lta_social_capital_purchases["bondHP"] = 1;
        __lta_social_capital_purchases["bondHoney"] = 5;
        __lta_social_capital_purchases["bondInit"] = 1;
        __lta_social_capital_purchases["bondItem1"] = 1;
        __lta_social_capital_purchases["bondItem2"] = 2;
        __lta_social_capital_purchases["bondItem3"] = 4;
        __lta_social_capital_purchases["bondJetpack"] = 3;
        __lta_social_capital_purchases["bondMPregen"] = 3;
        __lta_social_capital_purchases["bondMartiniDelivery"] = 1;
        __lta_social_capital_purchases["bondMartiniPlus"] = 3;
        __lta_social_capital_purchases["bondMartiniTurn"] = 1;
        __lta_social_capital_purchases["bondMeat"] = 1;
        __lta_social_capital_purchases["bondMox1"] = 1;
        __lta_social_capital_purchases["bondMox2"] = 3;
        __lta_social_capital_purchases["bondMus1"] = 1;
        __lta_social_capital_purchases["bondMus2"] = 3;
        __lta_social_capital_purchases["bondMys1"] = 1;
        __lta_social_capital_purchases["bondMys2"] = 3;
        __lta_social_capital_purchases["bondSpleen"] = 4;
        __lta_social_capital_purchases["bondStat"] = 2;
        __lta_social_capital_purchases["bondStat2"] = 4;
        __lta_social_capital_purchases["bondStealth"] = 3;
        __lta_social_capital_purchases["bondStealth2"] = 4;
        __lta_social_capital_purchases["bondSymbols"] = 3;
        __lta_social_capital_purchases["bondWar"] = 3;
        __lta_social_capital_purchases["bondWeapon2"] = 3;
        __lta_social_capital_purchases["bondWpn"] = 1;
    }
    initialiseLTASocialCapitalPurchases();
}

int licenseToAdventureSocialCapitalAvailable()
{
    int total_social_capital = 0;
    total_social_capital += 1 + MIN(23, get_property_int("bondPoints"));
    foreach level in $ints[3,6,9,12,15]
    {
        if (my_level() >= level)
            total_social_capital += 1;
    }
    total_social_capital += 2 * get_property_int("bondVillainsDefeated");
    
    
    
    int social_capital_used = 0;
    foreach property_name, value in __lta_social_capital_purchases
    {
        if (get_property_boolean(property_name))
            social_capital_used += value;
    }
    //print_html("total_social_capital = " + total_social_capital + ", social_capital_used = " + social_capital_used);
    
    return total_social_capital - social_capital_used;
}



monster convertEncounterToMonster(string encounter)
{
    boolean [string] intergnat_strings;
    intergnat_strings[" WITH SCIENCE!"] = true;
    intergnat_strings["ELDRITCH HORROR "] = true;
    intergnat_strings[" WITH BACON!!!"] = true;
    intergnat_strings[" NAMED NEIL"] = true;
    intergnat_strings[" AND TESLA!"] = true;
    foreach s in intergnat_strings
    {
        if (encounter.contains_text(s))
            encounter = encounter.replace_string(s, "");
    }
    if (encounter == "The Junk") //not a junksprite
        return $monster[Junk];
    if ((encounter.stringHasPrefix("the ") || encounter.stringHasPrefix("The")) && encounter.to_monster() == $monster[none])
    {
        encounter = encounter.substring(4);
        //print_html("now \"" + encounter + "\"");
    }
    //if (encounter == "the X-32-F Combat Training Snowman")
        //return $monster[X-32-F Combat Training Snowman];
    if (encounter == "clingy pirate")
        return $monster[clingy pirate (male)]; //always accurate for my personal data
    return encounter.to_monster();
}

//Returns [0, 100]
float resistanceLevelToResistancePercent(float level)
{
	float m = 0;
	if (my_primestat() == $stat[mysticality])
		m = 5;
	if (level <= 3) return 10 * level + m;
    return 90 - 50 * powf(5.0 / 6.0, level - 4) + m;
}


//Mafia's text output doesn't handle very long strings with no spaces in them - they go horizontally past the text box. This is common for to_json()-types.
//So, add spaces every so often if we need them:
buffer processStringForPrinting(string str)
{
    buffer out;
    int limit = 50;
    int comma_limit = 25;
    int characters_since_space = 0;
    for i from 0 to str.length() - 1
    {
        if (str.length() == 0) break;
        string c = str.char_at(i);
        out.append(c);
        
        if (c == " ")
            characters_since_space = 0;
        else
        {
            characters_since_space++;
            if (characters_since_space >= limit || (c == "," && characters_since_space >= comma_limit)) //prefer adding spaces after a comma
            {
                characters_since_space = 0;
                out.append(" ");
            }
        }
    }
    return out;
}
void printSilent(string line, string font_colour)
{
    print_html("<font color=\"" + font_colour + "\">" + line.processStringForPrinting() + "</font>");
}

void printSilent(string line)
{
    print_html(line.processStringForPrinting());
}

//have_equipped() exists
boolean equipped(item it)
{
	return it.equipped_amount() > 0;
}

boolean have(item it)
{
	return it.available_amount() > 0;
}

boolean canAccessMall()
{
	if (!can_interact()) return false;
	if (!get_property_boolean("autoSatisfyWithMall")) return false;
	if (my_ascensions() == 0 && !get_property_ascension("lastDesertUnlock")) return false;
	return true;
}

string generateEquipmentLink(item equipment)
{
	if (!equipment.have()) return "";
	if (equipment.equipped()) return "inventory.php?which=2";
	
	string ftext_value = equipment.replace_string(" ", "+").entity_encode();
	if (equipment.item_amount() == 0 && can_interact() && equipment.storage_amount() > 0) return "storage.php?which=2&ftext=" + ftext_value;
	return "inventory.php?which=2&ftext=" + ftext_value;
}

//it says "next NC will be" but it means, extremely specifically, a certain class of non-combats. I don't know how this skill interacts with superlikelies or those intro adventures and such
boolean locationNextNCWillBeCartography(location l)
{
    if (!lookupSkill("Comprehensive Cartography").skill_is_usable()) return false;
    
    //We use the following method to determine if cartography will fire:
    //We look for "relevant" NC names in recent noncombats in the zone. If any of the relevant NCs are there, then it won't happen.
    //The relevant NCs are the cartography NC, and the NCs it "replaces"
    //This can fail, if there is five outside-zone data points in noncombat_queue - which I think can happen sometimes?
    boolean [string] relevant_nc_names;
 
	//manually handle every NC:
    if (l == $location[Guano Junction]) //100%
    {
        relevant_nc_names = $strings[The Hidden Junction];
    }
    else if (l == $location[A-boo Peak]) //...unknown? 100%?
    {
        relevant_nc_names = $strings[Ghostly Memories];
    }
    else if (l == $location[the haunted billiards room]) //not 100%
    {
        relevant_nc_names = $strings[Billiards Room Options,That's your cue,Welcome To Our ool Table];
    }
    else if (l == $location[The Dark Neck of the Woods]) //not 100%
    {
        relevant_nc_names = $strings[Your Neck of the Woods,How Do We Do It? Quaint and Curious Volume!,Strike One!,Olive My Love To You\, Oh.,Dodecahedrariffic!];
    }
    else if (l == $location[The Defiled Nook]) //not 100%
    {
        relevant_nc_names = $strings[No Nook Unknown,Skull\, Skull\, Skull];
    }
    else if (l == $location[The Castle in the Clouds in the Sky (Top Floor)]) //not 100%
    {
        relevant_nc_names = $strings[Here There Be Giants,Copper Feel,Melon Collie and the Infinite Lameness,Yeah\, You're for Me\, Punk Rock Giant,Flavor of a Raver];
    }
    else if (l == $location[A Mob of Zeppelin Protesters]) //not 100%
    {
        relevant_nc_names = $strings[Mob Maptality,Bench Warrant,Fire Up Above,This Looks Like a Good Bush for an Ambush];
    }
    else if (l == $location[Frat House]) //not 100%. FIXME correct zone?
    {
        relevant_nc_names = $strings[Oh Yeah!,Purple Hazers,From Stoked to Smoked,Murder by Death,Sing This Explosion to Me]; //is this correct...?
    }
    else if (l == $location[Wartime Frat House (Hippy Disguise)]) //not 100%. FIXME correct zone?
    {
        relevant_nc_names = $strings[Sneaky\, Sneaky,Catching Some Zetas,Fratacombs,One Less Room Than In That Movie];
    }
    else if (l == $location[Wartime Hippy Camp (Frat Disguise)]) //not 100%. FIXME correct zone?
    {
        relevant_nc_names = $strings[Sneaky\, Sneaky,Bait and Switch,Blockin' Out the Scenery,The Thin Tie-Dyed Line];
    }
    
    if (relevant_nc_names.count() == 0) return false;
    
    
    foreach key, noncombat_name in l.locationSeenNoncombats()
    {
        if (relevant_nc_names[noncombat_name]) return false;
    }
    return true;
}

string getBasicItemDescription(item it)
{
	buffer out;
	
	string item_type = it.item_type();
	
	//if (item_type == "accessory") item_type = "acc";
	if (item_type == "container") item_type = "back";
	int weapon_hands = it.weapon_hands();
	
	if (weapon_hands != 0)
	{
        stat weapon_type = it.weapon_type();
        
		out.append(weapon_hands);
        out.append("h ");
        if (weapon_type == $stat[moxie])
        	out.append("ranged ");
        else
        	out.append("melee ");
	}
	
	out.append(item_type);
	return out.to_string();
}
boolean [item] __iotms_usable;

void initialiseIOTMsUsable()
{
    foreach key in __iotms_usable
        remove __iotms_usable[key];
    if (in_bad_moon())
        return;
    
    if (my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
    {
        int [item] campground = get_campground();
        //Campground items:
        foreach it in $items[source terminal, haunted doghouse, Witchess Set, potted tea tree, portable mayo clinic, Little Geneticist DNA-Splicing Lab, cornucopia]
        {
            if (campground contains it)
                __iotms_usable[it] = true;
        }
        if (campground contains $item[Asdon Martin keyfob])
            __iotms_usable[$item[Asdon Martin keyfob]] = true;
    }
    if (get_property_boolean("hasDetectiveSchool"))
        __iotms_usable[$item[detective school application]] = true;
    if (get_property_boolean("chateauAvailable") && my_path_id() != PATH_EXPLOSIONS)
        __iotms_usable[$item[Chateau Mantegna room key]] = true;
    if (get_property_boolean("barrelShrineUnlocked"))
        __iotms_usable[$item[shrine to the Barrel god]] = true;
    if (get_property_boolean("snojoAvailable"))
        __iotms_usable[$item[X-32-F snowman crate]] = true;
    if (get_property_boolean("telegraphOfficeAvailable"))
        __iotms_usable[$item[LT&T telegraph office deed]] = true;
    if (get_property_boolean("lovebugsUnlocked") && $item[hand turkey outline].is_unrestricted())
        __iotms_usable[$item[bottle of lovebug pheromones]] = true;
    if (get_property_boolean("loveTunnelAvailable"))
        __iotms_usable[$item[heart-shaped crate]] = true;
    if (get_property_boolean("spacegateAlways") || get_property_boolean("_spacegateToday"))
        __iotms_usable[$item[Spacegate access badge]] = true;
    if (my_path_id() == PATH_EXPLOSIONS)
    	__iotms_usable[$item[Spacegate access badge]] = false;
    if (get_property_boolean("gingerbreadCityAvailable") || get_property_boolean("_gingerbreadCityToday"))
        __iotms_usable[$item[Build-a-City Gingerbread kit]] = true;
    if ($item[kremlin's greatest briefcase].available_amount() > 0)
        __iotms_usable[$item[kremlin's greatest briefcase]] = true;
    if (get_property_boolean("horseryAvailable"))
        __iotms_usable[$item[Horsery contract]] = true;
    if ($item[genie bottle].available_amount() > 0)
        __iotms_usable[$item[genie bottle]] = true;
    if ($item[portable pantogram].available_amount() > 0)
        __iotms_usable[$item[portable pantogram]] = true;
    if ($item[January's Garbage Tote].available_amount() > 0)
        __iotms_usable[$item[January's Garbage Tote]] = true;
    if (get_property_boolean("coldAirportAlways") || get_property_boolean("_coldAirportToday"))
        __iotms_usable[$item[Airplane charter: The Glaciest]] = true;
    if (get_property_boolean("hotAirportAlways") || get_property_boolean("_hotAirportToday"))
        __iotms_usable[$item[Airplane charter: That 70s Volcano]] = true;
    if (get_property_boolean("sleazeAirportAlways") || get_property_boolean("_sleazeAirportToday"))
        __iotms_usable[$item[airplane charter: Spring Break Beach]] = true;
    if (get_property_boolean("spookyAirportAlways") || get_property_boolean("_spookyAirportToday"))
        __iotms_usable[$item[airplane charter: Conspiracy Island]] = true;
    if (get_property_boolean("stenchAirportAlways") || get_property_boolean("_stenchAirportToday"))
        __iotms_usable[$item[airplane charter: Dinseylandfill]] = true;
    if (get_property_boolean("_frToday") || get_property_boolean("frAlways"))
    	__iotms_usable[$item[FantasyRealm membership packet]] = true;
    if (get_property_boolean("_neverendingPartyToday") || get_property_boolean("neverendingPartyAlways"))
        __iotms_usable[$item[Neverending Party invitation envelope]] = true;
    if (get_property_boolean("_voteToday") || get_property_boolean("voteAlways"))
        __iotms_usable[$item[voter registration form]] = true;
    if (florist_available() && $item[hand turkey outline].is_unrestricted()) //Order of the Green Thumb Order Form is not marked as out of standard.
    	__iotms_usable[$item[Order of the Green Thumb Order Form]] = true;
    if (get_property_boolean("daycareOpen"))
    	__iotms_usable[$item[Boxing Day care package]] = true;
    if (get_property_boolean("getawayCampsiteUnlocked"))
        __iotms_usable[$item[Distant Woods Getaway Brochure]] = true;
    if ($item[clan vip lounge key].item_amount() > 0)
    {
    	//FIXME all
    	__iotms_usable[$item[Clan Carnival Game]] = true;
        __iotms_usable[$item[clan floundry]] = true;
    }
    //Remove non-standard:
    foreach it in __iotms_usable
    {
        if (!it.is_unrestricted() || it == $item[none])
            remove __iotms_usable[it];
    }
}

initialiseIOTMsUsable();
string [string] __user_preferences_private;
boolean __read_user_preferences_initially = false;



//File implementation:
//Preferred, but not chosen in case this somehow triggers an HD read too often:
/*string __user_preferences_file_name = "data/relay_ezandora_guide_preferences_" + my_id() + ".txt";
void readUserPreferences()
{
    __read_user_preferences_initially = true;
    file_to_map(__user_preferences_file_name, __user_preferences_private);
}

void writeUserPreferences()
{
    map_to_file(__user_preferences_private, __user_preferences_file_name);
}*/


string __user_preferences_property_name = "ezandora_guide_preferences";
void readUserPreferences()
{
    string [string] blank;
    __user_preferences_private = blank;
    string guide_value = get_property(__user_preferences_property_name);
    foreach key, pair in guide_value.split_string_alternate(";")
    {
        string [int] split = pair.split_string_alternate("=");
        if (split.count() != 2)
            continue;
        __user_preferences_private[split[0]] = split[1];
    }
    __read_user_preferences_initially = true;
}

void writeUserPreferences()
{
    if (!__read_user_preferences_initially)
        readUserPreferences();
    buffer output_value;
    boolean first = true;
    foreach key, value in __user_preferences_private
    {
        if (!first)
            output_value.append(";");
        else
            first = false;
        output_value.append(key);
        output_value.append("=");
        output_value.append(value);
    }
    set_property(__user_preferences_property_name, output_value);
}


string PreferenceGet(string name)
{
    if (!__read_user_preferences_initially)
        readUserPreferences();
    
    return __user_preferences_private[name];
}

boolean PreferenceGetBoolean(string name)
{
    return PreferenceGet(name).to_boolean();
}

void PreferenceSet(string name, string value)
{
	//print_html("PreferenceSet(" + name + ", " + value + ")");
    if (!__read_user_preferences_initially)
        readUserPreferences();
    __user_preferences_private[name] = value;
    writeUserPreferences();
}


void processSetUserPreferences(string [string] form_fields)
{
    foreach key, value in form_fields
    {
        if (key == "set user preferences")
            continue;
        PreferenceSet(key, value);
    }
}



static
{
    //mr. fusion:
    boolean [item] __pvpable_food_and_drinks;
    void initialisePVPFoodAndDrinks()
    {
        foreach it in $items[]
        {
            if (it.fullness == 0 && it.inebriety == 0) continue;
            if (!it.item_is_pvp_stealable()) continue;
            __pvpable_food_and_drinks[it] = true;
        }
    }
    initialisePVPFoodAndDrinks();
}

//Runtime variables:
location __last_adventure_location;


//Runtime call functions:

//Init functions happen after state and quest initialisation, so they can be referred to safely.
string [int] __init_functions;

void RegisterInitFunction(string function_name)
{
    __init_functions.listAppend(function_name);
}

string [int] __checklist_generation_function_names;

//Call function registration:
void RegisterChecklistGenerationFunction(string function_name)
{
    __checklist_generation_function_names.listAppend(function_name);
}


string [string][int] __specific_checklist_1_generation_function_names;
void RegisterSpecificChecklistGenerationFunction1(string function_name, string checklist_name_1)
{
    if (!(__specific_checklist_1_generation_function_names contains checklist_name_1))
    {
        __specific_checklist_1_generation_function_names[checklist_name_1] = listMakeBlankString();
    }
    __specific_checklist_1_generation_function_names[checklist_name_1].listAppend(function_name);
}

Record ChecklistGenerationFunctionRequest
{
    string function_name;
    string [int] checklist_names;
};

void listAppend(ChecklistGenerationFunctionRequest [int] list, ChecklistGenerationFunctionRequest entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

ChecklistGenerationFunctionRequest [int] __specific_checklist_generation_requests;

void RegisterSpecificChecklistGenerationFunction3(string function_name, string checklist_name_1, string checklist_name_2, string checklist_name_3)
{
    ChecklistGenerationFunctionRequest request;
    request.function_name = function_name;
    //Hardcoded to match call structure:
    request.checklist_names[0] = checklist_name_1;
    request.checklist_names[1] = checklist_name_2;
    request.checklist_names[2] = checklist_name_3;
    __specific_checklist_generation_requests.listAppend(request);
}

void RegisterResourceGenerationFunction(string function_name)
{
    RegisterSpecificChecklistGenerationFunction1(function_name, "Resources");
}

void RegisterTaskGenerationFunction(string function_name)
{
    RegisterSpecificChecklistGenerationFunction3(function_name, "Tasks", "Optional Tasks", "Future Tasks");
}


string [int] __generation_function_names;
void RegisterGenerationFunction(string function_name)
{
	__generation_function_names.listAppend(function_name);
}
string __close_image_data = "data:image/gif;base64,R0lGODlhgACAANUiAODg4IqKitra2o2NjYGBgdXV1YCAgOPj49vb24eHh4iIiIODg+fn5+Tk5NnZ2YmJidbW1ouLi9zc3M/Pz4WFhdTU1MDAwMfHx8HBwcrKysbGxtjY2Lu7u8XFxfj4+IKCgsTExH9/f/f39wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAACIALAAAAACAAIAAAAb/QJFwmBEMj8ikcslsOp/QaBOgcSIMBKN0y+16v0fAIlRgCgKhUOAAbrvfXcYgnagoL4Z0OuCA+/+AAHN6IRZIV4RpBn2AjY5bYolpZUJnkmkPbI+bnEhylyF1Ihl5oCEPG52qj4KmaSASBK4hi6u2cJGuBmUIEbOZt8Fen64JlCINvq4PjMLOTq3FAEgCsrrNz9lhY7oQSpbLmtraxKYKx0kHaMvY48HR5tNN1bO17u/cpgbeT+CmwPdWlQN1Toq6X+0CNoJHUJ4UetcUssoHap8Xf6AASvQz8FLBLwfZbcQ1KJ4biPoSjoRE8ZLFNxgvaVy5paOkj3BC/lNJkwlD/48O/aCsqKUntJaSXjaKKWmm0SQ2E+F0pDMjT6M/bwZ9NNRl0adCcunjp4ppIqc9oxKaqqqqzKsKs0rduqpr0q8jxVYkK8wsIbQB1ephK8xtU7jP5K6l68xuIgN4x+l1yXecXz2AnQlOQ3ic4bOIVSkezNidY0KQtU1OWlniZUzigm0O0VniZ0J8hI3mXHojAmumstxa/bh1z9dqYm+aXbtng3WmcnPaTbu30d+zhE+sZxxsJeig1jhijs57kuezpPuhrsC6eRHYXWl/Qxx19/dHkIt3Qx4/FPSuqOcFe+75N0R8wUUWRX16KGVgP+Bdsl9NJRFU3oNOABhdaGFUCP8UhlwgCMp8R3EHYhf6KadEfyd2oWF4cBHY4hciXkLiNibO+EWKUHl404U6bvGihF/JGGQbNUqiHYOK3HfkQxFKsgZ7QD7pYpRSAdeQlX4kOUtxXP6BnDlVhvnFkF9WZ2YjXo61piNjclbmm200oMCXFBRI54AffJnanoH4GJ6CgA6IlHyEFirFbBKqqOiCgqYZQKKPLsHklzdWysRsFJQSnaOadjhLAgDoR2mll+4iRJt6ZBrqbMbkhyVuoCpKHannzarHpKGGdShqVbKahqt7wjonArruUauZtxaIZiK8FprqnEcIGwKxVhq7BbLpLatjs1emd+qJ09KopY3jPqj/LRjcBuitgeC68Sxu6ZpXLhzWYovful0mm1yL8QIy7671rnSvI/kWLBG/j7T7qX8BczLwHgpL9muD1P6RsHcMr+JweO9KFqkeuDozsRoVD3exIhlvsvFIHTvzcaMbRazNydHec/A9L48TszszSxnyJjYrhHPKuKxMS8vZ9HzLz775O+EqRdN0tC07g+X0I1BfJ/XQA45Mh54rXe1I1v5t/UbX7wUNLdhPVP2g2W6gfaLaXLCNodu0giH3jMmIa2g9TGMYS3YV661jL91K8beVgQeYrt1rHo6oE4pzybi7PokdCtlcRh6dgpQXanmCnngea68HKvNwWKqDTqfog4pQT3qlHohw+ogCXDBq4YpuboohBdx5ScmsM0E7IRRMMAQELgGv6e56OH8EBomsnvwTwqfBgRLFj729FJE3zwT0qo4vxeHWM9GB9OojgEESQQAAOw==";
string __new_window_image_data = "data:image/gif;base64,R0lGODlhgACAANU7AImJiZiYmKCgoKenp/Dw8MjIyKGhoYyMjKioqLW1tZmZmYiIiISEhICAgIWFhfPz8+7u7ry8vIeHh6Ojo4aGhunp6dTU1JeXl+Tk5JycnLGxsaSkpI6Ojpubm4qKisXFxYKCgvb29u/v75+fn7S0tK6urqWlpb29vaKiotbW1q2trdPT08fHx9DQ0K+vr+3t7Y2NjZGRkaamptHR0bq6ure3t8bGxtfX16mpqbKysn9/f/f39wAAAAAAAAAAAAAAACH5BAEAADsALAAAAACAAIAAAAb/wJ1wSCwaj8ikcslsOp/QqHRKrVqv2Kx2y+16v+CweExGYjSZS2DNbrvf8Lh8Tq+/L5kcZrxq6P6AgYKDhIWGh4iJiQ0WYS8AipGSk5SUABBgNJWbnJ2TEWATnqOkpRtgI6Wqq5MCYAKssbKEBq+zt7O1X7C4vaq6XryDFALFxsfIycrLzM3OzQ6FwF3Cggpl2DsB0raE19lk27Tdg9/gYuKD01zVgebnYOmC61vtgO/wXvKB9Fr2f/jycdkHqF+WfzoCCtRC8I9BLAgVLsTSUMfDKxEn6uO2q5BEjVUqXrSSEeQWkeSsmTzJMZjHlQxbUnsJk6JMdjRrWkHZ0ZvO/ys8Xfr8GfJmvZxEpQSdOTSpUqP+kDp9shRn06lUoR6UipUJzwoRTEwYQLas2bNoz3ootCCt27dw45KVgQIHiwc2x1nw46tvJQ4VgEqrIMGvYUodBNNScbixpBs7pcFwTBlRjci0olXePKgEZnVrOYv+Q+LzvAOjRycwzQ91as6ri9JyPQgEgNu4c+verZsBgwW8gwsfTvw230GxqYikLQhBVyiQCCWfsryQ8+dOoiNnXZB5oOvYmWgXNP3pbOvhm4wPVD5KdULg0ydZD6g9lPeD4ss/Qv+P/aznwbefEv3p8J8T+DU34HyFHNhEgt8tiESBDnoljXeA6CehEBRy5/8Qhn9ouGGHsqkDog4iSkiicheit2ERK1LXooAvEhGjeSa6WCOHDXpo0YkpLnijezPmt+MQQ95XpIJH7pAkgDnSeOSTCC4ZYZNUPmhlhk062WOJp+m4Y5YWBmgkll+yaCaTU6Yp45pXtimdjwYA2SWZS0DIJZpzgtmamDXiqYSeId7pJo5hSjnmoUTCuaec2/nZHaAvCpoEoSga2qeaUZ4JqSAxyAVXYY4WyqdhdVI6YmOpKlrjAqza2aRmhgkg65EMNLbBrTvCetgJvAZ6GAUEBFvpYR/sYOyqhDBQ3LML/DZBCkIsqyKjWlgrJLZZaDugpVJ4ux+4UYgrH7lQmJvJHrpPqBseu064ix28Tcj7HL1M2NsVvkvoixW/Svg7FcBJCOwUwUgYnBTCRyhMFMNGOPwTxEVIrBPFRFhcE8ZDaAwTx9Wqeu2mXXi8EsjKirwtyVycGEABMMcs88w012zzzTjnjDOt5IFx4mt+VVjFz0D7IjQVRBeNy9FTkKp0YxqAQcHTjrkARgdUN5bsFy1kbdgCmIAxgNd92SDGAxFwQLYsDSgwAzYPiEDA3HTXbffdeOet99589303BCF0KfjghBdu+OGIgxMEADs=";
string __left_arrow_image_data = "data:image/gif;base64,R0lGODlhgACAAOZyAH5+fnt7e/b29vr6+nx8fPn5+fv7+/f394ODg3l5eXp6evj4+H19ffz8/Hh4eImJiYKCgvHx8bGxsbW1te7u7o6OjoyMjJOTk5ubm8TExM3NzeXl5dzc3N/f34eHh8nJyb6+vtnZ2fDw8Kqqquzs7Jqamubm5uLi4paWloCAgIuLi/Pz86WlpZKSkq6urrq6urOzs+Tk5N7e3szMzLCwsIiIiNbW1tPT0+Dg4Ly8vKKiotvb24SEhOrq6tfX19HR0ZeXl/T09M/Pz4+Pj52dnXd3d9LS0ujo6IGBgZ6enrS0tKurq+np6ZCQkO3t7a+vr+/v7/Ly8srKysbGxpGRkaSkpJycnKGhocDAwOHh4efn57m5uaOjo/39/Z+fn729vYaGhuvr66ioqIqKipSUlMLCwqenp8vLy9XV1bu7u5mZmdra2oWFhb+/v8PDw6CgoMjIyH9/f/X19QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAHIALAAAAACAAIAAAAf/gHKCg4SFhoeIiYqLhAU2PBAIkpOUlQgML4yam5ydnp9yAkQBAKWmp6gADk1MoK6vsLEDHwwAcbe4uboADFINscDBwoYLJC0Kusm6ARgCAsPQ0a4GIAq2ysoAEDsL0t7fiwUbDwTY2A4wA8/g7O1yCy4J5soKQ0cF7vneCzIQ1/O4eGX4pa+gMAEHdCADmCtAklAGI8ZqoIEXw4AAbOCTyPHTAhEl5F28lYDGgXUdU2oqkCHAyFsBLGwYoLLmogNMVJQbCSBAGYI2gxpqMMHlywBqIqAUytRAhxo7L5YKsZEpUwELlhR5GSfBiJNWrQ7wEecfwwAPYtAMK/QZBqNS/wOAMMCW6YAzUS8GQBHhQN2gByi0gCv1RtW/KhvksPYygZgFSxFzLGDCwkK9HnCslZxyAQ2RcXMA5TyZAw+zAAOQgeKXdMcFOkBfZPBjs+uIXTTEYdDYjLPbEhdQCPmSAJgOtoHrMzDFwUtVEwxEVt5OQBgVvEcSuOCkG/WCDWAQZkhgBt3v+gZk8ZAXoAIWENG7QzjCuXYEHM7Lb2cATQrU5gCQgBLq7FddFBhcdlYFPRxmoDcGfDAeQAR8kNyD0RxAwgXtzROAF/Fh6M0ALzB2EQH4XSiiMAPEMMaE5jggQQHTrQgMQhLIlloFJjhoYzAF4PDfURno9+MwB7wBI/82zIR4ZDAN3IBEdgwxAAFVTw6zQARW6DiPjDRmKYwBZ5AyUkwb+CgmKIE10aE5AWCh4pqfGJCGgu4BsUKNdHZCGTk8xeHDnH1uIsAA8TT2BFiFThPClGc+cAKhjS4iQBCxvaTAXJW6UsAPb2JDAAoi8NmpIgdEwCFPBNxg5KmbUGPmRQksgRCsnQygRQV4wikppbgWgpUSXpqjwBavBqsIPwgAKCoVSim7SQEsLJlMKUKoKa0hBhiRApUAOQBfa9smssAKRNh3Vg3IlbvIAHDMetYEo7lryAFQoGCtLgRUQAG59nL7xb65AECABskGLMgBPVgQajIJVLECwAoPUoD/BL2K6sEOCVcsQpfabdyxwt1+O1ICXExc8SEHVJFxNgEgvLIhQfqjnb8Ur4zVBFudSe/Mheg6xMvJBMAusO520Ya84Y4L9CACqPrwLgBk+7TFPxCcCwHQmmrvpVcUi82xIwdsQAgQgOvhr1eHgqi6DHl169UFnACoVAQYUba9dhKdzKiltq3hqiNture7BsxAgLPKoDWp4EFwIbYyCSzqtbsDrMGG2gEKinS5Azzhty4K6Hl5uQscgd1RcrYtxwBuJMB40TJpG3ABTgAxei5gnr6tAUKYPNuVtn8thxda49Kk79IWIENZRB6+LY6TF81j8Zi7mPwtvbdNoonkpSj4/4ZTL/MQ88pGuP0tFX4urQBRlLC78gxiX25/SMy+y4AFPk0f3BTCj/SkpR72aAo+6AtWeNYXh/IMUFnWWZ12uOOdpw2gOc9xQHQSCCvhEEc7x3Gfsiiym978xn8FyNRLaCPCYBXANPpbxmpyVjHPVG8XARBN2yhjmaNkpoW4Ugz44vYYDp4qMIPhCgAM4z3FcWUvfbmaM97ynAB8oV4rGwv0IqUWKWalZyf7ihE75RSoPAcAWLoaURiIlGg9jWE6qeJPdtiSJ8oEiKf6yAdPZpIxVooiFuFJRuz3PgFcYX7KO9/V+GEznjBgIG2Dxw1JZw9CKkscdxsJOvoHNGoMESwg2uDGIo2BSJg0w4+NmkUtntMLLFZMFKRIhSxLsYpW0O0RkbCELiWBCXcEAgA7";
string __right_arrow_image_data = "data:image/gif;base64,R0lGODlhgACAAOZyAH5+fnt7e/b29vr6+nx8fPn5+fv7+/f394ODg3l5eXp6evj4+H19ffz8/Hh4eImJiYKCgvHx8bGxsbW1te7u7o6OjoyMjJOTk5ubm8TExM3NzeXl5dzc3N/f34eHh8nJyb6+vtnZ2fDw8Kqqquzs7Jqamubm5uLi4paWloCAgIuLi/Pz86WlpZKSkq6urrq6urOzs+Tk5N7e3szMzLCwsIiIiNbW1tPT0+Dg4Ly8vKKiotvb24SEhOrq6tfX19HR0ZeXl/T09M/Pz4+Pj52dnXd3d9LS0ujo6IGBgZ6enrS0tKurq+np6ZCQkO3t7a+vr+/v7/Ly8srKysbGxpGRkaSkpJycnKGhocDAwOHh4efn57m5uaOjo/39/Z+fn729vYaGhuvr66ioqIqKipSUlMLCwqenp8vLy9XV1bu7u5mZmdra2oWFhb+/v8PDw6CgoMjIyH9/f/X19QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAHIALAAAAACAAIAAAAf/gHKCg4SFhoeHLwwIjI2OjwgQPDYFiJaXmJmam5ybTE0OAKKjpKUAAUQCnausra6dDVIMAHG1tre4AAwfA6++v8CcAgIYAbjHuAotJAvBzs/PCzsQtMjIAAogBtDc3awCAzAO1tYEDxuV3urriAVHQwrkyAkuzez3+A0Zs/K5EDL28AnspiqJsX63FOg4oGqgw2cFbIhCaGuWhgYPMwITcIBGAoq2EpQQEVCjyVUDNlg4CDJAhnQnY3JqUCZANYoEVDA5ILNnJgER1LCkGGACRp9I24WYCJJAjQ7bkkodxHHER5BxiixZ0HCq1AExHgztR8tHL69TDYCwiTUABjld/9H6PBABxdh+BM6clYu0wI2bRFtQ4MnXp4AFYq5SxJbjaOGeA3B4uEtOgQUTMB/HbJCDLcgENEpqNnkAChnK1gDw4JB5tMYBPxhgjZNAh2jXD4eZUYxQtoYuuE8O6ACGAFaRFG4HxyfAwIRQWB1Mibr84QInF4yDZKAiTNzqAg3M0N4ShmPwAlWxiNfUQ5a96PEZ4ICAPEIHIxjGTz9ASQLA8gCQAhrU7cdOAT1UgBoyCmAQxXcGejPAB/YhFMAHBUbojSpeLHgMAReQQJiG6gxAX4XkYPMCfCRyI0ABEozT0hgxsNgiRCYoeJwE+t3YjQEZeJhLCji05mMwqhTT1v8bIx4JUQgQyEYRA0jccJ6TG8EoI0UJWBGBcli6UoBKQtpyyhkZhunLAFiUaQsBTQymJpIrAMEeRQqkkeacrQzgQxwAkmMOZnz+wtETvPVDzwAQFtrJACeItR0SIezpKCdq3YlQbUE0eqkmAoiAAoqC/mDkp5sYcAMBgZZzQQRNoroJQ0skmmIA2sjKCqSS4lmBFjbqiokBW2iqqBJcCStMBFSQeg0CACnLSQFCMGUhC6dKewhPLGzZDwMpGGGptoUMV4ObcThAxApgkktIAxOgewocwbpLyAEUVODsMQGgAEWs9hZigAastvTFuAEfsEIVtpZjQQ8ABzyIATt4sG//MhJkKzHFFn9mhQgSb7sCFw0jA664IRsysGcIKVBFxBLjqy9IAEBQZMqFwItuVhMki7Mg5qKrwBDA/iwIt94GGEAbwBktB7XW4vWqp/YC1WxbpjotB7HGypPAFZ06zSu6DEBQqdMMWRWdC4w6bYARBeP0wAkauxvqqFjlibC7mWIFoohiRyovATPsre2hJc/DRRAw2+snoNuxsUa9VdfZdWVPUO54m1hxd0S77o65Es0JuKE5uS/GmDcQTtRNbgFQStlbCkIYLm2SOwfgBVxuB4kVLTK4rm0BOe6cAI9Uo65lWzSerq2J9dGswIpOF7Tz3427O+HF/GLoNII6gqRA/wkPGg2Of61egwSBbp8YXX7JHy7Hen6757y04nGPSwDmOX1ddp3rTvxu5xzogEQ691PWcIpznBIkx3wC2E3n4nARscVmNrUpwACVVZrT/G41wpMWZ1i2qdCITTI7swyhfnaYxPxOAY353l9mEwDBZE9bdLHLbAiXQGE14Ask7IdbhmE0sPRqMXEwi/kOoDasaMVnOINd1PDyFNsJCyhCoaFRnEaTIMojJxArIplo+JIlegSDIwHd8CSSPpMBoIIslINBZqOAKxDxZ/rgB83+oUZpuQMeGKyH+cKRNLycI4TCkgY1XpgrFhJjZ3FQBjOMFgs9LmYXPdTVJ0Jhik6KAg8VG5SWIiBBykZIghIRCgQAOw==";
string __refresh_image_data = "data:image/gif;base64,R0lGODlhgACAAPeIAG1tbW5ubvPz8/T09G9vb/Ly8vHx8XBwcPDw8HNzc+zs7HFxcbq6unR0dIKCgs3Nze7u7urq6nJycoCAgIGBgXV1dd3d3dfX1+/v74SEhJmZmXd3d+np6ePj44yMjJWVldXV1dDQ0ODg4Ovr635+fnl5edHR0aWlpdTU1OXl5ebm5t7e3qysrNjY2IqKisHBwXp6eri4uNvb276+vsnJye3t7eTk5LGxscTExOHh4ZCQkJycnJGRkaamppOTk6Kiont7e6ioqIODg4uLi6+vr3x8fN/f35+fn6CgoMXFxZ2dnc/Pz7W1tefn5+Li4n9/f87Ozq2trdzc3JKSkoWFhZubm9PT04eHh4mJiaenp4+Pj8fHx7S0tKurq5qamqOjo9ra2nh4eJ6ensLCwpaWlszMzLOzs9nZ2cPDw4iIiI6Ojqmpqb+/v42Njb29vcvLy9bW1nZ2dry8vH19fbKysujo6JeXl5iYmMDAwIaGhqqqqq6urre3t7m5udLS0sbGxrCwsJSUlMjIyMrKyru7u6GhoaSkpGxsbPX19QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAIgALAAAAACAAIAAAAj/ABEJHEiwoMGDCBMqXMiwocOHECNKnEixosWLGDNq3Mixo8ePIEOKHEmypMmTKFOqXOlQBQ1CRzQ4mElz5o4eci6w3AkxApQbdzIsOES0qNGjRA+Q+KBnSxOeUAUisOCmDdKrWLG6wCNCQFSVTA4AyEq2bNEAG2Z8LblFx1CzcOFu+ABmrccRM4TE3cuXRwivdi8aePGWr+G4VGQMCEwxBIWxhyPDPaBjBGOIK3ZI3ry3ARMMlxcaoNGA8yEAFYpMyMC6tYMiFQJwTiMiNEIEHzhT0LNEAQIDBQQIHy7AAAIIKNaUkHwAje2CF/QaBqAmBgoOFFOY6LLhcBUEzwds/ykcNw0gFRxpaCi9l4qT0ANi8D3goUNIBEjIm5XBeMAPAnEF0IN9JKlABGRmJUCDXQb0gGBZO6yQkgg7AGhWBUksBtUAUcQ1gRU7PQAEXAE8EBUdD2a1RgFQQeADXASUMREg72GEg35XlQCFXTMccKFOD1mhlw4sWrSCBGapUQdjIBRh1gYpNGSAIUYhoeFEGCRglhLPUZAgeAt5aVQAf1R0hFksGPBcBLmVJQZDLiB1ABwTjVEWAXwU+dwIPJjFwEIc4ChEDREpsFxWAPzwXEEFXFFWBdgpdMJVWlzZ0Itk6QHYogNB4EBZG4CJEAfdHQVAFw+FUBYPCnBqkBTsZf/1p0J2XvVGQwJ4QFYRhLpqUAgWYnWAEQohUOpRCxCo0AxkAVCbrwdlUZYXC3XgI1JXMEQFWTdAi1CuZAUAwkIaYOWFmgihQBYWonpbkAVaZkUBugiNgCRSAIxh6UAFjIgVAPxFNMBTgTHQ7LgKMYEVASYcZESwSO2wL0MpaJBADoFlSRYMeh5kKFYkREpQEFnBAMFDAvjxQbyKBnbGtVjtqJAJsl2VxqaIYAAzUlk4hAANQyAF5FoDWJXVBwsJkEdWJxA0CFmgLTQAGykW5QNjMpSlLEJG3HsVDgP9oCKgJ8BAFgEgBmYHWS0rJC1WFbQgkJhX0YnQBT/sjBUVDQf/9gZZEzDEgddIzWtDVmEcZEALWMAlQRS2TUCWhAslQZYLdMha0AAvkFBzWUOkMPFaW5ClBUMQzIForEclEMFATdzwRFxh4NHxZXXEexUArS5kgd5wTVDAAEYEoXtZB2hwsqtB/3tGQ3ccVogKbVSdlQTPQ/sAWXw01MHxcCXwuVkLmNG7t/5e5YFDCpuWlQ5DuzsFWb0upADh7hNVgXPuEpR5Vn1jCAjG5z4liKx/AvEDWbjgkAI0z31PuBUCC4IAiB0FCQ8RAY4MU4EeTBAhjcPK6R7yNslQwAYfRMiksFIEiKigApGJwxhul8KByCErC4gIDqyHKA2gsIYIKQNZ/87XEGPtpQTxA6JB1JUVuUFEBATEyg2IqESDWIAsSZCIF8qihiRW0SArIMusIGID/BUlDDH4IkMiIMaJyAcprFLjGtsoEQXEYAr3ooCJ5DhHzVUEAUvgQv34qBA2+pGQJDEkVsaISJF0gI6NFEkYDxlJkICBLE6sJEisQBYLaDIkgiDLJ0PSIawAISMCKIBxMEDDRpZLKxTJwQtYoAQPUOEJMGgAAFgwSkTAECtkoMgKr4K0Tz4yK6iaCA6yUoJRvoAs/JMIE7EihU+eKSvPkogKyNI0TS7NlBZRHVaEV0kIRLEo3aQIF3D4ukjugSwhsEgTLGgUJkQSA2b71w8pgv8AcV6lAVEjpBToWZQStBIigSCLzAj5BbK8ACMgIIsGENmBcxJlAziriHSuEgAvKpEIZOGBRm5AFmrJ0QAkwKJGRHA2KgKRBYDjSBXWNboJIiAMZOkDR2RAUKIAYAlf7MHZorQRAWRgV/RKYQvKQgSP2KCnRNmDEh94lThYxiNry0oCEPZBM5QFch/53cYG6S4ngO8oJBAJSMlyNQQqgHVXeWhIImDGozDQXQWIHlnIcNCNwAF4RiEA2LwF03DVaCRZvR7GfOWGsgCAkSLBwKfIsgCuPgcHUCVKW01iBcAapQFAfQ4bzDIBgp1kBjwsSgOgUFOoNLYsAUCBSgZABrP/BECngRGAGFJLlBKxpADz21K7eMKBPpklChlFyQioKi+PomQAKJCcWY4QlRScdZFJRYkBusDbokz0K3VIKVyEEM+UOCYuHljeV5wQJxJpoC4lkUEVLIqUNzFGAVfobpUskFyNDCAH14wLBkNjAB3wJQBPKC9HcuCCzB4lADNo7VfeyJcJiEFGF5FBEDJA36ts4AESXosJ0seXOCjhBSBQQX8NogAp0IAF0jWMC4jlLR3otyxX6IEZHsDjHieBBVOAq2EC8IUVP6cAf9hg/tznAPhOMAJfcPCSO3MD9aZwBVfo8JTLsoAPXLWKAsjBUbdsmCmIjpACWMIOtEzmQwQhV5ORtMAXxNvms+SBCFYepQW0IJYtByABQchzLwcyghbEQFecaYAP2GCBgA5aITUwgRyCUAUPkOBQSIHBEzxQBSLgQQrZfbSoR03qUpv61KhOtapXfZKAAAA7";

string __bad_moon_small_image_data = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAbCAYAAACN1PRVAAACyUlEQVR4AZ2WzUsbXRSHVUQhgi0iSgmYtFS7aJG2WdQgiCGlqyKKC1+yaHFRhQpFsCAKIqgLRZOFLgItqYK4SCRI03FTtFCC1Fr84P0PJItQQjbNR5vU5NdzBicMYT4u88CDMPfMfSA4M7dGEAf5gvSTETJ2/TdAviSdAGrMNMNLfiRR7draGmZmZuD1elFfX8/XJPKZldhNMkxCy+npaahJJpNYWVlBW1sbr0fJVtHYA/KnXqixsRHFYhF6jI+P81yafGgWu08WSOg5Pz8PM0KhEM9ekY/0Yjbyl1GotrYWmUwG1ZTLZQwPD6OhoQHZbBbM5uYm3/ObvKEVk0gYOTAwgGqOjo7Q3t4ur3s8HuRyOSiMjY3x9cPqmJuEmTs7O1AzOztbWdva2oIWLS0tvO5Rx76KxPi/jrm4uIDT6ZSv9ff3w4hgMMhzJ0rMLhLq7OyEwsbGhnxtfX0dTCKRQD6fhxalUgk2m43n73DslUhsaGgIapR//8nJSXm9o6MDqVQKWgwODvLMG44FRWK8qRZ1dXWVmdPTU2jBDzytv+fYJ5HY4uIitIhGo+ju7sbExIT8k2kRDochv/aIQ5HY6uoqrCJJEu/xmWP7IrHl5WVYZXd3F/IvSLwTifEzZRW/3897hDj2WiQ2OjoKq4yMjPAeUxxzisR6e3thlebmZt7jHilzYhZramrC8fExzs/PcXZ2VvHy8hJGbG9v8/3/q19XT0lYNZ1OQw+73c4zz9UxJm62qdvtlh/QpaUl2YWFBX736X5M+dhA9/3Q+sS0kldGsZ6eHogSi8WU+25pxZgnJIw8ODiAGXt7e8p8n9kZpI/8oxdzuVwwYm5ujuf+kh7R09Vt8oteMB6PQ02hUJA/Ow6HA9ffxrtWzo3/kd+qY11dXYhEIggEAvD5fMqx4DvpMz83muMi35IfyH3ykJTIEDlFPhY5Ef8DCuHZP51PEtAAAAAASUVORK5CYII=";

string __matrix_glyphs = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACvCAIAAAD1+0KvAAA++ElEQVR4AcRbi3dO55r/Pa8JQgSRtkRL6hI+xCDSOi7pEXXXOFRLi6Ip6kJQF22IICEuVZc0otJjnHbWzFFdRw+nnc4cR3UZPZQxf9J0/9Z693523v3u70vHmvmtZ2V92fvd7+Xdz/15N34lBgLvCzYI1gv6IETwuxQYD0wVuOiG4JFvDJ5FF1ACHOJYNRwrRwwD1gp2Co4KcsFrgiOkN/zthwsmCioErwqWCbYLzgi+MuiGBOQjWGYx9yoDzBCsFDQLrhn8A54yBNgrOCg4LBiKJLwi2G2wUbBW0QZuUKNBg3GWCnxuAuowyEOEV0Vdd3ii3oB3cdzgOXjRHfjYBAy0QDBJsMT2eYZbmSP+kU+REthipmCToC8iLLXt3xH4sJZtXCpDAiaycSJlPEMkrm6KYLWl8D2sECwXVAnGCgYjWEiL7XwEO88jh0XYKPhv46W/qBfMn5hk2/9soDEK0VOliKFacF/1+YMJRCERLyB5Gn83uG5wxeD3/DEKEcqAcwZTRPGT6mQ0Ynhd8ITXfzT4iFK7SnDaNm6SgPkGw85fYbVnl3YKXJTBs58c1MV8wW2Ddx0ttc0O+lht9XX/y/qJG/WEEhJhmY/dSK2q67kSCOJ22/6iwUgJaJRgCif3mX1qrLOMoRTNsNtLJnjrLobwbX2ejQYqnjtkL2416A/MEvxOcNlefE0CpukH9ABGqRk2G6sekmirOO9MsFuwmertbcFCwTQJJKZnoopWSq6VY+0yASdVczIxUAQv2HH3G2gsUFsdojmH/akRWNBaNAn5mvTLj4MS7Ms8vrYRiLAhVdZLgK/t7yUCF88B/xx/pFnQCxqBQBynddgluMk2lDbcMPjW4J6lAUoiw95WC+75pse7N+zvuyYQ07X+5Zx15r9Z8MjgzyZgnVOCBsEewft0RGoFLsqBxYKFpNk0Ny9QebpotNP4L4OMR23cNzGTuk7wJd/UV2TlH+2071Dj3jR4y51SRtCipHYgEvBmqqwXIxLuRYIEcIXvxjs5ZGLveGfSEKcMtnFV7whW82+ZFd8TSubqUqf3kmC44DR/TxKATtA0CV7DQdvmtMEeUo1AY6xSCS6dM0Dc2axLbEnmaDHBPMfZ/gcopbLO2bR5dkWfmCSHgNeP0kHhv8Fy0tALgey2GQzy+7SzKGGhxu8gXTZoExQBDfbWvtSRlgj+rsSlTjX+A69kpXl8pEqJ4ASJGPkkJSxUSF9yqpV8pAiBwA0D1ggOCY7y7+/tg3sFiagU/M03GUqMRkf2+UeBxmY1T9cHfs/evWUiX+xDCWTd56lskdwcdaEqOJTk8f5GIn9Yox+w0t5aLUjHQiVtmwUaxaHtIZ2gBF8kJ4UXy/lIrZ6JEoWRgv6IGg+hrHPZyCP76640HTOYLNDQszpim/0y0FzBcKCC6neeKB9CjdtmsEOwVQID3MynQsPc2zGoe0zMhL/EPpfbBTbau2/YK1oFntJX6CQZpMIAZy1T/JthRKGwwLLVbRPpmSM0UVfsU/WSFgjtDk0+6U3pNDr7sdQiaGKQt4NR0/P0cnuRBe/YNrvZw2P7LzUw/mT/3aL63y/ZxIt6Lx8JKADalKey3t1HuzmkuBdJDhtBlzbcnBLlbL9tLxbRU7nGrk8J75K/wVU/jKIb/uCeNziLWivIgjLgkuWIZZIUZZITCxCgB2jblJC96ZeDA3F2WykwfuF26WMKKAcNhKND2dQ226ZCsz/NnoBvSEl5PQ3tSEaT251R6gTuCmqFjytaL539pklq8lMF6ahUjeldoxDcSdJzDHC1RiyFiiOU7/2pUgPWNtvAuhcpEZ9bdvjKQGOo4rvQL1geZ6L3BC6mCe6qNg+4xa5p2CP4STX7mS21xN8xUXAyjMqDTgO+iY8+Qc3zN8INVZMcRIfjKh3+j+z1rzkcfwcWSuN5T2h7ld5liCJEPdxldJ6CLXbcR8xwUcqjLbqmRnldOofXMwRL7eN6maFWy4ThXTvZuZYKcIFgPmOkLYIOFTJ2QosKZydaeWpVrD1doCHUXdoRPUGeTURPYJVgG81bsTJLmxS/Dxe42GobHKbPvFIJ3A4uYURcvEJ+b1TqJBylRlCIyN8ss9fbeatZO/kqsaM1BwkfGrwqGJokSEuSvJm3JMH37m9f/3kltQsEe3VLBv2tnVJsM3OwSfsFcSjeoWwd4Js4qi6+LLEkXLMehdmofvBiBKK48Fs2vmTwRShbpGFIwBpnLQ1xN7snkgPlz0w0onbUq/n43wz+iRFwKOUgF55WnT9UPN0duOjZyduOdR9KvmwRhBikDC0pdved1Pel1V4fm+3MkhPZRn3oemFbRLltBr10V45ftljd2sJMdQomZJ2SIBH9uLO6ZYn1JDqslqt2Oj/MW51tsIFhHOGOvl2iTVgrkUXvjhhP/07sZBQtFuSCKqrPULgL47pwmbpLDwNLQl3luk1DyPi76Km2Ci5RXNoYINYKMvAiD6gnN50WdLOJqjrBfpo0DZ1WbWHjdEwCzgq+s/Kk6XsTqNAe8OJlwR8N/pNO5seCXlQe5wWj445uKI5XaSmGK4f8Fh1aY7WlVhuU5tieGASj3KQKdTGAftkfAhPLxzlWjhgn2ChYIShAAsYKjlmHZrUAXMI+QQdV91KB4CmhTBTnZmfMrhXL8uh1v0hPqpQeZtfhHbE3jaIe6wW+Etfp68/tGykoZTM36ivOYSElfCtPHX3ZeddQAFxgonU5XYP/d7zCwLFFAlnJEQupgT6lQvL5caxIYqoEUd8Yvt2BpGHOlhWwMckyGf21hZbyPZmiVs6hnX5oV9EPWCSooRCP9z++hrNaLBiT+xDPq2CrU9eFVMKsHGM1OaCG21QtgYNeyZhyGHX1APxKdKNMaExTYXcP5ITZEvmf3Tz7kmLjC9F51W51Wdvy3irKr2RdISMokyiRMINVyCIKXAHZK4+UgmI16AJBiP7kRWP3KvSZFwpyxXzlpxU7pX5ez04PdBWZzHhOcIvW8Z7BTb6tep6gGIfYaxuMwPR+Z3CF1v0gjY325zcJ6sm2iThj8ImgTT2ywbKjzuE88c48uGXiRfgBatWhVl+khnC2LieqFqSg0Ek26CHuMbg4o4ar4Lu33KytD43caEGeUzI65T3LkZ3OmGik/emNGaU0Wz9laG5D7BAkosnT/ojpnG9qizui2xgWH2WmLEQD88lno5ZBm110pPcpCV7IdHSl6DgiO2U1yZeTpHOeZNtMCs8a9QgZgfWWTyV4u/9qmeKEJESo5wXXyeadoq4vKZcP7JU/2206LblKPLkP45FDe06VwDkGqR10/k/568F/cpg1A/y7klot4ulnJ3x0UTCD4colS+Eu/YUb8j3Luo9DmROkIyy4rVct1wt7yEZbRTl45GWHUnXIAEZj7arxcon8l0H0rkGfpSPkLG7iNLL5bB6KqDc6M2ydXjqcoygQr9DA10gUc3cwlJxFI6dzapouk+WbVJpplVAI6F5MZ89jBC+SX7XEr3MCMN7NlTYJ4ohW10LdsE34UrlFA/k3HZ84xzP0Fm1TNatGqsyLJhL6ueEjk4VRWhLdYbws8GI08FfV3s27LlPi+64kV6CrGYLvEccI8QVk6LL1UcmdmQKN7/Sc1fGlHbrklXquSlHQ2zFmBdYLBnOB5cB0pVSqBHPIdvskdsyqmccQNAySRa0uKf2+gt3GEdWLdkiCC3bflW+iN+/md+KIoTwTuVVsXULR+wKTmlbsUPbJ8dfU6UPpwpnIBgqrPjLR6klj/ZYO/BTBVO7R63w3nao6A50jTtlJZUPzoVbB6VVJrH9kO1h5wGC/0mSFegNtPtk95HTcPvK2c2ud6rzB4Lg99vWaZItfuvMQ70meGdBeXAquGlUSceJR5c3mGPV6XFyVLh4CL57lKa3pgmIldm9JNJ9LZJ0bKrvkI32s5aFzMnK2OomRiANq7UskVsgqh4VSge3O/tz0FNcnp27RwxxDplJ1uvGkQQp2uhGhRV9lh9pZtc2Kj/RZBcprnfDglaJa8ab3OqwP30MdltglcJFHKW+MJ4onMKZ/g7WsnnqNzpnFSokkEvCXthy6GN+l91Q//T0SrB1AfYrU+iV2k1WJ7xmVWPDvtWI640nWzAmztfTDJaUT0mXuY6l/3NANPiOdKxB/ZCr4EJ3VRAhwyz6+WOzQdPIL/aXJWz5PmxB70PokM9hfM7iYyNJqKDGJOCzJ6mepY2KikySCbor/7nuqeflAjVDwBBm7kwXxQtNKUTbgND3AxXRxx/OQczn9iAvu0WiiQrBGsF14zlnRRoGLHkC9J1w7awLJ6ISjqt45W1BCr6GAWzyFUVxZPBO+gU51Oc9mTBacVZVdXZWqkpjsPkvPw9CvblGikFjaamCMUMXNGUmil+DNFrhlulO0o3O5nE4w8XPO9ZzqFG5veHGO40Y10dyWCXor2zo9HpoT+mCin1rEX3ZV4jvEn9a/4BnF/RZofbb5ZJBT5mgzU8Q/q4NLIYYg+ZF7qk3uyalz/gPCN+O+fQfdWPfTrKnI4naMhPcLEqoQfs3gObWZPfnS6NiGyfYRzXelSIMAGdqbc3Fr1DNpX2pTp6QrzTPFm0ejM4k6dQyDO6tONjmWbJbARVXqZNoMhsOLQUCzo+TEI+6tniGWSJfr5Rt04PMSM1n/IvghzgV36dfVJBX4ygGyJL4xaBRUogsQYDTj4w/4GYgPk1hn/dFRElcol9qAtQlukosf8e8NE/RcpE6e3KCTotlioiOU1w2mIxmVPNr4heCvKgn1mMmpI6yspCOfZdpHNlvXP9X/3y+4raz1VbGWxZHgI3QInjhZ9GtU3Wm7n0/Ky3aotpB//w9QwBx6EUeUX1WbkiTHahgwBhgHvNj1MrOgyyhkTWxmbk/2AvqkvwJld58BhpBKgHxPizSemk+/ppbG/OmiiAWZVZLre6oU/zEu6uoa0oj4p1Bz+CHaOob/TxcV/Iyj0f8J8igEQ+8VVKiEUl90AT34CjLAy9lOVUziZM7/Qsb5FIX2CS0MOvcYfEDazfJLueiPA/63qBT8ltHFRh5J7LD+eZ4nDXSEnudkQZ4yhO30SI+RNM/tSfo4Rxe2M06kMZMuTxPTQIdpt6ZwrBxRoaaUiA91JtkyXAdTTmvj4ZAgux9ekuSsFKgTPDYPH19CJrV0Mw7RBzlzUuyl4AyrbytSk5rfekZxXRtdg3pAd+k/Eh6kNbGFz7AArPPyAtxN+HgiGPEHz2S+Z3E+cY21rCtX2DVWq0zWYL48bnfCV9df8ETHM9TSocnX5b+f6DpcsTWoz9jgA8FAJBePM8AhCSrrbfTJ240qmZN7FnGqvRm/B8LapFMhikbSFeJvzBdf3lg/61G5nrLPCX5R/z/tnfl7ldXV/tlPIMRAAkFClEEGRBCQQURQrHXAAeNLwVoVxLaiYFsHNBAGEdCUAYSCMhhIUmul1sG++FXq8NbWalWUIuRf+ub95Nqn92Y9e58nGK+XH1jXunrVkyeH55w8a69h3fdal7mc4LNN+LJXhSDCDslZx9M03Zb54ByWykJGLCwHXtLkeF2qlVeneIIYgeHoPeTObi1Pd5SZVAV3UQfP1n6lpRxdeSXXm5BYqleeNujJdmOhOYVA6NgHIaBr4PQbW+rJUEyvRQfgoTe4OC+dUOVrtQDB4Ft5WaM+U9DRCK5dLtviuqNl32nmYR9HfMQ5GT+BOFFW+wsO+D7dZ9IrUzbGeqEjn+J7SOPGoR2o8nAT7xAJW9XPnmxwSf35iP/pZv7zKXc2ynpb9BsgLbzS/P0Pk54e9gMf7nQly7DxrT7F+g7R5GGEEPQORnKGRXpL8l3M9HasPNorpP1l9TYKy4romG26WyXTv9XJJ5Ke1ZPia5/NFOrsleO02Vfa18pJU6r0/TaTyhRHTuk8rwWvOZv6623ozUQDo3i3Eluze1BEjW/e7wazcS3VulkEN9pfWu66TiyC6vlJC5jlSnWcsKSOKbwmV+7JfP8V/TQcsXBZ8DeWR75AGUuxV+tKbk/qKo5z6E/++g0c0XfzTY0S+/uE+28WDpJyeUvVuh/LTIwa7fb4nt0g3uRMpO+kNbKfULL2RQUNd2xxMDX5pXRgdMsykuNbzQcZWGp5aZ1yKGM37hc7WEcU3URfuutLnOxKjZ2gf7xKmQG0bjJ5eLEY8kt4rt3XNBI6TgtLrMNAQDaB16lVXoJthfIZDkvnJzdkhTmv3VYtp1MjE0iXztd5mYZKJjjFiVzTpgNsvEzSkhw+NZMP202BdDx82w39ydt3Ppq6nirQJs9wmSsESZWJ/vWtmelf8UcMRRoXi2g5DDVFn2PZf6LzfVrwErR+Ax5OurACa6J5MEV89hfwl/zF5K/ewr7iLm2lV33SK/q6UIF/S/thvk94bugjKE/p8LyR+Q/YJ0SkyFvdEnKO5wDH7PqwTsp5Jd0N3GeRMbif2aqZhAi2hHLU//RJJ5VwOFoqN7j/hP3LaBSN5PiRir2Y402G8d6Bn5vKc6oM86qwM3pE80tlFQMzyHjQdETGPvHTEylfeJOFq4kR78cKSwS9/SGw+RHDeK+md9aaB6PE4wYWvFjyxfoS90RAVRV4ZU2dWzV698Y0xSluGaV4UDK4Vzylv9UkDj9ycjgZmSQnSqPTf1QKUHnN5nbild1nxRAzZfCM1U1O+IDERMe08plLpeLr/s4/QVtkxARcWJSkq/vZ+rO0QhGcN6PnLPU9E/PqyHCZQoe1ulOQD3/n+ln6iXyrY5W49tfl0w3lwPw8Mgpjhpqmd/9T0pBQaJhLNTEBP1MfGbD1MFeWcofub+A30oC3eiTAXZOMB08BDOInhOXeJjjkTMNmMrOYjHXcjVjDvS5o7AwBfbGZoSe5naWakrvFDpbiOJ6Wu/2pywcJU/L1YCXaSuqrnMIhMLJbnaTyomszMW5/hz+XQUR364wRTK2BZraeGY8p8NR/llckyC+VB17iyHkhtHisWdyqdM/0I1wvU4Ie9V38DnAvHPFK4qNn+aHMqimVn1pcdwjHf5IYlJXxIcE+L2MT2INBEm10cVgWUTSlVmxU+jz/wruX/PQbinjyTteSFv9u3n8GF+8PadB7pduzXH40mR55lxxUxjCO+d8+sf7G/BMj+CfsCaRRwnfi4zmc+aRSUfiGBOwDyZ6fAvoyo1SS3UZHc2teQWeavL7YcT1GubgYOzGjztWEfVRx+FhDWeFtYjM2qlIVgTW1Q5jX0HEq6YS9rOtvuVpSQ+lnSwxM9DeEw6Ar4j1AxaMUis/m5l8097AnC0oIY6V6LOmvQKbB1uwu2bGUHm300AGIjO6IfytBRjzCVzqNBM/+4hRHRhOU3X10voEH4SRGcJiYqHtMx9c8gAtdqYLfY+FRxd/I8XCCiBckepyFTKb+quf2f4kNBXw4oWF1HeN/JNo8zmWzuWw7MK5vDSq9lm/qDUy/yaX6OfPoYq1z8DYoHm2lSiw+2E9e4vobGenYDL/5JPn3Go/fq+SnC/h17RmM5cm4HUzPvNAldz1bf8YBl7q8Q30n8Z5w4MkXGN55IXUQI4iNi0tvt5/l+608V9pxrVe+8f8DqQDQPkmJy8VlGI/tc7Q8083USh7ATRTxyzxDgLMOoYn2lHI33iNx/JUrgvPlndGhnsc2Jf5kaEV9OefeC/GW8yBOmke4RmfaFgUL4ERaUPxLSq5jfM6NFMKuIuG+PDa4m0ilWxuKzLXbTOzXQoRcJXOybG15AP51IUUopTbNKXf3hxTmmBYpXN8txee5nGM6ZceOmKuRaTf7BaOUK2PlF2MzHKc4M6TOD93cbcJDR8J9F/9oJfUfB4W8CJH3RgnpNcPWTvmd8CrGE9aUrhnCodJ1b3V8Fd2l7Pj8N9zwfwshxz71sR5LVJRKJE7dShXluhdlWlaLt601Lgfs358m4H3yESp5/V2hSeZCMtaAcdec+2mQYi95cpv+E6WbacaPXi5J/ENhE7pUPzhMDkMU7WuFnhv9AX1u4/LFrYoelPdfW4ytuUXvf7KLdkYTM0xbwhyxiUDmRho42iZ60P1vereKdsdDgh2c66LzTndG8IsLICAFo27wDi/nlbEeljLQ7EgPP9EVnh7ONXrCGJbqeDv6Ct3EiITUHAEi0EcpEqwm835IqgW/gO3e5CR6kguSGo4y3Od8gYaH8UlTK1E2sf5LHXzR1xGa9xMQsqLLFGyguiBCNsTEo/qm/z9/zjivyhGZSlm7dcbXxk1Bk/LpQraI6fRSiVju5z0Qvhi6IFZFG3xNW0mRc+Wu6iP0nIf5w28ChCUD9yBJ0/neJc+E9ESF4ztDYA/qAtOyKazRINEZzrNdfLYGN7pATFAraDoaTkdPP0sBdlOmxaMUo2kIjuCXPNDbSyVf/t1pktjsliyzQ2gTW8Ki1Qg/nTw2cHtpaaIWn93J8eDPS4JzCVMa84K+Gq5ninxAGVnBZ+Ew+N/XM3F4xqpMIckGsZMh4L5MyNrC0MDLxFjXu2CS22wyvEUwaL+L+3U9S54Hj62JZqOeK9hEl5RKr3/Kgqh+lqXBC6SmSuZsXMOdr/hP04zIkVvVkngnTYJ2GV/rbzW8Ad7zWwNOHif9um59SgaCK3X4dTMd7K/K0tbrk1qr8bA2fJRi3JHDMBc/YcooB6SIHZP2JF14dQjk0HEWQ7FXLT/1kdD0EF5zkJ9zo+HlYnbKHPEd1gaKR89TtjVkAqUgiMMDGqaDsl+S3KHdeOJ6X0Eqfcs/k5J7afJeg/8+8e5JFS9Zw+SQndxAR/z6AZqwn4nwgD80Fiw7EuJK+J0rg+Xp+z1YzGYXRFs7nXexHDInpaH0BnsU3lAekUAbVT/kj+cv85NylLbrO6mfRD8CYFimb2opu1Ib3ug/KafrCIPBnMa7SQFGm9B3retSf6LQF3k7+U1qpdqceQK75Ih+GNzPEFtE2i4UI5Vm9cHWp9LSn060soRQVn2SrfvcARsxzaWZ57R+y3uKlXRwZUhZlpGZ8otNCmWKgDvvwWlt525bw0nRi3319EHpzvbzfcyzDGtBCNy8WsIIZ9hE7QJgnRGOrOWnODvKxn7sNueWIW9W0MXPHSGyxe7bWB0mgn0lY5mEasbWIZPgXZi8Lmez12uuT4dMM3F8KVFbERvlTUi+cxX20SaLMGHu06sQmf5NX2gF1pM/m0BOhfvDQEGDW10jpJiNGjyaxvmPOIiT3jErSvJjnRQmyO3S+VENd94kF4ID4ePM8/f2lu94Njo4zXH9FB+sdbjAG+3E6V6JsVv239LQyKZSyBxCPWgeme6kgIkrOF7TuJ0k7dWmrBTchvAlGWF+Jb+yz6fdMZnYR/s8EQvmDOieDlYTNqMGhsXe7XoyYbK2c6VwsAXibuuDOMtfSV+5zndUjxAl7BWsywzM44AUADx2M5WV3EgYG01SbolMX9pmLGCUzG+yageqvihLgXbJA/sakeS/dE+RnOcLqWS1ixP6rvAs3l8Jsb8y/lOrOtte8wWbB3eYWPdNn5ncri1kjOk92kEn7Iw7LPtKw0LuxK9vcRbmLVtaOK5+J9e8RQs5NUZvmjw1KJFehJZzJGKXHWYOCzArBnIKxkM0WZrmruwY5LQ0C6Ijt330XJzTMDm/jSEtYZKFKr6EfYIrHSKuitQ5paPi4zN1vSNDBFAyzwr//nspsI8nUG+N7HGqivRMqE95H9Ya/zZHcVa8Kd7uFL3YA/orcjzMETry+2bGHXigqCzx2XOTuPZ4Hdv7e5LpXKmmOnhMqksngG9OT77t3Rwqn4K9Kp004/BNzvS/N9P5PmNiiLeSlI4n+KTHvV0NoF/yDNXyypBKOV7oy0cFp32SwvWV5Zuv3OWwH4wyO5xoczY+tarA9eMpiBaXodT8Jrry/Mw6EhvX251pJVLXoQX5zfDYeiyV/oP0ftd8i29z5j+Y8tCNKvilFMMCJK4ZBg7kKbC0Ews8mtupif43AVRxuQ7bWuuiY1GHYN+DIyiDsnI54UIT/0SuTIK6MoEHgtWbpWM4HDVbgz0NTWnqb9MqbLgIRZ/kleJRERb5z/nDHEzqKzps08iP7LAZQz5+gkHbC2gtr5ORcRMYXTPTtAujZXOgzlacjA/r8Iyvbm0r1gufJNG4lWpZr2T1JhdJ9Yrs5qvDPq7xeqoUBmf+RZ6s0d4c3wy7xelj3243Lb4dVM+rf0qJOLcP1vP3V5EyNXGyFRLZqNrmTQNFlUeZ0RdM3cVzW9lSrBUmhLu46lafAZqkxlVbyA3hs7aX7DMmNxWeJZmwYIagpihAja5n798XFu8KTuNH+BvUalztGQxac72C1FYpINtJ5RkIKzV/ZFiYv2wj49ch291H2qIQLaQY7A6aaVupYRzC0gILPkMz8mSwYIxXiI1Py/DnCYUnvjeGoxQ+UEgwJdkBkZk0n8uxMZzn4yr6d91DyBpwKKOoPUWFn3bGp9xewjG+kJLF48TG26WP2+YYRS9MC5AhqKCv/2Bs6A53diB5LJjbFfPBQsyUVLhVXtR1bur79stPZUJicinJwTxIQF8Jbdok2VodarM8U3PN3aw2o6xulrJo7kTzlVSaXpQubHF5VjyrykzYtIP9v0UMgWuUvnImrpSea1Kxub1CbNROXXM4/iCLhB1yGOTntew7NQEpvkBwLAUi8K8E1JMrpe7H23k3ay1Y7+Z9Syng0R4ZPnDqtt8VpsI6Vy4Cp2/zL+pfxyPFtT95EznK/ybX8gu+gut/gcXbT1Gbl6fdSwy8Xqd9USSpiccEH2ZYggtvzAcu/c0OjGN8P1/qsL74NJW4BZu7ibu35OLNuP/uYKLyiNK3I277JTR9S/XkCYl4otHpVCFRYSKtt78iAKs9Mr0mA5ojXjO0LXLCwylz55Pmlak7fNN6dlgrvCvsIz1d7kTRsVc9tuB5LmAWqVRTOkcFtSPyjnDlsCTpv3J8qds+RkNmJJmYtyFjslByvyRs0cE2qnrYjKaW257J/GepjT8te8k/Zrvic7l0ZGXoem329z+tAEzsW1muBrSW+5EtqRAn8/cBL3NBaexNaJIfmtPocyjX52LByjHULaNF5HndmQJ+rMmPO26IVGd0mWeHqeJuDFFgC2WZ5xKFlZn37y+9XkWJLADmsdNjWu+VN3R5ZidKEMTdar98gl8UvlRb5rSGMt+dq5QPIq4tf+/hM8LtH+wJYD8lvF8r/OB13Tc8l58tLGnpEeYifV3rGLeGrY8mF9lAHLfgQ+FO9DQW/JqQJtuQh+E6wjv82ikXksZRfJ/xw8LG/3spJgB7dalUMxRF1VeqRXNMQrHWBRlqp6n4V3eze4kq6j3m/jTWv9kJi9AENDom5VWhI1f7Vel6Vm2hoD1BVtUWVZVl7uyQeCHFyKwnFlxc1EHux+dd5M9JdVTrJPzuPgNeloZPCVwxn1udS17bxC9eK+8zIcxndus/zftsx9aVXfg4qOmLTRbQzJCv7kJ0A6b2M+anTHNnY9AOSjRQEp2C8nveCgrMfxrkv5aBAgdkV87I4jB50bMP6ufzfneHK27BRQXfKbEo+gfAVlWy+0h1swsH86Bjw37wGaiCx4Etai98qpk2ezLPYV8dLhMv9aoHGdyW6hkFFMjtKUXfWvA1gDidH3N3Om9wwO9zzypWSDOiMq5ruGBTll94OqRQEILAhLxQ2IKtjJHQeq9kJlfmhawzXalkr71khVkZldEi9p/eYEBkU+R9Lo7fqqpAyey8IlQ4A1Vy52PCo3FevB9/mOpQb0o9xwCzc8oHXO8rZrHnMhjaz2nDipgMWLzbzv4WjqWsoDT2OkCtCZ7l9y6lqE6zGPhZl5oGO5Lgo5ETfrgiN/Li1YH4+KNC7P+OWHdDXnngXoBdB0OC7zCxYEsSGEPL+Z9h8euPjDbrZVH6V1mp8YRaPaZ6KsPinj7LvzcjMty3Dh1wTsTiWq99y5VfzuFrz7grNNUbHUSUOgKL74FcTmSLym/2ttSSxSpWQZfNrEBLh+2d/hWy/l6WieC9N4LTTks1kelmrFM7telhzk+RiUxLPwrIWDglWyAij0kiTFY4NLlduFBXp3+ExroGyO7DlOx/Th61FID0UjiAaRkOxrbVJ2PRNrMU3la6/M1no4gkFsSUB+Ke9GMq04Zi86u10btVQt8i+eFCIQz2K8BG13g+bt+2+xu/4wF596TBs+0HnCk3DSohm8Naz7/zwK0nzTzLFqedWrtcLak+DhpIHfRio3fKm9CVCw6zDyn5vuMZfJ/m94jkcWGuyDrGuc2BvqWDc6xoZDpcXO880+9xtuwfsZBMiUbdg2SeJZ9jUWcwulRFByUmdKmhXilj+CcuYP3+QrYJPeZD93ap3K5GfyfVaTpXnBMFtsYoGXdesea3ds/SEMlWaAQFd57t9CvTLhMg2FQykVavh8Musn+RpiffJL1hrYTzilF6aFL6Segpwr/3woVFb4WL/H5FnWw9bqxFyan8Ab4Kk7OLSF6/palez2kxQhPlAqrG3Rg2fDqM/p4pH3XmZEqojuR5Kf0rWHZ1ZOdgQk97zLa2zhLa4uyAzPRd+QICX0EhbYisE9DlVvYwb5dlggo4Go7v3Ke7BQvDRbT+rHei3S0rasFpbZfmrr7/3RjfWCxJQcvNYVVyKuWqB2E17o2fE3H+tFGx4AIX6yxPHc5GBfxhNuO+nvfYVoegxmNxJ6rBsL65lpdDthKEWmK3Oxj1XCoG7aD21qXtArO6g0Ek44wPHl5gi9FQv6Tnr1J9I9sJauzf+MbOAKH26vq0MVpcw0mP8oMDtBuoQ+VXwTp8h0Nxvzt7AsIuR0Ag5eVX/SvcMzE8/y6cMfn2/Dja0RREL+WC0YpfOSwr9kaYJ72Wq0swIrXCDnleKiNL7faLWVzldIyzV3zq5PD9d5iJ78udRUv12IJV1gin0na7mylAWjqWpvvjwubbRTIu4RW84ErnWRTEEGoetYbQQLwW/HOH4lF3bZ4pPxnQSiJP2QlGIamvikhIuddpovE3/0agPC+7bq+Zn8YdFXRj8Sh6eI/+wFKUbpDyxX7fy1Mb+LcQdkeES+A+Fw5jQ9xHdmJkh0i17wM2JOVorUILzjVO1VGev5amD4LMihNjCPNcaMFWlCar2qzppqRhzYo5otBYQf1lcZyxslJQwRf5+GgVuriXLHim0xUnZSD194UbF2q0KqmnWjG6vhal/0u3Sng/clhShppI1VZr7IdD73uxreRlbJ8oTZZYHLfg/mYz7lchu/5WM6p0sIkVP6ZeMT2O8dcj5HcJSpJaMAXn+4wuoQ4zPg9Q8Em4HKJvsoD1Tujw5sYqoFSt51AaY0CAVYWI+PFezAR1eUuX37RoCD0qiEhuCGeAfMWBX19ihu3Fsd1H3ec2wpz14jjPXrUY4oG7l6m/aHoy12Cm+m3+2uXnkRvhrteZr2lngGOKriUrmAdfHR+VpW3XGfFDpc58zKY4AcLe2yTqBzdS/Vgt5ZSpLhgnMo/5/LWmD31DeGN1YsGzHAmRaWGRRuraaFFBPUbJtaeEgjGsj5BTZZ66scv8nUJf50UHM73nU1Z8XdyC06p82TQmeWvkSoU6q/4pXrB8RpjKfePdgqAs6N3iZDVKygbTItM5bpFBtIf9i9udtISjD74ZB5T5mRgdpofVj7ZXm896a+K8kltkyJSWl62MF6PpIDfNJYHpGuPmPH1BonQrdwt6a4ukA7Eqv643PpJ85ybdWROX38gb6rSyy31M3mY+e0Of/MPJkWpuI3BByH9Wk5+1uj5vuT7vUbR6BwiBDv5WH3wUeHCuTKHIlSh9aJOgi/61g6Hyy1yq47SF0veLkWvu6II6dyWXaP33WCX6gc6sSwuQx//h+ieS/YDPdF57coXuC7zhl3h3jZzHUhezY6mmmOlmvTl6+aLkW2Ro786CHsxR9oNKBU3DIqJDlPune8aUHaZTMzhnqeJ97IvjvRYaaSw+CWBzElVTQes+OSy7d2Q0bhvtmXUOABaIUl0xFpO4w/7lmueVBZ7IORCUJ51Tq38azOPDLFj/3t9kvBPydBwXvdIBZkaF+erJu7icXhEFO5LnFJVB4qL0BCs4sFWJVYMorC6Rltf9IJx/QwE1IzYeYOLtfRIAN9Neu40+0kQStnH6DHkG9lB0SBh7X5N3/LKyLx+4vohAvc4OOnnMP+9/kWGp3a/8gv+NrhcsMDX6IAHwR7kKPOqqPuVZFLFryhZ6rIPf6IpSI2e7cNAc1n9CctkroDGeIZae4o83tjrGlY9cJbDwvyVnBgaFFwGzdipAE5nax/9Ix4UOE/BwTLdm6vaLtzIU/ZvSceK0MjtnXa9JI61sqdaSaHwLHFJvqLzYLhasgzwbfTtEU9vlsqGtv3yltzJYPNZL/rkzNUSjsf1UP9YbcDnlP1Qc04T8KeOoWLNKycq/pN3dgM7g3BjuWxkqR5JvrtZ5B2CP0141QTwjr8NdPncL7tuTASAfhmPXD8sutyqsWZHYiXrTBnbbd6/BuDp0Qzq/s8Xrx1JvmB7ZRvV4uLnzpBQMshDoFUy6W8VTX9LbHYsF7UMkON7rYNu9EklVr5V3s3onPqPwuIHI5Aqxnp+QCOZa8HisakdZlebPcqmKD5I9Fg/gU8+ymEpOnQleZ4Rf1ATRqb4wl0kFquRWpwEl6xB+sK7o3SMFPlMPkExaZabMrzsNjCZLhpH/EBbbFl33pcyAnos2UlKqFixH0V7D7FML1mWqRRAXiOCf6V1eCrL6bR76Uiv3O6xZTbYoTEyraXyoCb7P9inbn9RtTy6B2uT1Wf5FrXvPyYmNzertFsKKqp5AI14CJ/Z9Iug6GnBTuzM8/o8y9bpfnMjr08KaCaTQGPBDHoKCJ4QsxFaC025txlEPmE779lGnJeJiKuSMejkY9FNsFtZyk+AIJpT+FS4orQa7gmLis2cV7fvS98DTiEoHdwcHqc2m2w1dh25dr4o4uT2RtG1qntX+NWLBlR5VWYuqP1vtcR2DuUCmAcmaQtxQv5TvZ3ECAfYh9BsZztv9yiueeKIjtDa4HE7zdAyslVKuM0R7f2VyHs1V6q6S2h7OaL/ebCFZxdPd67Jeqr72AbJjNJrh/aWjaD23WsUUEi5JW1tPUa8uKM/IwmOXrMzsC2dWVyTLfONkdn5HvJUSuk/OgTfkCVJ0oA6hXBDBRX/iYy4F0B8jLU7ru8qqi8+0estOwxDP+j5A2iJRtEqb3L+dbqExynea6OMsi4ha/8pyK7E6hcj0UDln1xQa/ercfnaVfzZXeftYHe6lnwp1/CAoe13xLq6R/xR9lv5GRfGoWFNtFRmuqmDE8S4/JugXz4MLFsvaALTECJLXh26+jVEY4wpEFa06PUOdXWTCkK5dmposGK82bfgJufGz0vGO5M3o6Gd+5aTschhpJkl1cmgUj4pJtVOP9hl9c5AbaSluwZkJJk4ASokF+coV5tiIdkG0lBEO6CAoi09y7DTfzMzYwS6Efx1CnxK14KjAk18pnr8fFdo2k4eN5Y4fKqCLyx1f7QLBrCxei9ZKULxbt1lXPiTORiqL22QIfcG48v5wFvSgcs2GvWFw0zfZsHrUFbl5Y8E7XY9HCE+iNfsZ3eZel5tgIX8ahxIk1pGUlSpqvJ2km7UFLt7AoRINbSKwvZPU4yYXSxd3O0CcyfvRN/8WQFz5b/5KP1BUY+bi4shDfrjFw2MLN5hrvPYv/P4jqUMVlHP4mINBgRWXccUbyXw5I9IM7vlUDc9Bav3yz+I1rAZ+5S5m/PSmgBL5FUpv4LwSMmy0pjfeDYpDAakAZHTI1DaLicbJqb9Wg9/JspFaQWItxDjGaCxM6mL+NzXIh5ykVyQDRAz1OaL8dF5P1iEvz+t/PAqedQrFjb40bG4AgjnJmNMCQG1KrY6LLkZBZ2iDosBBVCsJYkfk32tNxs9PhDOz/tmTqHsIec5M0eOC8dfXr3Up3MgB3jB3A/imnuzr1YPELk541Vws1VYpL9NmLv3nkuBi+ZHpu6f8rl3ROQFobkuB+tQ66beYMp7s5DR6iL0Z+gF+2cO8eWLh63dlUdel+9g2ksGrNPV8X+8YUq920iFlDzfHM5Sr5F8ZTJVbz8XE5ubRBSOjt6X7OJW/2WnhzQ1Lb6eXZ5xWuYgMLz9DdWwzx86syNnQoEuKmF+3Fd3m+uwU3UVXVYfgxVS5CFaG5C1aawkLv49oKQ34aaCUl1sFQFMdvmcnk6V/SYDyWsyCBXB+wlc0E4jMJSHto5Bo57JDfSSPmwQFsulBmiH53H55gKb7cYeD+f+LADy0YMSXmB082ipRe6qmLKwyjlr6Viq9KGUjdL9/pYULmjPLRhF4tpkKKaG1TqMsFD+uchHWdXy/xVqpA55l7jste0hBOArMTstrltaQZ5HKav2jp2C8K+Xo3BD9LlAKH+XZ1iqDrT8a+jbnvdQHeEqbRy7inL+C331HDLG7g/azvAioShsyPGc/kglyneEE3/8nTehhhfGgqx0jMK3iCFRqJI4pTe5ZnVwF/rDTw6lArpwZ/7cxXnC5Qq58wJ1NNhxjqy25C7qEOFthjOBg+LyPkgJ4m3lmt0oF7XmJVNdHdn9XahUXK68yuxyOwGuVBSvC4i0sGd/VvbCE2+IWfIPlH2t6QmM+3eBqIvpJZUrbnN1gGXXgfxQWW60PK3RcupUDToqxvoO9EFDLMCmK6WfW7s134e5sF+KNtB2kFtwi+Ck9mdv0Y4qPyHQihwcO09hXW0wf1Kn619GIBb8hAdBAKad3Sq89r03CBdKoHhB7ylZEAsWX8tDIyoZTksVmgT1kedvtWsjbxvswNaOpPpmdxiMiU4TtEMp7XDRE7+DIUQtWBOQon/htDMP4ywxpY5s363626SRO+hyAK83WgjV+5tlVeVaBp/qjcF6RZhZj0mM0OiGrKxziFPisigiWYC2DG6dzhD6WjKX7+iLGvcxweyvT6QDRuve18hRLfCuHv0Sbf+YrVwtukF9fTz/xg/CjXefyK0T/yGv3hqxoEBARXs+syPi+t4wFV5YcPHqTs8MRUtM9M4Vioaf5pPVnVSp2htDfSwxSejPzNvlRoaRwO6HTZT6EntC99TwJkcwdDfCkk3vgL5SAhhEWqQWz0F3+iVpNapOjU2sjfZuNocV00MkYblKv7kBhG26oq72zEm2S0PpBpyYYPfmqNXYROqdKpuREr4f5JzLNBD6kjuOkXnjMoDXqmblYFDXoXbhTIr3RE+TZB7WOnUeh+Edk/sZ2WaZLfCsW7KM/RRHPdRxUekj2RGo1mJChBmoxhCNJlXbqGqk3LMq7pVXCY9jsIiEUafSp8HC6wRZ0KkxuUyLC7vWNz1/6x/AA31Ez60g6IqjECqnb6cO1Flc6nRlBCRnlw+OORKpHmLrZcwWsBWe80iQ+bL0GpT0XB2vhFUEsDzUnfPp428RxpVDtfWT8LtIE2kEwVHaX4kjx2fPNxalFjx+AddLhzPupLml8OBY+3d2MJ10DYHhPFkxK+Brm/M1xQEysx7WJolX55qDJWfc5n2Wa9v73l0s4PM4oQV588FTwPY1wulbQ2vq1g/1FSbwiD0QwOlFI5o9XRBx9iL09DQBzr+7Xw3fo//2Yuz3aTHwZyon9w8pQPtoFiZX06PMALqiLdE+7oQc3UbLvS/xyKUdIP7NUeZJXfQSnAKOfZlYuVzO24Y6I3kVS8H8uixn/eT9xw/d6jKrxrEsSytjFBglcFxTQhuIjqS0W0EzDu9YFiMOayO6/A1n+HBrlVumPiozkmUeokdZNgNTtWVJvlzHzOFYbTxQd3GFq0dXMLdma1F2laTX9JTlL6zQFEhfQstiUxnLc36vCUVA/letrI3xfbRldHJuojEEXH8mjm8ZU06tH73E5y9V0i4oy7k8ySnorg0J/7LcTHY90k2oL0Z/EwDQ9Tei4wmRfNcqCM6TGRfCLmgLq9QMijH1t+io0ep4p7q9iCfhyo08wekFvXgrRRuNJ6prkb010Ogw+R1slN1nJX6uvQGWL3E+dbSKdpHWjut8amcAu3zPX75TrZ7rCRMLIxZMCC5brzbSstQUtWArdM41eLWvN5zLZI7RgYJT8iGtEMbtLTf6qlJGTXk/xPtdIoaNgUaHTg5AqiNInYQDD0a9l/PxofjRFw5RSsttmOhITXNyCtVagvk0tWNzGgCSYSy/W0EmHZkyX64eYBrhOdE1b8F09RGjcJt9PTFwywhhhcooKyak0pe5KqF6wK4Rlol1GmFkX6kGpkPsXCUttwfNqM+kvYcEb8xbRW6PMoO3a1b/zQwvWp2G62V7Q6AJq7xQzOMZzIZMWLOMJimOs1Ad/ZZUxfXuTu0nnujTgKaxFY3w7hTF83E86GFvEAYsOU0NRo9Qi0a4MFUZQjyy4gtY05ESpRpk5kROF+PSMn6g/VC2Ykm9s9kyjNJT65pEbNGjSaHwbPUGrTSRLxX2wJXBeas6PmNRK5Z8RCcFW1Q0ZsTDos4qiDti44eNSw0yxqXpuwVoK/jIk/9/owqiSj/qav40RITuhEcRPZwQEcq+81ZXytO3w8y5udEF14pQMck2nmKlZnqIv5SFGOpP8XZVbpbP7JSuTv4nsr6kBdfoRHe7jXs/ItIXj/OgjFrnV5z7UO8TDGemxBWfhEvtWUtJMV7eULJjD+ZAQ2i82RvCiTB9QuaKHsKmHwnEW6d9YID6YPWSB1nq1srsnIJDbHRg05jo0mLMnLQejPEpx9crw/yxOr1MLPkrzWPXJPLc62Li9d+ic6Grem514Uxm6epYT3So/vTbk7X8Rdqkry5UYdd3Cbi2lxdFPp7Pyw/3GENMsREuLGv/G/QdKiepSg4nob5YWS/YVla+L8CjH+nBOEY1zdEbH98iDa8SppCpHOJvt9gJvwRpItyjH0MTGuznVx8Tr2DNCsu9BGlwNMQuWy6weokV2t5PAophOdNEipWb8tn7wOM9HIxXDRfJBsOC4zHI816E+5qIWnFKT2laSGn5XoAw0Lm//7j3+wH9PXnwmnMO/3y7rTUaw/6X3E/HuasExVQ7jLYUulsjDiuDCPs2SIw+M3uUKtEeaQ6asiwOLWnDDqo+US20bqHsHRwX4xSvMrKtNeo2HmqgRP2omFlTIwOo0V0rThB0hcKVf0oLjigXDEdlQZB8z4fHYyO3tlkBEJXU/1OFri/cU34MpWxdZVvIS+jNn+z8MkkGvTOILb2b5yB9JIiOr95jTjec7oqcx+wxejjdYxjJGivS00FCYSrhun1AqmhSJyLrz3S+IgHK1njirV6SOU+q0CaE1vVzF+tNd/g+xHRbBedABQyZIx7sgZ7dfAVxAZl7RpzMaFv3wUn9OE4X7Up8Y3psMWAHIzQcrOSF5Z9Wct6wQQ3mQBxW478lEibez9bZ/geunEU0spF04vngPVG6sfyRxiJljQ5K/O5qjZRm3NCGelYzA39X5e1DF4gs/5ZEjsKbAN2BtH4ckuiPS9YvQ+lJItox608uGXfgAf+aC1+P4kyR8JUYkAUoLXeHWkAQoa+zOf4sGLDZPr67gAUbqODQcvLKOml1bXNshnQayNB6bgfFUidD6JCgwktog9GpeOek5l5gimSL71pi0m/Cn8MhoiepVLolPdf5Mpk4Wn4jZkIZAERw87TGXbwtOb0/6zZXjpNgDDT7bUP3P4UUsOE44nxJe3G4aJmflVOO5XrNPAksdBBc90lfHx7er/LqHFqwI7Z0gcPV0ecB9Lwuup+Op73GxMEW0Qlc8ql/iIoMSW6HHDFTkhowP1zu4nVXu+ru/0styOQFAFwbx/sfi2fbNBId/gcX0kafrbA5H3llxlmGl49sjsx6PhrHxMPqsg0znoFPKcFV+bnMHvYr5pkLSQMLWGOoBuaU2aYpM9WeD9CRkzix6UHqOM6VE/xOXF0OgAblBi0ej7TL55OyO21x5C74DaP8a3meuL1lssWlufP155tfso/mTke7RklM5C94mTvQhRl60UDS+Ni8BU47TnUAD7qGWNB/mXEGsZ6tU2QZKxn9E7iQTeoTfmHR22bif1ByfCSd73wJR9lanH5lfOCMkvizv9TNxduKyAhZso5VX1Mi0v6tCWeMzqANfy8Vf5FHitKH0B8arpy3Y1uzUXCojiBFazmGxDCN25VDDf5JfCRGASoYGZSAd5RORViMDpVN6yIX9SKUTqmjJqfZcLdgCOV6O0+nT4Wg7xTUbf06VAtaL3OoSl7LgLLn33H6Q5a7ALvIkeUAr/Laa1hHZoxaLtOfE7kdZivouukNQRXGBdd/bgjNFL6An4s9EIhx9NyQuj5DuaSftv5kQ3XSKz83hMJQ6uqqdfg/qjYwq2uGUbpTiFR6kDPd2SDJOpPIfxfmDNqT/Nj70Vg/dT8OA+WEQgyvQx5zZOtwqdLkqoXhEFyT03IKdjlREnyNVSMtAqruXA3PUJu4LWdTKi28freiGL0la0ibfg8p9xv3b/aiD4i0cmWUQo4lAKxJ9vFzp8Qb9NsqOd3xVOxIK+NPd9YUsuCguYnuyZTueatEqas53ulIoawFHUStPQ52HAYpbRgpwh2zQOS2eNQbhftLlus/oYrZWp4tXUkPw/py31/QRDqSaPIM5JO/8cRqIPt8FTYk7+VoPpItBxS0YQzxkms3NXjfAMVfRrtQeyhrjzRiCup5bsPowDTuuYwfK0/Lib7Pw/mUl9wHa5CO1FsbYWRcZ99tm7iEm/c0hp7rY5bz5NkNWviSSigir3+gHnNtpC06Djx4sHvUhUySAz9Xj8oX2RRNerRHYQmVYy43Nv4lBI5qSHyGCExLcGXpJITonFGejc+Sf0AT9fQOfDqtAcumuvAdnZzlP2eh0SFZ6H2JUn3b2YDCBrtjQ5eWRcv76yJyGrnfQI0r1cfWU8hg9Hrl+Zbx3uTBMzQuKI/JYwaD96AhBsWP9ejcnJgoP5GzsOvc/R1/n5NSmROx4b/FqOeqlStkef43qVipWh3C3uetUXoCdfNrn6H8BxVGktnCf/CvXu2hPYg3IqTM+waXkEv1rOdCJ7eQap0nHD8B8TMhP5TZw3oVFmmnLCIzL0kQ+poWPNfaSjLIl8gtynstAfMBCuPpXFaCl1oIBuwudQ7B3Qc5TuQhsymHjgGe46J92pVmd1IZDqj3fPtsF6a9JmInKbC23nx3SKvoefv6CnEeikXAbSeoLIe6iNladQZ8ll+0wMOYLcr6Imu8sGSFQevEhF819n3MGgwHj4YKcR7JLhlg5O1KW+pzKNPnRFshSIxTJjOe+IOeN6N4yoB6OmGtPuN9LpcI0dFUBLV+Q80nuNRioI+UWHjQoaEh0G3NdL8j5JTWmpGnX8arMknXhVk8xGe+CnF9SA2vokBQ/FXe4Lotu/VjqcV/LQurfBTkfZRzMg0vpvfzY5QOeq8O+7FDBlWn2fEHOI5ne3V33ndorYDkoFHlMWAHXAtYjNEdHar+WA+CCnEcyRXC/qnYzj6J2E7rjfPPBF2RB2H/VKlV1znZeKXUZ3Qzu94KcdzIbDNTnNDu/BfL/gIs2BPsB2uoy7uNc/C2R9h46UedND/GC/H/Z+dV1BMjijgAAAABJRU5ErkJggg==";

string __red_pill_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAIsUlEQVR4Ae3d/29ddR3H8Xv6ZVvazs4C2Ro1G0EX2RzGkQgJigP9QTSUqb8sWVKjCQqaKCGpASWZzi1CMAG3KBolJfEHg4jBCNHhUMMUMTPYL260a0tpu663a9fvu12/3B6fP5xPcnPb7dPz5d7POZ/z/uHxB8Dr+WnOOffu3IzruikmbP8PFBKAkACEBCAkACEBCAlASABCAhASgJAAhAQgAVQ45VSBD+AefAOP4/v4Lr6Mu1EPB5mgVjx5LHuWCixiwXMF856c5zLmMIsZzzSmMIkJzyWMYwwXMYosRjwXMIzzGMIgBvAu+vGOp89xMr3owTlPl+dtnPWc8fzP01Gg3dPmU6kHb8AX8TT+gjEsw72GRfThFTyG21CVnAAkgG14EG9iCW4ERvAM7oATzwAkgL1oxRW4JdSFh7EpHgFIALvwEpbhltEUWrDBTAASwPX4hTrxBp3DveUNQAK4D8NwY+QEdkkApQ2gEkeQhxtDSzjG+A3RByABbMbLcONsBRhHCwHUSADRBFCJV5MxPpAHehn/znABSADV+DXcuCscX2H8PFoZvtF/ABKAg6eSND4KxwfA8DN4BBslgPUH8DW4CT79avxCvQSwXwLQB3AX5iw5/QAWPYx/Eh+RANYefyuGLTv9BeMDjL+EVsbfDgmgwCtw7T39KgCA8XM4zPi1SH0An0vX+EAOGMJBAnDSGkAF2lIbAC4DJwlgexoDaErz+CqAOWCWAL7H+JvSEoCDf1hz4acJYF5Za3zMehj/HTQTQKXtAdwmf/oLAsCMZxpoJ4C7bA7gWctOv358/elneGAKk8CLjH+jbQHUYgLuanL6pzyTmADmcZQA6mwJYL9c+BWMf/XTz/jAJWCYAJoJwEl6AM/Yf+GnP/2zutNfFMC4hwDeJIDbkxzAWT9DyOkvGB8XgTwBtBLADUkLYBvyabnty/k6/QXjawIY9RDAOON/E1VJCeA+ufALe/oLAsAI0EkAn0lCAIfltg/rHB9qfFxlfFzAMPASAdwU4wD0X/SU2z796c961PgqgPPAFQJ4nAA2xzGA/9g6vvnTz/gY8hDACAF8hQAq4hTAgPW3fdrxw5/+kauefjU+MAACOEMATXEJIBt6LLnw059+NT76PYz/KnabDmAs3Rd+KMmffhSPXxwA+vhaGgEcJ4AGUwF0asaQ0x/gwk9/+oE+MD6cUQL4kokA/iqnvzQXfvrTD4fxPT1g/D/iQ+UM4HiaTv9sOW771PjrPf3oUQEAC4z/UzSWI4AHNaPI8/7oTr9+fHSjC5ghgEcZf2MpA/hgup/3h7/tG9affv2f/uLx8baH8fvwhVIF4OCinP4At30BLvx0p79rzQAAxn8Ne0rxcfBvrDr95m/7wPiRnH41PsDwy/gZrosygK+m7nm/ods+/ekvHr84AKDTcSYY/luojiKAm4yNb+DTPpO3fb3hTj+ATnQA57AvXADAafN/+hP7aR/jQ3vhF9HpR0cBhp/Do6gKE8DD8iXPwvFLf9sX9PR3rA5A+TOjvjdoAPWYScOnfZPBT3+5bvv0f/qLx0cb0I2b/QcAHINbQJ73a05/1Ld9Z32c/vbVAShZ3BokgPcjF+fn/Yjn837zp7/YOD7mLwDgCbjhyfP+0Ld9wcdXRnGj3wDqMShf84rXhV+gAIDTqFl/AMA9ibvtM/A1r6AXftCMj2jGV1r9BBDgn4vJp339Jm770LZ++/0GsAGvJ+WlDuZPv/kLP40stq0/AKARg2n9kueFuN/2+dfqLwBgD0bhBpem5/3mT7/GLf4CAHYjm/J/3aMCMH/bF84L/gMAdqJbnvfH/rZPJ48d/gMAbsAJS17qkNzn/eE9GSwAwMEPkLP9a16RXfgZuO3TyIYJQNmHQSte6oCR9Jx+5dPhAgA24RHMJPNrXijLhR+CXPiVNoAjUQSgNOI55OW2L/anX/lXlAEoH8cbBk6/uU/7HMO3fcEtY0uU4ysOwx/EkHzaZ/7CT+OT0QeAFaCW8X+IXPjbPnneXyIPlS4A5IEdjP8clix5qUP8nvcH95PSB4BlYA/Dn7TjpQ4WnH7ghfIFgCWgmfEnjX3JM2W3fRp/L38AYPytDP8s8qU9/XLbp/FfMwFgAbiV8U/JlzwNjA+0mQ0AjO8w/AEMWPJSh2ScfuAt8wFgHqhh+BaMx/6lDjaMD7wWnwCQAxoY/xjjL1nyUgcUjR+fAH4fxwDUL3fuZvwT5l/qYOnpB56IcwDqlzub0GPBSx3iNT7w9fgHAGwggBbGnzbxvD+q098RvwA+lZQA1C93vo/xf2vJSx1Mj7+ILUkLQP1y5z60W/JSB1MB/BuZZAYAVDL+A4w/Jl/yDORI0gNQv9y5hfGfYvjFRL7UwYwV7LUlAPXLnR9m/D9BnvfrtSNjVwAYBT5PAN3yvP+aHrI3ABBANQE8wPjD8rx/lUu4zvYA1C931jH+Ucafj9VLHcw6ikxaAlC/3LmT8d+IzUsdzJlHY/oCAONXMP79GE3lbR/wI2TSGoD65c56xv8xwy+U+7avzaxBbJYA8C4YfydeTsnpn8VHkVEkAA8B3EkA/7T8tu/byKxFAgABOIx/kOGHLDz9z8O5dgASgPrlzlocZvycJeOfRt263xQqAQAEsJ3hn8dKgm/7erA1yLuCJQB0AZ9l+KEEnv4R7EBGAggTABj/PTjE+NMG/nVPEOdxCzKRBCABAIy/leF/hXyMT//r2IZM1AFIADgD7GX4UzEbfxlPYiMypQxAAgDjOzjA6AMxCKAdn1CDSgBlCQBg9BocwmUD4/ejGVXISABmAlCuZ/jHkC1DAB24H5vUiBKA6QDQDlTyP/VevIjZCEefxC9xNyrVeHELQAJAGzw1aMJxvIWcjy9sDuJvOIQ7UI2MkowAJIBidbgd38HP8Qec8ob+HZ7GAewKcsqDB+C66SUkAMtJAEICEBKAkACEBCAkACEBCAlASABCAhASgPg/csK8SMv+MG0AAAAASUVORK5CYII=";

string __blue_pill_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAJMElEQVR4AezStw3CABRF0Q+9gwdgGTqmoGcEKiowOWOgJuecmc0861uip6CAV5wBrnTF9/0/Rr8dSByAOABxAOIAxAGIAxAHIA5AHIA4AHEAEqf//KYoxCABKXAhA2lIQhwsiIB8rPd4695DN3E8ZXtXsTuBi2qfVesUOordPKjGXqxAfadqW1XdiFVZw0qVl2KWFqo4V4UZTMXMT5Q7FjM3EiOQHcJAjFd79/9b1V3Hcfxc2kLT3q7ItkCjCSxToiAzssQtmU6m/uCXjKH+QkJCosl0i4kuSzBbnMNBiSNz2dZGUaGU0iWsTth0NI4vc2bonMHM4aKRfdFQJBTBfSmzbLR3x+e56Ttt8jHXcz89537O55z3D49/gNfz05zPvZd7t0QGg47u3cDmAWDTrqAcuacfO4Py9yJ9wMbIjqB89/Zp3/2plbQHX4Av4UEcwllMIqzhIl7FMO7CNWj2JwANYBFuxXOYQJiA09iG61DSALIZwEr0422EKfobbkerBpCNAJbhcfnT3kBvYAPmagBuArgMP5ET79BLuLGxAWgAN+EUwgw5gGXpBqABNKEbFYQZNIEehl+gASQfQAf2I8wyRo+cwwa0aQDJBNCEg56MP9MrjH+9BjC7AFowiNC/AA6FjF9BPwF0aQD1B1DCA16OD4aHODjG+HdgXvwANICvIfT49Mv4wLaqVwhgjQbw/wO4AW/5Pz5kfDB+FQEcZvwPQwP4HxbiVG5Ovzk+noxMoJ/xF0MDgBj2e/x4AQjGH8cmxm9H4QP4vLfjw2J8AIx/EusIoFTUAObghYKdfhkfYvgw4y8uYgCrizi+EUDvMPafx3cIoLUoAZTw25xd+4wAYowvAYTzeyJP/J0A1jN+U94DuEZPvzF+2Bl5KPLLY7ghzwH0+RtAon/6ZwYg41cxfGQvrshbAO14raAPfrVPv4wvAYDxL2ALAZTzEsCaAlz74p9+Gd88/RIAHgsJ4BTjr0fJ9wC2FeDBL6nTX8X4U/aFnffve44ArvU5gL/WOYaefhkfjB9ecv/eCuP343LfAliESjGufRann9Frn34QAMOLc4z/DTT7EsBNCPXBr/bpZ/gap386AIYXLxLAZ3wIYBNC6LWvzj/9xumHBMD4GIo8zvhXZjkA84Oeeu2zP/0yvgSwNfLI27iXADqyGMAfcze+xenvtDj95vjG6Y/GB+6N7DlNAF8hgDlZCuBE4a59vbO99tV1+mX8KgIICeAvBLA6KwGM6uv99g9+sU+/jA/Gn/LwQQJY7jqAs4V/8EPtP/0i9oOfnH5zfEgAjB+ZIIBexl/gKoAXode+hB/8Ypx+xp/SPYjdZ/BlFwH82tnQevoxKAGEHZsjA0/gA40MoFevfTEe/KxO/564p39mAJF3COCHBNDViABu1df7U7r2Gac/xvhg/CoCGCOAOwlgXpoBvL/wr/dbnP4Yf/qBGH/6YY4Pxp+y81UC+GJaAZTwL6vB9PV+iwe/GKffDCAkAPQ9hRVJBxDZ48ODnxlAhh/80JHM6Zfxqxh/Ej8igEuTDOCrFqPp6/3Jn35zfDMA7AjLd+94jeG/iZYkArjS/fjZfLdPxhd2D36YOT5i/+k3x5cAsD3yElbNJgBxNO2x9fQP1nH6ZXwzABlfMORbuBPNswngdr321RgfyV/7bE//diEBiCfxHtsAOjFWgHf7YnzMy/W1zxy/xukX4jg+ZBNApCfRgfXdPovTvzP+6TfHF6O42iaA92HcblR9vR9xX+9P/vSbzuGj9QQgtuqDXwqv9yf/4BfHGVxRbwCdGPH/wQ8evN5vce2LG4A4ira4AYjP6bt98T/mFf/aNyBqjZ/A6Tf01xOA2OZgfH/f7WN4B9e+eqypN4C5eMaLd/vcf8jTDCDla5+FUSyKG4DowkhRr30M78u1L67+egIQK3CmwP+7x/5jXg4e/GK4qp4AxHKMItRrHxxe+xLwqE0AkaU4HmNwfb0/m6dfVLDEJoDI5Tjg8Zc62L/eD/ev9yfmPpsARAn3YDwT174e+9Pv/7XP2qhFAIZVGPH8Sx18fLcvKZ+2CMDQijswpv+7x/ba52B8oDuJAEQXdqFSgGuf76df/D7JAMTH8GzO3u1z9TGvtE1ifpLjixKjr8NJ/7/Uwf3HvFL2ieQDAMNH2rGZAMbtr336en/KbksxAHFoCePvwkQir/ejoB/zSsNDjQhAfr51BcMfdvkxL33wMzzauADA+JH1jP+6Xvucji9+0/gAwPgLGb+P0Sv+f6mDl6df/MlVAPLLnVfjiP9f6uD+2mfpBdcBREoMvxYnYr3bpx/yTNLz7gMAw0faGH0Dzjn6UocCXPsMT2UnADB8ZAF6GH8iJ1/qAGP8rASwL3MBCAJYTgAHPPhSBx9Pv9ia5QDklztXM/7L+jGvVHzdhwACApjL8BvwZuO+1OFh8/R79np/DJ/0IwAwfuS9DP+znHypg2sXMd+vAMD4kVWMf8zphzz9P/1/QOBnACCAJgK4hQDO+v+lDk50+x4AHgsIYD4BPMD4F/Xdvtjexcq8BCC/3PlBhv+VvtsXyzEEeQtAfrnzCwx/XF/vr+m2/AYAxm/BLYx/Sl/vN/wbl+Y9gCoCKDP+Fk7/BQ+/1CEtWxAUJQAMBQSwlACedf+/e5y7gK4iBoBH5jD+zThTnHf7DN9HUNQA5Jc7Oxn/Bwz/TkGufWIEHRrA9C93LsV+F1/q4MB5fATBNA2givGvx+9qnn7/r33fMsfXACSASIkA1jH+yRye/iGUNIBaAYAAsLudADYx/nhOHvyOohz/m0I1gIAAMLCY8YfwrsfXvpexEEH9AWgA8sudn2X4kx6e/tNYgmA2AWgAYPxLsJEA3vTkwe+fuApBMgFoAFWMv5Dhd6CS4dP/DBYhSD4ADQB9kZWMfyRj40/iPsxDoAGkGQAIoEQAaxn9RAYCOIaPy6AaQGMCkF/ubMNG/MfB8P/AejQj0ADcBCAu4x/zLowiTNmfcTNaZUQNwH0A8g/ahBuxF+cTHP11bMen0CTjZS8ADWCmNqxGL57HeB0f2BzB09iI69CCQHgRgAZgKONafBs/xi9wBE/j53gQa7FMTnkjBGEYFpfKeQBKA1AagNIAlAagNAClASgNQGkASgNQGoDSANR/AWJ2EQGXgXEIAAAAAElFTkSuQmCC";

string __importance_bar_gradient = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAUCAYAAABMDlehAAAAb0lEQVR42gFkAJv/AFFRUf8AVlZW+ABcXFzvAGRjY+QAa2xr2AB1dHXLAH5+fr0AiIiIrgCTk5KfAJ2dnZAAqKiofwCzs7JwAL69vmAAyMjIUQDS0tJBANzb3DMA5eXlJwDt7e0bAPT09BAA+vr6B861MNMaArkVAAAAAElFTkSuQmCC";



//This file isn't used in guide at all, currently, but I'd thought I'd release it anyways.
//Classifies locations on whether they are adventure.php. Useful for scripts that need that information. Relevant for arrowing monsters, KOLHS, wandering monsters, semi-rare, etc.



static
{
    int [location] __adventure_php_locations;
    void initialiseAdventurePHPLocations()
    {
        //Two methods:
        //Look up every snarfblat, and assign ones that have locations. (this is faster)
        //Load adventures.txt, find every adventure= entry, save those. (slower, but more accurate if they ever go past 1000 snarfblat)
        //Using the first method, because our parsing of adventures.txt isn't perfect, and it'll take a few years before we go over snarfblat=1000
        if (true)
        {
            //0.985093583 total, 0.663535898 net, 1000 invocations
            for i from 1 to 1000 //FIXME update this in a few years, we're nearing 500 or so right now
            {
                location l = i.to_location();
                if (l != $location[none])
                    __adventure_php_locations[l] = i;
            }
        }
        else
        {
            //2.571006588 total, 0.791600414 net, 1000 invocations
            //Read from adventures.txt:
            //This doesn't accurately read the file. No idea how to use file_to_map here.
            string [string,string] adventures_txt;
            file_to_map("data/adventures.txt", adventures_txt);
            //print_html("adventures_txt = " + adventures_txt.to_json());
            foreach key in adventures_txt
            {
                foreach key2 in adventures_txt[key]
                {
                    if (key2.contains_text("adventure="))
                    {
                        int snarfblat = key2.replace_string("adventure=", "").to_int_silent();
                        
                        location l = snarfblat.to_location();
                        if (l != $location[none])
                            __adventure_php_locations[l] = snarfblat;
                    }
                    //print_html("found (" + key + ")(" + key2 + ") \"" + adventures_txt[key][key2] + "\"");
                }
            }
        }
    }
    initialiseAdventurePHPLocations();
}

boolean locationVisitsAdventurePHP(location l)
{
    if (l.to_url().contains_text("adventure.php"))
        return true;
    if (__adventure_php_locations contains l)
        return true;
    return false;
}

boolean locationAllowsWanderingMonsters(location l)
{
    if ($locations[The Shore\, Inc. Travel Agency,Noob Cave,The Dire Warren] contains l)
        return false;
    if ($locations[The Daily Dungeon,An Overgrown Shrine (Northwest),An Overgrown Shrine (Southwest),An Overgrown Shrine (Northeast),An Overgrown Shrine (Southeast),A Massive Ziggurat] contains l) //warning: I have not personally verified these
    	return false;
    if (l == $location[The X-32-F Combat Training Snowman])
        return false;
    if ($locations[Gingerbread Industrial Zone,Gingerbread Train Station,Gingerbread Sewers,Gingerbread Upscale Retail District] contains l && l != $location[none])
        return false;
    return l.locationVisitsAdventurePHP();
}

int snarfblatForLocation(location l)
{
    if (__adventure_php_locations contains l)
        return __adventure_php_locations[l];
    return -1;
}

Record Counter
{
    string name;
    string location_id; //number or *
    string mafia_informed_type; //"wander" seen
    string [int] mafia_gifs;
    int [int] exact_turns; //sorted order
    int range_start_turn;
    int range_end_turn;
    boolean found_start_turn_range;
    boolean found_end_turn_range;
    
    boolean initialised;
    boolean waiting_for_adventure_php;
};

Counter CounterMake()
{
    Counter c;
    c.range_start_turn = -1;
    c.range_end_turn = -1;
    c.initialised = true;
    
    return c;
}

//If false, use exact_turns. If true, range_start_turn/range_end_turn. (this isn't ideal, sorry)
boolean CounterIsRange(Counter c)
{
    if (!c.initialised)
        return false;
    //if (c.range_start_turn < 0 && c.range_end_turn < 0) //seems to be an errornous test when we go past our window
        //return false;
    if (c.exact_turns.count() == 0 && (c.found_start_turn_range || c.found_end_turn_range))
        return true;
    return false;
}

int CounterGetNextExactTurn(Counter c)
{
    if (!c.initialised)
        return -1;
    if (c.CounterIsRange())
        return -1;
    if (c.exact_turns.count() == 0)
        return -1;
    return c.exact_turns[0];
}

boolean CounterIsExact(Counter c)
{
	return c.CounterGetNextExactTurn() >= 0;
}

boolean CounterMayHitNextTurn(Counter c)
{
    //FIXME use CounterMayHitInXTurns to implement this once we're sure it works
    if (!c.initialised)
        return false;
    if (c.exact_turns.count() > 0)
    {
        foreach key, turn in c.exact_turns
        {
            if (turn == 0)
                return true;
        }
        return false;
    }
    else if (!c.found_start_turn_range && !c.found_end_turn_range)
    {
        return false;
    }
    //turn range:
    else if (c.found_start_turn_range)
    {
        if (c.range_start_turn <= 0)
            return true;
        else
            return false;
    }
    else if (c.found_end_turn_range)
        return true; //maaaybe?
    return false;
}

boolean CounterMayHitInXTurns(Counter c, int turns_limit)
{
    if (!c.initialised)
        return false;
    if (c.exact_turns.count() > 0)
    {
        foreach key, turn in c.exact_turns
        {
            if (turn <= turns_limit)
                return true;
        }
        return false;
    }
    else if (!c.found_start_turn_range && !c.found_end_turn_range)
    {
        return false;
    }
    //turn range:
    else if (c.found_start_turn_range)
    {
        if (c.range_start_turn <= turns_limit && c.range_end_turn >= 0)
            return true;
        else
            return false;
    }
    else if (c.found_end_turn_range && c.range_end_turn >= 0)
    {
        return true; //maaaybe?
    }
    return false;
}

Vec2i CounterGetWindowRange(Counter c) //x is min, y is max
{
    if (!c.CounterIsRange())
        return Vec2iMake(-1, -1);
    return Vec2iMake(c.range_start_turn, c.range_end_turn);
}

//DOES NOT HANDLE COUNTER RANGES:
boolean CounterWillHitExactlyInTurnRange(Counter c, int start_turn_range, int end_turn_range)
{
    if (!c.initialised)
        return false;
    
    Vec2i turn_range = Vec2iMake(start_turn_range, end_turn_range);
    
    foreach key in c.exact_turns
    {
        int turn = c.exact_turns[key];
        if (turn_range.Vec2iValueInRange(turn))
            return true;
    }
    return false;
}

boolean CounterWillHitNextTurn(Counter c)
{
	if (c.name == "Holiday Monster") //mafia's tracking of these breaks, so, don't rely on it. thinking of El Dia de Los Muertos Borrachos specifically
		return false;
    if (c.CounterIsRange())
    {
        Vec2i range = c.CounterGetWindowRange();
        if (c.name == "Semi-rare" && range.y <= 0)
        	return false; //there's probably a lot of other ones where being negative means it won't happen
        if (range.y <= 0)
            return true;
    }
    if (c.CounterWillHitExactlyInTurnRange(0, 0))
        return true;
    return false;
}


boolean CounterExists(Counter c)
{
    if (!c.initialised)
        return false;
    if (c.CounterIsRange())
        return true;
    if (c.exact_turns.count() > 0)
        return true;
    return false;
}

buffer CounterDescription(Counter c)
{
    if (!c.initialised)
    {
        return "Uninitialised".to_buffer();
    }
    buffer description;
    description.append(c.name);
    if (!c.CounterExists())
        description.append(" (invalid)");
    if (c.location_id != "")
    {
        description.append(" (location ");
        description.append(c.location_id);
        description.append(")");
    }
    if (c.mafia_gifs.count() > 0)
    {
        description.append(" (gif ");
        description.append(c.mafia_gifs.listJoinComponents(", ", "and"));
        description.append(")");
    }
    description.append(" in ");
    if (c.CounterIsRange())
    {
        description.append("[");
        description.append(c.range_start_turn);
        description.append(", ");
        description.append(c.range_end_turn);
        description.append("]");
    }
    else
    {
        description.append(c.exact_turns.listJoinComponents(", ", "or"));
    }
    description.append(" turns");
    return description;
}


void CountersParseProperty(string property_name, Counter [string] counters, boolean are_temp_counters)
{
    foreach key in counters
    {
        remove counters[key];
    }
    
	string counter_string = get_property(property_name);
    /*_tempRelayCounters uses | as a separator, relayCounters does not:
> get _tempRelayCounters

15:Romantic Monster window begin loc=*:lparen.gif|25:Romantic Monster window end loc=* type=wander:rparen.gif|7:Digitize Monster loc=* type=wander:watch.gif|7:Digitize Monster loc=* type=wander:watch.gif|7:Digitize Monster loc=* type=wander:watch.gif|

> get relayCounters

70:Semirare window begin:lparen.gif:80:Semirare window end loc=*:rparen.gif
    */
	string [int] counter_split = split_string(counter_string.replace_string("|", ":"), ":"); //FIXME | properly
    //print_html("counter_split = " + counter_split.to_json());
    //Parse counters:
    for i from 0 to (counter_split.count() - 1) by 3
    {
        if (i + 3 > counter_split.count())
            break;
        if (counter_split[i].length() == 0)
            continue;
        int turn_number = to_int_silent(counter_split[i]);
        if (are_temp_counters)
            turn_number += my_turncount();
        int turns_until_counter = turn_number - my_turncount();
        string counter_name_raw = counter_split[i + 1];
        string counter_gif = counter_split[i + 2];
        string location_id;
        string type;
        string intermediate_name = counter_name_raw;
        //print_html("intermediate_name = " + intermediate_name + ", turn_number = " + turn_number + ", turns_until_counter = " + turns_until_counter);
        
        //Parse loc, remove it from intermediate name:
        //loc=* type=wander
        
        string [string] set_properties;
        
        string [int][int] properties_found = intermediate_name.group_string(" ([^= ]*)=([^ ]*)");
        //print_html("intermediate_name = " + intermediate_name + " properties_found = " + properties_found.to_json());
        
        foreach key in properties_found
        {
            string entire_match = properties_found[key][0];
            set_properties[properties_found[key][1]] = properties_found[key][2];
            intermediate_name = intermediate_name.replace_string(entire_match, "");
        }
        if (set_properties contains "loc")
            location_id = set_properties["loc"];
        if (set_properties contains "type")
            type = set_properties["type"];
        
        /*string [int][int] location_match = group_string(intermediate_name, " loc=([0-9*]*)");
        if (location_match.count() > 0)
        {
            location_id = location_match[0][1];
            string end_string = " loc=" + location_id;
            if (intermediate_name.stringHasSuffix(end_string))
            {
                int clip_pos = intermediate_name.length() - end_string.length();
                if (clip_pos > 0)
                    intermediate_name = intermediate_name.substring(0, clip_pos);
                else
                    intermediate_name = "";
            }
        }*/
        
        boolean is_window_start = false;
        boolean is_window_end = false;
        //Convert intermediate name to our internal representation:
        if (intermediate_name.contains_text("window begin"))
        {
            //generic window
            intermediate_name = intermediate_name.substring(0, intermediate_name.index_of(" window begin"));
            is_window_start = true;
        }
        else if (intermediate_name.contains_text("window end"))
        {
            //generic window
            intermediate_name = intermediate_name.substring(0, intermediate_name.index_of(" window end"));
            is_window_end = true;
        }
        
        
        string final_name = intermediate_name;
        if (intermediate_name == "Fortune Cookie" || intermediate_name.stringHasPrefix("Semirare"))
        {
            final_name = "Semi-rare";
        }
        final_name = final_name.entity_encode();
        
        //Now create and edit our counter:
        
        Counter c = CounterMake();
        if (counters contains final_name)
            c = counters[final_name];
        if (are_temp_counters)
            c.waiting_for_adventure_php = true;
        
        c.name = final_name;
        boolean should_add_gif = true;
        if (c.mafia_gifs.count() > 0)
        {
            foreach key in c.mafia_gifs
            {
                if (c.mafia_gifs[key] == counter_gif)
                    should_add_gif = false;
            }
        }
        if (should_add_gif)
            c.mafia_gifs.listAppend(counter_gif);
        c.location_id = location_id;
        c.mafia_informed_type = type;
        
        if (is_window_start)
        {
            c.range_start_turn = turns_until_counter;
            if (!c.found_end_turn_range) //haven't found an end turn range - implicitly set it to the start
                c.range_end_turn = turns_until_counter;
            c.found_start_turn_range = true;
        }
        else if (is_window_end)
        {
            c.range_end_turn = turns_until_counter;
            c.found_end_turn_range = true;
        }
        else
        {
            if (c.name == "Dance Card" && turns_until_counter < 0) //bug: dance card is still in relayCounters after being met
            {
                continue;
            }
            //if (turns_until_counter >= 0)
            if (true)
            {
                if (turns_until_counter >= 0 || c.name != "Semi-rare")
                    c.exact_turns.listAppend(MAX(0, turns_until_counter));
                sort c.exact_turns by value;
            }
        }
        
        counters[final_name] = c;
    }
    
    /*if (my_path_id() == PATH_LIVE_ASCEND_REPEAT && !(counters contains "Semi-rare"))
    {
        //We already have this information:
        //(won't always be accurate)
        Counter c = CounterMake();
        c.name = "Semi-rare";
        int next_turn = 75;
        while (next_turn < my_turncount())
        {
            next_turn += 110;
        }
        next_turn -= my_turncount();
        c.exact_turns.listAppend(next_turn);
        counters["Semi-rare"] = c;
    }*/
}

Counter [string] __active_counters; //Try to avoid referencing directly
Counter [string] __active_temp_counters;

boolean __counters_inited = false;
int __counters_turn_inited = -1;
string __counters_inited_property_value;
void CountersInit()
{
    if (__counters_inited && __counters_turn_inited == my_turncount() && __counters_inited_property_value == get_property("relayCounters"))
        return;
    __counters_inited = true;
    __counters_turn_inited = my_turncount();
    __counters_inited_property_value = get_property("relayCounters");

    //parse counters:
	//Examples:
	//relayCounters(user, now '1378:Fortune Cookie:fortune.gif', default )
	//relayCounters(user, now '1539:Semirare window begin loc=*:lparen.gif:1579:Semirare window end loc=*:rparen.gif', default )
	//relayCounters(user, now '70:Semirare window begin:lparen.gif:80:Semirare window end loc=*:rparen.gif', default )
	//relayCounters(user, now '1750:Romantic Monster window begin loc=*:lparen.gif:1760:Romantic Monster window end loc=*:rparen.gif', default )
    //relayCounters(user, now '7604:Fortune Cookie:fortune.gif:7584:Fortune Cookie:fortune.gif', default )
    //relayCounters(user, now '450:Fortune Cookie:fortune.gif:458:Fortune Cookie:fortune.gif:401:Dance Card loc=109:guildapp.gif', default )
    //relayCounters(user, now '1271:Nemesis Assassin window begin loc=*:lparen.gif:1286:Nemesis Assassin window end loc=*:rparen.gif:1331:Fortune Cookie:fortune.gif', default )
    //relayCounters(user, now '695:Nemesis Assassin window begin loc=*:lparen.gif:710:Nemesis Assassin window end loc=*:rparen.gif:780:Fortune Cookie:fortune.gif:685:Dance Card loc=109:guildapp.gif', default )
    //70:Semirare window begin:lparen.gif:80:Semirare window end loc=*:rparen.gif:57:Digitize Monster:watch.gif:57:Romantic Monster window begin loc=*:lparen.gif:67:Romantic Monster window end loc=*:rparen.gif
    
    foreach key in __active_counters
    {
        remove __active_counters[key];
    }
    foreach key in __active_temp_counters
    {
        remove __active_temp_counters[key];
    }
    CountersParseProperty("relayCounters", __active_counters, false);
    CountersParseProperty("_tempRelayCounters", __active_temp_counters, true);
    
    //print_html("__active_counters = " + __active_counters.to_json());
    
}

Counter CounterLookup(string counter_name, Error found, boolean allow_temp_counters)
{
    CountersInit();
    if (__active_counters contains counter_name)
    {
        return __active_counters[counter_name];
    }
    else if (allow_temp_counters && __active_temp_counters contains counter_name)
    {
        return __active_temp_counters[counter_name];
    }
    else
    {
        found.ErrorSet();
        return CounterMake();
    }
}


Counter CounterLookup(string counter_name, Error found)
{
    return CounterLookup(counter_name, found, false);
}

Counter CounterLookup(string counter_name, boolean allow_temp_counters)
{
    return CounterLookup(counter_name, ErrorMake(), allow_temp_counters);
}

Counter CounterLookup(string counter_name)
{
    return CounterLookup(counter_name, ErrorMake());
}

string [int] CounterGetAllNames(boolean allow_temp_counters)
{
    string [int] names;
    foreach name in __active_counters
        names.listAppend(name);
    if (allow_temp_counters)
    {
        foreach name in __active_temp_counters
            names.listAppend(name);
    }
    return names;
}

string [int] CounterGetAllNames()
{
    return CounterGetAllNames(false);
}

void CountersReparse()
{
    __counters_inited = false;
    CountersInit();
}



//Bee is wrong, mafia does not track properly.
boolean [string] __wandering_monster_counter_names = $strings[Romantic Monster,Rain Monster,Holiday Monster,Nemesis Assassin,WoL Monster,Digitize Monster,Enamorang Monster,portscan.edu];
string [string] __wandering_monster_property_lookups {"Romantic Monster":"romanticTarget", "Digitize Monster": "_sourceTerminalDigitizeMonster", "Enamorang Monster":"enamorangMonster"};

//This is for ascension automation scripts. Call this immediately before adventuring in an adventure.php zone.
//This will enable tracking of zero-adventure encounters that mean a wandering monster will not appear next turn. Affects CounterWanderingMonsterMayHitNextTurn() only.
int __last_turn_definitely_visited_adventure_php = -1;
void CounterAdviseAboutToVisitAdventurePHP()
{
    __last_turn_definitely_visited_adventure_php = my_turncount();
}

void CounterAdviseLastTurnAttemptedAdventurePHP(int turn)
{
    __last_turn_definitely_visited_adventure_php = turn;
}

boolean CounterWanderingMonsterMayHitNextTurn()
{
    monster last_monster = get_property_monster("lastEncounter");
    
    if (my_path_id() == PATH_THE_SOURCE)
    {
        int interval = get_property_int("sourceInterval");
        if (interval == 200 || interval == 400)
            return true;
    }
    if (get_property("questG04Nemesis") == "step17") //first wanderer in nemesis quest
        return true;
    
    if (__last_turn_definitely_visited_adventure_php == -1 && $monsters[Black Crayon Beast,Black Crayon Beetle,Black Crayon Constellation,Black Crayon Golem,Black Crayon Demon,Black Crayon Man,Black Crayon Elemental,Black Crayon Crimbo Elf,Black Crayon Fish,Black Crayon Goblin,Black Crayon Hippy,Black Crayon Hobo,Black Crayon Shambling Monstrosity,Black Crayon Manloid,Black Crayon Mer-kin,Black Crayon Frat Orc,Black Crayon Penguin,Black Crayon Pirate,Black Crayon Flower,Black Crayon Slime,Black Crayon Undead Thing,Black Crayon Spiraling Shape,angry bassist,blue-haired girl,evil ex-girlfriend,peeved roommate,random scenester] contains last_monster) //bit of a hack - if they just fought a hipster monster (hopefully not faxing it), then the wandering monster isn't up this turn. though... __last_turn_definitely_visited_adventure_php should handle that...
    {
        return false;
    }
    if (my_turncount() == __last_turn_definitely_visited_adventure_php && __last_turn_definitely_visited_adventure_php != -1) //that adventure didn't advance the counter; no wandering monsters. also, does lights out override wanderers? but, what if there are TWO wandering monsters? the plot thickens
    {
        string last_encounter = get_property("lastEncounter");
        location last_location = get_property_location("lastAdventure");
        if (!($strings[Lights Out,Wooof! Wooooooof!,Playing Fetch*,Your Dog Found Something Again,Gunbowwowder,Seeing-Eyes Dog] contains last_encounter) && !(last_location != $location[none] && !last_location.locationAllowsWanderingMonsters()))
            return false;
    }
    //FIXME use CounterWanderingMonsterMayHitInXTurns to implement this once we're sure it works
    foreach s in __wandering_monster_counter_names
    {
    	if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        if (s == "Romantic Monster" && get_property_int("_romanticFightsLeft") == 0) //If mafia's tracking doesn't recognise the monster, then we can override by decrementing the romantic fights left. Added because of the machine elf tunnels.
            continue;
        Counter c = CounterLookup(s);
        if (c.CounterExists() && c.CounterMayHitNextTurn())
        {
            return true;
        }
    }
    if (get_property_int("_romanticFightsLeft") > 0 && !CounterLookup("Romantic Monster").CounterExists() && my_path_id() != PATH_ONE_CRAZY_RANDOM_SUMMER) //mafia will clear the romantic monster window if it goes out of bounds
        return true;
    
    //Disabled for now, because this is hard to predict:
    /*boolean [string] holidays = getHolidaysToday();
    foreach s in $strings[Feast of Boris,El Dia de Los Muertos Borrachos]
    {
        if (!holidays[s]) continue;
        if (!CounterLookup("Holiday Monster").CounterExists())
        {
            return true;
        }
    }*/
    return false;
}

//only_detect_by_counter_names or in other words "not source agents", which we use in exactly one place for an obscure situation.
boolean CounterWanderingMonsterMayHitInXTurns(int turns, boolean only_detect_by_counter_names)
{
    if (CounterWanderingMonsterMayHitNextTurn() && !only_detect_by_counter_names)
        return true;
    foreach s in __wandering_monster_counter_names
    {
        if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        if (CounterLookup(s).CounterExists() && CounterLookup(s).CounterMayHitInXTurns(turns))
            return true;
    }
    //if (get_property_int("_romanticFightsLeft") > 0 && !CounterLookup("Romantic Monster").CounterExists() && my_path_id() != PATH_ONE_CRAZY_RANDOM_SUMMER) //mafia will clear the romantic monster window if it goes out of bounds
        //return true;
    return false;
}
boolean CounterWanderingMonsterMayHitInXTurns(int turns)
{
    return CounterWanderingMonsterMayHitInXTurns(turns, false);
}

boolean CounterWanderingMonsterWillHitInXTurns(int turns)
{
    //CounterWillHitExactlyInTurnRange
    foreach s in __wandering_monster_counter_names
    {
        if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        if (CounterLookup(s).CounterExists() && CounterLookup(s).CounterWillHitExactlyInTurnRange(0, turns))
            return true;
    }
    return false;
}

Counter [int] CounterWanderingMonsterWindowsActiveInXTurns(int turns)
{
    Counter [int] result;
    foreach s in __wandering_monster_counter_names
    {
        if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        Counter c = CounterLookup(s);
        if (c.CounterExists() && c.CounterMayHitInXTurns(turns))
            result[result.count()] = c;
    }
    return result;
}

Counter [int] CounterWanderingMonsterWindowsActiveNextTurn()
{
    Counter [int] result;
    if (!CounterWanderingMonsterMayHitNextTurn())
        return result;
    foreach s in __wandering_monster_counter_names
    {
        if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        Counter c = CounterLookup(s);
        if (c.CounterExists() && c.CounterMayHitNextTurn())
            result[result.count()] = c;
    }
    return result;
}

boolean [monster] CounterWanderingMonstersActiveNextTurn()
{
    boolean [monster] result;
    foreach key, c in CounterWanderingMonsterWindowsActiveNextTurn()
    {
        if (__wandering_monster_property_lookups contains c.name)
            result[get_property_monster(__wandering_monster_property_lookups[c.name])] = true;
        //result
    }
    //FIXME determine Rain Monster,Holiday Monster,Nemesis Assassin,Bee,WoL Monster
    return result;
}

boolean [monster] CounterWanderingMonstersActiveInXTurns(int turns)
{
    boolean [monster] result;
    foreach key, c in CounterWanderingMonsterWindowsActiveInXTurns(turns)
    {
        if (__wandering_monster_property_lookups contains c.name)
            result[get_property_monster(__wandering_monster_property_lookups[c.name])] = true;
        //result
    }
    //FIXME determine Rain Monster,Holiday Monster,Nemesis Assassin,Bee,WoL Monster
    return result;
}

boolean CounterWanderingMonsterCountersHaveRange()
{
    foreach s in __wandering_monster_counter_names
    {
        if (s == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING) continue; //mafia bug
        Counter c = CounterLookup(s);
        if (!c.CounterExists())
            continue;
        if (c.CounterIsRange())
            return true;
    }
    return false;
}


boolean CounterWanderingMonsterWillHitNextTurn()
{
    if (!CounterWanderingMonsterMayHitNextTurn())
        return false;
    foreach key, c in CounterWanderingMonsterWindowsActiveNextTurn()
    {
        if (c.CounterWillHitNextTurn())
        {
            return true;
        }
    }
    return false;
}

boolean CounterWanderingMonstersCurrentlyActiveNextTurnAreFree()
{
    boolean [monster] monsters = CounterWanderingMonstersActiveNextTurn();
    if (monsters.count() == 0)
        return false;
    foreach m in monsters
    {
        if (!m.monster_has_zero_turn_cost())
            return false;
    }
    return true;
}


boolean CounterWanderingMonstersCurrentlyAroundAreFree()
{
    boolean [monster] monsters = CounterWanderingMonstersActiveInXTurns(10000); //FIXME better
    if (monsters.count() == 0)
        return false;
    foreach m in monsters
    {
        if (!m.monster_has_zero_turn_cost())
            return false;
    }
    return true;
}

boolean CounterWanderingMonstersCurrentlyAroundAreExact() //not exclusively, but at least one is
{
    foreach key, c in CounterWanderingMonsterWindowsActiveInXTurns(10000) //FIXME better
    {
        if (c.CounterExists() && !c.CounterIsRange())
            return true;
    }
    return false;
}

CountersInit();
//Library for checking if any given location is unlocked.
//Similar to canadv.ash, except there's no code for using items and no URLs are (currently) visited. This limits our accuracy.
//Currently, most locations are missing, sorry.






//Quest status stores all/most of our quest information in an internal format that's easier to understand.
record QuestState
{
	string quest_name;
	string image_name;
	
	boolean startable; //can be started, but hasn't yet
	boolean started;
	boolean in_progress;
	boolean finished;
	
	int mafia_internal_step; //0 for not started. INT32_MAX for finished. This is +1 versus mafia's "step1/step2/stepX" system. "step1" is represented as 2, "step2" as 3, etc.
	
	boolean [string] state_boolean;
	string [string] state_string;
	int [string] state_int;
	float [string] state_float;
	
	boolean council_quest;
};

QuestState [string] __quest_state;
boolean [string] __misc_state;
string [string] __misc_state_string;
int [string] __misc_state_int;
float [string] __misc_state_float;

int QuestStateConvertQuestPropertyValueToNumber(string property_value)
{
	int result = 0;
	if (property_value == "")
		return -1;
	if (property_value == "started")
	{
		result = 1;
	}
	else if (property_value == "finished")
	{
		result = INT32_MAX;
	}
	else if (property_value.contains_text("step"))
	{
		//lazy:
		string theoretical_int = property_value.replace_string(" ", "").replace_string("step", ""); //one revision had a bug that set questL11Worship to "step 4", so remove spaces
		int step_value = theoretical_int.to_int_silent();
		
		result = step_value + 1;
		
		if (result < 0)
			result = 0;
	}
	else
	{
		//unknown
	}
	return result;
}

boolean questPropertyPastInternalStepNumber(string quest_property, int number)
{
	return QuestStateConvertQuestPropertyValueToNumber(get_property(quest_property)) >= number;
}

void QuestStateParseMafiaQuestPropertyValue(QuestState state, string property_value)
{
	state.started = false;
	state.finished = false;
    state.in_progress = false;
	state.mafia_internal_step = QuestStateConvertQuestPropertyValueToNumber(property_value);
	
	if (state.mafia_internal_step > 0)
		state.started = true;
	if (state.mafia_internal_step == INT32_MAX)
		state.finished = true;
	if (state.started && !state.finished)
		state.in_progress = true;
}

boolean QuestStateEquals(QuestState q1, QuestState q2)
{
	//not sure how to do record equality otherwise
	if (q1.quest_name != q2.quest_name)
		return false;
	if (q1.image_name != q2.image_name)
		return false;
	if (q1.startable != q2.startable)
		return false;
	if (q1.started != q2.started)
		return false;
	if (q1.in_progress != q2.in_progress)
		return false;
	if (q1.finished != q2.finished)
		return false;
	if (q1.mafia_internal_step != q2.mafia_internal_step)
		return false;
		
	if (q1.state_boolean != q2.state_boolean)
		return false;
	if (q1.state_string != q2.state_string)
		return false;
	if (q1.state_int != q2.state_int)
		return false;
	return true;
}

void QuestStateParseMafiaQuestProperty(QuestState state, string property_name, boolean allow_quest_log_load)
{
	state.QuestStateParseMafiaQuestPropertyValue(get_property(property_name));
}

void QuestStateParseMafiaQuestProperty(QuestState state, string property_name)
{
    QuestStateParseMafiaQuestProperty(state, property_name, true);
}

QuestState QuestState(string property_name)
{
	QuestState state;
    QuestStateParseMafiaQuestProperty(state, property_name);
    return state;
}

QuestState QuestStateFromManualStep(string manual_value)
{
    QuestState state;
    state.QuestStateParseMafiaQuestPropertyValue(manual_value);
    return state;
}


//Version compatibility locations:

boolean __location_compatibility_inited = false;
//Should probably be called manually, as a backup:
void locationCompatibilityInit()
{
    //Different versions refer to locations by different names.
    //For instance, pre-13878 versions refer to the palindome as "The Palindome". Versions after that refer it to "Inside the Palindome".
    //This method provides correct lookups for both versions, without warnings.
    if (__location_compatibility_inited)
        return;
    __location_compatibility_inited = true;
    
}

locationCompatibilityInit(); //not sure if calling functions like this is intended. may break in the future?

boolean [location] __la_location_is_available;
boolean [string] __la_zone_is_unlocked;

boolean __la_commons_were_inited = false;
int __la_turncount_initialised_on = -1;


//Takes into account banishes and olfactions.
//Probably will be inaccurate in many corner cases, sorry.
//There's an appearance_rates() function that takes into account queue effects, which we may consider using in the future?
float [monster] appearance_rates_adjusted(location l)
{
    boolean appearance_rates_has_changed = true; //not sure on the revision, but after a certain revision, appearance_rates() takes into account olfaction
    //FIXME domed city of ronald/grimacia doesn't take into account alien appearance rate
    float [monster] source = l.appearance_rates();
    //Bug in appearance_rates(): if you banish all three monsters, it says they are -3 rate. In realiy, they are equal. 
    
    if (l == $location[the sleazy back alley]) //FIXME is mafia's data files incorrect, or the wiki's?
        source[$monster[none]] = MIN(MAX(0, 20 - combat_rate_modifier()), 100);
    
    float minimum_monster_appearance = 1000000000.0;
    foreach m in source
    {
        if (m == $monster[none])
            continue;
        float v = source[m];
        if (v > 0.0)
        {
            if (v < minimum_monster_appearance)
                minimum_monster_appearance = v;
        }
    }
    
    float [monster] source_altered;
    foreach m in source
    {
        float v = source[m];
        if (m == $monster[none])
        {
            if (v < 0.0)
                source_altered[m] = 0.0;
            else
                source_altered[m] = v;
        }
        else
            source_altered[m] = v / minimum_monster_appearance;
    }
    
    boolean lawyers_relocated = get_property_ascension("relocatePygmyLawyer");
    boolean janitors_relocated = get_property_ascension("relocatePygmyJanitor");
    if (l == $location[the hidden park])
    {
        if (janitors_relocated)
            source_altered[$monster[pygmy janitor]] = 1.0;
        else if (source_altered contains $monster[pygmy janitor])
            remove source_altered[$monster[pygmy janitor]];
        if (lawyers_relocated)
            source_altered[$monster[pygmy witch lawyer]] = 1.0;
        else if (source_altered contains $monster[pygmy witch lawyer])
            remove source_altered[$monster[pygmy witch lawyer]];
    }
    if (($locations[The Hidden Apartment Building,The Hidden Bowling Alley,The Hidden Hospital,The Hidden Office Building] contains l))
    {
        if (janitors_relocated && (source_altered contains $monster[pygmy janitor]))
            remove source_altered[$monster[pygmy janitor]];
        if (lawyers_relocated && (source_altered contains $monster[pygmy witch lawyer]))
            remove source_altered[$monster[pygmy witch lawyer]];
    }
    if ($locations[domed city of grimacia,domed city of ronaldus] contains l)
    {
        boolean [monster] aliens;
        boolean [monster] survivors;
        float actual_percent_aliens = 0.0;
        
        
        if (l == $location[domed city of grimacia])
        {
            aliens = $monsters[cat-alien,dog-alien,alielf];
            survivors = $monsters[unhinged survivor,grizzled survivor,whiny survivor];
            int grimace_phase = moon_phase() / 2;
            if (grimace_phase == 4)
                actual_percent_aliens = 0.3;
            else if (grimace_phase < 2 || grimace_phase > 6)
                actual_percent_aliens = 0.0;
            else
                actual_percent_aliens = 0.15;
        }
        else
        {
            aliens = $monsters[dogcat,hamsterpus,ferrelf];
            survivors = $monsters[unlikely survivor,overarmed survivor,primitive survivor];
            int ronald_phase = moon_phase() % 8;
            if (ronald_phase == 4)
                actual_percent_aliens = 0.3;
            else if (ronald_phase < 2 || ronald_phase > 6)
                actual_percent_aliens = 0.0;
            else
                actual_percent_aliens = 0.15;
        }
        //Readjust:
        float source_percent_aliens = 0.0;
        float source_percent_survivors = 0.0;
        foreach m, rate in source_altered
        {
            if (aliens contains m)
            {
                if (actual_percent_aliens == 0.0)
                    remove source_altered[m];
                source_percent_aliens += rate;
            }
            if (survivors contains m)
                source_percent_survivors += rate;
        }
        //Readjust:
        
        foreach m, rate in source_altered
        {
            float adjusted_rate = rate;
            if (aliens contains m)
            {
                if (actual_percent_aliens == 0.0 || source_percent_aliens == 0.0)
                {
                    adjusted_rate = 0.0;
                }
                else
                {
                    adjusted_rate = rate / source_percent_aliens * actual_percent_aliens;
                }
            }
            if (survivors contains m)
            {
                if (source_percent_survivors == 0.0)
                    adjusted_rate = rate; //bugged, but don't change anything
                else
                    adjusted_rate = rate / source_percent_survivors * (1.0 - actual_percent_aliens);
            }
            source_altered[m] = adjusted_rate;
        }
        
    }
    if (l == $location[The Nemesis' Lair])
    {
        boolean [monster] all_monsters_to_remove = $monsters[hellseal guardian,Gorgolok\, the Infernal Seal (Inner Sanctum),warehouse worker,Stella\, the Turtle Poacher (Inner Sanctum),evil spaghetti cult zealot,Spaghetti Elemental (Inner Sanctum),security slime,Lumpy\, the Sinister Sauceblob (Inner Sanctum),daft punk,Spirit of New Wave (Inner Sanctum),mariachi bruiser,Somerset Lopez\, Dread Mariachi (Inner Sanctum)];
        
        boolean [monster] monsters_not_to_remove;
        if (my_class() == $class[seal clubber])
            monsters_not_to_remove = $monsters[hellseal guardian,Gorgolok\, the Infernal Seal (Inner Sanctum)];
        else if (my_class() == $class[turtle tamer])
            monsters_not_to_remove = $monsters[warehouse worker,Stella\, the Turtle Poacher (Inner Sanctum)];
        else if (my_class() == $class[pastamancer])
            monsters_not_to_remove = $monsters[evil spaghetti cult zealot,Spaghetti Elemental (Inner Sanctum)];
        else if (my_class() == $class[sauceror])
            monsters_not_to_remove = $monsters[security slime,Lumpy\, the Sinister Sauceblob (Inner Sanctum)];
        else if (my_class() == $class[disco bandit])
            monsters_not_to_remove = $monsters[daft punk,Spirit of New Wave (Inner Sanctum)];
        else if (my_class() == $class[accordion thief])
            monsters_not_to_remove = $monsters[mariachi bruiser,Somerset Lopez\, Dread Mariachi (Inner Sanctum)];
        foreach m in all_monsters_to_remove
        {
            if (monsters_not_to_remove contains m)
                continue;
            remove source_altered[m];
        }
    }
    
    boolean banishes_are_possible = true;
    if ($locations[the secret government laboratory,sloppy seconds diner] contains l)
        banishes_are_possible = false;
    if (banishes_are_possible)
    {
        foreach m in source_altered
        {
            if (m.is_banished())
                source_altered[m] = 0.0;
        }
    }
    
    //umm... I'm not sure if appearance_rates() takes into account olfact all the time or not
    //in the palindome, it didn't for some reason? but in another area I think it did. can't remember
    /*
    > get olfactedMonster
    bob racecar
    > ash $effect[on the trail].have_effect()
    Returned: 35
    > ash $location[inside the palindome].appearance_rates()
    Returned: aggregate float [monster]
    Bob Racecar => 9.0
    Dr. Awkward => 0.0
    Drab Bard => 9.0
    Evil Olive => -3.0
    Flock of Stab-Bats => 9.0
    none => 55.0
    Racecar Bob => 9.0
    Taco Cat => 9.0
    Tan Gnat => -3.0
    */
    //so, if appearance_rate() doesn't seem to be taking into account olfaction, force it?
    if ($effect[on the trail].have_effect() > 0 && get_property("olfactedMonster").to_monster() != $monster[none])
    {
        monster olfacted_monster = get_property("olfactedMonster").to_monster();
        if (source_altered contains olfacted_monster)
        {
            if (fabs(source_altered[olfacted_monster] - 1.0) < 0.01)
                appearance_rates_has_changed = false;
        }
    }
    
    if ($effect[on the trail].have_effect() > 0 && !appearance_rates_has_changed)
    {
        monster olfacted_monster = get_property("olfactedMonster").to_monster();
        if (olfacted_monster != $monster[none])
        {
            if (source_altered contains olfacted_monster)
                source_altered[olfacted_monster] += 3.0; //FIXME is this correct?
        }
    }
    
    
    //Convert source_altered to source.
    if (l == $location[Inside the Palindome])
    {
        if (!questPropertyPastInternalStepNumber("questL11Palindome", 3))
            source_altered[$monster[none]] = 0.0;
    }
    
    float total = 0.0;
    float nc_rate = clampf(source_altered[$monster[none]], 0.0, 100.0);
    float combat_rate = clampf(100.0 - nc_rate, 0.0, 100.0);
    foreach m in source_altered
    {
        float v = source_altered[m];
        if (m == $monster[none])
            continue;
        if (v > 0)
            total += v;
    }
    if ($locations[Guano Junction,the Batrat and Ratbat Burrow,the Beanbat Chamber] contains l)
    {
        //hacky, probably wrong:
        float v = total / 8.0;
        source_altered[$monster[screambat]] = v;
        total += v;
    }
    //oil peak goes here?
    if (total > 0.0)
    {
        foreach m in source_altered
        {
            if (m == $monster[none])
                continue;
            float v = source_altered[m];
            source_altered[m] = v / total * combat_rate;
        }
    }
    
    return source_altered;
}


float [monster] appearance_rates_adjusted_cancel_nc(location l)
{
    float [monster] base_rates = appearance_rates_adjusted(l);
    float nc_rate = base_rates[$monster[none]] / 100.0;
    float nc_inverse_multiplier = 1.0;
    if (nc_rate != 1.0)
        nc_inverse_multiplier = 1.0 / (1.0 - nc_rate);
    foreach m in base_rates
    {
        if (m == $monster[none])
            base_rates[m] = 0.0;
        else
            base_rates[m] *= nc_inverse_multiplier;
    }
    return base_rates;
}


//Do not call - internal implementation detail.
boolean locationAvailablePrivateCheck(location loc, Error able_to_find)
{
	string zone = loc.zone;
	
	if (zone == "KOL High School")
	{
		if (my_path_id() == PATH_KOLHS)
			return true;
		return false;
	}
	if (zone == "Mothership")
	{
		if (my_path_id() == PATH_BUGBEAR_INVASION)
			return true;
		return false;
	}
	if (zone == "BadMoon")
	{
		if (in_bad_moon())
			return true;
		return false;
	}
    if ($strings[Crimbo05,Crimbo14,Crimbo15,Crimbo16] contains zone)
        return false;
    if (zone == "Woods" && !__la_zone_is_unlocked["Woods"])
        return false;
    if (loc.parentdesc == "Batfellow Area")
        return limit_mode() == "batman";
    if (zone == "Spelunky Area")
        return limit_mode() == "spelunky";
    if (zone == "Twitch")
        return get_property_boolean("timeTowerAvailable");
    if (zone == "The Prince's Ball")
        return get_property("grimstoneMaskPath").to_lower_case() == "stepmother" && get_property_int("cinderellaMinutesToMidnight") > 0;
    
    if (loc == $location[hippy camp])
    {
    	//FIXME we don't know who won the war, do we? so only give information if the war hasn't started 
    	if (get_property_ascension("lastIslandUnlock"))
        {
            if (!QuestState("questL12War").started) return true;
        }
        else
        	return false;
    }
	
	switch (loc)
	{
		case $location[The Castle in the Clouds in the Sky (Ground floor)]:
			return get_property_ascension("lastCastleGroundUnlock");
		case $location[The Castle in the Clouds in the Sky (Top floor)]:
			return get_property_ascension("lastCastleTopUnlock");
		case $location[The Haunted Kitchen]:
		case $location[The Haunted Conservatory]:
            return questPropertyPastInternalStepNumber("questM20Necklace", 1);
		case $location[The Haunted Billiards Room]:
            if ($item[7301].available_amount() > 0)
                return true;
            else
                return false;
			//return get_property_ascension("lastManorUnlock");
		case $location[The Haunted Bedroom]:
		case $location[The Haunted Bathroom]:
        case $location[the haunted gallery]:
			return get_property_ascension("lastSecondFloorUnlock") && QuestState("questM21Dance").mafia_internal_step >= 2;
        case $location[the haunted ballroom]:
            return questPropertyPastInternalStepNumber("questM21Dance", 4);
        case $location[The Haunted Laboratory]:
        case $location[The Haunted Nursery]:
        case $location[The Haunted Storage Room]:
            return questPropertyPastInternalStepNumber("questM17Babies", 1);
        case $location[The Haunted Boiler Room]:
        case $location[The Haunted Laundry Room]:
        case $location[The Haunted Wine Cellar]:
            return questPropertyPastInternalStepNumber("questL11Manor", 2);
        case $location[summoning chamber]:
            return get_property("questL11Manor") == "finished";
        case $location[the batrat and ratbat burrow]:
            return questPropertyPastInternalStepNumber("questL04Bat", 2);
        case $location[the beanbat chamber]:
            return questPropertyPastInternalStepNumber("questL04Bat", 3);
        case $location[The Unquiet Garves]:
            return true;
        case $location[The VERY Unquiet Garves]:
            return get_property("questL07Cyrptic") == "finished";
        case $location[The Wreck of the Edgar Fitzsimmons]:
            return questPropertyPastInternalStepNumber("questS02Monkees", 2);
        case $location[the boss bat's lair]:
        	if (get_property("questL04Bat") == "finished") return false; //area closes
            if ($location[the boss bat's lair].combatTurnsAttemptedInLocation() > 0)
                return true;
            return questPropertyPastInternalStepNumber("questL04Bat", 4);
		case $location[cobb's knob barracks]:
		case $location[cobb's knob kitchens]:
		case $location[cobb's knob harem]:
		case $location[cobb's knob treasury]:
			string quest_value = get_property("questL05Goblin");
			if (quest_value == "finished")
				return true;
			else if (questPropertyPastInternalStepNumber("questL05Goblin", 1))
			{
				//Inference - quest is started. If map is missing, area must be unlocked
				if ($item[cobb's knob map].available_amount() > 0)
					return false;
				else //no map, must be available
					return true;
			}
			//unstarted, impossible
            return false;
		case $location[Vanya's Castle Chapel]:
			if ($item[map to Vanya's Castle].available_amount() > 0)
				return true;
			return false;
		case $location[lair of the ninja snowmen]:
		case $location[the extreme slope]:
			return questPropertyPastInternalStepNumber("questL08Trapper", 3);
		case $location[the hidden park]:
			return questPropertyPastInternalStepNumber("questL11Worship", 4);
        case $location[the hidden temple]:
            return get_property_ascension("lastTempleUnlock");
		case $location[the spooky forest]:
			return __la_zone_is_unlocked["Woods"];
		case $location[The Smut Orc Logging Camp]:
			return questPropertyPastInternalStepNumber("questL09Topping", 1);
		case $location[the black forest]:
			return questPropertyPastInternalStepNumber("questL11MacGuffin", 1);
		case $location[guano junction]:
		case $location[the bat hole entrance]:
			return questPropertyPastInternalStepNumber("questL04Bat", 1);
		case $location[itznotyerzitz mine]:
			return questPropertyPastInternalStepNumber("questL08Trapper", 2);
        case $location[the arid, extra-dry desert]:
			return (questPropertyPastInternalStepNumber("questL11MacGuffin", 3) || $item[your father's MacGuffin diary].available_amount() > 0);
        case $location[the oasis]:
			return (get_property_int("desertExploration") > 0) && (questPropertyPastInternalStepNumber("questL11MacGuffin", 3) || $item[your father's MacGuffin diary].available_amount() > 0);
        case $location[the defiled alcove]:
			return questPropertyPastInternalStepNumber("questL07Cyrptic", 1) && get_property_int("cyrptAlcoveEvilness") > 0;
        case $location[the defiled cranny]:
			return questPropertyPastInternalStepNumber("questL07Cyrptic", 1) && get_property_int("cyrptCrannyEvilness") > 0;
        case $location[the defiled niche]:
			return questPropertyPastInternalStepNumber("questL07Cyrptic", 1) && get_property_int("cyrptNicheEvilness") > 0;
        case $location[the defiled nook]:
			return questPropertyPastInternalStepNumber("questL07Cyrptic", 1) && get_property_int("cyrptNookEvilness") > 0;
		case $location[south of the border]:
        case $location[The Shore\, Inc. Travel Agency]:
			return get_property_ascension("lastDesertUnlock");
        case $location[Portal to Terrible Parents]:
        case $location[Rumpelstiltskin's Workshop]:
        case $location[Ye Olde Medievale Villagee]:
            return (get_property("grimstoneMaskPath") == "gnome");
        case $location[the mansion of dr. weirdeaux]:
        case $location[the secret government laboratory]:
        case $location[the deep dark jungle]:
            return $item[airplane charter: Conspiracy Island].is_unrestricted() && (get_property_boolean("_spookyAirportToday") || get_property_boolean("spookyAirportAlways"));
        case $location[the fun-guy mansion]:
        case $location[sloppy seconds diner]:
        case $location[the sunken party yacht]:
            return $item[airplane charter: Spring Break Beach].is_unrestricted() && (get_property_boolean("_sleazeAirportToday") || get_property_boolean("sleazeAirportAlways"));
        case $location[Pirates of the Garbage Barges]:
        case $location[Barf Mountain]:
        case $location[The Toxic Teacups]:
        case $location[Uncle Gator's Country Fun-Time Liquid Waste Sluice]:
            return $item[airplane charter: Dinseylandfill].is_unrestricted() && (get_property_boolean("_stenchAirportToday") || get_property_boolean("stenchAirportAlways"));
        case $location[The SMOOCH Army HQ]:
        case $location[The Velvet / Gold Mine]:
        case $location[LavaCo&trade; Lamp Factory]:
        case $location[The Bubblin' Caldera]:
            return $item[airplane charter: That 70s Volcano].is_unrestricted() && (get_property_boolean("_hotAirportToday") || get_property_boolean("hotAirportAlways"));
        case $location[The Ice Hotel]:
        case $location[VYKEA]:
        case $location[The Ice Hole]:
            return $item[airplane charter: The Glaciest].is_unrestricted() && (get_property_boolean("_coldAirportToday") || get_property_boolean("coldAirportAlways"));
        case $location[Kokomo Resort]:
            return $effect[Tropical Contact High].have_effect() > 0;
        case $location[Dreadsylvanian Woods]:
        case $location[Dreadsylvanian Village]:
        case $location[Dreadsylvanian Castle]:
            //FIXME not correct - does not take account whether the dungeon is open and the areas are unlocked
            return get_clan_id() > 0 && my_level() >= 15;
        case $location[A Barroom Brawl]:
            return questPropertyPastInternalStepNumber("questL03Rat", 1);
        case $location[The Laugh Floor]:
        case $location[Pandamonium Slums]:
        case $location[Infernal Rackets Backstage]:
            return get_property("questL06Friar") == "finished";
        case $location[The Degrassi Knoll Restroom]:
        case $location[The Degrassi Knoll Bakery]:
        case $location[The Degrassi Knoll Gym]:
        case $location[The Degrassi Knoll Garage]:
            return !knoll_available();
        case $location[Thugnderdome]:
            return gnomads_available() && my_basestat(my_primestat()) >= 25;
        case $location[outskirts of camp logging camp]:
        case $location[camp logging camp]:
            return canadia_available();
        ///FIXME test grimstone masks against their progress?
        case $location[Sweet-Ade Lake]:
        case $location[Eager Rice Burrows]:
        case $location[Gumdrop Forest]:
            return get_property("grimstoneMaskPath") == "witch";
        case $location[The Inner Wolf Gym]:
        case $location[Unleash Your Inner Wolf]:
            return get_property("grimstoneMaskPath") == "wolf";
        case $location[A Deserted Stretch of I-911]:
            return get_property("grimstoneMaskPath") == "hare";
        case $location[A-Boo Peak]:
        case $location[Twin Peak]:
        case $location[Oil Peak]:
            return questPropertyPastInternalStepNumber("questL09Topping", 2);
        case $location[The Icy Peak]:
            return get_property("questL08Trapper") == "finished"; //FIXME is it finished, or after defeating groar?
        case $location[the bugbear pen]:
            return knoll_available() && questPropertyPastInternalStepNumber("questM03Bugbear", 1) && get_property("questM03Bugbear") != "finished";
        case $location[post-quest bugbear pens]:
            return knoll_available() && get_property("questM03Bugbear") == "finished";
        case $location[the thinknerd warehouse]:
            return questPropertyPastInternalStepNumber("questM22Shirt", 1);
        case $location[The Overgrown Lot]:
            return questPropertyPastInternalStepNumber("questM24Doc", 1);
        case $location[The Skeleton Store]:
            if (questPropertyPastInternalStepNumber("questM23Meatsmith", 1))
                return true;
            //otherwise, don't know
            break;
        case $location[the old landfill]:
            return questPropertyPastInternalStepNumber("questM19Hippy", 1);
        case $location[The Hidden Apartment Building]:
            return get_property_int("hiddenApartmentProgress") >= 1;
        case $location[The Hidden Bowling Alley]:
            return get_property_int("hiddenBowlingAlleyProgress") >= 1;
        case $location[The Hidden Hospital]:
            return get_property_int("hiddenHospitalProgress") >= 1;
        case $location[The Hidden Office Building]:
            return get_property_int("hiddenOfficeProgress") >= 1;
        case $location[The Enormous Greater-Than Sign]:
            return my_basestat(my_primestat()) >= 45 && !get_property_ascension("lastPlusSignUnlock");
        case $location[The dungeons of doom]:
            return my_basestat(my_primestat()) >= 45 && get_property_ascension("lastPlusSignUnlock");
        case $location[The "Fun" House]:
            return questPropertyPastInternalStepNumber("questG04Nemesis", 6); //FIXME 6 is wrong, but I don't know the right value
        case $location[The Dark Neck of the Woods]:
        case $location[The Dark Heart of the Woods]:
        case $location[The Dark Elbow of the Woods]:
            return QuestState("questL06Friar").in_progress;
        case $location[The Goatlet]:
            return questPropertyPastInternalStepNumber("questL08Trapper", 1);
        case $location[The Penultimate Fantasy Airship]:
            return questPropertyPastInternalStepNumber("questL10Garbage", 2);
        case $location[anger man's level]:
        case $location[fear man's level]:
        case $location[doubt man's level]:
        case $location[regret man's level]:
            return get_campground()[$item[jar of psychoses (The Crackpot Mystic)]] > 0;
        case $location[the gourd!]:
            return get_campground()[$item[jar of psychoses (The Captain of the Gourd)]] > 0;
        case $location[The Nightmare Meatrealm]:
            return get_campground()[$item[jar of psychoses (The Meatsmith)]] > 0;
        case $location[A Kitchen Drawer]:
        case $location[A Grocery Bag]:
            return get_campground()[$item[jar of psychoses (The Pretentious Artist)]] > 0;
        case $location[Chinatown Shops]: //needs tracking for the quest? maybe use the items?
            return get_campground()[$item[jar of psychoses (The Suspicious-Looking Guy)]] > 0 && $item[strange goggles].available_amount() == 0;
        case $location[Triad Factory]:
            return $item[zaibatsu lobby card].available_amount() > 0 && $item[strange goggles].available_amount() == 0 && get_campground()[$item[jar of psychoses (The Suspicious-Looking Guy)]] > 0;
        //case $location[1st Floor, Shiawase-Mitsuhama Building]:
        //case $location[2nd Floor, Shiawase-Mitsuhama Building]:
        //case $location[3rd Floor, Shiawase-Mitsuhama Building]:
        case $location[Chinatown Tenement]:
            return $item[test site key].available_amount() > 0 && get_campground()[$item[jar of psychoses (The Suspicious-Looking Guy)]] > 0;
        case $location[whitey's grove]:
            return questPropertyPastInternalStepNumber("questG02Whitecastle", 1) || questPropertyPastInternalStepNumber("questL11Palindome", 4); //FIXME what step for questL11Palindome?
        case $location[the Obligatory pirate's cove]:
            return get_property_ascension("lastIslandUnlock") && !(QuestState("questL12War").mafia_internal_step >= 2 && !QuestState("questL12War").finished);
        case $location[Inside the Palindome]:
            return $item[talisman o' namsilat].equipped_amount() > 0; //technically
        case $location[The Valley of Rof L'm Fao]:
            return QuestState("questL09Topping").finished;
        case $location[Swamp Beaver Territory]:
            return get_property_boolean("maraisBeaverUnlock");
        case $location[The Corpse Bog]:
            return get_property_boolean("maraisCorpseUnlock");
        case $location[The Dark and Spooky Swamp]:
            return get_property_boolean("maraisDarkUnlock");
        case $location[The Weird Swamp Village]:
            return get_property_boolean("maraisVillageUnlock");
        case $location[The Wildlife Sanctuarrrrrgh]:
            return get_property_boolean("maraisWildlifeUnlock");
        case $location[The Ruined Wizard Tower]:
            return get_property_boolean("maraisWizardUnlock");
        case $location[The Edge of the Swamp]:
            return QuestState("questM18Swamp").started;
        case $location[madness bakery]:
            return QuestState("questM25Armorer").started;
        case $location[sonofa beach]:
            return QuestState("questL12War").mafia_internal_step >= 2;
        case $location[the spooky gravy burrow]:
        	return QuestState("questM03Bugbear").mafia_internal_step >= 3;
        case $location[The Copperhead Club]:
            return QuestState("questL11MacGuffin").mafia_internal_step >= 3; //FIXME no idea, diary?
        case $location[A mob of zeppelin protesters]:
            return QuestState("questL11MacGuffin").mafia_internal_step >= 3; //FIXME no idea, diary?
        case $location[The Red Zeppelin]:
            return QuestState("questL11MacGuffin").mafia_internal_step >= 3 && get_property_int("zeppelinProtestors") >= 80; //FIXME not quite right, diary?; also NC needs to be visited first
		default:
			break;
	}
    //if (loc.turnsAttemptedInLocation() > 0) //FIXME make this finer-grained, this is hacky
        //return true;
	
	ErrorSet(able_to_find, "");
	return false;
}

void locationAvailablePrivateInit()
{
	if (__la_commons_were_inited && __la_turncount_initialised_on == my_turncount())
		return;
        
    if (__la_location_is_available.count() > 0)
    {
        foreach key in __la_location_is_available
        {
            remove __la_location_is_available[key];
        }
    }
    if (__la_zone_is_unlocked.count() > 0)
    {
        foreach key in __la_zone_is_unlocked
        {
            remove __la_zone_is_unlocked[key];
        }
    }
	
	boolean [location] locations_always_available = $locations[the haunted pantry,the sleazy back alley,the outskirts of cobb's knob,the limerick dungeon,The Haiku Dungeon,The Daily Dungeon,noob cave,the dire warren];
	foreach loc in locations_always_available
	{
		if (loc == $location[none])
			continue;
		__la_location_is_available[loc] = true;
	}
    
    if (questPropertyPastInternalStepNumber("questL02Larva", 1) || questPropertyPastInternalStepNumber("questG02Whitecastle", 1))
        __la_zone_is_unlocked["Woods"] = true;
		
	string zones_never_accessible_string = "Gyms,Crimbo06,Crimbo07,Crimbo08,Crimbo09,Crimbo10,The Candy Diorama,Crimbo12,WhiteWed";
	
	item [location] locations_unlocked_by_item;
	effect [location] locations_unlocked_by_effect;
	
	item [string] zones_unlocked_by_item;
	effect [string] zones_unlocked_by_effect;
	
	locations_unlocked_by_item[$location[Cobb's Knob Laboratory]] = $item[Cobb's Knob lab key];
	locations_unlocked_by_item[$location[The Knob Shaft]] = $item[Cobb's Knob lab key];
	locations_unlocked_by_item[$location[Cobb's Knob Menagerie\, Level 1]] = $item[Cobb's Knob Menagerie key];
	locations_unlocked_by_item[$location[Cobb's Knob Menagerie\, Level 2]] = $item[Cobb's Knob Menagerie key];
	locations_unlocked_by_item[$location[Cobb's Knob Menagerie\, Level 3]] = $item[Cobb's Knob Menagerie key];
	
	//locations_unlocked_by_item[$location[the haunted ballroom]] = $item[spookyraven ballroom key];
	locations_unlocked_by_item[$location[The Haunted Library]] = $item[7302]; //library key
	//locations_unlocked_by_item[$location[The Haunted Gallery]] = $item[spookyraven gallery key];
	locations_unlocked_by_item[$location[The Castle in the Clouds in the Sky (Basement)]] = $item[S.O.C.K.];
	locations_unlocked_by_item[$location[the hole in the sky]] = $item[steam-powered model rocketship];
    if (my_path_id() == PATH_EXPLOSION)
    {
        locations_unlocked_by_item[$location[The Castle in the Clouds in the Sky (Basement)]] = $item[none];
        locations_unlocked_by_item[$location[the hole in the sky]] = $item[none];
    }
	
	locations_unlocked_by_item[$location[Vanya's Castle Foyer]] = $item[map to Vanya's Castle];
	
	
	zones_unlocked_by_item["Magic Commune"] = $item[map to the Magic Commune];
	zones_unlocked_by_item["Landscaper"] = $item[Map to The Landscaper's Lair];
	zones_unlocked_by_item["Kegger"] = $item[map to the Kegger in the Woods];
	zones_unlocked_by_item["Ellsbury's Claim"] = $item[Map to Ellsbury's Claim];
	zones_unlocked_by_item["Memories"] = $item[empty agua de vida bottle];
	zones_unlocked_by_item["Casino"] = $item[casino pass];
	
	zones_unlocked_by_effect["Astral"] = $effect[Half-Astral];
	zones_unlocked_by_effect["Spaaace"] = $effect[Transpondent];
	zones_unlocked_by_effect["RabbitHole"] = $effect[Down the Rabbit Hole];
	zones_unlocked_by_effect["Wormwood"] = $effect[Absinthe-Minded];	
	zones_unlocked_by_effect["Suburbs"] = $effect[Dis Abled];
	
	string [int] zones_never_accessible = split_string_alternate(zones_never_accessible_string, ",");
	
	boolean [string] zone_accessibility_status = zones_never_accessible.listInvert();
    foreach s in zone_accessibility_status //invert
    {
        zone_accessibility_status[s] = false;
    }
	
	
	foreach loc in $locations[Shivering Timbers,A Skeleton Invasion!,The Cannon Museum,A Swarm of Yeti-Mounted Skeletons,The Bonewall,A Massive Flying Battleship,A Supply Train,The Bone Star,Grim Grimacite Site,A Pile of Old Servers,The Haunted Sorority House,Fightin' Fire,Super-Intense Mega-Grassfire,Fierce Flying Flames,Lord Flameface's Castle Entryway,Lord Flameface's Castle Belfry,Lord Flameface's Throne Room,A Stinking Abyssal Portal,A Scorching Abyssal Portal,A Terrifying Abyssal Portal,A Freezing Abyssal Portal,An Unsettling Abyssal Portal,A Yawning Abyssal Portal,The Space Odyssey Discotheque,The Spirit World,The Crimbonium Mining Camp,WarBear Fortress (First Level),WarBear Fortress (Second Level),WarBear Fortress (Third Level)]
	{
		__la_location_is_available[loc] = false;
	}
	
	foreach loc in locations_unlocked_by_item
	{
		if (locations_unlocked_by_item[loc].available_amount() > 0 || locations_unlocked_by_item[loc] == $item[none])
			__la_location_is_available[loc] = true;
		else
			__la_location_is_available[loc] = false;
	}
	foreach loc in locations_unlocked_by_effect
	{
		if (locations_unlocked_by_effect[loc].have_effect() > 0)
			__la_location_is_available[loc] = true;
		else
			__la_location_is_available[loc] = false;
	}
	
	foreach zone in zones_unlocked_by_item
	{
		if (zones_unlocked_by_item[zone].available_amount() > 0)
			zone_accessibility_status[zone] = true;
		else
			zone_accessibility_status[zone] = false;
	}
	foreach zone in zones_unlocked_by_effect
	{
		if (zones_unlocked_by_effect[zone].have_effect() > 0)
			zone_accessibility_status[zone] = true;
		else
			zone_accessibility_status[zone] = false;
	}
	
	
	
	
	foreach loc in $locations[]
	{
		if (zone_accessibility_status contains (loc.zone))
			__la_location_is_available[loc] = zone_accessibility_status[loc.zone];
	}
		
		
	__la_commons_were_inited = true;
    __la_turncount_initialised_on = my_turncount();
}

boolean locationAvailable(location loc, Error able_to_find)
{
    locationAvailablePrivateInit();
	if ((__la_location_is_available contains loc))
		return __la_location_is_available[loc];
	
	boolean [int] could_find;
	boolean is_available = locationAvailablePrivateCheck(loc, able_to_find);
	if (able_to_find.was_error)
		return false;
	__la_location_is_available[loc] = is_available;
	
	return is_available;
}

boolean locationAvailable(location loc)
{
	return locationAvailable(loc, ErrorMake());
}

void locationAvailableResetCache()
{
    __la_commons_were_inited = false;
}



string [location] LAConvertLocationLookupToLocations(string [string] lookup_map)
{
    string [location] result;
    foreach location_name in lookup_map
    {
        location l = location_name.to_location();
        if (l == $location[none])
        {
            if (__setting_debug_mode)
                print_html("Location \"" + location_name + "\" does not appear to exist anymore.");
            continue;
        }
        result[l] = lookup_map[location_name];
    }
    
    return result;
}
static
{
    string [location] __constant_clickable_urls;
    void initialiseConstantClickableURLs()
    {
        string [string] lookup_map;
        
        lookup_map["Pump Up Muscle"] = "place.php?whichplace=knoll_friendly&action=dk_gym";
        lookup_map["Richard's Hobo Mysticality"] = "clan_hobopolis.php?place=3";
        lookup_map["Richard's Hobo Moxie"] = "clan_hobopolis.php?place=3";
        lookup_map["Richard's Hobo Muscle"] = "clan_hobopolis.php?place=3";
        lookup_map["South of the Border"] = "place.php?whichplace=desertbeach";
        lookup_map["The Oasis"] = "place.php?whichplace=desertbeach";
        lookup_map["The Arid, Extra-Dry Desert"] = "place.php?whichplace=desertbeach";
        lookup_map["The Shore, Inc. Travel Agency"] = "place.php?whichplace=desertbeach";
        lookup_map["The Upper Chamber"] = "pyramid.php";
        lookup_map["The Middle Chamber"] = "pyramid.php";
        lookup_map["The Lower Chambers"] = "pyramid.php";
        lookup_map["Goat Party"] = "casino.php";
        lookup_map["Pirate Party"] = "casino.php";
        lookup_map["Lemon Party"] = "casino.php";
        lookup_map["The Roulette Tables"] = "casino.php";
        lookup_map["The Poker Room"] = "casino.php";
        lookup_map["The Haiku Dungeon"] = "da.php";
        lookup_map["The Limerick Dungeon"] = "da.php";
        lookup_map["The Enormous Greater-Than Sign"] = "da.php";
        lookup_map["The Dungeons of Doom"] = "da.php";
        lookup_map["The Daily Dungeon"] = "da.php";
        lookup_map["Video Game Level 1"] = "place.php?whichplace=faqdungeon";
        lookup_map["Video Game Level 2"] = "place.php?whichplace=faqdungeon";
        lookup_map["Video Game Level 3"] = "place.php?whichplace=faqdungeon";
        lookup_map["A Maze of Sewer Tunnels"] = "clan_hobopolis.php";
        lookup_map["Hobopolis Town Square"] = "clan_hobopolis.php?place=2";
        lookup_map["Burnbarrel Blvd."] = "clan_hobopolis.php?place=4";
        lookup_map["Exposure Esplanade"] = "clan_hobopolis.php?place=5";
        lookup_map["The Heap"] = "clan_hobopolis.php?place=6";
        lookup_map["The Ancient Hobo Burial Ground"] = "clan_hobopolis.php?place=7";
        lookup_map["The Purple Light District"] = "clan_hobopolis.php?place=8";
        lookup_map["The Slime Tube"] = "clan_slimetube.php";
        lookup_map["Dreadsylvanian Woods"] = "clan_dreadsylvania.php";
        lookup_map["Dreadsylvanian Village"] = "clan_dreadsylvania.php";
        lookup_map["Dreadsylvanian Castle"] = "clan_dreadsylvania.php";
        lookup_map["The Briny Deeps"] = "place.php?whichplace=thesea";
        lookup_map["The Brinier Deepers"] = "place.php?whichplace=thesea";
        lookup_map["The Briniest Deepests"] = "place.php?whichplace=thesea";
        lookup_map["An Octopus's Garden"] = "seafloor.php";
        lookup_map["The Wreck of the Edgar Fitzsimmons"] = "seafloor.php";
        lookup_map["Madness Reef"] = "seafloor.php";
        lookup_map["The Mer-Kin Outpost"] = "seafloor.php";
        lookup_map["The Skate Park"] = "seafloor.php";
        lookup_map["The Marinara Trench"] = "seafloor.php";
        lookup_map["Anemone Mine"] = "seafloor.php";
        lookup_map["The Dive Bar"] = "seafloor.php";
        lookup_map["The Coral Corral"] = "seafloor.php";
        lookup_map["Mer-kin Elementary School"] = "sea_merkin.php?seahorse=1";
        lookup_map["Mer-kin Library"] = "sea_merkin.php?seahorse=1";
        lookup_map["Mer-kin Gymnasium"] = "sea_merkin.php?seahorse=1";
        lookup_map["Mer-kin Colosseum"] = "sea_merkin.php?seahorse=1";
        lookup_map["The Caliginous Abyss"] = "seafloor.php";
        lookup_map["Anemone Mine (Mining)"] = "seafloor.php";
        lookup_map["The Sleazy Back Alley"] = "place.php?whichplace=town_wrong";
        lookup_map["The Copperhead Club"] = "place.php?whichplace=town_wrong";
        lookup_map["The Haunted Kitchen"] = "place.php?whichplace=manor1";
        lookup_map["The Haunted Conservatory"] = "place.php?whichplace=manor1";
        lookup_map["The Haunted Library"] = "place.php?whichplace=manor1";
        lookup_map["The Haunted Billiards Room"] = "place.php?whichplace=manor1";
        lookup_map["The Haunted Pantry"] = "place.php?whichplace=manor1";
        lookup_map["The Haunted Gallery"] = "place.php?whichplace=manor2";
        lookup_map["The Haunted Bathroom"] = "place.php?whichplace=manor2";
        lookup_map["The Haunted Bedroom"] = "place.php?whichplace=manor2";
        lookup_map["The Haunted Ballroom"] = "place.php?whichplace=manor2";
        lookup_map["The Haunted Boiler Room"] = "place.php?whichplace=manor4";
        lookup_map["The Haunted Laundry Room"] = "place.php?whichplace=manor4";
        lookup_map["The Haunted Wine Cellar"] = "place.php?whichplace=manor4";
        lookup_map["The Haunted Laboratory"] = "place.php?whichplace=manor3";
        lookup_map["The Haunted Nursery"] = "place.php?whichplace=manor3";
        lookup_map["The Haunted Storage Room"] = "place.php?whichplace=manor3";
        lookup_map["Summoning Chamber"] = "place.php?whichplace=manor4";
        lookup_map["The Hidden Apartment Building"] = "place.php?whichplace=hiddencity";
        lookup_map["The Hidden Hospital"] = "place.php?whichplace=hiddencity";
        lookup_map["The Hidden Office Building"] = "place.php?whichplace=hiddencity";
        lookup_map["The Hidden Bowling Alley"] = "place.php?whichplace=hiddencity";
        lookup_map["The Hidden Park"] = "place.php?whichplace=hiddencity";
        lookup_map["An Overgrown Shrine (Northwest)"] = "place.php?whichplace=hiddencity";
        lookup_map["An Overgrown Shrine (Southwest)"] = "place.php?whichplace=hiddencity";
        lookup_map["An Overgrown Shrine (Northeast)"] = "place.php?whichplace=hiddencity";
        lookup_map["An Overgrown Shrine (Southeast)"] = "place.php?whichplace=hiddencity";
        lookup_map["A Massive Ziggurat"] = "place.php?whichplace=hiddencity";
        lookup_map["The Typical Tavern Cellar"] = "cellar.php";
        lookup_map["The Spooky Forest"] = "place.php?whichplace=woods";
        lookup_map["The Hidden Temple"] = "place.php?whichplace=woods";
        lookup_map["A Barroom Brawl"] = "tavern.php";
        lookup_map["8-Bit Realm"] = "place.php?whichplace=woods";
        lookup_map["Whitey's Grove"] = "place.php?whichplace=woods";
        lookup_map["The Road to the White Citadel"] = "place.php?whichplace=woods";
        lookup_map["The Black Forest"] = "place.php?whichplace=woods";
        lookup_map["The Old Landfill"] = "place.php?whichplace=woods";
        lookup_map["The Bat Hole Entrance"] = "place.php?whichplace=bathole";
        lookup_map["Guano Junction"] = "place.php?whichplace=bathole";
        lookup_map["The Batrat and Ratbat Burrow"] = "place.php?whichplace=bathole";
        lookup_map["The Beanbat Chamber"] = "place.php?whichplace=bathole";
        lookup_map["The Boss Bat's Lair"] = "place.php?whichplace=bathole";
        lookup_map["The Red Queen's Garden"] = "place.php?whichplace=rabbithole";
        lookup_map["The Clumsiness Grove"] = "suburbandis.php";
        lookup_map["The Maelstrom of Lovers"] = "suburbandis.php";
        lookup_map["The Glacier of Jerks"] = "suburbandis.php";
        lookup_map["The Degrassi Knoll Restroom"] = "place.php?whichplace=knoll_hostile";
        lookup_map["The Degrassi Knoll Bakery"] = "place.php?whichplace=knoll_hostile";
        lookup_map["The Degrassi Knoll Gym"] = "place.php?whichplace=knoll_hostile";
        lookup_map["The Degrassi Knoll Garage"] = "place.php?whichplace=knoll_hostile";
        lookup_map["The \"Fun\" House"] = "place.php?whichplace=plains";
        lookup_map["The Unquiet Garves"] = "place.php?whichplace=cemetery";
        lookup_map["The VERY Unquiet Garves"] = "place.php?whichplace=cemetery";
        lookup_map["Tower Ruins"] = "fernruin.php";
        lookup_map["Fernswarthy's Basement"] = "basement.php";
        lookup_map["Cobb's Knob Barracks"] = "cobbsknob.php";
        lookup_map["Cobb's Knob Kitchens"] = "cobbsknob.php";
        lookup_map["Cobb's Knob Harem"] = "cobbsknob.php";
        lookup_map["Cobb's Knob Treasury"] = "cobbsknob.php";
        lookup_map["Throne Room"] = "cobbsknob.php";
        lookup_map["Cobb's Knob Laboratory"] = "cobbsknob.php?action=tolabs";
        lookup_map["The Knob Shaft"] = "cobbsknob.php?action=tolabs";
        lookup_map["The Knob Shaft (Mining)"] = "cobbsknob.php?action=tolabs";
        lookup_map["Cobb's Knob Menagerie, Level 1"] = "cobbsknob.php?action=tomenagerie";
        lookup_map["Cobb's Knob Menagerie, Level 2"] = "cobbsknob.php?action=tomenagerie";
        lookup_map["Cobb's Knob Menagerie, Level 3"] = "cobbsknob.php?action=tomenagerie";
        lookup_map["The Dark Neck of the Woods"] = "friars.php";
        lookup_map["The Dark Heart of the Woods"] = "friars.php";
        lookup_map["The Dark Elbow of the Woods"] = "friars.php";
        lookup_map["Friar Ceremony Location"] = "friars.php";
        lookup_map["Pandamonium Slums"] = "pandamonium.php";
        lookup_map["The Laugh Floor"] = "pandamonium.php?action=beli";
        lookup_map["Infernal Rackets Backstage"] = "pandamonium.php?action=infe";
        lookup_map["The Defiled Nook"] = "crypt.php";
        lookup_map["The Defiled Cranny"] = "crypt.php";
        lookup_map["The Defiled Alcove"] = "crypt.php";
        lookup_map["The Defiled Niche"] = "crypt.php";
        lookup_map["Haert of the Cyrpt"] = "crypt.php";
        lookup_map["Frat House"] = "island.php";
        lookup_map["Frat House In Disguise"] = "island.php";
        lookup_map["The Frat House (Bombed Back to the Stone Age)"] = "island.php";
        lookup_map["Hippy Camp"] = "island.php";
        lookup_map["Hippy Camp In Disguise"] = "island.php";
        lookup_map["The Hippy Camp (Bombed Back to the Stone Age)"] = "island.php";
        lookup_map["The Obligatory Pirate's Cove"] = "island.php";
        lookup_map["Barrrney's Barrr"] = "place.php?whichplace=cove";
        lookup_map["The F'c'le"] = "place.php?whichplace=cove";
        lookup_map["The Poop Deck"] = "place.php?whichplace=cove";
        lookup_map["Belowdecks"] = "place.php?whichplace=cove";
        lookup_map["Post-War Junkyard"] = "island.php";
        lookup_map["McMillicancuddy's Farm"] = "island.php";
        lookup_map["The Battlefield (Frat Uniform)"] = "bigisland.php";
        lookup_map["The Battlefield (Hippy Uniform)"] = "bigisland.php";
        lookup_map["Wartime Frat House"] = "island.php";
        lookup_map["Wartime Frat House (Hippy Disguise)"] = "island.php";
        lookup_map["Wartime Hippy Camp"] = "island.php";
        lookup_map["Wartime Hippy Camp (Frat Disguise)"] = "island.php";
        lookup_map["Next to that Barrel with Something Burning in it"] = "bigisland.php?place=junkyard";
        lookup_map["Near an Abandoned Refrigerator"] = "bigisland.php?place=junkyard";
        lookup_map["Over Where the Old Tires Are"] = "bigisland.php?place=junkyard";
        lookup_map["Out by that Rusted-Out Car"] = "bigisland.php?place=junkyard";
        lookup_map["Sonofa Beach"] = "bigisland.php?place=lighthouse";
        lookup_map["The Themthar Hills"] = "bigisland.php?place=nunnery";
        lookup_map["McMillicancuddy's Barn"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Pond"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Back 40"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Other Back 40"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Granary"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Bog"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Family Plot"] = "bigisland.php?place=farm";
        lookup_map["McMillicancuddy's Shady Thicket"] = "bigisland.php?place=farm";
        lookup_map["The Hatching Chamber"] = "bigisland.php?place=orchard";
        lookup_map["The Feeding Chamber"] = "bigisland.php?place=orchard";
        lookup_map["The Royal Guard Chamber"] = "bigisland.php?place=orchard";
        lookup_map["The Filthworm Queen's Chamber"] = "bigisland.php?place=orchard";
        lookup_map["Noob Cave"] = "tutorial.php";
        lookup_map["The Dire Warren"] = "tutorial.php";
        lookup_map["The Valley of Rof L'm Fao"] = "place.php?whichplace=mountains";
        lookup_map["Mt. Molehill"] = "place.php?whichplace=mountains";
        lookup_map["The Barrel Full of Barrels"] = "barrel.php";
        lookup_map["The Smut Orc Logging Camp"] = "place.php?whichplace=orc_chasm";
        lookup_map["The Thinknerd Warehouse"] = "place.php?whichplace=mountains";
        lookup_map["A Mob of Zeppelin Protesters"] = "place.php?whichplace=zeppelin";
        lookup_map["The Red Zeppelin"] = "place.php?whichplace=zeppelin";
        lookup_map["A-Boo Peak"] = "place.php?whichplace=highlands";
        lookup_map["Twin Peak"] = "place.php?whichplace=highlands";
        lookup_map["Oil Peak"] = "place.php?whichplace=highlands";
        lookup_map["Itznotyerzitz Mine"] = "place.php?whichplace=mclargehuge";
        lookup_map["The Goatlet"] = "place.php?whichplace=mclargehuge";
        lookup_map["Lair of the Ninja Snowmen"] = "place.php?whichplace=mclargehuge";
        lookup_map["The eXtreme Slope"] = "place.php?whichplace=mclargehuge";
        lookup_map["Mist-Shrouded Peak"] = "place.php?whichplace=mclargehuge";
        lookup_map["The Icy Peak"] = "place.php?whichplace=mclargehuge";
        lookup_map["Itznotyerzitz Mine (in Disguise)"] = "place.php?whichplace=mclargehuge";
        lookup_map["The Penultimate Fantasy Airship"] = "place.php?whichplace=beanstalk";
        lookup_map["The Castle in the Clouds in the Sky (Basement)"] = "place.php?whichplace=giantcastle";
        lookup_map["The Castle in the Clouds in the Sky (Ground Floor)"] = "place.php?whichplace=giantcastle";
        lookup_map["The Castle in the Clouds in the Sky (Top Floor)"] = "place.php?whichplace=giantcastle";
        lookup_map["The Hole in the Sky"] = "place.php?whichplace=beanstalk";
        lookup_map["The Broodling Grounds"] = "volcanoisland.php";
        lookup_map["The Outer Compound"] = "volcanoisland.php";
        lookup_map["The Temple Portico"] = "volcanoisland.php";
        lookup_map["Convention Hall Lobby"] = "volcanoisland.php";
        lookup_map["Outside the Club"] = "volcanoisland.php";
        lookup_map["The Island Barracks"] = "volcanoisland.php";
        lookup_map["The Nemesis' Lair"] = "volcanoisland.php";
        lookup_map["The Bugbear Pen"] = "place.php?whichplace=knoll_friendly";
        lookup_map["The Spooky Gravy Burrow"] = "place.php?whichplace=knoll_friendly";
        lookup_map["The Stately Pleasure Dome"] = "place.php?whichplace=wormwood";
        lookup_map["The Mouldering Mansion"] = "place.php?whichplace=wormwood";
        lookup_map["The Rogue Windmill"] = "place.php?whichplace=wormwood";
        lookup_map["The Primordial Soup"] = "place.php?whichplace=memories";
        lookup_map["The Jungles of Ancient Loathing"] = "place.php?whichplace=memories";
        lookup_map["Seaside Megalopolis"] = "place.php?whichplace=memories";
        lookup_map["Domed City of Ronaldus"] = "place.php?whichplace=spaaace";
        lookup_map["Domed City of Grimacia"] = "place.php?whichplace=spaaace";
        lookup_map["Hamburglaris Shield Generator"] = "place.php?whichplace=spaaace";
        lookup_map["The Arrrboretum"] = "place.php?whichplace=woods";
        lookup_map["Spectral Pickle Factory"] = "place.php?whichplace=plains";
        lookup_map["Lollipop Forest"] = "";
        lookup_map["Fudge Mountain"] = "";
        lookup_map["WarBear Fortress (First Level)"] = "";
        lookup_map["WarBear Fortress (Second Level)"] = "";
        lookup_map["WarBear Fortress (Third Level)"] = "";
        lookup_map["Elf Alley"] = "";
        lookup_map["CRIMBCO cubicles"] = "";
        lookup_map["CRIMBCO WC"] = "";
        lookup_map["Crimbo Town Toy Factory (2005)"] = "";
        lookup_map["The Don's Crimbo Compound"] = "";
        lookup_map["Atomic Crimbo Toy Factory"] = "";
        lookup_map["Crimbo Town Toy Factory (2007)"] = "";
        lookup_map["Sinister Dodecahedron"] = "";
        lookup_map["Crimbo Town Toy Factory (2009)"] = "";
        lookup_map["Simple Tool-Making Cave"] = "";
        lookup_map["Spooky Fright Factory"] = "";
        lookup_map["Crimborg Collective Factory"] = "";
        lookup_map["Crimbo Town Toy Factory (2012)"] = "";
        lookup_map["Market Square, 28 Days Later"] = "";
        lookup_map["The Mall of Loathing, 28 Days Later"] = "";
        lookup_map["Wrong Side of the Tracks, 28 Days Later"] = "";
        lookup_map["The Icy Peak in The Recent Past"] = "";
        lookup_map["Shivering Timbers"] = "";
        lookup_map["A Skeleton Invasion!"] = "";
        lookup_map["The Cannon Museum"] = "";
        lookup_map["A Swarm of Yeti-Mounted Skeletons"] = "";
        lookup_map["The Bonewall"] = "";
        lookup_map["A Massive Flying Battleship"] = "";
        lookup_map["A Supply Train"] = "";
        lookup_map["The Bone Star"] = "";
        lookup_map["Grim Grimacite Site"] = "";
        lookup_map["A Pile of Old Servers"] = "";
        lookup_map["The Haunted Sorority House"] = "";
        lookup_map["Fightin' Fire"] = "";
        lookup_map["Super-Intense Mega-Grassfire"] = "";
        lookup_map["Fierce Flying Flames"] = "";
        lookup_map["Lord Flameface's Castle Entryway"] = "";
        lookup_map["Lord Flameface's Castle Belfry"] = "";
        lookup_map["Lord Flameface's Throne Room"] = "";
        lookup_map["A Stinking Abyssal Portal"] = "";
        lookup_map["A Scorching Abyssal Portal"] = "";
        lookup_map["A Terrifying Abyssal Portal"] = "";
        lookup_map["A Freezing Abyssal Portal"] = "";
        lookup_map["An Unsettling Abyssal Portal"] = "";
        lookup_map["A Yawning Abyssal Portal"] = "";
        lookup_map["The Space Odyssey Discotheque"] = "";
        lookup_map["The Spirit World"] = "";
        lookup_map["Some Scattered Smoking Debris"] = "place.php?whichplace=crashsite";
        lookup_map["Anger Man's Level"] = "place.php?whichplace=junggate_3";
        lookup_map["Fear Man's Level"] = "place.php?whichplace=junggate_3";
        lookup_map["Doubt Man's Level"] = "place.php?whichplace=junggate_3";
        lookup_map["Regret Man's Level"] = "place.php?whichplace=junggate_3";
        lookup_map["The Nightmare Meatrealm"] = "place.php?whichplace=junggate_6";
        lookup_map["A Kitchen Drawer"] = "place.php?whichplace=junggate_5";
        lookup_map["A Grocery Bag"] = "place.php?whichplace=junggate_5";
        lookup_map["Chinatown Shops"] = "place.php?whichplace=junggate_1";
        lookup_map["Triad Factory"] = "place.php?whichplace=junggate_1";
        lookup_map["1st Floor, Shiawase-Mitsuhama Building"] = "place.php?whichplace=junggate_1";
        lookup_map["2nd Floor, Shiawase-Mitsuhama Building"] = "place.php?whichplace=junggate_1";
        lookup_map["3rd Floor, Shiawase-Mitsuhama Building"] = "place.php?whichplace=junggate_1";
        lookup_map["Chinatown Tenement"] = "place.php?whichplace=junggate_1";
        lookup_map["The Gourd!"] = "place.php?whichplace=junggate_2";
        lookup_map["A Deserted Stretch of I-911"] = "place.php?whichplace=ioty2014_hare";
        lookup_map["The Prince's Restroom"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Prince's Dance Floor"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Prince's Kitchen"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Prince's Balcony"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Prince's Lounge"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Prince's Canapes table"] = "place.php?whichplace=ioty2014_cindy";
        lookup_map["The Inner Wolf Gym"] = "place.php?whichplace=ioty2014_wolf";
        lookup_map["Unleash Your Inner Wolf"] = "place.php?whichplace=ioty2014_wolf";
        lookup_map["The Crimbonium Mining Camp"] = "place.php?whichplace=desertbeach";
        lookup_map["Kokomo Resort"] = "place.php?whichplace=desertbeach";
        lookup_map["The Crimbonium Mine"] = "mining.php?mine=5";
        lookup_map["The Secret Council Warehouse"] = "tutorial.php";
        lookup_map["The Skeleton Store"] = "place.php?whichplace=town_market";
        lookup_map["Madness Bakery"] = "place.php?whichplace=town_right";
        lookup_map["Investigating a Plaintive Telegram"] = "place.php?whichplace=town_right";
        lookup_map["The Fungal Nethers"] = "place.php?whichplace=nemesiscave";
        lookup_map["Thugnderdome"] = "gnomes.php";
        lookup_map["The Overgrown Lot"] = "place.php?whichplace=town_wrong";
        lookup_map["The Canadian Wildlife Preserve"] = "place.php?whichplace=mountains";
        foreach s in $strings[The Hallowed Halls,Shop Class,Chemistry Class,Art Class]
            lookup_map[s] = "place.php?whichplace=KOLHS";
        foreach s in $strings[The Edge of the Swamp,The Dark and Spooky Swamp,The Corpse Bog,The Ruined Wizard Tower,The Wildlife Sanctuarrrrrgh,Swamp Beaver Territory,The Weird Swamp Village]
            lookup_map[s] = "place.php?whichplace=marais";
        foreach s in $strings[Ye Olde Medievale Villagee,Portal to Terrible Parents,Rumpelstiltskin's Workshop]
            lookup_map[s] = "place.php?whichplace=ioty2014_rumple";
            
        foreach s in $strings[The Cave Before Time,An Illicit Bohemian Party,Moonshiners' Woods,The Roman Forum,The Post-Mall,The Rowdy Saloon,The Spooky Old Abandoned Mine,Globe Theatre Main Stage,Globe Theatre Backstage,12 West Main,KoL Con Clan Party House]
            lookup_map[s] = "place.php?whichplace=twitch";
        foreach s in $strings[The Fun-Guy Mansion,Sloppy Seconds Diner,The Sunken Party Yacht]
            lookup_map[s] = "place.php?whichplace=airport_sleaze";
        foreach s in $strings[The Mansion of Dr. Weirdeaux,The Deep Dark Jungle,The Secret Government Laboratory]
            lookup_map[s] = "place.php?whichplace=airport_spooky";
        foreach s in $strings[Pirates of the Garbage Barges,Barf Mountain,The Toxic Teacups,Uncle Gator's Country Fun-Time Liquid Waste Sluice]
            lookup_map[s] = "place.php?whichplace=airport_stench";
        foreach s in $strings[The SMOOCH Army HQ,The Velvet / Gold Mine,LavaCo&trade; Lamp Factory,The Bubblin' Caldera]
            lookup_map[s] = "place.php?whichplace=airport_hot";
        foreach s in $strings[The Ice Hotel,VYKEA,The Ice Hole]
            lookup_map[s] = "place.php?whichplace=airport_cold";
        lookup_map["The Velvet / Gold Mine (Mining)"] = "mining.php?mine=6";
        foreach s in $strings[The Mines,The Jungle,The Ice Caves,The Temple Ruins,Hell,The Snake Pit,The Spider Hole,The Ancient Burial Ground,The Beehive,the crashed u. f. o.,The City of Goooold,LOLmec's Lair,Yomama's Throne]
            lookup_map[s] = "place.php?whichplace=spelunky";
        
        foreach s in $strings[Medbay,Waste Processing,Sonar,Science Lab,Morgue,Special Ops,Engineering,Navigation,Galley]
            lookup_map[s] = "place.php?whichplace=bugbearship";
        foreach s in $strings[Sweet-Ade Lake,Eager Rice Burrows,Gumdrop Forest]
            lookup_map[s] = "place.php?whichplace=ioty2014_candy";
        foreach s in $strings[Gingerbread Industrial Zone,Gingerbread Train Station,Gingerbread Sewers,Gingerbread Upscale Retail District]
            lookup_map[s] = "place.php?whichplace=gingerbreadcity";
            
        foreach s in $strings[Fastest Adventurer Contest,Strongest Adventurer Contest,Smartest Adventurer Contest,Smoothest Adventurer Contest,A Crowd of (Stat) Adventurers,Hottest Adventurer Contest,Coldest Adventurer Contest,Spookiest Adventurer Contest,Stinkiest Adventurer Contest,Sleaziest Adventurer Contest,A Crowd of (Element) Adventurers,The Hedge Maze,Tower Level 1,Tower Level 2,Tower Level 3,Tower Level 4,Tower Level 5,The Naughty Sorceress' Chamber]
            lookup_map[s] = "place.php?whichplace=nstower";
            
        lookup_map["Trick-or-treating"] = "place.php?whichplace=town&action=town_trickortreat";
        lookup_map["The Deep Machine Tunnels"] = "place.php?whichplace=dmt";
        
        lookup_map["The Ruins of the Fully Automated Crimbo Factory"] = "place.php?whichplace=crimbo2015";
        lookup_map["The X-32-F Combat Training Snowman"] = "place.php?whichplace=snojo";
        foreach s in $strings[Your Bung Chakra,Your Guts Chakra,Your Liver Chakra,Your Nipple Chakra,Your Nose Chakra,Your Hat Chakra]
            lookup_map[s] = "place.php?whichplace=crimbo2016m";
        foreach s in $strings[Crimbo's Sack,Crimbo's Boots,Crimbo's Jelly,Crimbo's Reindeer,Crimbo's Beard,Crimbo's Hat]
            lookup_map[s] = "place.php?whichplace=crimbo2016c";
        foreach s in $strings[The Cheerless Spire (Level 1), The Cheerless Spire (Level 2), The Cheerless Spire (Level 3), The Cheerless Spire (Level 4), The Cheerless Spire (Level 5)]
        	lookup_map[s] = "place.php?whichplace=crimbo17_silentnight";
        foreach s in $strings[The Bandit Crossroads,The Putrid Swamp,Near the Witch's House,The Troll Fortress,The Sprawling Cemetery,The Cursed Village,The Foreboding Cave,The Faerie Cyrkle,The Evil Cathedral,The Towering Mountains,The Mystic Wood,The Druidic Campsite,The Old Rubee Mine]
        	lookup_map[s] = "place.php?whichplace=realm_fantasy";
        foreach s in $strings[PirateRealm Island,Sailing the PirateRealm Seas]
            lookup_map[s] = "place.php?whichplace=realm_pirate";
        lookup_map["An Eldritch Horror"] = "place.php?whichplace=town";
        lookup_map["The Neverending Party"] = "place.php?whichplace=town_wrong";
        lookup_map["Through the Spacegate"] = "place.php?whichplace=spacegate";
        lookup_map["The Exploaded Battlefield"] = "place.php?whichplace=exploathing";
        __constant_clickable_urls = LAConvertLocationLookupToLocations(lookup_map);
    }
    initialiseConstantClickableURLs();
    
}

string [location] __variable_clickable_urls;
string getClickableURLForLocation(location l, Error unable_to_find_url)
{
    if (l == $location[none])
        return "";
    if (__constant_clickable_urls contains l)
        return __constant_clickable_urls[l];
        
    if (__variable_clickable_urls.count() == 0)
    {
        //Initialize:
        //We use to_location() lookups here because $location[] will halt the script if the location name changes.
        //Probably could move this to an external data file.
        string [string] lookup_map;
            
        //Conditionals only:
        if ($location[cobb's knob barracks].locationAvailable())
            lookup_map["The Outskirts of Cobb's Knob"] = "cobbsknob.php";
        else
            lookup_map["The Outskirts of Cobb's Knob"] = "place.php?whichplace=plains";
            
        if (knoll_available())
            lookup_map["Post-Quest Bugbear Pens"] = "place.php?whichplace=knoll_friendly";
        else
            lookup_map["Post-Quest Bugbear Pens"] =  "place.php?whichplace=knoll_hostile";
            
        if ($item[talisman o' namsilat].equipped_amount() > 0)
            lookup_map["Inside the Palindome"] = "place.php?whichplace=palindome";
        else
            lookup_map["Inside the Palindome"] = generateEquipmentLink($item[talisman o' namsilat]);
        //antique maps are weird:
        lookup_map["The Electric Lemonade Acid Parade"] = "inv_use.php?pwd=" + my_hash() + "&whichitem=4613";
        foreach s in $strings[Professor Jacking's Small-O-Fier,Professor Jacking's Huge-A-Ma-tron]
            lookup_map[s] = "inv_use.php?pwd=" + my_hash() + "&whichitem=4560";
            
        //Parse into locations:
        __variable_clickable_urls = LAConvertLocationLookupToLocations(lookup_map);
    }
    if (__variable_clickable_urls contains l)
        return __variable_clickable_urls[l];

    ErrorSet(unable_to_find_url);
    return "";
}

string getClickableURLForLocation(location l)
{
    return l.getClickableURLForLocation(ErrorMake());
}

string getClickableURLForLocationIfAvailable(location l)
{
    Error able_to_find;
    boolean found = l.locationAvailable(able_to_find);
    if (able_to_find.was_error) //assume it's available, since we don't know
        found = true;
    if (found)
        return l.getClickableURLForLocation();
    else
        return "";
}



void locationAvailableRunDiagnostics()
{
    location [string][int] unknown_locations_by_zone;
    
    foreach loc in $locations[]
    {
        Error able_to_find;
        locationAvailable(loc, able_to_find);
        if (!able_to_find.was_error)
            continue;
        if (!(unknown_locations_by_zone contains (loc.zone)))
            unknown_locations_by_zone[loc.zone] = listMakeBlankLocation();
        unknown_locations_by_zone[loc.zone].listAppend(loc);
    }
    if (unknown_locations_by_zone.count() > 0)
    {
        print_html("Unknown locations in location availability tester:");
        foreach zone in unknown_locations_by_zone
        {
            print(zone + ":");
            foreach key in unknown_locations_by_zone[zone]
            {
                location loc = unknown_locations_by_zone[zone][key];
                print_html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + loc);
            }
        }
    }
    /*print_html("<strong>Missing URLs:</strong>");
    foreach loc in $locations[]
    {
    	if (loc.parent == "Removed") continue;
    	if (loc.getClickableURLForLocation() == "")
        	print_html(loc.parent + ": " + loc.zone + ": " + loc);
    }*/
}

/*void main()
{
    locationAvailableRunDiagnostics();
}*/


Record EquipmentStatRequirement
{
    stat requirement_stat;
    int requirement_amount;
};
static
{
    EquipmentStatRequirement [item] __equipment_stat_requirements;
}

void initialiseEquipmentRequirements()
{
    if (__equipment_stat_requirements.count() > 0)
        return;
    Record equipment_txt_entry
    {
        int power;
        string requirement;
        string weapon_description;
    };
    equipment_txt_entry [item] entries;
    file_to_map("data/equipment.txt", entries);
    
    foreach it, entry in entries
    {
        if (entry.requirement == "" || entry.requirement == "none")
            continue;
        int requirement_integer = entry.requirement.split_string(" ")[1].to_int_silent();
        if (requirement_integer <= 0)
            continue;
        stat known_stat = $stat[none];
        if (entry.requirement.contains_text("Mus: "))
        {
            known_stat = $stat[muscle];
        }
        else if (entry.requirement.contains_text("Mys: "))
        {
            known_stat = $stat[mysticality];
        }
        else if (entry.requirement.contains_text("Mox: "))
        {
            known_stat = $stat[moxie];
        }
        if (known_stat != $stat[none])
        {
            EquipmentStatRequirement requirement;
            requirement.requirement_stat = known_stat;
            requirement.requirement_amount = requirement_integer;
            
            __equipment_stat_requirements[it] = requirement;
            //__equipment_stat_requirements[it][known_stat] = requirement_integer;
        }
    }
}
EquipmentStatRequirement StatRequirementForEquipment(item it)
{
    initialiseEquipmentRequirements();
    return __equipment_stat_requirements[it];
}



float __setting_indention_width_in_em = 1.45;
string __setting_indention_width = __setting_indention_width_in_em + "em";

string __html_right_arrow_character = "&#9658;";

//Design note: try to prefer HTMLAppend to HTMLGenerate due to lack of temporary objects.


buffer HTMLAppendTagPrefix(buffer out, string tag, string attribute_1, string value_1, string attribute_2, string value_2)
{
	out.append("<");
	out.append(tag);
	
    out.append(" ");
    out.append(attribute_1);
    if (value_1 != "")
    {
        boolean is_integer = value_1.is_integer(); //don't put quotes around integer attributes (i.e. width, height)
        
        out.append("=");
        if (!is_integer)
            out.append("\"");
        out.append(value_1);
        if (!is_integer)
            out.append("\"");
    }
    
    out.append(" ");
    out.append(attribute_2);
    if (value_2 != "")
    {
        boolean is_integer = value_2.is_integer(); //don't put quotes around integer attributes (i.e. width, height)
        
        out.append("=");
        if (!is_integer)
            out.append("\"");
        out.append(value_2);
        if (!is_integer)
            out.append("\"");
    }
    
    
    
	out.append(">");
	return out;
}

buffer HTMLAppendTagPrefix(buffer out, string tag, string attribute_1, string value_1)
{
	out.append("<");
	out.append(tag);
	
    out.append(" ");
    out.append(attribute_1);
    if (value_1 != "")
    {
        boolean is_integer = value_1.is_integer(); //don't put quotes around integer attributes (i.e. width, height)
        
        out.append("=");
        if (!is_integer)
            out.append("\"");
        out.append(value_1);
        if (!is_integer)
            out.append("\"");
    }
    
    
	out.append(">");
	return out;
}

buffer HTMLAppendTagPrefix(buffer out, string tag, string [string] attributes)
{
	out.append("<");
	out.append(tag);
	foreach attribute_name, attribute_value in attributes
	{
		//string attribute_value = attributes[attribute_name];
		out.append(" ");
		out.append(attribute_name);
		if (attribute_value != "")
		{
			boolean is_integer = attribute_value.is_integer(); //don't put quotes around integer attributes (i.e. width, height)
			
			out.append("=");
			if (!is_integer)
				out.append("\"");
			out.append(attribute_value);
			if (!is_integer)
				out.append("\"");
		}
	}
	out.append(">");
	return out;
}

buffer HTMLGenerateTagPrefix(string tag, string [string] attributes)
{
	buffer result;
	return HTMLAppendTagPrefix(result, tag, attributes);
}

buffer HTMLAppendTagPrefix(buffer out, string tag)
{
    out.append("<");
    out.append(tag);
    out.append(">");
    return out;
}

buffer HTMLGenerateTagPrefix(string tag)
{
    buffer result;
    result.append("<");
    result.append(tag);
    result.append(">");
    return result;
}


buffer HTMLAppendTagSuffix(buffer out, string tag)
{
    out.append("</");
    out.append(tag);
    out.append(">");
    return out;
}

buffer HTMLGenerateTagSuffix(string tag)
{
    buffer result;
    return result.HTMLAppendTagSuffix(tag);
}

buffer HTMLAppendTagWrap(buffer out, string tag, string source, string [string] attributes)
{
    out.HTMLAppendTagPrefix(tag, attributes);
    out.append(source);
    out.HTMLAppendTagSuffix(tag);
	return out;
}

buffer HTMLGenerateTagWrap(string tag, string source, string [string] attributes)
{
    buffer result;
    return result.HTMLAppendTagWrap(tag, source, attributes);
}

buffer HTMLGenerateTagWrap(string tag, string source)
{
    buffer result;
    result.HTMLAppendTagPrefix(tag);
    result.append(source);
    result.HTMLAppendTagSuffix(tag);
	return result;
}

buffer HTMLAppendDivOfClass(buffer out, string source, string class_name)
{
	if (class_name == "")
	{
		out.append("<div>");
		//return HTMLGenerateTagWrap("div", source);
    }
	else
	{
		out.append("<div class=\"");
        out.append(class_name);
        out.append("\">");
		//return HTMLGenerateTagWrap("div", source, mapMake("class", class_name));
    }
    out.append(source);
    out.append("</div>");
    
    return out;
}

buffer HTMLGenerateDivOfClass(string source, string class_name)
{
	buffer out;
	out.HTMLAppendDivOfClass(source, class_name);
	return out;
}

buffer HTMLGenerateDivOfClassAndStyle(string source, string class_name, string extra_style)
{
	return HTMLGenerateTagWrap("div", source, mapMake("class", class_name, "style", extra_style));
}

buffer HTMLGenerateDivOfStyle(string source, string style)
{
	if (style == "")
		return HTMLGenerateTagWrap("div", source);
	
	return HTMLGenerateTagWrap("div", source, mapMake("style", style));
}

buffer HTMLGenerateDiv(string source)
{
    return HTMLGenerateTagWrap("div", source);
}

buffer HTMLGenerateSpan(string source)
{
    return HTMLGenerateTagWrap("span", source);
}

buffer HTMLGenerateSpanOfClass(string source, string class_name)
{
	if (class_name == "")
		return HTMLGenerateTagWrap("span", source);
	else
		return HTMLGenerateTagWrap("span", source, mapMake("class", class_name));
}

buffer HTMLGenerateSpanOfStyle(string source, string style)
{
	if (style == "")
    {
        buffer out;
        out.append(source);
        return out;
    }
	return HTMLGenerateTagWrap("span", source, mapMake("style", style));
}

buffer HTMLGenerateSpanFont(string source, string font_colour, string font_size)
{
	if (font_colour == "" && font_size == "")
    {
        buffer out;
        out.append(source);
        return out;
    }
		
	buffer style;
	
	if (font_colour != "")
    {
		//style += "color:" + font_colour + ";";
        style.append("color:");
        style.append(font_colour);
        style.append(";");
    }
	if (font_size != "")
    {
		//style += "font-size:" + font_size + ";";
        style.append("font-size:");
        style.append(font_size);
        style.append(";");
    }
	return HTMLGenerateSpanOfStyle(source, style.to_string());
}

buffer HTMLGenerateSpanFont(string source, string font_colour)
{
    return HTMLGenerateSpanFont(source, font_colour, "");
}

string HTMLConvertStringToAnchorID(string id)
{
    if (id.length() == 0)
        return id;
    
	id = to_string(replace_string(id, " ", "_"));
	//ID and NAME must begin with a letter ([A-Za-z]) and may be followed by any number of letters, digits ([0-9]), hyphens ("-"), underscores ("_"), colons (":"), and periods (".")
    
	//FIXME do that
	return id;
}

string HTMLEscapeString(string line)
{
    return entity_encode(line);
}

string HTMLStripTags(string html)
{
    matcher pattern = create_matcher("<[^>]*>", html);
    return pattern.replace_all("");
}


string [string] generateMainLinkMap(string url)
{
    return mapMake("class", "r_a_undecorated", "href", url, "target", "mainpane");
}



string HTMLGreyOutTextUnlessTrue(string text, boolean conditional)
{
    if (conditional)
        return text;
    return HTMLGenerateSpanFont(text, "gray");
}

//Should this be here...? Might be "Guide" instead of this.
string HTMLGenerateTooltip(string underline_text, string inner_html)
{
	return HTMLGenerateSpanOfClass(HTMLGenerateSpanOfClass(inner_html, "r_tooltip_inner_class") + underline_text, "r_tooltip_outer_class");
}






string HTMLGenerateFutureTextByLocationAvailability(string base_text, location place)
{
    if (!place.locationAvailable() && place != $location[none])
    {
        base_text = HTMLGenerateSpanOfClass(base_text, "r_future_option");
    }
    return base_text;
}

string HTMLGenerateFutureTextByLocationAvailability(location place)
{
	return HTMLGenerateFutureTextByLocationAvailability(place.to_string(), place);
}

//Alternate name, since last time I tried making this function then discovered the "generate future text" options which I cleverly named in such a way that I would never find it
string HTMLGreyOutIfLocationUnavailable(string source, location l)
{
    return HTMLGenerateFutureTextByLocationAvailability(source, l);
}
string HTMLBoldIfTrue(string base_text, boolean conditional)
{
    if (conditional)
        return HTMLGenerateSpanOfClass(base_text, "r_bold");
    return base_text;
}


boolean can_equip_replacement(item it)
{
    if (it.equipped_amount() > 0)
        return true;
    if (it.item_type() == "chefstaff" && !($skill[Spirit of Rigatoni].have_skill() || my_class() == $class[Avatar of Jarlsberg] || (my_class() == $class[sauceror] && $item[special sauce glove].equipped_amount() > 0)))
    	return false;
    boolean can_equip = it.can_equip();
    if (can_equip)
        return true;
    if (my_class() == $class[pastamancer])
    {
        //Bind Undead Elbow Macaroni -> equalises muscle
        //Bind Penne Dreadful -> equalises moxie
        EquipmentStatRequirement requirement = it.StatRequirementForEquipment();
        
        if (requirement.requirement_stat == $stat[none])
            return true;
        if (my_basestat(requirement.requirement_stat) >= requirement.requirement_amount)
            return true;
        if (requirement.requirement_stat == $stat[mysticality])
            return false;
        
        if (requirement.requirement_stat == $stat[muscle])
        {
            if ($skill[bind undead elbow macaroni].have_skill() && my_basestat($stat[mysticality]) >= requirement.requirement_amount)
                return true;
        }
        else if (requirement.requirement_stat == $stat[moxie])
        {
            if ($skill[Bind Penne Dreadful].have_skill() && my_basestat($stat[mysticality]) >= requirement.requirement_amount)
                return true;
        }
    }
    return can_equip;
}

boolean can_equip_outfit(string outfit_name)
{
    if (!have_outfit_components(outfit_name))
        return false;
    item [int] outfit_pieces = outfit_pieces(outfit_name);
    foreach key, it in outfit_pieces
    {
        if (!it.can_equip_replacement())
            return false;
    }
    return true;
}


//Probably not a good place for it:
boolean asdonMartinFailsFuelableTestsPrivate(item craft, boolean [item] ingredients_blocklisted, boolean [item] crafts_seen)
{
    //if ($items[wad of dough,flat dough] contains craft) return false;
    if (craft.craft_type().contains_text("(fancy)"))
        return true;
    crafts_seen[craft] = true;
    boolean all_npc = true;
    foreach it, amount in craft.get_ingredients_fast()
    {
        //print_html(craft + ": " + it);
        if (ingredients_blocklisted[it]) return true;
        if (!it.is_npc_item())
            all_npc = false;
        
        if (it.item_amount() >= amount) continue;
        if (crafts_seen[it]) //wad of dough, flat dough, jolly roger charrrm
        {
            continue;
        }
        if (it.asdonMartinFailsFuelableTestsPrivate(ingredients_blocklisted, crafts_seen))
            return true;
    }
    if (craft.get_ingredients_fast().count() == 0)
        all_npc = false;
    if (all_npc && crafts_seen.count() == 0) //hmm... what if it's a second level all-NPC?
    {
        return true;
    }
    return false;
}

boolean asdonMartinFailsFuelableTests(item craft, boolean [item] ingredients_blocklisted)
{
    boolean [item] crafts_seen; //slower than a "last item" test, but necessary (spooky wads)
    return asdonMartinFailsFuelableTestsPrivate(craft, ingredients_blocklisted, crafts_seen);
}

item [int] asdonMartinGenerateListOfFuelables()
{
    item [int] fuelables;
    boolean [item] blocklist;
    if (!QuestState("questL11Black").finished) //FIXME no
        blocklist[$item[blackberry]] = true; //FIXME test properly?
    blocklist[$item[stunt nuts]] = true;
    blocklist[$item[wet stew]] = true; //FIXME I guess maybe not after
    blocklist[$item[goat cheese]] = true;
    blocklist[$item[turkey blaster]] = true;
    blocklist[$item[hot wing]] = true;
    blocklist[$item[glass of goat's milk]] = true;
    blocklist[$item[soft green echo eyedrop antidote martini]] = true; //if it's not created, FIXME
    blocklist[$item[warm gravy]] = true; //don't steal my boat
    foreach it in $items[Falcon&trade; Maltese Liquor, hardboiled egg]
        blocklist[it] = true; //don't steal my -combat
    blocklist[$item[loaf of soda bread]] = true; //elsewhere
    foreach it in $items[hot buttered roll,ketchup,catsup]
        blocklist[it] = true; //hermit
        
    //These aren't directly feedable, but indirectly make things:
    blocklist[$item[source essence]] = true; //that's silly
    blocklist[$item[white pixel]] = true; //no!
    blocklist[$item[cashew]] = true;
    
    if (my_path_id() != PATH_LICENSE_TO_ADVENTURE && inebriety_limit() > 0) //FIXME the test for can drink just about
    {
        foreach it in $items[bottle of gin,bottle of rum,bottle of vodka,bottle of whiskey,bottle of tequila] //too useful for crafting?
            blocklist[it] = true;
    }
    foreach it in $items[bottle of Calcutta Emerald,bottle of Lieutenant Freeman,bottle of Jorge Sinsonte,bottle of Definit,bottle of Domesticated Turkey,boxed champagne,bottle of Ooze-O,bottle of Pete's Sake,tangerine,kiwi,cocktail onion,kumquat,tonic water,raspberry] //nash crosby's still's results isn't feedable
        blocklist[it] = true;
    foreach it in __pvpable_food_and_drinks
    {
        if (blocklist[it]) continue;
        if (it.is_npc_item()) continue;
        if (it.historical_price() >= 20000) continue;
        if (it.item_amount() == 0)
        {
            if (it.creatable_amount() == 0)
                continue;
            if (it.asdonMartinFailsFuelableTests(blocklist))
            {
                continue;
            }
        }
        if (my_path_id() == PATH_LICENSE_TO_ADVENTURE && false)
        {
            if (it.inebriety > 0 && it.image == "martini.gif")
                continue;
        }
        if (it.item_cannot_be_asdon_martined_because_it_was_purchased_from_a_store()) //the asdon martin wishes it was an AE86, so those work
        {
            //print_html("Rejecting " + it);
            continue;
        }
        /*int [item] ingredients = it.get_ingredients_fast();
        if (ingredients.count() > 0)
        {
            boolean reject = false;
            //Various things count as being from a "store":
            foreach it in $items[yellow pixel,handful of barley,spacegate research]
            {
                if (ingredients[it] > 0)
                {
                    reject = true;
                    break;
                }
            }
            if (reject)
                continue;
        }*/
        float average_adventures = it.averageAdventuresForConsumable();
        if (average_adventures == 0.0)
            continue;
            
        float soda_bread_efficiency = to_float($item[wad of dough].npc_price() + $item[soda water].npc_price()) / 6.0;
        if (soda_bread_efficiency < 1.0) soda_bread_efficiency = 100000.0;
        if (it.autosell_price() > 0 && it.autosell_price().to_float() / average_adventures > soda_bread_efficiency && my_path_id() != PATH_EXPLOSIONS)
        {
            continue;
        }
        fuelables.listAppend(it);
    }
    sort fuelables by -value.averageAdventuresForConsumable() * ((value.asdonMartinFailsFuelableTests(blocklist) ? 0 : value.creatable_amount()) + value.item_amount());
    return fuelables;
}




boolean craftableUsingOnlyActiveNPCStoresPrivate(item it, boolean [item] crafts_seen)
{
    if (it.npc_price() > 0)
        return true;
    
    int [item] ingredients = it.get_ingredients_fast();
    if (ingredients.count() == 0) return false;
    
    if (crafts_seen[it])
        return true;
    
    crafts_seen[it] = true;
    
    foreach ingredient in ingredients
    {
        if (!craftableUsingOnlyActiveNPCStoresPrivate(ingredient, crafts_seen))
        {
            return false;
        }
    }
    return true;
}

boolean craftableUsingOnlyActiveNPCStores(item it)
{
    boolean [item] crafts_seen;
    return craftableUsingOnlyActiveNPCStoresPrivate(it, crafts_seen);
}


int CatBurglarChargesLeftToday()
{
    //FIXME this is totally wrong I think, fix this mafia
    int charge = get_property_int("_catBurglarCharge");
    
    int heists_gained_today = 0;
    int limit = 10;
    int c = charge;
    while (c >= limit)
    {
        heists_gained_today += 1;
        c -= limit;
        limit *= 2;
    }
    int heists_complete = get_property_int("_catBurglarHeistsComplete");
    //print_html("heists_gained_today = " + heists_gained_today + ", heists_complete = " + heists_complete); 
    return get_property_int("catBurglarBankHeists") + heists_gained_today - heists_complete;
}


int PathCommunityServiceEstimateTurnsTakenForTask(string service_name)
{
    int turns = 60;
    if (service_name == "Donate Blood")
    {
        turns = 60 - (my_maxhp() - (my_buffedstat($stat[muscle]) + 3)) / 30;
    }
    else if (service_name == "Coil Wire")
    {
        turns = 60;
    }
    else if (service_name == "Make Margaritas")
    {
    	float item_drop = numeric_modifier("Item Drop");
        //Mafia adds item drop modifiers depending on our location.
        //set_location() is slow, we want to avoid it.
        //Manually correct:
        if ($skill[Speluck].have_skill() && my_location().environment == "underground")
        {
        	item_drop -= 5.0;
            if ($effect[Steely-Eyed Squint].have_effect() > 0)
            	item_drop -= 5.0;
        }
        turns = 60 - (floor(item_drop / 30) + floor(numeric_modifier("Booze Drop") / 15));
    }
    else if (service_name == "Feed The Children (But Not Too Much)" || service_name == "Build Playground Mazes" || service_name == "Feed Conspirators")
    {
        stat using_stat;
        if (service_name == "Feed The Children (But Not Too Much)")
        {
            using_stat = $stat[muscle];
        }
        else if (service_name == "Build Playground Mazes")
        {
            using_stat = $stat[mysticality];
        }
        else if (service_name == "Feed Conspirators")
        {
            using_stat = $stat[moxie];
        }
        int basestat = my_basestat(using_stat);
        boolean relevant_thrall_active = false;
        if (my_thrall() == $thrall[Elbow Macaroni] && using_stat == $stat[muscle])
        {
            basestat = my_basestat($stat[mysticality]);
            relevant_thrall_active = true;
        }
        if (my_thrall() == $thrall[Penne Dreadful] && using_stat == $stat[moxie])
        {
            basestat = my_basestat($stat[mysticality]);
            relevant_thrall_active = true;
        }
        
        turns = 60 - (my_buffedstat(using_stat) - basestat) / 30;
    }
    else if (service_name == "Reduce Gazelle Population")
    {
        float modifier_1 = numeric_modifier("Weapon Damage");
        float modifier_2 = numeric_modifier("Weapon Damage Percent");
        
        foreach s in $slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3,familiar]
        {
        	item it = s.equipped_item();
            if (it.to_slot() != $slot[weapon]) continue;
            int power = it.get_power();
            float addition = to_float(power) * 0.15;
            
            modifier_1 -= addition;
        }
        if ($effect[bow-legged swagger].have_effect() > 0)
        {
            modifier_1 *= 2;
            modifier_2 *= 2;
        }
        turns = 60 - (floor(modifier_1 / 50) + floor(modifier_2 / 50));
    }
    else if (service_name == "Make Sausage")
    {
        turns = 60 - (floor(numeric_modifier("Spell Damage") / 50) + floor(numeric_modifier("Spell Damage Percent") / 50));
    }
    else if (service_name == "Clean Steam Tunnels")
    {
        turns = 60 - numeric_modifier("Hot Resistance");
    }
    else if (service_name == "Breed More Collies")
    {
        int current_familiar_weight = my_familiar().effective_familiar_weight() + numeric_modifier("familiar weight");
        turns = 60 - floor(current_familiar_weight / 5);
    }
    else if (service_name == "Be a Living Statue")
    {
        float combat_rate_raw = numeric_modifier("Combat Rate");
        int combat_rate_inverse = 0;
        if (combat_rate_raw < 0) combat_rate_inverse = -combat_rate_raw;
        if (combat_rate_inverse > 25) combat_rate_inverse = (combat_rate_inverse - 25) * 5 + 25;
        turns = 60 - floor(combat_rate_inverse / 5) * 3;
    }
    
    turns = clampi(turns, 1, 60);
    
    return turns;
}



Record KramcoSausageFightInformation 
{
    boolean goblin_will_appear;
    int turns_to_next_guaranteed_fight;
    float probability_of_sausage_fight;
    float average_turns_to_next_sausage_fight_if_continually_equipped;
};

int KramcoCalculateTurnWillAlwaysSeeGoblin(int sausage_fights)
{
    if (sausage_fights <= 0)
    	return 0;
	int turn_will_always_see_goblin = 5 + sausage_fights * 3 + powi(max(0, sausage_fights - 5), 3) - 1;
    return turn_will_always_see_goblin;
}

KramcoSausageFightInformation KramcoCalculateSausageFightInformation()
{
    KramcoSausageFightInformation information;
    information.average_turns_to_next_sausage_fight_if_continually_equipped = -1.0;
    int last_sausage_turn = get_property_int("_lastSausageMonsterTurn"); //FIXME
    int sausage_fights = get_property_int("_sausageFights");
    
    
    
    //These ceilings are not correct; they are merely what I have spaded so far. The actual values are higher.
    int delta = total_turns_played() - last_sausage_turn;
    
    int turn_will_always_see_goblin = -1;
    
    
    boolean use_formula = true;
    if (use_formula)
    {
    	//use formula, spaded by unknown:
        //seems to match the ceiling data I have
        //this line is fun - can you find the character gremlin that causes script parsing to break?
        //turn_will_always_see_goblin = 5 + sausage_fights * 3 + powi(max(0, sausage_fights  5), 3) - 1; //-1 for our system
        turn_will_always_see_goblin = KramcoCalculateTurnWillAlwaysSeeGoblin(sausage_fights);
    }
    else
    {
        int [int] observed_ceilings = {0, 7, 10, 13, 16, 19, 23, 33, 54, 93, 154, 219, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220};
        //0,7,10,13,16,19,23,33,55,94,155,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222
        
        turn_will_always_see_goblin = observed_ceilings[sausage_fights];
    	if (!(observed_ceilings contains sausage_fights))
     	   turn_will_always_see_goblin = -1;
    }
    
    
    
    information.turns_to_next_guaranteed_fight = MAX(0, turn_will_always_see_goblin - delta);
    //Goblins do not appear on the same turn as semi-rares, anywhere.
    if (information.turns_to_next_guaranteed_fight == 0 && CounterLookup("Semi-rare").CounterGetNextExactTurn() == 0)
    	information.turns_to_next_guaranteed_fight += 1;
    
    if (turn_will_always_see_goblin == -1)
         information.turns_to_next_guaranteed_fight = -1;
    
    if (turn_will_always_see_goblin > 1)
    {
    	if (use_formula)
        {
        	information.probability_of_sausage_fight = clampf(to_float(delta + 1) / to_float(turn_will_always_see_goblin + 1), 0.0, 1.0);
        }
        else
        {
            //This is probably wrong?
            float probability_each_incorrect = 1.0 / to_float(turn_will_always_see_goblin - 1);
            information.probability_of_sausage_fight = clampf((delta + 1) * probability_each_incorrect, 0.0, 1.0);
        }
    }
    information.goblin_will_appear = (information.turns_to_next_guaranteed_fight == 0);
    
    //calculate average_turns_to_next_sausage_fight_if_continually_equipped:
    if (true)
    {
        /*if (debug)
        {
        	print_html("Calculating average turns...");
        }*/
    	//Calculate average turns to next sausage fight if continually equipped:
    	//Method:
    	//Start at current turn
        //Calculate probability of not encountering a goblin this turn. Multiply by previous value. If value is <= 0.5, stop. Otherwise, increment turn and loop.
        //Then linerally interpret the result vs 0.5.
        float failure_likelyhood_so_far = 1.0;
        int calculation_delta_turn = 0;
        int breakout = 500;
        while (breakout > 0)
        {
            /*if (debug)
            {
                print_html("calculation_delta_turn = " + calculation_delta_turn + ", failure_likelyhood_so_far = " + failure_likelyhood_so_far);
            }*/
        	breakout -= 1;
            float previous_failure_likelyhood = failure_likelyhood_so_far;
        	float probability_of_sausage_fight = clampf(to_float((calculation_delta_turn + delta) + 1) / to_float(turn_will_always_see_goblin + 1), 0.0, 1.0);
            failure_likelyhood_so_far *= (1.0 - probability_of_sausage_fight);
            if (failure_likelyhood_so_far <= 0.5)
            {
            	//At critical point.
                //Linear interpolation that is probably wrong, I never paid attention to statistics:
                float average_turns = calculation_delta_turn;
                float to_half = (previous_failure_likelyhood - 0.5);
                float total_delta = previous_failure_likelyhood - failure_likelyhood_so_far;
                
                
                /*if (debug)
                {
                    print_html("vfailure_likelyhood_so_far = " + failure_likelyhood_so_far + ", average_turns before changing = " + average_turns);
                }*/
                if (total_delta != 0.0)
	                average_turns += clampf(to_half / total_delta, 0.0, 1.0);
                 
                 information.average_turns_to_next_sausage_fight_if_continually_equipped = average_turns;
                 break;
            }
            else
            {
            	calculation_delta_turn += 1;
            }
        }
    }
    
    /*if (debug)
    {
        print_html("sausage_fights = " + sausage_fights + " delta = " + delta + " turn_will_always_see_goblin = " + turn_will_always_see_goblin);
        print_html("information.turns_to_next_guaranteed_fight = " + information.turns_to_next_guaranteed_fight);
        print_html("information.probability_of_sausage_fight = " + information.probability_of_sausage_fight);
        print_html("information.average_turns_to_next_sausage_fight_if_continually_equipped = " + information.average_turns_to_next_sausage_fight_if_continually_equipped);
    }*/
    return information;
}








record CSSEntry
{
    string tag;
    string class_name;
    string definition;
    int importance;
};

CSSEntry CSSEntryMake(string tag, string class_name, string definition, int importance)
{
    CSSEntry entry;
    entry.tag = tag;
    entry.class_name = class_name;
    entry.definition = definition;
    entry.importance = importance;
    return entry;
}

record CSSBlock
{
    CSSEntry [int] defined_css_classes;
    string identifier;
};

CSSBlock CSSBlockMake(string identifier)
{
    CSSBlock result;
    result.identifier = identifier;
    return result;
}

buffer CSSBlockGenerate(CSSBlock block)
{
    buffer result;
    
    if (block.defined_css_classes.count() > 0)
    {
        boolean output_identifier = (block.identifier != "");
        if (output_identifier)
        {
            result.append("\t\t\t");
            result.append(block.identifier);
            result.append(" {\n");
        }
        sort block.defined_css_classes by value.importance;
    
        foreach key in block.defined_css_classes
        {
            CSSEntry entry = block.defined_css_classes[key];
            result.append("\t\t\t");
            if (output_identifier)
                result.append("\t");
        
            if (entry.class_name == "")
                result.append(entry.tag + " { " + entry.definition + " }");
            else
                result.append(entry.tag + "." + entry.class_name + " { " + entry.definition + " }");
            result.append("\n");
        }
        if (output_identifier)
            result.append("\n\t\t\t}\n");
    }
    return result;
}

void listAppend(CSSEntry [int] list, CSSEntry entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

record Page
{
	string title;
	buffer head_contents;
	buffer body_contents;
	string [string] body_attributes; //[attribute_name] -> attribute_value
	
    CSSBlock [string] defined_css_blocks; //There is always an implicit "" block.
};


Page __global_page;



Page Page()
{
	return __global_page;
}

Page PageResetGlobalPage()
{
	Page new_page;
	__global_page = new_page;
	return __global_page;
}

buffer PageGenerateBodyContents(Page page_in)
{
    return page_in.body_contents;
}

buffer PageGenerateBodyContents()
{
    return Page().PageGenerateBodyContents();
}

buffer PageGenerateStyle(Page page_in)
{
    buffer result;
    
    if (page_in.defined_css_blocks.count() > 0)
    {
        if (true)
        {
            result.append("\t\t");
            result.HTMLAppendTagPrefix("style", "type", "text/css");
            result.append("\n");
        }
        result.append(page_in.defined_css_blocks[""].CSSBlockGenerate()); //write first
        foreach identifier in page_in.defined_css_blocks
        {
            CSSBlock block = page_in.defined_css_blocks[identifier];
            if (identifier == "") //skip, already written
                continue;
            result.append(block.CSSBlockGenerate());
        }
        if (true)
        {
            result.append("\t\t</style>\n");
        }
    }
    return result;
}

buffer PageGenerateStyle()
{
    return Page().PageGenerateStyle();
}

buffer PageGenerate(Page page_in)
{
	buffer result;
	
	result.append("<!DOCTYPE html>\n"); //HTML 5 target
	result.append("<html>\n");
	
	//Head:
	result.append("\t<head>\n");
	result.append("\t\t<title>");
	result.append(page_in.title);
	result.append("</title>\n");
	if (page_in.head_contents.length() != 0)
	{
        result.append("\t\t");
		result.append(page_in.head_contents);
		result.append("\n");
	}
	//Write CSS styles:
    result.append(PageGenerateStyle(page_in));
    result.append("\t</head>\n");
	
	//Body:
	result.append("\t");
	result.HTMLAppendTagPrefix("body", page_in.body_attributes);
	result.append("\n\t\t");
	result.append(page_in.body_contents);
	result.append("\n");
		
	result.append("\t</body>\n");
	

	result.append("</html>");
	
	return result;
}

void PageGenerateAndWriteOut(Page page_in)
{
	write(PageGenerate(page_in));
}

buffer PageGenerateAsElementInBody(Page page_in)
{
	//In this mode, we don't generate an entire page - just one node in the body tag.
	//Includes style.
	
    buffer result;
    result.append(PageGenerateStyle(page_in));
    result.append(page_in.body_contents);
    return result;
}

buffer PageGenerateAsElementInBody()
{
	return Page().PageGenerateAsElementInBody();
}

void PageSetTitle(Page page_in, string title)
{
	page_in.title = title;
}

void PageAddCSSClass(Page page_in, string tag, string class_name, string definition, int importance, string block_identifier)
{
    //print_html("Adding block_identifier \"" + block_identifier + "\"");
    if (!(page_in.defined_css_blocks contains block_identifier))
        page_in.defined_css_blocks[block_identifier] = CSSBlockMake(block_identifier);
    page_in.defined_css_blocks[block_identifier].defined_css_classes.listAppend(CSSEntryMake(tag, class_name, definition, importance));
}

void PageAddCSSClass(Page page_in, string tag, string class_name, string definition, int importance)
{
    PageAddCSSClass(page_in, tag, class_name, definition, importance, "");
}

void PageAddCSSClass(Page page_in, string tag, string class_name, string definition)
{
    PageAddCSSClass(page_in, tag, class_name, definition, 0);
}


void PageWriteHead(Page page_in, string contents)
{
	page_in.head_contents.append(contents);
}

void PageWriteHead(Page page_in, buffer contents)
{
	page_in.head_contents.append(contents);
}


void PageWrite(Page page_in, string contents)
{
	page_in.body_contents.append(contents);
}

void PageWrite(Page page_in, buffer contents)
{
	page_in.body_contents.append(contents);
}

void PageSetBodyAttribute(Page page_in, string attribute, string value)
{
	page_in.body_attributes[attribute] = value;
}


//Global:

buffer PageGenerate()
{
	return PageGenerate(Page());
}

void PageGenerateAndWriteOut()
{
	write(PageGenerate());
}

void PageSetTitle(string title)
{
	PageSetTitle(Page(), title);
}

void PageAddCSSClass(string tag, string class_name, string definition)
{
	PageAddCSSClass(Page(), tag, class_name, definition);
}

void PageAddCSSClass(string tag, string class_name, string definition, int importance)
{
	PageAddCSSClass(Page(), tag, class_name, definition, importance);
}

void PageAddCSSClass(string tag, string class_name, string definition, int importance, string block_identifier)
{
	PageAddCSSClass(Page(), tag, class_name, definition, importance, block_identifier);
}

void PageWriteHead(string contents)
{
	PageWriteHead(Page(), contents);
}

void PageWriteHead(buffer contents)
{
	PageWriteHead(Page(), contents);
}

//Writes to body:

void PageWrite(string contents)
{
	PageWrite(Page(), contents);
}

void PageWrite(buffer contents)
{
	PageWrite(Page(), contents);
}

void PageSetBodyAttribute(string attribute, string value)
{
	PageSetBodyAttribute(Page(), attribute, value);
}


void PageInit()
{
	PageAddCSSClass("a", "r_a_undecorated", "text-decoration:none;color:inherit;");
	PageAddCSSClass("", "r_centre", "margin-left:auto; margin-right:auto;text-align:center;");
	PageAddCSSClass("", "r_bold", "font-weight:bold;");
	PageAddCSSClass("", "r_end_floating_elements", "clear:both;");
	
	
	PageAddCSSClass("", "r_element_stench", "color:green;");
	PageAddCSSClass("", "r_element_hot", "color:red;");
	PageAddCSSClass("", "r_element_cold", "color:blue;");
	PageAddCSSClass("", "r_element_sleaze", "color:purple;");
	PageAddCSSClass("", "r_element_spooky", "color:gray;");
    
    //50% desaturated versions of above:
	PageAddCSSClass("", "r_element_stench_desaturated", "color:#427F40;");
	PageAddCSSClass("", "r_element_hot_desaturated", "color:#FF7F81;");
	PageAddCSSClass("", "r_element_cold_desaturated", "color:#6B64FF;");
	PageAddCSSClass("", "r_element_sleaze_desaturated", "color:#7F407F;");
	PageAddCSSClass("", "r_element_spooky_desaturated", "color:gray;");
	
	PageAddCSSClass("", "r_indention", "margin-left:" + __setting_indention_width + ";");
	
	//Simple table lines:
	PageAddCSSClass("div", "r_stl_container", "display:table;");
	PageAddCSSClass("div", "r_stl_row", "display:table-row;");
    PageAddCSSClass("div", "r_stl_entry", "padding:0px;margin:0px;display:table-cell;padding-top:1px;padding-right:1em;border-bottom:1px solid " + __setting_line_colour + ";padding-bottom:1px;");
    PageAddCSSClass("div", "r_stl_entry_last_column", "padding-right:0em;");
    PageAddCSSClass("div", "r_stl_entry_last_row", "border-bottom:initial;padding-bottom:0px;");
    
    //PageAddCSSClass("div", "r_stl_spacer", "width:1em;");
}



string HTMLGenerateIndentedText(string text, string width)
{
	/*if (__use_table_based_layouts) //table-based layout
		return "<table cellpadding=0 cellspacing=0 width=100%><tr>" + HTMLGenerateTagWrap("td", "", mapMake("style", "width:" + width + ";")) + "<td>" + text + "</td></tr></table>";
	else //div-based layout:*/
	
    return HTMLGenerateDivOfClass(text, "r_indention");
}

string HTMLGenerateIndentedText(string [int] text)
{

	buffer building_text;
	foreach key in text
	{
		string line = text[key];
		building_text.append(HTMLGenerateDiv(line));
	}
	
	return HTMLGenerateIndentedText(to_string(building_text), __setting_indention_width);
}

string HTMLGenerateIndentedText(string text)
{
	return HTMLGenerateIndentedText(text, __setting_indention_width);
}


string HTMLGenerateSimpleTableLines(string [int][int] lines, boolean dividers_are_visible)
{
	buffer result;
	
	int max_columns = 0;
	foreach i in lines
	{
		max_columns = max(max_columns, lines[i].count());
	}
	
	/*if (__use_table_based_layouts)
	{
		//table-based layout:
		result.append("<table style=\"margin-right: 10px; width:100%;\" cellpadding=0 cellspacing=0>");
	
	
        int intra_i = 0;
		foreach i in lines
		{
            if (intra_i > 0)
            {
                result.append("<tr><td colspan=1000><hr></td></tr>");
            }
			result.append("<tr>");
			int intra_j = 0;
			foreach j in lines[i]
			{
				string entry = lines[i][j];
				result.append("<td align=");
				if (false && max_columns == 1)
					result.append("center");
				else if (intra_j == 0)
					result.append("left");
				else
					result.append("right");
				if (lines[i].count() < max_columns && intra_j == lines[i].count() - 1)
				{
					int calculated_colspan = max_columns - lines[i].count() + 1;
					result.append(" colspan=" + calculated_colspan);
				}
				result.append(">");
				result.append(entry);
				result.append("</td>");
				intra_j += 1;
			}
			result.append("</tr>");
            intra_i += 1;
		}
	
	
		result.append("</table>");
	}
	else*/
	if (true)
	{
		//div-based layout:
        //int intra_i = 0;
        //int last_cell_count = 0;
        result.HTMLAppendTagPrefix("div", "class", "r_stl_container");
		foreach i in lines
		{
            /*if (intra_i > 0)
            {
                result.HTMLAppendTagPrefix("div", "class", "r_stl_row");
                for i from 1 to last_cell_count //no colspan with display:table, generate extra (zero-padding, zero-margin) cells:
                {
                    string separator = "";
                    if (dividers_are_visible)
                        separator = "<hr>";
                    else
                        separator = "<hr style=\"opacity:0\">"; //laziness - generate an invisible HR, so there's still spacing
                    result.HTMLAppendDivOfClass(separator, "r_stl_entry");
                }
                result.append("</div>");
                last_cell_count = 0;
            }*/
            result.HTMLAppendTagPrefix("div", "class", "r_stl_row");
            //int intra_j = 0;
			foreach j in lines[i]
			{
				string entry = lines[i][j];
                /*if (intra_j > 0)
                {
                    //result.HTMLAppendDivOfClass("", "r_stl_entry r_stl_spacer");
                    //last_cell_count += 1;
                }*/
                string class_name = "r_stl_entry";
                if (j == lines[i].count() - 1)
                	class_name += " r_stl_entry_last_column";
                if (i == lines.count() - 1)
                	class_name += " r_stl_entry_last_row";
				result.HTMLAppendDivOfClass(entry, class_name);
                //last_cell_count += 1;
                
                //intra_j += 1;
			}
			
            result.append("</div>");
            //intra_i += 1;
		}
        result.append("</div>");
	}
	return result.to_string();
}

string HTMLGenerateSimpleTableLines(string [int][int] lines)
{
    return HTMLGenerateSimpleTableLines(lines, true);
}

string HTMLGenerateElementSpan(element e, string additional_text, boolean desaturated)
{
    string line = e;
    if (additional_text != "")
        line += " " + additional_text;
    return HTMLGenerateSpanOfClass(line, "r_element_" + e + (desaturated ? "_desaturated" : ""));
}

string HTMLGenerateElementSpan(element e, string additional_text)
{
    return HTMLGenerateElementSpan(e, additional_text, false);
}
string HTMLGenerateElementSpanDesaturated(element e, string additional_text)
{
    return HTMLGenerateElementSpan(e, additional_text, true);
}
string HTMLGenerateElementSpanDesaturated(element e)
{
    return HTMLGenerateElementSpanDesaturated(e, "");
}
//Moved to its own file because xcode was having a nightmare trying to parse this.

Record ServerImageStats
{
    int width;
    int height;
    int minimum_y_coordinate;
    int maximum_y_coordinate;
};

ServerImageStats ServerImageStatsMake(int width, int height, int minimum_y_coordinate, int maximum_y_coordinate)
{
    ServerImageStats result;
    result.width = width;
    result.height = height;
    result.minimum_y_coordinate = minimum_y_coordinate;
    result.maximum_y_coordinate = maximum_y_coordinate;
    return result;
}

ServerImageStats ServerImageStatsMake()
{
    return ServerImageStatsMake(-1,-1,-1,-1);
}


static
{
    //Rect [string] __minimum_bounding_box_of_image_url;
    int [string] __minimum_y_of_image_url;
    ServerImageStats [string] __server_image_stats;
    
    void initialiseMinimumBoundingBoxOfImageURL()
    {
        //Rect rm(int min_x, int min_y, int max_x, int max_y) { return RectMake(min_x, min_y, max_x, max_y); }
        //Vec2i vm(int x, int y) { return Vec2iMake(x, y); }
        //Rect test = rm(0,0,0,0);
        ServerImageStats im(int width, int height, int min_y, int max_y) { return ServerImageStatsMake(width, height, min_y, max_y); }
        ServerImageStats im(int min_y, int max_y) { return ServerImageStatsMake(100, 100, min_y, max_y); }
        
        ServerImageStats [string] ism;
        int [string] ysm;
        
ism["borgelf1.gif"] = im(11, 74);ism["borgelf4.gif"] = im(19, 82);ism["borgelf2.gif"] = im(25, 87);ism["borgelf3.gif"] = im(14, 78);ism["handymanjay.gif"] = im(5, 92);ism["1335.gif"] = im(7, 93);ism["miner.gif"] = im(1, 95);ism["foreman.gif"] = im(2, 94);ism["gremlinamc.gif"] = im(12, 78);ism["abcrusher.gif"] = im(12, 89);ism["adv_smart1.gif"] = im(0, 97);ism["lower_b.gif"] = im(16, 74);ism["electriceel.gif"] = im(1, 98);ism["1boy2cups.gif"] = im(2, 91);ism["advecho.gif"] = im(0, 99);ism["whitebat.gif"] = im(33, 70);ism["mar_alert.gif"] = im(0, 99);ism["alielf.gif"] = im(4, 95);ism["spelunkalien.gif"] = im(17, 81);ism["muthamster.gif"] = im(5, 95);ism["spelunkalienq.gif"] = im(150, 150, 17, 141);ism["spelunkufo.gif"] = im(21, 78);ism["steve.gif"] = im(0, 98);ism["catfish.gif"] = im(41, 91);ism["giant_alphabet.gif"] = im(1, 97);ism["elf_amateur.gif"] = im(10, 83);ism["ninja.gif"] = im(13, 85);ism["pirate2.gif"] = im(6, 93);ism["crimbominer3.gif"] = im(2, 97);ism["amokputty.gif"] = im(5, 84);ism["srpainting2.gif"] = im(20, 82);ism["regret3.gif"] = im(27, 79);ism["oldguardstatue.gif"] = im(0, 97);ism["pebbleman.gif"] = im(2, 89);ism["mariner.gif"] = im(5, 93);ism["protspirit.gif"] = im(7, 86);ism["guardstatue.gif"] = im(0, 98);ism["bb_horror.gif"] = im(125, 100, 5, 89);ism["anemone.gif"] = im(0, 97);ism["bb_doctor.gif"] = im(7, 83);ism["angel.gif"] = im(6, 87);ism["angerman.gif"] = im(200, 250, 15, 242);ism["anglerbush.gif"] = im(0, 97);ism["mh_bassist.gif"] = im(2, 97);ism["angbugbear.gif"] = im(6, 91);ism["bb_caveman.gif"] = im(4, 92);ism["mush_angry.gif"] = im(8, 89);ism["pinata.gif"] = im(0, 97);ism["madpoet.gif"] = im(7, 93);ism["raccoon.gif"] = im(6, 93);ism["hunter7.gif"] = im(0, 98);ism["stenchtourist.gif"] = im(0, 93);ism["nightstand2.gif"] = im(13, 91);ism["darkstand.gif"] = im(1, 98);ism["nightstand.gif"] = im(2, 96);ism["nightstand4.gif"] = im(1, 99);ism["fear2.gif"] = im(1, 95);ism["nightstand3.gif"] = im(7, 95);ism["spittoon.gif"] = im(3, 99);ism["smiley.gif"] = im(30, 67);ism["annoyfairy.gif"] = im(15, 76);ism["spiderserver.gif"] = im(7, 94);ism["lizardman.gif"] = im(4, 94);ism["aquabat.gif"] = im(150, 100, 15, 79);ism["aquaconda.gif"] = im(5, 91);ism["aquagoblin.gif"] = im(0, 99);ism["2headseal.gif"] = im(9, 81);ism["mush_armor.gif"] = im(7, 91);ism["adv_spooky4.gif"] = im(4, 96);ism["adv_stench3.gif"] = im(5, 95);ism["astronomer.gif"] = im(6, 93);ism["aquadargon.gif"] = im(200, 200, 6, 190);ism["elf_auteur.gif"] = im(15, 78);ism["disco_awkward.gif"] = im(4, 95);ism["axehandle.gif"] = im(9, 89);ism["axewound.gif"] = im(9, 87);ism["saucezombie.gif"] = im(0, 97);ism["stone_serpent.gif"] = im(0, 98);ism["stone_sheep.gif"] = im(21, 81);ism["baconsnake.gif"] = im(4, 96);ism["badascii.gif"] = im(35, 61);ism["pa_potatoes.gif"] = im(8, 95);ism["baglady.gif"] = im(0, 99);ism["warhipmo.gif"] = im(44, 98);ism["baiowulf.gif"] = im(8, 94);ism["spelunkbanana.gif"] = im(150, 150, 0, 149);ism["bangyomama.gif"] = im(2, 89);ism["banjowizard.gif"] = im(0, 99);ism["banshee.gif"] = im(6, 98);ism["bar.gif"] = im(13, 88);ism["ratsworth.gif"] = im(0, 96);ism["basaltamander.gif"] = im(0, 99);ism["ballbat.gif"] = im(7, 60);ism["reindeer.gif"] = im(0, 99);ism["basicgolem.gif"] = im(6, 89);ism["spelunkbat.gif"] = im(15, 77);ism["bb_bat.gif"] = im(27, 81);ism["adv_spooky3.gif"] = im(1, 93);ism["batrat.gif"] = im(25, 75);ism["snakeboss5.gif"] = im(150, 150, 13, 141);ism["bb_mech.gif"] = im(1, 98);ism["aboo_wars.gif"] = im(3, 98);ism["gremlinbat.gif"] = im(11, 83);ism["bazookafish.gif"] = im(25, 68);ism["beanbat.gif"] = im(28, 63);ism["topi2.gif"] = im(9, 93);ism["earbeast.gif"] = im(14, 80);ism["eyebeast.gif"] = im(17, 99);ism["beaver.gif"] = im(13, 77);ism["spelunkbee.gif"] = im(3, 86);ism["beeswarm.gif"] = im(3, 97);ism["beethoven.gif"] = im(5, 94);ism["beebeegunner.gif"] = im(16, 70);ism["beebeeking.gif"] = im(16, 79);ism["beebeequeue.gif"] = im(4, 97);ism["beefybat.gif"] = im(18, 58);ism["beelephant.gif"] = im(0, 89);ism["batter.gif"] = im(0, 99);ism["warfratbg.gif"] = im(0, 95);ism["straw_stench.gif"] = im(15, 93);ism["bellhop.gif"] = im(17, 89);ism["carpet.gif"] = im(33, 75);ism["novelist.gif"] = im(2, 92);ism["wraith2.gif"] = im(15, 89);ism["biclops.gif"] = im(4, 92);ism["spider1.gif"] = im(15, 78);ism["bigmeat.gif"] = im(0, 94);ism["whelps2.gif"] = im(1, 98);ism["twins_bigwheel.gif"] = im(200, 100, 5, 95);ism["aquaniewski.gif"] = im(0, 97);ism["bigface.gif"] = im(14, 92);ism["vib2.gif"] = im(3, 97);ism["blimp.gif"] = im(8, 94);ism["blackadder.gif"] = im(12, 79);ism["blackcat.gif"] = im(4, 90);ism["cray_beast.gif"] = im(200, 200, 41, 171);ism["cray_bug.gif"] = im(200, 200, 43, 152);ism["cray_const.gif"] = im(200, 200, 15, 193);ism["cray_elf.gif"] = im(200, 200, 22, 181);ism["cray_demon.gif"] = im(200, 200, 32, 178);ism["cray_elemental.gif"] = im(200, 200, 8, 191);ism["cray_fish.gif"] = im(200, 200, 30, 145);ism["cray_plant.gif"] = im(200, 200, 9, 184);ism["cray_orc.gif"] = im(200, 200, 32, 169);ism["cray_goblin.gif"] = im(200, 200, 32, 167);ism["cray_construct.gif"] = im(200, 200, 23, 183);ism["cray_hippy.gif"] = im(200, 200, 19, 163);ism["cray_hobo.gif"] = im(200, 200, 1, 198);ism["cray_dude.gif"] = im(200, 200, 7, 182);ism["cray_humanoid.gif"] = im(200, 200, 12, 188);ism["cray_merkin.gif"] = im(200, 200, 17, 172);ism["cray_penguin.gif"] = im(200, 200, 31, 185);ism["cray_pirate.gif"] = im(200, 200, 18, 179);ism["cray_horror.gif"] = im(200, 200, 1, 197);ism["cray_slime.gif"] = im(200, 200, 61, 166);ism["cray_weird.gif"] = im(200, 200, 27, 186);ism["cray_undead.gif"] = im(200, 200, 22, 162);ism["blackfriar.gif"] = im(5, 97);ism["blknight.gif"] = im(4, 90);ism["witchywoman.gif"] = im(1, 99);ism["bb_ninja.gif"] = im(5, 91);ism["panther.gif"] = im(11, 93);ism["blpudding.gif"] = im(47, 98);ism["blackwidow.gif"] = im(0, 99);ism["pengblackop.gif"] = im(3, 98);ism["blackbush.gif"] = im(15, 98);ism["sawblade.gif"] = im(0, 98);ism["firebat.gif"] = im(1, 97);ism["squid.gif"] = im(3, 95);ism["bluecultist.gif"] = im(0, 99);ism["mh_bluehair.gif"] = im(1, 98);ism["blur.gif"] = im(4, 97);ism["boaraffe.gif"] = im(0, 99);ism["naskar2.gif"] = im(5, 95);ism["bogleech.gif"] = im(10, 91);ism["bogskeleton.gif"] = im(1, 95);ism["bogart.gif"] = im(11, 91);ism["elf_boltcutters.gif"] = im(5, 78);ism["foss_wyrm.gif"] = im(200, 200, 0, 196);ism["bookbat.gif"] = im(22, 65);ism["boothslime.gif"] = im(2, 97);ism["bootycrab.gif"] = im(20, 85);ism["boozegiant.gif"] = im(5, 92);ism["borgabeeping.gif"] = im(0, 96);ism["bossbat.gif"] = im(26, 73);ism["deadbossbat.gif"] = im(7, 94);ism["crimonster3.gif"] = im(4, 96);ism["cricket.gif"] = im(5, 97);ism["box.gif"] = im(9, 87);ism["pa_muffin.gif"] = im(13, 87);ism["mystwander5.gif"] = im(5, 99);ism["broombrain.gif"] = im(6, 95);ism["bram.gif"] = im(8, 92);ism["breadgolem.gif"] = im(6, 90);ism["breakdancer.gif"] = im(0, 97);ism["brick_sleaze.gif"] = im(24, 96);ism["brick_cold.gif"] = im(1, 95);ism["brick_hot.gif"] = im(0, 99);
ism["brick_spooky.gif"] = im(4, 95);ism["kok_tender.gif"] = im(21, 97);ism["brick_stench.gif"] = im(4, 94);ism["brickoairship.gif"] = im(300, 300, 6, 295);ism["brickobat.gif"] = im(3, 68);ism["brickocathedral.gif"] = im(500, 450, 17, 443);ism["brickoelephant.gif"] = im(150, 150, 34, 132);ism["brickogchicken.gif"] = im(600, 450, 15, 444);ism["brickoctopus.gif"] = im(150, 150, 9, 143);ism["brickoblob.gif"] = im(57, 94);ism["brickooyster.gif"] = im(16, 91);ism["brickopython.gif"] = im(450, 100, 11, 87);ism["brickoturtle.gif"] = im(22, 77);ism["brickovacuum.gif"] = im(200, 200, 17, 182);ism["casebat.gif"] = im(40, 63);ism["bath_bubble.gif"] = im(17, 76);ism["iceguy5.gif"] = im(0, 97);ism["broctopus.gif"] = im(0, 99);ism["bronzechef.gif"] = im(0, 99);ism["babyseal.gif"] = im(6, 84);ism["togafrat.gif"] = im(2, 96);ism["twins_bubble.gif"] = im(13, 94);ism["bb_ghost.gif"] = im(5, 89);ism["bb_captain.gif"] = im(150, 150, 3, 143);ism["bb_drone.gif"] = im(2, 97);ism["bb_mortician.gif"] = im(9, 91);ism["robosurgeon.gif"] = im(14, 88);ism["bb_science.gif"] = im(6, 88);ism["binbox.gif"] = im(4, 91);ism["bugbugbear.gif"] = im(6, 91);ism["bulletbill.gif"] = im(15, 83);ism["bullseal.gif"] = im(9, 95);ism["ratbunch.gif"] = im(1, 92);ism["pa_meat.gif"] = im(5, 96);ism["bunsen.gif"] = im(9, 87);ism["sidekick.gif"] = im(5, 97);ism["adv_hot3.gif"] = im(18, 95);ism["snakeboss4.gif"] = im(150, 150, 19, 133);ism["bishop.gif"] = im(54, 94);ism["bush.gif"] = im(8, 93);ism["bushippy.gif"] = im(8, 94);ism["hedgerow.gif"] = im(25, 79);ism["pa_knife.gif"] = im(1, 87);ism["buzzerker.gif"] = im(11, 84);ism["buzzy.gif"] = im(0, 97);ism["chum1.gif"] = im(7, 91);ism["chumchief.gif"] = im(7, 94);ism["carnivore.gif"] = im(6, 96);ism["animbear.gif"] = im(0, 99);ism["laundrycabinet.gif"] = im(1, 98);ism["cactuary.gif"] = im(0, 97);ism["cakelord.gif"] = im(0, 98);ism["cameltoe.gif"] = im(5, 97);ism["cancan.gif"] = im(4, 97);ism["pecantree.gif"] = im(1, 98);ism["yamgolem.gif"] = im(0, 97);ism["gourd_cangoblin.gif"] = im(9, 88);ism["carbuncletop.gif"] = im(1, 92);ism["cargocrab.gif"] = im(7, 94);ism["dillplant.gif"] = im(2, 99);ism["carniv.gif"] = im(5, 94);ism["pa_eggs.gif"] = im(22, 86);ism["thecastle.gif"] = im(21, 78);ism["catalien.gif"] = im(21, 89);ism["spelunkcaveman.gif"] = im(7, 91);ism["cavedan.gif"] = im(0, 97);ism["cavefrat.gif"] = im(2, 95);ism["cavehippy.gif"] = im(0, 97);ism["cavesorority.gif"] = im(0, 95);ism["cavewomyn.gif"] = im(0, 94);ism["butt.gif"] = im(16, 81);ism["pengcement.gif"] = im(2, 97);ism["centurion.gif"] = im(7, 80);ism["adv_hot2.gif"] = im(2, 96);ism["chimp.gif"] = im(6, 90);ism["chalkdust.gif"] = im(6, 98);ism["hunter10.gif"] = im(1, 97);ism["c10chatty.gif"] = im(0, 96);ism["strix.gif"] = im(4, 93);ism["adv_stench2.gif"] = im(1, 97);ism["adv_fast1.gif"] = im(4, 93);ism["chefboy.gif"] = im(0, 98);ism["chester.gif"] = im(1, 97);ism["robotceo.gif"] = im(5, 92);ism["chocohare.gif"] = im(23, 93);ism["ccprairie.gif"] = im(1, 97);ism["soupgolem.gif"] = im(3, 93);ism["ciggirl.gif"] = im(0, 99);ism["animelf3.gif"] = im(19, 80);ism["cavebars.gif"] = im(0, 98);ism["clancy.gif"] = im(9, 94);ism["bathtub.gif"] = im(50, 97);ism["claygolem.gif"] = im(1, 98);ism["aboo_wiz.gif"] = im(3, 96);ism["cleanroomdemon.gif"] = im(5, 95);ism["cleanpirate.gif"] = im(3, 94);ism["girlpirate.gif"] = im(7, 91);ism["colaoff1.gif"] = im(4, 94);ism["colasol1.gif"] = im(6, 96);ism["rock_hopper.gif"] = im(0, 99);ism["whiskers.gif"] = im(8, 84);ism["clubfish.gif"] = im(1, 90);ism["prim_bact.gif"] = im(0, 98);ism["coaltergeist.gif"] = im(5, 91);ism["kg_oven.gif"] = im(8, 97);ism["spelunkcobra.gif"] = im(14, 77);ism["cocktailshrimp.gif"] = im(0, 99);ism["dvcoldbear1.gif"] = im(3, 97);ism["coldcutter.gif"] = im(2, 94);ism["dvcoldghost1.gif"] = im(0, 96);ism["coldhobo1.gif"] = im(5, 89);ism["wood_cold.gif"] = im(13, 96);ism["dvcoldskel1.gif"] = im(1, 95);ism["dvcoldvamp1.gif"] = im(3, 94);ism["dvcoldwolf1.gif"] = im(1, 98);ism["dvcoldzom1.gif"] = im(5, 98);ism["minegolem.gif"] = im(4, 89);ism["spider2.gif"] = im(20, 83);ism["pianist.gif"] = im(0, 98);ism["lilgoth.gif"] = im(19, 96);ism["2zombies.gif"] = im(6, 92);ism["conhippy.gif"] = im(2, 94);ism["regret1.gif"] = im(2, 90);ism["pa_cutter.gif"] = im(21, 76);ism["crimonster2.gif"] = im(0, 99);ism["coolerwino.gif"] = im(0, 97);ism["coppertender.gif"] = im(6, 91);ism["fatzombie.gif"] = im(9, 93);ism["prim_alga.gif"] = im(0, 98);ism["makeupwraith.gif"] = im(11, 81);ism["bakula.gif"] = im(7, 90);ism["drunkula.gif"] = im(100, 175, 5, 166);ism["drunkula_hm.gif"] = im(300, 175, 2, 159);ism["courtesan.gif"] = im(5, 95);ism["cowskeleton.gif"] = im(1, 97);ism["creep.gif"] = im(13, 91);ism["craggybart.gif"] = im(3, 91);ism["crate.gif"] = im(10, 89);ism["stone_raven.gif"] = im(21, 85);ism["bastard.gif"] = im(3, 94);ism["adv_smooth2.gif"] = im(3, 94);ism["clown.gif"] = im(3, 97);ism["creepydoll.gif"] = im(4, 96);ism["dianoga.gif"] = im(11, 87);ism["twins_ginger.gif"] = im(1, 98);ism["creepygirl.gif"] = im(32, 97);ism["pa_torch.gif"] = im(3, 92);ism["crimbomega.gif"] = im(400, 550, 7, 545);ism["spelunkcroc.gif"] = im(6, 89);ism["croqueteer.gif"] = im(1, 90);ism["dustmote.gif"] = im(20, 86);ism["hippy3.gif"] = im(8, 94);ism["crustpirate.gif"] = im(1, 95);ism["crys_rock.gif"] = im(200, 150, 2, 137);ism["cubistbull.gif"] = im(0, 99);ism["spelunkhawk.gif"] = im(3, 95);ism["curmpirate.gif"] = im(6, 93);ism["cybercop.gif"] = im(2, 97);ism["prim_cyru.gif"] = im(0, 98);ism["dad_machine.gif"] = im(400, 300, 6, 294);ism["daftpunk.gif"] = im(3, 97);ism["biggoat.gif"] = im(2, 98);ism["ooze.gif"] = im(45, 93);ism["dirtyape.gif"] = im(0, 99);ism["mush_dancing.gif"] = im(11, 91);ism["chad.gif"] = im(3, 93);ism["rorshach.gif"] = im(8, 79);ism["bath_showerhead.gif"] = im(2, 97);ism["venomtrout.gif"] = im(47, 99);ism["vice.gif"] = im(20, 85);ism["shiv_dead.gif"] = im(3, 94);ism["deathray.gif"] = im(4, 98);ism["lumberjack.gif"] = im(5, 92);ism["whiteshark.gif"] = im(15, 71);ism["5_4a.gif"] = im(200, 200, 0, 197);ism["demfridge.gif"] = im(1, 99);ism["jigsaw.gif"] = im(12, 83);ism["demoninja.gif"] = im(17, 89);ism["liana.gif"] = im(13, 90);ism["wanderacc1.gif"] = im(1, 97);ism["hunter8.gif"] = im(0, 97);ism["goldfarmer.gif"] = im(9, 91);ism["smoochboss4.gif"] = im(100, 200, 11, 191);ism["spelunkdevil.gif"] = im(0, 99);ism["digitalug.gif"] = im(17, 87);ism["dinnertroll.gif"] = im(13, 87);ism["direpigeon.gif"] = im(0, 98);ism["hippy2.gif"] = im(8, 93);ism["dirtyoldlihc.gif"] = im(6, 99);ism["bandit.gif"] = im(1, 95);ism["dinbox.gif"] = im(16, 91);ism["c10files.gif"] = im(7, 98);ism["divingbelle.gif"] = im(0, 99);ism["js_oh.gif"] = im(5, 91);ism["pede.gif"] = im(20, 81);ism["dogalien.gif"] = im(3, 92);ism["catdog.gif"] = im(17, 85);ism["iceguy2.gif"] = im(8, 97);ism["doncrimbo.gif"] = im(0, 99);ism["donerbagon.gif"] = im(200, 200, 1, 189);ism["dwarf_dopey.gif"] = im(0, 99);ism["doubtman.gif"] = im(200, 200, 2, 193);ism["doughbat.gif"] = im(41, 63);ism["aquard.gif"] = im(0, 99);ism["drawkward.gif"] = im(4, 95);ism["braddarb.gif"] = im(5, 96);ism["droll.gif"] = im(18, 87);ism["dropbase.gif"] = im(12, 80);ism["drownedsailor.gif"] = im(1, 97);ism["drownedbeat.gif"] = im(0, 95);ism["ducknicedrunk.gif"] = im(1, 94);ism["drunkgoat.gif"] = im(2, 98);ism["pyg_drunk.gif"] = im(9, 99);ism["drunkminer.gif"] = im(0, 98);ism["hobo.gif"] = im(5, 91);ism["rat.gif"] = im(33, 67);ism["ratking.gif"] = im(200, 200, 7, 185);ism["kok_drunk.gif"] = im(0, 93);ism["zomhobo.gif"] = im(5, 91);ism["aboo_dipshit.gif"] = im(1, 97);ism["straw_spooky.gif"] = im(39, 91);ism["dwarfgnome.gif"] = im(17, 84);ism["dweebie.gif"] = im(5, 94);ism["colaoff2.gif"] = im(4, 94);ism["colasol2.gif"] = im(6, 96);ism["eve.gif"] = im(0, 93);ism["eagle.gif"] = im(0, 98);ism["ed.gif"] = im(1, 98);ism["ed2.gif"] = im(1, 98);ism["ed3.gif"] = im(1, 98);ism["ed4.gif"] = im(1, 98);ism["ed5.gif"] = im(1, 98);ism["ed6.gif"] = im(22, 98);ism["ed7.gif"] = im(46, 98);ism["edwing.gif"] = im(24, 83);ism["eldiablo.gif"] = im(0, 99);ism["elders.gif"] = im(11, 85);ism["submarine.gif"] = im(8, 86);ism["nightstand5.gif"] = im(22, 82);ism["topi3.gif"] = im(7, 90);ism["elfhobo1.gif"] = im(28, 97);ism["warfratbg2.gif"] = im(0, 95);ism["elp_and_cros.gif"] = im(300, 150, 5, 146);ism["skinyeti.gif"] = im(4, 90);ism["armor.gif"] = im(0, 98);ism["inflatiger.gif"] = im(7, 98);ism["c10confcall.gif"] = im(2, 94);ism["grayblob3.gif"] = im(150, 200, 21, 178);ism["cow.gif"] = im(0, 99);ism["adv_strong3.gif"] = im(9, 91);ism["gremlinglasses.gif"] = im(7, 94);ism["stairmaster.gif"] = im(12, 94);ism["mc_respect3.gif"] = im(4, 94);ism["mc_soy3.gif"] = im(0, 97);ism["mc_tofu3.gif"] = im(1, 98);ism["cultist.gif"] = im(3, 98);ism["mh_evilex.gif"] = im(0, 99);ism["oliveevil.gif"] = im(13, 85);ism["spagcult2.gif"] = im(1, 95);ism["spagcult3.gif"] = im(0, 99);ism["spagcult1.gif"] = im(0, 98);ism["spagcult2k.gif"] = im(1, 95);ism["spagcult4.gif"] = im(0, 99);ism["spagcult1k.gif"] = im(0, 98);ism["trumpetmariachi.gif"] = im(2, 97);ism["vihuelamariachi.gif"] = im(2, 96);ism["crimbominer1.gif"] = im(0, 99);ism["skihippy.gif"] = im(3, 94);ism["fratboard.gif"] = im(3, 91);ism["wcorcs.gif"] = im(0, 97);
ism["witchy2.gif"] = im(0, 99);ism["darkeye.gif"] = im(5, 91);ism["guai.gif"] = im(11, 85);ism["facworker4.gif"] = im(3, 95);ism["facworker3.gif"] = im(1, 97);ism["facworker1.gif"] = im(3, 97);ism["facworker2.gif"] = im(1, 93);ism["badskel1.gif"] = im(20, 84);ism["archfiend.gif"] = im(10, 84);ism["fallsfromsky.gif"] = im(100, 150, 2, 143);ism["fallsfromsky_hm.gif"] = im(200, 300, 7, 285);ism["jewels.gif"] = im(8, 82);ism["kobolds.gif"] = im(0, 97);ism["fandancer.gif"] = im(6, 91);ism["fanslime.gif"] = im(2, 94);ism["bathslug.gif"] = im(1, 98);ism["hunter5.gif"] = im(1, 98);ism["hunter9.gif"] = im(1, 93);ism["fearman.gif"] = im(200, 200, 12, 185);ism["bath_octopus.gif"] = im(0, 98);ism["wacken.gif"] = im(200, 200, 23, 186);ism["manyeyes.gif"] = im(4, 81);ism["felonia.gif"] = im(0, 98);ism["haiku2.gif"] = im(6, 91);ism["bath_pelican.gif"] = im(1, 97);ism["ferrelf.gif"] = im(5, 90);ism["finger.gif"] = im(2, 96);ism["asparagus.gif"] = im(9, 89);ism["mush_flaming.gif"] = im(0, 99);ism["duckskate.gif"] = im(2, 98);ism["filthworm2.gif"] = im(24, 75);ism["filthworm3.gif"] = im(19, 70);ism["hippy1.gif"] = im(8, 89);ism["stinkpirate1.gif"] = im(3, 97);ism["adv_hot1.gif"] = im(1, 97);ism["firetruck.gif"] = im(300, 150, 7, 145);ism["duckfirebreath.gif"] = im(7, 91);ism["fisherfish.gif"] = im(3, 97);ism["stinkpirate3.gif"] = im(1, 93);ism["giant_fitness.gif"] = im(9, 97);ism["bigskeleton5.gif"] = im(250, 100, 0, 99);ism["meatblob.gif"] = im(10, 79);ism["samurai.gif"] = im(0, 99);ism["flametroll.gif"] = im(1, 96);ism["flange.gif"] = im(12, 78);ism["flashypirate.gif"] = im(4, 94);ism["cvfleaman.gif"] = im(5, 90);ism["woodsman.gif"] = im(9, 96);ism["disco_flexible.gif"] = im(3, 97);ism["caveelf3.gif"] = im(25, 85);ism["horstray.gif"] = im(19, 89);ism["seagulls.gif"] = im(3, 91);ism["stabbats.gif"] = im(0, 97);ism["bunny.gif"] = im(49, 94);ism["gourd_fnord.gif"] = im(200, 200, 23, 171);ism["giant_foodie.gif"] = im(4, 97);ism["forspirit.gif"] = im(21, 74);ism["bigskeleton4.gif"] = im(200, 100, 0, 99);ism["mime.gif"] = im(0, 97);ism["artteacher.gif"] = im(4, 95);ism["accboss.gif"] = im(0, 98);ism["warfrata.gif"] = im(1, 96);ism["mush_freaked.gif"] = im(9, 91);ism["frenchturtle.gif"] = im(19, 72);ism["bonefish.gif"] = im(40, 97);ism["frog.gif"] = im(53, 99);ism["frosty.gif"] = im(0, 99);ism["straw_cold.gif"] = im(12, 91);ism["mystwander3.gif"] = im(8, 94);ism["duckfrozen.gif"] = im(2, 96);ism["snakeboss1.gif"] = im(150, 150, 21, 133);ism["fruitgolem.gif"] = im(8, 97);ism["anger3.gif"] = im(0, 99);ism["fudgemonkey2.gif"] = im(0, 99);ism["fudgeoyster.gif"] = im(0, 99);ism["fudgepoodle.gif"] = im(2, 96);ism["fudgevulture.gif"] = im(0, 99);ism["fudgeweasel.gif"] = im(11, 86);ism["bigmirror.gif"] = im(0, 99);ism["fun-gal1.gif"] = im(0, 99);ism["funkparticle.gif"] = im(8, 94);ism["solebrother.gif"] = im(19, 76);ism["stinkpirate2.gif"] = im(3, 96);ism["shiv_fur.gif"] = im(1, 94);ism["giant_furry.gif"] = im(0, 98);ism["gimp.gif"] = im(15, 90);ism["gamblinman.gif"] = im(1, 95);ism["muggers.gif"] = im(2, 98);ism["ganger.gif"] = im(16, 88);ism["garbagetourist.gif"] = im(3, 94);ism["gargantulihc.gif"] = im(1, 93);ism["ghuol_skinny.gif"] = im(16, 90);ism["gelcube.gif"] = im(12, 97);ism["generalseal.gif"] = im(150, 100, 2, 97);ism["duckgeneric.gif"] = im(4, 94);ism["merkinballer2.gif"] = im(1, 99);ism["smoochboss1.gif"] = im(100, 200, 8, 189);ism["phantom.gif"] = im(1, 95);ism["cvghost.gif"] = im(4, 92);ism["spelunkghost.gif"] = im(11, 91);ism["ghostminer.gif"] = im(1, 98);ism["elizabeth.gif"] = im(10, 86);ism["fernghost.gif"] = im(1, 92);ism["worker.gif"] = im(2, 94);ism["adv_spooky1.gif"] = im(8, 91);ism["ghuol_reg.gif"] = im(11, 85);ism["giantbee.gif"] = im(2, 84);ism["pterodactyl.gif"] = im(6, 91);ism["globe.gif"] = im(0, 95);ism["friedegg.gif"] = im(2, 82);ism["centipede.gif"] = im(21, 81);ism["moth.gif"] = im(5, 95);ism["isopod.gif"] = im(35, 95);ism["python.gif"] = im(4, 93);ism["bath_whale.gif"] = im(14, 82);ism["manyspiders.gif"] = im(1, 94);ism["watertentacle.gif"] = im(6, 93);ism["tweezers.gif"] = im(6, 93);ism["headpumpkin.gif"] = im(5, 96);ism["rubberspider.gif"] = im(15, 84);ism["sandworm.gif"] = im(2, 99);ism["giantskel.gif"] = im(0, 99);ism["tarantula.gif"] = im(1, 97);ism["giantsquid.gif"] = im(0, 98);ism["whelps3.gif"] = im(0, 99);ism["tardigrade.gif"] = im(4, 91);ism["zomfish.gif"] = im(2, 86);ism["crimonster5.gif"] = im(0, 92);ism["gingerbreadman.gif"] = im(0, 99);ism["gladiator.gif"] = im(1, 96);ism["juiceglass.gif"] = im(12, 87);ism["wood_hot.gif"] = im(3, 95);ism["ghuol_fat.gif"] = im(13, 87);ism["gnarlgnome.gif"] = im(9, 79);ism["gnasgnome.gif"] = im(6, 77);ism["gnefgnome.gif"] = im(12, 83);ism["dk_builder.gif"] = im(9, 97);ism["dk_cross.gif"] = im(3, 94);ism["dk_swatter.gif"] = im(3, 95);ism["dk_gearhead.gif"] = im(1, 97);ism["dk_piechef.gif"] = im(0, 99);ism["dk_plunger.gif"] = im(3, 93);ism["gnollmage.gif"] = im(3, 95);ism["dk_juggler.gif"] = im(1, 97);ism["dk_warchef.gif"] = im(0, 98);ism["gnomester.gif"] = im(5, 91);ism["gnugnome.gif"] = im(10, 84);ism["gourd_goblin.gif"] = im(7, 92);ism["goldenring.gif"] = im(17, 86);ism["goomba.gif"] = im(9, 89);ism["goosealaying.gif"] = im(0, 99);ism["1_4a.gif"] = im(200, 200, 2, 198);ism["1_1.gif"] = im(18, 93);ism["1_2.gif"] = im(10, 92);ism["1_3.gif"] = im(10, 93);ism["giant_goth.gif"] = im(3, 96);ism["gourami.gif"] = im(51, 93);ism["gov_agent.gif"] = im(11, 94);ism["scientist.gif"] = im(3, 95);ism["adv_stench1.gif"] = im(6, 97);ism["grasselemental.gif"] = im(0, 99);ism["grasspirate.gif"] = im(0, 95);ism["rober.gif"] = im(8, 91);ism["zomshovel.gif"] = im(4, 94);ism["adv_sleaze1.gif"] = im(3, 90);ism["duckgreasy.gif"] = im(0, 91);ism["wolfoftheair.gif"] = im(200, 150, 8, 136);ism["wolfoftheair_hm.gif"] = im(200, 150, 7, 135);ism["warhipgr.gif"] = im(5, 93);ism["porkbun.gif"] = im(14, 79);ism["gritpirate.gif"] = im(1, 97);ism["surv_grizzled.gif"] = im(3, 91);ism["wingedyeti.gif"] = im(200, 100, 0, 99);ism["groast.gif"] = im(5, 94);ism["grouchewie.gif"] = im(7, 90);ism["cultistgroup.gif"] = im(4, 96);ism["groupie.gif"] = im(16, 85);ism["dwarf_grumpy.gif"] = im(0, 99);ism["grungypirate.gif"] = im(11, 95);ism["guardturtle1.gif"] = im(29, 89);ism["plesio.gif"] = im(1, 98);ism["gurgle.gif"] = im(150, 100, 0, 99);ism["animturtle.gif"] = im(100, 120, 4, 118);ism["beeguy.gif"] = im(0, 96);ism["gothic.gif"] = im(4, 96);ism["adv_sleaze2.gif"] = im(6, 89);ism["drunkyam.gif"] = im(0, 99);ism["hamsterpus.gif"] = im(2, 88);ism["mariachi1.gif"] = im(2, 97);ism["shiv_hangman.gif"] = im(3, 93);ism["hunter12.gif"] = im(3, 97);ism["skullabra.gif"] = im(1, 91);ism["tureen.gif"] = im(6, 87);ism["crystalgolem.gif"] = im(1, 92);ism["heatseal.gif"] = im(0, 99);ism["warfratar2.gif"] = im(10, 88);ism["nachogolem.gif"] = im(0, 98);ism["hellion.gif"] = im(3, 95);ism["sealguard.gif"] = im(13, 95);ism["sealpup.gif"] = im(29, 81);ism["hepcat.gif"] = im(1, 98);ism["hunter6.gif"] = im(3, 96);ism["hermeticseal.gif"] = im(5, 88);ism["c10slideshow.gif"] = im(10, 89);ism["highpriest.gif"] = im(0, 99);ism["warbear31.gif"] = im(0, 99);ism["snakes.gif"] = im(2, 83);ism["hockeyelem.gif"] = im(6, 90);ism["hodgman.gif"] = im(1, 96);ism["holoarmy.gif"] = im(2, 92);ism["honeypot.gif"] = im(5, 92);ism["hooded.gif"] = im(4, 96);ism["stenchfamily.gif"] = im(4, 96);ism["prim_amoe.gif"] = im(0, 98);ism["dvhotbear1.gif"] = im(5, 94);ism["dvhotghost1.gif"] = im(4, 93);ism["hothobo1.gif"] = im(3, 92);ism["dvhotskel1.gif"] = im(13, 99);ism["dvhotvamp1.gif"] = im(0, 98);ism["dvhotwolf1.gif"] = im(12, 98);ism["dvhotzom1.gif"] = im(1, 98);ism["mimic4.gif"] = im(1, 97);ism["ghuol_huge.gif"] = im(5, 95);ism["giantmosquito.gif"] = im(0, 98);ism["iceguy1.gif"] = im(1, 98);ism["bridgetroll.gif"] = im(2, 97);ism["vib6.gif"] = im(7, 98);ism["caveelf2.gif"] = im(18, 73);ism["huntingseal.gif"] = im(9, 85);ism["poolghost.gif"] = im(0, 99);ism["hypnotist.gif"] = im(0, 97);ism["medicus.gif"] = im(3, 92);ism["bb_vamp.gif"] = im(3, 93);ism["adv_cold2.gif"] = im(0, 98);ism["icecreamtruck.gif"] = im(400, 150, 9, 142);ism["icecube.gif"] = im(12, 94);ism["iceskate.gif"] = im(4, 96);ism["adv_cold3.gif"] = im(8, 93);ism["mummycat.gif"] = im(1, 96);ism["illegal_alien.gif"] = im(24, 96);ism["vib3.gif"] = im(0, 99);ism["drunktofurkey.gif"] = im(0, 99);ism["seal_larva.gif"] = im(63, 93);ism["seal_baby.gif"] = im(47, 93);ism["meatbug.gif"] = im(7, 89);ism["inkubus.gif"] = im(7, 97);ism["mariachi2.gif"] = im(2, 91);ism["adv_strong2.gif"] = im(5, 92);ism["encount.gif"] = im(3, 93);ism["jacobsadder.gif"] = im(0, 99);ism["orquette1.gif"] = im(13, 86);ism["jamfish.gif"] = im(0, 98);ism["pilot.gif"] = im(3, 97);ism["jetski.gif"] = im(15, 94);ism["jockohomo.gif"] = im(0, 98);ism["merkindragger2.gif"] = im(1, 99);ism["doubt3.gif"] = im(0, 99);ism["orangutan.gif"] = im(8, 97);ism["scabie_jungle.gif"] = im(2, 92);ism["thejunk.gif"] = im(19, 86);ism["js_bender.gif"] = im(5, 91);ism["js_melter.gif"] = im(11, 95);ism["js_sharpener.gif"] = im(7, 90);ism["orquette2.gif"] = im(13, 86);ism["keese.gif"] = im(25, 66);ism["tooold.gif"] = im(1, 97);ism["clownfish.gif"] = im(22, 82);ism["killingbird.gif"] = im(0, 98);ism["adv_smart3.gif"] = im(15, 94);ism["snaknight.gif"] = im(0, 97);ism["wolfknight.gif"] = im(3, 97);ism["knight.gif"] = im(7, 91);ism["kg_accountant.gif"] = im(12, 98);ism["kg_alchemist.gif"] = im(15, 94);ism["kg_asstchef.gif"] = im(0, 99);ism["kg_bbqteam.gif"] = im(1, 99);ism["kg_beancounter.gif"] = im(12, 97);ism["kg_guard.gif"] = im(10, 94);ism["kg_guardcaptain.gif"] = im(10, 94);ism["zomelite.gif"] = im(6, 90);
ism["kg_embezzler.gif"] = im(12, 97);ism["kg_haremgirl.gif"] = im(15, 89);ism["kg_haremguard.gif"] = im(14, 94);ism["kg_king.gif"] = im(0, 98);ism["kg_madsci.gif"] = im(11, 91);ism["kg_madam.gif"] = im(16, 97);ism["kg_masterchef.gif"] = im(0, 99);ism["kg_mba.gif"] = im(16, 98);ism["kg_mutant.gif"] = im(13, 97);ism["kg_poseur.gif"] = im(28, 94);ism["kg_souschef.gif"] = im(0, 98);ism["kg_verymadsci.gif"] = im(15, 92);ism["slanding.gif"] = im(5, 91);ism["yeti.gif"] = im(1, 95);ism["koopa.gif"] = im(5, 93);ism["kublakhan.gif"] = im(5, 92);ism["adv_fast3.gif"] = im(4, 92);ism["limp.gif"] = im(8, 94);ism["labmonkey.gif"] = im(16, 91);ism["n00b.gif"] = im(6, 91);ism["lower_k.gif"] = im(7, 81);ism["headwolf.gif"] = im(0, 98);ism["grayblob2.gif"] = im(9, 93);ism["larrysignfield.gif"] = im(9, 95);ism["filthworm1.gif"] = im(49, 83);ism["laser.gif"] = im(9, 97);ism["lavagolem.gif"] = im(5, 89);ism["lavalamprey.gif"] = im(3, 95);ism["lavalos.gif"] = im(200, 300, 7, 290);ism["lavatory.gif"] = im(0, 98);ism["statbike.gif"] = im(2, 96);ism["linbox.gif"] = im(17, 91);ism["lemonfish.gif"] = im(17, 74);ism["adv_sleaze4.gif"] = im(3, 97);ism["lfruitgol.gif"] = im(33, 84);ism["licosnake.gif"] = im(5, 94);ism["lich.gif"] = im(3, 98);ism["bb_liquidmetal.gif"] = im(7, 92);ism["liquidmetal.gif"] = im(1, 97);ism["grayblob1.gif"] = im(40, 88);ism["canoeman.gif"] = im(13, 66);ism["wanderacc2.gif"] = im(1, 98);ism["pa_bread.gif"] = im(7, 95);ism["lobsterman.gif"] = im(1, 98);ism["lollicat.gif"] = im(12, 91);ism["lolligator.gif"] = im(18, 85);ism["lollipede.gif"] = im(11, 77);ism["lolliphaunt.gif"] = im(12, 91);ism["spelunklolm.gif"] = im(250, 300, 3, 269);ism["lollirus2.gif"] = im(9, 91);ism["vib5.gif"] = im(1, 97);ism["coalition.gif"] = im(2, 89);ism["soggyraven.gif"] = im(0, 99);ism["lordspooky.gif"] = im(7, 97);ism["lotswife.gif"] = im(1, 97);ism["lizardfish.gif"] = im(31, 61);ism["regret2.gif"] = im(1, 95);ism["kok_lovers.gif"] = im(5, 97);ism["lower_h.gif"] = im(13, 87);ism["catstatue.gif"] = im(15, 84);ism["lumbersup.gif"] = im(5, 92);ism["lumberjill.gif"] = im(5, 92);ism["lumberjuan.gif"] = im(0, 92);ism["4_4a.gif"] = im(200, 200, 13, 168);ism["4_1.gif"] = im(21, 70);ism["4_2.gif"] = im(19, 92);ism["4_3.gif"] = im(3, 97);ism["lynyrd.gif"] = im(9, 91);ism["skinner.gif"] = im(2, 96);ism["adv_strong1.gif"] = im(5, 94);ism["madbugbear.gif"] = im(6, 95);ism["prim_flag.gif"] = im(0, 98);ism["madwino.gif"] = im(6, 94);ism["madiator.gif"] = im(2, 96);ism["dragonfish.gif"] = im(0, 99);ism["mech.gif"] = im(1, 98);ism["spelunkmagma.gif"] = im(7, 84);ism["cropcircle.gif"] = im(2, 93);ism["hairclog.gif"] = im(0, 94);ism["magfield.gif"] = im(1, 93);ism["tofurkey.gif"] = im(2, 92);ism["maltliquorgolem.gif"] = im(0, 99);ism["mammon.gif"] = im(200, 200, 11, 193);ism["redbuttons.gif"] = im(1, 93);ism["audrey.gif"] = im(0, 98);ism["wraith5.gif"] = im(10, 90);ism["bandolero.gif"] = im(0, 99);ism["mar_bruiser.gif"] = im(4, 93);ism["mariachi3.gif"] = im(1, 96);ism["wraith3.gif"] = im(9, 88);ism["promoter.gif"] = im(2, 93);ism["wasp.gif"] = im(13, 96);ism["mayorghost.gif"] = im(200, 150, 3, 146);ism["mayorghost_hm.gif"] = im(200, 150, 5, 147);ism["beggar.gif"] = im(0, 98);ism["duckmeandrunk.gif"] = im(3, 96);ism["med_dung.gif"] = im(5, 94);ism["med_mugman.gif"] = im(3, 92);ism["med_muggirl.gif"] = im(5, 89);ism["med_potter.gif"] = im(3, 91);ism["med_strawman.gif"] = im(0, 97);ism["med_stucco.gif"] = im(12, 96);ism["mimic3.gif"] = im(11, 89);ism["cvmedusa.gif"] = im(4, 91);ism["megafrog.gif"] = im(15, 89);ism["vib1.gif"] = im(0, 98);ism["lawngnome1.gif"] = im(14, 80);ism["nemesisthug.gif"] = im(7, 90);ism["merkinalphabet.gif"] = im(6, 93);ism["merkinballer.gif"] = im(4, 98);ism["merkinswitcher.gif"] = im(4, 98);ism["merkinburglar.gif"] = im(1, 95);ism["merkindiver.gif"] = im(1, 95);ism["merkindrifter.gif"] = im(4, 98);ism["merkinhealer.gif"] = im(3, 95);ism["merkinjuicer.gif"] = im(4, 98);ism["merkinminer.gif"] = im(1, 95);ism["merkinmonitor.gif"] = im(6, 93);ism["merkindragger.gif"] = im(4, 98);ism["merkinposeur.gif"] = im(1, 95);ism["merkinpunisher.gif"] = im(1, 95);ism["merkinraider.gif"] = im(3, 95);ism["merkinresearcher.gif"] = im(6, 93);ism["merkinspear.gif"] = im(1, 95);ism["merkinscav.gif"] = im(1, 95);ism["merkinghost.gif"] = im(13, 85);ism["merkinteacher.gif"] = im(2, 99);ism["merkintippler.gif"] = im(1, 99);ism["merkintrainer.gif"] = im(4, 98);ism["mercenary.gif"] = im(6, 95);ism["pengmesmer.gif"] = im(3, 99);ism["adv_smart2.gif"] = im(6, 98);ism["adv_fast2.gif"] = im(1, 96);ism["lowerm.gif"] = im(9, 90);ism["minecrab.gif"] = im(0, 99);ism["mineboss2.gif"] = im(1, 96);ism["mineboss1.gif"] = im(2, 97);ism["mineworker1.gif"] = im(3, 92);ism["mineworker2.gif"] = im(3, 92);ism["twins_mism.gif"] = im(100, 200, 17, 198);ism["badportrait.gif"] = im(0, 98);ism["pengarson.gif"] = im(2, 97);ism["mobcapo.gif"] = im(8, 95);ism["pengcapo.gif"] = im(3, 98);ism["pengdemo.gif"] = im(2, 98);ism["pengthug.gif"] = im(2, 98);ism["peng_ent.gif"] = im(3, 98);ism["pengbook.gif"] = im(2, 98);ism["penggoon.gif"] = im(2, 98);ism["penggun.gif"] = im(3, 98);ism["pengchef.gif"] = im(3, 98);ism["pengpsycho.gif"] = im(3, 98);ism["pengracket.gif"] = im(3, 99);ism["pengsmasher.gif"] = im(0, 98);ism["hazmatpeng.gif"] = im(0, 98);ism["pengprano.gif"] = im(0, 99);ism["pengphone.gif"] = im(0, 98);ism["warhipar2.gif"] = im(6, 89);ism["modelskeleton.gif"] = im(1, 99);ism["modernzombie.gif"] = im(8, 91);ism["moyster.gif"] = im(7, 93);ism["moneybee.gif"] = im(11, 75);ism["elf_wrench.gif"] = im(17, 87);ism["monsterhearse.gif"] = im(250, 200, 22, 186);ism["boiler.gif"] = im(4, 95);ism["monty.gif"] = im(4, 95);ism["moonshriner.gif"] = im(0, 99);ism["fear1.gif"] = im(0, 99);ism["wraith1.gif"] = im(8, 83);ism["motherseal.gif"] = im(9, 91);ism["otherimages/slimetube/stboss.gif"] = im(30, 30, 29, 30);ism["motorhead.gif"] = im(2, 95);ism["mountainman.gif"] = im(3, 97);ism["lawngnome3.gif"] = im(1, 99);ism["lawngnome2.gif"] = im(26, 98);ism["mrcheeng.gif"] = im(0, 97);ism["mrchoch.gif"] = im(0, 98);ism["adv_strong4.gif"] = im(17, 91);ism["adv_cold4.gif"] = im(0, 99);ism["chemteacher.gif"] = im(0, 98);ism["swampturtle.gif"] = im(0, 99);ism["muff.gif"] = im(10, 78);ism["mumblebee.gif"] = im(27, 74);ism["spelunkmumm.gif"] = im(3, 92);ism["mush_beefy.gif"] = im(6, 89);ism["antlerelf.gif"] = im(12, 97);ism["elfblob.gif"] = im(5, 98);ism["elflimbs.gif"] = im(17, 97);ism["elfclaw.gif"] = im(25, 96);ism["mutantgila.gif"] = im(3, 96);ism["mutantsnake.gif"] = im(19, 95);ism["mutantcactus.gif"] = im(0, 96);ism["elfhulk.gif"] = im(3, 97);ism["alielephant.gif"] = im(10, 97);ism["mutantalielf.gif"] = im(1, 97);ism["bb_vassist.gif"] = im(3, 95);ism["nastybear.gif"] = im(1, 97);ism["fear3.gif"] = im(1, 99);ism["sorcform1.gif"] = im(0, 99);ism["sorcblob.gif"] = im(200, 200, 28, 197);ism["bigsaus.gif"] = im(39, 59);ism["warfratmd2.gif"] = im(2, 96);ism["navyseal.gif"] = im(0, 98);ism["giant_neckbeard.gif"] = im(3, 95);ism["neil.gif"] = im(6, 95);ism["flytrap.gif"] = im(0, 96);ism["mc_respect2.gif"] = im(0, 97);ism["mc_respect1.gif"] = im(0, 97);ism["snakenest.gif"] = im(8, 88);ism["newt.gif"] = im(43, 97);ism["emofrat.gif"] = im(0, 97);ism["ninjawaiter.gif"] = im(5, 95);ism["ninjarice.gif"] = im(7, 95);ism["snowman.gif"] = im(7, 95);ism["ninja_ass.gif"] = im(3, 91);ism["ninjamop.gif"] = im(10, 98);ism["ninjacloud.gif"] = im(3, 97);ism["nhobo1.gif"] = im(7, 94);ism["hunter2.gif"] = im(0, 99);ism["tropicalskel.gif"] = im(0, 98);ism["novia.gif"] = im(5, 99);ism["novio.gif"] = im(11, 97);ism["nurseshark.gif"] = im(15, 71);ism["whirlwind.gif"] = im(8, 91);ism["tourist.gif"] = im(9, 92);ism["octopus.gif"] = im(0, 96);ism["octorok.gif"] = im(10, 93);ism["headghost.gif"] = im(4, 94);ism["adv_stench4.gif"] = im(0, 97);ism["kg_offdutyguard.gif"] = im(13, 95);ism["officialseal.gif"] = im(17, 91);ism["oilbaron.gif"] = im(0, 99);ism["oilcartel2.gif"] = im(200, 100, 5, 97);ism["oilslick.gif"] = im(29, 61);ism["oiltycoon.gif"] = im(1, 99);ism["straw_sleaze.gif"] = im(37, 93);ism["olscratch.gif"] = im(2, 97);ism["noart.gif"] = im(7, 91);ism["dk_oneeye.gif"] = im(2, 95);ism["oneeyed.gif"] = im(4, 91);ism["fratboy.gif"] = im(2, 91);ism["fratskirt.gif"] = im(2, 91);ism["fratbong.gif"] = im(2, 91);ism["lilfratboy.gif"] = im(7, 86);ism["oscus.gif"] = im(5, 97);ism["bandsaw.gif"] = im(11, 87);ism["tableoutlaw.gif"] = im(8, 93);ism["outlawboss.gif"] = im(0, 97);ism["surv_overarmed.gif"] = im(0, 98);ism["pimp.gif"] = im(17, 90);ism["elpriest.gif"] = im(1, 97);ism["stonebros.gif"] = im(2, 96);ism["warfratpr.gif"] = im(19, 85);ism["ptowels.gif"] = im(0, 99);ism["hunter3.gif"] = im(1, 99);
ism["peanut.gif"] = im(0, 98);ism["mh_roommate.gif"] = im(2, 97);ism["pencil.gif"] = im(5, 93);ism["smoochboss3.gif"] = im(100, 200, 17, 191);ism["defense_sphere.gif"] = im(3, 97);ism["pestopuddle.gif"] = im(46, 91);ism["perpbat.gif"] = im(5, 88);ism["bystander.gif"] = im(1, 96);ism["somepig.gif"] = im(3, 88);ism["pinebat.gif"] = im(33, 69);ism["piranhadon.gif"] = im(29, 97);ism["wood_stench.gif"] = im(3, 90);ism["adv_spooky2.gif"] = im(4, 95);ism["plaidghost.gif"] = im(7, 95);ism["plaque.gif"] = im(0, 99);ism["drunkcrancan.gif"] = im(1, 99);ism["drunkfrat.gif"] = im(1, 96);ism["animelf2.gif"] = im(20, 81);ism["poolter.gif"] = im(1, 97);ism["poolter2.gif"] = im(2, 98);ism["popnlocker.gif"] = im(0, 98);ism["porkbutterfly.gif"] = im(9, 88);ism["porksword.gif"] = im(17, 87);ism["adv_sleaze3.gif"] = im(8, 90);ism["abom.gif"] = im(6, 95);ism["crancan.gif"] = im(21, 95);ism["mystwander2.gif"] = im(9, 95);ism["mystwander1.gif"] = im(8, 95);ism["tomatosoup.gif"] = im(6, 89);ism["eyewash.gif"] = im(11, 91);ism["mystwander4.gif"] = im(1, 97);ism["mangler.gif"] = im(5, 95);ism["organ.gif"] = im(1, 99);ism["silverware.gif"] = im(0, 99);ism["toybox.gif"] = im(7, 89);ism["winerack.gif"] = im(4, 98);ism["question.gif"] = im(0, 86);ism["pouooze.gif"] = im(33, 88);ism["primp.gif"] = im(7, 90);ism["fly.gif"] = im(4, 92);ism["surv_primitive.gif"] = im(2, 91);ism["chalmers.gif"] = im(1, 98);ism["bigskeleton.gif"] = im(0, 98);ism["giant_procrast.gif"] = im(5, 98);ism["profjacking.gif"] = im(2, 96);ism["elf_propaganda.gif"] = im(11, 84);ism["protag.gif"] = im(6, 95);ism["protspect.gif"] = im(0, 99);ism["spurt.gif"] = im(0, 99);ism["elf_provocateur.gif"] = im(10, 83);ism["pterodact.gif"] = im(250, 150, 14, 136);ism["pufferfish.gif"] = im(0, 98);ism["pumpedbass.gif"] = im(17, 69);ism["shiv_pumpkin.gif"] = im(6, 97);ism["giant_punk.gif"] = im(0, 98);ism["pyg_squad.gif"] = im(0, 99);ism["pyg_blowgunner.gif"] = im(31, 99);ism["pyg_bowler.gif"] = im(29, 98);ism["pyg_headhunter.gif"] = im(28, 99);ism["pyg_janitor.gif"] = im(41, 99);ism["pyg_orderlies.gif"] = im(18, 98);ism["pyg_shaman.gif"] = im(24, 97);ism["pyg_acct.gif"] = im(33, 99);ism["pyg_lawyer.gif"] = im(27, 98);ism["pyg_nurse.gif"] = im(20, 98);ism["pyg_surgeon.gif"] = im(21, 99);ism["wood_spooky.gif"] = im(28, 90);ism["animelf4.gif"] = im(19, 78);ism["upper_q.gif"] = im(8, 88);ism["beequeen.gif"] = im(13, 87);ism["spelunkbeeq.gif"] = im(200, 150, 5, 149);ism["filthworm4.gif"] = im(0, 97);ism["qbasicele.gif"] = im(0, 97);ism["healer.gif"] = im(9, 93);ism["wanderacc3.gif"] = im(0, 99);ism["mmoaddict.gif"] = im(12, 94);ism["naskar1.gif"] = im(5, 95);ism["weightrack.gif"] = im(27, 95);ism["elf_raconteur.gif"] = im(7, 80);ism["radiator.gif"] = im(0, 99);ism["hunter13.gif"] = im(7, 93);ism["anger1.gif"] = im(0, 99);ism["ragingbull.gif"] = im(2, 94);ism["adding.gif"] = im(2, 89);ism["mh_scenester.gif"] = im(1, 96);ism["ratbat.gif"] = im(19, 67);ism["duckrattle.gif"] = im(2, 96);ism["smoochboss2.gif"] = im(100, 200, 13, 191);ism["raven.gif"] = im(18, 93);ism["giant_raver.gif"] = im(0, 99);ism["wallpaper.gif"] = im(17, 83);ism["foss_baboon.gif"] = im(1, 97);ism["foss_bat.gif"] = im(38, 69);ism["foss_demon.gif"] = im(150, 150, 2, 130);ism["foss_spider.gif"] = im(150, 150, 32, 130);ism["foss_serpent.gif"] = im(1, 96);ism["redbutler.gif"] = im(4, 95);ism["redfox.gif"] = im(5, 94);ism["redherring.gif"] = im(7, 94);ism["redskeleton.gif"] = im(5, 97);ism["redsnapper.gif"] = im(6, 90);ism["regretman.gif"] = im(200, 200, 9, 180);ism["regbat.gif"] = im(35, 66);ism["headlessskel.gif"] = im(15, 89);ism["mistress.gif"] = im(2, 99);ism["giant_renfair.gif"] = im(1, 97);ism["reneccorman.gif"] = im(1, 97);ism["doubt2.gif"] = im(6, 92);ism["kok_waiter.gif"] = im(2, 95);ism["revbugbear.gif"] = im(1, 98);ism["merkinswitcher2.gif"] = im(1, 99);ism["duckgolem.gif"] = im(2, 92);ism["rock_guy.gif"] = im(31, 96);ism["popweasel.gif"] = im(0, 99);ism["scorpion.gif"] = im(8, 91);ism["rock_snake.gif"] = im(1, 97);ism["caveelf1.gif"] = im(21, 78);ism["rock_fish.gif"] = im(24, 77);ism["rollerskate.gif"] = im(2, 92);ism["muse.gif"] = im(2, 96);ism["rollingstone.gif"] = im(4, 90);ism["roncopper.gif"] = im(3, 96);ism["realdolphin.gif"] = im(14, 92);ism["duckfat.gif"] = im(0, 99);ism["rudolfus.gif"] = im(3, 97);ism["rulergolem.gif"] = im(0, 99);ism["runningman.gif"] = im(2, 94);ism["bum.gif"] = im(8, 95);ism["elf_saboteur.gif"] = im(22, 79);ism["ferret.gif"] = im(2, 90);ism["toothgoat.gif"] = im(0, 95);ism["stkiwi.gif"] = im(8, 85);ism["lime.gif"] = im(15, 77);ism["sadiator.gif"] = im(3, 92);ism["safarijack.gif"] = im(1, 97);ism["salamander.gif"] = im(51, 97);ism["salaminder.gif"] = im(26, 88);ism["salaryninja.gif"] = im(4, 96);ism["pirate1.gif"] = im(6, 93);ism["adv_smooth1.gif"] = im(5, 92);ism["zompirate.gif"] = im(7, 93);ism["bb_scav.gif"] = im(7, 93);ism["gummifish.gif"] = im(0, 99);ism["schoolofmany.gif"] = im(3, 94);ism["wizardfish.gif"] = im(1, 99);ism["scimitarfish.gif"] = im(16, 73);ism["duckscorch.gif"] = im(0, 98);ism["spelunkscorp.gif"] = im(3, 89);ism["hunter4.gif"] = im(2, 92);ism["scoutseal.gif"] = im(12, 86);ism["screambat.gif"] = im(24, 79);ism["screwgolem.gif"] = im(3, 98);ism["seacow.gif"] = im(17, 73);ism["seacowboy.gif"] = im(0, 98);ism["adv_smooth4.gif"] = im(2, 95);ism["secrobot.gif"] = im(11, 87);ism["securityslime.gif"] = im(4, 96);ism["crimbominer2.gif"] = im(9, 81);ism["sadpoet.gif"] = im(5, 93);ism["atm.gif"] = im(7, 94);ism["serialbus.gif"] = im(1, 94);ism["grodseal.gif"] = im(3, 93);ism["fireservant1.gif"] = im(0, 99);ism["sewergator.gif"] = im(11, 78);ism["sewersnake.gif"] = im(5, 91);ism["sewertruck.gif"] = im(400, 150, 6, 143);ism["sororghost1.gif"] = im(1, 97);ism["sororeton1.gif"] = im(3, 89);ism["sororpire1.gif"] = im(7, 97);ism["sororwolf1.gif"] = im(6, 97);ism["sororbie1.gif"] = im(5, 95);ism["shadowseal.gif"] = im(8, 91);ism["sheetghost.gif"] = im(5, 95);ism["shopkeep.gif"] = im(7, 91);ism["shub-jigguwatt.gif"] = im(300, 300, 20, 283);ism["tacoelf_sign.gif"] = im(27, 94);ism["caveelf4.gif"] = im(14, 77);ism["sk8gnome.gif"] = im(23, 77);ism["boardskate.gif"] = im(3, 91);ism["animrat.gif"] = im(1, 93);ism["catskel.gif"] = im(20, 84);ism["hamskel.gif"] = im(73, 95);ism["monkeyskel.gif"] = im(17, 77);ism["crimonster6.gif"] = im(3, 95);ism["steward.gif"] = im(3, 97);ism["spelunkskel.gif"] = im(10, 91);ism["mopskeleton.gif"] = im(6, 96);ism["buttleton.gif"] = im(3, 97);ism["sketchyvan.gif"] = im(200, 100, 0, 99);ism["skinflute.gif"] = im(27, 76);ism["skeleton.gif"] = im(6, 93);ism["skullbat.gif"] = im(31, 66);ism["skulldozer.gif"] = im(450, 300, 12, 278);ism["skullery.gif"] = im(0, 97);ism["dvsleazebear1.gif"] = im(5, 89);ism["dvsleazeghost1.gif"] = im(11, 88);ism["slhobo1.gif"] = im(1, 97);ism["dvsleazeskel1.gif"] = im(9, 92);ism["dvsleazevamp1.gif"] = im(3, 96);ism["dvsleazewolf1.gif"] = im(2, 97);ism["dvsleazezom1.gif"] = im(4, 93);ism["kg_sleepingguard.gif"] = im(0, 98);ism["dwarf_sleepy.gif"] = im(37, 95);ism["mar_sleepy.gif"] = im(0, 99);ism["slime1_1.gif"] = im(0, 98);ism["slime2_1.gif"] = im(0, 96);ism["slime3_1.gif"] = im(2, 97);ism["slime4_1.gif"] = im(3, 95);ism["slime5_1.gif"] = im(0, 98);ism["wood_sleaze.gif"] = im(16, 79);ism["holglob.gif"] = im(34, 89);ism["slithering.gif"] = im(15, 81);ism["ssd_burger.gif"] = im(0, 99);ism["ssd_cocktail.gif"] = im(0, 98);ism["ssd_sundae.gif"] = im(1, 98);ism["eliot.gif"] = im(5, 97);ism["mimic2.gif"] = im(23, 87);ism["smartskel.gif"] = im(4, 94);ism["smellothewisp.gif"] = im(4, 98);ism["smokemonster.gif"] = im(5, 96);ism["smoochman3.gif"] = im(100, 150, 16, 127);ism["smoochman1.gif"] = im(7, 93);ism["smoochman2.gif"] = im(1, 97);ism["adv_smooth3.gif"] = im(3, 97);ism["scabie_jazz.gif"] = im(2, 89);ism["smutorc_jacker.gif"] = im(6, 95);ism["smutorc_nailer.gif"] = im(8, 96);ism["smutorc_pervert.gif"] = im(7, 93);ism["smutorc_layer.gif"] = im(5, 97);ism["smutorc_screwer.gif"] = im(9, 97);ism["spelunksnake.gif"] = im(20, 83);ism["firesnake.gif"] = im(0, 99);ism["snakeboss6.gif"] = im(150, 150, 26, 131);ism["snapdragon.gif"] = im(1, 98);ism["snowqueen.gif"] = im(0, 98);ism["adv_cold1.gif"] = im(9, 93);ism["sodium.gif"] = im(3, 92);ism["6_4a.gif"] = im(200, 200, 11, 189);ism["6_1.gif"] = im(10, 91);ism["6_2.gif"] = im(3, 96);ism["6_3.gif"] = im(2, 98);ism["sonofsailor.gif"] = im(1, 99);ism["warfratmd.gif"] = im(4, 96);ism["warfratcm.gif"] = im(1, 96);ism["tree_hickory.gif"] = im(0, 98);ism["drunkstuffing.gif"] = im(0, 99);ism["spacebeast1.gif"] = im(8, 83);ism["spacebeast3.gif"] = im(14, 91);ism["spacemarine.gif"] = im(1, 95);ism["aboo_trek.gif"] = im(1, 97);ism["3_4a.gif"] = im(200, 200, 3, 193);ism["3_1.gif"] = im(2, 95);ism["3_2.gif"] = im(4, 97);ism["3_3.gif"] = im(0, 93);ism["spamwitch.gif"] = im(3, 95);ism["pa_spatula.gif"] = im(7, 98);ism["wretchedseal.gif"] = im(54, 94);ism["hunter11.gif"] = im(3, 95);ism["jellyfish.gif"] = im(6, 96);ism["spelastronaut.gif"] = im(2, 96);ism["spelunkspider.gif"] = im(21, 88);ism["topi1.gif"] = im(3, 93);ism["gourd_spider.gif"] = im(10, 83);ism["gremlinspider.gif"] = im(7, 88);ism["spelunkspiderq.gif"] = im(150, 100, 1, 96);ism["gourd_spidergob.gif"] = im(1, 97);ism["spiderhut.gif"] = im(200, 150, 9, 140);ism["bb_spider.gif"] = im(125, 100, 3, 86);ism["spikeskel.gif"] = im(7, 92);ism["spiritalclock.gif"] = im(0, 99);ism["spiritbug.gif"] = im(10, 92);ism["spiritfaucet.gif"] = im(5, 93);ism["5_1.gif"] = im(3, 99);ism["5_2.gif"] = im(0, 99);ism["5_3.gif"] = im(0, 99);ism["spiritpea.gif"] = im(18, 78);ism["sponge.gif"] = im(0, 98);ism["dvspookybear1.gif"] = im(1, 95);ism["dvspookyghost1.gif"] = im(4, 94);ism["sgguard.gif"] = im(16, 77);ism["sgninja.gif"] = im(22, 80);ism["sgwarlock.gif"] = im(8, 83);ism["spookyhobo1.gif"] = im(3, 89);ism["mummy.gif"] = im(6, 89);ism["musicbox.gif"] = im(2, 90);ism["dvspookyskel1.gif"] = im(13, 97);ism["vampire.gif"] = im(10, 91);ism["dvspookyvamp1.gif"] = im(35, 65);ism["dvspookywolf1.gif"] = im(8, 94);ism["dvspookyzom1.gif"] = im(39, 93);ism["manor.gif"] = im(12, 89);ism["sporto.gif"] = im(1, 99);ism["princess.gif"] = im(8, 95);ism["steamelemental.gif"] = im(3, 94);ism["straw_hot.gif"] = im(5, 91);ism["giant_steampunk.gif"] = im(0, 99);ism["2_4a.gif"] = im(200, 200, 11, 189);ism["2_1.gif"] = im(10, 90);ism["2_2.gif"] = im(12, 96);ism["2_3.gif"] = im(16, 93);ism["dvstenchbear1.gif"] = im(1, 99);ism["dvstenchghost1.gif"] = im(0, 97);ism["stenchhobo1.gif"] = im(12, 97);ism["dvstenchskel1.gif"] = im(2, 99);ism["dvstenchvamp1.gif"] = im(0, 98);ism["dvstenchwolf1.gif"] = im(1, 99);ism["dvstenchzom1.gif"] = im(0, 98);ism["steven.gif"] = im(5, 91);
ism["stickymummy.gif"] = im(3, 94);ism["disco_stiff.gif"] = im(2, 91);ism["crimonster4.gif"] = im(3, 94);ism["stomper.gif"] = im(0, 99);ism["stone_pirate.gif"] = im(3, 93);ism["stormcow.gif"] = im(0, 99);ism["strangler.gif"] = im(1, 98);ism["algae.gif"] = im(1, 97);ism["crimboelf.gif"] = im(27, 96);ism["moosehead.gif"] = im(7, 93);ism["stuffgolem.gif"] = im(3, 91);ism["paulblart.gif"] = im(2, 99);ism["suckubus.gif"] = im(6, 92);ism["tree_juniper.gif"] = im(0, 99);ism["colasoldier.gif"] = im(1, 95);ism["supervirus.gif"] = im(9, 95);ism["witchy1.gif"] = im(0, 99);ism["mar_surprised.gif"] = im(0, 99);ism["mc_soy2.gif"] = im(0, 94);ism["mc_soy1.gif"] = im(0, 98);ism["beav_jack.gif"] = im(9, 92);ism["beav_shaman.gif"] = im(0, 97);ism["beav_warrior.gif"] = im(7, 90);ism["duckstinky.gif"] = im(0, 98);ism["swampentity.gif"] = im(5, 95);ism["swampgator.gif"] = im(19, 81);ism["swamphag.gif"] = im(0, 97);ism["swampowl.gif"] = im(0, 99);ism["swampskunk.gif"] = im(3, 95);ism["swarmers.gif"] = im(1, 95);ism["ralphbat.gif"] = im(2, 84);ism["ants.gif"] = im(1, 97);ism["fudgewasps.gif"] = im(0, 98);ism["whelps1.gif"] = im(10, 85);ism["aswarm.gif"] = im(7, 93);ism["kg_lice.gif"] = im(3, 93);ism["mutantants.gif"] = im(9, 87);ism["beatles.gif"] = im(5, 94);ism["skullswarm.gif"] = im(50, 93);ism["swisshen.gif"] = im(0, 98);ism["t9000.gif"] = im(3, 99);ism["cacotap.gif"] = im(21, 80);ism["tacofish.gif"] = im(17, 82);ism["tacoelf_taco.gif"] = im(12, 86);ism["tacoelf_cart.gif"] = im(9, 82);ism["kasemhead.gif"] = im(2, 96);ism["biggnat.gif"] = im(21, 70);ism["hatskel.gif"] = im(0, 99);ism["adv_fast4.gif"] = im(11, 86);ism["c10spreadsheet.gif"] = im(8, 98);ism["tektite.gif"] = im(21, 77);ism["skel10.gif"] = im(300, 100, 0, 98);ism["terrorbot.gif"] = im(5, 88);ism["tetched.gif"] = im(1, 98);ism["madpirate.gif"] = im(6, 93);ism["fudgeman.gif"] = im(200, 200, 19, 186);ism["theaquaman.gif"] = im(0, 99);ism["boris.gif"] = im(6, 89);ism["aojarls.gif"] = im(6, 93);ism["sneakypete.gif"] = im(13, 90);ism["batinspats.gif"] = im(200, 100, 6, 96);ism["beefhemoth.gif"] = im(200, 100, 0, 98);ism["c10bge.gif"] = im(11, 86);ism["thisdude.gif"] = im(0, 93);ism["c10faces.gif"] = im(0, 99);ism["beelzebozo.gif"] = im(0, 98);ism["colollilossus.gif"] = im(270, 270, 3, 264);ism["bath_craykin.gif"] = im(0, 99);ism["darkness.gif"] = im(0, 98);ism["theemperor.gif"] = im(5, 93);ism["skelmanager.gif"] = im(5, 97);ism["snakeboss2.gif"] = im(5, 94);ism["hunter15.gif"] = im(0, 92);ism["fudgewizard.gif"] = im(0, 99);ism["bunionghost.gif"] = im(4, 92);ism["thegunk.gif"] = im(3, 95);ism["hermit.gif"] = im(30, 30, 29, 30);ism["landscaper.gif"] = im(0, 99);ism["snitch.gif"] = im(150, 300, 13, 275);ism["adv_hot4.gif"] = im(10, 97);ism["theluter.gif"] = im(11, 93);ism["theman.gif"] = im(0, 94);ism["darkmariachi.gif"] = im(2, 97);ism["masterat.gif"] = im(40, 97);ism["adv_smart4.gif"] = im(13, 97);ism["thenuge.gif"] = im(4, 94);ism["rainking.gif"] = im(250, 300, 10, 287);ism["sagittarian.gif"] = im(3, 95);ism["theserver.gif"] = im(0, 97);ism["sierpinski.gif"] = im(0, 89);ism["snakeboss3.gif"] = im(150, 150, 5, 136);ism["timebandit.gif"] = im(9, 88);ism["thepinch.gif"] = im(100, 150, 4, 147);ism["thething.gif"] = im(250, 200, 3, 195);ism["thethorax.gif"] = im(200, 100, 4, 92);ism["c10tropes.gif"] = im(0, 99);ism["ukskeleton.gif"] = im(200, 200, 15, 187);ism["ukskeleton_hm.gif"] = im(200, 200, 2, 195);ism["unknownghost.gif"] = im(0, 99);ism["c10cooler.gif"] = im(0, 98);ism["wholekingdom.gif"] = im(200, 200, 2, 195);ism["they.gif"] = im(0, 99);ism["tnbot1.gif"] = im(1, 95);ism["bigskeleton3.gif"] = im(150, 100, 0, 99);ism["thug1thug2.gif"] = im(200, 100, 1, 93);ism["anger2.gif"] = im(0, 99);ism["tigerlily.gif"] = im(1, 96);ism["spelunktiki.gif"] = im(1, 93);ism["mc_tofu2.gif"] = im(2, 97);ism["mc_tofu1.gif"] = im(2, 95);ism["gourd_can.gif"] = im(14, 90);ism["gourd_canspider.gif"] = im(150, 100, 9, 87);ism["mimic1.gif"] = im(17, 83);ism["animelf1.gif"] = im(19, 79);ism["tipsypirate.gif"] = im(0, 98);ism["tpgeist.gif"] = im(0, 97);ism["shiv_tp.gif"] = im(6, 94);ism["tombasp.gif"] = im(0, 99);ism["mummybat.gif"] = im(34, 60);ism["tombrat.gif"] = im(33, 78);ism["tombratking.gif"] = im(200, 200, 17, 176);ism["tombguy.gif"] = im(0, 98);ism["mastiff.gif"] = im(34, 95);ism["toothpirate.gif"] = im(2, 96);ism["toothskel.gif"] = im(5, 90);ism["topiarychi.gif"] = im(2, 95);ism["topiaryduck.gif"] = im(10, 89);ism["topiary.gif"] = im(0, 98);ism["topiarygopher.gif"] = im(7, 93);ism["topiarykiwi.gif"] = im(17, 92);ism["tree_baobab.gif"] = im(3, 96);ism["c10tmz.gif"] = im(0, 99);ism["orquette3.gif"] = im(6, 92);ism["vib4.gif"] = im(2, 96);ism["toxbeast1.gif"] = im(2, 98);ism["animelf5.gif"] = im(18, 76);ism["crimonster1.gif"] = im(1, 98);ism["travoltron.gif"] = im(200, 200, 4, 197);ism["treadmill.gif"] = im(9, 91);ism["bb_chef.gif"] = im(5, 92);ism["triadwizard.gif"] = im(1, 96);ism["tribalgoblin.gif"] = im(11, 89);ism["trixiepixie.gif"] = im(6, 99);ism["triffid.gif"] = im(2, 96);ism["tarkinhead.gif"] = im(0, 98);ism["monahead.gif"] = im(0, 99);ism["twins_troll.gif"] = im(0, 98);ism["trollipop.gif"] = im(100, 150, 5, 145);ism["trophyfish.gif"] = im(0, 98);ism["tsnake.gif"] = im(5, 94);ism["tumbleweed.gif"] = im(4, 93);ism["turtlemech.gif"] = im(14, 89);ism["turtletrapper.gif"] = im(1, 95);ism["twigberry.gif"] = im(3, 89);ism["bigskeleton2.gif"] = im(0, 99);ism["tex.gif"] = im(0, 98);ism["unclehobo.gif"] = im(10, 92);ism["macaroni.gif"] = im(4, 84);ism["pengundercover.gif"] = im(2, 98);ism["shiv_underworld.gif"] = im(200, 200, 17, 170);ism["ellsburyboss.gif"] = im(150, 150, 15, 124);ism["lensgoblin.gif"] = im(3, 94);ism["surv_unhinged.gif"] = im(6, 95);ism["unholydiver.gif"] = im(0, 99);ism["surv_unlikely.gif"] = im(7, 89);ism["c10database.gif"] = im(2, 95);ism["unstill.gif"] = im(8, 92);ism["ram.gif"] = im(13, 85);ism["urchin.gif"] = im(10, 90);ism["eyesdown.gif"] = im(45, 62);ism["usher.gif"] = im(11, 88);ism["spelunkvampire.gif"] = im(13, 85);ism["vampclam.gif"] = im(11, 91);ism["duckvampire.gif"] = im(3, 95);ism["vandalkid.gif"] = im(9, 91);ism["cvcreature.gif"] = im(100, 200, 4, 196);ism["gremlinveg.gif"] = im(5, 93);ism["velvetug.gif"] = im(19, 91);ism["vendorslime.gif"] = im(0, 95);ism["turtleghost.gif"] = im(23, 84);ism["mantrap.gif"] = im(4, 97);ism["easel.gif"] = im(5, 95);ism["gnauga.gif"] = im(14, 92);ism["victor.gif"] = im(15, 88);ism["qmark.gif"] = im(4, 93);ism["gar.gif"] = im(6, 93);ism["prim_fung.gif"] = im(0, 98);ism["music.gif"] = im(2, 95);ism["iceguy4.gif"] = im(7, 98);ism["smallartist.gif"] = im(40, 97);ism["wimp.gif"] = im(15, 90);ism["wackypirate.gif"] = im(1, 97);ism["iceguy3.gif"] = im(1, 98);ism["mush_shrieking.gif"] = im(1, 93);ism["waiterninja.gif"] = im(5, 95);ism["wallofbones.gif"] = im(250, 150, 3, 138);ism["wallofskin.gif"] = im(250, 125, 1, 115);ism["warfratc.gif"] = im(1, 95);ism["warfrata2.gif"] = im(1, 96);ism["warfratb.gif"] = im(0, 95);ism["warfratc2.gif"] = im(1, 95);ism["warfratb2.gif"] = im(0, 95);ism["warfratsp2.gif"] = im(0, 97);ism["warfratgr.gif"] = im(5, 96);ism["warfratar.gif"] = im(5, 89);ism["warfratmo.gif"] = im(24, 89);ism["warfratgr2.gif"] = im(2, 91);ism["streaker.gif"] = im(3, 95);ism["warfratsp.gif"] = im(3, 98);ism["warhipb.gif"] = im(6, 96);ism["warhipac2.gif"] = im(1, 96);ism["warhipar.gif"] = im(0, 99);ism["warhipds.gif"] = im(8, 93);ism["warhipsh2.gif"] = im(0, 98);ism["warhipfs2.gif"] = im(3, 95);ism["warhipc2.gif"] = im(5, 94);ism["warhipa2.gif"] = im(0, 98);ism["warhipfs.gif"] = im(2, 94);ism["warhipb2.gif"] = im(6, 96);ism["warhipmd.gif"] = im(0, 90);ism["warhipa.gif"] = im(0, 98);ism["warhipmd2.gif"] = im(0, 91);ism["warhipc.gif"] = im(5, 92);ism["warhipsh.gif"] = im(1, 97);ism["warhipac.gif"] = im(5, 96);ism["hippyspy.gif"] = im(8, 89);ism["warhipcm.gif"] = im(2, 94);ism["warbear11.gif"] = im(2, 97);ism["warbear21.gif"] = im(0, 99);ism["nightstand1.gif"] = im(4, 96);ism["warehouseclerk.gif"] = im(2, 95);ism["warehouseguard.gif"] = im(0, 98);ism["warehousejanitor.gif"] = im(3, 92);ism["warehouseguy.gif"] = im(3, 94);ism["wartdinsey.gif"] = im(150, 150, 0, 148);ism["wartpirate.gif"] = im(2, 92);ism["werewolf.gif"] = im(4, 98);ism["wigwasp.gif"] = im(8, 93);ism["wastoid.gif"] = im(8, 93);ism["waterspider.gif"] = im(23, 80);ism["waterseal.gif"] = im(0, 99);ism["richpirate.gif"] = im(3, 93);ism["weatherug.gif"] = im(3, 91);ism["weremoose.gif"] = im(2, 90);ism["weretaco.gif"] = im(29, 82);ism["hunter14.gif"] = im(4, 95);ism["wetseal.gif"] = im(6, 80);
ism["aboo_who.gif"] = im(2, 97);ism["tree_willow.gif"] = im(2, 95);ism["surv_whiny.gif"] = im(3, 91);ism["pa_whisk.gif"] = im(4, 91);ism["whitebonedemon.gif"] = im(200, 100, 12, 98);ism["chocgolem.gif"] = im(9, 92);ism["whiteelephant.gif"] = im(11, 88);ism["lion.gif"] = im(6, 93);ism["zombie2.gif"] = im(5, 94);ism["whitesnake.gif"] = im(10, 87);ism["wildgirl.gif"] = im(0, 97);ism["seahorse.gif"] = im(4, 96);ism["wiresculpture.gif"] = im(0, 97);ism["elf_wires.gif"] = im(12, 89);ism["mush_wizard.gif"] = im(0, 99);ism["tree_magnolia.gif"] = im(1, 99);ism["wraith4.gif"] = im(14, 81);ism["doubt1.gif"] = im(0, 98);ism["ravendesk.gif"] = im(0, 94);ism["susguy.gif"] = im(1, 96);ism["wumpus.gif"] = im(0, 99);ism["beergolem.gif"] = im(4, 97);ism["stonegolem.gif"] = im(3, 97);ism["dimhorror.gif"] = im(2, 96);ism["shopteacher.gif"] = im(1, 98);ism["hydra.gif"] = im(6, 99);ism["polprisoner.gif"] = im(9, 89);ism["pr0n.gif"] = im(11, 87);ism["yakisoba.gif"] = im(0, 97);ism["yakcourier.gif"] = im(3, 96);ism["yakguard.gif"] = im(3, 96);ism["yeastbeast.gif"] = im(4, 93);ism["spelunkyeti.gif"] = im(1, 97);ism["yog-urt.gif"] = im(300, 300, 107, 290);ism["yomama.gif"] = im(300, 300, 3, 289);ism["c10inbox.gif"] = im(9, 94);ism["otherimages/shadows/20.gif"] = im(30, 30, 29, 30);ism["zrex.gif"] = im(150, 100, 0, 99);ism["zimmerman.gif"] = im(4, 98);ism["zombie.gif"] = im(3, 84);ism["zol.gif"] = im(11, 90);ism["zomlizard.gif"] = im(4, 94);ism["zmobaby.gif"] = im(2, 86);ism["zombiechef.gif"] = im(1, 97);ism["zomclown.gif"] = im(3, 97);ism["duckzombie.gif"] = im(1, 96);ism["zomsnow.gif"] = im(7, 91);ism["zomfrat.gif"] = im(12, 84);ism["zomknoll.gif"] = im(10, 87);ism["zomgoth.gif"] = im(0, 94);ism["zomhippy.gif"] = im(4, 92);ism["zombiehoa.gif"] = im(150, 150, 1, 148);ism["zombiehoa_hm.gif"] = im(200, 200, 0, 199);ism["zomchef.gif"] = im(1, 92);ism["zomnoob.gif"] = im(4, 93);ism["zomhealer.gif"] = im(1, 93);ism["zomwaltz.gif"] = im(0, 97);ism["zomyeast.gif"] = im(9, 98);ism["hunter1.gif"] = im(3, 96);ism["zombo.gif"] = im(0, 98);

        
        
        foreach s, v in ysm
        {
            __minimum_y_of_image_url["images/adventureimages/" + s] = v;
        }
        foreach s, v in ism
        {
            __server_image_stats["images/adventureimages/" + s] = v;
        }
    }
    initialiseMinimumBoundingBoxOfImageURL();
}


ServerImageStats ServerImageStatsOfImageURL(string url)
{
    if (__server_image_stats contains url)
    {
        return __server_image_stats[url];
    }
    return ServerImageStatsMake();
}

int KOLImageMinimumYOfImageURL(string url)
{
    if (__server_image_stats contains url)
    {
        return __server_image_stats[url].minimum_y_coordinate;
    }
    return 0;
}

boolean __setting_show_alignment_guides = false;
//Library for displaying KOL images
//Each image is referred to by a string via KOLImageLookup, or KOLImageGenerateImageHTML
//There's a list of pre-set images in KOLImagesInit. Otherwise, it tries to look up the string as an item, then as a familiar, and then as an effect. If any matches are found, that image is output. (uses KoLmafia's internal database)
//Also "__item item name", "__familiar familiar name", and "__effect effect name" explicitly request those images.
//"__half lookup name" will reduce the image to half-size.
//NOTE: To use KOLImageGenerateImageHTML with should_centre set to true, the page must have the class "r_centre" set as "margin-left:auto; margin-right:auto;text-align:center;"

record KOLImage
{
	string url;
	
	Vec2i base_image_size;
	Rect crop;
	
	Rect [int] erase_zones; //rectangular zones which are generated as white divs on the output. Erases specific sections of the image. Can be offset by one pixel depending on the browser, sorry.
};


KOLImage KOLImageMake(string url, Vec2i base_image_size, Rect crop)
{
	KOLImage result;
	result.url = url;
	result.base_image_size = base_image_size;
	result.crop = crop;
	return result;
}

KOLImage KOLImageMake(string url, Vec2i base_image_size)
{
	return KOLImageMake(url, base_image_size, RectZero());
}

KOLImage KOLImageMake(string url)
{
	return KOLImageMake(url, Vec2iZero(), RectZero());
}

KOLImage KOLImageMake()
{
	return KOLImageMake("", Vec2iZero(), RectZero());
}


static
{
    KOLImage [string] __kol_images;
    
    void initialiseConstantKOLImages()
    {
        KOLimage [string] building_images;
        building_images["typical tavern"] = KOLImageMake("images/otherimages/woods/tavern0.gif", Vec2iMake(100,100), RectMake(0,39,99,97));
        building_images["boss bat"] = KOLImageMake("images/adventureimages/bossbat.gif", Vec2iMake(100,100), RectMake(0,27,99,74));
        building_images["bugbear"] = KOLImageMake("images/adventureimages/fallsfromsky.gif", Vec2iMake(100,150));
        
        building_images["twin peak"] = KOLImageMake("images/otherimages/orcchasm/highlands_main.gif", Vec2iMake(500, 250), RectMake(153,128,237,214));
        building_images["a-boo peak"] = KOLImageMake("images/otherimages/orcchasm/highlands_main.gif", Vec2iMake(500, 250), RectMake(40,134,127,218));
        building_images["oil peak"] = KOLImageMake("images/otherimages/orcchasm/highlands_main.gif", Vec2iMake(500, 250), RectMake(261,117,345,213));
        building_images["highland lord"] = KOLImageMake("images/otherimages/orcchasm/highlands_main.gif", Vec2iMake(500, 250), RectMake(375,73,457,144));
        building_images["orc chasm"] = KOLImageMake("images/otherimages/mountains/chasm.gif", Vec2iMake(100, 100), RectMake(0, 41, 99, 95));
        
        building_images["spooky forest"] = KOLImageMake("images/otherimages/woods/forest.gif", Vec2iMake(100, 100), RectMake(12,39,91,93));
        building_images["council"] = KOLImageMake("images/otherimages/council.gif", Vec2iMake(100, 100), RectMake(0,26,99,73));
        
        
        building_images["daily dungeon"] = KOLImageMake("images/otherimages/town/dd1.gif", Vec2iMake(100,100), RectMake(28,44,71,86));
        building_images["clover"] = KOLImageMake("images/itemimages/clover.gif", Vec2iMake(30,30));
        
        building_images["mayfly bait"] = KOLImageMake("images/itemimages/mayflynecklace.gif", Vec2iMake(30,30));
        building_images["spooky putty"] = KOLImageMake("images/itemimages/sputtysheet.gif", Vec2iMake(30,30));
        
        building_images["fax machine"] = KOLImageMake("images/otherimages/clanhall/faxmachine.gif", Vec2iMake(100,100), RectMake(34,28,62,54));
        
        building_images["unknown"] = KOLImageMake("images/itemimages/confused.gif", Vec2iMake(30,30));
        
        building_images["goth kid"] = KOLImageMake("images/itemimages/crayongoth.gif", Vec2iMake(30,30));
        building_images["hipster"] = KOLImageMake("images/itemimages/minihipster.gif", Vec2iMake(30,30));
        
        
        building_images[""] = KOLImageMake("images/itemimages/blank.gif", Vec2iMake(30,30));
        building_images["blank"] = KOLImageMake("images/itemimages/blank.gif", Vec2iMake(30,30));
        building_images["demon summon"] = KOLImageMake("images/otherimages/manor/chamber.gif", Vec2iMake(100,100), RectMake(14, 12, 88, 66));
        
        building_images["cobb's knob"] = KOLImageMake("images/otherimages/plains/knob2.gif", Vec2iMake(100,100), RectMake(12,43,86,78));
        
        building_images["generic dwelling"] = KOLImageMake("images/otherimages/campground/rest4.gif", Vec2iMake(100,100), RectMake(0,26,95,99));
        
        
        building_images["forest friars"] = KOLImageMake("images/otherimages/woods/stones0.gif", Vec2iMake(100,100), RectMake(0, 24, 99, 99));
        building_images["cyrpt"] = KOLImageMake("images/otherimages/plains/cyrpt.gif", Vec2iMake(100,100), RectMake(0, 33, 99, 99));
        building_images["trapper"] = KOLImageMake("images/otherimages/thetrapper.gif", Vec2iMake(60,100), RectMake(0,11,59,96));
        
        building_images["castle"] = KOLImageMake("images/otherimages/stalktop/beanstalk.gif", Vec2iMake(500,400), RectMake(234,158,362,290)); //experimental - half sized castle
        building_images["penultimate fantasy airship"] = KOLImageMake("images/otherimages/stalktop/beanstalk.gif", Vec2iMake(500,400), RectMake(75, 231, 190, 367));
        building_images["lift, bro"] = KOLImageMake("images/adventureimages/fitposter.gif", Vec2iMake(100,100));
        //building_images["castle stairs up"] = KOLImageMake("images/adventureimages/giantstairsup.gif", Vec2iMake(100,100), RectMake(0, 8, 99, 85));
        building_images["castle stairs up"] = KOLImageMake("images/adventureimages/giantstairsup.gif", Vec2iMake(100,100), RectMake(20, 10, 74, 83));
        building_images["castle stairs up"].erase_zones.listAppend(RectMake(70, 78, 76, 84));
        
        
        building_images["goggles? yes!"] = KOLImageMake("images/adventureimages/steamposter.gif", Vec2iMake(100,100));
        //building_images["hole in the sky"] = KOLImageMake("images/otherimages/stalktop/beanstalk.gif", Vec2iMake(500,400), RectMake(403, 4, 487, 92));
        building_images["hole in the sky"] = KOLImageMake("images/otherimages/stalktop/beanstalk.gif", Vec2iMake(250,200), RectMake(201, 2, 243, 46));
        
        building_images["macguffin"] = KOLImageMake("images/itemimages/macguffin.gif", Vec2iMake(30,30));
        building_images["island war"] = KOLImageMake("images/otherimages/sigils/warhiptat.gif", Vec2iMake(50,50), RectMake(0,12,49,35));
        building_images["naughty sorceress"] = KOLImageMake("images/adventureimages/sorcform1.gif", Vec2iMake(100,100));
        building_images["naughty sorceress lair"] = KOLImageMake("images/otherimages/main/map6.gif", Vec2iMake(100,100), RectMake(6,0,50,43));
        
        building_images["king imprismed"] = KOLImageMake("images/otherimages/lair/kingprism1.gif", Vec2iMake(100,100));
        building_images["campsite"] = KOLImageMake("images/otherimages/plains/plains1.gif", Vec2iMake(100,100));
        building_images["trophy"] = KOLImageMake("images/otherimages/trophy/not_wearing_any_pants.gif", Vec2iMake(100,100));
        building_images["hidden temple"] = KOLImageMake("images/otherimages/woods/temple.gif", Vec2iMake(100,100), RectMake(16, 40, 89, 96));
        building_images["florist friar"] = KOLImageMake("images/adventureimages/floristfriar.gif", Vec2iMake(100,100), RectMake(31, 7, 77, 92));
        
        
        building_images["plant rutabeggar"] = KOLImageMake("images/otherimages/friarplants/plant2.gif", Vec2iMake(50,100), RectMake(1, 24, 47, 96));
        
        building_images["plant stealing magnolia"] = KOLImageMake("images/otherimages/friarplants/plant12.gif", Vec2iMake(49,100), RectMake(3, 15, 43, 94));
        
        building_images["plant shuffle truffle"] = KOLImageMake("images/otherimages/friarplants/plant24.gif", Vec2iMake(66,100), RectMake(4, 35, 63, 88));
        building_images["plant horn of plenty"] = KOLImageMake("images/otherimages/friarplants/plant22.gif", Vec2iMake(62,100), RectMake(4, 14, 58, 86));
        
        building_images["plant rabid dogwood"] = KOLImageMake("images/otherimages/friarplants/plant1.gif", Vec2iMake(57,100), RectMake(3, 16, 55, 98));
        building_images["plant rad-ish radish"] = KOLImageMake("images/otherimages/friarplants/plant3.gif", Vec2iMake(48,100), RectMake(4, 14, 42, 96));
        building_images["plant war lily"] = KOLImageMake("images/otherimages/friarplants/plant11.gif", Vec2iMake(49,100), RectMake(5, 5, 45, 98));
        
        building_images["plant canned spinach"] = KOLImageMake("images/otherimages/friarplants/plant13.gif", Vec2iMake(48,100), RectMake(3, 24, 46, 94));	
        building_images["plant blustery puffball"] = KOLImageMake("images/otherimages/friarplants/plant21.gif", Vec2iMake(54,100), RectMake(3, 38, 50, 90));
        building_images["plant wizard's wig"] = KOLImageMake("images/otherimages/friarplants/plant23.gif", Vec2iMake(53,100), RectMake(2, 15, 48, 90));
        
        building_images["plant up sea daisy"] = KOLImageMake("images/otherimages/friarplants/plant40.gif", Vec2iMake(64,100), RectMake(3, 6, 60, 92));
        building_images["sunflower face"] = KOLImageMake("images/otherimages/friarplants/plant40.gif", Vec2iMake(64,100), RectMake(6, 6, 58, 52));
        
        building_images["ringing phone"] = KOLImageMake("images/otherimages/spookyraven/srphonering.gif", Vec2iMake(30, 51), RectMake(0, 16, 30, 46));
        
        building_images["basic hot dog"] = KOLImageMake("images/itemimages/jarl_regdog.gif", Vec2iMake(30,30));
        building_images["Island War Arena"] = KOLImageMake("images/otherimages/bigisland/6.gif", Vec2iMake(100,100), RectMake(17, 28, 89, 76));
        building_images["Island War Lighthouse"] = KOLImageMake("images/otherimages/bigisland/17.gif", Vec2iMake(100,100), RectMake(30, 34, 68, 97));
        building_images["Island War Nuns"] = KOLImageMake("images/otherimages/bigisland/19.gif", Vec2iMake(100,100), RectMake(20, 43, 78, 87));
        building_images["Island War Farm"] = KOLImageMake("images/otherimages/bigisland/15.gif", Vec2iMake(100,100), RectMake(8, 50, 93, 88));
        building_images["Island War Orchard"] = KOLImageMake("images/otherimages/bigisland/3.gif", Vec2iMake(100,100), RectMake(20, 36, 99, 87));
        
        building_images["Island War Junkyard"] = KOLImageMake("images/otherimages/bigisland/25.gif", Vec2iMake(100,100), RectMake(0, 4, 99, 89));
        building_images["Island War Junkyard"].erase_zones.listAppend(RectMake(0, 2, 20, 6));
        building_images["Island War Junkyard"].erase_zones.listAppend(RectMake(9, 41, 95, 52));
        
        
        building_images["spookyraven manor"] = KOLImageMake("images/otherimages/town/manor.gif", Vec2iMake(100,100), RectMake(0, 22, 99, 99));
        
        building_images["spookyraven manor"].erase_zones.listAppend(RectMake(23, 18, 53, 28));
        
        
        building_images["spookyraven manor locked"] = KOLImageMake("images/otherimages/town/pantry.gif", Vec2iMake(80,80), RectMake(0, 26, 79, 79));
        
        building_images["haunted billiards room"] = KOLImageMake("images/otherimages/manor/sm4.gif", Vec2iMake(100,100), RectMake(12, 10, 93, 63));
        
        building_images["haunted library"] = KOLImageMake("images/otherimages/manor/sm7.gif", Vec2iMake(100,100), RectMake(14, 5, 92, 55));
        
        building_images["haunted bedroom"] = KOLImageMake("images/otherimages/manor/sm2_1b.gif", Vec2iMake(100,100), RectMake(18, 28, 91, 86));
        building_images["Haunted Ballroom"] = KOLImageMake("images/otherimages/manor/sm2_5.gif", Vec2iMake(100,200), RectMake(19, 11, 74, 76));
        
        building_images["Palindome"] = KOLImageMake("images/otherimages/plains/the_palindome.gif", Vec2iMake(96,86), RectMake(0, 17, 96, 83));
        
        
        building_images["high school"] = KOLImageMake("images/otherimages/town/kolhs.gif", Vec2iMake(100,100), RectMake(0, 26, 99, 92));
        //building_images["Toot Oriole"] = KOLImageMake("images/otherimages/oriole.gif", Vec2iMake(60,100), RectMake(0, 12, 59, 85));
        building_images["Toot Oriole"] = KOLImageMake("images/otherimages/mountains/noobsingtop.gif", Vec2iMake(200,100), RectMake(52, 18, 131, 49)); //I love this GIF

        building_images["bookshelf"] = KOLImageMake("images/otherimages/campground/bookshelf.gif", Vec2iMake(100,100), RectMake(0, 26, 99, 99));
        building_images["pirate quest"] = KOLImageMake("images/otherimages/trophy/party_on_the_big_boat.gif", Vec2iMake(100,100), RectMake(18, 3, 87, 64));
        building_images["meat"] = KOLImageMake("images/itemimages/meat.gif", Vec2iMake(30,30));
        building_images["monk"] = KOLImageMake("images/itemimages/monkhead.gif", Vec2iMake(30,30));
        
        
        building_images["Pyramid"] = KOLImageMake("images/otherimages/desertbeach/pyramid.gif", Vec2iMake(60,70), RectMake(12, 11, 47, 38));
        building_images["Pyramid"].erase_zones.listAppend(RectMake(14, 19, 19, 22));
        building_images["Pyramid"].erase_zones.listAppend(RectMake(41, 12, 45, 16));
        
        
        //building_images["hidden city"] = KOLImageMake("images/otherimages/hiddencity//hiddencitybg.gif", Vec2iMake(600,400), RectMake(114, 38, 213, 159)); //building, don't like
        //building_images["hidden city"] = KOLImageMake("images/otherimages/hiddencity//hiddencitybg.gif", Vec2iMake(600,400), RectMake(7, 240, 77, 294)); //shrine, too close to hidden temple
        building_images["hidden city"] = KOLImageMake("images/otherimages/hiddencity//hiddencitybg.gif", Vec2iMake(600,400), RectMake(426, 13, 504, 61)); //hidden tavern, small, better
        building_images["Dispensary"] = KOLImageMake("images/adventureimages/knobwindow.gif", Vec2iMake(100,100));
        
        
        building_images["Wine Racks"] = KOLImageMake("images/otherimages/manor/cellar4.gif", Vec2iMake(100,100), RectMake(17, 11, 96, 65));
        building_images["Wine Racks"].erase_zones.listAppend(RectMake(17, 11, 33, 12));
        building_images["Wine Racks"].erase_zones.listAppend(RectMake(39, 61, 42, 66));
        building_images["Wine Racks"].erase_zones.listAppend(RectMake(70, 61, 74, 66));
        building_images["Wine Racks"].erase_zones.listAppend(RectMake(94, 45, 97, 54));
        building_images["Wine Racks"].erase_zones.listAppend(RectMake(17, 49, 18, 53));
        
        
        building_images["black forest"] = KOLImageMake("images/otherimages/woods/bforest.gif", Vec2iMake(100,100), RectMake(0, 19, 99, 99));
        
        building_images["possessed wine rack"] = KOLImageMake("images/adventureimages/winerack.gif", Vec2iMake(100,100), RectMake(0, 0, 99, 99));
        building_images["cabinet of Dr. Limpieza"] = KOLImageMake("images/adventureimages/laundrycabinet.gif", Vec2iMake(100,100), RectMake(0, 0, 99, 99));
        building_images["monstrous boiler"] = KOLImageMake("images/adventureimages/boiler.gif", Vec2iMake(100,100), RectMake(0, 0, 99, 99));
        
        
        
        building_images["Dad Sea Monkee"] = KOLImageMake("images/adventureimages/dad_machine.gif", Vec2iMake(400,300), RectMake(150,212,245,260));
        building_images["Shub-Jigguwatt"] = KOLImageMake("images/adventureimages/shub-jigguwatt.gif", Vec2iMake(300,300), RectMake(19, 17, 267, 288));
        building_images["Yog-Urt"] = KOLImageMake("images/adventureimages/yog-urt.gif", Vec2iMake(300,300), RectMake(36, 88, 248, 299));
        building_images["Sea"] = KOLImageMake("images/adventureimages/wizardfish.gif", Vec2iMake(100,100), RectMake(18, 23, 61, 72));
        building_images["Sea"].erase_zones.listAppend(RectMake(18, 23, 27, 28));
        building_images["Sea"].erase_zones.listAppend(RectMake(48, 23, 62, 35));
        building_images["Spooky little girl"] = KOLImageMake("images/adventureimages/axelgirl.gif", Vec2iMake(100,100), RectMake(37, 25, 63, 74));
        
        //hermit.gif and oldman.gif are almost identical. twins?
        
        building_images["astral spirit"] = KOLImageMake("images/otherimages/spirit.gif", Vec2iMake(60,100));
        building_images["Disco Bandit"] = KOLImageMake("images/otherimages/discobandit_f.gif", Vec2iMake(60,100), RectMake(0,6,59,87));
        building_images["Seal Clubber"] = KOLImageMake("images/otherimages/sealclubber_f.gif", Vec2iMake(60,100), RectMake(0,9,59,92));
        building_images["Turtle Tamer"] = KOLImageMake("images/otherimages/turtletamer_f.gif", Vec2iMake(60,100), RectMake(0,5,59,93));
        building_images["Pastamancer"] = KOLImageMake("images/otherimages/pastamancer_f.gif", Vec2iMake(60,100), RectMake(0,0,59,91));
        building_images["Sauceror"] = KOLImageMake("images/otherimages/sauceror_f.gif", Vec2iMake(60,100), RectMake(0,5,59,90));
        building_images["Accordion Thief"] = KOLImageMake("images/otherimages/accordionthief_f.gif", Vec2iMake(60,100), RectMake(0,2,59,99));
        building_images["Avatar of Sneaky Pete"] = KOLImageMake("images/otherimages/peteavatar_f.gif", Vec2iMake(60,100), RectMake(1,7,59,96));
        building_images["Avatar of Jarlsberg"] = KOLImageMake("images/otherimages/jarlsberg_avatar_f.gif", Vec2iMake(60,100), RectMake(0,6,59,96));
        building_images["Avatar of Boris"] = KOLImageMake("images/otherimages/boris_avatar_f.gif", Vec2iMake(60,100), RectMake(0,4,59,93));
        building_images["Zombie Master"] = KOLImageMake("images/otherimages/zombavatar_f.gif", Vec2iMake(60,100), RectMake(10,3,55,99));
        building_images["Hourglass"] = KOLImageMake("images/itemimages/hourglass.gif", Vec2iMake(30,30));

        building_images["Nemesis Disco Bandit"] = KOLImageMake("images/adventureimages/newwave.gif", Vec2iMake(100,100));
        building_images["Nemesis Seal Clubber"] = KOLImageMake("images/adventureimages/1_1.gif", Vec2iMake(100,100));
        building_images["Nemesis Turtle Tamer"] = KOLImageMake("images/adventureimages/2_1.gif", Vec2iMake(100,100));
        building_images["Nemesis Pastamancer"] = KOLImageMake("images/adventureimages/3_1.gif", Vec2iMake(100,100));
        building_images["Nemesis Sauceror"] = KOLImageMake("images/adventureimages/4_1.gif", Vec2iMake(100,100));
        building_images["Nemesis Accordion Thief"] = KOLImageMake("images/adventureimages/6_1.gif", Vec2iMake(100,100));
        building_images["Nemesis Actually Ed the Undying"] = KOLImageMake("images/itemimages/blackcheck.gif", Vec2iMake(30,30)); //being old, his true enemy is his ever-decreasing pension
        
        building_images["sword guy"] = KOLImageMake("images/otherimages/leftswordguy.gif", Vec2iMake(80,100));
        building_images["Jick"] = KOLImageMake("images/otherimages/customavatars/1.gif", Vec2iMake(60,100));
        building_images["Superhuman Cocktailcrafting"] = KOLImageMake("images/itemimages/fruitym.gif", Vec2iMake(30,30));
        
        building_images["inexplicable door"] = KOLImageMake("images/otherimages/woods/8bitdoor.gif", Vec2iMake(100,100), RectMake(15, 43, 85, 99));
        building_images["Dungeons of Doom"] = KOLImageMake("images/otherimages/town/ddoom.gif", Vec2iMake(100,100), RectMake(31, 33, 68, 99));
        
        building_images["chinatown"] = KOLImageMake("images/otherimages/jung/jung_chinaback.gif", Vec2iMake(450,500), RectMake(188, 202, 229, 270));
        building_images["chinatown"].erase_zones.listAppend(RectMake(227, 247, 231, 256));
        
        
        building_images["barrel god"] = KOLImageMake("images/otherimages/bgshrine.gif", Vec2iMake(100,100), RectMake(29, 39, 69, 81));
        
        building_images["__skill Easy Riding"] = KOLImageMake("images/itemimages/motorbike.gif", Vec2iMake(30,30));
        building_images["__skill jump shark"] = KOLImageMake("images/itemimages/sharkfin.gif", Vec2iMake(30,30));
        building_images["__skill Natural Dancer"] = KOLImageMake("images/itemimages/dance3.gif", Vec2iMake(30,30));
        building_images["__skill Check Mirror"] = KOLImageMake("images/itemimages/bikemirror.gif", Vec2iMake(30,30));
        building_images["__skill Ball Lightning"] = KOLImageMake("images/itemimages/balllightning.gif", Vec2iMake(30,30));
        building_images["__skill rain man"] = KOLImageMake("images/itemimages/rainman.gif", Vec2iMake(30,30));
        building_images["__skill Wisdom of Thoth"] = KOLImageMake("images/itemimages/thoth.gif", Vec2iMake(30,30));
        
        building_images["lair registration desk"] = KOLImageMake("images/otherimages/nstower/nstower_regdesk.gif", Vec2iMake(100,61), RectMake(30, 3, 68, 41));
        
        
        building_images["mini-adventurer blank female"] = KOLImageMake("images/itemimages/miniadv0f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer seal clubber female"] = KOLImageMake("images/itemimages/miniadv1f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer turtle tamer female"] = KOLImageMake("images/itemimages/miniadv2f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer pastamancer female"] = KOLImageMake("images/itemimages/miniadv3f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer sauceror female"] = KOLImageMake("images/itemimages/miniadv4f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer disco bandit female"] = KOLImageMake("images/itemimages/miniadv5f.gif", Vec2iMake(30,30));
        building_images["mini-adventurer accordion thief female"] = KOLImageMake("images/itemimages/miniadv6f.gif", Vec2iMake(30,30));
        
        building_images["Lady Spookyraven"] = KOLImageMake("images/otherimages/spookyraven/sr_ladys.gif", Vec2iMake(65,65), RectMake(0, 0, 64, 37));
        building_images["Yeti"] = KOLImageMake("images/adventureimages/yeti.gif", Vec2iMake(100,100), RectMake(12, 0, 80, 98));
        building_images["Lights Out"] = KOLImageMake("images/adventureimages/lightning.gif", Vec2iMake(100,100), RectMake(0, 10, 99, 96));
        building_images["stench airport kiosk"] = KOLImageMake("images/otherimages/dinseylandfill_bg.gif", Vec2iMake(500,500), RectMake(163, 438, 225, 494));
    
        foreach key in building_images
        {
            __kol_images[key.to_lower_case()] = building_images[key];
        }

    }
    initialiseConstantKOLImages();
}

boolean __kol_images_has_inited = false;
//Does not need to be called directly.
void KOLImagesInit()
{
    if (__kol_images_has_inited)
        return;
        
	PageAddCSSClass("div", "r_image_container", "overflow:hidden;position:relative;top:0px;left:0px;");
    __kol_images_has_inited = true;
    KOLimage [string] building_images;
	
	string class_name = my_class().to_string().to_lower_case();
	string class_nemesis_name = "nemesis " + class_name;
	
	if (__kol_images contains class_name)
		building_images["player character"] = __kol_images[class_name];
	else
		building_images["player character"] = __kol_images["disco bandit"];
		
	if (__kol_images contains class_nemesis_name)
		building_images["nemesis"] = __kol_images[class_nemesis_name];
	else
		building_images["nemesis"] = __kol_images["jick"];
    
    
    
    foreach key in building_images
    {
        __kol_images[key.to_lower_case()] = building_images[key];
    }
}



KOLImage KOLImageLookup(string lookup_name)
{
    KOLImagesInit();
	if (!(__kol_images contains lookup_name))
	{
		//Automatically look up items, familiars, and effects by name:
		item it = lookup_name.to_item();
		familiar f = lookup_name.to_familiar();
		effect e = lookup_name.to_effect();
        monster m = $monster[none];
        skill s = $skill[none];
        string secondary_lookup_name = lookup_name;
        if (lookup_name.stringHasPrefix("__item "))
        {
            secondary_lookup_name = lookup_name.substring(7);
            f = $familiar[none];
            e = $effect[none];
            it = secondary_lookup_name.to_item();
        }
        else if (lookup_name.stringHasPrefix("__familiar "))
        {
            secondary_lookup_name = lookup_name.substring(11);
            it = $item[none];
            e = $effect[none];
            f = secondary_lookup_name.to_familiar();
        }
        else if (lookup_name.stringHasPrefix("__effect "))
        {
            secondary_lookup_name = lookup_name.substring(9);
            f = $familiar[none];
            it = $item[none];
            e = secondary_lookup_name.to_effect();
        }
        else if (lookup_name.stringHasPrefix("__monster "))
        {
            secondary_lookup_name = lookup_name.substring(10);
            f = $familiar[none];
            it = $item[none];
            e = $effect[none];
            m = secondary_lookup_name.to_monster();
        }
        else if (lookup_name.stringHasPrefix("__skill "))
        {
            secondary_lookup_name = lookup_name.substring(8);
            f = $familiar[none];
            it = $item[none];
            e = $effect[none];
            s = secondary_lookup_name.to_skill();
        }
        //Disabled for now - skill images are a new feature.
        /*if (lookup_name.stringHasPrefix("__skill "))
        {
            secondary_lookup_name = lookup_name.substring(8);
            skill s = secondary_lookup_name.to_skill();
            
			__kol_images[lookup_name] = KOLImageMake("images/itemimages/" + s.image, Vec2iMake(30,30));
            return __kol_images[lookup_name];
        }*/
        secondary_lookup_name = secondary_lookup_name.to_lower_case();
		if (it != $item[none] && it.smallimage != "" && it.to_string().to_lower_case() == secondary_lookup_name)
		{
			__kol_images[lookup_name] = KOLImageMake("images/itemimages/" + it.smallimage, Vec2iMake(30,30));
		}
		else if (f != $familiar[none] && f.image != "" && f.to_string().to_lower_case() == secondary_lookup_name)
		{
			__kol_images[lookup_name] = KOLImageMake("images/itemimages/" + f.image, Vec2iMake(30,30));
		}
        else if (e != $effect[none] && e.image != "" && e.to_string().to_lower_case() == secondary_lookup_name)
        {
            __kol_images[lookup_name] = KOLImageMake("images/itemimages/" + e.image, Vec2iMake(30,30));
        }
        else if (m != $monster[none] && m.image != "" && m.to_string().to_lower_case() == secondary_lookup_name)
        {
            __kol_images[lookup_name] = KOLImageMake("images/adventureimages/" + m.image, Vec2iMake(100, 100));
        }
        else if (s != $skill[none] && s.image != "" && s.to_string().to_lower_case() == secondary_lookup_name)
        {
			__kol_images[lookup_name] = KOLImageMake("images/itemimages/" + s.image, Vec2iMake(30,30));
        }
		else
		{
            if (__setting_debug_mode)
                print("Unknown image \"" + lookup_name + "\"");
			return KOLImageMake();
		}
	}
	return __kol_images[lookup_name];
}

Vec2i __kol_image_generate_image_html_return_final_size;
buffer KOLImageGenerateImageHTML(string lookup_name, boolean should_centre, Vec2i max_image_dimensions, string container_additional_class, string container_additional_style)
{
    KOLImagesInit();
	lookup_name = to_lower_case(lookup_name);
    
    boolean half_sized_output = false;
    boolean item_sized_output = false;
	lookup_name = lookup_name.to_lower_case();
    if (lookup_name.stringHasPrefix("__half "))
    {
        lookup_name = lookup_name.substring(7);
        half_sized_output = true;
    }
    if (lookup_name.stringHasPrefix("__itemsize "))
    {
        lookup_name = lookup_name.substring(11);
        item_sized_output = true;
    }
    if (lookup_name.stringHasPrefix("__small "))
    {
        lookup_name = lookup_name.substring(8);
        item_sized_output = true;
    }
    
    __kol_image_generate_image_html_return_final_size = Vec2iZero();
    
	KOLImage kol_image = KOLImageLookup(lookup_name);
	buffer result;
	if (kol_image.url == "")
		return "".to_buffer();
    
    Vec2i image_size = Vec2iCopy(kol_image.base_image_size);
    Rect image_crop = RectCopy(kol_image.crop);
    
    
		
	boolean have_size = true;
	boolean have_crop = true;
	if (image_size.x == 0 || image_size.y == 0)
		have_size = false;
	if (image_crop.max_coordinate.x == 0 || image_crop.max_coordinate.y == 0)
		have_crop = false;
    
    
    float scale_ratio = 1.0;
    if (have_size || have_crop)
    {
        Vec2i effective_image_size = image_size;
            
        if (half_sized_output)
        {
            effective_image_size.x = round(effective_image_size.x.to_float() * 0.5);
            effective_image_size.y = round(effective_image_size.y.to_float() * 0.5);
        }
        if (item_sized_output)
        {
            //FIXME this will result in incorrect proportions for nonsquare images
            //also crop? what crop?
            effective_image_size.x = MIN(effective_image_size.x, 30.0);
            effective_image_size.y = MIN(effective_image_size.y, 30.0);
        }
        if (have_crop)
            effective_image_size = Vec2iMake(image_crop.max_coordinate.x - image_crop.min_coordinate.x + 1, image_crop.max_coordinate.y - image_crop.min_coordinate.y + 1);
        
        if (half_sized_output && have_crop)
        {
            image_crop.min_coordinate.x = round(image_crop.min_coordinate.x.to_float() * 0.5);
            image_crop.min_coordinate.y = round(image_crop.min_coordinate.y.to_float() * 0.5);
            image_crop.max_coordinate.x = round(image_crop.max_coordinate.x.to_float() * 0.5);
            image_crop.max_coordinate.y = round(image_crop.max_coordinate.y.to_float() * 0.5);
        }
        
        if (effective_image_size.x > max_image_dimensions.x || effective_image_size.y > max_image_dimensions.y)
        {
            //Scale down, to match limitations:
            float image_ratio = 1.0;
            if (effective_image_size.x != 0.0 && effective_image_size.y != 0.0)
            {
                image_ratio = effective_image_size.y.to_float() / effective_image_size.x.to_float();
                //Try width-major:
                Vec2i new_image_size = Vec2iMake(max_image_dimensions.x.to_float(), max_image_dimensions.x.to_float() * image_ratio);
                if (new_image_size.x > max_image_dimensions.x || new_image_size.y > max_image_dimensions.y) //too big, try vertical-major:
                {
                    new_image_size = Vec2iMake(max_image_dimensions.y.to_float() / image_ratio, max_image_dimensions.y);
                }
                //Find ratio:
                if (new_image_size.x != 0.0)
                {
                    scale_ratio = new_image_size.x.to_float() / effective_image_size.x.to_float();
                }
            }
        }
    }
    if (scale_ratio > 1.0) scale_ratio = 1.0;
    if (scale_ratio < 1.0)
    {
        image_size.x = round(image_size.x.to_float() * scale_ratio);
        image_size.y = round(image_size.y.to_float() * scale_ratio);
        image_crop.min_coordinate.x = ceil(image_crop.min_coordinate.x.to_float() * scale_ratio);
        image_crop.min_coordinate.y = ceil(image_crop.min_coordinate.y.to_float() * scale_ratio);
        image_crop.max_coordinate.x = floor(image_crop.max_coordinate.x.to_float() * scale_ratio);
        image_crop.max_coordinate.y = floor(image_crop.max_coordinate.y.to_float() * scale_ratio);
    }
		
	boolean outputting_div = false;
	boolean outputting_erase_zones = false;
	Vec2i div_dimensions;
    
    if (container_additional_class != "")
        outputting_div = true;
	if (have_size)
	{
		div_dimensions = image_size;
		if (have_crop)
		{
			outputting_div = true;
			div_dimensions = Vec2iMake(image_crop.max_coordinate.x - image_crop.min_coordinate.x + 1,
									   image_crop.max_coordinate.y - image_crop.min_coordinate.y + 1);
		}
		else if (image_size.x > 100)
		{
			//Automatically crop to 100 pixels wide:
			outputting_div = true;
			div_dimensions = image_size;
			div_dimensions.x = min(100, div_dimensions.x);
		}
		if (kol_image.erase_zones.count() > 0)
		{
			outputting_div = true;
			outputting_erase_zones = true;
		}
	}
	
	if (outputting_div)
	{
		string style = "";
        
        if (have_size)
            style = "width:" + div_dimensions.x + "px; height:" + div_dimensions.y + "px;";
		if (__setting_show_alignment_guides)
			style += "background:purple;";
        if (container_additional_style != "")
        	style += container_additional_style;
        
        string [int] classes;
        classes.listAppend("r_image_container");
        
        if (should_centre)
            classes.listAppend("r_centre");
        if (container_additional_class != "")
            classes.listAppend(container_additional_class);
        result.HTMLAppendTagPrefix("div", "class", classes.listJoinComponents(" "), "style", style);
	}
	
	string [string] img_tag_attributes;
	img_tag_attributes["src"] = kol_image.url;
	//img_tag_attributes["style"] = "mix-blend-mode:multiply;";
	if (have_size)
	{
		img_tag_attributes["width"] =  image_size.x;
		img_tag_attributes["height"] =  image_size.y;
        if (!outputting_div && container_additional_style != "")
        	img_tag_attributes["style"] += container_additional_style;
        
        __kol_image_generate_image_html_return_final_size = image_size;
        
	}
    
    //Needs to be optimized to use buffers first.
    /*string unadorned_name = lookup_name;
    int breakout = 50;
    while (unadorned_name != "" && unadorned_name.stringHasPrefix("__") && breakout > 0)
    {
        int space_index = unadorned_name.index_of(" ") + 1;
        if (space_index < 0 || space_index > unadorned_name.length())
            space_index = unadorned_name.length();
        unadorned_name = unadorned_name.substring(space_index);
        breakout -= 1;
    }*/
    
	img_tag_attributes["alt"] = lookup_name.HTMLEscapeString();
	//img_tag_attributes["title"] = unadorned_name.HTMLEscapeString();
	
	if (have_crop && outputting_div)
	{
		//cordinates are upper-left
		//format is clip:rect(top-edge,right-edge,bottom-edge,left-edge);
		
		int top_edge = image_crop.min_coordinate.y;
		int bottom_edge = image_crop.max_coordinate.y;
		int left_edge = image_crop.min_coordinate.x;
		int right_edge = image_crop.max_coordinate.x;
		
		int margin_top = -(image_crop.min_coordinate.y);
		int margin_bottom = -(image_size.y - image_crop.max_coordinate.y);
		int margin_left = -(image_crop.min_coordinate.x);
		int margin_right = -(image_size.x - image_crop.max_coordinate.x);
		img_tag_attributes["style"] = "margin: " + margin_top + "px " + margin_right + "px " + margin_bottom + "px " + margin_left + "px;";
        
        
        
        __kol_image_generate_image_html_return_final_size = Vec2iMake(right_edge - left_edge, bottom_edge - top_edge);
	}
	
	if (__setting_show_alignment_guides)
		img_tag_attributes["style"] += "opacity: 0.5;";
	
	result.HTMLAppendTagPrefix("img", img_tag_attributes);
	
	if (outputting_erase_zones)
	{
		foreach i in kol_image.erase_zones
		{
			Rect zone = RectCopy(kol_image.erase_zones[i]);
			Vec2i dimensions = Vec2iMake(zone.max_coordinate.x - zone.min_coordinate.x + 1, zone.max_coordinate.y - zone.min_coordinate.y + 1);
            //print_html("zone = " + zone.to_json());
            if (scale_ratio < 1.0)
            {
                dimensions.x = round(dimensions.x.to_float() * scale_ratio);
                dimensions.y = round(dimensions.y.to_float() * scale_ratio);
                zone.min_coordinate.x = round(zone.min_coordinate.x.to_float() * scale_ratio);
                zone.min_coordinate.y = round(zone.min_coordinate.y.to_float() * scale_ratio);
                zone.max_coordinate.x = round(zone.max_coordinate.x.to_float() * scale_ratio);
                zone.max_coordinate.y = round(zone.max_coordinate.y.to_float() * scale_ratio);
            }
			
			int top = 0;
			int left = 0;
			
			top = -image_crop.min_coordinate.y;
			left = -image_crop.min_coordinate.x;
			
			top += zone.min_coordinate.y;
			left += zone.min_coordinate.x;
			//Output a white div over this area:
            buffer style;
            style.append("width:");
            style.append(dimensions.x);
            style.append("px;height:");
            style.append(dimensions.y);
            style.append("px;");
			if (__setting_show_alignment_guides)
				style.append("background:pink;");
			else
				style.append("background:#FFFFFF;");
			
            style.append("z-index:2;position:absolute;top:");
            style.append(top);
            style.append("px;left:");
            style.append(left);
            style.append("px;");
			
			result.append(HTMLGenerateDivOfStyle("", style));
		}
	}
	
	if (outputting_div)
		result.append("</div>");
	return result;
}

buffer KOLImageGenerateImageHTML(string lookup_name, boolean should_centre, Vec2i max_image_dimensions, string container_additional_class)
{
	return KOLImageGenerateImageHTML(lookup_name, should_centre, max_image_dimensions, container_additional_class, ""); 
}

buffer KOLImageGenerateImageHTML(string lookup_name, boolean should_centre, Vec2i max_image_dimensions)
{
    return KOLImageGenerateImageHTML(lookup_name, should_centre, max_image_dimensions, "");
}

buffer KOLImageGenerateImageHTML(string lookup_name, boolean should_centre)
{
	return KOLImageGenerateImageHTML(lookup_name, should_centre, Vec2iMake(65535, 65535));
}





//Standard checklist names:
string C_REQUIRED_ITEMS = "Required Items";
string C_RESOURCES = "Resources";
string C_TASKS = "Tasks";
string C_OPTIONAL_TASKS = "Optional Tasks";
string C_AFTERCORE_TASKS = "Aftercore Quests";
string C_FUTURE_TASKS = "Future Tasks";


record ChecklistSubentry
{
	string header;
	string [int] modifiers;
	string [int] entries;
};


ChecklistSubentry ChecklistSubentryMake(string header, string [int] modifiers, string [int] entries)
{
	boolean all_subentries_are_empty = true;
	foreach key in entries
	{
		if (entries[key] != "")
			all_subentries_are_empty = false;
	}
	ChecklistSubentry result;
	result.header = header;
	result.modifiers = modifiers;
	if (!all_subentries_are_empty)
		result.entries = entries;
	return result;
}

ChecklistSubentry ChecklistSubentryMake(string header, string modifiers, string [int] entries)
{
	if (modifiers == "")
		return ChecklistSubentryMake(header, listMakeBlankString(), entries);
	else
		return ChecklistSubentryMake(header, listMake(modifiers), entries);
}


ChecklistSubentry ChecklistSubentryMake(string header, string [int] entries)
{
	return ChecklistSubentryMake(header, listMakeBlankString(), entries);
}

ChecklistSubentry ChecklistSubentryMake(string header, string [int] modifiers, string e1)
{
	return ChecklistSubentryMake(header, modifiers, listMake(e1));
}

ChecklistSubentry ChecklistSubentryMake(string header, string [int] modifiers, string e1, string e2)
{
	return ChecklistSubentryMake(header, modifiers, listMake(e1, e2));
}


ChecklistSubentry ChecklistSubentryMake(string header, string modifiers, string e1)
{
	if (modifiers == "")
		return ChecklistSubentryMake(header, listMakeBlankString(), listMake(e1));
	else
		return ChecklistSubentryMake(header, listMake(modifiers), listMake(e1));
}

ChecklistSubentry ChecklistSubentryMake(string header)
{
	return ChecklistSubentryMake(header, "", "");
}

void listAppend(ChecklistSubentry [int] list, ChecklistSubentry entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listPrepend(ChecklistSubentry [int] list, ChecklistSubentry entry)
{
	int position = 0;
	while (list contains position)
		position -= 1;
	list[position] = entry;
}

ChecklistSubentry [int] listMake(ChecklistSubentry e1)
{
	ChecklistSubentry [int] result;
	result.listAppend(e1);
	return result;
}


int CHECKLIST_DEFAULT_IMPORTANCE = 0;
record ChecklistEntry
{
	string image_lookup_name;
	string url;
    string [string] container_div_attributes;
	ChecklistSubentry [int] subentries;
	boolean should_indent_after_first_subentry;
    
    boolean should_highlight;
	
	int importance_level; //Entries will be resorted by importance level before output, ascending order. Default importance is 0. Convention is to vary it from [-11, 11] for reasons that are clear and well supported in the narrative.
    boolean only_show_as_extra_important_pop_up; //only valid if -11 importance or lower - only shows up as a pop-up, meant to inform the user they can scroll up to see something else (semi-rares)
    ChecklistSubentry [int] subentries_on_mouse_over; //replaces subentries
    
    string combination_tag; //Entries with identical combination tags will be combined into one, with the "first" taking precedence.
    string short_description; //five letters or less
    string category; //similar to combination_tags, except they aren't combined - just "grouped" next to each other
    string specific_image;
    string abridged_header; //custom
    int universal_id;
    
    //string internal_generation_identifier;
    string [string] internal_processing_data; //when combined via tags, the data is += to each other with a | separator
    
    int [int] internal_processing_data_subentry_content_id; //key is subentry index, value is content id. stored this "high" instead of internal_processing_data because this is simpler than a generic system
};

//In retrospect, making all these ChecklistEntryMake overloads was a mistake
//may want to consider removing some? but they're *all* used
ChecklistEntry ChecklistEntryMakeInternal(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries, int importance, boolean should_highlight)
{
	ChecklistEntry result;
	result.image_lookup_name = image_lookup_name;
	result.url = url;
	result.subentries = subentries;
	result.importance_level = importance;
    result.should_highlight = should_highlight;
    result.universal_id = universal_id;
    //This generation process adds about nine milliseconds to load time: (6.6% load cost)
    //This is the only way I can think of it make checklist entries have a "unique" identifier. There are a lot of "vague" identifiers - image name, url, first entry title - but those change.
    if (false)
    {
    	/*
        Example:
        Checklist.ash: ChecklistEntryMakeInternal L193
        Spinmaster Lathe.ash: ChecklistEntryMake L104
        Checklists.ash: IOTMSpinmasterLatheGenerate L237
        Main.ash: generateChecklists L71
        relay_Guide.ash: runMain L9
        Globals.ash: main L45
        */
    	//Mystery I've never really solved: how to store the result from get_stack_trace() into a variable, instead of calling it three times? don't know the syntax
        
        /*print_html("");
        foreach key, r in get_stack_trace()
        {
        	print_html(r.file + ": " + r.name + " L" + r.line);
        }*/
        //Note that there can be non-unique entries with the same file, function, and line; doctor bag and emotion chip, as an example, because they're in a loop.
        //But, those are often grouped together anyways, so...
        //Switched to universal_id
        /*buffer generation_identifier; //Considered making this part of the record to prevent an alloc, but
        generation_identifier.append(get_stack_trace()[1].file);
        generation_identifier.append(get_stack_trace()[2].name);
        generation_identifier.append(get_stack_trace()[1].line);
        result.internal_generation_identifier = generation_identifier.to_string();*/
    }
	return result;
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries, int importance, boolean should_highlight)
{
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, importance, should_highlight);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries, int importance)
{
    return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, importance, false);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries, int importance, boolean [location] highlight_if_last_adventured)
{
    boolean should_highlight = false;
    
    if (highlight_if_last_adventured contains __last_adventure_location)
        should_highlight = true;
    return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, importance, should_highlight);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries)
{
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, CHECKLIST_DEFAULT_IMPORTANCE, false);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry [int] subentries, boolean [location] highlight_if_last_adventured)
{
    boolean should_highlight = false;
    
    if (highlight_if_last_adventured contains __last_adventure_location)
        should_highlight = true;
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, CHECKLIST_DEFAULT_IMPORTANCE, should_highlight);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry subentry, int importance)
{
	ChecklistSubentry [int] subentries;
	subentries[subentries.count()] = subentry;
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, importance, false);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry subentry, int importance, boolean [location] highlight_if_last_adventured)
{
    boolean should_highlight = false;
    
    if (highlight_if_last_adventured contains __last_adventure_location)
        should_highlight = true;
        
	ChecklistSubentry [int] subentries;
	subentries[subentries.count()] = subentry;
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, importance, should_highlight);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry subentry)
{
	ChecklistSubentry [int] subentries;
	subentries[subentries.count()] = subentry;
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, CHECKLIST_DEFAULT_IMPORTANCE, false);
}

ChecklistEntry ChecklistEntryMake(int universal_id, string image_lookup_name, string url, ChecklistSubentry subentry, boolean [location] highlight_if_last_adventured)
{
    boolean should_highlight = false;
    
    if (highlight_if_last_adventured contains __last_adventure_location)
        should_highlight = true;
        
	ChecklistSubentry [int] subentries;
	subentries[subentries.count()] = subentry;
	return ChecklistEntryMakeInternal(universal_id, image_lookup_name, url, subentries, CHECKLIST_DEFAULT_IMPORTANCE, should_highlight);
}

ChecklistEntry ChecklistEntryMake(int universal_id)
{
	ChecklistSubentry [int] blank_subentries;
	return ChecklistEntryMakeInternal(universal_id, "", "", blank_subentries, 0, false);
}



//Secondary level of making checklist entries; setting properties and returning them.
ChecklistEntry ChecklistEntryTag(ChecklistEntry e, string tag)
{
    e.combination_tag = tag;
    return e;
}

ChecklistEntry ChecklistEntrySetShortDescription(ChecklistEntry e, string short_description)
{
	e.short_description = short_description;
	return e;
}
ChecklistEntry ChecklistEntrySetCategory(ChecklistEntry e, string category)
{
	e.category = category;
	return e;
}
ChecklistEntry ChecklistEntrySetSpecificImage(ChecklistEntry e, string specific_image)
{
	e.specific_image = specific_image;
	return e;
}
ChecklistEntry ChecklistEntrySetAbridgedHeader(ChecklistEntry e, string abridged_header)
{
	e.abridged_header = abridged_header;
	return e;
}


ChecklistEntry listAppend(ChecklistEntry [int] list, ChecklistEntry entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
	return list[position];
}

void listAppendList(ChecklistEntry [int] list, ChecklistEntry [int] entries)
{
	foreach key in entries
		list.listAppend(entries[key]);
}

void listClear(ChecklistEntry [int] list)
{
	foreach i in list
	{
		remove list[i];
	}
}


record Checklist
{
	string title;
	ChecklistEntry [int] entries;
    
    boolean disable_generating_id; //disable generating checklist anchor and title-based div identifier
};


Checklist ChecklistMake(string title, ChecklistEntry [int] entries)
{
	Checklist cl;
	cl.title = title;
	cl.entries = entries;
	return cl;
}

Checklist ChecklistMake()
{
	Checklist cl;
	return cl;
}

void listAppend(Checklist [int] list, Checklist entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void listRemoveKeys(Checklist [int] list, int [int] keys_to_remove)
{
	foreach i in keys_to_remove
	{
		int key = keys_to_remove[i];
		if (!(list contains key))
			continue;
		remove list[key];
	}
}


string ChecklistGenerateModifierSpan(string [int] modifiers)
{
    if (modifiers.count() == 0)
        return "";
	return HTMLGenerateSpanOfClass(modifiers.listJoinComponents(", "), "r_cl_modifier");
}

string ChecklistGenerateModifierSpan(string modifier)
{
	return HTMLGenerateSpanOfClass(modifier, "r_cl_modifier");
}


void ChecklistInit()
{
	PageAddCSSClass("a", "r_cl_internal_anchor", "");
	//PageAddCSSClass("", "r_cl_modifier_inline", "font-size:0.80em; color:" + __setting_modifier_colour + ";");
	//PageAddCSSClass("", "r_cl_modifier", "font-size:0.80em; color:" + __setting_modifier_colour + "; display:block;");
    PageAddCSSClass("", "r_cl_modifier_inline", "font-size:0.85em; color:" + __setting_modifier_colour + ";");
    PageAddCSSClass("", "r_cl_modifier", "font-size:0.85em; color:" + __setting_modifier_colour + "; display:block;");
	
	PageAddCSSClass("", "r_cl_header", "text-align:center; font-size:1.15em; font-weight:bold;width:100%;padding-bottom:5px;border-bottom:1px solid " + __setting_line_colour + ";padding-top:5px;");
	PageAddCSSClass("", "r_cl_header_clicked", "background-color:" + __setting_line_colour + ";"); //__setting_line_colour is too light
	//Thought about making subheaders for abridged mode bigger - 1.5em fits fine within the vertical space - but it looks weird, like shouting.
	PageAddCSSClass("", "r_cl_subheader", "font-size:1.07em; font-weight:bold;");
	PageAddCSSClass("", "r_cl_subheader_abridged", "font-size:1.07em; font-weight:bold;");
	
	
	PageAddCSSClass("div", "r_cl_inter_spacing_divider", "width:100%; height:12px;");
    
    string container_gradient = "background: #ffffff;background: -moz-linear-gradient(left, #ffffff 50%, #F0F0F0 75%, #F0F0F0 100%);background: -webkit-gradient(linear, left top, right top, color-stop(50%,#ffffff), color-stop(75%,#F0F0F0), color-stop(100%,#F0F0F0));background: -webkit-linear-gradient(left, #ffffff 50%,#F0F0F0 75%,#F0F0F0 100%);background: -o-linear-gradient(left, #ffffff 50%,#F0F0F0 75%,#F0F0F0 100%);background: -ms-linear-gradient(left, #ffffff 50%,#F0F0F0 75%,#F0F0F0 100%);background: linear-gradient(to right, #ffffff 50%,#F0F0F0 75%,#F0F0F0 100%);filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#F0F0F0',GradientType=1 );"; //help
    
    if (!__use_flexbox_on_checklists)
    {
        PageAddCSSClass("div", "r_cl_l_container_highlighted", container_gradient + "padding-top:5px;padding-bottom:5px;");
        PageAddCSSClass("div", "r_cl_l_container", "padding-top:5px;padding-bottom:5px;");
        PageAddCSSClass("", "r_cl_l_left", "float:left;width:" + __setting_image_width_large + "px;margin-left:20px;overflow:hidden;");
        PageAddCSSClass("", "r_cl_l_right_container", "width:100%;margin-left:" + (-__setting_image_width_large - 20) + "px;float:right;text-align:left;vertical-align:top;");
        PageAddCSSClass("div", "r_cl_l_right_content", "margin-left:" + (__setting_image_width_large + 20 + 2) + "px;display:inline-block;margin-right:20px;");
    }
    //string hr_width = __setting_indention_width;
    //string half_hr_width = (__setting_indention_width_in_em / 2.0) + "em";
    string hr_width = "0px";
    string half_hr_width = "0px";
    PageAddCSSClass("hr", "r_cl_hr", "padding:0px;margin-top:0px;margin-bottom:0px;width:auto; margin-left:" + hr_width + ";margin-right:" + hr_width +";");
    PageAddCSSClass("hr", "r_cl_hr_extended", "padding:0px;margin-top:0px;margin-bottom:0px;width:auto; margin-left:" + hr_width + ";margin-right:0px;");
	PageAddCSSClass("div", "r_cl_holding_container", "display:inline-block;");
	
    
    PageAddCSSClass("", "r_cl_image_container_large", "display:block;");
    PageAddCSSClass("", "r_cl_image_container_medium", "display:none;");
    PageAddCSSClass("", "r_cl_image_container_small", "display:none;");
    
	if (true)
	{
		string div_style = "";
		div_style = "margin:0px;";
        /*div_style += "border-style: solid; border-color:" + __setting_line_colour + ";";
        div_style += "border:1px;";
        div_style += "border-left:0px; border-right:0px;border-bottom:0px;";*/
        div_style += "border-top:1px solid " + __setting_line_colour + ";";
        div_style += "background-color:#FFFFFF; width:100%;";// padding-top:5px;";
        if (__use_flexbox_on_checklists)
        	div_style += "display:flex;flex-wrap:wrap;align-items:stretch;";
		PageAddCSSClass("div", "r_cl_checklist_container", div_style);
	}
    
    //media queries:
    if (!__use_table_based_layouts)
    {
    	if (!__use_flexbox_on_checklists)
        {
            PageAddCSSClass("", "r_cl_l_left", "width:" + __setting_image_width_medium + "px;margin-left:5px;", 0, __setting_media_query_medium_size);
            PageAddCSSClass("", "r_cl_l_right_container", "margin-left:" + (-__setting_image_width_medium - 5) + "px;", 0, __setting_media_query_medium_size);
            PageAddCSSClass("div", "r_cl_l_right_content", "margin-left:" + (__setting_image_width_medium + 5 + 2) + "px;margin-right:10px;", 0, __setting_media_query_medium_size);
            PageAddCSSClass("div", "r_cl_l_container", "padding-top:4px;padding-bottom:4px;", 0, __setting_media_query_medium_size);
        }
        
        PageAddCSSClass("hr", "r_cl_hr", "margin-left:" + half_hr_width + ";margin-right:" + half_hr_width + ";", 0, __setting_media_query_medium_size);
        PageAddCSSClass("hr", "r_cl_hr_extended", "margin-left:" + half_hr_width + ";", 0, __setting_media_query_medium_size);
        
        
    	if (!__use_flexbox_on_checklists)
        {
            PageAddCSSClass("", "r_cl_l_left", "width:" + (__setting_image_width_small) + "px;margin-left:5px;", 0, __setting_media_query_small_size);
            PageAddCSSClass("", "r_cl_l_right_container", "margin-left:" + (-(__setting_image_width_small) - 10) + "px;", 0, __setting_media_query_small_size);
            PageAddCSSClass("div", "r_cl_l_right_content", "margin-left:" + ((__setting_image_width_small) + 10) + "px;margin-right:3px;", 0, __setting_media_query_small_size);
            PageAddCSSClass("div", "r_cl_l_container", "padding-top:3px;padding-bottom:3px;", 0, __setting_media_query_small_size);
        }
        PageAddCSSClass("hr", "r_cl_hr", "margin-left:0px;margin-right:0px;", 0, __setting_media_query_small_size);
        PageAddCSSClass("hr", "r_cl_hr_extended", "margin-left:0px;", 0, __setting_media_query_small_size);
        
        
    	if (!__use_flexbox_on_checklists)
        {
            PageAddCSSClass("", "r_cl_l_left", "width:" + (0) + "px;margin-left:3px;", 0, __setting_media_query_tiny_size);
            PageAddCSSClass("", "r_cl_l_right_container", "margin-left:" + (-(0) - 3) + "px;", 0, __setting_media_query_tiny_size);
            PageAddCSSClass("div", "r_cl_l_right_content", "margin-left:" + ((0) + 3 + 2) + "px;margin-right:3px;", 0, __setting_media_query_tiny_size);
            PageAddCSSClass("div", "r_cl_l_container", "padding-top:3px;padding-bottom:3px;", 0, __setting_media_query_tiny_size);
        }
        PageAddCSSClass("hr", "r_cl_hr", "margin-left:0px;margin-right:0px;", 0, __setting_media_query_tiny_size);
        PageAddCSSClass("hr", "r_cl_hr_extended", "margin-left:0px;", 0, __setting_media_query_tiny_size);
        
        
        
        PageAddCSSClass("", "r_cl_image_container_large", "display:none", 0, __setting_media_query_medium_size);
        PageAddCSSClass("", "r_cl_image_container_medium", "display:block;", 0, __setting_media_query_medium_size);
        PageAddCSSClass("", "r_cl_image_container_small", "display:none;", 0, __setting_media_query_medium_size);
        
        PageAddCSSClass("", "r_cl_image_container_large", "display:none", 0, __setting_media_query_small_size);
        PageAddCSSClass("", "r_cl_image_container_medium", "display:none;", 0, __setting_media_query_small_size);
        PageAddCSSClass("", "r_cl_image_container_small", "display:block;", 0, __setting_media_query_small_size);
        
        PageAddCSSClass("", "r_cl_image_container_large", "display:none", 0, __setting_media_query_tiny_size);
        PageAddCSSClass("", "r_cl_image_container_medium", "display:none;", 0, __setting_media_query_tiny_size);
        PageAddCSSClass("", "r_cl_image_container_small", "display:none;", 0, __setting_media_query_tiny_size);
        
        PageAddCSSClass("", "r_small_float_indention", "display:none");
        
        PageAddCSSClass("", "r_indention_not_small", "margin-left:" + __setting_indention_width + ";");
        if (__setting_small_size_uses_full_width)
        {
        	if (!__use_flexbox_on_checklists)
	            PageAddCSSClass("div", "r_cl_l_right_content", "margin-left:10px;margin-right:3px;min-width:80%;", 0, __setting_media_query_small_size);
            PageAddCSSClass("", "r_cl_image_container_small", "display:block;float:left;", 0, __setting_media_query_small_size);
            //PageAddCSSClass("", "r_small_float_indention", "display:inline;width:0.5em;height:" + (__setting_image_width_small - 10) + "px;float:left;", 0, __setting_media_query_small_size);
            PageAddCSSClass("", "r_small_float_indention", "display:inline;width:0.5em;float:left;", 0, __setting_media_query_small_size);
            PageAddCSSClass("", "r_indention_not_small", "margin-left:0.75em;", 0, __setting_media_query_small_size);
            PageAddCSSClass("", "r_indention_not_small", "margin-left:0.75em;", 0, __setting_media_query_tiny_size);
        }
        
        
        PageAddCSSClass("", "r_indention", "margin-left:0.75em;", 0, __setting_media_query_small_size);
        PageAddCSSClass("", "r_indention", "margin-left:0.75em;", 0, __setting_media_query_tiny_size);
    }
    
    if (__use_flexbox_on_checklists)
    {
    	//padding-top:5px;padding-bottom:5px;
        PageAddCSSClass("div", "r_cl_l_container", "display:flex;flex-direction:row;flex-wrap:nowrap;justify-content:flex-start;align-items:stretch;border-bottom:1px solid " + __setting_line_colour + ";flex-grow:1;width:100%;width:100%;"); //width:600px;
        PageAddCSSClass("div", "r_cl_l_container_highlighted", container_gradient);
        PageAddCSSClass("div", "r_cl_l_container_minimised", "width:200px;");
        PageAddCSSClass("div", "r_cl_l_container_always_minimised", "width:200px;");
        //PageAddCSSClass("div", "r_cl_l_container_minimised", "");
        
        
        PageAddCSSClass("", "r_cl_l_right_container", "width:100%;" + "px;text-align:left;padding-top:5px;padding-bottom:5px;margin-left:3px;align-self:center;padding-right:5px;");
        PageAddCSSClass("div", "r_cl_l_right_content", ""); //display:inline-block;
        PageAddCSSClass("div", "r_cl_l_right_content_abridged", "display:none;");
        
        PageAddCSSClass("", "r_cl_l_left", "flex-basis:" + (__setting_image_width_large) + "px;overflow:hidden;padding-top:5px;padding-bottom:5px;flex-shrink:0;");
        PageAddCSSClass("", "r_cl_l_left", "max-width:" + (__setting_image_width_medium) + "px;margin-left:5px;", 0, __setting_media_query_medium_size);
        PageAddCSSClass("", "r_cl_l_left", "max-width:" + (__setting_image_width_small) + "px;margin-left:5px;", 0, __setting_media_query_small_size);
        PageAddCSSClass("", "r_cl_l_left", "max-width:" + (0) + "px;margin-left:3px;", 0, __setting_media_query_tiny_size);
        
        
        if (false)
        {
        	//solid background:
            //PageAddCSSClass("div", "r_cl_l_left_showhide", "cursor:pointer;background:" + __setting_line_colour + ";width:20px;flex-shrink:0;");
        }
        else
        {
            //PageAddCSSClass("div", "r_cl_l_left_showhide:hover", "background:" + __setting_line_colour + ";");
        }
        //PageAddCSSClass("div", "r_cl_l_left_showhide_blank", "width:21px;max-width:21px;min-width:21px;flex-shrink:0;");
        
        //art design student
        
        PageAddCSSClass("div", "r_cl_l_left_showhide_clicked", "background-color:" + __setting_page_background_colour + ";"); //this looks nicer, but line matches header clicked
        //PageAddCSSClass("div", "r_cl_l_left_showhide_clicked", "background-color:" + __setting_line_colour + ";");
        
        PageAddCSSClass("div", "r_cl_l_left_showhide", "border-right:1px solid " + __setting_line_colour + ";border-left:1px solid " + __setting_line_colour + ";width:15px;max-width:15px;min-width:15px;flex-shrink:0;flex-grow:0;flex-basis:0;margin-left:-1px;"); //-1 px to hide the left border
        PageAddCSSClass("div", "r_cl_l_container_minimised:hover", "background-color:" + "#CCCCCC" + ";mix-blend-mode:multiply;");
        //PageAddCSSClass("div", "r_cl_l_left_showhide:hover", "background-color:" + "#CCCCCC" + ";");
        PageAddCSSClass("div", "r_cl_l_left_showhide", "width:20px;max-width:20px;min-width:15px;", 0, __setting_media_query_medium_size);
        PageAddCSSClass("div", "r_cl_l_left_showhide", "width:15px;max-width:15px;min-width:15px;", 0, __setting_media_query_small_size);
        PageAddCSSClass("div", "r_cl_l_left_showhide", "width:10px;max-width:10px;min-width:10px;", 0, __setting_media_query_tiny_size);
        //Order matters; this class must be defined after r_cl_l_left_showhide to override it.
        PageAddCSSClass("div", "r_cl_l_left_showhide_blank", "border-right:1px solid transparent;border-left:1px solid transparent;");
        PageAddCSSClass("div", "r_cl_l_left_showhide_blank:hover", "cursor:auto;background:transparent;");
        
        PageAddCSSClass("div", "showhide_mouseover_popup_class", "position:absolute;background:white;width:100%;z-index:5;border-bottom:1px solid " + __setting_line_colour + ";border-right:1px solid " + __setting_line_colour + ";pointer-events:none;box-shadow:0px 0px 30px 0px black;display:none;");
         //transition:opacity 0.25s; box-shadow:0px 0px 0px 10000px rgba(0,0,0,0.5); opacity:0;
        
    }
}

//Creates if not found:
Checklist lookupChecklist(Checklist [int] checklists, string title)
{
	foreach key in checklists
	{
		Checklist cl = checklists[key];
		if (cl.title == title)
			return cl;
	}
	//Not found, create one.
	Checklist cl = ChecklistMake();
	cl.title = title;
	checklists.listAppend(cl);
	return cl;
}

void ChecklistFormatSubentry(ChecklistSubentry subentry)
{
    foreach i in subentry.entries
    {
        string [int] line_split = split_string_alternate(subentry.entries[i], "\\|");
        foreach l in line_split
        {
            if (stringHasPrefix(line_split[l], "*"))
            {
                //remove prefix:
                //indent:
                line_split[l] = HTMLGenerateIndentedText(substring(line_split[l], 1));
            }
        }
        //Recombine:
        buffer building_line;
        boolean first = true;
        boolean last_was_indention = false;
        foreach key in line_split
        {
            string line = line_split[key];
            if (!contains_text(line, "class=\"r_indention\"") && !first && !last_was_indention) //hack way of testing for indention
            {
                building_line.append("<br>");
            }
            last_was_indention = contains_text(line, "class=\"r_indention\"");
            building_line.append(line);
            first = false;
        }
        subentry.entries[i] = to_string(building_line);
    }
}

Record ChecklistGeneratedEntryHTML
{
	buffer out;
	boolean small_enough_for_showhide_to_ignore;
	string abridged_header_text;
};

ChecklistGeneratedEntryHTML ChecklistGenerateEntryHTMLFull(ChecklistEntry entry, ChecklistSubentry [int] subentries, string anchor_url, boolean setting_use_holding_containers_per_subentry)
{
    Vec2i max_image_dimensions_large = Vec2iMake(__setting_image_width_large, 75);
    Vec2i max_image_dimensions_medium = Vec2iMake(__setting_image_width_medium, 50);
    Vec2i max_image_dimensions_small = Vec2iMake(__setting_image_width_small, 50);
    if (__setting_small_size_uses_full_width)
        max_image_dimensions_small = Vec2iMake(__setting_image_width_small,__setting_image_width_small);
    boolean outputting_anchor = anchor_url != "";
    boolean outputting_as_anchor = anchor_url != "";
    
    string [string] main_containers_base_map;
    if (outputting_as_anchor)
	    main_containers_base_map = mapMake("target", "mainpane", "href", entry.url, "class", "r_a_undecorated");
    
    string anchor_prefix_html = ""; //HTMLGenerateTagPrefix("a", main_containers_base_map);
    string main_container_tag = "div";
    if (outputting_as_anchor)
    	main_container_tag = "a";
    
    
    ChecklistGeneratedEntryHTML final_result;
    buffer result;
    if (true)
    {
        
        buffer image_container;
        
        if (outputting_anchor && !__setting_entire_area_clickable)
            image_container.append(anchor_prefix_html);
        
        image_container.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_large, "r_cl_image_container_large"));
        image_container.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_medium, "r_cl_image_container_medium"));
        if (!__setting_small_size_uses_full_width)
            image_container.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_small, "r_cl_image_container_small"));
        
        if (outputting_anchor && !__setting_entire_area_clickable)
            image_container.append("</a>");
        
        //result.HTMLAppendDivOfClass(image_container, "r_cl_l_left");
        string [string] cl_l_left_map = main_containers_base_map.mapCopy();
        cl_l_left_map["class"] += " r_cl_l_left";
        result.HTMLAppendTagPrefix(main_container_tag, cl_l_left_map);
        result.append(image_container);
        result.HTMLAppendTagSuffix(main_container_tag);
        
    }
    //else
        //result.HTMLAppendDivOfClass(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_large), "r_cl_l_left");
    
    
    //result.HTMLAppendTagPrefix("div", "class", "r_cl_l_right_container");
    
    
    string [string] r_cl_l_right_container = main_containers_base_map.mapCopy();
    r_cl_l_right_container["class"] += " r_cl_l_right_container";
    result.HTMLAppendTagPrefix(main_container_tag, r_cl_l_right_container);
    
    if (outputting_anchor && !__setting_entire_area_clickable)
        result.append(anchor_prefix_html);
    //internal_processing_data
    //if (entry.internal_processing_data contains "content_id")
    	//r_cl_l_right_content_map["data-content-ids"] = entry.internal_processing_data["content_id"]; 
    result.HTMLAppendTagPrefix("div", "class", "r_cl_l_right_content");
    
    if (__setting_small_size_uses_full_width)
    {
        result.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_small, "r_cl_image_container_small"));
        
        result.HTMLAppendTagWrap("div", "", mapMake("class", "r_small_float_indention", "style", "height: " + __kol_image_generate_image_html_return_final_size.y + "px;"));
        //result.HTMLAppendDivOfClass("", "r_small_float_indention"); //&nbsp; to have it display. hack
    }
    
    string [string] hardcoded_combination_tag_descriptions = {
    "free instakill":"Free instant kills",
	"daily free fight":"Daily free fights",
	"free banish":"Free banishes",
	"emotion chip combat":"Emotion chip",
	"banish":"Turn-costing banishes",
	"zutara":"Fortune Teller",
	"telegraph skill":"",
	"consumption junction, what's your function?":"Consumption space",
    };
    
    buffer abridged_buffer;
    //int approximate_subtext_height = 0;
    boolean first = true;
    int approximate_lines = subentries.count();
    foreach j in subentries
    {
        ChecklistSubentry subentry = subentries[j];
        if (subentry.header == "")
            continue;
        string subheader = subentry.header;
        
        boolean indent_this_entry = false;
        if (!first && entry.should_indent_after_first_subentry)
        {
            indent_this_entry = true;
        }
        
        
        
        if (indent_this_entry)
            result.HTMLAppendTagPrefix("div", "class", "r_indention");
        
        
        //internal_processing_data_subentry_content_id
        
        if (true)
        {
        	//result.append(HTMLGenerateSpanOfClass(subheader, "r_cl_subheader"));
         
         
        	string [string] subheader_map = mapMake("class", "r_cl_subheader");
            if (entry.internal_processing_data_subentry_content_id.count() > 0)
            	subheader_map["data-content-id"] = entry.internal_processing_data_subentry_content_id[j];
            result.HTMLAppendTagPrefix("span", subheader_map);
            result.append(subheader);
            result.HTMLAppendTagSuffix("span");
            
            if (first)
            {
                abridged_buffer.HTMLAppendTagPrefix("span", "class", "r_cl_subheader_abridged");
                
                
                string core_text = subheader;
                
                if (entry.abridged_header != "")
                {
                	core_text = entry.abridged_header;
                }
            	else if (entry.combination_tag != "" && subentries.count() > 1)
                {
                	if (hardcoded_combination_tag_descriptions contains entry.combination_tag)
                    {
                    	if (hardcoded_combination_tag_descriptions[entry.combination_tag] != "")
                        {
                 			core_text = hardcoded_combination_tag_descriptions[entry.combination_tag];
                        }
                    }
                    else
                    {
	                	core_text = entry.combination_tag.capitaliseFirstLetter();
                    }
                }
                final_result.abridged_header_text = core_text.entity_encode();
                abridged_buffer.append(core_text);
                abridged_buffer.HTMLAppendTagSuffix("span");
            }
        }
        
        string indention_class = "r_indention";
        if (__setting_small_size_uses_full_width)
        	indention_class = "r_indention_not_small";
        
        if (true)
        {
        	string [string] indention_map = mapMake("class", indention_class);
            if (entry.internal_processing_data_subentry_content_id.count() > 0)
            	indention_map["data-content-id"] = entry.internal_processing_data_subentry_content_id[j];
            result.HTMLAppendTagPrefix("div", indention_map);
        }
        approximate_lines += subentry.modifiers.count();
        approximate_lines += subentry.entries.count();
        if (subentry.modifiers.count() > 0)
            result.append(ChecklistGenerateModifierSpan(listJoinComponents(subentry.modifiers, ", ")));
        if (subentry.entries.count() > 0)
        {
        	//approximate_subtext_height += subentry.entries.count();
            int intra_k = 0;
            if (setting_use_holding_containers_per_subentry)
                result.HTMLAppendTagPrefix("div", "class", "r_cl_holding_container"); //HRs
            while (intra_k < subentry.entries.count())
            { 
                if (intra_k > 0)
                {
                    result.append("<hr>");
                }
                string line = subentry.entries[listKeyForIndex(subentry.entries, intra_k)];
                
                //if (line.contains_text("<div class=\"r_stl_container_row\">") || line.contains_text("<hr>"))
                	//approximate_subtext_height += 1;
                
                //if (line.contains_text("<hr"))
                result.HTMLAppendDivOfClass(line, "r_cl_holding_container"); //For nested HRs, sizes them down a bit
                
                intra_k += 1;
            }
            if (setting_use_holding_containers_per_subentry)
                result.append("</div>");
        }
        result.append("</div>");
        if (indent_this_entry)
            result.append("</div>");
        first = false;
    }
    result.append("</div>"); //r_cl_l_right_content
    
    
    result.HTMLAppendTagPrefix("div", "class", "r_cl_l_right_content_abridged");
    result.append(abridged_buffer);
    result.append("</div>"); //r_cl_l_right_content_abridged
    
    if (outputting_anchor && !__setting_entire_area_clickable)
        result.append("</a>");
    result.HTMLAppendTagSuffix(main_container_tag); //r_cl_l_right_container
    
    if (!__use_flexbox_on_checklists)
	    result.HTMLAppendDivOfClass("", "r_end_floating_elements"); //stop floating
     
    final_result.out = result;
    final_result.small_enough_for_showhide_to_ignore = approximate_lines <= 1; //approximate_subtext_height <= 1;
    //final_result.small_enough_for_showhide_to_ignore = false;
    
    return final_result;
}

buffer ChecklistGenerateEntryHTML(ChecklistEntry entry, ChecklistSubentry [int] subentries, string anchor_url, boolean setting_use_holding_containers_per_subentry)
{
	return ChecklistGenerateEntryHTMLFull(entry, subentries, anchor_url, setting_use_holding_containers_per_subentry).out;
}

buffer ChecklistGenerate(Checklist cl, boolean output_borders)
{
	ChecklistEntry [int] entries = cl.entries;
	
	//Combine entries with identical combination tags:
	ChecklistEntry [string] combination_tag_entries;
	foreach key, entry in entries
	{
		if (entry.combination_tag == "") continue;
        if (entry.only_show_as_extra_important_pop_up) continue; //do not support this feature with this
        if (entry.subentries_on_mouse_over.count() > 0) continue;
        if (entry.container_div_attributes.count() > 0) continue;
        
        if (!(combination_tag_entries contains entry.combination_tag))
        {
        	entry.importance_level -= 1; //combined entries gain a hack; a level above everything else
        	combination_tag_entries[entry.combination_tag] = entry;
            continue;
        }
        ChecklistEntry master_entry = combination_tag_entries[entry.combination_tag];
        
        if (entry.should_highlight)
        	master_entry.should_highlight = true;
        if (master_entry.url == "" && entry.url != "")
        	master_entry.url = entry.url;
        master_entry.importance_level = min(master_entry.importance_level, entry.importance_level - 1);
        foreach key, subentry in entry.subentries
        { 
        	master_entry.subentries.listAppend(subentry);
            //Bring over internal_processing_data_subentry_content_id:
            master_entry.internal_processing_data_subentry_content_id[master_entry.subentries.count() - 1] = entry.internal_processing_data_subentry_content_id[key];
        }
        foreach key, value in entry.internal_processing_data
        {
        	if (!(master_entry.internal_processing_data contains key))
            	master_entry.internal_processing_data[key] = value;
            else
            {
            	master_entry.internal_processing_data[key] += "|" + value;
            }
        }
        remove entries[key];
	}
	
	//Sort by importance:
	sort entries by value.importance_level;
    
	
	if (true)
	{
		//Format subentries:
		foreach i in entries
		{
			ChecklistEntry entry = entries[i];
			foreach j in entry.subentries
			{
                ChecklistFormatSubentry(entry.subentries[j]);
			}
			foreach j in entry.subentries_on_mouse_over
			{
                ChecklistFormatSubentry(entry.subentries_on_mouse_over[j]);
			}
		}
	}

	boolean skip_first_entry = false;
	string special_subheader = "";
	if (entries.count() > 0)
	{
		if (entries[0].image_lookup_name == "special subheader")
		{
			if (entries[0].subentries.count() > 0)
			{
				special_subheader = entries[0].subentries[0].header;
				skip_first_entry = true;
			}
		}
	}
	
	
	buffer result;
    if (output_borders)
        result.HTMLAppendDivOfClass("", "r_cl_inter_spacing_divider"); //spacing
	
    if (!cl.disable_generating_id)
        result.HTMLAppendTagWrap("a", "", mapMake("id", HTMLConvertStringToAnchorID(cl.title), "class", "r_cl_internal_anchor"));
	
    string [string] main_container_map;
    main_container_map["class"] = "r_cl_checklist_container";
    if (!cl.disable_generating_id)
        main_container_map["id"] = HTMLConvertStringToAnchorID(cl.title + " checklist container");
    main_container_map["data-title"] = cl.title;
    if (!output_borders)
        main_container_map["style"] = "border:0px;";
    result.HTMLAppendTagPrefix("div", main_container_map);
	
	
	result.HTMLAppendTagWrap("div", cl.title, mapMake("class", "r_cl_header r_clickable", "onmousedown", "checklistHeaderButtonClicked(window.event)"));
	
	if (special_subheader != "")
		result.append(ChecklistGenerateModifierSpan(special_subheader));
	
	int starting_intra_i = 0;
	if (skip_first_entry)
		starting_intra_i = 1;
	int intra_i = 0;
	int entries_output = 0;
    boolean last_was_highlighted = false;
    int current_mouse_over_id = 1;
	foreach i in entries
	{
		if (intra_i < starting_intra_i)
		{
			intra_i += 1;
			continue;
		}
		ChecklistEntry entry = entries[i];
		if (intra_i > starting_intra_i && !__use_flexbox_on_checklists)
		{
            boolean next_is_highlighted = false;
            if (entry.should_highlight)
                next_is_highlighted = true;
            string class_name = "r_cl_hr";
            if (last_was_highlighted || next_is_highlighted)
                class_name = "r_cl_hr_extended";
			result.HTMLAppendTagPrefix("hr", "class", class_name);
		}
        if (__use_table_based_layouts)
            __setting_entire_area_clickable = true;
		boolean outputting_anchor = false;
        buffer anchor_prefix_html;
		if (entry.url != "")
		{
            anchor_prefix_html = HTMLGenerateTagPrefix("a", mapMake("target", "mainpane", "href", entry.url, "class", "r_a_undecorated"));
			outputting_anchor = true;
		}
        if (outputting_anchor && __setting_entire_area_clickable)
			result.append(anchor_prefix_html);
		
		boolean setting_use_holding_containers_per_subentry = true;
			
		Vec2i max_image_dimensions_large = Vec2iMake(__setting_image_width_large, 75);
		Vec2i max_image_dimensions_medium = Vec2iMake(__setting_image_width_medium, 50);
		Vec2i max_image_dimensions_small = Vec2iMake(__setting_image_width_small, 50);
        if (__setting_small_size_uses_full_width)
            max_image_dimensions_small = Vec2iMake(__setting_image_width_small,__setting_image_width_small);
        
        string container_class = "r_cl_l_container";
        if (entry.should_highlight)
            container_class += " r_cl_l_container_highlighted";
        last_was_highlighted = entry.should_highlight;
        
        ChecklistGeneratedEntryHTML generated_entry = ChecklistGenerateEntryHTMLFull(entry, entry.subentries, entry.url, setting_use_holding_containers_per_subentry);
        buffer generated_subentry_html = generated_entry.out;
        if (generated_entry.small_enough_for_showhide_to_ignore)
        	container_class += " r_cl_l_container_always_minimised";
        if (entry.subentries_on_mouse_over.count() > 0)
        {
            buffer generated_mouseover_subentry_html = ChecklistGenerateEntryHTML(entry, entry.subentries_on_mouse_over, entry.url, setting_use_holding_containers_per_subentry);
            
            //Can't properly escape, so generate two no-show divs and replace them as needed:
            //We could just have a div that shows up when we mouse over...
            //This is currently very buggy.
            entry.container_div_attributes["onmouseenter"] = "event.currentTarget.innerHTML = document.getElementById('r_temp_o" + current_mouse_over_id + "').innerHTML";
            entry.container_div_attributes["onmouseleave"] = "event.currentTarget.innerHTML = document.getElementById('r_temp_l" + current_mouse_over_id + "').innerHTML";
            
            result.HTMLAppendTagPrefix("div", "id", "r_temp_o" + current_mouse_over_id, "style", "display:none");
            result.append(generated_mouseover_subentry_html);
            result.HTMLAppendTagSuffix("div");
            result.HTMLAppendTagPrefix("div", "id", "r_temp_l" + current_mouse_over_id, "style", "display:none");
            result.append(generated_subentry_html);
            result.HTMLAppendTagSuffix("div");
            
            current_mouse_over_id += 1;
        }
        
        entry.container_div_attributes["class"] += (entry.container_div_attributes contains "class" ? " " : "") + container_class;
        
        //string entry_stable_id = entry.internal_generation_identifier;
        string entry_stable_id = entry.universal_id;
        if (entry.combination_tag != "")
        	entry_stable_id = entry.combination_tag;
        
        if (entry_stable_id != "")
	        entry.container_div_attributes["data-stable-id"] = entry_stable_id;
        else if (my_id() == 1557284)
        	print_html("warning: no stable id for " + entry.subentries[0].header); //usually caused by a lack of checklistentrymake
         
        //if (generated_entry.abridged_header_text != "")
			//entry.container_div_attributes["data-abridged-text"] = generated_entry.abridged_header_text;
        
        if (entry.internal_processing_data contains "content_id")
            entry.container_div_attributes["data-content-ids"] = entry.internal_processing_data["content_id"]; 
        result.HTMLAppendTagPrefix("div", entry.container_div_attributes);
        
		/*if (__use_table_based_layouts)
		{
			//table-based layout:
			result.append("<table cellpadding=0 cellspacing=0><tr>");
			
			result.HTMLAppendTagWrap("td", "", mapMake("style", "width:" + __setting_indention_width + ";"));
			result.append("<td>");
			result.HTMLAppendTagPrefix("td", "style", "min-width:" + __setting_image_width_large + "px; max-width:" + __setting_image_width_large + "px; width:" + __setting_image_width_large + "px;vertical-align:top; text-align: center;");
			
			result.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, max_image_dimensions_large));
			
			result.append("</td>");
			result.HTMLAppendTagPrefix("td", "style", "text-align:left; vertical-align:top");
			
				
			boolean first = true;
			foreach j in entry.subentries
			{
				ChecklistSubentry subentry = entry.subentries[j];
				if (subentry.header == "")
					continue;
				string subheader = subentry.header;
				
				boolean indent_this_entry = false;
				if (first)
				{
					first = false;
				}
				else if (entry.should_indent_after_first_subentry)
				{
					indent_this_entry = true;
				}
				if (indent_this_entry)
					result.HTMLAppendTagPrefix("div", "class", "r_indention");
				
				result.append("<table cellpadding=0 cellspacing=0><tr><td colspan=2>");
			
				result.append(HTMLGenerateSpanOfClass(subheader, "r_cl_subheader"));
				
				result.append("</td></tr>");
				
				
				result.append("<tr>");
				result.HTMLAppendTagWrap("td", "", mapMake("style", "width:" + __setting_indention_width + ";"));
				result.append("<td>");
				if (subentry.modifiers.count() > 0)
					result.append(ChecklistGenerateModifierSpan(listJoinComponents(subentry.modifiers, ", ") + "<br>"));
				if (subentry.entries.count() > 0)
				{
					int intra_k = 0;
					while (intra_k < subentry.entries.count())
					{ 
						if (intra_k > 0)
							result.append("<hr>");
						string line = subentry.entries[listKeyForIndex(subentry.entries, intra_k)];
						line = HTMLGenerateDivOfClass(line, "r_cl_holding_container"); //For nested HRs
						
						
						result.append(line);
						
						intra_k += 1;
					}
				}
				result.append("</td></tr>");
				
				result.append("</table>");
				if (indent_this_entry)
					result.append("</div>");
			}		
			result.append("</td>");
			result.append("</tr></table>");
		}
		else*/
        if (true)
		{
        	if (__use_flexbox_on_checklists && __enable_showhide_feature)
            {
                //int approximate_height = generated_subentry_html.split_string("<").count(); //r_cl_holding_container
                string [string] showhide_map;
                showhide_map["class"] = "r_cl_l_left_showhide";
            	if (generated_entry.small_enough_for_showhide_to_ignore)// || !output_borders)
                {
                    showhide_map["class"] += " r_cl_l_left_showhide_blank";
                }
                else
                {
                	showhide_map["class"] += " r_clickable";
                	showhide_map["onmousedown"] = "showhideButtonClicked(window.event)";
                }
                result.append(HTMLGenerateTagWrap("div", " ", showhide_map));
                //result.append("<div>" + approximate_height + "</div>");
            }
			//div-based layout:
            //result.append(ChecklistGenerateEntryHTML(entry, entry.subentries, entry.url, setting_use_holding_containers_per_subentry));
            result.append(generated_subentry_html);
		}
        result.append("</div>");

		
		if (outputting_anchor && __setting_entire_area_clickable)
            result.append("</a>");
		
		intra_i += 1;
		entries_output += 1;
	}
	result.append("</div>");
	
    if (output_borders)
        result.HTMLAppendDivOfClass("", "r_cl_inter_spacing_divider");
	
	return result;
}


buffer ChecklistGenerate(Checklist cl)
{
    return ChecklistGenerate(cl, true);
}


Record ChecklistCollection
{
    Checklist [string] checklists;
};

//NOTE: WILL DESTRUCTIVELY EDIT CHECKLISTS GIVEN TO IT
//mostly because there's no easy way to copy an object in ASH
//without manually writing a copy function and insuring it is synched
Checklist [int] ChecklistCollectionMergeWithLinearList(ChecklistCollection collection, Checklist [int] other_checklists)
{
    Checklist [int] result;
    
    boolean [string] seen_titles;
    foreach key, checklist in other_checklists
    {
        seen_titles[checklist.title] = true;
        result.listAppend(checklist);
    }
    foreach key, checklist in collection.checklists
    {
        if (seen_titles contains checklist.title)
        {
            foreach key, checklist2 in result
            {
                if (checklist2.title == checklist.title)
                {
                    checklist2.entries.listAppendList(checklist.entries);
                    break;
                }
            }
        }
        else
        {
            result.listAppend(checklist);
        }
    }
    
    return result;
}

Checklist lookup(ChecklistCollection checklists, string name)
{
    if (checklists.checklists contains name)
        return checklists.checklists[name];
    
    Checklist c = ChecklistMake();
    c.title = name;
    checklists.checklists[c.title] = c;
    return c;
}

//Preferred use. Returns entry you just added:
//Example usage:
//checklists.add(C_RESOURCES, ChecklistEntryMake(etc));
//I suppose we could do...
//checklists.add(C_RESOURCES).setURL("inventory.php").setImage("__item disco ball").addSubentries(subentries).setShouldHighlightIfAdventuringAtLocation($location[noob cave]);
//What would be nice if we could do something like this:
//checklists.add(C_RESOURCES, {url:"inventory.php", image:"__item disco ball", subentry:{title:"Important Title", description:description}, highlightLocation:$location[noob cave]});
//and location: doing both url: and highlightLocation:
//checklists.add(C_RESOURCES, {location:$location[noob cave], item:$item[disco ball], subentry:{title:"Important Title", description:description}});
//with some prefix to make that work without quotes
//or better
//checklists.add(C_RESOURCES, {location:$location[noob cave], item:$item[disco ball], title:"Important Title", description:description});
//which just automatically creates a single subentry
//But, I don't think mafia's map system is strong enough for that, and functions don't allow tagging arguments like that. Alas.
ChecklistEntry add(ChecklistCollection checklists, string collection_name, ChecklistEntry entry)
{
	Checklist c = checklists.lookup(collection_name);
	return c.entries.listAppend(entry);
}

//if resupported, needs unique_id
/*ChecklistEntry add(ChecklistCollection checklists, string collection_name)
{
	ChecklistEntry entry = ChecklistEntryMake();
	Checklist c = checklists.lookup(collection_name);
	return c.entries.listAppend(entry);
}*/


void QLevel2Init()
{
	//questL02Larva
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questL02Larva");
	if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished"); 
	
	state.quest_name = "Spooky Forest Quest";
	state.image_name = "Spooky Forest";
	state.council_quest = true;
	
	if (my_level() >= 2 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
	
	if (state.in_progress)
	{
		if ($item[mosquito larva].available_amount() > 0)
		{
			state.state_boolean["have mosquito"] = true;
		}
	}
	else if (state.finished)
	{
		state.state_boolean["have mosquito"] = true;
	}
	
	__quest_state["Level 2"] = state;
	__quest_state["Spooky Forest"] = state;
}


void QLevel2GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Level 2"];
	if (!base_quest_state.in_progress)
		return;
    
    if (my_path_id() == PATH_COMMUNITY_SERVICE || __misc_state["in aftercore"])
        return;
		
	ChecklistSubentry subentry;
    string url = "place.php?whichplace=woods";
	
	subentry.header = base_quest_state.quest_name;
	
	
	if (base_quest_state.state_boolean["have mosquito"])
	{
		subentry.entries.listAppend("Finished, go chat with the council.");
        url = "place.php?whichplace=town";
	}
	else
	{
		string [int] modifiers;
		modifiers.listAppend("-combat");
		
		if (delayRemainingInLocation($location[the spooky forest]) > 0)
		{
            string hipster_text = "";
            if (__misc_state["have hipster"])
            {
                hipster_text = " (use " + __misc_state_string["hipster name"] + ")";
                modifiers.listAppend(__misc_state_string["hipster name"]);
            }
			string line = "Delay for " + pluralise(delayRemainingInLocation($location[the spooky forest]), "turn", "turns") + hipster_text + ".";
            subentry.entries.listAppend(line);
			subentry.entries.listAppend("Run -combat after that.");
		}
		else
			subentry.entries.listAppend("Run -combat");
		subentry.entries.listAppend("Explore the stream" + __html_right_arrow_character + "March to the marsh");
		
		
		if (!__quest_state["Manor Unlock"].state_boolean["ballroom song effectively set"])
			subentry.entries.listAppend("Possibly wait until -combat ballroom song set. (marginal)");
			
		if (__misc_state["free runs available"])
		{
			subentry.entries.listAppend("Free run from monsters (low stats)");
			modifiers.listAppend("free runs");
		}
			
			
		subentry.modifiers = modifiers;
	}
	
	task_entries.listAppend(ChecklistEntryMake(80, base_quest_state.image_name, url, subentry, $locations[the spooky forest]));
}

void QLevel3Init()
{
	//questL03Rat
	//lastTavernSquare
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL03Rat");
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	
	state.quest_name = "Typical Tavern Quest";
	state.image_name = "Typical Tavern";
	state.council_quest = true;
	
	if ((my_path_id() == PATH_EXPLOSIONS || my_level() >= 3) && __quest_state["Level 2"].finished)
		state.startable = true;
	
	__quest_state["Level 3"] = state;
	__quest_state["Typical Tavern"] = state;
}


void QLevel3GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 3"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 3"];
	boolean wait_until_level_eleven = false;
	if ($skill[ur-kel's aria of annoyance].skill_is_usable() && my_level() < 11)
		wait_until_level_eleven = true;
    
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	
    if (base_quest_state.mafia_internal_step == 1)
        subentry.entries.listAppend("Speak to the bartender.");
    
    boolean can_skip_cold = numeric_modifier("Cold Damage") >= 20.0;
    boolean can_skip_hot = numeric_modifier("Hot Damage") >= 20.0;
    boolean can_skip_spooky = numeric_modifier("Spooky Damage") >= 20.0;
    boolean can_skip_stench = numeric_modifier("Stench Damage") >= 20.0;
    
    
	
    float combat_rate = clampNormalf((0.85 + combat_rate_modifier() / 100.0)); //15%? I can't remember...
    
    boolean need_to_complete_pyramid = true;
    
    //FIXME test properly
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        need_to_complete_pyramid = false;
    if (__quest_state["Level 11"].finished)
        need_to_complete_pyramid = false;
    if (need_to_complete_pyramid && $item[tangle of rat tails].available_amount() < 6)
    {
        float rat_king_chance = clampNormalf(monster_level_adjustment_for_location($location[the typical tavern cellar]) / 300.0);
        float average_tangles_found = (clampNormalf(rat_king_chance * combat_rate) * 8.5);
        
        if (wait_until_level_eleven)
            subentry.entries.listAppend("May want to wait until level 11 for most +ML from aria.");
        string line = "Run +ML for tangles (" + roundForOutput(rat_king_chance * 100.0, 0) + "% rat king chance, " + average_tangles_found.roundForOutput(1) + " tangles on average";
        line += ")";
        
        subentry.entries.listAppend(line);
	}
    
	string [int] elemental_sources_available;
	if ($item[piddles].available_amount() > 0 && $effect[Belch the Rainbow&trade;].have_effect() == 0)
		elemental_sources_available.listAppend("+" + MIN(11, my_level()) + " piddles");
	
	
	if ($skill[Benetton's Medley of Diversity].skill_is_usable() && my_level() >= 15 && get_property_int("_benettonsCasts") < 10)
		elemental_sources_available.listAppend("+15 Benetton's Medley of Diversity");
	
	string elemental_sources_available_string;
	if (elemental_sources_available.count() > 0)
		elemental_sources_available_string = " (" + listJoinComponents(elemental_sources_available, ", ") + " available)";
	
    if (true)
    {
        int ncs_skippable = 0;
        string [int] additionals;
        if (!can_skip_cold)
            additionals.listAppend(HTMLGenerateSpanOfClass("cold", "r_element_cold"));
        else
            ncs_skippable += 1;
        if (!can_skip_hot)
            additionals.listAppend(HTMLGenerateSpanOfClass("hot", "r_element_hot"));
        else
            ncs_skippable += 1;
        if (!can_skip_spooky)
            additionals.listAppend(HTMLGenerateSpanOfClass("spooky", "r_element_spooky"));
        else
            ncs_skippable += 1;
        if (!can_skip_stench)
            additionals.listAppend(HTMLGenerateSpanOfClass("stench", "r_element_stench"));
        else
            ncs_skippable += 1;
        
        //drunken rat kings seem to happen after the combat/non-combat check, so recommend +combat if they need tangles:
        
        string combat_type_to_run = "-combat";
        if (ncs_skippable > 0)// && ($item[tangle of rat tails].available_amount() * 3 + $item[tomb ratchet].available_amount() >= 11 || !need_to_complete_pyramid)) //technically should check if we're done with the pyramid moving, not level 11 finished, but that's harder to test. on second thought, just -combat if we can skip at least one?
            combat_type_to_run = "-combat";
        string line;
        if (additionals.count() > 0)
            line += "Run " + combat_type_to_run + " with +20 " + additionals.listJoinComponents("/") + " damage.";
        else
            line += "Run " + combat_type_to_run + ".";
        if (ncs_skippable < 4)
            line += elemental_sources_available_string;
        if (ncs_skippable > 0)
        {
            float rate = ncs_skippable.to_float() / 4.0;
            if (ncs_skippable == 4)
                line += "|Can skip every non-combat.";
            else
                line += "|Can skip " + (rate * 100.0).round() + "% of non-combats.";
        }
        line += "|Alternatively, run +combat if you can't skip NCs. Slightly more chance of rat tangles.";
        subentry.modifiers.listAppend(combat_type_to_run);
        subentry.entries.listAppend(line);
        
        if ($item[tangle of rat tails].available_amount() > 0 && need_to_complete_pyramid)
        {
            subentry.entries.listAppend(pluralise($item[tangle of rat tails]) + " found.");
        }
    }
    if (need_to_complete_pyramid)
        subentry.modifiers.listAppend("+300 ML");
    
    string url = "tavern.php";
    
    if (get_property_ascension("lastCellarReset") && base_quest_state.mafia_internal_step > 1)
        url = "cellar.php";
	
	if (wait_until_level_eleven && false) //Ehhh... no? It's like, a 5% difference?
		optional_task_entries.listAppend(ChecklistEntryMake(82, base_quest_state.image_name, url, subentry, $locations[the typical tavern cellar]));
	else
		task_entries.listAppend(ChecklistEntryMake(83, base_quest_state.image_name, url, subentry, $locations[the typical tavern cellar]));
}

void QLevel4Init()
{
	//questL04Bat
	//be sure to set state_int["areas unlocked"]
    
    //started -> no areas unlocked
    //step1 -> 1 area unlocked
    //step2 -> 2 areas unlocked
    //step3 -> 3 areas unlocked
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL04Bat");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	
	state.quest_name = "Boss Bat Quest";
	state.image_name = "Boss Bat";
	state.council_quest = true;
	
	if (state.in_progress)
	{
		//Zones opened?
        if ($location[the batrat and ratbat burrow].locationAvailable())
            state.state_int["areas unlocked"] = 1;
        if ($location[the beanbat chamber].locationAvailable())
            state.state_int["areas unlocked"] = 2;
        if ($location[the boss bat's lair].locationAvailable())
            state.state_int["areas unlocked"] = 3;
            
	}
	else if (state.finished)
	{
		state.state_int["areas unlocked"] = 3;
	}
	
	if (my_level() >= 4 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
		
	__quest_state["Level 4"] = state;
	__quest_state["Boss Bat"] = state;
}


void QLevel4GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 4"].in_progress)
		return;
	
	QuestState base_quest_state = __quest_state["Level 4"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
    string url = "place.php?whichplace=bathole";
	
    if (base_quest_state.mafia_internal_step >= 5)
    {
        subentry.entries.listAppend("Quest finished, speak to the council of loathing.");
        url = "place.php?whichplace=town";
    }
    else if ($location[the boss bat's lair].locationAvailable())
    {
        subentry.entries.listAppend("Possibly run +meat in the boss bat's lair. (250 meat drop)");
        subentry.modifiers.listAppend("+meat");
		if (delayRemainingInLocation($location[the boss bat's lair]) > 0)
		{
			string line = "Delay for " + pluralise(delayRemainingInLocation($location[the boss bat's lair]), "turn", "turns") + " before boss bat shows up.";
            subentry.entries.listAppend(line);
		}
    }
    else
    {
        int areas_unlocked = base_quest_state.state_int["areas unlocked"];
        int areas_locked = 3 - areas_unlocked;
        int sonars_needed = MAX(areas_locked - $item[sonar-in-a-biscuit].available_amount(), 0);
        
        
        if (true)
        {
            string line = pluraliseWordy(areas_locked, "area", "areas").capitaliseFirstLetter() + " to unlock";
            /*if ($item[sonar-in-a-biscuit].available_amount() > 0)
                line += ", " + pluralise($item[sonar-in-a-biscuit]);*/
            line += ".";
            subentry.entries.listAppend(line);
        }
        
        if ($item[sonar-in-a-biscuit].available_amount() > 0 && areas_locked > 0 && my_path_id() != PATH_G_LOVER && my_path_id() != PATH_BEES_HATE_YOU)
        {
            int amount = MIN(areas_locked, $item[sonar-in-a-biscuit].available_amount());
            subentry.entries.listAppend("Use " + pluralise(amount, $item[sonar-in-a-biscuit]));
            url = "inventory.php?which=3";
        }
        
        boolean have_stench_resistance = (numeric_modifier("stench resistance") > 0.0);
        if (!have_stench_resistance)
        {
            string line = "Need " + HTMLGenerateSpanOfClass("stench resistance", "r_element_stench") + " to adventure in Guano Junction.";
            string [int] possibilities;
            //This could be more... unified:
            if ($item[ghost of a necklace].available_amount() > 0)
            {
                if ($item[ghost of a necklace].equipped_amount() == 0)
                    line += "|*Equip your ghost of a necklace.";
            }
            else if ($item[bum cheek].available_amount() > 0)
            {
                if ($item[bum cheek].equipped_amount() == 0)
                    line += "|*Equip your bum cheek.";
            }
            else if ($item[knob goblin harem veil].available_amount() == 0)
            {
                possibilities.listAppend("acquire a knob goblin harem veil");
                possibilities.listAppend("finish the first floor of spookyraven manor");
            }
            else
            {
                if ($item[knob goblin harem veil].equipped_amount() == 0)
                {
                    possibilities.listAppend("equip your knob goblin harem veil");
                }
            }
            if ($skill[elemental saucesphere].have_skill())
            {
                possibilities.listAppend("cast elemental saucesphere");
            }
            else if (my_class() == $class[sauceror])
                possibilities.listAppend("learn elemental saucesphere at guild trainer");
            if (possibilities.count() > 0)
                line += "|*Possibly " + possibilities.listJoinComponents(", ", "or") + ".";
            
            subentry.entries.listAppend(line);
        }
        
        
        if (__misc_state["can use clovers"] && sonars_needed >= 2 && my_path_id() != PATH_G_LOVER)
            subentry.entries.listAppend("Potentially clover Guano Junction for two sonar-in-a-biscuit");
        if ($item[enchanted bean].available_amount() == 0 && !__quest_state["Level 10"].state_boolean["beanstalk grown"])
        {
            if ($location[the beanbat chamber].locationAvailable())
                subentry.entries.listAppend("Run +100% item in the beanbat chamber for a single turn for enchanted bean. (50% drop)");
            else
                subentry.entries.listAppend("When beanbat chamber is unlocked, run +100% item for a single turn there for enchanted bean (50% drop)");
        }
        
        int total_turns = $location[Guano Junction].turns_spent + $location[The Batrat and Ratbat Burrow].turns_spent + $location[The Beanbat Chamber].turns_spent;
        int turns_until_next_screambat = 8 - (total_turns % 8);
        if (turns_until_next_screambat == 8 && total_turns != 0) turns_until_next_screambat = 0;
        boolean screambat_up_now = false;
        
        if (turns_until_next_screambat == 0)
        {
            screambat_up_now = true;
            subentry.entries.listAppend("Screambat next turn.");
        }
        else
            subentry.entries.listAppend("Screambat after " + pluraliseWordy(turns_until_next_screambat, "turn", "turns") + ".");
        
        if (!screambat_up_now && my_path_id() != PATH_G_LOVER)
        {
            if (__misc_state["yellow ray available"] && sonars_needed > 0)
                subentry.entries.listAppend("Potentially yellow ray for sonar-in-a-biscuit.");
            if (sonars_needed > 0)
                subentry.entries.listAppend("Run +item in the batrat and ratbat burrow for biscuits. (15% drop)");
            subentry.modifiers.listAppend("+566% item");
        }
        //subentry.entries.listAppend("Run +meat in the boss bat's lair, if you wish. (250 meat drop)");
	}
    
	task_entries.listAppend(ChecklistEntryMake(78, base_quest_state.image_name, url, subentry, $locations[the bat hole entrance, guano junction, the batrat and ratbat burrow, the beanbat chamber,the boss bat's lair]));
}

void QLevel5Init()
{
	//questL05Goblin
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL05Goblin");
	state.quest_name = "Knob Goblin Quest";
	state.image_name = "cobb's knob";
	state.council_quest = true;
	
	
	if (my_level() >= 5 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
		
	if (get_property("questL05Goblin") == "unstarted" && $item[knob goblin encryption key].available_amount() == 0 && my_path_id() != PATH_COMMUNITY_SERVICE)
	{
		//start the quest anyways, because they need to acquire the encryption key:
        //there's also an edge case here in BIG!, where you want to avoid visiting the council for a while to yellow ray an outfit
		QuestStateParseMafiaQuestPropertyValue(state, "started");
	}
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
		
		
	__quest_state["Level 5"] = state;
	__quest_state["Knob Goblin King"] = state;
}


void QLevel5GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 5"].in_progress)
		return;
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO|| __misc_state["in aftercore"])
        return;
    string url = "place.php?whichplace=plains";
	//if the quest isn't started and we have unlocked the barracks, wait until it's started:
	if (get_property("questL05Goblin") == "unstarted" && $item[knob goblin encryption key].available_amount() > 0) //have key already, waiting for quest to start, nothing more to do here
		return;
		
	QuestState base_quest_state = __quest_state["Level 5"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	
	boolean should_output = true;
	
	if (!$location[cobb's knob barracks].locationAvailable())
	{
		if ($item[knob goblin encryption key].available_amount() == 0)
		{
			//Need key:
			//Unlocking:
			if (__misc_state["have hipster"])
				subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
			if (__misc_state["free runs available"])
				subentry.modifiers.listAppend("free runs");
                
            int turns_spent = $location[the outskirts of cobb's knob].turns_spent;
            if (turns_spent != -1)
            {
                int delay_turns_remaining = 10 - turns_spent;
                if (delay_turns_remaining == 0)
                    subentry.entries.listAppend("Map appears next turn in cobb's knob.");
                else
                    subentry.entries.listAppend("Delay for " + pluraliseWordy(delay_turns_remaining, "more turn", "more turns") + " in cobb's knob to unlock area.");
            }
            else
                subentry.entries.listAppend("Delay for ten turns in cobb's knob to unlock area.");
            if ($classes[seal clubber, turtle tamer] contains my_class() && !__misc_state["guild open"] && !QuestState("questG09Muscle").started && my_path_id() != PATH_NUCLEAR_AUTUMN)
            {
                url = "guild.php";
                subentry.entries.listAppend("Start your guild quest first.");
            }
		}
		else if ($item[cobb's knob map].available_amount() > 0 && $item[knob goblin encryption key].available_amount() > 0)
		{
            url = "inventory.php?which=3";
			subentry.entries.listAppend("Use cobb's knob map to unlock area.");
		}
		else if ($item[cobb's knob map].available_amount() == 0 && $item[knob goblin encryption key].available_amount() > 0)
			should_output = false;
	}
	else
	{
        url = "cobbsknob.php";
		//Cobb's knob unlocked. Now to set up for king:
		
		boolean can_use_harem_route = true;
		boolean can_use_kge_route = true;
		
		boolean have_knob_cake_or_ingredients = false;
		have_knob_cake_or_ingredients = ($item[knob cake].available_amount() > 0 || creatable_amount($item[knob cake]) > 0);
		
		if (can_use_kge_route && have_outfit_components("Knob Goblin Elite Guard Uniform") && have_knob_cake_or_ingredients)
			can_use_harem_route = false;
		else if (can_use_harem_route && have_outfit_components("Knob Goblin Harem Girl Disguise") && have_outfit_components("Knob Goblin Elite Guard Uniform")) //only stop guarding after KGE is acquired, for dispensary
			can_use_kge_route = false;
		
		if (!__misc_state["can equip just about any weapon"])
			can_use_kge_route = false;
        string fight_king_string = "fight king";
        if (53 + monster_level_adjustment() > my_buffedstat($stat[moxie]))
            fight_king_string += " (" + (53 + monster_level_adjustment()) + " attack)";
		if (can_use_harem_route)
		{
			string [int] harem_modifiers;
			string [int] harem_lines;
			if (!have_outfit_components("Knob Goblin Harem Girl Disguise"))
			{
				harem_lines.listAppend("Need disguise.|*20% drop from harem girls (olfact)|*Or adventure in zone for eleven (or more) turns.");
				harem_modifiers.listAppend("+400% item");
				harem_modifiers.listAppend("olfact harem girls");
                if ($familiar[slimeling].familiar_is_usable())
                    harem_modifiers.listAppend("slimeling?");
			}
			else
			{
				string [int] things_to_do_before_fighting_king;
				if (!is_wearing_outfit("Knob Goblin Harem Girl Disguise"))
					things_to_do_before_fighting_king.listAppend("wear harem girl disguise");
				if ($effect[Knob Goblin Perfume].have_effect() > 0)
				{
				}
				else
				{
					if ($item[knob goblin perfume].available_amount() > 0)
					{
						things_to_do_before_fighting_king.listAppend("use knob goblin perfume");
					}
					else
					{
						things_to_do_before_fighting_king.listAppend("adventure in harem for perfume");
					}
				}
				things_to_do_before_fighting_king.listAppend(fight_king_string);
				harem_lines.listAppend(things_to_do_before_fighting_king.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
			}
			subentry.entries.listAppend("Harem route:|*" + ChecklistGenerateModifierSpan(harem_modifiers) + harem_lines.listJoinComponents("|*"));
		}
		if (can_use_kge_route)
		{
			string [int] kge_modifiers;
			string [int] kge_lines;
			
			if (!have_outfit_components("Knob Goblin Elite Guard Uniform"))
			{
				int outfit_pieces_needed = 0;
				if ($item[Knob Goblin elite polearm].available_amount() == 0)
					outfit_pieces_needed += 1;
				if ($item[Knob Goblin elite pants].available_amount() == 0)
					outfit_pieces_needed += 1;
				if ($item[Knob Goblin elite helm].available_amount() == 0)
					outfit_pieces_needed += 1;
				//take into account combats?
				//with banishes and slimeling and +item and?
                //too complicated. Possibly remove?
				kge_modifiers.listAppend("-combat");
                if ($familiar[slimeling].familiar_is_usable())
                    kge_modifiers.listAppend("slimeling?");
				string line = "Need knob goblin elite guard uniform.|*Semi-rare in barracks.|*Or run -combat in barracks";
				if (familiar_is_usable($familiar[slimeling]))
					line += " with slimeling";
                    
                line += ".";
                
                line += "|*" + generateTurnsToSeeNoncombat(85, outfit_pieces_needed, "acquire outfit via only non-combats");
				kge_lines.listAppend(line);
			}
			else
			{
				string cook_cake_line  = "cook a knob cake";
                
                 if (!__misc_state["can cook for free"])
                 {
                    cook_cake_line += " (1 adventure";
                    if (skill_is_usable($skill[inigo's incantation of inspiration]))
                        cook_cake_line += ", can use inigo's";
                    cook_cake_line += ")";
                }
				string [int] things_to_do_before_fighting_king;
				if (!is_wearing_outfit("Knob Goblin Elite Guard Uniform"))
					things_to_do_before_fighting_king.listAppend("wear knob goblin elite guard uniform");
                    
                    
                boolean have_first_step = ($item[knob cake pan].available_amount() > 0 || $item[unfrosted Knob cake].available_amount() > 0);
                boolean have_second_step = ($item[knob batter].available_amount() > 0 || $item[unfrosted Knob cake].available_amount() > 0);
                boolean have_third_step = ($item[knob frosting].available_amount() > 0);
                have_third_step = have_third_step && have_second_step && have_first_step;
                have_second_step = have_second_step && have_first_step;
                    
				if ($item[knob cake].available_amount() > 0)
				{
				}
				else if (have_first_step && have_second_step && have_third_step)
				{
					things_to_do_before_fighting_king.listAppend(cook_cake_line);
				}
				else
				{
					
					string times_remaining = "three times";
					if (have_first_step)
						times_remaining = "two times";
					if (have_second_step)
						times_remaining = "One More Time";
					if (have_third_step)
						times_remaining = "zero times?";
					string line = "adventure in kitchens " + times_remaining + " for knob cake components";
					things_to_do_before_fighting_king.listAppend(line);
					things_to_do_before_fighting_king.listAppend(cook_cake_line);
				}
				things_to_do_before_fighting_king.listAppend(fight_king_string);
				kge_lines.listAppend(things_to_do_before_fighting_king.listJoinComponents(", then ", "").capitaliseFirstLetter() + ".");
			}
			subentry.entries.listAppend("Guard route:|*" + ChecklistGenerateModifierSpan(kge_modifiers) + kge_lines.listJoinComponents("|*"));
		}
        if (!__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "")
        {
            stat stat_race_type = __quest_state["Level 13"].state_string["Stat race type"].to_stat();
            
            int change_mcd_to = -1;
            if (stat_race_type == $stat[muscle] && (current_mcd() == 3 || current_mcd() == 7) && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING)
                change_mcd_to = -2;
            else if (stat_race_type == $stat[mysticality])
                change_mcd_to = 3;
            else if (stat_race_type == $stat[moxie])
                change_mcd_to = 7;
                
            if (change_mcd_to != -1 && change_mcd_to != current_mcd())
            {
                string mcd_change_text = change_mcd_to;
                if (change_mcd_to == -2)
                    mcd_change_text = "anything besides 3 or 7";
                subentry.entries.listAppend("For the king fight, change MCD to " + mcd_change_text + " for the tower stat test. (+" + stat_race_type.to_lower_case() + ")");
            }
        }
	}
    
	
	if (should_output)
		task_entries.listAppend(ChecklistEntryMake(79, base_quest_state.image_name, url, subentry, $locations[cobb's knob barracks, cobb's knob kitchens, cobb's knob harem, the outskirts of cobb's knob]));
}

void QLevel6Init()
{
	//questL06Friar
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL06Friar");
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Deep Fat Friars' Quest";
	state.image_name = "forest friars";
	state.council_quest = true;
	
	if (my_level() >= 6 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
	
	__quest_state["Level 6"] = state;
	__quest_state["Friars"] = state;
}

float QLevel6TurnsToCompleteArea(location place)
{
    //FIXME not sure how accurate these calculations are.
    //First NC will always happen at 6, second at 11, third at 16.
    int turns_spent_in_zone = turnsAttemptedInLocation(place); //not always accurate
    int ncs_found = noncombatTurnsAttemptedInLocation(place);
    
    boolean [string] area_known_ncs;
    if (place == $location[the dark neck of the woods])
        area_known_ncs = $strings[How Do We Do It? Quaint and Curious Volume!,Strike One!,Dodecahedrariffic!];
    if (place == $location[The Dark Heart of the Woods])
        area_known_ncs = $strings[Moon Over the Dark Heart,Running the Lode,Imp Be Nimble\, Imp Be Quick];
    if (place == $location[The Dark Elbow of the Woods])
        area_known_ncs = $strings[Deep Imp Act,Imp Art\, Some Wisdom,Butter Knife? I'll Take the Knife];
    
    if (area_known_ncs.count() > 0)
    {
        ncs_found = 0;
        string [int] location_ncs = place.locationSeenNoncombats();
        foreach key, s in location_ncs
        {
            if (area_known_ncs contains s)
                ncs_found += 1;
        }
    }
    if (ncs_found == 3)
        return 0.0;
    
    float turns_remaining = 0.0;
    int ncs_remaining = MAX(0, 3 - ncs_found);
    
    float combat_rate = 0.9 + combat_rate_modifier() / 100.0;
    float noncombat_rate = 1.0 - combat_rate;
    
    if (noncombat_rate != 0.0)
        turns_remaining = ncs_remaining / noncombat_rate;
    else
        turns_remaining = 10000.0; //how do you refer to infinity in this language?
    
    return MIN(turns_remaining, MAX(0.0, 16.0 - turns_spent_in_zone.to_float()));
}


void QLevel6GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 6"].in_progress)
		return;
	boolean want_hell_ramen = false;
	if ($skill[pastamastery].skill_is_usable() && $skill[Advanced Saucecrafting].skill_is_usable())
		want_hell_ramen = true;
    if (my_path_id() == PATH_SLOW_AND_STEADY)
        want_hell_ramen = false;
    want_hell_ramen = false; //this needs rethinking
    
	boolean hot_wings_relevant = __quest_state["Pirate Quest"].state_boolean["hot wings relevant"];
	boolean need_more_hot_wings = __quest_state["Pirate Quest"].state_boolean["need more hot wings"];
	
	QuestState base_quest_state = __quest_state["Level 6"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	if (want_hell_ramen && __misc_state["have olfaction equivalent"])
		subentry.modifiers.listAppend("olfact hellions");
	
	string [int] sources_need_234;
	if (want_hell_ramen)
		sources_need_234.listAppend("hell ramen");
	if (need_more_hot_wings)
		sources_need_234.listAppend("hot wings");
	if (sources_need_234.count() > 0)
		subentry.modifiers.listAppend("+234% item");
    
    boolean hipster_fights_needed = false;
    boolean need_minus_combat = false;
	if ($item[dodecagram].available_amount() == 0)
    {
        hipster_fights_needed = true;
		subentry.entries.listAppend("Adventure in " + HTMLGenerateSpanOfClass("Dark Neck of the Woods", "r_bold") + ", acquire dodecagram.|~" + roundForOutput(QLevel6TurnsToCompleteArea($location[the dark neck of the woods]), 1) + " average turns remain at " + combat_rate_modifier().floor() + "% combat.");
        need_minus_combat = true;
    }
	if ($item[box of birthday candles].available_amount() == 0)
    {
        hipster_fights_needed = true;
		subentry.entries.listAppend("Adventure in " + HTMLGenerateSpanOfClass("Dark Heart of the Woods", "r_bold") + ", acquire box of birthday candles.|~" + roundForOutput(QLevel6TurnsToCompleteArea($location[the Dark Heart of the Woods]), 1) + " turns remain at " + combat_rate_modifier().floor() + "% combat.");
        need_minus_combat = true;
    }
	if ($item[Eldritch butterknife].available_amount() == 0)
    {
        hipster_fights_needed = true;
		subentry.entries.listAppend("Adventure in " + HTMLGenerateSpanOfClass("Dark Elbow of the Woods", "r_bold") + ", acquire Eldritch butterknife.|~" + roundForOutput(QLevel6TurnsToCompleteArea($location[the Dark Elbow of the Woods]), 1) + " turns remain at " + combat_rate_modifier().floor() + "% combat.");
        need_minus_combat = true;
    }
    
    //hipster fights advance the superlikelies. in slow paths, is this relevant?
    //FIXME suggest in HCO/S&S?
    //if (hipster_fights_needed && __misc_state["have hipster"])
        //subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
	
    string [int] needed_modifiers;
    if (need_minus_combat)
    {
        subentry.modifiers.listAppend("-combat");
        needed_modifiers.listAppend("-combat");
    }
	if (sources_need_234.count() > 0)
        needed_modifiers.listAppend("+234% item for " + listJoinComponents(sources_need_234, "/"));
    if (needed_modifiers.count() > 0)
        subentry.entries.listAppend("Run " + needed_modifiers.listJoinComponents(", ", "and") + ".");
    
	if ($item[dodecagram].available_amount() + $item[box of birthday candles].available_amount() + $item[Eldritch butterknife].available_amount() == 3)
    {
        if (!(hot_wings_relevant && $item[hot wing].available_amount() <3))
        {
            subentry.entries.listAppend("Go to the cairn stones!");
        }
        else
        {
            subentry.entries.listAppend("Visit the dark heart of the woods for hot wings.");
        }
    }
	if (!get_property_ascension("lastTempleUnlock") && QuestState("questM16Temple").in_progress && $item[heavy-duty bendy straw].available_amount() == 0)
        subentry.entries.listAppend("Potentially find a heavy-duty bendy straw, first.|From fallen archfiends in the dark heart of the woods.");
	if (__misc_state_int["ruby w needed"] > 0)
		subentry.entries.listAppend("Potentially find ruby W, if not clovering (w imp, dark neck, 30% drop)");
	if (hot_wings_relevant)
    {
        if ($item[hot wing].available_amount() <3 )
            subentry.entries.listAppend((MIN(3, $item[hot wing].available_amount())) + "/3 hot wings for pirate quest. (optional, 30% drop)");
        else
            subentry.entries.listAppend((MIN(3, $item[hot wing].available_amount())) + "/3 hot wings for pirate quest.");
    }
	boolean should_delay = false;
	if (!__quest_state["Manor Unlock"].state_boolean["ballroom song effectively set"] && need_minus_combat)
	{
		subentry.entries.listAppend(HTMLGenerateSpanOfClass("Wait until -combat ballroom song set.", "r_bold"));
		should_delay = true;
	}
	
	if (should_delay)
		future_task_entries.listAppend(ChecklistEntryMake(76, base_quest_state.image_name, "friars.php", subentry, $locations[the dark neck of the woods, the dark heart of the woods, the dark elbow of the woods]));
	else
		task_entries.listAppend(ChecklistEntryMake(77, base_quest_state.image_name, "friars.php", subentry, $locations[the dark neck of the woods, the dark heart of the woods, the dark elbow of the woods]));
}

void QLevel7Init()
{
	//questL07Cyrptic
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL07Cyrptic");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Cyrpt Quest";
	state.image_name = "cyrpt";
	state.council_quest = true;
	
	if (my_level() >= 7 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
	
    if (state.started)
    {
        state.state_int["alcove evilness"] = get_property_int("cyrptAlcoveEvilness");
        state.state_int["cranny evilness"] = get_property_int("cyrptCrannyEvilness");
        state.state_int["niche evilness"] = get_property_int("cyrptNicheEvilness");
        state.state_int["nook evilness"] = get_property_int("cyrptNookEvilness");
	}
    else
    {
        //mafia won't track these properly until quest is started, I think?
        state.state_int["alcove evilness"] = 50;
        state.state_int["cranny evilness"] = 50;
        state.state_int["niche evilness"] = 50;
        state.state_int["nook evilness"] = 50;
    }
    
    if (state.finished)
    {
        //just in case:
        state.state_int["alcove evilness"] = 0;
        state.state_int["cranny evilness"] = 0;
        state.state_int["niche evilness"] = 0;
        state.state_int["nook evilness"] = 0;
    }
    
    foreach l in $strings[alcove,cranny,niche,nook]
    {
        boolean need_speeding_up = false;
        int evilness = state.state_int[l + " evilness"];
        
        if (l == "alcove" && get_property_monster("romanticTarget") == $monster[modern zmobie])
            evilness -= 5 * get_property_int("_romanticFightsLeft");
        
        if (evilness <= 26)
            need_speeding_up = false;
        else
            need_speeding_up = true;
        state.state_boolean[l + " needs speed tricks"] = need_speeding_up;
            
    }
    
	if (state.state_int["alcove evilness"] <= 0)
		state.state_boolean["alcove finished"] = true;
	if (state.state_int["cranny evilness"] <= 0)
		state.state_boolean["cranny finished"] = true;
	if (state.state_int["niche evilness"] <= 0)
		state.state_boolean["niche finished"] = true;
	if (state.state_int["nook evilness"] <= 0)
		state.state_boolean["nook finished"] = true;
		
		
	__quest_state["Level 7"] = state;
	__quest_state["Cyrpt"] = state;
}


void QLevel7GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 7"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 7"];
	
	ChecklistEntry entry = ChecklistEntryMake(72);
	entry.url = "crypt.php";
	entry.image_lookup_name = base_quest_state.image_name;
	entry.should_indent_after_first_subentry = true;
	entry.subentries.listAppend(ChecklistSubentryMake(base_quest_state.quest_name));
    entry.should_highlight = $locations[the defiled nook, the defiled cranny, the defiled alcove, the defiled niche, haert of the cyrpt] contains __last_adventure_location;
	
	string [int] evilness_properties = split_string_alternate("cyrptAlcoveEvilness,cyrptCrannyEvilness,cyrptNicheEvilness,cyrptNookEvilness", ",");
	string [string] evilness_text;
	
	float universal_evilness_removed_per_adventure = 0.0;
	string superhero_cape_suggestions;
	boolean superhero_cape_active = false;
	if (lookupItem("unwrapped knock-off retro superhero cape").have())
	{
		string [int] tasks;
        if (!lookupItem("unwrapped knock-off retro superhero cape").equipped())
        {
        	tasks.listAppend("equip the retro superhero cape");
            entry.url = "inventory.php?which=2&ftext=unwrapped+knock-off+retro+superhero+cape";
        }
        if ($slot[weapon].equipped_item().item_type() != "sword")
        {
        	tasks.listAppend("equip a sword in mainhand");
        }
        if ($effect[Iron Palms].have_effect() != 0)
        {
        	tasks.listAppend("cast iron palm technique");
        }
		if (!(get_property("retroCapeSuperhero") == "vampire" && get_property("retroCapeWashingInstructions") == "kill"))
        {
        	string line = "switch";
            if (tasks.count() == 0)
            {
            	line += " the retro superhero cape";
                entry.url = "inventory.php?action=hmtmkmkm";
            }
            line += " to Vampire Slicer/Kill Me";
        	tasks.listAppend(line);
        }
        if (tasks.count() > 0)
        {
        	superhero_cape_suggestions = HTMLGenerateSpanFont(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".", "red");
        }
        else
        {
        	superhero_cape_active = true;
            superhero_cape_suggestions = "Cast Slay the Dead every combat.";
            universal_evilness_removed_per_adventure += 1.0;
        }
	}
	foreach key in evilness_properties
	{
		string property = evilness_properties[key];
		int evilness = get_property_int(property);
		string text;
		if (evilness == 0)
			text = "Finished";
		else if (evilness <= 25)
			text = HTMLGenerateSpanFont("At boss", "red");
		else
			text = (evilness - 25) + " evilness to boss.";
		evilness_text[property] = text;
	}
	
	if (!base_quest_state.state_boolean["nook finished"])
	{
		int evilness = base_quest_state.state_int["nook evilness"];
		ChecklistSubentry subentry;
		subentry.header = "Defiled Nook";
		
		subentry.entries.listAppend(evilness_text["cyrptNookEvilness"]);
		
		if (evilness > 26 && my_path_id() != PATH_G_LOVER)
		{
            subentry.modifiers.listAppend("+400% item");
            float item_drop = (100.0 + $location[the defiled nook].item_drop_modifier_for_location()) / 100.0;
            
			float eyes_per_adventure = MIN(1.0, (item_drop) * 0.2);
            float eyes_value = 3.0;
            if (evilness < 29)
                eyes_value = clampi(evilness - 25 - 1, 0, 3);
			float evilness_per_adventure = 1.0;
            if ($item[gravy boat].equipped_amount() > 0)
                evilness_per_adventure += 1.0;
            evilness_per_adventure += universal_evilness_removed_per_adventure;
            evilness_per_adventure = MAX(evilness_per_adventure, evilness_per_adventure + eyes_per_adventure * eyes_value);
			
			if ($item[evil eye].available_amount() > 0)
            {
                if ($item[evil eye].available_amount() == 1)
                    subentry.entries.listAppend("Use your evil eye.");
                else
                    subentry.entries.listAppend("Use your evil eyes.");
            }
            if (__iotms_usable[$item[haunted doghouse]] && !$location[the defiled nook].noncombat_queue.contains_text("Seeing-Eyes Dog") && $location[the defiled nook].turns_spent >= 5)// && evilness <= 25 + 9)
            {
                //haunted doghouse adventures are a percentage chance, and the NC is skippable. more NCs, more chances, less turns spent
                subentry.modifiers.listAppend("-combat");
            }
            if (my_path_id() == PATH_EXPLOSIONS)
            	subentry.entries.listAppend("Ignore this area until the end of the run; wandering astronauts drop evil eyes. Lure them to delay-burning areas; keep signal jammer equipped otherwise.");
		
			float evilness_remaining = evilness - 25;
			evilness_remaining -= $item[evil eye].available_amount() * 3;
			if (evilness_remaining > 0)
			{
				float average_turns_remaining = (evilness_remaining / evilness_per_adventure);
				int theoretical_best_turns_remaining = ceil(evilness_remaining / 4.0);
				if (average_turns_remaining < theoretical_best_turns_remaining) //not sure about this. +344.91% item, 38 evilness, 4 optimal, 3.something not-optimal, what does it mean?
					average_turns_remaining = theoretical_best_turns_remaining;
		
				subentry.entries.listAppend(roundForOutput(eyes_per_adventure * 100.0, 0) + "% chance of evil eyes.");
				subentry.entries.listAppend("~" + roundForOutput(average_turns_remaining, 1) + " turns remain to boss. (theoretical best: " + theoretical_best_turns_remaining + ")");
                if (superhero_cape_suggestions.length() > 0)
                	subentry.entries.listAppend(superhero_cape_suggestions);
			}
		}
		
		
		entry.subentries.listAppend(subentry);
	}
	if (!base_quest_state.state_boolean["niche finished"])
	{
		int evilness = base_quest_state.state_int["niche evilness"];
		ChecklistSubentry subentry;
		subentry.header = "Defiled Niche";
		
		subentry.entries.listAppend(evilness_text["cyrptNicheEvilness"]);
        
        float [monster] appearance_rates = $location[the defiled niche].appearance_rates_adjusted_cancel_nc();
        float evilness_removed_per_adventure = 0.0;
        evilness_removed_per_adventure += 1.0 * appearance_rates[$monster[slick lihc]] / 100.0;
        evilness_removed_per_adventure += 1.0 * appearance_rates[$monster[senile lihc]] / 100.0;
        evilness_removed_per_adventure += 3.0 * appearance_rates[$monster[dirty old lihc]] / 100.0;
        evilness_removed_per_adventure += universal_evilness_removed_per_adventure;
        
        float turns_remaining = MAX(0, evilness - 25);
        
        if (evilness_removed_per_adventure != 0.0)
            turns_remaining = MAX(1, turns_remaining / evilness_removed_per_adventure);
        
        if (floor(turns_remaining) * 3 < evilness)
            turns_remaining = ceiling(turns_remaining);
        
        
		if (evilness > 26 && (appearance_rates[$monster[slick lihc]] > 0.0 || appearance_rates[$monster[senile lihc]] > 0.0))
        {
            subentry.modifiers.listAppend("olfact dirty old lihc");
            subentry.modifiers.listAppend("banish");
        }
		if (evilness > 25)
            subentry.entries.listAppend("~" + turns_remaining.roundForOutput(1) + " turns remaining to boss.");
        if (evilness > 26 && superhero_cape_suggestions.length() > 0)
            subentry.entries.listAppend(superhero_cape_suggestions);
		
		
		entry.subentries.listAppend(subentry);
	}
	if (!base_quest_state.state_boolean["cranny finished"])
	{
		ChecklistSubentry subentry;
		subentry.header = "Defiled Cranny";
		subentry.entries.listAppend(evilness_text["cyrptCrannyEvilness"]);
		
		if (base_quest_state.state_int["cranny evilness"] > 26)
		{
            subentry.modifiers.listAppend("-combat");
            subentry.modifiers.listAppend("+ML");
            float monster_level = monster_level_adjustment_for_location($location[the defiled cranny]);
            
            monster_level = MAX(monster_level, 0);
            
			float cranny_beep_beep_beep = MAX(3.0,sqrt(monster_level));
			int beep_boop_lookup = floor(cranny_beep_beep_beep) - 3;
            
            float area_combat_rate = clampNormalf(0.85 + combat_rate_modifier() / 100.0);
            float area_nc_rate = 1.0 - area_combat_rate;
            
            float average_beeps_per_turn = cranny_beep_beep_beep * area_nc_rate + 1.0 * area_combat_rate;
            average_beeps_per_turn += universal_evilness_removed_per_adventure;
            float average_turns_remaining = ((base_quest_state.state_int["cranny evilness"] - 25) / average_beeps_per_turn);
            
            average_turns_remaining = MAX(1, average_turns_remaining);
			
			subentry.entries.listAppend("~" + cranny_beep_beep_beep.roundForOutput(1) + " beeps per ghuol swarm. ~" + average_turns_remaining.roundForOutput(1) + " turns remain to boss.");
   
   			if (superhero_cape_suggestions.length() > 0)
                	subentry.entries.listAppend(superhero_cape_suggestions);
		}
        else if (base_quest_state.state_int["cranny evilness"] <= 25)
            subentry.modifiers.listAppend("+meat");
		
		entry.subentries.listAppend(subentry);
	}
	if (!base_quest_state.state_boolean["alcove finished"])
	{
		ChecklistSubentry subentry;
		int evilness = base_quest_state.state_int["alcove evilness"];
		subentry.header = "Defiled Alcove";
		subentry.entries.listAppend(evilness_text["cyrptAlcoveEvilness"]);
        
        
        int evilness_after_arrow = evilness;
        if (get_property_monster("romanticTarget") == $monster[modern zmobie])
            evilness_after_arrow -= 5 * get_property_int("_romanticFightsLeft");
        
        if (evilness_after_arrow <= 25 && evilness > 25)
        {
            subentry.entries.listAppend("Wait for modern zmobie arrows.");
        }
		else if (evilness > 26)
		{
            subentry.modifiers.listAppend("+850% init");
            subentry.modifiers.listAppend("-combat");
            
			int zmobies_needed = ceil((evilness.to_float() - 26.0) / (5.0 + universal_evilness_removed_per_adventure));
			float zmobie_chance = min(100.0, 15.0 + initiative_modifier_for_location($location[the defiled alcove]) / 10.0);
			
			subentry.entries.listAppend(pluralise(zmobies_needed, "modern zmobie", "modern zmobies") + " needed (" + roundForOutput(zmobie_chance, 0) + "% chance of appearing)");
            
            //float combat_rate = clampNormalf(0.85 + combat_rate_modifier() / 100.0);
            //float nc_rate = 1.0 - combat_rate;
            
            if ($familiar[oily woim].familiar_is_usable() && !(($familiars[oily woim,happy medium] contains my_familiar())))
            {
                if (!(my_familiar() == $familiar[Xiblaxian Holo-Companion] && my_familiar() != $familiar[none]))
                    subentry.entries.listAppend("Run " + $familiar[oily woim] + ($familiar[happy medium].familiar_is_usable() ? "/medium" : "") + ($familiar[Xiblaxian Holo-Companion].familiar_is_usable() ? "/holo-companion" : "") + " for +init.");
            }
			if (superhero_cape_suggestions.length() > 0)
                	subentry.entries.listAppend(superhero_cape_suggestions);
            
		}
        else if (evilness <= 25)
            subentry.modifiers.listAppend("+meat");
		entry.subentries.listAppend(subentry);
	}
	if (base_quest_state.mafia_internal_step == 2)
	{
		entry.subentries[0].entries.listAppend("Go talk to the council to finish the quest.");
        entry.url = "place.php?whichplace=town";
	}
	else if (base_quest_state.state_boolean["alcove finished"] && base_quest_state.state_boolean["cranny finished"] && base_quest_state.state_boolean["niche finished"] && base_quest_state.state_boolean["nook finished"])
	{
        float bonerdagon_attack = (90 + monster_level_adjustment());
        
        string line = "Fight bonerdagon!";
        if (my_path_id() == PATH_HEAVY_RAINS)
            line = "Fight auqadargon!";
        if (my_basestat($stat[moxie]) < bonerdagon_attack)
            line += " (attack: " + bonerdagon_attack.round() + ")";
		entry.subentries[0].entries.listAppend(line);
	}
	task_entries.listAppend(entry);
}



string generateNinjaSafetyGuide(boolean show_colour)
{
	boolean can_survive = false;
	float init_needed = $monster[ninja snowman assassin].monster_initiative();
	init_needed = monster_initiative($monster[Ninja snowman assassin]);
	
	float damage_taken = calculateCurrentNinjaAssassinMaxDamage();
    float damage_taken_always = calculateCurrentNinjaAssassinMaxEnvironmentalDamage();
	
	string result;
	if (initiative_modifier() >= init_needed)
	{
        if (my_hp() >= ceil(damage_taken_always) + 2)
            can_survive = true;
		result += "Keep";
	}
	else
		result += "Need";
	result += " +" + ceil(init_needed) + "% init";
    
    if (damage_taken_always > my_hp())
        result += "/" + ceil(damage_taken_always) + " HP";
    
    result += " to survive ninja, or ";
    
    //FIXME warn about damage_taken_always WITH INIT
	
	int min_safe_damage = (ceil(damage_taken) + 2) + (ceil(damage_taken_always) + 2) ;
	if (my_hp() >= min_safe_damage)
	{
		result += "keep";
		can_survive = true;
	}
	else
		result += "need";
	result += " HP above " + min_safe_damage + ".";
    
    if (my_path_id() == PATH_CLASS_ACT_2 && monster_level_adjustment() > 50)
    {
        result += " Reduce ML to +50 to prevent elemental damage.";
        can_survive = false;
    }
	
	if (!can_survive && show_colour)
		result = HTMLGenerateSpanFont(result, "red");
	return result;
}


void CopiedMonstersGenerateDescriptionForMonster(string monster_name, string [int] description, boolean show_details, boolean from_copy)
{
    if (!__misc_state["in run"])
        return;
    monster_name = monster_name.to_lower_case();
	if (monster_name == "ninja snowman assassin")
	{
		description.listAppend(generateNinjaSafetyGuide(show_details));
        int components_missing = $items[ninja rope,ninja carabiner,ninja crampons].items_missing().count();
        if (components_missing > 0)
            description.listAppend("Need to fight " + components_missing.int_to_wordy() + " more.");
        else
            description.listAppend("Don't need to fight anymore.");
        
        if (from_copy && $familiar[obtuse angel].familiar_is_usable() && $familiar[reanimated reanimator].familiar_is_usable())
        {
            string line = "Make sure to copy with angel, not the reanimator.";
            if (my_familiar() == $familiar[reanimated reanimator])
                line = HTMLGenerateSpanFont(line, "red");
            description.listAppend(line);
        }
	}
	else if (monster_name == "quantum mechanic")
	{
		string line;
		boolean requirements_met = false;
		if (item_drop_modifier_ignoring_plants() < 150.0)
			line += "Need ";
		else
		{
			line += "Keep ";
			requirements_met = true;
		}
		line += "+150% item for large box";
		if (show_details && !requirements_met)
			line = HTMLGenerateSpanFont(line, "red");
		description.listAppend(line);
	}
    else if ($strings[bricko bat,bricko cathedral,bricko elephant,bricko gargantuchicken,bricko octopus,bricko ooze,bricko oyster,bricko python,bricko turtle,bricko vacuum cleaner] contains monster_name)
    {
        description.listAppend("Zero adventure cost, use to burn delay.");
    }
    else if (monster_name == "lobsterfrogman" && show_details)
    {
        string line;
    
        if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
        {
            int number_to_fight = clampi(5 - $item[barrel of gunpowder].available_amount(), 0, 5);
            line += number_to_fight.int_to_wordy().capitaliseFirstLetter() + " more to defeat. ";
        }
        
        int lfm_attack = $monster[lobsterfrogman].base_attack + 5.0;
        string attack_text = lfm_attack + " attack.";
        
		if (my_buffedstat($stat[moxie]) < lfm_attack)
			attack_text = HTMLGenerateSpanFont(attack_text, "red");
        
        line += attack_text;
        description.listAppend(line);
    }
    else if (monster_name == "big swarm of ghuol whelps" || monster_name == "swarm of ghuol whelps" || monster_name == "giant swarm of ghuol whelps")
    {
        float monster_level = monster_level_adjustment_ignoring_plants();
    
        monster_level = MAX(monster_level, 0);
        
        float cranny_beep_beep_beep = MAX(3.0,sqrt(monster_level));
        description.listAppend("~" + cranny_beep_beep_beep.roundForOutput(1) + " cranny beeps.");
    }
    else if (monster_name == "writing desk")
    {
        /*if ($item[telegram from Lady Spookyraven].available_amount() > 0)
            description.listAppend(HTMLGenerateSpanFont("Read the telegram from Lady Spookyraven first.", "red"));
        int desks_remaining = clampi(5 - get_property_int("writingDesksDefeated"), 0, 5);
        if (desks_remaining > 0 && !get_property_ascension("lastSecondFloorUnlock") && $item[Lady Spookyraven's necklace].available_amount() == 0 && get_property("questM20Necklace") != "finished")
            description.listAppend(pluraliseWordy(desks_remaining, "desk", "desks").capitaliseFirstLetter() + " remaining.");*/
        description.listAppend("This doesn't work anymore.");

    }
    else if (monster_name == "skinflute" || monster_name == "camel's toe")
    {
        description.listAppend("Have " + pluralise($item[star]) + " and " + pluralise($item[line]) + ".");
		if (item_drop_modifier_ignoring_plants() < 234.0)
			description.listAppend(HTMLGenerateSpanFont("Need +234% item.", "red"));
    }
    else if (monster_name == "source agent")
    {
        if (monster_level_adjustment() > 0)
            description.listAppend("Possibly remove +ML.");
        string stat_description;
        
        if (get_property_int("sourceAgentsDefeated") > 0)
            stat_description += pluralise(get_property_int("sourceAgentsDefeated"), "agent", "agents") + " defeated so far. ";
        stat_description += $monster[Source Agent].base_attack + " attack.";
        float our_init = initiative_modifier();
        if ($skill[Overclocked].have_skill())
            our_init += 200;
        float agent_initiative = $monster[Source Agent].base_initiative;
        float chance_to_get_jump = clampf(100 - agent_initiative + our_init, 0.0, 100.0);
        boolean might_not_gain_init = false;
        boolean avoid_displaying_init_otherwise = false;
        if (my_thrall() == $thrall[spaghetti elemental] && my_thrall().level >= 5 && monster_level_adjustment() <= 150)
        {
            stat_description += "|Will effectively gain initiative on agent.";
            if (!__iotms_usable[$item[source terminal]] || get_property_int("_sourceTerminalPortscanUses") >= 3)
                avoid_displaying_init_otherwise = true;
        }
        if (avoid_displaying_init_otherwise)
        {
        }
        else if (chance_to_get_jump >= 100.0)
            stat_description += "|Will gain initiative on agent.";
        else if (chance_to_get_jump <= 0.0)
        {
            stat_description += "|Will not gain initiative on agent. Need " + round(agent_initiative - our_init) + "% more init.";
            might_not_gain_init = true;
        }
        else
        {
            stat_description += "|" + round(chance_to_get_jump) + "% chance to gain initiative on agent.";
            might_not_gain_init = true;
        }
        if (might_not_gain_init)
        {
            if (my_class() == $class[pastamancer] && $skill[bind spaghetti elemental].have_skill() && my_thrall() != $thrall[spaghetti elemental])
            {
                stat_description += " Or run ";
                if ($thrall[spaghetti elemental].level < 5)
                    stat_description += "and level up ";
                stat_description += "a spaghetti elemental to block the first attack.";
            }
        }
        description.listAppend(stat_description);
        if (__last_adventure_location == $location[the haunted bedroom])
            description.listAppend("Won't appear in the haunted bedroom, so may want to go somewhere else?");
        if ($skill[Humiliating Hack].have_skill())
        {
            string [int] delevelers;
            if ($skill[ruthless efficiency].have_skill() && $effect[ruthlessly efficient].have_effect() == 0)
            {
                delevelers.listAppend("cast ruthless efficiency");
            }
            if ($item[dark porquoise ring].available_amount() > 0 && $item[dark porquoise ring].equipped_amount() == 0 && $item[dark porquoise ring].can_equip())
            {
                delevelers.listAppend("equip dark porquoise ring");
            }
            if (delevelers.count() > 0)
            {
                description.listAppend("Possibly " + delevelers.listJoinComponents(", ", "or") + " for better deleveling.");
            }
        }
    }
    
    if (__misc_state["monsters can be nearly impossible to kill"] && monster_level_adjustment() > 0)
        description.listAppend(HTMLGenerateSpanFont("Possibly remove +ML to survive. (at +" + monster_level_adjustment() + " ML)", "red"));
}

void generateCopiedMonstersEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task) //if from_task is false, assumed to be from resources
{
	string [int] description;
	boolean very_important = false;
	int show_up_in_tasks_turn_cutoff = 10;
	string title = "";
	int min_turns_until = -1;
    string url = "";
    if (get_property_boolean("dailyDungeonDone"))
        url = $location[the daily dungeon].getClickableURLForLocation();
    Counter romantic_arrow_counter = CounterLookup("Romantic Monster", ErrorMake(), true);
	if (false && (romantic_arrow_counter.CounterIsRange() || get_property_int("_romanticFightsLeft") > 0))
	{
        Vec2i turn_range = romantic_arrow_counter.CounterGetWindowRange();
        
        title = "Arrowed " + __misc_state_string["Romantic Monster Name"].to_lower_case() + " appears ";
        
        if (turn_range.y <= 0)
            title += "now or soon";
        else if (turn_range.x <= 0)
            title += "between now and " + turn_range.y + " turns.";
        else
            title += "in [" + turn_range.x + " to " + turn_range.y + "] turns.";
        
        min_turns_until = turn_range.x;
        
        int fights_left = get_property_int("_romanticFightsLeft");
        if (fights_left > 1)
        {
            string line = fights_left + " fights left";
            
            Vec2i estimated_range = Vec2iMake(15 * (fights_left - 1), 25 * (fights_left - 1));
            estimated_range.x += turn_range.x;
            estimated_range.y += turn_range.y;
            
            line += " over ~" + (estimated_range.x + estimated_range.y) / 2 + " turns.";
            
            description.listAppend(line);
        }
        else if (fights_left == 1)
            description.listAppend("Last fight.");
        
        
        
        
        if (turn_range.x <= 0)
            very_important = true;
	}
	if (from_task && min_turns_until > show_up_in_tasks_turn_cutoff)
		return;
	if (!from_task && min_turns_until <= show_up_in_tasks_turn_cutoff)
		return;
		
	if (title != "")
	{
		CopiedMonstersGenerateDescriptionForMonster(__misc_state_string["Romantic Monster Name"], description, very_important, false);
	}
	
	if (title != "")
	{
		int importance = 4;
		if (very_important)
			importance = -11;
		ChecklistEntry entry = ChecklistEntryMake(255, __misc_state_string["obtuse angel name"], url, ChecklistSubentryMake(title, "", description), importance);
		if (very_important)
			task_entries.listAppend(entry);
		else
			optional_task_entries.listAppend(entry);
			
	}
}

void SCopiedMonstersGenerateResourceForCopyType(ChecklistEntry [int] resource_entries, item shaking_object, string shaking_shorthand_name, string monster_name_property_name)
{
	if (shaking_object.available_amount() == 0 && shaking_object != $item[none])
		return;
    
    string url = "inventory.php?which=3&ftext=" + shaking_object;
	
	string [int] monster_description;
	string monster_name = get_property(monster_name_property_name).HTMLEscapeString();
	CopiedMonstersGenerateDescriptionForMonster(monster_name, monster_description, true, true);
    
    if (get_auto_attack() != 0)
    {
        url = "account.php?tab=combat";
        monster_description.listAppend("Auto attack is on, disable it?");
    }
	
	//string line = monster_name.capitaliseFirstLetter() + HTMLGenerateIndentedText(monster_description);
    string line = HTMLGenerateSpanOfClass(monster_name.capitaliseFirstLetter(), "r_bold");
    
    if (monster_description.count() > 0)
        line += "<hr>" + monster_description.listJoinComponents("|");
    
    string image_name = "__item " + shaking_object;
    if (shaking_shorthand_name == "chateau painting")
    {
        image_name = "__item fancy oil painting";
        url = "place.php?whichplace=chateau";
    }
	
	resource_entries.listAppend(ChecklistEntryMake(256, image_name, url, ChecklistSubentryMake(shaking_shorthand_name.capitaliseFirstLetter() + " monster trapped!", "", line)));
}

void SCopiedMonstersGenerateResource(ChecklistEntry [int] resource_entries)
{
    //Sources:
    
    boolean have_spooky_putty = $items[Spooky Putty ball,Spooky Putty leotard,Spooky Putty mitre,Spooky Putty sheet,Spooky Putty snake,Spooky Putty monster].available_amount() > 0;
    
	int copies_used = get_property_int("spookyPuttyCopiesMade") + get_property_int("_raindohCopiesMade");
	int copies_available = MIN(6,5*MIN($items[Spooky Putty ball,Spooky Putty leotard,Spooky Putty mitre,Spooky Putty sheet,Spooky Putty snake,Spooky Putty monster].available_amount(), 1) + 5*MIN($item[Rain-Doh black box].available_amount() + $item[rain-doh box full of monster].available_amount(), 1));
    int copies_left = copies_available - copies_used;
    
    string [int] potential_copies;
    if (true)
    {
        //ghuol whelps, modern zmobies, wine racks, gaudy pirates, lobsterfrogmen, ninja assassin
        if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
            potential_copies.listAppend("Lobsterfrogman.");
        if (__quest_state["Level 7"].state_boolean["cranny needs speed tricks"])
            potential_copies.listAppend("Swarm of ghuol whelps.");
        if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"])
            potential_copies.listAppend("Modern zmobies.");
        if (!__quest_state["Level 8"].state_boolean["Mountain climbed"] && $items[ninja rope,ninja carabiner,ninja crampons].available_amount() == 0 && !have_outfit_components("eXtreme Cold-Weather Gear"))
            potential_copies.listAppend("Ninja assassin.");
        //if (!__quest_state["Level 11"].finished && !__quest_state["Level 11 Palindome"].finished && $item[talisman o' namsilat].available_amount() == 0 && $items[gaudy key,snakehead charrrm].available_amount() < 2 && my_path_id() != PATH_G_LOVER)
            //potential_copies.listAppend("Gaudy pirate - copy once for extra key.");
        //baa'baa. astronomer? nuns trick brigand
        //FIXME astronomer when we can calculate that
        //if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
            //potential_copies.listAppend("Brigand - nuns trick.");
        //possibly less relevant:
        //ghosts/skulls/bloopers...?
        //seems very marginal
        //if (!__quest_state["Level 13"].state_boolean["past keys"] && ($item[digital key].available_amount() + creatable_amount($item[digital key])) == 0)
            //potential_copies.listAppend("Ghosts/morbid skulls/bloopers, for digital key. (marginal?)");
        //bricko bats, if they have bricko...?
        //if (__misc_state["bookshelf accessible"] && $skill[summon brickos].skill_is_usable())
            //potential_copies.listAppend("Bricko bats...?");
    }
    ChecklistEntry copy_source_entry = ChecklistEntryMake(257);
    
    if (__misc_state["Chateau Mantegna available"] && !get_property_boolean("_chateauMonsterFought"))
    {
        string url = "place.php?whichplace=chateau";
        string header = "Chateau painting copy";
        string [int] description;
        monster current_monster = get_property_monster("chateauMonster");
        
        if (current_monster == $monster[none])
            header += " available";
        else
            header += " fightable";
        
        if (__misc_state["in run"])
        {
            if ($item[alpine watercolor set].available_amount() == 0)
                description.listAppend("Acquire an alpine watercolor set to copy something else.");
            else
                description.listAppend("Copy something else with alpine watercolor set.");
            /*string line;
            if (current_monster == $monster[none])
                line += "Options:";
            else
                line += "Other options:";
            
            if ($item[alpine watercolor set].available_amount() == 0)
            {
                //url = "shop.php?whichshop=chateau";
                line += " (buy alpine watercolor set first)";
            }
            else
                line += " (copy with alpine watercolor set)";
        
            line += "|*" + potential_copies.listJoinComponents("|*");
            description.listAppend(line);*/
        }
        
        if (current_monster != $monster[none])
        {
            string [int] monster_description;
            CopiedMonstersGenerateDescriptionForMonster(current_monster, monster_description, true, true);
            string line = HTMLGenerateSpanOfClass("Currently have " + current_monster.to_string() + ".", "r_bold");
            if (monster_description.count() > 0)
                line += "|*" + monster_description.listJoinComponents("|*");
            description.listPrepend(line);
        }
		//resource_entries.listAppend(ChecklistEntryMake(258, "__item fancy oil painting", url, ChecklistSubentryMake(header, "", description)));
        
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake(header, "", description));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item fancy oil painting";
        if (copy_source_entry.url == "")
            copy_source_entry.url = "place.php?whichplace=chateau";
    }
	if (copies_left > 0)
	{
		string [int] copy_source_list;
		if (have_spooky_putty)
            copy_source_list.listAppend("spooky putty");
		if ($item[Rain-Doh black box].available_amount() + $item[rain-doh box full of monster].available_amount() > 0)
            copy_source_list.listAppend("rain-doh black box");
        
		string copy_sources = copy_source_list.listJoinComponents("/");
		string name = "";
		//FIXME make this possibly say which one in the case of 6 (does that matter? how does that mechanic work?)
		name = pluralise(copies_left, copy_sources + " copy", copy_sources + " copies") + " left";
		string [int] description;// = potential_copies;
        
		//resource_entries.listAppend(ChecklistEntryMake(259, copy_source_list[0], "", ChecklistSubentryMake(name, "", description)));
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake(name, "", description));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = copy_source_list[0];
	}
    
    if (!get_property_boolean("_cameraUsed") && $item[4-d camera].available_amount() > 0)
    {
		//resource_entries.listAppend(ChecklistEntryMake(260, "__item 4-d camera", "", ChecklistSubentryMake("4-d camera copy available", "", potential_copies)));
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake("4-d camera copy available", "", ""));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item 4-d camera";
    }
    if (!get_property_boolean("_iceSculptureUsed") && $item[unfinished ice sculpture].available_amount() > 0)
    {
		//resource_entries.listAppend(ChecklistEntryMake(261, "__item unfinished ice sculpture", "", ChecklistSubentryMake("Ice sculpture copy available", "", potential_copies)));
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake("Ice sculpture copy available", "", ""));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item unfinished ice sculpture";
    }
    if ($item[sticky clay homunculus].available_amount() > 0)
    {
		//resource_entries.listAppend(ChecklistEntryMake(262, "__item sticky clay homunculus", "", ChecklistSubentryMake(pluralise($item[sticky clay homunculus].available_amount(), "sticky clay copy", "sticky clay copies") + " available", "", "Unlimited/day.")));
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake(pluralise($item[sticky clay homunculus].available_amount(), "sticky clay copy", "sticky clay copies") + " available", "", "Unlimited/day."));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item sticky clay homunculus";
    }
    if ($item[print screen button].available_amount() > 0)
    {
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake(pluralise($item[print screen button].available_amount(), "print screen copy", "print screen copies") + " available", "", ""));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item print screen button";
    }
    if ($item[LOV Enamorang].available_amount() > 0)
    {
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake(pluralise($item[LOV Enamorang]), "", ""));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item lov enamorang";
    }
    if (!get_property_boolean("_crappyCameraUsed") && $item[crappy camera].available_amount() > 0)
    {
        string [int] description;// = listCopy(potential_copies);
        description.listPrepend("50% success rate");
		//resource_entries.listAppend(ChecklistEntryMake(263, "__item crappy camera", "", ChecklistSubentryMake("Crappy camera copy available", "", description)));
        
        
        copy_source_entry.subentries.listAppend(ChecklistSubentryMake("Crappy camera copy available", "", description));
        if (copy_source_entry.image_lookup_name == "")
            copy_source_entry.image_lookup_name = "__item crappy camera";
    }
    if (copy_source_entry.subentries.count() > 0)
    {
        ChecklistSubentry last_subentry = copy_source_entry.subentries[copy_source_entry.subentries.count() - 1];
        if (last_subentry.entries.count() > 0 && potential_copies.count() > 0)
        {
            copy_source_entry.subentries.listAppend(ChecklistSubentryMake("Potential targets:", "", potential_copies));
        }
        else
            last_subentry.entries.listAppendList(potential_copies);
        copy_source_entry.ChecklistEntrySetAbridgedHeader("Monster copy sources");
        resource_entries.listAppend(copy_source_entry);
    }
    
    //Copies made:


	generateCopiedMonstersEntry(resource_entries, resource_entries, false);
	SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[Rain-Doh box full of monster], "rain doh", "rainDohMonster");
	SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[spooky putty monster], "spooky putty", "spookyPuttyMonster");
    if (!get_property_boolean("_cameraUsed"))
        SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[shaking 4-d camera], "shaking 4-d camera", "cameraMonster");
    if (!get_property_boolean("_crappyCameraUsed"))
        SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[shaking crappy camera], "shaking crappy camera", "crappyCameraMonster");
	if (!get_property_boolean("_photocopyUsed"))
		SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[photocopied monster], "photocopied", "photocopyMonster");
	if (!get_property_boolean("_envyfishEggUsed"))
		SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[envyfish egg], "envyfish egg", "envyfishMonster");
	if (!get_property_boolean("_iceSculptureUsed"))
		SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[ice sculpture], "ice sculpture", "iceSculptureMonster");
    SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[screencapped monster], "screencapped", "screencappedMonster");
        
	//if (__misc_state["Chateau Mantegna available"] && !get_property_boolean("_chateauMonsterFought"))
		//SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[none], "chateau painting", "chateauMonster");
    
    SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[wax bugbear], "wax bugbear", "waxMonster");
    SCopiedMonstersGenerateResourceForCopyType(resource_entries, $item[crude monster sculpture], "crude sculpture", "crudeMonster");
}

void SCopiedMonstersGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	generateCopiedMonstersEntry(task_entries, optional_task_entries, true);
	
}

void QLevel8Init()
{
	//questL08Trapper
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL08Trapper");
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Trapper Quest";
	state.image_name = "trapper";
	state.council_quest = true;
    
    if (get_property("peteMotorbikeTires") == "Snow Tires" && state.started && !state.finished && state.mafia_internal_step < 4) //sort of hacky - they're not actually there, but...
    {
        state.mafia_internal_step = 4;
    }
    
	
	if (state.mafia_internal_step > 2)
		state.state_boolean["Past mine"] = true;
	if (state.mafia_internal_step > 3)
		state.state_boolean["Mountain climbed"] = true;
	if (state.mafia_internal_step > 5)
		state.state_boolean["Groar defeated"] = true;
	
	state.state_string["ore needed"] = get_property("trapperOre").HTMLEscapeString();
	
	if (my_level() >= 8 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
	
	__quest_state["Level 8"] = state;
	__quest_state["Trapper"] = state;
}


void QLevel8GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 8"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 8"];
    string image_name = base_quest_state.image_name;
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
    string url = "place.php?whichplace=mclargehuge";
	string talk_to_trapper_string = "Go talk to the trapper.";
    
    float cold_resistance = numeric_modifier("cold resistance");
    string need_cold_res_string = "acquire " + (5.0 - cold_resistance).to_int() + " more " + HTMLGenerateSpanOfClass("cold resistance", "r_element_cold");
	
	if (base_quest_state.mafia_internal_step == 1)
	{
		subentry.entries.listAppend(talk_to_trapper_string);
	}
	else if (!base_quest_state.state_boolean["Past mine"])
	{
		string cheese_header; //string cheese
		string [int] cheese_lines;
		
		cheese_header = MIN(3, $item[goat cheese].available_amount()) + "/3 goat cheese found";
		if ($item[goat cheese].available_amount() <3 )
			cheese_header += " (40% drop)";
		
		boolean need_cheese = $item[goat cheese].available_amount() <3;
		
		if (need_cheese)
		{
			subentry.modifiers.listAppend("150% item");
			if (__misc_state["have olfaction equivalent"])
				subentry.modifiers.listAppend("olfact dairy goats");
			
				
			if ($skill[Advanced Saucecrafting].skill_is_usable() && fullness_limit() > 0 && __misc_state["can eat just about anything"] && my_path_id() != PATH_SLOW_AND_STEADY)
				cheese_lines.listAppend("Have " + pluralise($item[glass of goat's milk]) + " for magnesium (20% drop)");
		}
		
		subentry.entries.listAppend(cheese_header + HTMLGenerateIndentedText(cheese_lines));
		
		
		
		string ore_header;
		string [int] ore_lines;
		item ore_needed = to_item(base_quest_state.state_string["ore needed"]);
		
		ore_header = MIN(3, ore_needed.available_amount()) + "/3 " + ore_needed + " found";
		
		boolean need_ore = ore_needed.available_amount() <3;
		if (need_ore)
		{
			string [int] potential_ore_sources;
			potential_ore_sources.listAppend("Mining");
            if (!in_bad_moon())
                potential_ore_sources.listAppend("Clovering itznotyerzitzmine (one of each ore, consider if zap available?)");
			
			
			
			boolean need_outfit = true;
			if (have_outfit_components("Mining Gear"))
				need_outfit = false;
			if (my_path_id() == PATH_AVATAR_OF_BORIS)
			{
				subentry.modifiers.listAppend("+150%/+1000% item");
				need_outfit = false;
				potential_ore_sources.listClear();
				potential_ore_sources.listAppend("Fight mountain men in the mine (40%, 10% drop for each ore)");
			}
			if (my_path_id() == PATH_WAY_OF_THE_SURPRISING_FIST)
			{
				string have_skill_text = "";
				if (!skill_is_usable($skill[worldpunch]))
					have_skill_text = " (you do not have this skill yet)";
				potential_ore_sources.listAppend("Earthen Fist will allow mining." + have_skill_text);
				need_outfit = false;
			}
            if ($item[Deck of every card].available_amount() > 0 && $item[Deck of every card].is_unrestricted())
                potential_ore_sources.listAppend("Deck of Every Card - Mine card");
			ore_lines.listAppend("Potential sources of ore:" + HTMLGenerateIndentedText(potential_ore_sources));
			if (skill_is_usable($skill[unaccompanied miner]))
				ore_lines.listAppend("You can free mine. Consider splitting mining over several days for zero-adventure cost.");
			if (need_outfit)
			{
				subentry.modifiers.listAppend("-combat");
                if ($familiar[slimeling].familiar_is_usable())
                    subentry.modifiers.listAppend("slimeling?");
				ore_lines.listAppend("Mining outfit not available. Consider acquiring one via -combat in mine or the semi-rare (30% drop)");
			}
            if (is_wearing_outfit("Mining Gear"))
            {
                url = "mining.php?mine=1";
            }
		
		}
		subentry.entries.listAppend(ore_header + HTMLGenerateIndentedText(ore_lines));
		
		if (!need_cheese && !need_ore)
		{
			subentry.entries.listClear();
			subentry.entries.listAppend(talk_to_trapper_string);
			
		}
	}
	else if (!base_quest_state.state_boolean["Mountain climbed"])
	{
        //ninja:
        string ninja_line;
        boolean ninja_finishes_quest = false;
        if (true)
        {
            string [int] ninja_path;
            string [int] ninja_modifiers;
            
            item [int] items_needed;
            if ($item[ninja rope].available_amount() == 0) items_needed.listAppend($item[ninja rope]);
            if ($item[ninja crampons].available_amount() == 0) items_needed.listAppend($item[ninja crampons]);
            if ($item[ninja carabiner].available_amount() == 0) items_needed.listAppend($item[ninja carabiner]);
            
            if (items_needed.count() == 0)
            {
                if (cold_resistance < 5.0)
                    ninja_path.listAppend(need_cold_res_string.capitaliseFirstLetter() + ".");
                    
                ninja_path.listAppend("Climb the peak.");
                ninja_finishes_quest = true;
            }
            else
            {
                ninja_path.listAppend("Need " + items_needed.listJoinComponents(", ", "and") + ".");
                string [int] assassin_description;
                
                if (get_property_int("_romanticFightsLeft") > 0 && get_property_int("_romanticFightsLeft") >= items_needed.count() && get_property("romanticTarget") == "ninja snowman assassin")
                {
                    ninja_path.listAppend("They will find you.");
                }
                else
                {
                    ninja_modifiers.listAppend("+combat");
                    ninja_path.listAppend("Run +combat in Lair of the Ninja Snowmen, fight assassins.");
                    CopiedMonstersGenerateDescriptionForMonster("ninja snowman assassin", assassin_description, true, false);
                    if (combat_rate_modifier() <= 0.0)
                        ninja_path.listAppend("Need more +combat, assassins won't appear at " + combat_rate_modifier().floor() + "% combat.");
                    else
                    {
                        int turns_spent = $location[lair of the ninja snowmen].turns_spent;
                        if (turns_spent != -1)
                        {
                            float chance = combat_rate_modifier() / 200.0 + turns_spent * 0.015;
                            if (turns_spent == 10 || turns_spent == 20 || turns_spent == 30 || chance >= 1.0)
                                ninja_path.listAppend("Assassin will appear next turn.");
                            else
                                ninja_path.listAppend((chance * 100.0).roundForOutput(0) + "% chance of assassins.");
                        }
                    }
                }
                ninja_path.listAppend(generateNinjaSafetyGuide(true));
            }
            
            ninja_line = "Ninja path:";
            
            if (ninja_modifiers.count() > 0)
                ninja_line += "|*" + ChecklistGenerateModifierSpan(ninja_modifiers) + "|";
            ninja_line += HTMLGenerateIndentedText(ninja_path.listJoinComponents("<hr>"));
            
            if (ninja_finishes_quest)
                ninja_line = ninja_path.listJoinComponents("<hr>");
        }
        //eXtreme outfit:
        string extreme_line;
        if (true)
        {
            string [int] extreme_path;
            string [int] extreme_modifiers;
            
            
            
            item [int] items_needed = missing_outfit_components("eXtreme Cold-Weather Gear");
        
            if (items_needed.count() == 0)
            {
                string [int] things_to_do;
                if (!is_wearing_outfit("eXtreme Cold-Weather Gear"))
                    things_to_do.listAppend("wear eXtreme Cold-Weather Gear");
                
                if (!$location[the extreme slope].noncombat_queue.contains_text("3 eXXXtreme 4ever 6pack"))
                {
                    things_to_do.listAppend("run -combat");
                    things_to_do.listAppend("become eXtreme");
                    extreme_modifiers.listAppend("-combat");
                }
                things_to_do.listAppend("jump onto the mountain top");
                extreme_path.listAppend(things_to_do.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            }
            else
            {
                extreme_path.listAppend("Acquire outfit components: " + items_needed.listJoinComponents(", ", "and") + ".");
                extreme_modifiers.listAppend("-combat");
                extreme_modifiers.listAppend("+item");
                if ($familiar[slimeling].familiar_is_usable())
                    extreme_modifiers.listAppend("slimeling?");
                extreme_path.listAppend("Run -combat and maybe +item on the eXtreme slope.");
            }
        
            extreme_line = "Extreme path:";
            
            if (extreme_modifiers.count() > 0)
                extreme_line += "|*" + ChecklistGenerateModifierSpan(extreme_modifiers) + "|";
            extreme_line += HTMLGenerateIndentedText(extreme_path.listJoinComponents("<hr>"));
            
        }
        if (!ninja_finishes_quest)
            subentry.entries.listAppend("Find a way to climb the peak.");
        subentry.entries.listAppend(ninja_line);
        if (!ninja_finishes_quest) //ninja need not tricks
            subentry.entries.listAppend(extreme_line);
	}
	else if (!base_quest_state.state_boolean["Groar defeated"])
	{
        int turns_remaining = MAX(0, 4 - $location[mist-shrouded peak].turnsAttemptedInLocation());
        
        if (get_property("peteMotorbikeTires") == "Snow Tires")
            turns_remaining = 1;
        
		string [int] todo;
		if (cold_resistance < 5.0)
			todo.listAppend(need_cold_res_string);
            
            
        float groar_attack = (120 + monster_level_adjustment());
        
        string line = "fight Groar at the peak";
        if (my_basestat($stat[moxie]) < groar_attack)
            line += " (attack: " + groar_attack.round() + ")";
            
		todo.listAppend(line);
		subentry.entries.listAppend(todo.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
		
        if (turns_remaining > 1)
        {
            subentry.modifiers.listAppend("+meat");
            subentry.entries.listAppend("Optionally run +meat for " + pluraliseWordy((turns_remaining - 1), "turn", "turns") + ". (200 base meat drop)");
        }
        
        image_name = "Yeti";
	}
	else
	{
		subentry.entries.listAppend(talk_to_trapper_string);
	}
	
	
	
	task_entries.listAppend(ChecklistEntryMake(63, image_name, url, subentry, $locations[itznotyerzitz mine,the goatlet, lair of the ninja snowmen, the extreme slope,mist-shrouded peak, itznotyerzitz mine (in disguise)]));
}

void QLevel9Init()
{
	//questL09Topping
	//oilPeakProgress
	//twinPeakProgress
	//booPeakProgress
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL09Topping");
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Highland Lord Quest";
	state.image_name = "orc chasm";
	state.council_quest = true;
	
    //Recorded in-run:
    //twinPeakProgress(user, now '1', default 0) - +stench one done
    //twinPeakProgress(user, now '3', default 0) - +stench, +item ones done
    //twinPeakProgress(user, now '7', default 0) - +stench, +item, jar ones done
    //twinPeakProgress(user, now '15', default 0) - finished
	//twinPeakProgress(user, now '3', default 0) -> item done, stench done, jar not done, init not done, quest started
	
	if (state.mafia_internal_step > 1)
	{
		state.state_boolean["bridge complete"] = true;
	}
	else
	{
		int bridge_progress = get_property_int("chasmBridgeProgress");
		int fasteners_have = bridge_progress + $item[thick caulk].available_amount() + $item[long hard screw].available_amount() + $item[messy butt joint].available_amount() + 5 * $item[smut orc keepsake box].usable_amount() + 5 * $item[snow boards].usable_amount();
		int lumber_have = bridge_progress + $item[morningwood plank].available_amount() + $item[raging hardwood plank].available_amount() + $item[weirdwood plank].available_amount() + 5 * $item[smut orc keepsake box].usable_amount() + 5 * $item[snow boards].usable_amount();
        if (my_path_id() == PATH_LICENSE_TO_ADVENTURE && get_property_boolean("bondBridge"))
        {
            fasteners_have += 15;
            lumber_have += 15;
        }
		
		int fasteners_needed = MAX(0, 30 - fasteners_have);
		int lumber_needed = MAX(0, 30 - lumber_have);
		
		state.state_int["bridge fasteners needed"] = fasteners_needed;
		state.state_int["bridge lumber needed"] = lumber_needed;
	}
	
	if (my_level() >= 9 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
		
	
	state.state_boolean["can complete twin peaks quest quickly"] = true;
	
	if (my_path_id() == PATH_BEES_HATE_YOU)
		state.state_boolean["can complete twin peaks quest quickly"] = false;
	
	state.state_float["oil peak pressure"] = get_property_float("oilPeakProgress");
	if ($location[oil peak].noncombat_queue.contains_text("Unimpressed with Pressure"))
        state.state_float["oil peak pressure"] = 0.0;
	state.state_int["twin peak progress"] = get_property_int("twinPeakProgress");
	state.state_int["a-boo peak hauntedness"] = get_property_int("booPeakProgress");
    if ($location[a-boo peak].noncombat_queue.contains_text("Come On Ghosty, Light My Pyre"))
        state.state_int["a-boo peak hauntedness"] = 0;
    
	
	if (!state.state_boolean["bridge complete"]) //haven't gotten over there yet. not sure what mafia says at this point, so set some defaults:
	{
		state.state_int["twin peak progress"] = 0;
		state.state_float["oil peak pressure"] = 310.66;
		state.state_int["a-boo peak hauntedness"] = 100;
	}
	if (state.finished)
	{
		state.state_boolean["bridge complete"] = true;
		
		state.state_int["twin peak progress"] = 15;
		state.state_float["oil peak pressure"] = 0.0;
		state.state_int["a-boo peak hauntedness"] = 0;
	}
    
    if (state.state_float["oil peak pressure"] > 500.0) //not sure what causes this. detecting this situation
    {
        state.state_float["oil peak pressure"] = 310.66;
        state.state_boolean["oil peak pressure bug in effect"] = true;
    }
    
    
    int twin_progress = state.state_int["twin peak progress"];
    
    state.state_boolean["Peak Stench Completed"] = (twin_progress & 1) > 0;
    state.state_boolean["Peak Item Completed"] = (twin_progress & 2) > 0;
    state.state_boolean["Peak Jar Completed"] = (twin_progress & 4) > 0;
    state.state_boolean["Peak Init Completed"] = (twin_progress & 8) > 0;
    
    state.state_int["peak tests remaining"] = 0;
    foreach s in $strings[Peak Stench Completed,Peak Item Completed,Peak Jar Completed,Peak Init Completed]
    {
        if (!state.state_boolean[s])
            state.state_int["peak tests remaining"] += 1;
    }
    
	__quest_state["Level 9"] = state;
	__quest_state["Highland Lord"] = state;
}

void QLevel9GenerateTasksSidequests(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Level 9"];
    
	if (base_quest_state.state_int["a-boo peak hauntedness"] > 0)
	{
        boolean should_delay = false;
		string [int] details;
		string [int] modifiers;
        int clues_needed = ceil(MIN(base_quest_state.state_int["a-boo peak hauntedness"], 90).to_float() / 30.0);
        
        if (true)
        {
            int clues_remaining = MAX(0, clues_needed - $item[a-boo clue].available_amount());
            string [int] tasks;
            if (base_quest_state.state_int["a-boo peak hauntedness"] > 90)
                tasks.listAppend("get down to 90% hauntedness");
            if (clues_remaining > 0)
                tasks.listAppend("collect " + clues_remaining.int_to_wordy() + " a-boo clues");
            tasks.listAppend("use/survive each clue to finish quest.|May want to consider delaying until end of the run");
            details.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
        }
        
		modifiers.listAppend("+567% item");
		details.listAppend(base_quest_state.state_int["a-boo peak hauntedness"] + "% hauntedness.");
        
        float item_drop_multiplier = (100.0 + $location[a-boo peak].item_drop_modifier_for_location())/100.0;
        
        if (true)
        {
            string line = "Have " + pluralise($items[a-boo clue,glued a-boo clue].available_amount(), $item[a-boo clue]) + ".";
            
            float clue_drop_rate = clampf(item_drop_multiplier * 0.15, 0.0, 1.0);
            line += " " + clue_drop_rate.roundForOutput(2) + " clues/adventure at +" + ((item_drop_multiplier - 1) * 100.0).roundForOutput(1) + "% item.";
            
            details.listAppend(line);
        }
        
        
		if (base_quest_state.state_int["a-boo peak hauntedness"] <= 90 && __misc_state["can use clovers"] && $item[a-boo clue].available_amount() < clues_needed)
        {
            details.listAppend("Can clover for two A-Boo clues.");
        }
        
		
		
        
        int spooky_damage_taken_cumulative = 0;
        int cold_damage_taken_cumulative = 0;
        
        int [int] spooky_damage_levels;
        int [int] cold_damage_levels;
        
        int [int] damage_levels = listMake(13, 25, 50, 125, 250);
        
        foreach key in damage_levels
        {
            int damage = damage_levels[key];
            if ($item[glass pie plate].equipped_amount() > 0)
                damage /= 2;
            
            int spooky_damage_at_level = damageTakenByElement(damage, $element[spooky]);
            int cold_damage_at_level = damageTakenByElement(damage, $element[cold]);
            
            spooky_damage_taken_cumulative += spooky_damage_at_level;
            cold_damage_taken_cumulative += cold_damage_at_level;
            
            spooky_damage_levels.listAppend(spooky_damage_taken_cumulative);
            cold_damage_levels.listAppend(cold_damage_taken_cumulative);
        }
        
        boolean can_survive_clues_now = false;
        if (true)
        {
            string line;
        
            int hp_damage_taken = spooky_damage_levels[4] + cold_damage_levels[4] + 2;
            string hp_string = hp_damage_taken + " HP";
            if (hp_damage_taken >= my_hp())
                hp_string = HTMLGenerateSpanFont(hp_string, "red");
            
            if (hp_damage_taken <= my_maxhp())
                can_survive_clues_now = true;
            line = "Need " + hp_string + " (" + HTMLGenerateSpanOfClass(spooky_damage_levels[4] + " spooky", "r_element_spooky") + ", " + HTMLGenerateSpanOfClass(cold_damage_levels[4] + " cold", "r_element_cold") + ") to survive 30% effective A-Boo clues.";
            if (hp_damage_taken >= my_hp())
            {
                hp_damage_taken = spooky_damage_levels[3] + cold_damage_levels[3] + 2;
                string hp_string = hp_damage_taken + " HP";
                if (hp_damage_taken >= my_hp())
                    hp_string = HTMLGenerateSpanFont(hp_string, "red");
                
                line += "|Or ";
                line += hp_string;
                line += " to survive 22% effectiveness clues.";
            }
            if ($item[glass pie plate].available_amount() > 0 && $item[glass pie plate].can_equip() && $item[glass pie plate].equipped_amount() == 0)
                line += "|Equip the glass pie plate for half damage.";
            
            details.listAppend(line);
        }
        
        if (!black_market_available() && my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST && my_path_id() != PATH_NUCLEAR_AUTUMN)
        {
            details.listAppend("Possibly unlock the black market first, for cans of black paint. (+2 " + HTMLGenerateSpanOfClass("spooky", "r_element_spooky") + "/" + HTMLGenerateSpanOfClass("cold", "r_element_cold") + " res buff, 1k meat)");
        }
        if ($item[a-boo clue].available_amount() * 30 >= base_quest_state.state_int["a-boo peak hauntedness"] && my_level() < 13) //wait for later
            should_delay = true;
        if (can_survive_clues_now)
            should_delay = false;
        
        ChecklistEntry checklist_entry = ChecklistEntryMake(65, "a-boo peak", "place.php?whichplace=highlands", ChecklistSubentryMake("A-Boo Peak", modifiers, details), $locations[a-boo peak]);
		if (should_delay)
        {
            checklist_entry.importance_level = 11;
            future_task_entries.listAppend(checklist_entry);
        }
        else
            task_entries.listAppend(checklist_entry);
	}
    else if (!$location[a-boo peak].noncombat_queue.contains_text("Come On Ghosty, Light My Pyre"))
    {
		string [int] details;
		string [int] modifiers;
        
        details.listAppend("Light the fire!");
        
        ChecklistEntry checklist_entry = ChecklistEntryMake(66, "a-boo peak", "place.php?whichplace=highlands", ChecklistSubentryMake("A-Boo Peak", modifiers, details), $locations[a-boo peak]);
        task_entries.listAppend(checklist_entry);
    }
	if (base_quest_state.state_int["twin peak progress"] < 15)
	{
		string [int] details;
		string [int] modifiers;
        string url = "place.php?whichplace=highlands";
		
		if (base_quest_state.state_boolean["can complete twin peaks quest quickly"])
		{
            int progress = base_quest_state.state_int["twin peak progress"];
            
            boolean stench_completed = base_quest_state.state_boolean["Peak Stench Completed"];
            boolean item_completed = base_quest_state.state_boolean["Peak Item Completed"];
            boolean jar_completed = base_quest_state.state_boolean["Peak Jar Completed"];
            boolean init_completed = base_quest_state.state_boolean["Peak Init Completed"];
            
            boolean can_complete_stench = false;
            boolean can_complete_item = false;
            boolean can_complete_jar = false;
            boolean can_complete_init = false;
            
            boolean have_at_least_one_usable_option = false;
            
            
            if (!stench_completed && numeric_modifier("stench resistance") >= 4.0)
                can_complete_stench = true;
            if (!item_completed)
            {
                int effective_familiar_weight = my_familiar().familiar_weight() + numeric_modifier("familiar weight");
                
                int familiar_weight_from_familiar_equipment = $slot[familiar].equipped_item().numeric_modifier("familiar weight"); //need to cancel it out
                
                float familiar_item_drop = my_familiar().numeric_modifier("item drop", effective_familiar_weight - familiar_weight_from_familiar_equipment, $slot[familiar].equipped_item());
                //FIXME implement item_drop_modifier_for_location (friars does not count for this test, so maybe item_drop_modifier_ignoring_plants())
                float effective_non_familiar_item = $location[twin peak].item_drop_modifier_for_location() - familiar_item_drop + numeric_modifier("food drop");
                if (effective_non_familiar_item >= 50.0)
                    can_complete_item = true;
            }
            if (!jar_completed && $item[jar of oil].available_amount() > 0)
                can_complete_jar = true;
            if (!init_completed && (stench_completed && item_completed && jar_completed) && initiative_modifier() >= 40)
                can_complete_init = true;
            
            if (can_complete_stench || can_complete_item || can_complete_jar || can_complete_init)
                have_at_least_one_usable_option = true;
            
            if (!have_at_least_one_usable_option)
                details.listAppend(HTMLGenerateSpanFont("Avoid adventuring in area until requirements met.", "red"));
            
            string [int] options_left;
            
            if (!stench_completed)
            {
                string line = "investigate room 37";
                if (options_left.count() == 0)
                    line = line.capitaliseFirstLetter(); //have to pre-capitalise because of possible HTML later
                if (!can_complete_stench)
                    line = HTMLGenerateSpanFont(line, "gray");
                options_left.listAppend(line);
            }
            if (!item_completed)
            {
                string line = "search the pantry";
                if (options_left.count() == 0)
                    line = line.capitaliseFirstLetter();
                if (!can_complete_item)
                    line = HTMLGenerateSpanFont(line, "gray");
                options_left.listAppend(line);
            }
            if (!jar_completed)
            {
                string line = "follow the faint sound of music";
                if (options_left.count() == 0)
                    line = line.capitaliseFirstLetter();
                if (!can_complete_jar)
                    line = HTMLGenerateSpanFont(line, "gray");
                options_left.listAppend(line);
            }
            if (!init_completed)
            {
                string line = "you";
                if (options_left.count() == 0)
                    line = line.capitaliseFirstLetter();
                if (!can_complete_init)
                    line = HTMLGenerateSpanFont(line, "gray");
                options_left.listAppend(line);
            }
            
            details.listAppend(options_left.listJoinComponents(", ", "and") + ".");
            
            boolean can_complete_using_trimmers = false;
            if ($item[rusty hedge trimmers].available_amount() >= options_left.count()) //purely trimmers, now
            {
                can_complete_using_trimmers = true;
                if (have_at_least_one_usable_option)
                    url = "inventory.php?which=3";
            }
			if (numeric_modifier("stench resistance") < 4.0 && !stench_completed)
            {
				details.listAppend("+" + (4.0 - numeric_modifier("stench resistance")).floor() + " more " + HTMLGenerateSpanOfClass("stench", "r_element_stench") + " resist required.");
            }
            if (!can_complete_using_trimmers)
            {
                modifiers.listAppend("-combat");
                modifiers.listAppend("+item");
                modifiers.listAppend("olfact a topiary animal");
            }
				
            if (!item_completed && !can_complete_item)
            {
                details.listAppend("+50% non-familiar item required. (+food works)");
            }
			
			if ($item[jar of oil].available_amount() == 0 && !jar_completed)
            {
                string line = HTMLGenerateSpanFont("Jar of oil required", "red") + ".";
                if ($item[bubblin' crude].available_amount() >= 12)
                    line += " Can make by multi-using 12 bubblin' crude.";
                else
                    line += " Visit oil peak for bubblin' crude.";
				details.listAppend(line);
            }
			if (initiative_modifier() < 40.0 && !init_completed)
            {
                string line = "+40% init required.";
                if (options_left.count() > 1)
                    line = "+40% init will be required later.";
                if ($familiar[oily woim].familiar_is_usable() && !($familiars[oily woim,happy medium] contains my_familiar()))
                {
                    if (!(my_familiar() == $familiar[Xiblaxian Holo-Companion] && my_familiar() != $familiar[none]))
                        line += "|Run " + $familiar[oily woim] + " for +init.";
                }
				details.listAppend(line);
            }
            
			if ($item[rusty hedge trimmers].available_amount() > 0)
            {
                if (!have_at_least_one_usable_option)
                    details.listAppend("Have " + pluraliseWordy(MIN(options_left.count(), $item[rusty hedge trimmers].available_amount()), $item[rusty hedge trimmers]) + ".");
                else if ($item[rusty hedge trimmers].available_amount() > 1)
                    details.listAppend("Use " + pluraliseWordy(MIN(options_left.count(), $item[rusty hedge trimmers].available_amount()), $item[rusty hedge trimmers]) + ".");
                else
                    details.listAppend("Use rusty hedge trimmers.");
            }
            
            int ncs_need_to_visit_by_hand = MAX(0, options_left.count() - $item[rusty hedge trimmers].available_amount());
            int ncs_need_to_visit_with_hedge = options_left.count() - ncs_need_to_visit_by_hand;
            if (have_at_least_one_usable_option && !can_complete_using_trimmers)
                details.listAppend(generateTurnsToSeeNoncombat(80, ncs_need_to_visit_by_hand, "", 0, ncs_need_to_visit_with_hedge));
            
            
		}
		else
		{
			details.listAppend("Spend 50 total turns in the twin peak.");
		}
		task_entries.listAppend(ChecklistEntryMake(67, "twin peak", url, ChecklistSubentryMake("Twin Peak", modifiers, details), $locations[twin peak]));
	}
    boolean need_jar_of_oil = false;
    if ($item[jar of oil].available_amount() == 0 && $item[bubblin' crude].available_amount() < 12 && !base_quest_state.state_boolean["Peak Jar Completed"] && base_quest_state.state_boolean["can complete twin peaks quest quickly"])
        need_jar_of_oil = true;
        
	if (base_quest_state.state_float["oil peak pressure"] > 0.0 || need_jar_of_oil)
	{
		string [int] details;
		string [int] modifiers;
        
        int oil_ml = monster_level_adjustment_for_location($location[oil peak]);
        
        if (my_path_id() == PATH_HEAVY_RAINS)
        {
            //heavy rains ML doesn't affect which oil monster you get; cancel out the rain effect:
            //int inherent_ml_reduction = monster_level_adjustment() - numeric_modifier("Monster Level");
            //oil_ml -= inherent_ml_reduction;
            //FIXME this is complicated
        }
        
        int turns_remaining_at_current_ml = 0;
        if (base_quest_state.state_float["oil peak pressure"] > 0.0)
        {
            modifiers.listAppend("+100 ML");
            
            
            string line = "Run +" + HTMLGenerateSpanFont("20/50", "", "0.8em") + "/100 ML (at ";
            string adjustment = (oil_ml > 0 ? "+" : "") + oil_ml + " ML";
            if (oil_ml < 100)
                adjustment = HTMLGenerateSpanFont(adjustment, "red");
            adjustment += ")";
            details.listAppend(line + adjustment);
            
            
            float pressure_reduced_per_turn = 0.0;
            if ($item[dress pants].available_amount() > 0)
            {
                if ($item[dress pants].equipped_amount() > 0)
                {
                    pressure_reduced_per_turn += 6.34;
                }
                else
                {
                    if (oil_ml < 100) //only worth it <100 usually
                        details.listAppend("Wear dress pants.");
                }
            }
            if (oil_ml >= 100)
                pressure_reduced_per_turn += 63.4;
            else if (oil_ml >= 50)
                pressure_reduced_per_turn += 31.7;
            else if (oil_ml >= 20)
                pressure_reduced_per_turn += 19.02;
            else
                pressure_reduced_per_turn += 6.34;
                
            if (fabs(pressure_reduced_per_turn) > 0.01)
                turns_remaining_at_current_ml = ceil(base_quest_state.state_float["oil peak pressure"] / pressure_reduced_per_turn);
            
            string line2 = pluralise(turns_remaining_at_current_ml, "turn", "turns") + " remaining at " + oil_ml + " ML.";
            if (base_quest_state.state_boolean["oil peak pressure bug in effect"])
                line2 = "At most " + line2 + " (unable to track, sorry)";
            details.listAppend(line2);
            
            if (oil_ml < 50 && $item[dress pants].available_amount() == 0 && !in_hardcore())
                details.listAppend("If you can't reach +50 ML or more, possibly consider pulling and wearing dress pants. (lazy pull, doesn't add ML but saves 4 or 24 turns)");
        }
		if (need_jar_of_oil)
		{
			modifiers.listAppend("+item");
            string item_drop_string = "";
            int [int] drop_rates;
            if (oil_ml >= 100)
            {
                //last is possibly 10%, needs more spading
                item_drop_string = "100%/30%/10% drops";
                drop_rates = listMake(100, 30, 10);
            }
            else if (oil_ml >= 50)
            {
                item_drop_string = "100%/30% drops";
                drop_rates = listMake(100, 30);
            }
            else if (oil_ml >= 20)
            {
                item_drop_string = "100%/10% drops";
                drop_rates = listMake(100, 10);
            }
            else
            {
                item_drop_string = "100% drop";
                drop_rates = listMake(100);
            }
            
            float crudes_per_adventure = 0.0;
            float item_drop_rate_multiplier = (100.0 + $location[oil peak].item_drop_modifier_for_location()) / 100.0;
            foreach key in drop_rates
            {
                int rate = drop_rates[key];
                float effective_rate = MIN(1.0, rate.to_float() / 100.0 * item_drop_rate_multiplier);
                crudes_per_adventure += effective_rate;
            }
            string crude_string = "~" + crudes_per_adventure.roundForOutput(1) + " crude/adventure.";
            if (turns_remaining_at_current_ml > 0)
                crude_string += " ~" + (crudes_per_adventure * turns_remaining_at_current_ml.to_float()).roundForOutput(1) + " crudes before fire lit.";
            
            
            if ($item[bubblin' crude].available_amount() < 12)
            {
                details.listAppend("Run +item to acquire " + pluralise(MAX(0, 12 - $item[bubblin' crude].available_amount()), "more bubblin' crude", "more bubblin' crudes") + ". (" + item_drop_string + ")|" + crude_string);
                if ($item[duskwalker syringe].available_amount() > 0)
                    details.listAppend("Use " + $item[duskwalker syringe].pluralise() + " in-combat for more crude.");
            }
		}
		
		task_entries.listAppend(ChecklistEntryMake(68, "oil peak", "place.php?whichplace=highlands", ChecklistSubentryMake("Oil Peak", modifiers, details), $locations[oil peak]));
	}
    else if (!$location[oil peak].noncombat_queue.contains_text("Unimpressed with Pressure"))
    {
        string [int] details;
        string [int] modifiers;
        
        details.listAppend("Light the fire!");
        
		task_entries.listAppend(ChecklistEntryMake(69, "oil peak", "place.php?whichplace=highlands", ChecklistSubentryMake("Oil Peak", modifiers, details), $locations[oil peak]));
    }
}

void QLevel9GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 9"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 9"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	
    string url = "place.php?whichplace=highlands";
	int tasks_before = task_entries.count() + optional_task_entries.count() + future_task_entries.count();
	
	if (base_quest_state.mafia_internal_step == 1)
    {
        url = "place.php?whichplace=orc_chasm";
		//build bridge:
  
        //if (__misc_state["have olfaction equivalent"]) //don't remember what you'd olfact here
            //subentry.modifiers.listAppend("olfaction");
		subentry.entries.listAppend("Build a bridge.");
  
        string smut_orc_noncombat_progress_string = get_property("smutOrcNoncombatProgress");
        boolean orc_tracking_supported = false;
        if (smut_orc_noncombat_progress_string != "")
        {
            orc_tracking_supported = true;
        }
        float weapon_damage_actual = numeric_modifier("Weapon Damage");
        //correct numeric_modifier's response to actual:
        foreach s in $slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3,familiar]
        {
        	item it = s.equipped_item();
            if (it == $item[none]) continue;
            if (it.to_slot() != $slot[weapon]) continue;
            weapon_damage_actual -= it.get_power().to_float() * 0.15;
        }
        
        int choice_1_pieces_gained = MAX(3, MIN(14, sqrt((my_buffedstat($stat[muscle]) + weapon_damage_actual) / 15.0 * (numeric_modifier("Weapon Damage Percent") / 100.0 + 1.0))));
        int choice_2_pieces_gained = MAX(3, MIN(14, sqrt((my_buffedstat($stat[mysticality]) + numeric_modifier("Spell Damage")) / 15.0 * (numeric_modifier("Spell Damage Percent") / 100.0 + 1.0))));
        int choice_3_pieces_gained = MAX(3, MIN(14, sqrt((my_buffedstat($stat[moxie]) / 30.0 * (numeric_modifier("Sleaze Resistance") * 0.69 + 1.0)))));
        
        if (orc_tracking_supported)
        {
            int smut_orc_noncombat_progress = smut_orc_noncombat_progress_string.to_int_silent();
            if (smut_orc_noncombat_progress < 15)
            {
                subentry.modifiers.listAppend("+item");
            	subentry.modifiers.listAppend("-ML");
                int percent_to_nc = smut_orc_noncombat_progress.to_float() / 15.0 * 100; 
            	subentry.entries.listAppend("Run as little monster level as possible.|Overkill the orcs with as much " + HTMLGenerateSpanOfClass("cold damage", "r_element_cold") + " as you can.|" + percent_to_nc + "% to NC.");
            }
            else
            {
            	int best_choice_pieces = choice_1_pieces_gained;
            	string best_choice = "the first choice";
                if (choice_2_pieces_gained > best_choice_pieces)
                {
	                best_choice = "the second choice";
                	best_choice_pieces = choice_2_pieces_gained;
                }
                if (choice_3_pieces_gained > best_choice_pieces)
                {
                    best_choice = "the third choice";
                    best_choice_pieces = choice_3_pieces_gained;
                }
                
            	subentry.entries.listAppend("Next encounter will be the non-combat.|Choose <strong>" + best_choice + "</strong>. (<strong>" + best_choice_pieces + "</strong> pieces gained)");
                string line;
            	line += "Your buffing options are:";
                line += "|*Buff <strong>+muscle</strong>/<strong>weapon damage percent</strong>/<small>weapon damage</small> for the first NC option. (at <strong>" + choice_1_pieces_gained + "</strong> pieces)";
                line += "|*Or <strong>+myst</strong>/<strong>spell damage percent</strong>/<small>spell damage</small> for the second NC option. (at <strong>" + choice_2_pieces_gained + "</strong> pieces)";
                line += "|*Or <strong>+moxie</strong>/<strong>sleaze resistance</strong> and choose the third option at the NC. (at <strong>" + choice_3_pieces_gained + "</strong> pieces)";
                subentry.entries.listAppend(line);
            }
        }
        else
        {
            subentry.modifiers.listAppend("+item");
            subentry.modifiers.listAppend("-ML");
            subentry.modifiers.listAppend("+moxie");
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+sleaze resistance", "r_element_sleaze_desaturated"));
            //FIXME show how effective you are at the moment.
            subentry.entries.listAppend("Run as little monster level as possible.|Overkill the orcs with as much cold damage as you can.");
            subentry.entries.listAppend("Then:");
            subentry.entries.listAppend("|*Buff +muscle/weapon damage/weapon damage percent for the first NC option.");
            subentry.entries.listAppend("|*Or +myst/spell damage/spell damage percent for the second NC option.");
            subentry.entries.listAppend("|*Or +moxie/sleaze resistance and choose the third option at the NC.");
        }
        
        if (get_property("questM15Lol") != "finished" && ($item[bridge].available_amount() > 0 || $item[dictionary].available_amount() == 0) && false) //it's gone!
        {
            if ($item[bridge].available_amount() > 0)
                subentry.entries.listAppend("Place the bridge.");
            else if ($item[abridged dictionary].available_amount() > 0)
                subentry.entries.listAppend("Untinker the abridged dictionary.");
            else
                subentry.entries.listAppend("Acquire an abridged dictionary from the pirates, untinker it.");
        }
		int fasteners_needed = base_quest_state.state_int["bridge fasteners needed"];
		int lumber_needed = base_quest_state.state_int["bridge lumber needed"];
		
		if (__misc_state["can equip just about any weapon"])
		{
            if (lumber_needed > 0)
            {
                if ($item[logging hatchet].available_amount() > 0 && $item[logging hatchet].equipped_amount() == 0)
                    subentry.entries.listAppend("Possibly equip that logging hatchet.");
                else if ($item[logging hatchet].available_amount() == 0 && canadia_available())
                    subentry.entries.listAppend("Possibly acquire a logging hatchet. (first adventure in Camp Logging Camp in Little Canadia)");
            }
			
            if (fasteners_needed > 0)
            {
                if ($item[loadstone].available_amount() > 0 && $item[loadstone].equipped_amount() == 0)
                    subentry.entries.listAppend("Possibly equip that loadstone.");
                else if ($item[loadstone].available_amount() == 0 && !__quest_state["Level 8"].state_boolean["Past mine"])
                    subentry.entries.listAppend("Possibly find a loadstone in the mine.");
            }
		}
		
        if (($item[snow berries].available_amount() > 0 || $item[ice harvest].available_amount() > 0) && $item[snow boards].available_amount() < 4)
			subentry.entries.listAppend("Possibly make snow boards.");
        if (__misc_state["can use clovers"])
			subentry.entries.listAppend("Possibly clover for 3 lumber and 3 fasteners.");

		
		string [int] line;
		if (fasteners_needed > 0)
			line.listAppend(fasteners_needed + " fasteners");
		if (lumber_needed > 0)
			line.listAppend(lumber_needed + " lumber");
            
        if (lumber_needed + fasteners_needed == 0)
        {
            //finished
            subentry.modifiers.listClear();
            subentry.entries.listClear();
            subentry.entries.listAppend("Build a bridge!");
        }
		if ($item[smut orc keepsake box].available_amount() > 0)
			subentry.entries.listAppend("Open " + pluralise($item[smut orc keepsake box]) + ".");
		if (line.count() > 0)
			subentry.entries.listAppend("Need " + line.listJoinComponents(" ", "and") + ".");
	}
	/*else if (base_quest_state.mafia_internal_step == 2)
	{
		//bridge built, talk to angus:
		subentry.entries.listAppend("Talk to Angus in the Highland Lord's tower.");
	}*/
	else if (base_quest_state.mafia_internal_step == 2 || base_quest_state.mafia_internal_step == 3)
	{
		//do three peaks:
		//subentry.entries.listAppend("Light the fires!");
        if ($location[oil peak].noncombat_queue.contains_text("Unimpressed with Pressure") && $location[a-boo peak].noncombat_queue.contains_text("Come On Ghosty, Light My Pyre") && base_quest_state.state_int["twin peak progress"] == 15)
            subentry.entries.listAppend("Talk to Lord Angus to finish the quest.");
        else
            subentry.entries.listAppend("Light the fires!");
		QLevel9GenerateTasksSidequests(task_entries, optional_task_entries, future_task_entries);
	}
	else if (base_quest_state.mafia_internal_step == 4)
	{
		//fires lit, talk to angus again:
		subentry.entries.listAppend("Talk to Angus in the Highland Lord's tower.");
	}
	int tasks_after = task_entries.count() + optional_task_entries.count() + future_task_entries.count();
	if (tasks_before == tasks_after) //if our sidequests didn't add anything, show something:
		task_entries.listAppend(ChecklistEntryMake(70, base_quest_state.image_name, url, subentry, $locations[the smut orc logging camp,a-boo peak,oil peak,twin peak]));
}

void QLevel10Init()
{
	//questL10Garbage
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL10Garbage");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Castle Quest";
	state.image_name = "castle";
	state.council_quest = true;
    
    
    boolean beanstalk_grown = false;
    if ($items[Model airship,Plastic Wrap Immateria,Gauze Immateria,Tin Foil Immateria,Tissue Paper Immateria,S.O.C.K.].available_amount() > 0)
        beanstalk_grown = true;
    if (state.finished)
        beanstalk_grown = true;
    if ($location[the penultimate fantasy airship].turnsAttemptedInLocation() > 0)
        beanstalk_grown = true;
    if (state.mafia_internal_step > 1)
        beanstalk_grown = true;
    
    state.state_boolean["beanstalk grown"] = beanstalk_grown;
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        state.state_boolean["beanstalk grown"] = true;
	
	if (my_level() >= 10 || my_path_id() == PATH_EXPLOSIONS)
		state.startable = true;
    
	__quest_state["Level 10"] = state;
	__quest_state["Castle"] = state;
}


void QLevel10GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 10"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 10"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	string image_name = base_quest_state.image_name;
    string url = "place.php?whichplace=beanstalk";
	
    boolean add_as_future_task = false;
	if ($item[s.o.c.k.].available_amount() == 0 && my_path_id() != PATH_EXPLOSION)
	{
        //FIXME delay if ballroom song not set
        image_name = "penultimate fantasy airship";
        if (!base_quest_state.state_boolean["beanstalk grown"])
        {
            if ($item[enchanted bean].available_amount() == 0)
            {
                subentry.entries.listAppend("Acquire enchanted bean from a beanbat.");
                subentry.modifiers.listAppend("+100% item");
                url = $location[the beanbat chamber].getClickableURLForLocation();
            }
            else
            {
                subentry.entries.listAppend("Grow the beanstalk.");
                url = "place.php?whichplace=plains";
            }
        }
        else
        {
            int turns_spent = $location[the penultimate fantasy airship].turns_spent;
            int turns_delay = -1;
            
            boolean need_minus_combat = true;
            if (turns_spent == -1)
                need_minus_combat = true;
            else if (turns_spent < 5)
            {
                need_minus_combat = false;
                turns_delay = 5 - turns_spent;
            }
            else if (turns_spent < 10 && $item[Tissue Paper Immateria].available_amount() > 0)
            {
                need_minus_combat = false;
                turns_delay = 10 - turns_spent;
            }
            else if (turns_spent < 15 && $item[Tin Foil Immateria].available_amount() > 0)
            {
                need_minus_combat = false;
                turns_delay = 15 - turns_spent;
            }
            else if (turns_spent < 20 && $item[Gauze Immateria].available_amount() > 0)
            {
                need_minus_combat = false;
                turns_delay = 20 - turns_spent;
            }
            else if (turns_spent < 25 && $item[Plastic Wrap Immateria].available_amount() > 0)
            {
                need_minus_combat = false;
                turns_delay = 25 - turns_spent;
            }
            
            //boolean need_minus_combat_only_for_model_airship = false;
            if ($item[model airship].available_amount() == 0 && turns_spent >= 5)
            {
                //if (!need_minus_combat)
                    //need_minus_combat_only_for_model_airship = true;
                need_minus_combat = true;
            }
            
            
            if (need_minus_combat)
                subentry.modifiers.listAppend("-combat");
            else
                subentry.modifiers.listAppend("possibly +combat");
            
            if (__misc_state["free runs available"])
                subentry.modifiers.listAppend("free runs");
            if (turns_spent < 25)
            {
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
            }
            
            boolean have_more_than_enough_sgeeas = false;
            if ($item[soft green echo eyedrop antidote].available_amount() >= 30 || !in_ronin())
                have_more_than_enough_sgeeas = true;
            
            string [int] things_we_want_item_for;
            
            if ($skill[Transcendent Olfaction].skill_is_usable() && !have_more_than_enough_sgeeas)
            {
                string line = "SGEEA";
                if ($item[soft green echo eyedrop antidote].available_amount() > 0)
                    line += " (have " + $item[soft green echo eyedrop antidote].available_amount() + ")";
                things_we_want_item_for.listAppend(line);
            }
            
            
            //immateria:
            
            item [int] immaterias_missing = $items[Tissue Paper Immateria,Tin Foil Immateria,Gauze Immateria,Plastic Wrap Immateria].items_missing();
            
            if (turns_delay != -1 && !need_minus_combat)
            {
                //subentry.entries.listAppend(pluraliseWordy(turns_delay, "turn", "turns").capitaliseFirstLetter() + " delay until -combat relevant.");
                string line = "After " + pluraliseWordy(turns_delay, "turn", "turns") + " delay, ";
                if (immaterias_missing.count() == 0)
                    subentry.entries.listAppend(line + "find Cid.");
                else
                    subentry.entries.listAppend(line + "find " + immaterias_missing.count().int_to_wordy() + " more immateria.");
                    //subentry.entries.listAppend(line + "find the immateria: " + listJoinComponents(immaterias_missing, ", ", "and"));
            }
            else
            {
                if (immaterias_missing.count() == 0)
                    subentry.entries.listAppend("Find Cid. (-combat)");
                else
                {
                    subentry.entries.listAppend("Find " + immaterias_missing.count().int_to_wordy() + " more immateria. (-combat)");
                    //subentry.entries.listAppend("Find the immateria (-combat): " + listJoinComponents(immaterias_missing, ", ", "and"));
                }
            }
            
            //FIXME it would be nice to track this
            if (turns_spent == -1)
                subentry.entries.listAppend("25 total turns of delay.");
            else if (turns_spent < 25)
                subentry.entries.listAppend(pluralise(25 - turns_spent, "turn", "turns") + " total delay remaining.");
            if ($skill[Transcendent Olfaction].skill_is_usable() && !($effect[on the trail].have_effect() > 0 && get_property("olfactedMonster") == "Quiet Healer") && !have_more_than_enough_sgeeas)
                subentry.entries.listAppend("Potentially olfact quiet healer for SGEEAs");
            
            if ($items[amulet of extreme plot significance,mohawk wig].items_missing().count() > 0 && $familiar[slimeling].familiar_is_usable())
                subentry.modifiers.listAppend("slimeling?");
            
            if ($item[model airship].available_amount() == 0)
                subentry.entries.listAppend("Acquire model airship from non-combat. (speeds up quest)");
            if ($item[amulet of extreme plot significance].available_amount() == 0)
            {
                things_we_want_item_for.listAppend("amulet of extreme plot significance");
                subentry.entries.listAppend("Acquire amulet of extreme plot significance (quiet healer, 10% drop) to speed up opening ground floor.");
            }
            if ($item[mohawk wig].available_amount() == 0)
            {
                things_we_want_item_for.listAppend("Mohawk wig");
                subentry.entries.listAppend("Acquire mohawk wig (Burly Sidekick, 10% drop) to speed up top floor.");
            }
            if (things_we_want_item_for.count() > 0)
            {
                subentry.modifiers.listAppend("+item");
                subentry.entries.listAppend("Potentially run +item for " + listJoinComponents(things_we_want_item_for, ", ", "and") + ".");
            }
        }
	}
	else
	{
        url = "place.php?whichplace=giantcastle";
        if (base_quest_state.mafia_internal_step >= 11) //(get_property("lastEncounter") == "Keep On Turnin' the Wheel in the Sky")
        {
            url = "place.php?whichplace=town";
            subentry.entries.listAppend("Talk to the council to finish quest.");
        }
		else if ($location[The Castle in the Clouds in the Sky (Top floor)].locationAvailable())
		{
            float turn_estimation = -1.0;
            float non_combat_rate = 1.0 - (0.95 + combat_rate_modifier() / 100.0);
            if (non_combat_rate < 0.11111111111111) //every nine adventures, minimum
                non_combat_rate = 0.11111111111111;
            
            //FIXME turn estimation for all routes, not just mohawk wig/model airship
            
			subentry.modifiers.listAppend("-combat");
			subentry.entries.listAppend("Top floor. Run -combat.");
            if ($item[mohawk wig].equipped_amount() == 0 && $item[mohawk wig].available_amount() > 0)
            {
                string line = "Wear your mohawk wig";
                if (!$item[mohawk wig].can_equip())
                {
                    add_as_future_task = true;
                    line += ", once you can equip it";
                }
                line += ".";
                subentry.entries.listAppend(HTMLGenerateSpanFont(line, "red"));
            }
            if ($item[mohawk wig].available_amount() == 0 && !in_hardcore())
                subentry.entries.listAppend("Potentially pull and wear a mohawk wig.");
            if ($item[model airship].available_amount() == 0 && my_path_id() != PATH_EXPLOSIONS)
            {
                if ($item[mohawk wig].available_amount() == 0) //no wig, no airship
                    subentry.entries.listAppend("Backfarm for a model airship in the fantasy airship. (non-combat option, run -combat)");
                else
                    subentry.entries.listAppend("Potentially backfarm for a model airship in the fantasy airship. (non-combat option, run -combat)"); //always suggest this - backfarming for model airship is faster than spending time in top floor, I think
            }
            
            if ($item[mohawk wig].available_amount() > 0 && $item[model airship].available_amount() > 0)
            {
                if (non_combat_rate != 0.0)
                    turn_estimation = 1.0 / non_combat_rate;
            }
            
            //We don't suggest trying to complete this quest with the record, even if they lack the mohawk wig/model airship - I feel as though that would take quite a number of turns?
            //It's a 95% combat location (max nine/ten turns between non-combats), and the non-combats are split between two different sets.
            //There might be some internal mechanics to make it faster? Don't know.
			image_name = "goggles? yes!";
            
            if (turn_estimation != -1.0)
                subentry.entries.listAppend("~" + turn_estimation.roundForOutput(1) + " turns left on average.");
            
            if (CounterLookup("Semi-rare").CounterWillHitExactlyInTurnRange(1,1))
            {
                subentry.modifiers.listClear();
                subentry.entries.listClear();
                subentry.entries.listAppend(HTMLGenerateSpanFont("Avoid adventuring here; wheel will override semi-rare.", "red"));
            }
		}
		else if ($location[The Castle in the Clouds in the Sky (Ground floor)].locationAvailable())
		{
            int turns_spent = $location[The Castle in the Clouds in the Sky (Ground floor)].turns_spent;
            int turns_remaining = 11;
            if (turns_spent != -1)
            {
                turns_remaining = 11 - turns_spent;
                subentry.entries.listAppend("Ground floor. Spend " + pluraliseWordy(turns_remaining, "more turn", "more turns") + " here to unlock top floor.");
            }
            else
                subentry.entries.listAppend("Ground floor. Spend eleven turns here to unlock top floor.");
            
			image_name = "castle stairs up";
            
            if (__misc_state["need to level"])
                subentry.entries.listAppend("Possibly acquire the very overdue library book from a non-combat. (stats)");
            
            boolean request_minus_combat = false;
            if ($item[electric boning knife].available_amount() == 0 && __quest_state["Level 13"].state_boolean["wall of bones will need to be defeated"] && !$skill[garbage nova].skill_is_usable())
            {
                request_minus_combat = true;
                subentry.modifiers.listAppend("-combat");
                string line = "Try to acquire the electric boning knife if you see it. (foodie NC)";
                string [int] ncs_to_spend_turn_on;
                foreach s in $strings[There's No Ability Like Possibility,Putting Off Is Off-Putting,Huzzah!]
                {
                    if (!$location[The Castle in the Clouds in the Sky (Ground floor)].noncombat_queue.contains_text(s))
                    {
                        ncs_to_spend_turn_on.listAppend(s);
                    }
                }
                if (ncs_to_spend_turn_on.count() > 0)
                    line += "|Avoid skipping NCs " + ncs_to_spend_turn_on.listJoinComponents(", ", "and") + " exactly once each, to make the knife appear faster. (don't do this after unlocking the top floor)";
                subentry.entries.listAppend(line);
            }
            if (!request_minus_combat && CounterWanderingMonsterMayHitNextTurn() && !CounterWanderingMonsterWillHitNextTurn())
            {
                request_minus_combat = true;
                subentry.modifiers.listAppend("-combat");
                subentry.entries.listAppend("If you seek out and skip NCs here, they can tell you if your wandering monster is up next turn.|Then you can adventure somewhere else for a turn, and burn more delay here.");
            }
            
            if (true)
            {
                if (__misc_state["have hipster"])
                {
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                }
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
            }
		}
		else
		{
			subentry.modifiers.listAppend("-combat");
			subentry.entries.listAppend("Basement. Run -combat.");
            
            float turn_estimation = -1.0;
            float non_combat_rate = 1.0 - (0.95 + combat_rate_modifier() / 100.0);
            if (non_combat_rate < 0.11111111111111) //every nine adventures, minimum
                non_combat_rate = 0.11111111111111;
            if ($item[amulet of extreme plot significance].available_amount() > 0)
            {
                if ($item[amulet of extreme plot significance].equipped_amount() == 0)
                    subentry.entries.listAppend("Possibly " + HTMLGenerateSpanFont("wear the amulet of extreme plot significance.", "red") + "|Or search for the non-combat, skip it, equip the amulet, and adventure again.");
                
                if (non_combat_rate != 0.0)
                    turn_estimation = 1.0 / non_combat_rate;
                
                    
            }
            else
            {
                boolean have_usable_umbrella = (__misc_state["can equip just about any weapon"] && $item[titanium assault umbrella].available_amount() > 0);
                
                if (!in_hardcore())
                    subentry.entries.listAppend("Potentially pull and wear an amulet of extreme plot significance.");
                if (have_usable_umbrella && $item[titanium assault umbrella].equipped_amount() == 0)
                    subentry.entries.listAppend("Equip your titanium assault umbrella.");
                if ($item[massive dumbbell].available_amount() == 0)
                {
                    if (have_usable_umbrella)
                    {
                        subentry.entries.listAppend("Grab the massive dumbbell from gym if you can't reach the ground floor otherwise.");
                        
                        if (non_combat_rate != 0.0)
                            turn_estimation = (2.0 / 3.0) * (2.0 / non_combat_rate) + (1.0 / 3.0) * (1.0 / non_combat_rate); //1/3rd chance of instant completion with umbrella
                    }
                    else
                    {
                        subentry.entries.listAppend("Grab the massive dumbbell from gym.");
                        if (non_combat_rate != 0.0)
                        {
                            turn_estimation = 1.0 / non_combat_rate + (1.0 / (non_combat_rate * (2.0 / 3.0)));
                        }
                    }
                    
                }
                else
                {
                    subentry.entries.listAppend("Place the massive dumbbell in the Open Source dumbwaiter.");
                    if (non_combat_rate != 0.0)
                        turn_estimation = 1.0 / (non_combat_rate * (2.0 / 3.0));
                }
            }
            
            if (turn_estimation != -1.0)
                subentry.entries.listAppend("~" + turn_estimation.roundForOutput(1) + " turns left on average.");
			
			image_name = "lift, bro";
		}
	}
    
	ChecklistEntry entry = ChecklistEntryMake(7, image_name, url, subentry, $locations[the penultimate fantasy airship, the castle in the clouds in the sky (basement), the castle in the clouds in the sky (ground floor), the castle in the clouds in the sky (top floor)]);
    if (add_as_future_task)
        future_task_entries.listAppend(entry);
    else
        task_entries.listAppend(entry);
}
//Our strategy for the copperhead quest is probably not very good. Largely because it looks complicated and I made a few guesses.

void QLevel11CopperheadInit()
{
	if (true)
	{
		QuestState state;
		QuestStateParseMafiaQuestProperty(state, "questL11Ron");
    	if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
		state.quest_name = "Zeppelin Quest"; //"Merry-Go-Ron";
		state.image_name = "__item copperhead charm (rampant)"; //__item bitchin ford anglia
        
        state.state_int["protestors remaining"] = clampi(80 - get_property_int("zeppelinProtestors"), 0, 80);
        
        state.state_boolean["need protestor speed tricks"] = true;
        if (state.mafia_internal_step >= 3)
            state.state_int["protestors remaining"] = 0;
        if (state.state_int["protestors remaining"] <= 1)
            state.state_boolean["need protestor speed tricks"] = false;
        
		__quest_state["Level 11 Ron"] = state;
	}
	if (true)
	{
		QuestState state;
		QuestStateParseMafiaQuestProperty(state, "questL11Shen");
    	if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
		state.quest_name = "Copperhead Club Quest"; //"Of Mice and Shen";
		state.image_name = "__item copperhead charm"; //"__effect Ancient Annoying Serpent Poison";
		__quest_state["Level 11 Shen"] = state;
	}
}

boolean QLevel11ShouldOutputCopperheadRoute(string which_route)
{
    if (__quest_state["Level 11"].mafia_internal_step < 3) //need diary
        return false;
    
    int pirate_insult_count = 0;
    for i from 1 to 8
    {
        if (get_property_boolean("lastPirateInsult" + i))
            pirate_insult_count += 1;
    }
    if ($item[pirate fledges].available_amount() == 0 && pirate_insult_count == 0) //they haven't started the pirate quest... hm...
    {
        return true;
    }
    
    //want: output this in aftercore if they're adventuring there
    //want: output this in paths that do not allow the pirates (if such paths exist)
    //want: output this in-run if they're adventuring there
    //soooo...
    
    if (which_route == "ron" && $location[the red zeppelin].turns_spent > 0)
        return true;
    if (which_route == "ron" && __last_adventure_location == $location[a mob of zeppelin protesters])
        return true;
    if (which_route == "shen" && $location[the copperhead club].turns_spent > 0)
        return true;
    
    if (__misc_state["in run"] && ($location[a mob of zeppelin protesters].turns_spent + $location[the red zeppelin].turns_spent + $location[the copperhead club].turns_spent) > 0)
        return true;
    
    if (!$item[Talisman o' Namsilat].have()) return true;
    
    return false;
}

void QLevel11RonGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    /*
    questL11Ron
        Merry-Go-Ron
        started - Search for Ron Copperhead on the Red Zeppelin.
        step1 - Fight your way through the mob of zeppelin protesters.
        step2 - All aboard! All aboard the Red Zeppelin!
        step3 - Search the Red Zeppelin for Ron Copperhead.
        step4 - Barge into Ron Copperhead's cabin in the Red Zeppelin and beat him up!
        finshed - You recovered half of the Talisman o' Nam from Ron Copperhead. Brilliant!
    */
    if (!QLevel11ShouldOutputCopperheadRoute("ron"))
        return;
    
    QuestState base_quest_state = __quest_state["Level 11 Ron"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    
    string url = $location[A Mob of Zeppelin Protesters].getClickableURLForLocation();
	if (base_quest_state.finished)
		return;
    
     
    if (base_quest_state.mafia_internal_step <= 2 && base_quest_state.state_int["protestors remaining"] <= 1)
    {
        subentry.entries.listAppend("Adventure in the mob of protestors.");
    }
    else if (base_quest_state.mafia_internal_step <= 2)
    {
        //Fight your way through the mob of zeppelin protesters.
        subentry.entries.listAppend("Scare away " + pluraliseWordy(base_quest_state.state_int["protestors remaining"], "more protestor", "more protestors") + ".");
        subentry.modifiers.listAppend("-combat");
        subentry.modifiers.listAppend("+567% item");
        if (__misc_state["have olfaction equivalent"])
            subentry.modifiers.listAppend("olfact cultists");
        subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("sleaze damage", "r_element_sleaze"));
        subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("sleaze spell damage", "r_element_sleaze"));
        //Two olfaction targets here seem to be cultists or lynyrd skinner.
        //Cultists seem much better.
        //Cigarette lighter is a 15% drop. when used in combat against protestors, removes quite a few
        
        boolean [item] relevant_lynyrdskin_items;
        relevant_lynyrdskin_items[$item[lynyrdskin cap]] = true;
        relevant_lynyrdskin_items[$item[lynyrdskin breeches]] = true;
        if (__misc_state["Torso aware"])
            relevant_lynyrdskin_items[$item[lynyrdskin tunic]] = true;
        
        if ($item[lynyrd musk].available_amount() > 0 && $effect[Musky].have_effect() == 0 && my_path_id() != PATH_G_LOVER)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Use lynyrd musk.", "red"));
            url = "inventory.php?which=3";
        }
        if ($item[cigarette lighter].available_amount() > 0 && base_quest_state.state_boolean["need protestor speed tricks"] && my_path_id() != PATH_POCKET_FAMILIARS)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Use cigarette lighter in-combat.", "red"));
        }
        if ($item[lynyrd snare].available_amount() > 0 && $items[lynyrdskin cap,lynyrdskin tunic,lynyrdskin breeches].items_missing().count() > 0 && $item[lynyrd snare].item_is_usable()) //FIXME daily tracking
        {
            subentry.entries.listAppend("Possibly use the lynyrd snare. (free combat)");
        }
        string [int] what_not_not_to_wear;
        foreach it in relevant_lynyrdskin_items
        {
            if (it.available_amount() == 0)
                continue;
            if (it.equipped_amount() > 0)
                continue;
            what_not_not_to_wear.listAppend(it.to_string().replace_string("lynyrdskin ", ""));
        }
        
        if ($item[pocket wish].have() || ($item[genie bottle].have() && get_property_int("_genieWishesUsed") < 3))
        {
            int current_sleaze_damage = numeric_modifier("sleaze damage") + numeric_modifier("sleaze spell damage");
            string [int] options;
            if ($effect[Fifty Ways to Bereave Your Lover].have_effect() == 0)
            	options.listAppend("Fifty Ways to Bereave Your Lover for +100 sleaze damage");
            if ($effect[Dirty Pear].have_effect() == 0)
                options.listAppend("Dirty Pear for 2x sleaze damage; currently +" + current_sleaze_damage + " total damage");
            string line = "Could wish for sleaze damage";
            if (options.count() > 0)
            	line += ", like " + options.listJoinComponents(", ", "or");
            line += ".";
        	subentry.entries.listAppend(line);
        }
        float sleaze_protestors_cleared = MAX(3.0, sqrt(numeric_modifier("sleaze damage") + numeric_modifier("sleaze spell damage")));
        if (sleaze_protestors_cleared > 3)
            subentry.entries.listAppend(HTMLGenerateSpanOfClass("Sleaze", "r_element_sleaze") + " damage will clear " + sleaze_protestors_cleared.roundForOutput(1) + " protestors."); //FIXME do we want to list the amount they'll need to increase that?
        
        if (what_not_not_to_wear.count() > 0)
        {
            subentry.entries.listAppend("Equip your lynyrdskin " + what_not_not_to_wear.listJoinComponents(", ", "and") + "?");
            url = "inventory.php?which=2";
        }
        
        if ($skill[Transcendent Olfaction].skill_is_usable() && !($effect[on the trail].have_effect() > 0 && get_property_monster("olfactedMonster") == $monster[Blue Oyster cultist]) && base_quest_state.state_boolean["need protestor speed tricks"])
            subentry.entries.listAppend("Olfact blue oyster cultists for protestor-skipping lighters.");
        
        if ($item[lynyrd skin].available_amount() > 0 && $skill[armorcraftiness].skill_is_usable())
        {
            item [int] missing_equipment = relevant_lynyrdskin_items.items_missing();
            if (missing_equipment.count() > 0)
            {
                string [int] missing_equipment_output_string;
                foreach key, it in missing_equipment
                {
                    missing_equipment_output_string.listAppend(it.to_string().replace_string("lynyrdskin ", ""));
                }
                string joining_string = "or";
                if (missing_equipment.count() <= $item[lynyrd skin].available_amount())
                    joining_string = "and";
                string line = "Craft lynyrdskin " + missing_equipment_output_string.listJoinComponents(", ", joining_string);
                
                line += ".";
                boolean can_likely_freecraft = false;
                if ($effect[inigo's incantation of inspiration].have_effect() >= 5)
                    can_likely_freecraft = true;
                if ($item[thor's pliers].available_amount() > 0 && get_property_int("_thorsPliersCrafting") < 10) //FIXME is _thorsPliersCrafting correct? suspect mafia tracks it incorrectly, I saw it at 9 after a run. smithing, probably
                    can_likely_freecraft = true;
                
                //_legionJackhammerCrafting <3
                if ($items[Loathing Legion abacus,Loathing Legion can opener,Loathing Legion chainsaw,Loathing Legion corkscrew,Loathing Legion defibrillator,Loathing Legion double prism,Loathing Legion electric knife,Loathing Legion flamethrower,Loathing Legion hammer,Loathing Legion helicopter,Loathing Legion jackhammer,Loathing Legion kitchen sink,Loathing Legion knife,Loathing Legion many-purpose hook,Loathing Legion moondial,Loathing Legion necktie,Loathing Legion pizza stone,Loathing Legion rollerblades,Loathing Legion tape measure,Loathing Legion tattoo needle,Loathing Legion universal screwdriver,Loathing Legion Knife].available_amount() > 0 && get_property_int("_legionJackhammerCrafting") < 3)
                {
                    if ($item[Loathing Legion jackhammer].available_amount() == 0 && !can_likely_freecraft)
                    {
                        line += " (fold loathing legion knife into jackhammer first)";
                    }
                    can_likely_freecraft = true;
                }
                
                if (!can_likely_freecraft)
                    line += " (1 adventure, not worth it?)";
                
                subentry.entries.listAppend(line);
                
            }
        }
        if (!__quest_state["Level 11 Shen"].finished && $item[Flamin' Whatshisname].available_amount() == 0)
            subentry.entries.listAppend("Could adventure in the Copperhead Club first for Flamin' Whatshisnames.");
    }
    else if (base_quest_state.mafia_internal_step <= 4)
    {
        //All aboard! All aboard the Red Zeppelin!
        subentry.entries.listAppend("Search for Ron in the zeppelin.");
        //possibly 50% chance of no progress without a ticket (unconfirmed chat rumour)
        
        if (my_path_id() != PATH_POCKET_FAMILIARS)
        {
            subentry.modifiers.listAppend("+234% item");
            foreach m in $monsters[Red Herring,Red Snapper]
            {
                if (!m.is_banished())
                    subentry.modifiers.listAppend("banish " + m);
            }
            
            if (__misc_state["have olfaction equivalent"])
                subentry.modifiers.listAppend("olfact red butler");
        }
        
        if ($item[red zeppelin ticket].available_amount() == 0)
        {
            if ($item[priceless diamond].available_amount() > 0)
                subentry.entries.listAppend("Trade in your priceless diamond for a red zeppelin ticket.");
            else if (my_meat() >= $item[red zeppelin ticket].npc_price() && my_meat() >= 4000)
                subentry.entries.listAppend("Purchase a red zeppelin ticket in the black market.");
            else if (!__quest_state["Level 11 Shen"].finished)
                subentry.entries.listAppend("Could adventure in the Copperhead Club first for a ticket. (greatly speeds up area)");
            else
                subentry.entries.listAppend("No ticket.");
        }
            
        if (get_property_int("_glarkCableUses") < 5 && my_path_id() != PATH_POCKET_FAMILIARS)
        {
            if ($skill[Transcendent Olfaction].skill_is_usable() && !($effect[on the trail].have_effect() > 0 && get_property_monster("olfactedMonster") == $monster[red butler]))
                subentry.entries.listAppend("Olfact red butlers for glark cables.");
            
            if ($item[glark cable].available_amount() > 0)
            {
                subentry.entries.listAppend(HTMLGenerateSpanFont("Use glark cable in-combat.", "red"));
            }
        }
            
        if ($item[priceless diamond].available_amount() > 0 && $item[red zeppelin ticket].available_amount() == 0)
        {
            subentry.modifiers.listClear();
            subentry.entries.listClear();
            subentry.entries.listAppend("Acquire a Red Zeppelin ticket from the black market.");
            url = "shop.php?whichshop=blackmarket";
        }
    }
    else if (base_quest_state.mafia_internal_step == 5)
    {
        //Barge into Ron Copperhead's cabin in the Red Zeppelin and beat him up!
        subentry.entries.listAppend("Defeat Ron in the zeppelin.");
    }
    
    
    
    
    ChecklistEntry entry = ChecklistEntryMake(73, base_quest_state.image_name, url, subentry, $locations[A Mob of Zeppelin Protesters,The Red Zeppelin]);
    
    if (!__misc_state["in run"] || $item[talisman o' namsilat].available_amount() > 0)
        optional_task_entries.listAppend(entry);
    else
        task_entries.listAppend(entry);
}

void QLevel11ShenGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    /*
    questL11Shen
        Of Mice and Shen
        started - Go to the Copperhead Club and find Shen, the man mentioned in your father's diary.
        step1 - (no unique message)
        step2 - (no unique message)
        step3 - (no unique message)
        step4 - (no unique message)
        step5 - (no unique message)
        step6 - (no unique message)
        finished - You retrieved half of the Talisman o' Nam from Shen Copperhead. Nice!
        
    Guesses:
        1 - Need to meet shen for the first time.
        2 - shen met the first time, go do as he asks
        3 - monster done, now go find shen
        4 - shen met second time, go do as he asks
        5 - second monster done, go now find shen
        6 - shen found, go find the third monster
        7 - third monster defeated, shen find go
        finished*/
    
    if (!QLevel11ShouldOutputCopperheadRoute("shen"))
        return;
    QuestState base_quest_state = __quest_state["Level 11 Shen"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    
    item quest_item = get_property_item("shenQuestItem");
    
    location [item] quest_items_to_locations = {$item[Murphy's Rancid Black Flag]:$location[The Castle in the Clouds in the Sky (Top Floor)],
    	$item[The Stankara Stone]:$location[The Batrat and Ratbat Burrow],
        $item[The First Pizza]:$location[Lair of the Ninja Snowmen],
        $item[The Eye of the Stars]:$location[The Hole in the Sky],
        $item[The Lacrosse Stick of Lacoronado]:$location[The Smut Orc Logging Camp],
        $item[The Shield of Brook]:$location[The VERY Unquiet Garves]};
    location quest_location = quest_items_to_locations[quest_item]; 
    
	if (base_quest_state.finished)
		return;
    string url = $location[the copperhead club].getClickableURLForLocation();
    
    boolean want_club_details = false;
    boolean want_hunting_details = false;
    if (base_quest_state.mafia_internal_step <= 1)
    {
        subentry.entries.listAppend("Adventure in the Copperhead Club and meet Shen.");
        subentry.entries.listAppend("This will give you unremovable -5 stat poison.");
        if (my_daycount() == 1 && my_path_id() != PATH_EXPLOSIONS)
        	subentry.entries.listAppend("Perhaps wait until tomorrow before starting this; day 2's shen bosses are more favourable.");
    }
    else if (base_quest_state.mafia_internal_step == 2)
    {
    	want_hunting_details = true;
    }
    else if (base_quest_state.mafia_internal_step == 3)
    {
        want_club_details = true;
    }
    else if (base_quest_state.mafia_internal_step == 4)
    {
        want_hunting_details = true;
    }
    else if (base_quest_state.mafia_internal_step == 5)
    {
        want_club_details = true;
    }
    else if (base_quest_state.mafia_internal_step == 6)
    {
        want_hunting_details = true;
    }
    else if (base_quest_state.mafia_internal_step == 7)
    {
        want_club_details = true;
    }
    //step hacks:
    if (want_club_details && quest_location != $location[none] && !quest_item.have())
    {
        want_club_details = false;
    }
    if (!want_club_details && quest_item != $item[none] && quest_item.have())
    {
    	want_club_details = true;
        want_hunting_details = false;
    }
    
    if (want_hunting_details)
    {
        subentry.entries.listAppend("Adventure in " + quest_location + ".");
        url = quest_location.getClickableURLForLocation();
    }
    //FIXME is shen scheduled?
    if (want_club_details)
    {
        subentry.entries.listAppend("Find Shen in the Copperhead Club.");
        //unnamed cocktail is 15%
        //ninja dressed as a waiter has 30% disguise
        //waiter dressed as a ninja has 20% disguise
        //Behind the 'Stache can have a single state: gong, ice, or lanterns on fire
        //ice -> priceless diamond
        //fire -> setting unnamed cocktail on fire
        //gong -> prevents damage taken (not speed relevant)
        //and averages 0.64285714285714 unnamed cocktails per attempt (which takes a turn?)
        //so let's see...
        //you first want the priceless diamond for the ticket, otherwise you have the 50% chance(?) of losing progress
        //soo... run 234% item for the disguise?
        //after that, you theoretically want to upgrade cocktails, but...
        //to do that, you need a second disguise, which means possibly olfacting? then olfacting the bartender.
        
        //alternatively, olfact the ninja, then use disguises to collect cocktails
        //each one saves up to seven protestors if you see the NC (at -25% combat, the likelyhood is 11.6% per turn)
        
        boolean need_diamond = false;
        boolean need_flaming_whathisname = false;
        
        if ($items[priceless diamond,Red Zeppelin ticket].available_amount() == 0 && __quest_state["Level 11 Ron"].mafia_internal_step < 5)
            need_diamond = true;
        if (my_meat() >= 5000)
            need_diamond = false;
        if (__quest_state["Level 11 Ron"].state_boolean["need protestor speed tricks"])
            need_flaming_whathisname = true;
        
        if (need_diamond)
        {
            subentry.entries.listAppend("Try to acquire a priceless diamond. (complicated)");
        }
        else if (need_flaming_whathisname)
        {
            subentry.entries.listAppend("Could try to acquire Flamin' Whatshisname. (complicated)");
        }
    }
    
    
	ChecklistEntry entry = ChecklistEntryMake(74, base_quest_state.image_name, url, subentry, $locations[the copperhead club]);
    
    if (!__misc_state["in run"] || $item[talisman o' namsilat].available_amount() > 0)
        optional_task_entries.listAppend(entry);
    else
        task_entries.listAppend(entry);
}

void QLevel11PyramidInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questL11Pyramid");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Pyramid Quest";
    state.image_name = "Pyramid";
    __quest_state["Level 11 Pyramid"] = state;
}

void QLevel11PyramidGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 11"].in_progress)
        return;
    if (__quest_state["Level 11 Pyramid"].finished)
        return;
        
    QuestState base_quest_state = __quest_state["Level 11 Pyramid"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    string url = "";
    if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"])
        return;
    //Desert explored.
    
    boolean definitely_have_staff_of_ed = false;
    if (2286.to_item().available_amount() > 0 && 2268.to_item().available_amount() > 0 && 2180.to_item().available_amount() > 0)
        definitely_have_staff_of_ed = true;
    
    if ($item[2325].available_amount() + $item[2325].creatable_amount() + $item[7961].available_amount() + $item[7961].creatable_amount() == 0 && !definitely_have_staff_of_ed)
    {
        //Staff of ed.
        //subentry.entries.listAppend("Find the Staff of Ed.");
        return;
    }
    else if (!base_quest_state.in_progress && $location[the upper chamber].turnsAttemptedInLocation() == 0)
    {
        url = "place.php?whichplace=desertbeach";
        subentry.entries.listAppend("Visit the pyramid, click on it.");
    }
    else
    {
        /*
        How the new pyramid seemingly works:
        Adventure six times in the upper chamber with -combat. (delay, free runs relevant) This unlocks the middle chamber with the adventure "Down Dooby-Doo Down Down"
        Adventure six times in the middle chamber with +400% item and banishes. (delay, free runs relevant). This unlocks the lower chamber.
        Adventure five times in the middle chamber with +400% item and banishes. (delay, free runs relevant) This unlocks the control chamber.
        After that, you handle the control chamber and solve the puzzle. One tomb ratchet/crumbling wooden wheel advances the puzzle by one step. So, you can farm tomb ratchets (+item) or wooden wheels (-combat). There's so much delay in the middle chamber though...
        "Under Control" is the control room unlock.
        
        */
        //middleChamberUnlock, lowerChamberUnlock, controlRoomUnlock implemented
        url = "place.php?whichplace=pyramid";
        boolean done_with_wheel_turning = false; //FIXME set this
        boolean should_generate_control_room_information = false;
        boolean ed_chamber_open = get_property_boolean("pyramidBombUsed");
        if (get_property_boolean("middleChamberUnlock") || $location[the middle chamber].turnsAttemptedInLocation() > 0 || $location[the upper chamber].noncombat_queue.contains_text("Down Dooby-Doo Down Down"))
        {
            //middle chamber unlocked:
            if (get_property_boolean("controlRoomUnlock") || $location[the middle chamber].noncombat_queue.contains_text("Under Control"))
            {
                //control room unlocked:
                should_generate_control_room_information = true;
                //FIXME implement this
                //FIXME suggest the better route
                subentry.modifiers.listAppend("+400% item OR -combat");
                subentry.modifiers.listAppend("olfact tomb rats");
                subentry.entries.listAppend("Can find crumbling wooden wheels in the upper chamber (-combat), or tomb ratchets in the middle chamber (+400% item, olfact rats)");
            }
            /*else if (get_property_boolean("lowerChamberUnlock") || $location[the middle chamber].noncombat_queue.contains_text("Further Down Dooby-Doo Down Down"))
            {
                //lower chamber unlocked:
                subentry.entries.listAppend("Adventure in the middle chamber for five total turns to unlock the control room.");
                subentry.modifiers.listAppend("+400% item");
                subentry.modifiers.listAppend("olfact tomb rats");
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
            }*/
            else
            {
                //unlock lower chamber:
                int turns_spent = $location[the middle chamber].turns_spent;
                
                int turns_remaining = MAX(0, 11 - turns_spent);
                subentry.entries.listAppend("Adventure in the middle chamber for " + pluraliseWordy(turns_remaining, "more turn", "more turns") + " to unlock the control room.");
            
                subentry.modifiers.listAppend("+400% item");
                subentry.modifiers.listAppend("olfact tomb rats");
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
                
            }
            if ($item[tangle of rat tails].available_amount() > 0)
                subentry.entries.listAppend("Use tangle of rat tails against tomb rats for more tomb ratchets.");
            if (my_path_id() == PATH_HEAVY_RAINS && $item[catfish whiskers].available_amount() > 0 && $effect[Fishy Whiskers].have_effect() == 0 && $item[tangle of rat tails].available_amount() > 0)
                subentry.entries.listAppend("Possibly use catfish whiskers to find more tomb ratchets.");
        }
        else
        {
            //unlock middle chamber:
            int turns_spent = $location[the upper chamber].turns_spent;
            int turns_remaining = MAX(0, 6 - turns_spent);
            subentry.entries.listAppend("Adventure in the upper chamber for " + pluraliseWordy(turns_remaining, "more turn", "more turns") + " to unlock the middle chamber.");
            subentry.modifiers.listAppend("-combat");
            if (__misc_state["have hipster"])
                subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
            if (__misc_state["free runs available"])
                subentry.modifiers.listAppend("free runs");
        }
        
        
        //Generate spin cycle:

        //this is not very good code:
        boolean have_pyramid_position = false;
        int pyramid_position = get_property_int("pyramidPosition");
        
        //Uncertain:
        //if (get_property_ascension("lastPyramidReset"))
        if (pyramid_position > 0) //does this work?
            have_pyramid_position = true;
        
        //I think there are... five positions?
        //1=Ed, 2=bad, 3=vending machine, 4=token, 5=bad
        int next_position_needed = -1;
        int additional_turns_after_that = 0;
        string task;
        done_with_wheel_turning = false;
        if (2318.to_item().available_amount() > 0 || ed_chamber_open)
        {
            //need 1
            next_position_needed = 1;
            additional_turns_after_that = 0;
            
            boolean delay_for_semirare = CounterLookup("Semi-rare").CounterWillHitExactlyInTurnRange(0, 6);
            if (delay_for_semirare)
            {
                task = HTMLGenerateSpanFont("Avoid fighting Ed the Undying, semi-rare coming up ", "red");
            }
            else
            {
                int ed_ml = 180 + monster_level_adjustment_for_location($location[the lower chambers]);
                task = "fight Ed in the lower chambers";
                if (ed_ml > my_buffedstat($stat[moxie]))
                    task += " (" + ed_ml + " attack)";
            }
            if (ed_chamber_open)
                done_with_wheel_turning = true;
        }
        else if ($item[ancient bronze token].available_amount() > 0)
        {
            //need 3
            next_position_needed = 3;
            additional_turns_after_that = 3;
            task = "acquire " + 2318.to_item().to_string() + " in lower chamber";
        }
        else
        {
            //need 4
            next_position_needed = 4;
            additional_turns_after_that = 3 + 4;
            task = "acquire token in lower chamber";
        }
        
        int spins_needed = (next_position_needed - pyramid_position + 10) % 5;
        int total_spins_needed = spins_needed + additional_turns_after_that;
        int spins_available = $item[tomb ratchet].available_amount() + $item[crumbling wooden wheel].available_amount();
        
        int extra_spin_sources_needed = clampi(total_spins_needed - spins_available, 0, 11);
        
        //Pyramid unlocked:
        if (should_generate_control_room_information)
        {
            
            string [int] tasks;
            if (spins_needed > 0)
            {
                if (spins_needed == 1)
                    tasks.listAppend("spin the pyramid One More Time");
                else
                    tasks.listAppend("spin the pyramid " + spins_needed.int_to_wordy() + " times");
                if ($item[tomb ratchet].available_amount() + $item[crumbling wooden wheel].available_amount() > 0)
                    url = "place.php?whichplace=pyramid&action=pyramid_control";
            }
            tasks.listAppend(task);
            
            
            if (!have_pyramid_position)
            {
                tasks.listClear();
                //tasks.listAppend("look at the pyramid"); //I dunno
            }
            
            if (ed_chamber_open && done_with_wheel_turning)
            {
                subentry.modifiers.listClear();
                subentry.entries.listClear();
            }
            
            if (tasks.count() > 0)
                subentry.entries.listPrepend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
            else
                subentry.entries.listAppend("Spin the control room, search the lower chambers! Then fight Ed.");
                
            if (ed_chamber_open && my_path_id() == PATH_EXPLOSIONS && $item[low-pressure oxygen tank].equipped_amount() == 0)
            {
            	subentry.modifiers.listAppend("+hp regen");
                subentry.entries.listAppend("Keep +hp regen up, so you survive the multi-round fight without the oxygen tank?");
            }
        }
        
        if (!done_with_wheel_turning)
        {
            if (extra_spin_sources_needed > 0)
                subentry.entries.listAppend("Need " + HTMLGenerateSpanFont(int_to_wordy(extra_spin_sources_needed), "red") + " more ratchet/wheel" + ((extra_spin_sources_needed > 1) ? "s" : "") + ".");
            else
                subentry.entries.listAppend("Have enough wheels.");
            /*if (amount > 0)
                subentry.entries.listAppend(pluralise(amount, "wheel turn", "wheel turns") + " available.");*/
            if ($item[tangle of rat tails].available_amount() > 0 && extra_spin_sources_needed > 0)
                subentry.entries.listAppend(pluralise($item[tangle of rat tails]) + " available.");
        }
        
    }
    
    task_entries.listAppend(ChecklistEntryMake(91, base_quest_state.image_name, url, subentry, $locations[the upper chamber,the lower chambers, the middle chamber]));
}
void QLevel11DesertInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questL11Desert");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Desert Quest";
    state.image_name = "Pyramid"; //"__item instant karma";
    
    int gnasir_progress = get_property_int("gnasirProgress");
    
    state.state_boolean["Stone Rose Given"] = (gnasir_progress & 1) > 0;
    state.state_boolean["Black Paint Given"] = (gnasir_progress & 2) > 0;
    state.state_boolean["Killing Jar Given"] = (gnasir_progress & 4) > 0;
    state.state_boolean["Manual Pages Given"] = (gnasir_progress & 8) > 0;
    state.state_boolean["Wormridden"] = (gnasir_progress & 16) > 0;
    
    state.state_int["Desert Exploration"] = get_property_int("desertExploration");
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        state.state_int["Desert Exploration"] = 100;
    state.state_boolean["Desert Explored"] = (state.state_int["Desert Exploration"] == 100);
    if (state.finished) //in case mafia doesn't detect it properly
    {
        state.state_int["Desert Exploration"] = 100;
        state.state_boolean["Desert Explored"] = true;
    }
        
    
    
    boolean have_uv_compass_equipped = false;
    
    if (!__misc_state["can equip just about any weapon"])
        have_uv_compass_equipped = true;
    if ($item[UV-resistant compass].equipped_amount() > 0)
        have_uv_compass_equipped = true;
    if ($item[ornate dowsing rod].equipped_amount() > 0)
        have_uv_compass_equipped = true;
    
    state.state_boolean["Have UV-Compass eqipped"] = have_uv_compass_equipped;

    __quest_state["Level 11 Desert"] = state;
}

void QLevel11DesertGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 11 Desert"].in_progress && __quest_state["Level 11"].mafia_internal_step <3)
        return;
    QuestState base_quest_state = __quest_state["Level 11 Desert"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    string url = "";

    if (base_quest_state.state_boolean["Desert Explored"])
        return;
        
    url = "place.php?whichplace=desertbeach";
    int exploration = base_quest_state.state_int["Desert Exploration"];
    int exploration_remaining = 100 - exploration;
    float exploration_per_turn = 1.0;
    if ($item[ornate dowsing rod].available_amount() > 0)
        exploration_per_turn += 2.0; //FIXME make completely accurate for first turn? not enough information available
    else if ($item[uv-resistant compass].available_amount() > 0)
        exploration_per_turn += 1.0;
    //if (my_familiar() == lookupFamiliar("Melodramedary") && my_familiar() != $familiar[none])
    if (lookupFamiliar("Melodramedary").familiar_is_usable() && !__misc_state["familiars temporarily blocked"]) //fixme should this be always...?
    	exploration_per_turn += 1.0;
    if (my_path_id() == PATH_LICENSE_TO_ADVENTURE && get_property_boolean("bondDesert"))
        exploration_per_turn += 2.0;
    
    boolean have_blacklight_bulb = (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && get_property("peteMotorbikeHeadlight") == "Blacklight Bulb");
    if (have_blacklight_bulb)
        exploration_per_turn += 2.0;
    //FIXME deal with ultra-hydrated
    int combats_remaining = exploration_remaining;
    combats_remaining = ceil(to_float(exploration_remaining) / exploration_per_turn);
    subentry.entries.listAppend(exploration_remaining + "% exploration remaining. (" + pluralise(combats_remaining, "combat", "combats") + ")");
    if ($effect[ultrahydrated].have_effect() == 0 && my_path_id() != PATH_G_LOVER)
    {
        if (__last_adventure_location == $location[the arid, extra-dry desert])
        {
            string [int] description;
            description.listAppend("Adventure in the Oasis.");
            if ($items[ten-leaf clover, disassembled clover].available_amount() > 0)
                description.listAppend("Potentially clover for 20 turns, versus 5.");
            task_entries.listAppend(ChecklistEntryMake(2, "__effect ultrahydrated", "place.php?whichplace=desertbeach", ChecklistSubentryMake("Acquire ultrahydrated effect", "", description), -11));
        }
        //if (exploration > 0)
            //subentry.entries.listAppend("Need ultra-hydrated from The Oasis. (potential clover for 20 turns)");
    }
    if (exploration < 10)
    {
        int turns_until_gnasir_found = -1;
        if (exploration_per_turn != 0.0)
            turns_until_gnasir_found = ceil(to_float(10 - exploration) / exploration_per_turn);
        
        subentry.entries.listAppend("Find Gnasir after " + pluralise(turns_until_gnasir_found, "turn", "turns") + ".");
    }
    else if (get_property_int("gnasirProgress") == 0 && exploration <= 14 && !$location[the arid, extra-dry desert].noncombat_queue.contains_text("A Sietch in Time"))
    {
        subentry.entries.listAppend("Find Gnasir next turn.");
    }
    else
    {
        boolean need_pages = false;
        if (!base_quest_state.state_boolean["Black Paint Given"])
        {
            if ($item[can of black paint].available_amount() == 0)
            {
                if (black_market_available())
                    subentry.entries.listAppend("Buy can of black paint, give it to Gnasir.");
            }
            else
                subentry.entries.listAppend("Give can of black paint to Gnasir.");
                
        }
        if (!base_quest_state.state_boolean["Stone Rose Given"])
        {
            if ($item[stone rose].available_amount() > 0)
                subentry.entries.listAppend("Give stone rose to Gnasir.");
            else
            {
                string line = "Potentially adventure in Oasis for stone rose";
                line += ".";
                if (delayRemainingInLocation($location[the oasis]) > 0)
                {
                    string hipster_text = "";
                    if (__misc_state["have hipster"])
                    {
                        hipster_text = " (use " + __misc_state_string["hipster name"] + ")";
                    }
                    line += "|Delay for " + pluralise(delayRemainingInLocation($location[the oasis]), "turn", "turns") + hipster_text + ".";
                }
                subentry.entries.listAppend(line);
            }
        }
        if (my_path_id() == PATH_G_LOVER)
        {
        }
        else if (!base_quest_state.state_boolean["Manual Pages Given"])
        {
            if ($item[worm-riding manual page].available_amount() == 15)
                subentry.entries.listAppend("Give Gnasir the worm-riding manual pages.");
            else
            {
                int remaining = 15 - $item[worm-riding manual page].available_amount();
                
                subentry.entries.listAppend("Find " + pluralise(remaining, "more worm-riding manual page", "more worm-riding manual pages") + ".");
                need_pages = true;
            }
            
        }
        else if (!base_quest_state.state_boolean["Wormridden"])
        {
            subentry.modifiers.listAppend("rhythm");
            if ($item[drum machine].available_amount() > 0)
            {
                subentry.entries.listAppend("Use drum machine.");
            }
        }
        if (!base_quest_state.state_boolean["Wormridden"] && $item[drum machine].available_amount() == 0 && my_path_id() != PATH_G_LOVER)
        {
            if (base_quest_state.state_boolean["Manual Pages Given"])
                subentry.entries.listAppend("Potentially acquire drum machine from blur. (+234% item), use drum machine.");
            else
                subentry.entries.listAppend("Potentially acquire drum machine from blur. (+234% item), collect/return pages, then use drum machine.");
            subentry.modifiers.listAppend("+234% item");
        }
        if (!base_quest_state.state_boolean["Killing Jar Given"])
        {
            if ($item[killing jar].available_amount() > 0)
                subentry.entries.listAppend("Give Gnasir the killing jar.");
            else
                subentry.entries.listAppend("Potentially find killing jar. (banshee, haunted library, 10% drop, YR?)");
        }
        
        if (__misc_state["have hipster"])
        {
            subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
            
            string line = __misc_state_string["hipster name"].capitaliseFirstLetter() + " for free combats";
            if (need_pages)
                line += " and manual pages";
            line += ".";
            subentry.entries.listAppend(line);
        }
    }
    if ($effect[ultrahydrated].have_effect() == 0 && my_path_id() != PATH_G_LOVER)
    {
        if (exploration > 0)
            subentry.entries.listAppend("Acquire ultrahydrated effect from oasis. (potential clover for 20 adventures)");
    }
    if ($item[desert sightseeing pamphlet].available_amount() > 0)
    {
        if ($item[desert sightseeing pamphlet].available_amount() == 1)
            subentry.entries.listAppend("Use your desert sightseeing pamphlet. (+15% exploration)");
        else
            subentry.entries.listAppend("Use your desert sightseeing pamphlets. (+15% exploration)");
    }
    if (lookupFamiliar("Melodramedary").familiar_is_usable() && my_familiar() != lookupFamiliar("Melodramedary") && !__misc_state["familiars temporarily blocked"])
    {
    	subentry.entries.listAppend(HTMLGenerateSpanFont("Bring along your Melodramedary for extra exploration.", "red"));
    }
    if (!base_quest_state.state_boolean["Have UV-Compass eqipped"] && __quest_state["Level 11 Desert"].state_int["Desert Exploration"] < 99)
    {
        boolean should_output_compass_in_red = true;
        string line = "";
        string line_extra = "";
        if ($item[ornate dowsing rod].available_amount() > 0)
        {
            line = "Equip the ornate dowsing rod.";
            url = generateEquipmentLink($item[ornate dowsing rod]);
        }
        else
        {
            if ($item[uv-resistant compass].available_amount() == 0 && !(my_path_id() == PATH_LICENSE_TO_ADVENTURE && get_property_boolean("bondDesert")) && my_path_id() != PATH_EXPLOSIONS)
            {
                line = "Acquire";
                if (have_blacklight_bulb)
                {
                    line = "Possibly acquire";
                    should_output_compass_in_red = false;
                }
              
                line += " UV-resistant compass, equip for faster desert exploration. (shore vacation)";
                if ($item[Shore Inc. Ship Trip Scrip].available_amount() > 0)
                    url = "shop.php?whichshop=shore";
              
                if ($item[odd silver coin].available_amount() > 0 || $item[grimstone mask].available_amount() > 0 || get_property("grimstoneMaskPath") != "") //FIXME check for the correct grimstoneMaskPath
                {
                    line_extra += "|Or acquire ornate dowsing rod from Paul's Boutique? (5 odd silver coins)";
                }
              
            }
            else if ($item[uv-resistant compass].available_amount() > 0)
            {
                line = "Equip the UV-resistant compass.";
                url = generateEquipmentLink($item[uv-resistant compass]);
            }
        }
        if (line != "")
        {
            if (should_output_compass_in_red)
                line = HTMLGenerateSpanFont(line, "red");
            line += line_extra;
            subentry.entries.listAppend(line);
        }
    }
    task_entries.listAppend(ChecklistEntryMake(3, base_quest_state.image_name, url, subentry, $locations[the arid\, extra-dry desert,the oasis]));
}
void QLevel11PalindomeInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questL11Palindome");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Palindome Quest";
    state.image_name = "Palindome";
    
    state.state_boolean["Need instant camera"] = false;
    if ($item[photograph of a dog].available_amount() + $item[disposable instant camera].available_amount() == 0 && state.mafia_internal_step < 3)
        state.state_boolean["Need instant camera"] = true;
    if (7270.to_item().available_amount() > 0 || my_path_id() == PATH_POCKET_FAMILIARS || my_path_id() == PATH_G_LOVER)
        state.state_boolean["Need instant camera"] = false;
    
    state.state_boolean["dr. awkward's office unlocked"] = false;
    if (state.mafia_internal_step > 2)
        state.state_boolean["dr. awkward's office unlocked"] = true;
    if (get_property_int("palindomeDudesDefeated") >= 5 && 7262.to_item().available_amount() == 0) //inference
        state.state_boolean["dr. awkward's office unlocked"] = true;
    __quest_state["Level 11 Palindome"] = state;
}

void QLevel11PalindomeGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //FIXME add whitey's grove fallthrough

	if (!__quest_state["Level 11 Palindome"].in_progress && __quest_state["Level 11"].mafia_internal_step <3) //questL11Palindome unstarted until uncertain time
        return;
    if (__quest_state["Level 11 Palindome"].finished)
        return;
    if (__quest_state["Level 11"].finished)
        return;
    if (__quest_state["Level 11"].mafia_internal_step <3 )
        return;
    if (($item[Staff of Ed\, almost].available_amount() > 0 || $item[2325].available_amount() > 0 || $item[2268].available_amount() > 0) && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
        return;
    
    QuestState base_quest_state = __quest_state["Level 11 Palindome"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    string url;
    
    if (base_quest_state.mafia_internal_step < 2 && $item[talisman o' namsilat].available_amount() == 0 && $items[Copperhead Charm,Copperhead Charm (rampant)].items_missing().count() == 0)
    {
        url = "craft.php?mode=combine";
        subentry.entries.listAppend("Paste the two copperhead charms together to acquire the talisman o' nam.");
    }
    else if (base_quest_state.mafia_internal_step < 2 && $item[talisman o' namsilat].available_amount() == 0)
    {
        //1 -> find palindome
        url = "place.php?whichplace=cove";
        if (__quest_state["Pirate Quest"].state_boolean["valid"])
        	subentry.entries.listAppend("Find the palindome. The pirates will know the way.");
        else
        {
        	string [int] quests;
            if (!__quest_state["Level 11 Shen"].finished)
            	quests.listAppend("copperhead");
            if (!__quest_state["Level 11 Ron"].finished)
                quests.listAppend("zeppelin");
            subentry.entries.listAppend("Find the palindome by completing the " + quests.listJoinComponents("/") + " quest.");
        }
        
        if (!is_wearing_outfit("Swashbuckling Getup") && $item[pirate fledges].equipped_amount() == 0 && $item[pirate fledges].available_amount() > 0 && false)
        {
            url = "inventory.php?which=2";
            if ($item[pirate fledges].available_amount() > 0 && $item[pirate fledges].can_equip())
            {
                subentry.entries.listAppend("Equip the pirate fledges first.");
                url = generateEquipmentLink($item[pirate fledges]);
            }
            else
                subentry.entries.listAppend("Equip the Swashbuckling Getup first.");
        }
        
        if (!__quest_state["Pirate Quest"].state_boolean["valid"])
        {
        }
        else if ($location[the poop deck].noncombat_queue.contains_text("It's Always Swordfish") || $location[belowdecks].turnsAttemptedInLocation() > 0)
        {
            if ($items[gaudy key,snakehead charrrm].available_amount() < 2)
            {
                if ($items[gaudy key,snakehead charrrm].available_amount() == 0)
                {
                    subentry.modifiers.listAppend("olfact gaudy pirate");
                    string line = "Olfact/copy gaudy pirate belowdecks";
                    line += ".";
                    subentry.entries.listAppend(line);
                }
                else
                    subentry.entries.listAppend("Find a single gaudy pirate.");
            }
            else
                url = "inventory.php?which=3";
            if ($item[gaudy key].available_amount() > 0)
                subentry.entries.listAppend("Use " + $item[gaudy key].pluralise() + ".");
        }
        else if ($item[pirate fledges].available_amount() > 0)
        {
            subentry.modifiers.listAppend("-combat");
            subentry.entries.listAppend("Run -combat on the Poop Deck to unlock belowdecks.");
            subentry.entries.listAppend(generateTurnsToSeeNoncombat(80, 1, "unlock belowdecks"));
            
            if (__misc_state["need to level"])// && $location[the poop deck].noncombat_queue.contains_text("O Cap'm"))
            {
                if (my_meat() < 977)
                {
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Possibly acquire 977 meat first", "red") + ", to gain extra stats from the other NC.");
                }
                else
                {
                    string coordinates;
                    if (my_primestat() == $stat[muscle])
                        coordinates = "(56, 14)";
                    else if (my_primestat() == $stat[mysticality])
                        coordinates = "(3, 35)";
                    else if (my_primestat() == $stat[moxie])
                        coordinates = "(5, 39)";
                    if (coordinates != "")
                        subentry.entries.listAppend("If you encounter the wheel/O Cap'm adventure, take the helm, and sail to " + coordinates + ". (costs a turn for stats)");
                }
            }
        }
        else
        {
            subentry.entries.listAppend("Do pirate quest first.");
        }
            
    }
    else
    {
        url = "place.php?whichplace=palindome";
        if ($item[talisman o' namsilat].equipped_amount() == 0)
        {
            url = generateEquipmentLink($item[pirate fledges]);
        }
        
        
        /*
        Quest steps:
        Adventure in palindome, acquire:
            photograph of a dog (7263) by taking a picture of one of the racecar twins(?) with a disposable instant camera
            photograph of an ostrich egg (7265)
            photograph of a red nugget (7264)
            photograph of god
            stunt nuts for wet stunt nut stew
            "I Love Me, Vol. I" (7262) (dropped from monster, possibly drab bard?, possibly after rest are available?)
         Use I love me, volume 1. This removes it from your inventory, and unlocks the office.
         Arrange the photographs on the shelf:
            god, red nugget, dog, ostrich egg
        This gives 2 Love Me, Vol. 2 (7270)
        Read it to unlock mr. alarm in left office. It will disappear.
        He'll tell you to go acquire wet stunt nut stew. Adventure in whitey's grove as per usual.
        Cook wet stunt nut stew.
        Go talk to mr. alarm. He'll give a mega gem.
        Go fight Dr. Awkward with both equipped.
        
        */
        
        if ($item[mega gem].available_amount() > 0 || base_quest_state.mafia_internal_step == 5)
        {
            //5 -> fight dr. awkward
            string [int] tasks;
            if ($item[talisman o' namsilat].equipped_amount() == 0)
                tasks.listAppend("equip the Talisman o' Nam");
            if ($item[mega gem].equipped_amount() == 0)
                tasks.listAppend("equip the Mega Gem");
            
            tasks.listAppend("fight Dr. Awkward in his office");
            subentry.entries.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
        }
        else if (base_quest_state.mafia_internal_step == 3 && 7270.to_item().available_amount() > 0 && false)
        {
            //doesn't seem to work?
            subentry.entries.listAppend("Use 2 Love Me, Vol. 2, then talk to Mr. Alarm in his office.");
        }
        else if (base_quest_state.mafia_internal_step == 4 || base_quest_state.mafia_internal_step == 3)
        {
            //4 -> acquire wet stunt nut stew, give to mr. alarm
            //FIXME handle alternate route
            //step3 not supported yet, so we have this instead:
            if (base_quest_state.mafia_internal_step == 3)
            {
                if (!(7270.to_item().available_amount() > 0 && false))
                    subentry.entries.listAppend("Use 2 Love Me, Vol. 2, then talk to Mr. Alarm in his office. Then:");
            }
            
            if ($item[wet stunt nut stew].available_amount() == 0)
            {
                if (($item[bird rib].available_amount() > 0 && $item[lion oil].available_amount() > 0 || $item[wet stew].available_amount() > 0) && $item[stunt nuts].available_amount() > 0)
                {
                    url = "craft.php?mode=cook";
                    subentry.entries.listAppend("Cook wet stunt nut stew.");
                }
                else
                {
                    url = "place.php?whichplace=woods";
                    subentry.entries.listAppend("Acquire and make wet stunt nut stew.");
                    if ($item[wet stunt nut stew].available_amount() == 0 && $item[stunt nuts].available_amount() == 0)
                        subentry.entries.listAppend("Acquire stunt nuts from Bob Racecar or Racecar Bob in Palindome. (30% drop)");
                    if ($item[wet stew].available_amount() == 0 && ($item[bird rib].available_amount() == 0 || $item[lion oil].available_amount() == 0))
                    {
                        string [int] components;
                        monster [int] monsters_need_to_meet;
                        if ($item[bird rib].available_amount() == 0)
                        {
                            components.listAppend($item[bird rib]);
                            monsters_need_to_meet.listAppend($monster[whitesnake]);
                        }
                        if ($item[lion oil].available_amount() == 0)
                        {
                            components.listAppend($item[lion oil]);
                            monsters_need_to_meet.listAppend($monster[white lion]);
                        }
                        string line = "Adventure in Whitey's Grove to acquire " + components.listJoinComponents("", "and") + ".";
                      
                        line += "|";
                        int food_drop_have = $location[whitey's grove].item_drop_modifier_for_location() + numeric_modifier("food drop");
                        if (food_drop_have >= 300.0)
                        {
                            line += "Have +300% item";
                        }
                        else
                        {
                            line += HTMLGenerateSpanFont("Need +300% item", "red") + " (missing " + (300 - food_drop_have) + "%)";
                        }
                        line += " and +combat.";
                        if (familiar_is_usable($familiar[jumpsuited hound dog]))
                            line += " (hound dog is useful for this)";
                        subentry.entries.listAppend(line);
                      
                        if ($item[white page].available_amount() > 0)
                            subentry.entries.listAppend("Can use your white pages to dial up a " + monsters_need_to_meet.listJoinComponents(", ", "or a") + ".");
                      
                        subentry.modifiers.listAppend("+combat");
                        subentry.modifiers.listAppend("+300% item/food drop");
                        if (__quest_state["Level 6"].finished && !get_property_boolean("friarsBlessingReceived"))
                        {
                            subentry.entries.listAppend("Can use friars blessing for +30% food drop.");
                        }
                        if ($item[Gene Tonic: Goblin].available_amount() > 0 && $effect[Human-Goblin Hybrid].have_effect() == 0)
                        {
                            subentry.entries.listAppend("Use goblin gene tonic for +50% food drop.");
                        }
                        if (!in_hardcore())
                            subentry.entries.listAppend("Or pull wet stew.");
                    }
                    subentry.entries.listAppend("Or try the alternate route in the Palindome.");
                }
            }
            else
            {
                subentry.entries.listAppend("Talk to Mr. Alarm.");
                if ($item[talisman o' namsilat].equipped_amount() == 0)
                    subentry.entries.listAppend("Equip the Talisman o' Nam.");
            }
            //if (7270.to_item() != $item[none] && 7270.to_item().available_amount() > 0)
                //url = "place.php?whichplace=palindome";
        }
        else if (base_quest_state.mafia_internal_step == 3 || 7270.to_item().available_amount() > 0)
        {
            string [int] tasks;
            //talk to mr. alarm to unlock whitey's grove
            if (7270.to_item().available_amount() > 0)
            {
                //url = "inventory.php?which=3";
                tasks.listAppend("use 2 Love Me, Vol. 2");
            }
            if ($item[wet stunt nut stew].available_amount() > 0)
                tasks.listAppend("talk to Mr. Alarm");
            else
                tasks.listAppend("talk to Mr. Alarm to unlock Whitey's Grove");
                
            subentry.entries.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            if ($item[talisman o' namsilat].equipped_amount() == 0)
                subentry.entries.listAppend("Equip the Talisman o' Nam.");
        }
        else
        {
            boolean dr_awkwards_office_unlocked = base_quest_state.state_boolean["dr. awkward's office unlocked"]; //no way to track this at the moment
            string single_entry_mode = "";
            boolean need_to_adventure_in_palindome = false;
            boolean need_palindome_location = true;
            
            //Need:
            //Wet stunt nut stew / stunt nuts
            //"I Love Me, Vol. I" (7262)
            //instant camera -> 7263 photograph of a dog
            //7264 photograph of a red nugget
            //7265 photograph of an ostrich egg
            //photograph of god
            subentry.entries.listAppend("Adventure in the palindome.");
            
            if ($item[photograph of a dog].available_amount() == 0)
            {
            	if (my_path_id() == PATH_POCKET_FAMILIARS || my_path_id() == PATH_G_LOVER)
                {
                    need_to_adventure_in_palindome = true;
                    subentry.entries.listAppend("Defeat Bob Racecar or Racecar Bobs until you acquire the photograph of a dog.");
                }
                else if ($item[disposable instant camera].available_amount() == 0)
                {
                    subentry.modifiers.listClear();
                    url = $location[the haunted bedroom].getClickableURLForLocation();
                    single_entry_mode = "Adventure in the haunted bedroom for a disposable instant camera.";
                    int monsters_in_zone = 0;
                    foreach m in $monsters[animated mahogany nightstand,animated ornate nightstand,animated rustic nightstand,elegant animated nightstand,Wardr&ouml;b nightstand]
                    {
                        //monster m = s.to_monster();
                        if (!m.is_banished() || m == $monster[none])
                            monsters_in_zone += 1;
                    }
                    if (monsters_in_zone == 0)
                        monsters_in_zone = 5;
                    
                    if (!in_hardcore() && (get_property("questM21Dance") == "finished" || $location[the haunted ballroom].turnsAttemptedInLocation() > 0 || $item[Lady Spookyraven's finest gown].available_amount() > 0))
                        single_entry_mode += "|Or pull for it. (saves " + pluraliseWordy(monsters_in_zone, "turn", "turns") + ")";
                    need_palindome_location = false;
                }
                else
                {
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Photograph Bob Racecar or Racecar Bob", "red") + " with disposable instant camera.");
                    need_to_adventure_in_palindome = true;
                }
            }
            
            if ($item[stunt nuts].available_amount() + $item[wet stunt nut stew].available_amount() == 0 && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
            {
                subentry.modifiers.listAppend("+234% item");
                subentry.entries.listAppend("Possibly acquire stunt nuts from Bob Racecar or Racecar Bob. (30% drop)");
                need_to_adventure_in_palindome = true;
            }
            
            
            string [int] missing_ncs;
            if ($item[photograph of a red nugget].available_amount() == 0)
            {
                missing_ncs.listAppend("photograph of a red nugget");
            }
            if ($item[photograph of an ostrich egg].available_amount() == 0)
            {
                missing_ncs.listAppend("photograph of an ostrich egg");
            }
            if ($item[photograph of god].available_amount() == 0)
            {
                missing_ncs.listAppend("photograph of god");
            }
            if (missing_ncs.count() > 0)
            {
                subentry.modifiers.listAppend("-combat"); //initial spading suggests at least two of these are affected by -combat, need more data
                subentry.entries.listAppend("Find " + missing_ncs.listJoinComponents(", ", "and") + " from non-combats, run -combat");
                need_to_adventure_in_palindome = true;
            }
            
            
            
            
            //This must be after all other need_to_adventure_in_palindome checks:
            if (7262.to_item().available_amount() == 0 && !dr_awkwards_office_unlocked) //I love me, Vol. I
            {
                int dudes_left = clampi(5 - get_property_int("palindomeDudesDefeated"), 0, 5);
                    
                if (__misc_state["have olfaction equivalent"] && __misc_state_string["olfaction equivalent monster"] != "Racecar Bob" && __misc_state_string["olfaction equivalent monster"] != "Bob Racecar" && __misc_state_string["olfaction equivalent monster"] != "Drab Bard" && dudes_left > 1)
                {
                    subentry.modifiers.listAppend("olfact racecar");
                    subentry.entries.listAppend("Olfact Bob Racecar or Racecar Bob.");
                }
                subentry.entries.listAppend("Defeat " + pluraliseWordy(dudes_left, "more dude", "more dudes") + " in the palindome.");
                need_to_adventure_in_palindome = true;
            }
            else if (7262.to_item().available_amount() > 0)
            {
                if (!need_to_adventure_in_palindome)
                {
                    url = "inventory.php?which=3";
                    subentry.entries.listAppend("Use I Love Me, Vol. I. Then place the photographs in Dr. Awkward's Office.");
                }
                else
                {
                    subentry.entries.listAppend("Have I Love Me, Vol. I. Collect photographs and such in the Palindome first.");
                }
            }
            
            if (!need_to_adventure_in_palindome)
            {
                if (subentry.entries contains 0)
                    remove subentry.entries[0]; //remove "Adventure in the palindome" by index - this is hacky
            }
            
            if (!need_to_adventure_in_palindome && dr_awkwards_office_unlocked)
            {
                subentry.modifiers.listClear();
                single_entry_mode = "Place items on shelves in Dr. Awkward's office.|Order is god, red nugget, dog, and ostrich egg.";
            }
                
            if (single_entry_mode != "")
            {
                subentry.entries.listClear();
                subentry.entries.listAppend(single_entry_mode);
            }
            if (need_palindome_location && $item[talisman o' namsilat].equipped_amount() == 0)
                subentry.entries.listAppend("Equip the Talisman o' Nam.");
        }
    }
    
    boolean [location] relevant_locations = makeConstantLocationArrayMutable($locations[the poop deck, belowdecks,cobb's knob laboratory,whitey's grove]);
    relevant_locations[$location[Inside the Palindome]] = true;

    task_entries.listAppend(ChecklistEntryMake(33, base_quest_state.image_name, url, subentry, relevant_locations));
}
void QLevel11ManorInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questL11Manor");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Lord Spookyraven Quest";
    state.image_name = "Spookyraven manor";
    
    if (($items[2286,Headpiece of the Staff of Ed].available_amount() > 0 || to_item("2325").available_amount() > 0) && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING) //eye of ed
        QuestStateParseMafiaQuestPropertyValue(state, "finished");
    
    
    boolean use_fast_route = true;
    if (!__misc_state["can equip just about any weapon"])
        use_fast_route = false;
    if (my_path_id() == PATH_NUCLEAR_AUTUMN && in_hardcore())
        use_fast_route = false;
    if (in_bad_moon()) //This is possible, but certainly not plausible.
        use_fast_route = false;
    
    state.state_boolean["Can use fast route"] = use_fast_route;

    __quest_state["Level 11 Manor"] = state;
}

void QLevel11ManorGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 11 Manor"].in_progress)
        return;
    if (__quest_state["Level 11"].mafia_internal_step <3 ) //strange bug where questL11MacGuffin = started, questL11Manor = step1
        return;
    
    QuestState base_quest_state = __quest_state["Level 11 Manor"];
    ChecklistSubentry subentry;
    string url = "";
    subentry.header = base_quest_state.quest_name;
    string image_name = base_quest_state.image_name;
    if (true)
    {
        boolean use_fast_route = base_quest_state.state_boolean["Can use fast route"];
        boolean recipe_will_be_autoread = (($item[lord spookyraven's spectacles].available_amount() > 0) && use_fast_route) && get_property_boolean("autoCraft");
        boolean recipe_was_autoread_with_glasses = (get_property("spookyravenRecipeUsed") == "with_glasses");
        boolean recipe_was_autoread = recipe_was_autoread_with_glasses || (get_property("spookyravenRecipeUsed") == "no_glasses");
        //FIXME spectacles first?
        if (!$location[the haunted ballroom].locationAvailable())
            return;
        if (!$location[the haunted ballroom].noncombat_queue.contains_text("We'll All Be Flat") && base_quest_state.mafia_internal_step < 2)
        {
            url = "place.php?whichplace=manor2";
            subentry.modifiers.listAppend("-combat");
            subentry.entries.listAppend("Run -combat in the haunted ballroom.");
            image_name = "Haunted Ballroom";
            if (delayRemainingInLocation($location[the haunted ballroom]) > 0)
            {
                string line = "Delay for " + pluralise(delayRemainingInLocation($location[the haunted ballroom]), "turn", "turns") + ".";
                if (__misc_state["have hipster"])
                {
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                }
                subentry.entries.listAppend(line);
            }
        }
        else
        {
            url = "manor3.php";
        
            if (use_fast_route && $item[lord spookyraven's spectacles].available_amount() == 0 && !recipe_was_autoread)
            {
                url = $location[the haunted bedroom].getClickableURLForLocation();
                subentry.entries.listAppend("Acquire Lord Spookyraven's spectacles from the haunted bedroom.|Unless you're using the slow route, in which case ignore this.");
                image_name = "__item Lord Spookyraven's spectacles";
            }
            else if ($item[recipe: mortar-dissolving solution].available_amount() == 0 && !__setting_debug_mode && !recipe_was_autoread)
            {
                if (recipe_will_be_autoread)
                {
                    subentry.entries.listAppend("Click on the suspicious masonry in the basement.");
                    image_name = "__item recipe: mortar-dissolving solution";
                }
                else if (use_fast_route && $item[lord spookyraven's spectacles].equipped_amount() == 0)
                {
                    url = generateEquipmentLink($item[lord spookyraven's spectacles]);
                    subentry.entries.listAppend("Equip Lord Spookyraven's Spectacles, click on the suspicious masonry in the basement, then read the recipe.");
                    image_name = "__item Lord Spookyraven's spectacles";
                }
                else
                {
                    subentry.entries.listAppend("Click on the suspicious masonry in the basement, then read the recipe.");
                    image_name = "__item recipe: mortar-dissolving solution";
                }
                
            }
            else
            {
                //FIXME also make sure that is relevant when in the haunted bedroom/missing items
                //FIXME detect the chamber being opened
                boolean output_final_fight_info = false;
                if (use_fast_route)
                {
                    if ($item[wine bomb].available_amount() > 0 || base_quest_state.mafia_internal_step >= 4)
                    {
                        output_final_fight_info = true;
                    }
                    else if ($item[unstable fulminate].available_amount() > 0)
                    {
                        string [int] tasks;
                        if ($item[unstable fulminate].equipped_amount() == 0)
                        {
                            url = generateEquipmentLink($item[unstable fulminate]);
                            tasks.listAppend(HTMLGenerateSpanFont("Equip unstable fulminate", "red"));
                        }
                        image_name = "monstrous boiler";
                        
                        int ml_needed = 82;
                        int inherent_ml_modifier = 0;
                        //if (my_path_id() == PATH_HEAVY_RAINS) //need to test this
                            //inherent_ml_modifier = 82 - 40; //maybe?
                        ml_needed -= inherent_ml_modifier;
                        tasks.listAppend("adventure in the haunted boiler room with +" + ml_needed + " ML");
                        subentry.modifiers.listAppend("+" + ml_needed + " ML");
                        
                        subentry.entries.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
                        
                        int current_ml = $location[The Haunted Boiler Room].monster_level_adjustment_for_location();
                        
                        if (current_ml < ml_needed)
                        {
                            subentry.modifiers.listAppend("olfact boiler");
                        }
                        else
                        {
                            string [int] banish_targets;
                            if (!$monster[coaltergeist].is_banished())
                                banish_targets.listAppend("coaltergeist");
                            if (!$monster[steam elemental].is_banished())
                                banish_targets.listAppend("steam elemental");
                            if (banish_targets.count() > 0)
                                subentry.modifiers.listAppend("banish " + banish_targets.listJoinComponents(", "));
                        }
                        
                        float degrees_per_fight = 10 + floor(MAX((current_ml + inherent_ml_modifier).to_float(), 0.0) / 2.0);
                        
                        int boilers_needed = clampi(ceil(50.1 / degrees_per_fight.to_float()), 1, 6);
                        
                        monster boiler_monster = $monster[monstrous boiler];
                        float [monster] appearance_rates = $location[The Haunted Boiler Room].appearance_rates_adjusted();
                        
                        
                        float boiler_per_adventure = appearance_rates[boiler_monster] / 100.0;
                        
                        if (boiler_per_adventure > 0.0)
                        {
                            float turns_needed = boilers_needed.to_float() / boiler_per_adventure;
                            subentry.entries.listAppend("~" + turns_needed.roundForOutput(1) + " total turns to charge fulminate.");
                        }
                        else if ((appearance_rates contains boiler_monster) && boiler_monster != $monster[none])
                        {
                            subentry.entries.listAppend("Seemingly unable to find boilers. They miss you. They look up to you.");
                        }
                    }
                    else if (!recipe_was_autoread_with_glasses)
                    {
                        subentry.entries.listAppend("Need to " + ($item[lord spookyraven's spectacles].available_amount() == 0 ? "acquire and " : "") + "equip Lord Spookyraven's spectacles and read the recipe before you can use the quick route.");
                    }
                    else
                    {
                        //FIXME implement this differently?
                        boolean need_item_modifier = false;
                        if ($item[bottle of Chateau de Vinegar].available_amount() == 0)
                        {
                            //+booze? +food seemingly doesn't work on this one
                            subentry.entries.listAppend("Find bottle of Chateau de Vinegar from possessed wine rack in the haunted wine cellar.");
                            subentry.modifiers.listAppend("olfact wine rack");
                            need_item_modifier = true;
                            image_name = "possessed wine rack";
                        }
                        if ($item[blasting soda].available_amount() == 0)
                        {
                            subentry.entries.listAppend("Find blasting soda from the cabinet in the haunted laundry room.");
                            subentry.modifiers.listAppend("olfact cabinet");
                            need_item_modifier = true;
                            
                            if (image_name == base_quest_state.image_name)
                                image_name = "cabinet of Dr. Limpieza";
                        }
                        if (need_item_modifier)
                        {
                            subentry.modifiers.listPrepend("+1900% item"); //+item, increasing drop
                            subentry.entries.listAppend("Base drop rate is 5%, then 10%, 15%, etc, for each wine rack/cabinet defeated, individually.");
                        }
                            
                        if ($item[bottle of Chateau de Vinegar].available_amount() > 0 && $item[blasting soda].available_amount() > 0)
                        {
                            url = "craft.php?mode=cook";
                            string line = "Cook unstable fulminate.";
                            if (!__misc_state["can cook for free"])
                                line += " (1 adventure)";
                            subentry.entries.listAppend(line);
                            image_name = "__item unstable fulminate";
                        }
                    }
                }
                if (!output_final_fight_info)
                {
                    item [location] searchables;
                    searchables[$location[the haunted kitchen]] = $item[loosening powder];
                    searchables[$location[the haunted conservatory]] = $item[powdered castoreum];
                    searchables[$location[the haunted bathroom]] = $item[drain dissolver];
                    searchables[$location[the haunted gallery]] = $item[triple-distilled turpentine];
                    searchables[$location[the haunted laboratory]] = $item[detartrated anhydrous sublicalc];
                    searchables[$location[the haunted storage room]] = $item[triatomaceous dust];
                    
                    
                    item [location] missing_searchables;
                    foreach l in searchables
                    {
                        item it = searchables[l];
                        if (it.available_amount() == 0)
                            missing_searchables[l] = it;
                    }
                    
                    if (missing_searchables.count() > 0)
                    {
                        string [int] places;
                        foreach l in missing_searchables
                        {
                            item it = searchables[l];
                            //places.listAppend(it.capitaliseFirstLetter() + " in " + l + ".");
                            places.listAppend(l.to_string().replace_string("The Haunted ", ""));
                        }
                        string line = "Scavenger hunt! ";
                        if (use_fast_route)
                            line = "Alternatively, scavenger hunt! (likely much slower)|*";
                        //line += "Go search for:|*" + places.listJoinComponents("<hr>|*");
                        line += "Go search in the Haunted " + places.listJoinComponents(", ", "and") + ".";
                        subentry.entries.listAppend(line);
                        /*if (!recipe_was_autoread)
                            subentry.entries.listAppend("Read the recipe.");*/
                        
                        //are these scheduled, or regular NCs?
                        //assuming scheduled for now
                        if (__misc_state["free runs available"])
                        {
                            subentry.modifiers.listAppend("free runs");
                        }
                        if (__misc_state["have hipster"])
                        {
                            subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                        }
                    }
                    else
                    {
                        subentry.entries.listClear();
                        subentry.modifiers.listClear();
                        output_final_fight_info = true;
                    }
                    
                }
                if (output_final_fight_info)
                {
                    image_name = "Demon Summon";
                    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
                    {
                        subentry.entries.listAppend("Talk to Lord Spookyraven.");
                    }
                    else if (my_path_id() == PATH_VAMPIRE)
                    {
                        subentry.entries.listAppend("Fight the path-specific boss.");
                    }
                    else
                    {
                        subentry.modifiers.listAppend("elemental resistance");
                        subentry.entries.listAppend("Fight Lord Spookyraven.");
                        
                        if ($effect[Red Door Syndrome].have_effect() == 0 && my_meat() > 1000 && black_market_available() && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING && my_path_id() != PATH_POCKET_FAMILIARS && $item[can of black paint].item_is_usable())
                        {
                            subentry.entries.listAppend("A can of black paint can help with fighting him." + (my_meat() < 20000 ? " Bit pricy. (1k meat)" : ""));
                        }
                    }
                }
                //This is covered elsewhere, in that mess of if statements up there.
                /*if (use_fast_route && !recipe_was_autoread_with_glasses)
                {
                    if ($item[unstable fulminate].available_amount() == 0 && !output_final_fight_info && $item[bottle of Chateau de Vinegar].available_amount() == 0 && $item[bottle of Chateau de Vinegar].available_amount() == 0 && !recipe_will_be_autoread)
                        subentry.entries.listAppend("Remember to wear Spookyraven's spectacles/read the recipe if you haven't.");
                }
                else if (!recipe_was_autoread)
                    subentry.entries.listAppend("Remember to read the recipe if you haven't.");*/
            }
        }
    }
    
    boolean [location] relevant_locations;
    relevant_locations[$location[the haunted ballroom]] = true;
    relevant_locations[$location[summoning chamber]] = true;
    relevant_locations[$location[the haunted wine cellar]] = true;
    relevant_locations[$location[The Haunted Boiler Room]] = true;
    relevant_locations[$location[The Haunted Laundry Room]] = true;
    foreach l in $locations[the haunted kitchen,the haunted conservatory,the haunted bathroom,the haunted gallery,the haunted laboratory,the haunted storage room]
        relevant_locations[l] = true;
    

    task_entries.listAppend(ChecklistEntryMake(34, image_name, url, subentry, relevant_locations));
}
boolean [item] __dense_liana_machete_items = $items[antique machete,Machetito,Muculent machete,Papier-m&acirc;ch&eacute;te];

int numberOfDenseLianaFoughtInShrine(location shrine)
{
    //need to check the combat names due to wanderers:
    int dense_liana_defeated = 0;
    string [int] area_combats_seen = shrine.locationSeenCombats();
    foreach key, s in area_combats_seen
    {
        if (s == "dense liana")
            dense_liana_defeated += 1;
    }
    return dense_liana_defeated;
}

void QLevel11HiddenCityInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questL11Worship");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Hidden City Quest";
    state.image_name = "Hidden City";
    
    state.state_boolean["Hospital finished"] = (get_property_int("hiddenHospitalProgress") >= 8);
    state.state_boolean["Bowling alley finished"] = (get_property_int("hiddenBowlingAlleyProgress") >= 8);
    state.state_boolean["Apartment finished"] = (get_property_int("hiddenApartmentProgress") >= 8);
    state.state_boolean["Office finished"] = (get_property_int("hiddenOfficeProgress") >= 8);
    
    state.state_boolean["need machete for liana"] = true;
    foreach it in __dense_liana_machete_items
    {
        if (it.available_amount() > 0)
        {
            state.state_boolean["need machete for liana"] = false;
            break;
        }
    }
    
    if (get_property_int("hiddenBowlingAlleyProgress") >= 1 && get_property_int("hiddenHospitalProgress") >= 1 && get_property_int("hiddenApartmentProgress") >= 1 && get_property_int("hiddenOfficeProgress") >= 1 && $location[a massive Ziggurat].numberOfDenseLianaFoughtInShrine() >= 3 && state.mafia_internal_step >= 4)
        state.state_boolean["need machete for liana"] = false;
    
    if (!__misc_state["can equip just about any weapon"])
        state.state_boolean["need machete for liana"] = false;
    
    
    if (state.finished) //backup
    {
        state.state_boolean["Hospital finished"] = true;
        state.state_boolean["Bowling alley finished"] = true;
        state.state_boolean["Apartment finished"] = true;
        state.state_boolean["Office finished"] = true;
        state.state_boolean["need machete for liana"] = false;
    }
    
    __quest_state["Level 11 Hidden City"] = state;
}


void generateHiddenAreaUnlockForShrine(string [int] description, location shrine)
{
    boolean have_machete_equipped = false;
    item machete_available = $item[none];
    foreach it in __dense_liana_machete_items
    {
        if (it.available_amount() > 0)
            machete_available = it;
        if (it.equipped_amount() > 0)
            have_machete_equipped = true;
    }
    //int liana_remaining = MAX(0, 3 - shrine.combatTurnsAttemptedInLocation());
    int liana_remaining = MAX(0, 3 - shrine.numberOfDenseLianaFoughtInShrine());
    
    if (shrine != $location[a massive ziggurat])
        description.listAppend("Unlock by visiting " + shrine + ".");
    if (liana_remaining > 0 && shrine.noncombatTurnsAttemptedInLocation() == 0)
    {
        string line = liana_remaining.int_to_wordy().capitaliseFirstLetter() + " dense liana remain.";
        
        if (__misc_state["can equip just about any weapon"] && my_path_id() != PATH_POCKET_FAMILIARS)
        {
            if (machete_available == $item[none])
                line += " Acquire a machete first.";
            else if (!have_machete_equipped)
            {
                line += " Equip " + machete_available + " first.";
                if (!machete_available.can_equip())
                    line += " (not yet equippable)";
            }
        }
        description.listAppend(line);
    }
}

void QLevel11HiddenCityGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 11 Hidden City"].in_progress)
        return;
    if (__quest_state["Level 11"].mafia_internal_step <3 ) //strange bug where questL11MacGuffin = started, questL11Manor = step1
        return;
        
    QuestState base_quest_state = __quest_state["Level 11 Hidden City"];
    ChecklistEntry entry = ChecklistEntryMake(36);
    entry.url = "place.php?whichplace=hiddencity";
    entry.image_lookup_name = base_quest_state.image_name;
    entry.should_indent_after_first_subentry = true;
    entry.should_highlight = $locations[the hidden temple, the hidden apartment building, the hidden hospital, the hidden office building, the hidden bowling alley, the hidden park, a massive ziggurat,an overgrown shrine (northwest),an overgrown shrine (southwest),an overgrown shrine (northeast),an overgrown shrine (southeast)] contains __last_adventure_location;
    
    if (!__quest_state["Hidden Temple Unlock"].finished)
    {
        return;
    }
    else if (!locationAvailable($location[the hidden park]))
    {
        entry.image_lookup_name = "Hidden Temple";
        entry.url = "place.php?whichplace=woods";
        ChecklistSubentry subentry;
        subentry.header = base_quest_state.quest_name;
        subentry.entries.listAppend("Unlock the hidden city via the hidden temple.");
        if ($item[the Nostril of the Serpent].available_amount() == 0)
            subentry.entries.listAppend("Need nostril of the serpent.");
        if ($item[stone wool].available_amount() > 0 && my_path_id() != PATH_G_LOVER)
        {
            if ($effect[Stone-Faced].have_effect() == 0)
                entry.url = "inventory.php?which=3";
            subentry.entries.listAppend(pluralise($item[stone wool]) + " available.");
        }
        if (my_path_id() == PATH_G_LOVER)
        {
        	subentry.modifiers.listAppend("-combat");
            if (__iotms_usable[$item[genie bottle]])
            {
            	subentry.entries.listAppend("Genie wish for the \"stone-faced\" effect, then adventure in the temple.");
            }
        }
        entry.subentries.listAppend(subentry);
    }
    else
    {		
        if (true)
        {
            ChecklistSubentry subentry;
            subentry.header = base_quest_state.quest_name;
            entry.subentries.listAppend(subentry);
        }
        //Not sure exactly how these work.
        //8 appears to be finished.
        //1 appears to be "area unlocked"
        boolean hidden_tavern_unlocked = get_property_ascension("hiddenTavernUnlock");
        boolean janitors_relocated_to_park = get_property_ascension("relocatePygmyJanitor");
        boolean have_machete = false;
    
        have_machete = __dense_liana_machete_items.available_amount() > 0;
        int bowling_progress = get_property_int("hiddenBowlingAlleyProgress");
        int hospital_progress = get_property_int("hiddenHospitalProgress");
        int apartment_progress = get_property_int("hiddenApartmentProgress");
        int office_progress = get_property_int("hiddenOfficeProgress");
        
        if (!base_quest_state.state_boolean["need machete for liana"])
            have_machete = true;
        
        boolean at_last_spirit = false;
        
        if (bowling_progress == 8 && hospital_progress == 8 && apartment_progress == 8 && office_progress == 8 || $item[stone triangle].available_amount() == 4)
        {
            at_last_spirit = true;
            ChecklistSubentry subentry;
            subentry.header = "Massive Ziggurat";
            //Instead of checking for four stone triangles, we check for the lack of all four stone spheres. That way it should detect properly after you fight the boss (presumably losing stone triangles), and lost?
        
            int spheres_available = $item[moss-covered stone sphere].available_amount() + $item[dripping stone sphere].available_amount() + $item[crackling stone sphere].available_amount() + $item[scorched stone sphere].available_amount();
        
            if (spheres_available > 0)
            {
                subentry.entries.listAppend("Acquire stone triangles");
            }
            else
            {
                if ($location[a massive ziggurat].numberOfDenseLianaFoughtInShrine() <3 && $location[a massive ziggurat].noncombatTurnsAttemptedInLocation() == 0)
                {
                    generateHiddenAreaUnlockForShrine(subentry.entries,$location[a massive ziggurat]);
                }
                else
                {
                    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
                    {
                        subentry.entries.listAppend("Talk to the protector spectre.");
                    }
                    else
                    {
                        subentry.modifiers.listAppend("elemental damage");
                        subentry.entries.listAppend("Fight the protector spectre!");
                    }
                }
            }
        
            entry.subentries.listAppend(subentry);
        }
        if (!at_last_spirit)
        {
            if ((!janitors_relocated_to_park && !$monster[pygmy janitor].is_banished()) || (!have_machete  && my_path_id() != PATH_POCKET_FAMILIARS))
            {
                ChecklistSubentry subentry;
                subentry.header = "Hidden Park";
            
                subentry.modifiers.listAppend("-combat");
                if (!have_machete && my_path_id() != PATH_POCKET_FAMILIARS)
                {
                    int turns_remaining = MAX(0, 7 - $location[the hidden park].turnsAttemptedInLocation());
                    string line;
                    line += "Adventure for ";
                    if (turns_remaining == 1)
                        line += "One More Turn";
                    else
                        line += turns_remaining.int_to_wordy() + " more turns";
                    line += " here for antique machete to clear dense lianas.";
                    if (canadia_available())
                        line += "|Or potentially use muculent machete by acquiring forest tears. (kodama, Outskirts of Camp Logging Camp, 30% drop or clover)";
                    subentry.entries.listAppend(line);
                }
                if (!janitors_relocated_to_park)
                    subentry.entries.listAppend("Potentially relocate janitors to park via non-combat.");
                else
                    subentry.entries.listAppend("Acquire useful items from dumpster with -combat.");
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
                if (my_basestat($stat[muscle]) < 62)
                {
                    string line = "Will need " + (62 - my_basestat($stat[muscle])) + " more muscle to equip machete.";
                    subentry.entries.listAppend(line);
                }
            
                entry.subentries.listAppend(subentry);
            }
        }
        
        if (apartment_progress < 8)
        {
            ChecklistSubentry subentry;
            subentry.header = "Hidden Apartment";
            if (apartment_progress == 7 || $item[moss-covered stone sphere].available_amount() > 0)
            {
                subentry.entries.listAppend("Place moss-covered stone sphere in shrine.");
            }
            else if (apartment_progress == 0)
            {
                generateHiddenAreaUnlockForShrine(subentry.entries,$location[an overgrown shrine (Northwest)]);
            }
            else
            {
                subentry.entries.listAppend("Olfact shaman.");
                //if (!$monster[pygmy witch lawyer].is_banished())
                    //subentry.entries.listAppend("Potentially banish lawyers.");
                    
                int turns_spent = $location[the hidden apartment building].turns_spent;
                if (turns_spent == -1)
                    subentry.entries.listAppend("NC appears every 9th adventure.");
                else
                {
                    int turns_until_next_nc = (9 - (turns_spent % 9)) - 1;
                    if (turns_until_next_nc == 0)
                        subentry.entries.listAppend("Non-combat appears next turn.");
                    else
                        subentry.entries.listAppend("Non-combat appears after " + pluraliseWordy(turns_until_next_nc, "turn", "turns") + ".");
                }
                
                string [int] curse_sources;
                if (__misc_state["can drink just about anything"])
                {
                    if (hidden_tavern_unlocked)
                        curse_sources.listAppend("cursed punch from the tavern");
                    else
                        curse_sources.listAppend("cursed punch from the tavern, if you unlock it");
                }
                curse_sources.listAppend("fighting a pygmy shaman");
                curse_sources.listAppend("non-combat (try to avoid)");
                string curse_details = "";
                curse_details = " Acquired from " + curse_sources.listJoinComponents(", ", "or") + ".";
                
                if (my_class() == $class[pastamancer] && my_thrall() == $thrall[Vampieroghi] && my_thrall().level >= 5)
                {
                    //FIXME should this be a reminder too, if adventuring there? hmm...
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Change your thrall - Vampieroghi will remove curses.", "red"));
                }
                if ($effect[Ancient Fortitude].have_effect() > 0 && $effect[thrice-cursed].have_effect() == 0)
                {
                	subentry.entries.listAppend(HTMLGenerateSpanFont("Remove Ancient Fortitude effect - you will not be cursed while that effect is up.", "red"));
                }
                
                if ($effect[thrice-cursed].have_effect() > 0)
                {
                    subentry.entries.listAppend("You're thrice-cursed. Fight the protector spirit!");
                }
                else if ($effect[twice-cursed].have_effect() > 0)
                {
                    subentry.entries.listAppend("Need one more curse." + curse_details);
                }
                else if ($effect[once-cursed].have_effect() > 0)
                {
                    subentry.entries.listAppend("Need two more curses." + curse_details);
                }
                else
                {
                    subentry.entries.listAppend("Need three more curses." + curse_details);
                }
                if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && $skill[Shake it off].skill_is_usable())
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Avoid using Shake It Off to heal", "red") + ", it'll remove the curse.");
        
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
            }
            entry.subentries.listAppend(subentry);
        }
        if (office_progress < 8)
        {
            ChecklistSubentry subentry;
            subentry.header = "Hidden Office";
            if (office_progress == 7 || $item[crackling stone sphere].available_amount() > 0)
            {
                subentry.entries.listAppend("Place crackling stone sphere in shrine.");
            }
            else if (office_progress == 0)
            {
                generateHiddenAreaUnlockForShrine(subentry.entries,$location[an overgrown shrine (Northeast)]);
            }
            else
            {
                int files_found = $item[McClusky file (page 1)].available_amount() + $item[McClusky file (page 2)].available_amount() + $item[McClusky file (page 3)].available_amount() + $item[McClusky file (page 4)].available_amount() + $item[McClusky file (page 5)].available_amount();
                int files_not_found = 5 - files_found;
                if ($item[McClusky file (complete)].available_amount() == 0)
                {
                    if (files_not_found > 0)
                    {
                        subentry.entries.listAppend("Olfact accountant.");
                        subentry.entries.listAppend("Need " + pluralise(files_not_found, "more McClusky file", "more McClusky files") + ". Found from pygmy witch accountants.");
                        //if (!$monster[pygmy witch lawyer].is_banished())
                            //subentry.entries.listAppend("Potentially banish lawyers.");
                    }
                    if ($item[Boring binder clip].available_amount() == 0)
                        subentry.entries.listAppend("Need boring binder clip. (raid the supply cabinet, office NC)");
                }
                else
                {
                    subentry.entries.listAppend("You have the complete McClusky files, fight boss.");
                }
                
                int turns_spent = $location[the hidden office building].turns_spent;
                
                if (turns_spent == -1)
                    subentry.entries.listAppend("Non-combat appears first on the 6th adventure, then every 5 adventures.");
                else
                {
                    int turns_until_next_nc = -1;
                    if (turns_spent < 6)
                        turns_until_next_nc = (6 - turns_spent) - 1;
                    else
                        turns_until_next_nc = (5 - ((turns_spent - 6) % 5)) - 1;
                    if (turns_until_next_nc == 0)
                        subentry.entries.listAppend("Non-combat appears next turn.");
                    else
                        subentry.entries.listAppend("Non-combat appears after " + pluraliseWordy(turns_until_next_nc, "turn", "turns") + ".");
                        
                    if (turns_until_next_nc == 0 && $item[McClusky file (complete)].available_amount() == 0 && $item[Boring binder clip].available_amount() > 0)
                    {
                        if (files_not_found > 0)
                        {
                            subentry.entries.listAppend(HTMLGenerateSpanFont("Go adventure in the apartment building for files instead.", "red"));
                        }
                    }
                }
        
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
            }
            entry.subentries.listAppend(subentry);
        }
        if (hospital_progress < 8)
        {
            boolean [item] hospital_outfit_pieces = $items[bloodied surgical dungarees,surgical mask,head mirror,half-size scalpel].makeConstantItemArrayMutable();
            boolean hospital_outfit_pieces_is_complete = true;
            if (__misc_state["Torso aware"])
                hospital_outfit_pieces[$item[surgical apron]] = true;
            
            ChecklistSubentry subentry;
            subentry.header = "Hidden Hospital";
            if (hospital_progress == 7 || $item[dripping stone sphere].available_amount() > 0)
            {
                subentry.entries.listAppend("Place dripping stone sphere in shrine.");
            }
            else if (hospital_progress == 0)
            {
                generateHiddenAreaUnlockForShrine(subentry.entries,$location[an overgrown shrine (Southwest)]);
            }
            else
            {
                if (hospital_outfit_pieces.items_missing().count() > 0)
                {
                    subentry.entries.listAppend("Olfact surgeon.");
                    if (!$monster[pygmy orderlies].is_banished())
                        subentry.entries.listAppend("Potentially banish pygmy orderlies.");
                }
                
        
                string [int] items_we_have_unequipped;
                item [int] items_we_have_equipped;
                foreach it in hospital_outfit_pieces
                {
                    boolean can_equip = true;
                    if (it.to_slot() == $slot[shirt] && !__misc_state["Torso aware"])
                        can_equip = false;
                    if (it.available_amount() > 0 && it.equipped_amount() == 0 && can_equip)
                    {
                        buffer line;
                        line.append(it);
                        line.append(" (");
                        line.append(it.to_slot().slot_to_string());
                        if (!it.can_equip())
                            line.append(", can't equip yet");
                        line.append(")");
                        items_we_have_unequipped.listAppend(line);
                    }
                    if (it.equipped_amount() > 0)
                        items_we_have_equipped.listAppend(it);
                }
                if (items_we_have_unequipped.count() > 0)
                {
                    subentry.entries.listAppend("Equipment unequipped: (+10% chance of protector spirit per piece)|*" + items_we_have_unequipped.listJoinComponents("|*"));
                }
                //the cap they implemented seems to be, if you spend thirty turns in the hospital, you always get You, M.D., and it'll come back if you skip it
                //it appeared on turn 31, with zero doctor equipment equipped
                if (items_we_have_equipped.count() > 0)
                    subentry.entries.listAppend((items_we_have_equipped.count() * 10) + "% chance of protector spirit encounter.");
                else
                    subentry.entries.listAppend("Without doctor equipment equipped, this area takes thirty-one turns.");
            }
            
            
            entry.subentries.listAppend(subentry);
        }
    
        if (bowling_progress < 8)
        {
            ChecklistSubentry subentry;
            subentry.header = "Hidden Bowling Alley";
        
            if (bowling_progress == 7 || $item[scorched stone sphere].available_amount() > 0)
            {
                subentry.entries.listAppend("Place scorched stone sphere in shrine.");
            }
            else if (bowling_progress == 0)
            {
                generateHiddenAreaUnlockForShrine(subentry.entries,$location[an overgrown shrine (southeast)]);
            }
            else
            {
                int rolls_needed = 6 - bowling_progress;
                boolean worry_about_free_runs = false;
                if (rolls_needed > $item[bowling ball].available_amount_including_closet())
                {
                    subentry.modifiers.listAppend("+150% item");
                    subentry.entries.listAppend("Olfact bowler, run +150% item.");
                    if (!$monster[pygmy orderlies].is_banished())
                        subentry.entries.listAppend("Potentially banish pygmy orderlies.");
                    worry_about_free_runs = true;
                }
                
                string line;
                line = int_to_wordy(rolls_needed).capitaliseFirstLetter();
                if (rolls_needed > 1)
                    line += " more rolls";
                else
                    line = "One More Roll";
                line += " until protector spirit fight.";
                
                if ($item[bowling ball].item_amount() > 0)
                    line += "|Have " + pluraliseWordy($item[bowling ball].item_amount(), $item[bowling ball]) + ".";
                if ($item[bowling ball].item_amount() < rolls_needed)
                {
                    if ($item[bowling ball].closet_amount() > 0 && $item[bowling ball].item_amount() > 0)
                        line += " (" + ($item[bowling ball].item_amount() + $item[bowling ball].closet_amount()).int_to_wordy() + " total with closet)";
                    else if ($item[bowling ball].closet_amount() > 0)
                    {
                        line += "|Have " + pluraliseWordy($item[bowling ball].closet_amount(), $item[bowling ball]) + " in closet.";
                        if ($item[bowling ball].closet_amount() >= rolls_needed)
                            line += " (take them out!)";
                    }
                }
                
                subentry.entries.listAppend(line);
                
                //FIXME pop up a reminder to acquire bowl of scorpions
                if (__misc_state["free runs usable"] && worry_about_free_runs)
                {
                    if (hidden_tavern_unlocked)
                    {
                        if ($item[bowl of scorpions].item_amount() == 0 && !$monster[drunk pygmy].is_banished())
                            subentry.entries.listAppend(HTMLGenerateSpanFont("Buy a bowl of scorpions", "red") + " from the Hidden Tavern to free run from drunk pygmys.");
                    }
                    else
                    {
                        subentry.entries.listAppend("Possibly unlock the hidden tavern first, for free runs from drunk pygmies.");
                    }
                }
            }
        
        
        
            entry.subentries.listAppend(subentry);
        }
        
        if (!at_last_spirit)
        {
            if ($location[a massive ziggurat].numberOfDenseLianaFoughtInShrine() <3)
            {
                ChecklistSubentry subentry;
                subentry.header = "Massive Ziggurat";
                generateHiddenAreaUnlockForShrine(subentry.entries,$location[a massive ziggurat]);
                entry.subentries.listAppend(subentry);
            }
            if (!hidden_tavern_unlocked && my_path_id() != PATH_G_LOVER && my_path_id() != PATH_BEES_HATE_YOU)
            {
                ChecklistSubentry subentry;
                subentry.header = "Hidden Tavern";
                boolean should_output = true;
            
                if ($item[book of matches].available_amount() > 0)
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Use book of matches.", "red"));
                else
                {
                    if (janitors_relocated_to_park)
                        subentry.entries.listAppend("Possibly acquire and use book of matches from janitors. (Pygmy janitors, Hidden Park, 20% drop)");
                    else
                        subentry.entries.listAppend("Possibly acquire and use book of matches from janitors. (Pygmy janitors, everywhere in the hidden city, 20% drop)");
                    
                    string [int] tavern_provides;
                    if (bowling_progress < 7 && __misc_state["free runs usable"])
                        tavern_provides.listAppend("Free runs from drunk pygmys.");
                    if (__misc_state["can drink just about anything"])
                    {
                        if (apartment_progress < 8)
                            tavern_provides.listAppend("Curses for hidden apartment.");
                        int adventures_given = 15;
                        if ($skill[the ode to booze].skill_is_usable())
                            adventures_given += 6;
                        
                        if (my_path_id() != PATH_SLOW_AND_STEADY)
                            tavern_provides.listAppend("Nightcap drink. (Fog Murderer for " + adventures_given + " adventures)");
                    }
                    if (tavern_provides.count() > 0)
                        subentry.entries.listAppend("Hidden Tavern provides:|*" + tavern_provides.listJoinComponents("|*"));
                    else
                        should_output = false; //don't bother, no reason to... I think?
                
                }
                if (should_output)
                    entry.subentries.listAppend(subentry);
            }
        }
    }
    if (entry.subentries.count() > 0)
        task_entries.listAppend(entry);
}
void QLevel11HiddenTempleInit()
{
    QuestState state;

    if (get_property_ascension("lastTempleUnlock"))
        QuestStateParseMafiaQuestPropertyValue(state, "finished");
    else if (__quest_state["Level 2"].startable)
    {
        QuestStateParseMafiaQuestPropertyValue(state, "started");
    }
    else
        QuestStateParseMafiaQuestPropertyValue(state, "unstarted");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    if (my_path_id() == PATH_EXPLOSIONS) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    state.quest_name = "Hidden Temple Unlock";
    state.image_name = "spooky forest";

    __quest_state["Hidden Temple Unlock"] = state;
}

void QLevel11HiddenTempleGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Hidden Temple Unlock"].in_progress)
        return;
    if (my_path_id() == PATH_G_LOVER) return;
        
    QuestState base_quest_state = __quest_state["Hidden Temple Unlock"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    
    if (delayRemainingInLocation($location[the spooky forest]) > 0)
    {
		string hipster_text = "";
		if (__misc_state["have hipster"])
		{
			hipster_text = " (use " + __misc_state_string["hipster name"] + ")";
			subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
		}
        string line = "Delay for " + pluralise(delayRemainingInLocation($location[the spooky forest]), "turn", "turns") + hipster_text + ".";
        subentry.entries.listAppend(line);
        subentry.entries.listAppend("Run -combat after that.");
    }
    else
    {
        subentry.modifiers.listAppend("-combat");
        subentry.entries.listAppend("Run -combat in the spooky forest.");
    }
    if (__misc_state["free runs available"])
    {
        subentry.modifiers.listAppend("free runs");
        subentry.entries.listAppend("Free run from low-stat monsters.");
    }
    
    int ncs_remaining = 0;
        
    if ($item[spooky sapling].available_amount() == 0)
    {
        if (my_meat() < 100)
            subentry.entries.listAppend("Obtain 100 meat for spooky sapling.");
        else
            subentry.entries.listAppend("Acquire spooky sapling.|*Follow the old road" + __html_right_arrow_character + "Talk to the hunter" + __html_right_arrow_character + "Buy a tree");
        ncs_remaining += 1;
    }
        
    if ($item[tree-holed coin].available_amount() == 0)
    {
        if ($item[spooky temple map].available_amount() == 0)
        {
            //no coin, no map
            subentry.entries.listAppend("Acquire tree-holed coin, then map.|*Explore the stream" + __html_right_arrow_character + "Squeeze into the cave");
            ncs_remaining += 2;
        }
        else
        {
            //no coin, have map, nothing to do here
        }
    }
    else
    {
        if ($item[spooky temple map].available_amount() == 0)
        {
            //coin, no map
            subentry.entries.listAppend("Acquire spooky temple map.|*Brave the dark thicket" + __html_right_arrow_character + "Follow the coin" + __html_right_arrow_character + "Insert coin to continue");
            
            ncs_remaining += 1;
        }
        else
        {
            //wait, what?
            subentry.entries.listAppend("how did we get here?");
        }
    }
    if ($item[spooky-gro fertilizer].item_amount() == 0)
    {
        subentry.entries.listAppend("Acquire spooky-gro fertilizer.|*Brave the dark thicket" + __html_right_arrow_character + "Investigate the dense foliage" + (in_hardcore() ? "" : "|*Or pull."));
        ncs_remaining += 1;
    }
    if ($item[spooky temple map].available_amount() > 0 && $item[spooky-gro fertilizer].item_amount() > 0 && $item[spooky sapling].available_amount() > 0)
    {
        subentry.modifiers.listClear();
        subentry.entries.listClear();
        subentry.entries.listAppend("Use the spooky temple map.");
    }
    
    if (ncs_remaining > 0)
    {
        float spooky_forest_nc_rate = clampNormalf(1.0 - (85.0 + combat_rate_modifier()) / 100.0);
        
        float turns_remaining = -1.0;
        float turns_per_nc = 7.0;
        if (spooky_forest_nc_rate > 0.0)
            turns_per_nc = MIN(7.0, 1.0 / spooky_forest_nc_rate);
            
        turns_remaining = ncs_remaining.to_float() * turns_per_nc;
        turns_remaining += delayRemainingInLocation($location[the spooky forest]);
        
        subentry.entries.listAppend("~" + turns_remaining.roundForOutput(1) + " turns remain at " + combat_rate_modifier().floor() + "% combat.");
    }
    
    if (my_level() < 6)
        subentry.entries.listAppend("There's also another unlock quest at level six, but it's slower.");
    else
        subentry.entries.listAppend("There's also another unlock quest, but it's slower.");
    
    if (!__quest_state["Manor Unlock"].state_boolean["ballroom song effectively set"])
    {
        subentry.entries.listAppend(HTMLGenerateSpanOfClass("Wait until -combat ballroom song set.", "r_bold"));
        future_task_entries.listAppend(ChecklistEntryMake(87, base_quest_state.image_name, "place.php?whichplace=woods", subentry, $locations[the spooky forest]));
    }
    else
    {
        task_entries.listAppend(ChecklistEntryMake(88, base_quest_state.image_name, "place.php?whichplace=woods", subentry, , $locations[the spooky forest]));
    }
}

void QLevel11Init()
{
	//questL11MacGuffin, questL11Manor, questL11Palindome, questL11Pyramid, questL11Worship
	//hiddenApartmentProgress, hiddenBowlingAlleyProgress, hiddenHospitalProgress, hiddenOfficeProgress, hiddenTavernUnlock
	//relocatePygmyJanitor, relocatePygmyLawyer
	
	
	/*
	gnasirProgress is a bitmap of things you've done with Gnasir to advance desert exploration:

	stone rose = 1
	black paint = 2
	killing jar = 4
	worm-riding manual pages (15) = 8
	successful wormride = 16
	*/
	if (true)
	{
		QuestState state;
		QuestStateParseMafiaQuestProperty(state, "questL11MacGuffin");
    	if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
		state.quest_name = "MacGuffin Quest";
		state.image_name = "MacGuffin";
		state.council_quest = true;
        
		if (my_level() >= 11 || my_path_id() == PATH_EXPLOSIONS)
			state.startable = true;
        
		__quest_state["Level 11"] = state;
		__quest_state["MacGuffin"] = state;
	}

    QLevel11CopperheadInit();
    QLevel11PyramidInit();
    QLevel11DesertInit();
    QLevel11PalindomeInit();
    QLevel11ManorInit();
    QLevel11HiddenCityInit();
    QLevel11HiddenTempleInit();
}

void QLevel11BaseGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 11"].in_progress)
        return;

    QuestState base_quest_state = __quest_state["Level 11"];
    ChecklistSubentry subentry;
    subentry.header = base_quest_state.quest_name;
    string url = "";
    string image_name = base_quest_state.image_name;
    boolean make_entry_future = false;
    
    if (base_quest_state.mafia_internal_step < 2)
    {
        subentry.header = "Unlock the Black Market";
        image_name = "Black Forest";
        //This needs better spading.
        //Side info: in the livestream, the flag [blackforestexplore] => 55 was visible, as well as [blackforestprogress] => 5
        
        //Unlock black market:
        url = "place.php?whichplace=woods";
        
        string combat_rate_string = "+5% combat";
        
        subentry.modifiers.listAppend(combat_rate_string);
        subentry.entries.listAppend("Adventure in the Black Forest with " + combat_rate_string + ".");
        
        if ($item[blackberry galoshes].available_amount() > 0)
        {
            if ($item[blackberry galoshes].equipped_amount() == 0)
            {
                string line = HTMLGenerateSpanFont("Equip blackberry galoshes", "red") + " to speed up exploration";
                
                if (!$item[blackberry galoshes].can_equip())
                {
                    make_entry_future = true;
                    line += ", once you can equip them";
                }
                line += ".";
                subentry.entries.listAppend(line);
            }
        }
        else
        {
            if (!in_hardcore())
                subentry.entries.listAppend("Possibly pull and wear the blackberry galoshes?");
            //it seems unlikely finding the galoshes in HC would be worth it? maaaybe in no-familiar paths, but probably not? sneaky pete, perhaps
            //subentry.entries.listAppend("Possibly make the blackberry galoshes via NC, if you get three blackberries.");
        }
        
        boolean [familiar] relevant_familiars = $familiars[reassembled blackbird,reconstituted crow];
        familiar bird_needed_familiar;
        item bird_needed;
        if (my_path_id() == PATH_BEES_HATE_YOU)
        {
            bird_needed_familiar = $familiar[reconstituted crow];
            bird_needed = $item[reconstituted crow];
        }
        else
        {
            bird_needed_familiar = $familiar[reassembled blackbird];
            bird_needed = $item[reassembled blackbird];
        }
        item [int] missing_components = missingComponentsToMakeItem(bird_needed);
        
        //FIXME clean this up:
        //FIXME test if having a reassembled blackbird in your inventory is more than enough in any path?
        //FIXME handle both reassembled blackbird and reconstituted crow as familiar
        
        if (missing_components.count() > 0 && bird_needed.available_amount() == 0)
        {
            subentry.modifiers.listAppend("+100% item"); //FIXME what is the drop rate for bees hate you items? we don't know...
        }
        
        if (bird_needed_familiar.familiar_is_usable())
        {
            if (bird_needed.available_amount() == 0 && missing_components.count() == 0)
            {
                subentry.entries.listAppend("Make a " + bird_needed + ".");
            }
            else if (!(relevant_familiars contains my_familiar()) && bird_needed.available_amount() == 0)
            {
                subentry.entries.listAppend(HTMLGenerateSpanFont("Bring along " + bird_needed_familiar + " to speed up quest.", "red"));
            }
            else if ((relevant_familiars contains my_familiar()) && bird_needed.available_amount() > 0)
            {
                subentry.entries.listAppend("Bring along another familiar, you don't need to use the bird anymore.");
            }
        }
        if (bird_needed.available_amount() == 0)
        {
            string line = "";
            line = "Acquire " + bird_needed + ".";
        
            if (missing_components.count() == 0)
                line += " You have all the parts, make it.";
            else
                line += " Parts needed: " + missing_components.listJoinComponents(", ", "and");
            subentry.entries.listAppend(line);
        }
        int black_forest_progress = get_property_int("blackForestProgress");
        if (black_forest_progress >= 1 && __quest_state["Level 13"].state_boolean["wall of skin will need to be defeated"] && $item[beehive].available_amount() == 0)
        {
            subentry.entries.listAppend("Find a beehive for the tower, from the non-combat.|*" + listMake("Head toward the blackberry patch", "Head toward the buzzing sound", "Keep going", "Almost... there...").listJoinComponents(__html_right_arrow_character) + "|*Costs two extra turns. Skip if you're towerkilling.");
        }
        //if (black_forest_progress > 0)
        subentry.entries.listAppend("~" + (black_forest_progress * 20) + "% finished.");
    }
    else if (base_quest_state.mafia_internal_step < 3)
    {
        //Vacation:
        if ($item[forged identification documents].available_amount() == 0)
        {
            subentry.header = "Buy forged identification documents";
            image_name = "__item forged identification documents";
            url = "shop.php?whichshop=blackmarket";
            subentry.entries.listAppend("From the black market.");
            if ($item[can of black paint].available_amount() == 0)
                subentry.entries.listAppend("Also buy a can of black paint while you're there, for the desert quest.");
        }
        else
        {
            if (CounterLookup("Semi-rare").CounterWillHitExactlyInTurnRange(0,2))
            {
                image_name = "__item fortune cookie";
                subentry.header = HTMLGenerateSpanFont("Avoid vacationing at the shore", "red");
                subentry.entries.listAppend("Will override semi-rare.");
                //subentry.entries.listAppend(HTMLGenerateSpanFont("Avoid vacationing; will override semi-rare.", "red"));
            }
            else
            {
                url = "place.php?whichplace=desertbeach";
                subentry.header = "Vacation at the shore";
                image_name = "__item your father's MacGuffin diary";
                string diary_owner = "your father's";
                if (my_path_id() == PATH_GELATINOUS_NOOB)
                    diary_owner = "an archeologist's";
                subentry.entries.listAppend("To acquire " + diary_owner + " diary.");
            }
        }
    }
    else if (base_quest_state.mafia_internal_step < 4)
    {
        //Have diary:
        if (to_item("2334").available_amount() == 0) //$item[holy macguffin] has shadow aliasing problem
        {
            //nothing to say
            //subentry.entries.listAppend("Retrieve the MacGuffin.");
            return;
        }
        else
        {
            url = "place.php?whichplace=town";
            subentry.entries.listAppend("Speak to the council.");
        }
    }
    if (make_entry_future)
        future_task_entries.listAppend(ChecklistEntryMake(12, image_name, url, subentry, $locations[the black forest]));
    else
        task_entries.listAppend(ChecklistEntryMake(13, image_name, url, subentry, $locations[the black forest]));
}

void QLevel11GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
        return;
    QLevel11RonGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11ShenGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (!__misc_state["in run"])
        return;
    //Such a complicated quest.
    QLevel11BaseGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11ManorGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11PalindomeGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11DesertGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11PyramidGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11HiddenCityGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QLevel11HiddenTempleGenerateTasks(task_entries, optional_task_entries, future_task_entries);
}

static
{
    item [string][int] __if_potions_with_numeric_modifiers;
    
    
    /*void ItemFilterInitialise()
    {
        boolean [string] modifier_names = $strings[Meat Drop,Initiative,Muscle,Mysticality,Moxie,Muscle Percent,Mysticality Percent,Moxie Percent];
        
        foreach modifier in modifier_names
        {
            __if_potions_with_numeric_modifiers[modifier] = listMakeBlankItem();
        }
        foreach it in $items[]
        {
            if (it.inebriety > 0 || it.fullness > 0 || it.spleen > 0) continue;
            effect e = it.to_effect();
            if (e == $effect[none]) continue;
            foreach modifier in modifier_names
            {
                if (e.numeric_modifier(modifier) > 0.0)
                {
                    __if_potions_with_numeric_modifiers[modifier].listAppend(it);
                }
            }
        }
    }
    
    
    ItemFilterInitialise();*/
}


void ItemFilterInitialisePotionsForModifier(string modifier)
{
    if (__if_potions_with_numeric_modifiers contains modifier)
        return;
    __if_potions_with_numeric_modifiers[modifier] = listMakeBlankItem();

    foreach it in $items[]
    {
        if (it.inebriety > 0 || it.fullness > 0 || it.spleen > 0) continue;
        effect e = it.to_effect();
        if (e == $effect[none]) continue;
        if (e.numeric_modifier(modifier) != 0.0)
        {
            __if_potions_with_numeric_modifiers[modifier].listAppend(it);
        }
    }
}


item [int] ItemFilterGetPotionsWithNumericModifiers(string [int] modifiers)
{
    item [int] potions;
    boolean [item] seen_potions;
    foreach key, modifier in modifiers
    {
        item [int] first_layer_list;
        if (!(__if_potions_with_numeric_modifiers contains modifier))
            ItemFilterInitialisePotionsForModifier(modifier);
        
        first_layer_list = __if_potions_with_numeric_modifiers[modifier];
        
        
        foreach key, it in first_layer_list
        {
            if (!it.is_unrestricted())
                continue;
            if (seen_potions contains it)
                continue;
            potions.listAppend(it);
            seen_potions[it] = true;
        }
    }
    
    return potions;
}

item [int] ItemFilterGetPotionsCouldPullToAddToNumericModifier(string [int] modifiers, float minimum_modifier, boolean [item] blocklist)
{
    item [int] relevant_potions_first_layer = ItemFilterGetPotionsWithNumericModifiers(modifiers);
    
    item [int] relevant_potions;
    foreach key, it in relevant_potions_first_layer
    {
        if (it.available_amount() > 0) continue;
        if (!it.tradeable && it.storage_amount() == 0) continue;
        if (!it.item_is_usable()) continue;
        effect e = it.to_effect();
        if (e.have_effect() > 0) continue;
        if (!e.effect_is_usable()) continue;
        float v = 0;
        foreach key, modifier in modifiers
            v += e.numeric_modifier(modifier);
        if (v != 0.0 && v >= minimum_modifier && !(blocklist contains it))
        {
            relevant_potions.listAppend(it);
        }
    }
    if (modifiers.count() == 2)
        sort relevant_potions by -(value.effect_modifier("effect").numeric_modifier(modifiers[0]) + value.effect_modifier("effect").numeric_modifier(modifiers[1]));
    else
        sort relevant_potions by -value.effect_modifier("effect").numeric_modifier(modifiers[0]);
    
    return relevant_potions;
}


item [int] ItemFilterGetPotionsCouldPullToAddToNumericModifier(string modifier, float minimum_modifier, boolean [item] blocklist)
{
    return ItemFilterGetPotionsCouldPullToAddToNumericModifier(listMake(modifier), minimum_modifier, blocklist);
}

void QLevel12Init()
{
	//questL12War
	//fratboysDefeated, hippiesDefeated
	//sidequestArenaCompleted, sidequestFarmCompleted, sidequestJunkyardCompleted, sidequestLighthouseCompleted, sidequestNunsCompleted, sidequestOrchardCompleted
	//warProgress
	
	//Sidequests:
	//state_boolean["Lighthouse Finished"]
	//state_boolean["Orchard Finished"]
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL12War");
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Island War Quest";
	state.image_name = "island war";
	state.council_quest = true;
	
	state.state_boolean["Arena Finished"] = (get_property("sidequestArenaCompleted") != "none");
	state.state_boolean["Farm Finished"] = (get_property("sidequestFarmCompleted") != "none");
	state.state_boolean["Junkyard Finished"] = (get_property("sidequestJunkyardCompleted") != "none");
	state.state_boolean["Lighthouse Finished"] = (get_property("sidequestLighthouseCompleted") != "none");
	state.state_boolean["Nuns Finished"] = (get_property("sidequestNunsCompleted") != "none");
	state.state_boolean["Orchard Finished"] = (get_property("sidequestOrchardCompleted") != "none");
    state.state_boolean["War started"] = (state.mafia_internal_step >= 2);
    state.state_boolean["War in progress"] = state.state_boolean["War started"] && !state.finished;
    
    state.state_int["hippies left on battlefield"] = 1000 - get_property_int("hippiesDefeated");
    state.state_int["frat boys left on battlefield"] = 1000 - get_property_int("fratboysDefeated");
	
	if (state.finished)
	{
		state.state_boolean["Arena Finished"] = true;
		state.state_boolean["Farm Finished"] =  true;
		state.state_boolean["Junkyard Finished"] = true;
		state.state_boolean["Lighthouse Finished"] = true;
		state.state_boolean["Nuns Finished"] = true;
		state.state_boolean["Orchard Finished"] = true;
	}
	if (my_path_id() == PATH_EXPLOSIONS)
		state.state_boolean["Lighthouse Finished"] = true;
    int quests_completed_hippy = 0;
    int quests_completed_frat = 0;
    
    foreach s in $strings[sidequestArenaCompleted,sidequestFarmCompleted,sidequestJunkyardCompleted,sidequestLighthouseCompleted,sidequestNunsCompleted,sidequestOrchardCompleted]
    {
        string property_value = get_property(s);
        if (property_value == "hippy")
            quests_completed_hippy += 1;
        else if (property_value == "fratboy")
            quests_completed_frat += 1;
    }
    
    state.state_int["Quests completed for hippies"] = quests_completed_hippy;
    state.state_int["Quests completed for frat boys"] = quests_completed_frat;
    
    if (!state.finished)
    {
        //define state.state_string["Side seemingly fighting for"]
        //"hippy", "frat boys", "both", ""
        
        if (state.state_int["Quests completed for hippies"] > 0)
            state.state_string["Side seemingly fighting for"] = "hippy";
        if (state.state_int["Quests completed for frat boys"] > 0)
            state.state_string["Side seemingly fighting for"] = "frat boys";
        
        if (state.state_int["hippies left on battlefield"] == 1000 && state.state_int["frat boys left on battlefield"] != 1000)
            state.state_string["Side seemingly fighting for"] = "hippy";
        if (state.state_int["hippies left on battlefield"] != 1000 && state.state_int["frat boys left on battlefield"] == 1000)
            state.state_string["Side seemingly fighting for"] = "frat boys";
        if (state.state_int["hippies left on battlefield"] != 1000 && state.state_int["frat boys left on battlefield"] != 1000)
            state.state_string["Side seemingly fighting for"] = "both";
        if (state.state_int["Quests completed for hippies"] > 0 && state.state_int["Quests completed for frat boys"] > 0)
            state.state_string["Side seemingly fighting for"] = "both";
    }
	
	if (false)
	{
		//Internal debugging:
		state.state_boolean["Arena Finished"] = false;
		state.state_boolean["Farm Finished"] =  false;
		state.state_boolean["Junkyard Finished"] = false;
		state.state_boolean["Lighthouse Finished"] = false;
		state.state_boolean["Nuns Finished"] = false;
		state.state_boolean["Orchard Finished"] = false;
	}
	
	if (my_level() >= 12 && my_path_id() != PATH_EXPLOSIONS)
		state.startable = true;
    
	__quest_state["Level 12"] = state;
	__quest_state["Island War"] = state;
}

void QLevel12GenerateTasksSidequests(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Level 12"];
	if (!base_quest_state.state_boolean["Orchard Finished"])
	{
		string [int] details;
		string [int] modifiers;
	
        string url = "bigisland.php?place=orchard";
		modifiers.listAppend("+1000% item");
		if (__misc_state["yellow ray potentially available"])
			modifiers.listAppend("potential YR");
	
        location next_location;
        monster pickpocket_monster = $monster[none];
        boolean need_gland = false;
		if ($item[heart of the filthworm queen].available_amount() > 0)
		{
			modifiers.listClear();
			details.listAppend("Go talk to the hippies to complete quest.");
		}
		else if ($effect[Filthworm Guard Stench].have_effect() > 0 || $item[Filthworm royal guard scent gland].available_amount() > 0)
		{
			if ($effect[Filthworm Guard Stench].have_effect() == 0)
            {
                url = "inventory.php?which=3";
				details.listAppend("Use filthworm royal guard scent gland.");
            }
			modifiers.listClear();
            modifiers.listAppend("+meat");
			details.listAppend("Defeat the filthworm queen in the queen's chamber.");
            next_location = $location[the filthworm queen's chamber];
		}
		else if ($effect[Filthworm Drone Stench].have_effect() > 0 || $item[Filthworm drone scent gland].available_amount() > 0)
		{
			if ($effect[Filthworm Drone Stench].have_effect() == 0)
            {
                url = "inventory.php?which=3";
				details.listAppend("Use filthworm drone scent gland");
            }
			details.listAppend("Adventure with +item in the guards' chamber.");
            need_gland = true;
            pickpocket_monster = $monster[filthworm royal guard];
            next_location = $location[the royal guard chamber];
		}
		else if ($effect[Filthworm Larva Stench].have_effect() > 0 || $item[filthworm hatchling scent gland].available_amount() > 0)
		{
			if ($effect[Filthworm Larva Stench].have_effect() == 0)
            {
                url = "inventory.php?which=3";
				details.listAppend("Use filthworm hatchling scent gland");
            }
			details.listAppend("Adventure with +item in the feeding chamber.");
            need_gland = true;
            pickpocket_monster = $monster[filthworm drone];
            next_location = $location[the feeding chamber];
		}
		else
		{
			details.listAppend("Adventure with +item in the hatching chamber.");
            need_gland = true;
            pickpocket_monster = $monster[larval filthworm];
            next_location = $location[the hatching chamber];
		}
        
        if (__misc_state["can pickpocket"] && pickpocket_monster != $monster[none])
        {
            int total_initiative_needed = pickpocket_monster.base_initiative;
            int initiative_needed = total_initiative_needed - initiative_modifier();
            if (initiative_needed > 0)
                details.listAppend("Need " + initiative_needed + "% more initiative to pickpocket every turn.");
        }
        
        if (need_gland)
        {
            float effective_item_drop = next_location.item_drop_modifier_for_location() / 100.0;
            //FIXME take into account pickpocketing, init, etc.
            float average_glands_found_per_combat = MIN(1.0, (effective_item_drop + 1.0) * 0.1);
            float turns_per_gland = -1.0;
            if (average_glands_found_per_combat != 0.0)
                turns_per_gland = 1.0 / average_glands_found_per_combat;
            details.listAppend("~" + roundForOutput(turns_per_gland, 1) + " turns per gland.");
        }
	
		optional_task_entries.listAppend(ChecklistEntryMake(19, "Island War Orchard", url, ChecklistSubentryMake("Island War Orchard Quest", modifiers, details), $locations[the hatching chamber, the feeding chamber, the royal guard chamber, the filthworm queen's chamber]));
	}
	if (!base_quest_state.state_boolean["Farm Finished"])
	{
		string [int] details;
		details.listAppend("Great flappin' beasts, with webbed feet and bills! dooks!");
		string [int] modifiers;
        modifiers.listAppend("+meat");
        
        string [int] tasks;
        int ncs_seen = $location[McMillicancuddy's Barn].noncombatTurnsAttemptedInLocation();
        
        if (ncs_seen < 3)
        {
            tasks.listAppend("make a fence out of the barbed wire");
            tasks.listAppend("knock over the lantern");
            tasks.listAppend("dump out the drum");
            details.listAppend("Remember to use a chaos butterfly in combat before clearing the barn.|Then " + tasks.listJoinComponents(", ", "and") + ".");
            
            
            if (__misc_state["free runs available"])
                modifiers.listAppend("free runs in barn");
        }
		optional_task_entries.listAppend(ChecklistEntryMake(20, "Island War Farm", "bigisland.php?place=farm", ChecklistSubentryMake("Island War Farm Quest", modifiers, details), $locations[mcmillicancuddy's farm,mcmillicancuddy's barn,mcmillicancuddy's pond,mcmillicancuddy's back 40,mcmillicancuddy's other back 40,mcmillicancuddy's granary,mcmillicancuddy's bog,mcmillicancuddy's family plot,mcmillicancuddy's shady thicket]));
	}
	if (!base_quest_state.state_boolean["Nuns Finished"])
	{
		string [int] details;
		int meat_gotten = get_property_int("currentNunneryMeat");
		int meat_remaining = 100000 - meat_gotten;
		details.listAppend(meat_remaining + " meat remaining.");
	
		float meat_drop_multiplier = meat_drop_modifier() / 100.0 + 1.0;
		vec2i brigand_meat_drop_range = vec2iMake(800 * meat_drop_multiplier, 1200 * meat_drop_multiplier);
		vec2i turn_range;
		if (brigand_meat_drop_range.x != 0 && brigand_meat_drop_range.y != 0)
			turn_range = vec2iMake(ceil(to_float(meat_remaining) / to_float(brigand_meat_drop_range.y)),
			ceil(to_float(meat_remaining) / to_float(brigand_meat_drop_range.x)));
        if (my_path_id() == PATH_2CRS)
        	turn_range = Vec2iMake(MAX(100, turn_range.x), MAX(100, turn_range.y));
        
            
		
  		string turns_extra = ".";
      	string [int] extra_details;
        if (get_property("boomBoxSong") == "Total Eclipse of Your Meat")
        {
            vec2i brigand_meat_drop_range_sing = vec2iMake(820 * meat_drop_multiplier, 1230 * meat_drop_multiplier);
            vec2i turn_range_sing;
            if (brigand_meat_drop_range_sing.x != 0 && brigand_meat_drop_range_sing.y != 0)
                turn_range_sing = vec2iMake(ceil(to_float(meat_remaining) / to_float(brigand_meat_drop_range_sing.y)),
                ceil(to_float(meat_remaining) / to_float(brigand_meat_drop_range_sing.x)));
            turns_extra = ", if you don't sing.";
            if (turn_range_sing.x == turn_range.x && turn_range_sing.y == turn_range.y)
            {
            	turns_extra = ".";
            }
            else if (turn_range_sing.x == turn_range_sing.y)
                details.listAppend(pluralise(turn_range_sing.x, "turn", "turns") + " remaining, if you sing.");
            else
                details.listAppend("[" + turn_range_sing.x + " to " + turn_range_sing.y + "] turns remaining, if you sing.");
            extra_details.listAppend("Be sure to Sing Along with your boombox every turn.");
            /*float without = meat_remaining / (1000.0 * meat_drop_multiplier);
            float with = meat_remaining / (1025.0 * meat_drop_multiplier);
            details.listAppend("Singing saves " + (without - with) + " turns.");*/
        }
        
              
		//FIXME consider looking into tracking how long until the semi-rare item runs out, for turn calculation
		if (turn_range.x == turn_range.y)
			details.listAppend(pluralise(turn_range.x, "turn", "turns") + " remaining" + turns_extra);
		else
			details.listAppend("[" + turn_range.x + " to " + turn_range.y + "] turns remaining" + turns_extra);
        
        
        if (turn_range.x == 1 && turn_range.y == 2)
        {
        	float chance = 1.0 - TriangularDistributionCalculateCDF(meat_remaining + 1, brigand_meat_drop_range.x, brigand_meat_drop_range.y);
         	details.listAppend((chance * 100.0).floor() + "% chance of completing in one turn.");   
        }
        
        if ($item[ice nine].available_amount() == 0 && __misc_state["can equip just about any weapon"] && $item[ice harvest].available_amount() >= 9 && $item[ice nine].is_unrestricted() && $item[miracle whip].available_amount() == 0) //is this safe? unfinished ice sculpture is really nice, and ice bucket in sneaky pete...
            details.listAppend("Possibly make and equip an ice nine. (+30% meat 1h weapon)");
                
        if ($effect[Sinuses For Miles].have_effect() > 0 && !get_property_ascension("lastTempleAdventures") && $item[stone wool].available_amount() > 0 && get_property_ascension("lastTempleUnlock"))
            details.listAppend("Potentially use stone wool and visit the hidden temple to extend Sinuses for Miles for 3 turns.");
        
        
        if (my_path_id() == PATH_HEAVY_RAINS && $skill[Make it Rain].skill_is_usable() && turn_range.y > 1)
            details.listAppend("Cast Make it Rain each fight. (+300%? meat)");
        if ($item[Sneaky Pete's leather jacket (collar popped)].equipped_amount() > 0 && turn_range.y > 1)
            details.listAppend("Could unpop your collar. (+20% meat)");
	
        if (__misc_state_int["pulls available"] > 0 && meat_drop_modifier() < 1000.0)
        {
            int limit = 100;
            if (meat_drop_modifier() < 800.0)
                limit = 50;
            if (my_path_id() == PATH_G_LOVER)
            	limit = 25;
            limit = 0; //show them all - we'll go based off of turns saved
            boolean [item] blocklist = $items[uncle greenspan's bathroom finance guide,black snowcone];
            item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Meat Drop", limit, blocklist);
            string [int] relevant_potions_output;
            float average_turns_currently = meat_remaining / ((meat_drop_modifier() / 100.0 + 1.0) * 1000.0);
            foreach key, it in relevant_potions
            {
                effect e = it.to_effect();
            	if (!e.effect_is_usable())
                	continue;
                if (!it.item_is_usable())
                    continue;
                //average_turns_currently - 
                float meat_dropped_per_turn_with_item = ((meat_drop_modifier() + e.numeric_modifier("meat drop")) / 100.0 + 1.0) * 1000.0;
                float turns_saved = average_turns_currently - meat_remaining / meat_dropped_per_turn_with_item;
                if (turns_saved < 1.0) continue;
                relevant_potions_output.listAppend(it + " (" + e.numeric_modifier("meat drop").roundForOutput(0) + "%, " + turns_saved.roundForOutput(1) + " turns saved)");
            }
            
            if (relevant_potions_output.count() > 0)
                details.listAppend("Could try pulling " + relevant_potions_output.listJoinComponents(", ", "or") + ".");
        }
        details.listAppendList(extra_details);
		optional_task_entries.listAppend(ChecklistEntryMake(21, "Island War Nuns", "bigisland.php?place=nunnery", ChecklistSubentryMake("Island War Nuns Quest", "+meat", details), $locations[the themthar hills]));
	}
	if (!base_quest_state.state_boolean["Junkyard Finished"])
	{
		string [int] details;
		if ($item[molybdenum magnet].available_amount() == 0)
		{
			details.listAppend("Talk to Yossarian first.");
		}
		else
		{
			location [item] items_and_locations;
			items_and_locations[$item[molybdenum hammer]] = $location[Next to that Barrel with Something Burning in it];
			items_and_locations[$item[molybdenum pliers]] = $location[Near an Abandoned Refrigerator];
			items_and_locations[$item[molybdenum crescent wrench]] = $location[Over Where the Old Tires Are];
			items_and_locations[$item[molybdenum screwdriver]] = $location[Out By that Rusted-Out Car];
			boolean have_all = true;
            
            string [location][int] location_monsters;
            location_monsters[$location[Next to that Barrel with Something Burning in it]] = listMake("tool batwinged", "vegetable");
            location_monsters[$location[Out By that Rusted-Out Car]] = listMake("tool vegetable", "erudite");
            location_monsters[$location[Near an Abandoned Refrigerator]] = listMake("tool spider", "batwinged");
            location_monsters[$location[Over Where the Old Tires Are]] = listMake("tool erudite", "spider");
            
            location [int][monster] banishment_locations; //it's time we had a talk... about your hair! it's gone too far!
            banishment_locations[1][$monster[batwinged gremlin]] = $location[Near an Abandoned Refrigerator];
            banishment_locations[1][$monster[erudite gremlin]] = $location[Out By that Rusted-Out Car];
            banishment_locations[1][$monster[spider gremlin]] = $location[Over Where the Old Tires Are];
            banishment_locations[1][$monster[vegetable gremlin]] = $location[Next to that Barrel with Something Burning in it];
            
            
            banishment_locations[0][$monster[batwinged gremlin]] = $location[Next to that Barrel with Something Burning in it];
            banishment_locations[0][$monster[erudite gremlin]] = $location[Over Where the Old Tires Are];
            banishment_locations[0][$monster[spider gremlin]] = $location[Near an Abandoned Refrigerator];
            banishment_locations[0][$monster[vegetable gremlin]] = $location[Out By that Rusted-Out Car];
            
            foreach key in banishment_locations
            {
                foreach m in banishment_locations[key]
                {
                    if (!m.is_banished())
                        continue;
                    location l = banishment_locations[key][m];
                    
                    if (key == 0 && location_monsters[l][key].contains_text("tool "))
                        location_monsters[l][key] = "tool " + HTMLGenerateSpanFont(location_monsters[l][key].replace_string("tool ", ""), "grey", "");
                    else
                        location_monsters[l][key] = HTMLGenerateSpanFont(location_monsters[l][key], "grey");
                }
            }


            
            item [int] item_display_order = listMake($item[molybdenum hammer],$item[molybdenum pliers],$item[molybdenum crescent wrench],$item[molybdenum screwdriver]); //make a path
            string [int] areas_left_strings;
			//foreach it in items_and_locations
            
            string [location] location_shorthand_name;
            location_shorthand_name[$location[Next to that Barrel with Something Burning in it]] = "Barrel";
            location_shorthand_name[$location[Out By that Rusted-Out Car]] = "Car";
            location_shorthand_name[$location[Near an Abandoned Refrigerator]] = "Refrigerator";
            location_shorthand_name[$location[Over Where the Old Tires Are]] = "Tires";
            
            foreach key in item_display_order
			{
                item it = item_display_order[key];
				location loc = items_and_locations[it];
				if (it.available_amount() > 0)
				{
					continue;
				}
				else
					have_all = false;
                
                string location_display_name;
                if (location_shorthand_name contains loc)
                    location_display_name = location_shorthand_name[loc];
                else
                    location_display_name = loc.to_string().to_lower_case();
                    
                areas_left_strings.listAppend("<strong>" + location_display_name + "</strong> - " + location_monsters[loc].listJoinComponents(", "));
			}
            if (areas_left_strings.count() > 0)
                details.listAppend("Areas left:|*" + areas_left_strings.listJoinComponents("<hr>|*"));
			if (have_all)
				details.listAppend("Talk to Yossarian to complete quest.");
			else
            {
                if ($item[dictionary].available_amount() > 0 && $item[dictionary].item_is_usable())
                {
                    details.listAppend("Read from the dictionary to stasis gremlins.");
                }
                else if ($item[facsimile dictionary].available_amount() > 0 && $item[facsimile dictionary].item_is_usable())
                {
                    details.listAppend("Read from the facsimile dictionary to stasis gremlins.");
                }
                else if ($item[seal tooth].available_amount() > 0 && $item[seal tooth].item_is_usable())
                {
                    details.listAppend("Use your seal tooth to stasis gremlins.");
                }
                else if ($skill[suckerpunch].skill_is_usable())
                {
                    details.listAppend("Cast suckerpunch to stasis gremlins.");
                }
                else if ($item[seal tooth].item_is_usable())
                    details.listAppend(HTMLGenerateSpanFont("Acquire a seal tooth", "red") + " to stasis gremlins. (from hermit)");
                else if ($item[beehive].available_amount() > 0)
                    details.listAppend("Use your beehive to stasis gremlins.");
                
                if (!$monster[A.M.C. gremlin].is_banished())
                    details.listAppend("Potentially banish A.M.C. Gremlin.");
            }
		}
		optional_task_entries.listAppend(ChecklistEntryMake(22, "Island War Junkyard", "bigisland.php?place=junkyard", ChecklistSubentryMake("Island War Junkyard Quest", listMake("+DR", "+DA", "+HP", "+moxie"), details), $locations[next to that barrel with something burning in it,near an abandoned refrigerator,over where the old tires are,out by that rusted-out car]));
	}
	if (!base_quest_state.state_boolean["Lighthouse Finished"])
	{
		string [int] details;
	
        int gunpowder_needed = MAX(0, 5 - $item[barrel of gunpowder].available_amount());
        
        
        string [int] modifiers;
        if (gunpowder_needed > 0)
        {
            modifiers = listMake("+combat", "copies");
            if (gunpowder_needed == 1)
                details.listAppend("Need " + gunpowder_needed + " more barrel of gunpowder.");
            else
                details.listAppend("Need " + gunpowder_needed + " more barrels of gunpowder.");
            
            
            
            //this is an approximation:
            //off by a little over half a turn on average
            float effective_combat_rate = (11.0 / 12.0) * clampNormalf(0.1 + combat_rate_modifier() / 100.0) + (1.0 / 12.0) * 1.0;
            float turns_per_lobster = -1.0;
            if (effective_combat_rate != 0.0)
                turns_per_lobster = 1.0 / effective_combat_rate;
                
            
            float turns_to_complete = gunpowder_needed.to_float() * turns_per_lobster;
            
            //I had the data lying around, so why not?
            //misses <-10 and >30, but the estimate above will catch that
            float [int][int] lfm_simulation_data;
            lfm_simulation_data[5][-10] = 60.00; lfm_simulation_data[5][-5] = 40.02; lfm_simulation_data[5][0] = 29.92; lfm_simulation_data[5][5] = 23.84; lfm_simulation_data[5][10] = 19.76; lfm_simulation_data[5][15] = 16.84; lfm_simulation_data[5][20] = 14.66; lfm_simulation_data[5][25] = 13.00; lfm_simulation_data[4][-10] = 48.00; lfm_simulation_data[4][-5] = 32.27; lfm_simulation_data[4][0] = 24.20; lfm_simulation_data[4][5] = 19.29; lfm_simulation_data[4][10] = 16.00; lfm_simulation_data[4][15] = 13.68; lfm_simulation_data[4][20] = 11.96; lfm_simulation_data[4][25] = 10.63; lfm_simulation_data[3][-10] = 36.00; lfm_simulation_data[3][-5] = 24.53; lfm_simulation_data[3][0] = 18.47; lfm_simulation_data[3][5] = 14.78; lfm_simulation_data[3][10] = 12.34; lfm_simulation_data[3][15] = 10.59; lfm_simulation_data[3][20] = 9.26; lfm_simulation_data[3][25] = 8.20; lfm_simulation_data[2][-10] = 24.00; lfm_simulation_data[2][-5] = 16.79; lfm_simulation_data[2][0] = 12.84; lfm_simulation_data[2][5] = 10.38; lfm_simulation_data[2][10] = 8.68; lfm_simulation_data[2][15] = 7.40; lfm_simulation_data[2][20] = 6.40; lfm_simulation_data[2][25] = 5.60; lfm_simulation_data[1][-10] = 12.00; lfm_simulation_data[1][-5] = 9.19; lfm_simulation_data[1][0] = 7.17; lfm_simulation_data[1][5] = 5.72; lfm_simulation_data[1][10] = 4.66; lfm_simulation_data[1][15] = 3.87; lfm_simulation_data[1][20] = 3.29; lfm_simulation_data[1][25] = 2.84; lfm_simulation_data[5][26] = 12.71; lfm_simulation_data[5][27] = 12.44; lfm_simulation_data[5][28] = 12.18; lfm_simulation_data[5][29] = 11.93; lfm_simulation_data[5][30] = 11.69; lfm_simulation_data[4][26] = 10.40; lfm_simulation_data[4][27] = 10.17; lfm_simulation_data[4][28] = 9.96; lfm_simulation_data[4][29] = 9.75; lfm_simulation_data[4][30] = 9.56; lfm_simulation_data[3][26] = 8.01; lfm_simulation_data[3][27] = 7.83; lfm_simulation_data[3][28] = 7.65; lfm_simulation_data[3][29] = 7.48; lfm_simulation_data[3][30] = 7.32; lfm_simulation_data[2][26] = 5.46; lfm_simulation_data[2][27] = 5.33; lfm_simulation_data[2][28] = 5.20; lfm_simulation_data[2][29] = 5.07; lfm_simulation_data[2][30] = 4.96; lfm_simulation_data[1][26] = 2.76; lfm_simulation_data[1][27] = 2.69; lfm_simulation_data[1][28] = 2.62; lfm_simulation_data[1][29] = 2.56; lfm_simulation_data[1][30] = 2.50;
            
            if (lfm_simulation_data[gunpowder_needed] contains combat_rate_modifier().to_int())
            {
                turns_to_complete = lfm_simulation_data[gunpowder_needed][combat_rate_modifier().to_int()];
                if (gunpowder_needed != 0.0)
                    turns_per_lobster = turns_to_complete / gunpowder_needed.to_float();
            }
            
            details.listAppend("~" + roundForOutput(turns_to_complete, 1) + " turns to complete quest at " + combat_rate_modifier().floor() + "% combat.|~" + roundForOutput(turns_per_lobster, 1) + " turns per lobster.");
            
            if ($skill[meteor lore].have_skill() && get_property_int("_macrometeoriteUses") < 10)
            {
            	details.listAppend("Could use macrometeorite on a wandering monster (portscan, voting) to guarantee an LFM.");
                if ($item[&quot;I Voted!&quot; sticker].available_amount() > 0 && get_property_int("_voteFreeFights") >= 3)
                {
                	if (total_turns_played() % 11 == 1 && get_property_int("lastVoteMonsterTurn") < total_turns_played())
                    {
                        details.listAppend("Voting monster now!");
                    }
                    else
                    {
                    	int turns_to_next_voting_monster = 11 - (((total_turns_played() % 11) - 1 + 11) % 11);
                        details.listAppend("Voting monster will appear in " + pluralise(turns_to_next_voting_monster, "more turn", "more turns") + ".");
                    }
                    
                }
            }
        }
        else
            details.listAppend("Talk to the lighthouse keeper to finish quest.");
        
	
		optional_task_entries.listAppend(ChecklistEntryMake(23, "Island War Lighthouse", "bigisland.php?place=lighthouse", ChecklistSubentryMake("Island War Lighthouse Quest", modifiers, details), $locations[sonofa beach]));
	}
	if (!base_quest_state.state_boolean["Arena Finished"] && my_path_id() != PATH_G_LOVER && my_path_id() != PATH_POCKET_FAMILIARS)
	{
		string [int] modifiers;
		modifiers.listAppend("+ML");
		float percent_done = clampf(get_property_int("flyeredML") / 10000.0 * 100.0, 0.0, 100.0);
		int ml_remaining = 10000 - get_property_int("flyeredML");
		string [int] details;
		if (percent_done >= 100.0)
		{
			modifiers.listClear();
			details.listAppend("Turn in quest.");
		}
		else
		{
			if ($item[jam band flyers].available_amount() == 0 && $item[rock band flyers].available_amount() == 0)
				details.listAppend("Acquire fliers.");
            details.listAppend(round(percent_done, 1) + "% ML completed, " + ml_remaining + " ML remains.");
		}
	
        //Normally, this would be bigisland.php?place=concert
        //But that could theoretically complete the quest for the wrong side, if they're wearing the wrong uniform and misclick.
		optional_task_entries.listAppend(ChecklistEntryMake(24, "Island War Arena", "bigisland.php", ChecklistSubentryMake("Island War Arena Quest", modifiers, details)));
		
		if (ml_remaining > 0 && ($item[jam band flyers].available_amount() > 0 || $item[rock band flyers].available_amount() > 0))
		{
			item it = $item[jam band flyers];
			if ($item[rock band flyers].available_amount() > 0 && $item[jam band flyers].available_amount() == 0)
				it = $item[rock band flyers];
			task_entries.listAppend(ChecklistEntryMake(25, it, "", ChecklistSubentryMake("Flyer with " + it + " every combat", "+ML", details), -11));
		}
	}
}


void QLevel12GenerateBattlefieldDescription(ChecklistSubentry subentry, string side, int enemies_remaining, int enemies_defeated_per_combat, string enemy_name, string enemy_name_plural, string boss_name, string [int] sidequest_list, string [int] base_sidequest_list)
{
    if (enemies_defeated_per_combat == 0)
        return;
    
    int enemies_defeated = 1000 - enemies_remaining;
    string line;
    if (enemies_remaining > 0)
    {
        line = pluralise(enemies_remaining, enemy_name, enemy_name_plural) + " left.";
    }
    else
    {
        line += "Fight " + boss_name + "!";
        if (my_path_id() == PATH_DEMIGUISE && $effect[Flared Nostrils].have_effect() > 0)
        	line += "|" + HTMLGenerateSpanFont("Remove Flared Nostrils", "red") + " or you will die.";
        if (my_path_id() == PATH_DEMIGUISE)
        {
        	int damage_taken = 0;
            damage_taken += ceil(my_maxhp() * 2.0 * (1.0 - elemental_resistance($element[stench]) / 100.0));
            if ($effect[flared nostrils].have_effect() > 0)
                damage_taken += ceil(my_maxhp() * 2.0 * 2.0);
            else
	            damage_taken += ceil(my_maxhp() * 2.0 * (1.0 - elemental_resistance($element[sleaze]) / 100.0));
        	subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+stench res", "r_element_stench_desaturated"));
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+sleaze res", "r_element_sleaze_desaturated"));
            
            line += "|Will take " + damage_taken + " damage at the start of combat";
            if (damage_taken >= my_maxhp())
            	line += ", " + HTMLGenerateSpanFont("which you cannot survive", "red");
            line += ".";
        	line += "|Run " + HTMLGenerateSpanOfClass("stench", "r_element_stench") + " and " + HTMLGenerateSpanOfClass("sleaze", "r_element_sleaze") + " resistance.";
            if (my_hp() != my_maxhp())
	            line += "|" + HTMLGenerateSpanFont("Also restore your HP.", "red");
        }
    }
    
    string outfit_name;
    if (side == "hippy")
        outfit_name = "War Hippy Fatigues";
    if (side == "frat boy")
        outfit_name = "Frat Warrior Fatigues";
    
    if (outfit_name != "")
    {
        item [int] missing_outfit_components = missing_outfit_components(outfit_name);
        if (missing_outfit_components.count() > 0)
            line += "|*Missing outfit piece" + (missing_outfit_components.count() > 1 ? "s" : "") + " " + missing_outfit_components.listJoinComponents(", ", "and") + ".";
    }
    int turns_remaining = ceiling(enemies_remaining.to_float() / enemies_defeated_per_combat.to_float());
    if (turns_remaining > 0)
    {
        line += "|*" + pluralise(turns_remaining, "turn", "turns") + " remaining.";
        line += " " + pluralise(enemies_defeated_per_combat, enemy_name, enemy_name_plural) + " defeated per combat.";
    }
    int enemies_to_defeat_for_unlock = -1;
    string area_to_unlock = "";
    string [int] areas_unlocked_but_not_completed;
    
    boolean [string] areas_blocked;
    if (my_path_id() == PATH_G_LOVER || my_path_id() == PATH_POCKET_FAMILIARS)
        areas_blocked["Arena"] = true;
    
    foreach key, sidequest in base_sidequest_list
    {
    	if (areas_blocked[sidequest])
        	continue;
        if (!__quest_state["Level 12"].state_boolean[sidequest + " Finished"])
        {
            areas_unlocked_but_not_completed.listAppend(sidequest);
        }
    }
    
    if (my_path_id() != PATH_BUGBEAR_INVASION) //FIXME test against trendy bugbear chef being needed
    {
        if (side == "frat boy" && __misc_state["free runs usable"])
            subentry.modifiers.listAppend("possibly olfact Green Ops Soldier");
        else if (side == "hippy")
            subentry.modifiers.listAppend("possibly olfact Sorority Operator");
    }
    
    int [int] unlock_threshold;
    unlock_threshold[0] = 64;
    unlock_threshold[1] = 192;
    unlock_threshold[2] = 458;
    
    for i from 2 to 0 by -1
    {
        int threshold = unlock_threshold[i];
        if (areas_blocked[sidequest_list[i]]) continue;
        if (!__quest_state["Level 12"].state_boolean[sidequest_list[i] + " Finished"])
        {
            if (enemies_defeated < threshold)
            {
                area_to_unlock = sidequest_list[i];
                enemies_to_defeat_for_unlock = threshold - enemies_defeated;
            }
            else
            {
                areas_unlocked_but_not_completed.listAppend(sidequest_list[i]);
            }
        }
    }
    
    if (enemies_to_defeat_for_unlock != -1)
    {
        int turns_to_reach = ceiling(enemies_to_defeat_for_unlock.to_float() / enemies_defeated_per_combat.to_float());
        line += "|*" + pluralise(turns_to_reach, "turn", "turns") + " (" + pluralise(enemies_to_defeat_for_unlock, enemy_name, enemy_name_plural) + ") to unlock " + area_to_unlock + ".";
    }
    
    if (areas_unlocked_but_not_completed.count() > 0 && enemies_remaining > 0)
        line += "|*Quests accessible: " + areas_unlocked_but_not_completed.listJoinComponents(", ", "and") + ".";
    
    subentry.entries.listAppend(line);
    
    if (enemies_remaining == 0)
    {
        string [int] items_to_turn_in_for;
        if (__quest_state["Level 13"].state_boolean["shadow will need to be defeated"])
        {
            if (side == "hippy")
                items_to_turn_in_for.listAppend("filthy poultices for shadow");
            else
                items_to_turn_in_for.listAppend("gauze garters for shadow");
        }
        
        string line2 = "Also, turn in gear to your home camp.";
        if (items_to_turn_in_for.count() > 0)
            line2 += " Acquire " + items_to_turn_in_for.listJoinComponents(", ", "and") + ", etc.";
        subentry.entries.listAppend(line2);
    }
}

void QLevel12ExplosionsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_path_id() != PATH_EXPLOSIONS) return;
	if (QuestState("questL12HippyFrat").finished) return;
	
	string [int] description;
	string url = "place.php?whichplace=exploathing";
	
	int fratboys_defeated = get_property_int("fratboysDefeated");
    int hippies_defeated = get_property_int("hippiesDefeated");
    int fratboys_left = clampi(333 - fratboys_defeated, 0, 333);
    int hippies_left = clampi(333 - hippies_defeated, 0, 333);
    
    if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues"))
    	description.listAppend("Find a uniform. Either calculate the universe 151st + YR, wish + YR?, pull, or yellow-ray a battlefield enemy with the outfit?");
    else if (!is_wearing_outfit("War Hippy Fatigues") && !is_wearing_outfit("Frat Warrior Fatigues"))
    {
    	description.listAppend("Equip a war outfit first.");
    	url = "inventory.php?which=2";
    }
    if ($items[jacob's rung,haunted paddle-ball].available_amount() == 0)
    {
        description.listAppend((!in_hardcore() ? "Pull/" : "") + "YR a jacob's rung or haunted paddle-ball, from the top floor of spookyraven manor.|Jacob's adder in the Haunted Laboratory or possessed toy chest in the The Haunted Nursery have them.");
    }
    else if ($items[jacob's rung,haunted paddle-ball].equipped_amount() == 0)
    {
        if ($item[haunted paddle-ball].have())
        {
            description.listAppend("Equip haunted paddle-ball first.");
            url = generateEquipmentLink($item[haunted paddle-ball]);
        }
        else if ($item[jacob's rung].have())
        {
            description.listAppend("Equip jacob's rung first.");
            url = generateEquipmentLink($item[jacob's rung]);
        }
    }
    boolean likely_fighting_frats = false;
    if (fratboys_defeated > 0 && fratboys_defeated > hippies_defeated)
    {
    	likely_fighting_frats = true;
    	if (fratboys_left <= 0)
     	   	description.listAppend("Fight the Man!");
        else
            description.listAppend("Defeat " + pluralise(fratboys_left, "more fratboy", "more fratboys") + ".");
    }
    else
    {
        if (hippies_left <= 0)
            description.listAppend("Fight the Big Wisniewski!");
        else
            description.listAppend("Defeat " + pluralise(hippies_left, "more hippy", "more hippies") + ".");
    }
    
    
    int battlefield_turns = $location[The Exploaded Battlefield].turns_spent;
    int turns_until_next_war_nc = -1;
    if (battlefield_turns < 7)
        turns_until_next_war_nc = 7 - battlefield_turns;
    else
    {
        turns_until_next_war_nc = (battlefield_turns + 7) % 7;
        if (turns_until_next_war_nc != 0)
        	turns_until_next_war_nc = 7 - turns_until_next_war_nc;
    }
    
    if (turns_until_next_war_nc == 0)
    {
        description.listAppend("Non-combat now. Throw high-adventure consumable to speed up war.");
    }
    else
    	description.listAppend(pluraliseWordy(turns_until_next_war_nc, "More Turn", "more turns").capitaliseFirstLetter() + " until war NC.");
    
    
    if (likely_fighting_frats)
    {
        if ($item[space wine].available_amount() == 0)
            description.listAppend("Buy some space wine for the non-combat.");
    }
    else
    {
    	if ($items[pie man was not meant to eat,space chowder].available_amount() == 0)
            description.listAppend("Buy some space chowder for the non-combat.");
    }
	
	task_entries.listAppend(ChecklistEntryMake(26, "island war", url, ChecklistSubentryMake("War!", "", description), 0));
}

void QLevel12GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() == PATH_EXPLOSIONS)
		QLevel12ExplosionsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	if (!__quest_state["Level 12"].in_progress)
		return;
	
	QuestState base_quest_state = __quest_state["Level 12"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
	
	task_entries.listAppend(ChecklistEntryMake(27, base_quest_state.image_name, "island.php", subentry, $locations[the battlefield (frat uniform), the battlefield (hippy uniform), frat house, hippy camp, wartime frat house, wartime frat house (hippy disguise), wartime hippy camp, wartime hippy camp (frat disguise)]));
	if (base_quest_state.mafia_internal_step < 2)
	{
		subentry.modifiers.listAppend("-combat");
		subentry.entries.listAppend("Start the war!");
        
        float noncombat_rate = 1.0 - (.85 + combat_rate_modifier() / 100.0);
        float turns_remaining = -1.0;
        if (noncombat_rate != 0.0)
            turns_remaining = 3.0 / noncombat_rate;
        
        
		if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues"))
		{
            //FIXME suggest routes to doing both.
			subentry.entries.listAppend("Need either the war hippy fatigues or frat warrior fatigues outfit.");
            if ($familiar[slimeling].familiar_is_usable())
                subentry.modifiers.listAppend("slimeling?");
		}
		else
        {
            string [int] stats_needed;
            if (my_basestat($stat[moxie]) < 70)
                stats_needed.listAppend((70 - my_basestat($stat[moxie])) + " more moxie");
            if (my_basestat($stat[mysticality]) < 70)
                stats_needed.listAppend((70 - my_basestat($stat[mysticality])) + " more mysticality");
            if (stats_needed.count() == 0)
                subentry.entries.listAppend("Wear war outfit, run -combat, adventure in other side's camp.");
            else
            {
                string line = "Acquire " + stats_needed.listJoinComponents(", ", "and") + " to wear war outfit.";
                if (my_class() == $class[pastamancer] && (is_wearing_outfit("War Hippy Fatigues") || is_wearing_outfit("Frat Warrior Fatigues")))
                    line += "|Or... wear it anyways, because you're a pastamancer.";
                subentry.entries.listAppend(line);
            }
            
            
            //need 70 moxie, 70 myst
            
        }
        if (false && $item[talisman o' namsilat].available_amount() == 0 && !__quest_state["Level 11 Palindome"].finished && my_path_id() != PATH_G_LOVER)
        {
            subentry.entries.listAppend("May want to " + HTMLGenerateSpanFont("acquire the Talisman o' Nam", "red") + " first.");
        }
        
        subentry.entries.listAppend(generateTurnsToSeeNoncombat(85, 3, "start war"));
	}
	else
	{
		int sides_completed_hippy = base_quest_state.state_int["Quests completed for hippies"];
		int sides_completed_frat = base_quest_state.state_int["Quests completed for frat boys"];
		
        int frat_boys_left = base_quest_state.state_int["frat boys left on battlefield"];
		int hippies_left = base_quest_state.state_int["hippies left on battlefield"];
		
		int frat_boys_defeated_per_combat = powi(2, sides_completed_hippy);
		int hippies_defeated_per_combat = powi(2, sides_completed_frat);
        
        if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && get_property("peteMotorbikeCowling") == "Rocket Launcher")
        {
            frat_boys_defeated_per_combat += 3;
            hippies_defeated_per_combat += 3;
        }
        if (my_path_id() == PATH_LICENSE_TO_ADVENTURE && get_property_boolean("bondWar"))
        {
            frat_boys_defeated_per_combat += 3;
            hippies_defeated_per_combat += 3;
        }
        
        
        subentry.modifiers.listAppend("+item");
		if (hippies_left < 1000 || (frat_boys_left == 1000 && hippies_left == 1000) || sides_completed_frat > 0)
            QLevel12GenerateBattlefieldDescription(subentry, "frat boy", hippies_left, hippies_defeated_per_combat, "hippy", "hippies", "The Big Wisniewski", listMake("Orchard", "Nuns", "Farm"), listMake("Lighthouse", "Junkyard", "Arena"));
        //specific exception to deal with 151st cheating:
		if ((frat_boys_left < 1000 && !(frat_boys_left >= 998 && hippies_left < 1000)) || (frat_boys_left == 1000 && hippies_left == 1000) || sides_completed_hippy > 0)
            QLevel12GenerateBattlefieldDescription(subentry, "hippy", frat_boys_left, frat_boys_defeated_per_combat, "frat boy", "frat boys", "The Man", listMake("Lighthouse", "Junkyard", "Arena"), listMake("Orchard", "Nuns", "Farm"));
            
        
        if (frat_boys_left == 1 && hippies_left == 1)
		{
			if ($item[flaregun].available_amount() > 0)
				subentry.entries.listAppend("Wossname time! Adventure on battlefield, use a flaregun.");
			else if (!in_hardcore())
				subentry.entries.listAppend("Pull a flaregun for wossname.");
			else if (__misc_state["fax equivalent accessible"])
				subentry.entries.listAppend("Fax smarmy pirate, run +234% item (or YR) for flaregun for wossname.");
			else
				subentry.entries.listAppend("That almost was a wossname, but you needed more flare.");
		}
        
        item [int] items_to_closet_for_desert_hippy;
        foreach it in $items[reinforced beaded headband,round purple sunglasses,bullet-proof corduroys,beer helmet,distressed denim pants,bejeweled pledge pin]
        {
            if (it.available_amount() == 0)
                continue;
            items_to_closet_for_desert_hippy.listAppend(it);
        }
        
        if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues"))
        {
            string line = "Visit the Arid, Extra-Dry Desert to find a hippy uniform.";
            if (items_to_closet_for_desert_hippy.count() > 0)
                line += "|But first closet " + items_to_closet_for_desert_hippy.listJoinComponents(", ", "and");
            subentry.entries.listAppend(line);
        }
        //FIXME Add when spaded:
        /*else if (!have_outfit_components("War Hippy Fatigues"))
        {
            string line = "If you want a hippy uniform without visiting the battlefield, adventure in the Arid, Extra-Dry Desert.";
            if (items_to_closet_for_desert_hippy.count() > 0)
                line += "|But first closet " + items_to_closet_for_desert_hippy.listJoinComponents(", ", "and");
            subentry.entries.listAppend(line);
        }*/
        
		QLevel12GenerateTasksSidequests(task_entries, optional_task_entries, future_task_entries);
	}
	
}


effect [element] __flavour_lookup;
__flavour_lookup[$element[hot]] = $effect[Spirit of Cayenne];
__flavour_lookup[$element[cold]] = $effect[Spirit of Peppermint];
__flavour_lookup[$element[stench]] = $effect[Spirit of Garlic];
__flavour_lookup[$element[spooky]] = $effect[Spirit of Wormwood];
__flavour_lookup[$element[sleaze]] = $effect[Spirit of Bacon Grease];

float damageForElementAgainstElement(float base_damage, element attacking_element, element defence_element)
{
    if (defence_element == $element[none] || attacking_element == $element[none])
        return base_damage;
    if (attacking_element == defence_element)
        return MIN(base_damage, 1);
    if (base_damage < 1)
        return 0.0;
    
    boolean [element] relevant_elements = $elements[sleaze,stench,hot,spooky,cold];
    float [element,element] attack_versus_element;
    foreach e1 in relevant_elements
    {
        foreach e2 in relevant_elements
        {
            if (e1 == e2)
                attack_versus_element[e1][e2] = 0.0;
            else
                attack_versus_element[e1][e2] = 1.0;
        }
    }
    attack_versus_element[$element[sleaze]][$element[stench]] = 2.0;
    attack_versus_element[$element[sleaze]][$element[hot]] = 2.0;
    
    attack_versus_element[$element[stench]][$element[hot]] = 2.0;
    attack_versus_element[$element[stench]][$element[spooky]] = 2.0;
    
    attack_versus_element[$element[hot]][$element[spooky]] = 2.0;
    attack_versus_element[$element[hot]][$element[cold]] = 2.0;
    
    attack_versus_element[$element[spooky]][$element[cold]] = 2.0;
    attack_versus_element[$element[spooky]][$element[sleaze]] = 2.0;
    
    attack_versus_element[$element[cold]][$element[sleaze]] = 2.0;
    attack_versus_element[$element[cold]][$element[stench]] = 2.0;
    
    
    float final = MAX(1, base_damage * attack_versus_element[attacking_element][defence_element]);
    return final;
}

element currentFlavourElement()
{
    foreach s, d in __flavour_lookup
    {
        if (d.have_effect() != 0)
            return s;
    }
    return $element[none];
}

//Does not take into account spell criticals, as they're random by nature.
//FIXME support 100% criticals, I suppose

Vec2f spellFormulaDamageRange(float multiplier, float damage_cap, Vec2f base_damage_range, float buffed_myst_percentage, element e)
{
    Vec2f range = Vec2fMake(0.0, 0.0);
    range.x = base_damage_range.x + floor(my_buffedstat($stat[mysticality]) * buffed_myst_percentage) + numeric_modifier("spell damage");
    range.y = base_damage_range.y + floor(my_buffedstat($stat[mysticality]) * buffed_myst_percentage) + numeric_modifier("spell damage");
    
    if (e != $element[none])
    {
        float element_spell_damage = numeric_modifier(e + " spell damage");
        range.x += element_spell_damage;
        range.y += element_spell_damage;
    }
    if (damage_cap > 0.0)
    {
        range.x = MIN(damage_cap, range.x);
        range.y = MIN(damage_cap, range.y);
    }
    range.x *= multiplier;
    range.y *= multiplier;
    
    range.x *= 1.0 + numeric_modifier("spell damage percent") / 100.0;
    range.y *= 1.0 + numeric_modifier("spell damage percent") / 100.0;
    
    range.x = ceil(range.x);
    range.y = ceil(range.y);
    return range;
}

Record SEDRDamageSource
{
    element element_type;
    Vec2f damage_range;
};

SEDRDamageSource SEDRDamageSourceMake(element e, Vec2f damage_range)
{
    SEDRDamageSource result;
    result.element_type = e;
    result.damage_range = damage_range;
    return result;
}

void listAppend(SEDRDamageSource [int] list, SEDRDamageSource entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

float MLDamageMultiplier()
{
    float ml_damage_multiplier = 1.0;
    ml_damage_multiplier = MIN(1.0, 1.0 - MIN(monster_level_adjustment() * 0.4 / 100.0, 0.5)); //FIXME investigate negative ML
    return ml_damage_multiplier;
}

Vec2f skillExpectedDamageRangeAlternate(monster m, skill s)
{
    //FIXME spade how on earth to properly calculate this
    //for instance, how does elemental spell damage work?
    float ml_damage_multiplier = MLDamageMultiplier();
    
    element flavour_element = currentFlavourElement();
    
    int monster_group_size = 1;
    //FIXME add a bunch of these, or feature request to mafia:
    if (m == $monster[wall of bones])
        monster_group_size = 100; //FIXME spade
    
    element [int] active_lanterns;
    
    if ($item[Rain-Doh green lantern].equipped_amount() > 0)
        active_lanterns.listAppend($element[stench]);
    else if ($item[snow mobile].equipped_amount() > 0)
        active_lanterns.listAppend($element[cold]);
    
    element [int] pastamancer_active_lanterns = active_lanterns.listCopy();
    if ($item[porcelain porkpie].equipped_amount() > 0) //ONLY for pastamancer spells
        pastamancer_active_lanterns.listAppend($element[sleaze]);
    
    
    SEDRDamageSource [int] damage_sources;
    
    if (s == $skill[saucegeyser])
    {
        float multiplier = MIN(3.0, monster_group_size);
        element saucegeyser_element = $element[hot];
        if (m.defense_element == $element[hot] || m.defense_element == $element[sleaze] || m.defense_element == $element[stench])
            saucegeyser_element = $element[cold];
        else if (m.defense_element == $element[cold] || m.defense_element == $element[spooky])
            saucegeyser_element = $element[hot];
        else
        {
            //complicated
            //we pick the one with more spell damage
            //FIXME the exact calculation in-game is probably "whichever element does more damage"
            //we should be doing that now, but we aren't handling hotform/coldform/etc
            //or double-ice
            //but spading suggests if hot spell damage is greater than cold spell damage, it'll always be hot against non-elementals. if they're equal, it's random. if it's less than, it's always cold.
            if (numeric_modifier("hot spell damage") > numeric_modifier("cold spell damage"))
                saucegeyser_element = $element[hot];
            else
                saucegeyser_element = $element[cold];
        }
        Vec2f saucegeyser_base = spellFormulaDamageRange(multiplier, 0.0, Vec2fMake(60.0, 70.0), 0.4, saucegeyser_element);
        //FIXME is the group damage multiplier before or after bonus spell damage?
        damage_sources.listAppend(SEDRDamageSourceMake(saucegeyser_element, saucegeyser_base));
        foreach key, e in active_lanterns
            damage_sources.listAppend(SEDRDamageSourceMake(e, saucegeyser_base));
    }
    else
        return Vec2fMake(-1.0, -1.0);
    Vec2f expected_damage_range = Vec2fMake(0.0, 0.0);
    
    foreach key, damage_source in damage_sources
    {
        expected_damage_range.x += ml_damage_multiplier * damageForElementAgainstElement(damage_source.damage_range.x, damage_source.element_type, m.defense_element);
        expected_damage_range.y += ml_damage_multiplier * damageForElementAgainstElement(damage_source.damage_range.y, damage_source.element_type, m.defense_element);
    }

    return expected_damage_range;
}

float skillExpectedDamageAlternate(monster m, skill s)
{
    Vec2f range = skillExpectedDamageRangeAlternate(m, s);
    return (range.x + range.y) * 0.5;
}
//Active attacks, stinging damage.

int PDS_DAMAGE_TYPE_NONE = 0;
int PDS_DAMAGE_TYPE_ACTIVE = 1;
int PDS_DAMAGE_TYPE_STINGING = 2;

int PDS_SOURCE_TYPE_NONE = 0;
int PDS_SOURCE_TYPE_EFFECT = 1;
int PDS_SOURCE_TYPE_COMBAT_ITEM = 2;
int PDS_SOURCE_TYPE_EQUIPMENT = 3;
int PDS_SOURCE_TYPE_COMBAT_SKILL = 4;
int PDS_SOURCE_TYPE_FAMILIAR = 5;
int PDS_SOURCE_TYPE_BJORN_FAMILIAR = 6; //also crown

record PassiveDamageSource
{
    int damage_type;
    int source_type; //item, etc
    float chance_of_acting;
    int max_rounds_act; //0 for unlimited
    
    Vec2f [element] damage_range;
    
    
    effect source_effect; //if effect
    item source_effect_potion; //if effect
    skill source_effect_skill; //if effect
    item source_equipment; //if equipment
    item source_combat_item; //if combat item
    skill source_combat_skill; //if combat skill
    familiar source_familiar; //familiar or bjorn familiar
};

PassiveDamageSource PassiveDamageSourceMake(int damage_type, int source_type)
{
    PassiveDamageSource pds;
    pds.damage_type = damage_type;
    pds.source_type = source_type;
    pds.chance_of_acting = 1.0;
    
    return pds;
}

void PassiveDamageSourceAddDamage(PassiveDamageSource pds, float min_damage, float max_damage, element e)
{
    Vec2f range;
    range.x = min_damage;
    range.y = max_damage;
    if (pds.damage_range contains e)
    {
        range.x += pds.damage_range[e].x;
        range.y += pds.damage_range[e].y;
    }
    pds.damage_range[e] = range;
}

void PassiveDamageSourceAddDamage(PassiveDamageSource pds, float amount, element e)
{
    PassiveDamageSourceAddDamage(pds, amount, amount, e);
}

void PassiveDamageSourceAddDamage(PassiveDamageSource pds, float physical_only)
{
    PassiveDamageSourceAddDamage(pds, physical_only, $element[none]);
}

void listAppend(PassiveDamageSource [int] list, PassiveDamageSource entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

PassiveDamageSource listExactLastObject(PassiveDamageSource [int] list) //WARNING only works for linear arrays
{
    if (list.count() == 0)
        return PassiveDamageSourceMake(0, 0);
    return list[list.count() - 1];
}

static
{
    PassiveDamageSource [int] __known_sources;
    void PDSInitialiseDoNotCallThis()
    {
        if (__known_sources.count() > 0)
            return;
        //Create every source:
        //FIXME add
        __known_sources.listAppend(PassiveDamageSourceMake(PDS_DAMAGE_TYPE_ACTIVE, PDS_SOURCE_TYPE_EQUIPMENT));
        __known_sources.listExactLastObject().PassiveDamageSourceAddDamage(1, 11, $element[none]); //FIXME WRONG
        __known_sources.listExactLastObject().source_equipment = $item[hand in glove];
        
        //FIXME wrong, but a good preliminary:
        foreach it in $items[MagiMechTech NanoMechaMech,bottle opener belt buckle,old school calculator watch,ant hoe,ant pick,ant pitchfork,ant rake,ant sickle,fishy wand,moveable feast,oversized fish scaler,plastic pumpkin bucket,tiny bowler,cup of infinite pencils,double-ice box,smirking shrunken head,mr. haggis,stapler bear,dubious loincloth,muddy skirt,bottle of Goldschn&ouml;ckered,acid-squirting flower,ironic oversized sunglasses,hippy protest button,cannonball charrrm bracelet,groovy prism necklace,spiky turtle shoulderpads,double-ice cap,parasitic headgnawer,eelskin hat,balloon shield,hot plate,Ol' Scratch's stove door,Oscus's garbage can lid,eelskin shield,eelskin pants,buddy bjorn,shocked shell,crown of thrones]
        {
            __known_sources.listAppend(PassiveDamageSourceMake(PDS_DAMAGE_TYPE_ACTIVE, PDS_SOURCE_TYPE_EQUIPMENT));
            __known_sources.listExactLastObject().PassiveDamageSourceAddDamage(1);
            __known_sources.listExactLastObject().source_equipment = it;
        }
        foreach e in $effects[Skeletal Warrior,Skeletal Cleric,Skeletal Wizard,Bone Homie,Burning\, Man,Biologically Shocked,EVISCERATE!,Fangs and Pangs,Permanent Halloween,Curse of the Black Pearl Onion,Long Live GORF,Apoplectic with Rage,Dizzy with Rage,Quivering with Rage,Jaba&ntilde;ero Saucesphere,Psalm of Pointiness,Drenched With Filth,Stuck-Up Hair,It's Electric!,Smokin',Jalape&ntilde;o Saucesphere,Scarysauce,spiky shell,Boner Battalion]
        {
            __known_sources.listAppend(PassiveDamageSourceMake(PDS_DAMAGE_TYPE_ACTIVE, PDS_SOURCE_TYPE_EFFECT));
            __known_sources.listExactLastObject().PassiveDamageSourceAddDamage(1);
            __known_sources.listExactLastObject().source_effect = e;
        }
        
        foreach f in $familiars[]
        {
            if (!(f.physical_damage || f.elemental_damage) && !($familiars[Doppelshifter,Comma Chameleon,Mad Hatrack,Robot Reindeer,Fancypants Scarecrow,Mini-Adventurer] contains f))
                continue;
            __known_sources.listAppend(PassiveDamageSourceMake(PDS_DAMAGE_TYPE_ACTIVE, PDS_SOURCE_TYPE_FAMILIAR));
            __known_sources.listExactLastObject().chance_of_acting = 0.333; //most
            __known_sources.listExactLastObject().PassiveDamageSourceAddDamage(1);
            __known_sources.listExactLastObject().source_familiar = f;
        }
    }
    
    PDSInitialiseDoNotCallThis();
}


PassiveDamageSource [int] PDSGetActiveDamageSources()
{
    PassiveDamageSource [int] result;
    
    foreach key, pds in __known_sources
    {
        boolean should_add = false;
        if (pds.source_type == PDS_SOURCE_TYPE_EFFECT)
        {
            if (pds.source_effect.have_effect() > 0)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_COMBAT_ITEM)
        {
            //Nothing
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_EQUIPMENT)
        {
            if (pds.source_equipment.equipped_amount() > 0)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_COMBAT_SKILL)
        {
            //Nothing
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_FAMILIAR)
        {
            if (my_familiar() == pds.source_familiar)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_BJORN_FAMILIAR)
        {
            if (my_bjorned_familiar() == pds.source_familiar && $item[buddy bjorn].equipped_amount() > 0)
                should_add = true;
            if (my_enthroned_familiar() == pds.source_familiar && $item[crown of thrones].equipped_amount() > 0)
                should_add = true;
        }
        if (should_add)
            result.listAppend(pds);
    }
    
    return result;
}

//Does not return sources already in effect
PassiveDamageSource [int] PDSGetPotentialDamageSources()
{
    PassiveDamageSource [int] result;

    foreach key, pds in __known_sources
    {
        boolean should_add = false;
        if (pds.source_type == PDS_SOURCE_TYPE_EFFECT)
        {
            if (pds.source_effect.have_effect() == 0)
            {
                if (pds.source_effect_potion.available_amount() > 0)
                    should_add = true;
                if (pds.source_effect_skill.have_skill() && pds.source_effect_skill.is_unrestricted())
                    should_add = true;
            }
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_COMBAT_ITEM)
        {
            if (pds.source_combat_item.available_amount() > 0)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_EQUIPMENT)
        {
            if (pds.source_equipment.equipped_amount() == 0 && pds.source_equipment.can_equip() && pds.source_equipment.available_amount() > 0)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_COMBAT_SKILL)
        {
            //FIXME is this correct?
            if (pds.source_combat_skill.have_skill() && pds.source_combat_skill.is_unrestricted())
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_FAMILIAR)
        {
            if (pds.source_familiar.familiar_is_usable() && my_familiar() != pds.source_familiar)
                should_add = true;
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_BJORN_FAMILIAR)
        {
            //FIXME add
        }
        if (should_add)
            result.listAppend(pds);
    }
    
    return result;
}


string [int] PDSGenerateDescriptionToUneffectPassives()
{
    string [int] effect_types;
    string [int] equipment_types;
    string [int] familiar_types; //you know, because we often bring two or more familiars... with us... avatar of susie?
    string [int] bjorn_familiar_types;
    foreach key, pds in PDSGetActiveDamageSources()
    {
        if (pds.source_type == PDS_SOURCE_TYPE_EFFECT)
        {
            effect_types.listAppend(pds.source_effect);
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_EQUIPMENT)
        {
            equipment_types.listAppend(pds.source_equipment);
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_FAMILIAR)
        {
            familiar_types.listAppend(pds.source_familiar);
        }
        else if (pds.source_type == PDS_SOURCE_TYPE_BJORN_FAMILIAR)
        {
            bjorn_familiar_types.listAppend(pds.source_familiar);
        }
    }
    string [int] result;
    if (effect_types.count() > 0)
        result.listAppend("Uneffect " + effect_types.listJoinComponents(", ", "and") + ".");
    if (equipment_types.count() > 0)
        result.listAppend("Unequip " + equipment_types.listJoinComponents(", ", "and") + ".");
    if (familiar_types.count() > 0)
        result.listAppend("Change familiar from " + familiar_types.listJoinComponents(", ", "and") + ".");
    if (bjorn_familiar_types.count() > 0)
        result.listAppend("Change bjorn/crown familiar from " + bjorn_familiar_types.listJoinComponents(", ", "and") + ".");
    if (get_property("_horsery") == "pale horse") //FIXME make generic
    	result.listAppend("Change to a different horse.");
        
    return result;
}

boolean PDSFamiliarCouldPossiblyAttack(familiar f)
{
    if (f.combat) return true;
    foreach key, pds in __known_sources
    {
        if (pds.source_type == PDS_SOURCE_TYPE_FAMILIAR)
        {
            if (f == pds.source_familiar)
                return true;
        }
    }
    return false;
}



Record TFWMInternalModifier
{
    string description;
    boolean have;
    boolean obtainable_now;
    boolean obtainable_theoretically;
    float bonus;
    
    boolean from_familiar_equipment;
};

boolean TFWMInternalModifierEquals(TFWMInternalModifier a, TFWMInternalModifier b)
{
    if (a.description != b.description)
        return false;
    if (a.have != b.have)
        return false;
    if (a.obtainable_now != b.obtainable_now)
        return false;
    if (a.obtainable_theoretically != b.obtainable_theoretically)
        return false;
    if (a.bonus != b.bonus)
        return false;
    if (a.from_familiar_equipment != b.from_familiar_equipment)
        return false;
    return true;
}

TFWMInternalModifier TFWMInternalModifierMake(string description, boolean have, boolean obtainable_now, boolean obtainable_theoretically, float bonus, boolean from_familiar_equipment)
{
    TFWMInternalModifier result;
    result.description = description;
    result.have = have;
    result.obtainable_now = obtainable_now;
    result.obtainable_theoretically = obtainable_theoretically;
    result.bonus = bonus;
    result.from_familiar_equipment = from_familiar_equipment;
    
    return result;
}

TFWMInternalModifier TFWMInternalModifierMake(string description, boolean have, boolean obtainable_now, boolean obtainable_theoretically, float bonus)
{
    return TFWMInternalModifierMake(description, have, obtainable_now, obtainable_theoretically, bonus, false);
}

TFWMInternalModifier TFWMInternalModifierMake()
{
    return TFWMInternalModifierMake("", false, false, false, 0);
}

TFWMInternalModifier TFWMInternalModifierMake(skill s)
{
    effect e = s.to_effect();
    string description = s;
    if (e != $effect[none] && e.have_effect() == 0)
        description += " (cast)";
    
    float weight_modifier = 0.0;
    if (e != $effect[none])
        weight_modifier = e.numeric_modifier("familiar weight");
    else
        weight_modifier = s.numeric_modifier("familiar weight");
    
    return TFWMInternalModifierMake(description, s.skill_is_usable(), s.skill_is_usable(), s.skill_is_usable(), weight_modifier);
}

TFWMInternalModifier TFWMInternalModifierMake(item equippable_item)
{
    if (equippable_item.available_amount() == 0)
        return TFWMInternalModifierMake();
    float weight_modifier = equippable_item.numeric_modifier("familiar weight");
    
    if (equippable_item == $item[crown of thrones])
        weight_modifier = 5.0;
    
    
    string description = equippable_item;
    if (equippable_item.equipped_amount() == 0)
        description += " (equip)";
    
    TFWMInternalModifier result = TFWMInternalModifierMake(description, true, true, true, weight_modifier);
    
    if (equippable_item.to_slot() == $slot[familiar])
        result.from_familiar_equipment = true;
    return result;
}

void listAppend(TFWMInternalModifier [int] list, TFWMInternalModifier entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}


//Returns TRUE if they currently have, or can easily have, enough to pass.
//Example use:
/*
    string [int] how;
    string [int] immediately_obtainable;
    string [int] missing_potentials;
    FloatHandle missing_weight;
    return !generateTowerFamiliarWeightMethod(how, immediately_obtainable, missing_potentials, missing_weight);
*/
boolean generateTowerFamiliarWeightMethod(string [int] how, string [int] immediately_obtainable, string [int] missing_potentials, FloatHandle missing_weight)
{
    missing_weight.f = 0.0;
    if (__quest_state["Level 13"].finished) //no need
        return true;
    if (!__misc_state["in run"])
        return true;
    if (__misc_state["familiars temporarily blocked"])
        return true;
    
    
    //Not the best of solutions, but...
    
    TFWMInternalModifier [int] weight_modifiers;
    
    //amphibian sympathy
    weight_modifiers.listAppend(TFWMInternalModifierMake($skill[amphibian sympathy]));
    //leash of linguini
    weight_modifiers.listAppend(TFWMInternalModifierMake($skill[leash of linguini]));
    //empathy of the newt
    weight_modifiers.listAppend(TFWMInternalModifierMake($skill[empathy of the newt]));
    //knob goblin pet-buffing spray
    if ($item[knob goblin pet-buffing spray].available_amount() > 0 || dispensary_available() || $effect[heavy petting].have_effect() > 0 && false)
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("knob goblin pet-buffing spray", true, true, true, 5.0));
    }
    else if (__misc_state["can equip just about any weapon"])
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("knob goblin pet-buffing spray (unlock cobb's knob dispensary)", false, false, true, 5.0));
    }
    //hippy concert
    if (get_property("sidequestArenaCompleted") == "hippy" && !get_property_boolean("concertVisited") || $effect[Optimist Primal].have_effect() > 0)
    {
        boolean have_effect = $effect[Optimist Primal].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("Optimist Primal (hippy concert)", have_effect, have_effect || !get_property_boolean("concertVisited"), true, 5.0));
    }
    //irradiated pet snacks
    if ($item[irradiated pet snacks].available_amount() > 0 || $effect[healthy green glow].have_effect() > 0)
    {
        boolean have_effect = $effect[healthy green glow].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("irradiated pet snacks", have_effect, true, true, 10.0));
    }
    else if (__misc_state["can eat just about anything"] || (__misc_state["can drink just about anything"] && __misc_state["VIP available"]))
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("irradiated pet snacks (semi-rare, menagerie level 2)", false, false, true, 10.0));
    }
    if (__misc_state["VIP available"] && __misc_state["can drink just about anything"])
    {
        if (get_property_int("_speakeasyDrinksDrunk") <3 && availableDrunkenness() >= 3 && $item[clan speakeasy].is_unrestricted())
        {
            boolean have_effect = $effect[1701].have_effect() > 0; //hip to the jive
            weight_modifiers.listAppend(TFWMInternalModifierMake("Speakeasy hot socks", have_effect, true, true, 10.0));
        }
        
    }
    //billiards
    if (__misc_state["VIP available"] && get_property_int("_poolGames") <3 && $item[Clan pool table].is_unrestricted() || $effect[Billiards Belligerence].have_effect() > 0)
    {
        boolean have_effect = $effect[Billiards Belligerence].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("VIP Pool (play aggressively)", have_effect, have_effect || (get_property_int("_poolGames") <3), true, 5.0));
    }
    //tea party
    if (($item[&quot;DRINK ME&quot; potion].available_amount() > 0 || $effect[Down the Rabbit Hole].have_effect() > 0) && (!get_property_boolean("_madTeaParty") || $effect[You Can Really Taste the Dormouse].have_effect() > 0))
    {
        boolean have_effect = $effect[You Can Really Taste the Dormouse].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("Mad hatter (reinforced beaded headband)", have_effect, have_effect, true, 5.0));
    }
    //beastly paste
    if ($item[beastly paste].available_amount() > 0 || $effect[Beastly Flavor].have_effect() > 0)
    {
        boolean have_effect = $effect[Beastly Flavor].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("beastly paste (4 spleen)", have_effect, true, true, 3.0));
    }
    else if ($familiar[pair of stomping boots].familiar_is_usable())
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("beastly paste (4 spleen, stomp beasts)", false, false, true, 3.0));
    }
    //resolution
    if ($item[resolution: be kinder].available_amount() > 0 || $effect[Kindly Resolve].have_effect() > 0)
    {
        boolean have_effect = $effect[Kindly Resolve].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("resolution: be kinder", have_effect, true, true, 5.0));
    }
    else if ($skill[summon resolutions].skill_is_usable() && __misc_state["bookshelf accessible"])
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("resolution: be kinder (summon)", false, false, true, 5.0));
    }
    //green candy heart
    skill candy_hearts = $skill[Summon Candy Heart];
    if ($item[green candy heart].available_amount() > 0 || $effect[Heart of Green].have_effect() > 0)
    {
        boolean have_effect = $effect[Heart of Green].have_effect() > 0;
        weight_modifiers.listAppend(TFWMInternalModifierMake("green candy heart", have_effect, true, true, 3.0));
    }
    else if (candy_hearts.skill_is_usable() && __misc_state["bookshelf accessible"] && candy_hearts != $skill[none])
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake("green candy heart (summon)", false, false, true, 3.0));
    }
    
    //sugar sheet, sugar shield
    if ($item[astral pet sweater].available_amount() == 0 && ($item[snow suit].available_amount() == 0 || $item[snow suit].numeric_modifier("familiar weight") < 10.0))
    {
        if ($item[sugar shield].available_amount() > 0)
            weight_modifiers.listAppend(TFWMInternalModifierMake($item[sugar shield]));
        else if ($item[sugar sheet].available_amount() > 0)
        {
            weight_modifiers.listAppend(TFWMInternalModifierMake("sugar shield (use sugar sheet)", false, true, true, 10.0, true));
        }
        else if ($skill[Summon Sugar Sheets].skill_is_usable() && __misc_state["bookshelf accessible"])
        {
            //TFWMInternalModifier TFWMInternalModifierMake(string description, boolean have, boolean obtainable_now, boolean obtainable_theoretically, float bonus)
            weight_modifiers.listAppend(TFWMInternalModifierMake("sugar shield (summon sugar sheet)", false, false, true, 10.0, true));
        }
    }
    //ittah bittah hookah
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[ittah bittah hookah]));
    //lead necklace
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[lead necklace]));
    //snow suit - numeric_modifier($item[snow suit], "familiar weight")
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[snow suit]));
    //astral pet sweater
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[astral pet sweater]));
    
    //greaves of the whatever
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[greaves of the murk lord]));
    //furry halo
    weight_modifiers.listAppend(TFWMInternalModifierMake($item[furry halo]));
    //CoT, if they have the right familiars
    if ($familiars[Animated Macaroni Duck, Autonomous Disco Ball, Barrrnacle, Gelatinous Cubeling, Ghost Pickle on a Stick, Misshapen Animal Skeleton, Pair of Ragged Claws, Penguin Goodfella, Spooky Pirate Skeleton].have_familiar_replacement())
    {
        weight_modifiers.listAppend(TFWMInternalModifierMake($item[crown of thrones]));
    }
    
    
    //Find best familiar equipment:
    TFWMInternalModifier best_familiar_equipment;
    foreach key in weight_modifiers
    {
        TFWMInternalModifier modifier = weight_modifiers[key];
        if (modifier.have && modifier.from_familiar_equipment)
        {
            if (modifier.bonus > best_familiar_equipment.bonus)
                best_familiar_equipment = modifier;
        }
    }
    
    float total = 0.0;
    foreach key in weight_modifiers
    {
        TFWMInternalModifier modifier = weight_modifiers[key];
        string description = modifier.description;
        description += " (+" + modifier.bonus.floor() + ")";
        if (modifier.have)
        {
            if (best_familiar_equipment.have && modifier.from_familiar_equipment && !TFWMInternalModifierEquals(best_familiar_equipment, modifier)) //not our chosen familiar equipment
                continue;
            how.listAppend(description);
            total += modifier.bonus;
        }
        else if (modifier.obtainable_now)
        {
            immediately_obtainable.listAppend(description);
        }
        else if (modifier.obtainable_theoretically)
        {
            missing_potentials.listAppend(description);
        }
        
    }
    missing_weight.f = MAX(0, 19 - total);
    
    if (numeric_modifier("familiar weight") >= 19.0)
        return true;
    if (total >= 19.0)
        return true;
    else
        return false;
}


            
string generatePotatoSuggestion()
{
    if (familiar_is_usable($familiar[fancypants scarecrow]) && $item[swashbuckling pants].available_amount() > 0)
        return "Run swashbuckling pants on scarecrow. (2x potato)";
    else if (familiar_is_usable($familiar[fancypants scarecrow]) && $item[spangly mariachi pants].available_amount() > 0)
        return "Run spangly mariachi pants on scarecrow. (2x potato)";
    else if (familiar_is_usable($familiar[mad hatrack]) && $item[spangly sombrero].available_amount() > 0)
        return "Run spangly sombrero on mad hatrack. (2x potato)";
    else
        return "Run a potato familiar if you can.";
}


void QLevel13Init()
{
	//questL13Final
    
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questL13Final");
    if (my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_GREY_GOO) QuestStateParseMafiaQuestPropertyValue(state, "finished");
    if (my_path_id() == PATH_BUGBEAR_INVASION || __misc_state["in aftercore"] || (!state.in_progress && my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING) || my_path_id() == PATH_COMMUNITY_SERVICE) //FIXME mafia may track the ed L13 quest under this variable
        QuestStateParseMafiaQuestPropertyValue(state, "finished"); //never will start
	if (__misc_state["Example mode"])
        QuestStateParseMafiaQuestPropertyValue(state, "step6");
	state.quest_name = "Naughty Sorceress Quest";
	state.image_name = "naughty sorceress lair";
	state.council_quest = true;
	
    state.state_string["Stat race type"] = ""; //telescope1
    state.state_string["Elemental damage race type"] = ""; //telescope2
    
    //FIXME these all need checking:
    string [string] telescope1_messages_to_type;
    telescope1_messages_to_type["all wearing sunglasses and dancing"] = "moxie";
    telescope1_messages_to_type["standing around flexing their muscles and using grip exercisers"] = "muscle";
    telescope1_messages_to_type["sitting around playing chess and solving complicated-looking logic puzzles"] = "mysticality";
    
    string [string] telescope2_messages_to_type;
    telescope2_messages_to_type["greasy-looking people furtively skulking around"] = "sleaze";
    telescope2_messages_to_type["people, all of whom appear to be on fire"] = "hot"; //???
    telescope2_messages_to_type["people, clustered around a group of igloos"] = "cold";
    telescope2_messages_to_type["people, surrounded by a cloud of eldritch mist"] = "spooky"; //???
    telescope2_messages_to_type["people, surrounded by garbage and clouds of flies"] = "stench";
    
    string [string] telescope3_messages_to_type;
    string [string] telescope4_messages_to_type;
    string [string] telescope5_messages_to_type;
    
    telescope3_messages_to_type["creepy-looking black bushes on the outskirts of a hedge maze"] = "spooky";
    telescope3_messages_to_type["nasty-looking, dripping green bushes on the outskirts of a hedge maze"] = "stench"; //stench? sleaze?
    telescope3_messages_to_type["purplish, greasy-looking hedges"] = "sleaze"; //???
    telescope3_messages_to_type["smoldering bushes on the outskirts of a hedge maze"] = "hot"; //???
    telescope3_messages_to_type["frost-rimed bushes on the outskirts of a hedge maze"] = "cold";
    
    telescope4_messages_to_type["a greasy purple cloud hanging over the center of the maze"] = "sleaze";
    telescope4_messages_to_type["smoke rising from deeper within the maze"] = "hot"; //????
    telescope4_messages_to_type["a miasma of eldritch vapors rising from deeper within the maze"] = "spooky"; //????
    telescope4_messages_to_type["a cloud of green gas hovering over the maze"] = "stench"; //????
    telescope4_messages_to_type["wintry mists rising from deeper within the maze"] = "cold";
    
    telescope5_messages_to_type["occasionally disgorging a bunch of ice cubes"] = "cold";
    telescope5_messages_to_type["that occasionally vomits out a greasy ball of hair"] = "sleaze"; //???
    telescope5_messages_to_type["surrounded by creepy black mist"] = "spooky"; //???
    telescope5_messages_to_type["disgorging a really surprising amount of sewage"] = "stench"; //???
    telescope5_messages_to_type["with lava slowly oozing out of it"] = "hot"; //???
    
    state.state_string["Stat race type"] = get_property("nsChallenge1"); //telescope1_messages_to_type[get_property("telescope1")];
    if (state.state_string["Stat race type"] == "none")
        state.state_string["Stat race type"] = "";
    state.state_string["Elemental damage race type"] = get_property("nsChallenge2"); //telescope2_messages_to_type[get_property("telescope2")];
    if (state.state_string["Elemental damage race type"] == "none")
        state.state_string["Elemental damage race type"] = "";
    
    string [int] elements_needed = listMake(telescope3_messages_to_type[get_property("telescope3")], telescope4_messages_to_type[get_property("telescope4")], telescope5_messages_to_type[get_property("telescope5")]);
    
    boolean have_all_elements = true;
    foreach key, e in elements_needed
    {
        if (e.length() == 0)
        {
            have_all_elements = false;
            break;
        }
    }
    state.state_string["Hedge maze elements needed"] = "";
    if (have_all_elements)
        state.state_string["Hedge maze elements needed"] = elements_needed.listJoinComponents("|");
    
    state.state_boolean["past races"] = state.mafia_internal_step >= 4;
    
    state.state_boolean["Init race completed"] = get_property_int("nsContestants1") != -1;
    state.state_boolean["Stat race completed"] = get_property_int("nsContestants2") != -1;
    state.state_boolean["Elemental damage race completed"] = get_property_int("nsContestants3") != -1;
    if (state.finished || state.state_boolean["past races"])
    {
        state.state_boolean["Init race completed"] = true;
        state.state_boolean["Stat race completed"] = true;
        state.state_boolean["Elemental damage race completed"] = true;
    }
    
	state.state_boolean["past hedge maze"] = state.mafia_internal_step >= 6;
	state.state_boolean["past keys"] = state.mafia_internal_step >= 7;
    
    state.state_boolean["past tower level 1"] = state.mafia_internal_step >= 8;
    state.state_boolean["past tower level 2"] = state.mafia_internal_step >= 9;
    state.state_boolean["past tower level 3"] = state.mafia_internal_step >= 10;
    state.state_boolean["past tower level 4"] = state.mafia_internal_step >= 11;
    state.state_boolean["past tower level 5"] = state.mafia_internal_step >= 12;
    
	state.state_boolean["past tower monsters"] = state.state_boolean["past tower level 3"]; //5
	state.state_boolean["wall of skin will need to be defeated"] = !state.state_boolean["past tower level 1"];
	state.state_boolean["wall of meat will need to be defeated"] = !state.state_boolean["past tower level 2"];
	state.state_boolean["wall of bones will need to be defeated"] = !state.state_boolean["past tower level 3"];
	state.state_boolean["shadow will need to be defeated"] = !state.state_boolean["past tower level 5"];
    //FIXME what paths don't fight the shadow?
	state.state_boolean["king waiting to be freed"] = (state.mafia_internal_step >= 14 && !state.finished);
    
    
    boolean [string] known_key_names = $strings[Boris's key,Jarlsberg's key,Sneaky Pete's key,Richard's star key,skeleton key,digital key];
    
        
    if (my_path_id() == PATH_LOKI)
        known_key_names = $strings[clown car key,batting cage key,aqu&iacute;,knob labinet key,weremoose key,peg key,kekekey,rabbit's foot key,knob shaft skate key,ice key,anchovy can key,cactus key,f'c'le sh'c'le k'y,treasure chest key,demonic key,key sausage,knob treasury key,scrap metal key,black rose key,music box key,actual skeleton key,deep-fried key,discarded bike lock key,Boris's key,Jarlsberg's key,Sneaky Pete's key,Richard's star key,skeleton key,digital key];
    foreach key_name in known_key_names
    {
        state.state_boolean[key_name + " used"] = state.state_boolean["past keys"];
    }
    
    if (!state.state_boolean["past keys"])
    {
        //nsTowerDoorKeysUsed
        //nsTowerDoorKeysUsed(user, now 'Boris's key,Jarlsberg's key,Sneaky Pete's key,Richard's star key,digital key,skeleton key', default )
        
        string [int] keys_used = split_string_alternate(get_property("nsTowerDoorKeysUsed"), ",");
        
        foreach index, key_name in keys_used
        {
            //FIXME implement this
            //Boris's, Jarlsberg's, Sneaky Pete's, star, skeleton key, and digital
            if (!(known_key_names contains key_name))
            {
                continue;
            }
            state.state_boolean[key_name + " used"] = true;
        }
    }
    
    foreach key_name in known_key_names
    {
    	boolean need = true;
        if (state.state_boolean["past keys"])
        	need = false;
        else if (state.state_boolean[key_name + " used"])
        	need = false;
        else
        {
        	item it = key_name.to_item();
            if (it.have())
            	need = false;
        }
        
        state.state_boolean["need to find " + key_name] = need;
        state.state_boolean["need to find " + key_name.to_lower_case()] = need;
    }
    //to use:
    //__quest_state["Level 13"].state_boolean["need to find Boris's key", "need to find digital key", "need to find Jarlsberg's key", "need to find Richard's star key", "need to find skeleton key", "need to find Sneaky Pete's key"]
    //or that, lowercase
    //print_html("state.state_boolean = " + state.state_boolean.to_json());
    
    //Silent, Shell Up, Sauceshell
    
    boolean other_quests_completed = true;
    for i from 2 to 12
    {
        if (!__quest_state["Level " + i].finished)
        {
            other_quests_completed = false;
        }
    }
    if (other_quests_completed && (my_level() >= 13 || my_path_id() == PATH_EXPLOSIONS))
        state.startable = true;
	
	__quest_state["Level 13"] = state;
	__quest_state["Lair"] = state;
}


void QLevel13GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Level 13"].in_progress)
		return;
	QuestState base_quest_state = __quest_state["Level 13"];
	ChecklistSubentry subentry;
    ChecklistSubentry [int] subentries;
    subentries.listAppend(subentry);
	subentry.header = base_quest_state.quest_name;
    string url = "place.php?whichplace=nstower";
	
	string image_name = base_quest_state.image_name;
    
	boolean should_output_main_entry = true;
    if (!base_quest_state.state_boolean["past races"] && (base_quest_state.state_string["Stat race type"].length() == 0 || base_quest_state.state_string["Elemental damage race type"].length() == 0))
    {
        subentry.header = "Visit the registration desk";
        subentry.entries.listAppend("Find out what the races are, first.");
        image_name = "lair registration desk";
    }
    else if (base_quest_state.mafia_internal_step == 3)
    {
        image_name = "lair registration desk";
        subentry.header = "Visit the registration desk";
        subentry.entries.listAppend("Claim your prize!");
        url = "place.php?whichplace=nstower&action=ns_01_contestbooth";
    }
    else if (!base_quest_state.state_boolean["past races"])
    {
        image_name = "lair registration desk";
        remove subentries[0];
        
        if (!base_quest_state.state_boolean["Init race completed"])
        {
            string [int] description;
            float current_value = numeric_modifier("initiative");
            
            description.listAppend("Currently " + current_value.floor() + "%.");
            
            if (current_value < 400.0)
            {
                description.listAppend("Need " + (400.0 - current_value).roundForOutput(1) + "% more initiative for #2.");
                
                if (!($familiars[oily woim,Xiblaxian Holo-Companion] contains my_familiar()) && !__misc_state["familiars temporarily blocked"])
                {
                    familiar [int] init_familiar_evaluation_order;
                    init_familiar_evaluation_order.listAppend($familiar[Xiblaxian Holo-Companion]);
                    init_familiar_evaluation_order.listAppend($familiar[oily woim]);
                    foreach key, f in init_familiar_evaluation_order
                    {
                        if (f.familiar_is_usable())
                        {
                            description.listAppend("Try switching to your " + f + ".");
                            break;
                        }
                    }
                }
                if (__misc_state_int["pulls available"] > 0)
                {
                    boolean [item] blocklist;// = $items[hare brush,freddie's blessing of mercury,ruby on canes];
                    item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Initiative", 30, blocklist);
                    string [int] relevant_potions_output;
                    foreach key, it in relevant_potions
                    {
                    	float initiative_modifier = it.to_effect().numeric_modifier("Initiative");
                        if ($effect[Bow-Legged Swagger].have_effect() > 0)
                        	initiative_modifier *= 2.0;
                        relevant_potions_output.listAppend(it + " (" + initiative_modifier.roundForOutput(0) + "%)");
                    }
                    
                    if (relevant_potions_output.count() > 0)
                        description.listAppend("Could try pulling " + relevant_potions_output.listJoinComponents(", ", "or") + ".");
                }
            }
            else
                description.listAppend("Take the test now, you should(?) make second place.");
            
            subentries.listAppend(ChecklistSubentryMake("Compete in the init race", "+init", description));
        }
        if (!base_quest_state.state_boolean["Stat race completed"])
        {
            stat stat_type = base_quest_state.state_string["Stat race type"].to_stat();
            string [int] description;
            float current_value = my_buffedstat(stat_type);
            
            
            //FIXME find this value; current is a guess
            //highest seen #3 is 577 moxie
            if (current_value < 600.0)
            {
                description.listAppend("Need " + (600.0 - current_value).roundForOutput(1) + " more " + stat_type.to_lower_case() + " for #2.");
            }
            else
                description.listAppend("Take the test now, you should(?) make second place.");
                
            if (stat_type != $stat[none] && current_value < 600.0)
            {
                if (__misc_state_int["pulls available"] > 0)
                {
                    float base_stat = MAX(1.0, my_basestat(stat_type));
                    
                    //R&uuml;mpelstiltz,gummi snake,handful of laughing willow bark,dennis's blessing of minerva,smart watch,mer-kin smartjuice,lump of saccharine maple sap,burt's blessing of bacchus,augmented-reality shades,mer-kin cooljuice,lobos mints,mariachi toothpaste,disco horoscope (virgo),pressurized potion of pulchritude,pressurized potion of perspicacity,pressurized potion of puissance,handful of crotchety pine needles,bruno's blessing of mars,fitness wristband,gummi salamander,bottle of fire,banana smoothie,banana supersucker,ennui-flavored potato chips,moonds,ultrasoldier serum,kumquat supersucker,mer-kin strongjuice,
                    boolean [item] blocklist = $items[snake,M-242,sparkler]; //limited/expensive/unusable content
                    item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier(stat_type, MIN(600 - current_value, 25), blocklist);
                    item [int] relevant_potions_source_2 = ItemFilterGetPotionsCouldPullToAddToNumericModifier(stat_type + " percent", 25.0 / base_stat * 100.0, blocklist);
                    
                    relevant_potions.listAppendList(relevant_potions_source_2);
                    
                    sort relevant_potions by -(value.to_effect().numeric_modifier(stat_type) + (value.to_effect().numeric_modifier(stat_type + " percent") / 100.0 * my_basestat(stat_type)));
                    
                    
                    string [int] relevant_potions_output;
                    foreach key, it in relevant_potions
                    {
                        float total = (it.to_effect().numeric_modifier(stat_type) + (it.to_effect().numeric_modifier(stat_type + " percent") / 100.0 * my_basestat(stat_type)));
                        string line = it + " (" + total.roundForOutput(1) + ")";
                        //if (it.mall_price() >= 15000) //for internal use, to fill out the blocklist
                            //line = HTMLGenerateSpanFont(line, "red", "");
                        relevant_potions_output.listAppend(line);
                    }
                    
                    if (relevant_potions_output.count() > 0)
                        description.listAppend("Could try pulling " + relevant_potions_output.listJoinComponents(", ", "or") + ".");
                }
            }
            
            subentries.listAppend(ChecklistSubentryMake("Compete in the " + stat_type + " race", "+" + stat_type.to_string().to_lower_case(), description));
        }
        if (!base_quest_state.state_boolean["Elemental damage race completed"])
        {
            element element_type = base_quest_state.state_string["Elemental damage race type"].to_element();
            
            string [int] description;
            
            string element_class = "r_element_" + element_type;
            string element_class_desaturated = element_class + "_desaturated";
            
            float current_value = numeric_modifier(element_type + " damage") + numeric_modifier(element_type + " spell damage");
            if (current_value < 100.0)
            {
                description.listAppend("Need " + (100.0 - current_value).roundForOutput(1) + " more " + HTMLGenerateSpanOfClass(element_type + " damage ", element_class) + " + " + HTMLGenerateSpanOfClass(element_type + " spell damage", element_class) + " for #2.");
                
                
                if (__misc_state_int["pulls available"] > 0)
                {
                    boolean [item] blocklist = $items[witch's brew,boiling seal blood];
                    item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier(listMake(element_type + " damage", element_type + " spell damage"), 30, blocklist);
                    string [int] relevant_potions_output;
                    foreach key, it in relevant_potions
                    {
                        relevant_potions_output.listAppend(it + " (" + (it.to_effect().numeric_modifier(element_type + " damage") + it.to_effect().numeric_modifier(element_type + " spell damage")).roundForOutput(0) + ")");
                    }
                    
                    if (relevant_potions_output.count() > 0)
                        description.listAppend("Could try pulling " + relevant_potions_output.listJoinComponents(", ", "or") + ".");
                }
            }
            else
                description.listAppend("Take the test now, you should(?) make second place.");
            description.listAppend("Currently " + current_value.roundForOutput(1) + ".");
            
            subentries.listAppend(ChecklistSubentryMake("Compete in the " + HTMLGenerateSpanOfClass(element_type + " damage", element_class) + " race", listMake("+" + HTMLGenerateSpanOfClass(element_type + " damage", element_class_desaturated), "+" + HTMLGenerateSpanOfClass(element_type + " spell damage", element_class_desaturated)), description));
        }
        
        int total_contestants_to_fight = 0;
        foreach s in $strings[nsContestants1,nsContestants2,nsContestants3]
        {
            if (get_property_int(s) > 0)
                total_contestants_to_fight += get_property_int(s);
        }
        if (total_contestants_to_fight > 0)
        {
            subentries.listAppend(ChecklistSubentryMake("Fight " + pluraliseWordy(total_contestants_to_fight, "more contestant", "more contestants"), "", ""));
        }
        else if (subentries.count() == 0)
        {
            //hmm...
            subentries.listAppend(ChecklistSubentryMake("Visit the registration desk", "", "Claim your prize!"));
            url = "place.php?whichplace=nstower&action=ns_01_contestbooth";
        }
        else if (total_contestants_to_fight == 0)
            url = "place.php?whichplace=nstower&action=ns_01_contestbooth";
        //nsContestants1 - default -1
        //nsContestants2 - default -1
        //nsContestants3 - default -1
    }
    else if (base_quest_state.mafia_internal_step == 4)
    {
        subentry.header = "Attend your coronation";
        image_name = "__item Snow Queen Crown";
    }
    else if (!base_quest_state.state_boolean["past hedge maze"])
    {
        //FIXME individualised room support
        //need X more hot resistance, Y more Z resistance to pass elemental tests
        subentry.header = "Find your way through the Hedge Maze";
        image_name = "__item hedge maze puzzle";
        int current_room = get_property_int("currentHedgeMazeRoom");
        if (current_room >= 9)
        {
            subentry.entries.listAppend("Almost there...");
        }
        else
        {
            int [element] elements_needed_to_pass;
            string [int] resists_needed_for_hedge_maze = base_quest_state.state_string["Hedge maze elements needed"].split_string_alternate("\\|");
            float total_damage_taken_from_resists = 0.0;
            if (resists_needed_for_hedge_maze.count() > 0)
            {
                foreach key, element_name in resists_needed_for_hedge_maze
                {
                    element e = element_name.to_element();
                    if (e == $element[none]) //wha?
                        continue;
                    elements_needed_to_pass[e] = 7;
                    float percentage = 0.0;
                    if (key == 0) percentage = 0.9;
                    if (key == 1) percentage = 0.8;
                    if (key == 2) percentage = 0.7;
                    float resist = e.elemental_resistance() / 100.0;
                    float damage_taken = my_maxhp() * percentage * (1.0 - resist);
                    total_damage_taken_from_resists += damage_taken;  
                }
            }
            else
            {
            	total_damage_taken_from_resists = 10000;
                elements_needed_to_pass[$element[hot]] = 7;
                elements_needed_to_pass[$element[stench]] = 7;
                elements_needed_to_pass[$element[spooky]] = 7;
                elements_needed_to_pass[$element[cold]] = 7;
                elements_needed_to_pass[$element[sleaze]] = 7;
            }
            
            int [element] amount_missing;
            foreach e, amount_needed in elements_needed_to_pass
            {
                subentry.modifiers.listAppend("+" + HTMLGenerateSpanOfClass(amount_needed + " " + e + " resistance", "r_element_" + e + "_desaturated"));
                float amount_have = numeric_modifier(e + " resistance");
                if (amount_have < amount_needed)
                {
                    amount_missing[e] = amount_needed - amount_have;
                }
            }
            if (amount_missing.count() > 0 && total_damage_taken_from_resists >= my_maxhp())
            {
                if ($familiar[exotic parrot].familiar_is_usable() && !__misc_state["familiars temporarily blocked"])
                    subentry.entries.listAppend("Potentially switch to the exotic parrot.");
                
                string [int] amount_missing_string;
                foreach e, amount in amount_missing
                {
                    amount_missing_string.listAppend(HTMLGenerateSpanOfClass(amount + " more " + e + " resistance", "r_element_" + e));
                }
                subentry.entries.listAppend("Need " + amount_missing_string.listJoinComponents(", ", "and") + " to safely make it through the maze quickly.");
            }
            else
            {
                subentry.modifiers.listClear();
                subentry.entries.listAppend("Choose the second option each time to save the most turns.");
            }
            if (my_hp() < my_maxhp() && current_room <= 1)
            {
                //FIXME only output this if we won't make it.
                subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
            }
        }
            
        //elemental tests are 1, 4, 7
        //9 is escape
        //subentry.entries.listAppend("currentHedgeMazeRoom = " + get_property_int("currentHedgeMazeRoom"));
    }
    else if (!base_quest_state.state_boolean["past keys"])
    {
        url = "place.php?whichplace=nstower_door";
        subentry.header = "Open the tower door";
        
        string [int] keys_to_use;
        item [int] missing_keys;
        boolean [string] known_key_names = $strings[Boris's key,Jarlsberg's key,Sneaky Pete's key,Richard's star key,skeleton key,digital key];
        
        if (my_path_id() == PATH_LOKI)
        	known_key_names = $strings[clown car key,batting cage key,aqu&iacute;,knob labinet key,weremoose key,peg key,kekekey,rabbit's foot key,knob shaft skate key,ice key,anchovy can key,cactus key,f'c'le sh'c'le k'y,treasure chest key,demonic key,key sausage,knob treasury key,scrap metal key,black rose key,music box key,actual skeleton key,deep-fried key,discarded bike lock key,Boris's key,Jarlsberg's key,Sneaky Pete's key,Richard's star key,skeleton key,digital key];
        foreach key_name in known_key_names
        {
            if (!base_quest_state.state_boolean[key_name + " used"])
            {
                item key_item = key_name.to_item();
                string key_name_output = key_name.replace_string(" key", "");
                if (key_item.available_amount() == 0)
                {
                    key_name_output = HTMLGenerateSpanFont(key_name_output, "grey");
                    missing_keys.listAppend(key_item);
                }
                keys_to_use.listAppend(key_name_output);
            }
        }
        
        if (keys_to_use.count() == 0)
        {
            subentry.entries.listAppend("Open the doorknob.");
        }
        else if (missing_keys.count() > 0)
        {
            subentry.entries.listAppend("Find the " + missing_keys.listJoinComponents(", ", "and") + ".");
        }
        else
        {
            subentry.entries.listAppend("Use " + pluraliseWordy(keys_to_use.count(), "more key", "more keys") + " on the perplexing door: " + keys_to_use.listJoinComponents(", ", "and") + ".");
        }
    }
    else if (!base_quest_state.state_boolean["past tower level 1"])
    {
        //wall of skin
        subentry.header = "Defeat the Wall of Skin";
        if ($item[beehive].available_amount() > 0)
        {
            subentry.entries.listAppend("Use the beehive against it.");
        }
        else
        {
            subentry.entries.listAppend("Either find the beehive in the black forest (-combat), or towerkill.");
            subentry.entries.listAppend("Lots of passive damage sources.");
            if (my_path_id() == PATH_BIG)
            	subentry.entries.listAppend("Towerkilling is likely impractical in BIG?");
            //Originally I wanted this to properly calculate the exact amount of damage you can do against the wall of skin.
            //But, I feel like that would be super complicated and prone to error.
            //So, we'll just give suggestions and hope it works out.
            boolean have_prismatic_damage = true;
            string [int] prismatic_damage_needed;
            foreach e in $elements[hot,cold,sleaze,stench,spooky]
            {
            	if (numeric_modifier(e + " damage") > 0) continue;
                have_prismatic_damage = false;
                prismatic_damage_needed.listAppend(e);
            }
            string [int] methods;
            string [int] skills_to_cast;
            foreach s in $skills[spiky shell,Jalape&ntilde;o Saucesphere,The Psalm of Pointiness,Scarysauce]
            {
                if (s.to_effect().have_effect() > 0)
                    continue;
                if (!s.have_skill())
                    continue;
                if (!s.is_unrestricted())
                    continue;
                skills_to_cast.listAppend(s);
            }
            if (skills_to_cast.count() > 0)
            {
                methods.listAppend("Cast " + skills_to_cast.listJoinComponents(", ", "and") + ".");
            }
            if ($item[colorful toad].have() && $item[colorful toad].item_is_usable() && $item[colorful toad].to_effect().have_effect() == 0 && !have_prismatic_damage && my_path_id() != PATH_2CRS)	
                methods.listAppend("Use colorful toad for +prismatic damage.");
            familiar desired_familiar = $familiar[none];
            if ($familiar[mu].familiar_is_usable())
            {
            	methods.listAppend("Run extra +familiar weight for your mu; it will attack more often.");
            	desired_familiar = $familiar[mu];
            }
            else if ($familiar[Imitation Crab].familiar_is_usable())
                desired_familiar = $familiar[Imitation Crab];
            else if ($familiar[Sludgepuppy].familiar_is_usable())
                desired_familiar = $familiar[Sludgepuppy];
            else if ($familiar[mini-crimbot].familiar_is_usable())
            {
                desired_familiar = $familiar[mini-crimbot];
                //(crimbotArm - "STAL-1 UltraFist" or "Frostronic Hypercoil"/crimbotChassis - "Music Box Box"/crimbotPropulsion - "X-1 Hover Rocket")
                string [int] configure_options;
                if (get_property("crimbotChassis") == "")
                    configure_options.listAppend("Music Box Box");
                if (get_property("crimbotArm") == "")
                	configure_options.listAppend("STAL-1 UltraFist");
                if (get_property("crimbotPropulsion") == "")
                    configure_options.listAppend("X-1 Hover Rocket");
                if (configure_options.count() > 0)
	                methods.listAppend("Configure mini-crimbot for " + configure_options.listJoinComponents(" / ") + ".");
            }
            
            if (!__misc_state["familiars temporarily blocked"] && desired_familiar != $familiar[none] && my_familiar() != desired_familiar)
            {
            	methods.listAppend("Switch to familiar " + desired_familiar + ".");
            }
            item [int] items_to_equip;
            foreach it in $items[hand in glove,bottle opener belt buckle,buddy bjorn,smirking shrunken head,kremlin's greatest briefcase]
            {
            	if (!it.have()) continue;
                if (it.equipped()) continue;
            	items_to_equip.listAppend(it);
            }
            if (items_to_equip.count() > 0)
            {
            	methods.listAppend("Equip " + items_to_equip.listJoinComponents(", ", "and") + "?");
            }
            if ($item[buddy bjorn].equipped() && $familiar[misshapen animal skeleton].familiar_is_usable() && my_bjorned_familiar() != $familiar[misshapen animal skeleton])
            	methods.listAppend("Put misshapen animal skeleton in the buddy bjorn.");
            	
            if (!have_prismatic_damage)
            {
            	methods.listAppend("Gain prismatic damage. Need " + prismatic_damage_needed.listJoinComponents(", ", "and") + ".");
            }
            
            if (monster_level_adjustment() > 0)
                methods.listAppend("Reduce monster level.");
            	
            
            string [int] attack_methods;
            if ($skill[shieldbutt].skill_is_usable())
            	attack_methods.listAppend("shieldbutt if you can hit" + ($slot[off-hand].equipped_item().item_type() != "shield" ? " but equip a shield first" : ""));
            if ($skill[headbutt].skill_is_usable())
                attack_methods.listAppend("headbutt if you can hit" + ($slot[hat].equipped_item() == $item[none] ? " but equip a hat first" : ""));
            if ($skill[kneebutt].skill_is_usable())
                attack_methods.listAppend("kneebutt if you can hit" + ($slot[pants].equipped_item() == $item[none] ? " but equip some pants first (or don't, live free)" : ""));
            if ($skill[belch the rainbow].skill_is_usable())
                attack_methods.listAppend("belch the rainbow");
            if ($skill[clobber].skill_is_usable())
                attack_methods.listAppend("clobber");
            attack_methods.listAppend("regular attack(?)");
            if (attack_methods.count() > 0)
            {
                methods.listAppend("Attack using " + attack_methods.listJoinComponents(", ", "or") + ".");
            }
            string [int] shell_up_methods;
            foreach s in $skills[sauceshell,shell up]
            {
            	if (!s.skill_is_usable()) continue;
                shell_up_methods.listAppend(s);
            }
            if (shell_up_methods.count() > 0)
                methods.listAppend("After three rounds, cast " + shell_up_methods.listJoinComponents(" and then ") + ".");
            
            /*
            
                item best_shield = $item[none];
                foreach it in __items_shields
                {
                    if (it.to_slot() != $slot[off-hand]) continue;
                    if (it.item_type() != "shield") continue;
                    if (!it.can_equip()) continue;
                    if (it.available_amount() == 0) continue;
                    if (it.get_power() > best_shield.get_power() || best_shield == $item[none])
                        best_shield = it;
                }
            */
            if (methods.count() > 0)
            	subentry.entries.listAppend("Towerkilling ideas:|*" + methods.listJoinComponents("<hr>"));
            if (my_hp() < my_maxhp())
            {
                //FIXME only output this if we won't make it.
                subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
            }
        }
    }
    else if (!base_quest_state.state_boolean["past tower level 2"])
    {
        //wall of meat
        //current assumption is it's a [160, 240] drop, and you need to clear one thousand (thousand slimy) meats
        subentry.header = "Defeat the Wall of Meat";
        subentry.modifiers.listAppend("+526% meat");
        
        float current_value = numeric_modifier("meat drop");
        if (current_value < 526.0)
        {
            subentry.entries.listAppend("Need " + (526.0 - current_value).roundForOutput(0) + "% more meat drop to always complete in a single turn.");
            
            float meat_multiplier = 1.0 + current_value / 100.0;
            float chance = 1.0 - TriangularDistributionCalculateCDF(1001.0, 160.0 * meat_multiplier, 240.0 * meat_multiplier);
            if (chance > 0.0)
                subentry.entries.listAppend((chance * 100.0).floor() + "% chance of completing in one turn.");
        }
        else
            subentry.entries.listAppend("Should take one turn.");
        
        if (__misc_state_int["pulls available"] > 0 && current_value < 526.0)
        {
            float delta = 526.0 - current_value;
            boolean [item] blocklist = $items[uncle greenspan's bathroom finance guide,black snowcone,sorority brain,blue grass,salt wages,perl necklace];
            item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Meat Drop", MIN(25, delta), blocklist);
            string [int] relevant_potions_output;
            foreach key, it in relevant_potions
            {
                relevant_potions_output.listAppend(it + " (" + it.to_effect().numeric_modifier("meat drop").roundForOutput(0) + "%)");
            }
            
            if (relevant_potions_output.count() > 0)
                subentry.entries.listAppend("Could try pulling " + relevant_potions_output.listJoinComponents(", ", "or") + ".");
        }
        //FIXME does mafia have a tracking variable for meat dropped?
        //FIXME REST
        //estimated turns?
        if (my_hp() < my_maxhp())
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
        }
    }
    else if (!base_quest_state.state_boolean["past tower level 3"])
    {
        subentry.header = "Defeat the Wall of Bones";
        //wall of bones
        if ($item[electric boning knife].available_amount() > 0)
        {
            subentry.entries.listAppend("Use the electric boning knife against it.");
        }
        else
        {
            //suggest towerkilling methods
            //removing passive damage sources
            //support saucegeyser, intimidating mien, grease up, and future airport skills (or lack thereof)
            //strategy: saucegeyser three times, then either saucegeyser One More Time or unleash grease up/intimidating mien/future airport skills
            //FIXME REST
            subentry.entries.listAppend("Either find the electric boning knife on the ground floor of the castle in the clouds in the sky (-combat), or towerkill:");
            subentry.entries.listAppend("Make sure to remove all sources of passive damage.");
            
            string [int] passives_to_remove = PDSGenerateDescriptionToUneffectPassives();
            if (passives_to_remove.count() > 0)
                subentry.entries.listAppend(HTMLGenerateSpanFont(passives_to_remove.listJoinComponents("|"), "red"));
            //FIXME HACK USE A LIBRARY
            /*string [int] things_to_do;
            foreach it in $items[hand in glove,MagiMechTech NanoMechaMech,bottle opener belt buckle,old school calculator watch,ant hoe,ant pick,ant pitchfork,ant rake,ant sickle,fishy wand,moveable feast,oversized fish scaler,plastic pumpkin bucket,tiny bowler,cup of infinite pencils,double-ice box,smirking shrunken head,mr. haggis,stapler bear,dubious loincloth,muddy skirt,bottle of Goldschn&ouml;ckered,acid-squirting flower,ironic oversized sunglasses,hippy protest button,cannonball charrrm bracelet,groovy prism necklace,spiky turtle shoulderpads,double-ice cap,parasitic headgnawer,eelskin hat,balloon shield,hot plate,Ol' Scratch's stove door,Oscus's garbage can lid,eelskin shield,eelskin pants,buddy bjorn]
            {
                if (it.equipped_amount() > 0)
                    things_to_do.listAppend("unequip " + it);
            }
            foreach e in $effects[Skeletal Warrior,Skeletal Cleric,Skeletal Wizard,Bone Homie,Burning\, Man,Biologically Shocked,EVISCERATE!,Fangs and Pangs,Permanent Halloween,Curse of the Black Pearl Onion,Long Live GORF,Apoplectic with Rage,Dizzy with Rage,Quivering with Rage,Jaba&ntilde;ero Saucesphere,Psalm of Pointiness,Drenched With Filth,Stuck-Up Hair,It's Electric!,Smokin',Jalape&ntilde;o Saucesphere,Scarysauce,spiky shell]
            {
                if (e.have_effect() > 0)
                    things_to_do.listAppend("uneffect " + e);
            }
            if (things_to_do.count() > 0)
                subentry.entries.listAppend(HTMLGenerateSpanFont(things_to_do.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".", "red"));*/
            
            //FIXME Firegate - spade, etc
            
            //Firegate is 100% myst, +30-40 damage, but unaffected by spell damage % (and possibly spell damage?)
            //Garbage nova is 40% myst, etc, but affected by spell damage %/spell damage.
            //So, we have to calculate which one is better and suggest that. (garbage nova may be better, in fact)
            if ($skill[Garbage Nova].skill_is_usable())
            {
                //Special note on calculations:
                //Spell damage percent is multiplied before the group size multiplier, then floored.
                //I believe this means against a size 100 monster, garbage nova will always deal damage in multiples of 50
                //It also means estimation can be wildly off without taking that into account.
                //Also, stench spell damage counts double, maybe?
                float buffed_myst = my_buffedstat($stat[mysticality]);
                float spell_damage = numeric_modifier("spell damage");
                float stench_spell_damage = numeric_modifier("stench spell damage");
                float spell_damage_percent = numeric_modifier("spell damage percent");
                float monster_level = monster_level_adjustment_ignoring_plants();
                float spell_damage_multiplier = 1.0 + spell_damage_percent / 100.0;
                float monster_damage_multiplier = 1.0 - min(50.0, monster_level * 0.4) / 100.0;
                
                //Estimate: 62894
                //Actual: 63263
                
                //Current damage formulas:
                //min = floor((45.0 + floor(0.4 * buffed_myst) + spell_damage + stench_spell_damage * 2.0) * (1.0 + spell_damage_percent / 100.0)) * ceil(group_size * 0.5)
                //max = floor((50.0 + floor(0.4 * buffed_myst) + spell_damage + stench_spell_damage * 2.0) * (1.0 + spell_damage_percent / 100.0)) * ceil(group_size * 0.5)
                //group_size = 100
                //then apply damage resistance: damage_out = floor(damage_in * (1.0 - min(50.0, ml * 0.4)) / 100.0));
                //damage must be >= 5k
                
                string [int] tasks;
                
                int min_myst_needed = 1000;
                //5000 = floor(floor((45.0 + floor(0.4 * buffed_myst) + spell_damage + stench_spell_damage * 2.0) * spell_damage_multiplier) * 50.0 * monster_damage_multiplier)
                //approximation:
                //buffed_myst = 2.5 * (5000 / monster_damage_multiplier / 50.0 / spell_damage_multiplier - spell_damage - stench_spell_damage * 2.0 - 45.0)
                //hmm... 138 to 388 myst without anything else? yes
                //though -100 myst with 50 stench spell damage is also enough
                
                float divisor = monster_damage_multiplier * 50.0 * spell_damage_multiplier;
                if (divisor == 0.0)
                    divisor = 0.001;
                min_myst_needed = ceil(2.5 * (5000 / divisor - spell_damage - stench_spell_damage * 2.0 - 45.0));
                
                int per_round_damage = floor(floor((45.0 + floor(0.4 * buffed_myst) + spell_damage + stench_spell_damage * 2.0) * spell_damage_multiplier) * 50.0 * monster_damage_multiplier);
                
                
                int casts_needed = 4;
                if (per_round_damage != 0)
                    casts_needed = clampi(ceil(20000.0 / to_float(per_round_damage)), 1, 4);
                
                if (my_buffedstat($stat[mysticality]) < min_myst_needed)
                {
                    tasks.listAppend(HTMLGenerateSpanFont("buff up to " + min_myst_needed + " mysticality", "red"));
                    if (monster_level > 0)
                        tasks.listAppend("possibly reduce ML");
                }
                tasks.listAppend("cast garbage nova " + pluraliseWordy(casts_needed, "time", "times"));
                
                if (tasks.count() > 0)
                    subentry.entries.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
                
                subentry.entries.listAppend(per_round_damage + " damage/round.");
            }
            else if ($skill[saucegeyser].skill_is_usable())
            {
                boolean need_modifier_output = true;
                if (my_familiar() != $familiar[magic dragonfish] && $familiar[magic dragonfish].familiar_is_usable() && !__misc_state["familiars temporarily blocked"])
                    subentry.entries.listAppend("Potentially switch to the magic dragonfish.");
                if ($item[meteorb].have() && !$item[meteorb].equipped())
                	subentry.entries.listAppend("Potentially equip meteorb.");
                //Calculate saucegeyser damage:
                float expected_saucegeyser_damage = skillExpectedDamageRangeAlternate($monster[wall of bones], $skill[saucegeyser]).x;
                if ($item[meteorb].equipped())
                	expected_saucegeyser_damage *= 2.0;
                    
                subentry.entries.listAppend("Expected saucegeyser minimum damage: " + expected_saucegeyser_damage.roundForOutput(0));
                if (expected_saucegeyser_damage >= 5000.0)
                {
                    subentry.entries.listAppend("Cast saucegeyser four times.");
                    need_modifier_output = false;
                }
                else
                {
                    float hp_remaining = 20000.0 - expected_saucegeyser_damage * 3.0;
                    
                    float [skill] airport_skill_per_turn_damage_multiplier;
                    float [skill] airport_skill_base_damage;
                    
                    airport_skill_per_turn_damage_multiplier[$skill[grease up]] = 5.0;
                    airport_skill_base_damage[$skill[grease up]] = 30.0;
                    
                    airport_skill_per_turn_damage_multiplier[$skill[Intimidating Mien]] = 2.0;
                    airport_skill_base_damage[$skill[Intimidating Mien]] = 15.0;
                    
                    string [skill] airport_skill_name_of_combat_skill;
                    
                    airport_skill_name_of_combat_skill[$skill[grease up]] = "Unleash the Greash";
                    airport_skill_name_of_combat_skill[$skill[Intimidating Mien]] = "Thousand-Yard Stare";
                    
                    
                    float ml_damage_multiplier = MLDamageMultiplier();
                    if (ml_damage_multiplier != 1.0)
                    {
                        //FIXME this is correct... right? hmm...
                        foreach s in airport_skill_base_damage
                        {
                            airport_skill_base_damage[s] *= ml_damage_multiplier;
                            airport_skill_per_turn_damage_multiplier[s] *= ml_damage_multiplier;
                        }
                    }
                    
                    skill chosen_skill = $skill[none];
                    int chosen_skill_total_mp_cost = 0;
                    int chosen_skill_turns_left_to_cast = 0;
                    foreach s in airport_skill_base_damage
                    {
                        if (!s.skill_is_usable())
                            continue;
                        float base_damage = airport_skill_base_damage[s];
                        float variable_damage = airport_skill_per_turn_damage_multiplier[s];
                        effect skill_effect = s.to_effect();
                        
                        if (variable_damage == 0.0)
                            continue;
                        int total_turns_needed_of_effect = ceil((hp_remaining - base_damage) / variable_damage);
                        int turns_to_cast = MAX(0, total_turns_needed_of_effect - skill_effect.have_effect());
                        
                        int mp_cost = MAX(0, s.mp_cost() * turns_to_cast / MAX(1.0, s.turns_per_cast().to_float()));
                        
                        if (chosen_skill == $skill[none] || chosen_skill_total_mp_cost > mp_cost)
                        {
                            chosen_skill = s;
                            chosen_skill_total_mp_cost = mp_cost;
                            chosen_skill_turns_left_to_cast = turns_to_cast;
                        }
                    }
                    if (chosen_skill != $skill[none])
                    {
                        if (chosen_skill_turns_left_to_cast > 0)
                        {
                            string expected_meat_cost = ceil(chosen_skill_total_mp_cost * __misc_state_float["meat per MP"]);
                            
                            //string line = "Acquire " + chosen_skill_turns_left_to_cast + " more turns of " + chosen_skill + ".|Expected meat cost: ";
                            string line = "Cast " + chosen_skill + " ";
                            int cast_amount = ceil(chosen_skill_turns_left_to_cast.to_float() / MAX(1.0, chosen_skill.turns_per_cast().to_float()));
                            
                            if (cast_amount == 1)
                                line += "One More Time.";
                            else
                                line += cast_amount + " more times.";
                            
                            line += "|Expected meat cost: ";
                            
                            if (expected_meat_cost > my_meat())
                                line += HTMLGenerateSpanFont(expected_meat_cost, "red");
                            else
                                line += expected_meat_cost;
                            subentry.modifiers.listAppend("-mana cost");
                            subentry.entries.listAppend(line);
                        }
                        else
                        {
                            subentry.entries.listAppend("Cast saucegeyser three times, then cast " + airport_skill_name_of_combat_skill[chosen_skill] + ".");
                            need_modifier_output = false;
                        }
                    }
                    else if ($item[hand turkey outline].is_unrestricted()) //FIXME test if we have an airport skill
                    {
                        subentry.entries.listAppend("Cast saucegeyser three times, then an airport skill? (perm garbage nova)");
                    }
                }
                if (my_hp() < my_maxhp())
                {
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
                }
                if (my_mp() < $skill[saucegeyser].mp_cost() * 4.0)
                    subentry.entries.listAppend(HTMLGenerateSpanFont("Restore some MP first.", "red"));
                if (need_modifier_output)
                {
                    subentry.modifiers.listAppend("mysticality");
                    subentry.modifiers.listAppend("spell damage");
                    subentry.modifiers.listAppend("spell damage percent");
                    if (monster_level_adjustment() > 0)
                        subentry.modifiers.listAppend("-ML");
                }
            }
            if ($skill[splattersmash].skill_is_usable() && my_id() == 1557284)
            {
            	//(30-40 damage + (muscle - monster defence)) * 100 / 4
                //Two jam band bootlegs make that 1000 defence 250. If you have funksling, that's 487 buffed muscle needed.
                //
                int combat_items_per_round = 1;
                if ($skill[Ambidextrous Funkslinging].skill_is_usable())
                	combat_items_per_round = 2;
                int jam_band_bootlegs_left = $item[jam band bootleg].item_amount();
                
                int [item] items_thrown_operating;
                int monster_base_defence = $monster[wall of bones].base_defense;
                
                int [int][item] items_throw_after_round;
                int [int] monster_defence_after_round;
                monster_defence_after_round[0] = monster_base_defence; 
                int operating_defence = monster_base_defence;
                for round from 1 to 3
                {
                    float v = operating_defence;
                    if (jam_band_bootlegs_left > 0)
                    {
                    	v *= 0.5;
                     	jam_band_bootlegs_left -= 1;
                        items_thrown_operating[$item[jam band bootleg]] += 1;
                        if (combat_items_per_round > 1 && jam_band_bootlegs_left > 0)
                        {
                			v *= 0.5;
                            jam_band_bootlegs_left -= 1;
                            items_thrown_operating[$item[jam band bootleg]] += 1;
                        }
                    }
                    monster_defence_after_round[round] = v;
                    items_throw_after_round[round] = items_thrown_operating.listCopy();
                    operating_defence = v;
                }
                float ml_damage_multiplier = MLDamageMultiplier();
                boolean found_one = false;
                for round from 1 to 4
                {
                	int bones_defence = monster_defence_after_round[round - 1];
                    if (!(monster_defence_after_round contains (round - 1)))
                    	bones_defence = operating_defence;
                    int [item] items_thrown = items_throw_after_round[round - 1];
                    float splattersmash_damage = 30 + MAX(0, my_buffedstat($stat[muscle]) - bones_defence) * 100 * 0.25;
                    splattersmash_damage *= ml_damage_multiplier;
                    int total_damage_done = -1;
                    int times = 1;
                    if (round == 1)
                    	times = 4;
                    else if (round == 2)
                    	times = 3;
                    else if (round == 3)
                        times = 2;
                    else if (round == 4)
                        times = 1;
                    total_damage_done = splattersmash_damage * times;
                    if (total_damage_done >= $monster[wall of bones].base_hp)
                    {
                    	string [int] tasks;
                        if (items_thrown.count() > 0)
                        {
                        	string [int] throwing_items;
                            foreach it, amount in items_thrown
                            	throwing_items.listAppend(pluralise(amount, it));
                        	tasks.listAppend("throw " + throwing_items.listJoinComponents(", ", "and"));
                        }
                        tasks.listAppend("cast splattersmash " + times + " times for " + total_damage_done + " total damage");
                    	subentry.entries.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
                        found_one = true;
                    }
                    if (found_one)
                    	break;
                    //subentry.entries.listAppend("Total splattersmash damage at round " + round + " would be " + total_damage_done + " for " + splattersmash_damage + " damage/round" + ", " + items_thrown.to_json()); 
                }
                if (!found_one)
                {
                    subentry.entries.listAppend("Run +muscle to use splattersmash?");
                }
            }
        }
    }
    else if (!base_quest_state.state_boolean["past tower level 4"])
    {
        //stare into the looking glass, or break it
        subentry.header = "Face the looking glass";
        if (my_path_id() == PATH_VAMPIRE)
        {
            subentry.entries.listAppend("Gaze upon... nothing.");
        }
        else
        {
            subentry.entries.listAppend("Two options here.");
            subentry.entries.listAppend("Gazing upon the looking glass will cost a turn, but makes the naughty sorceress much easier.");
            subentry.entries.listAppend("Breaking the mirror will save a turn, but makes the NS fight much more difficult.");
        }
    }
    else if (!base_quest_state.state_boolean["past tower level 5"] && my_path_id() == PATH_VAMPIRE)
    {
        subentry.header = "Fight the mirror";
        subentry.entries.listAppend("It has, like, 3000 HP. You can handle it, right?");
    }
    else if (!base_quest_state.state_boolean["past tower level 5"])
    {
		//at top of tower (fight shadow??)
		//8 -> fight shadow
        int total_initiative_needed = $monster[Your Shadow].monster_initiative();
		subentry.modifiers.listAppend("+HP");
		subentry.modifiers.listAppend("+" + total_initiative_needed + "% init");
		subentry.header = "Fight your shadow";
        foreach it in $items[attorney's badge, navel ring of navel gazing]
        {
            if (it.available_amount() > 0 && it.equipped_amount() == 0)
                subentry.entries.listAppend("Possibly equip your " + it + ". (blocks shadow)");
        }
        
        string [int] healing_items_available;
        foreach it in $items[filthy poultice,gauze garter,red pixel potion,Dreadsylvanian seed pod,soggy used band-aid,Mer-kin healscroll,scented massage oil,extra-strength red potion,red potion,sew-on bandage]
        {
            if (it.item_amount() == 0)
                continue;
            if (!it.item_is_usable()) continue;
            if (it.item_amount() == 1)
                healing_items_available.listAppend(it.to_string());
            else
                healing_items_available.listAppend(it.pluralise());
        }
        if (healing_items_available.count() > 0)
            subentry.entries.listAppend("Healing items available: " + healing_items_available.listJoinComponents(", ", "and") + ".");
        else
            subentry.entries.listAppend("May want to go find some healing items.");
            
            
        int initiative_needed = total_initiative_needed - initiative_modifier();
        if (initiative_needed > 0 && !$skill[Ambidextrous Funkslinging].skill_is_usable())
            subentry.entries.listAppend("Need " + initiative_needed + "% more initiative.");
        if (my_hp() < my_maxhp())
        {
            //FIXME only output this if we won't make it.
            subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
        }
	}
    else if (!base_quest_state.state_boolean["king waiting to be freed"])
	{
		//At NS. Good luck, we're all counting on you.
        if (my_path_id() != PATH_HEAVY_RAINS)
        {
            subentry.modifiers.listAppend("+moxie, DA equipment");
            subentry.modifiers.listAppend("no buffs");
            if (!__misc_state["familiars temporarily blocked"])
                subentry.modifiers.listAppend("attack familiar");
        }
		image_name = "naughty sorceress";
		subentry.header = "She awaits";
        if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        {
            subentry.header = "You await";
            image_name = "Disco Bandit";
        }
        if (my_path_id() == PATH_LICENSE_TO_ADVENTURE)
        {
            subentry.header = "\"Blofeld\" awaits";
            image_name = "__monster \"Blofeld\"";
        }
        //don't think blocking works anymore? not sure
        /*if (!__misc_state["familiars temporarily blocked"] && my_path_id() != PATH_HEAVY_RAINS)
        {
            string potato_suggestion = generatePotatoSuggestion();
            
            subentry.entries.listAppend(potato_suggestion);
        }*/
        
        if ($item[The Lot's engagement ring].equipped_amount() > 0)
        {
            subentry.entries.listAppend("You and her? Good luck!");
        }
        
        /*if ($item[The Lot's engagement ring].available_amount() > 0 && $item[The Lot's engagement ring].equipped_amount() == 0)
        {
            subentry.entries.listAppend("Potentially equip the lot's engagement ring for an alternate ending.|<small>(sigh... if only)<small>");
        }*/
        
        if (my_path_id() == PATH_HEAVY_RAINS)
        {
            subentry.modifiers.listAppend("many buffs");
            if ($familiar[warbear drone].have_familiar())
                subentry.entries.listAppend("Run a warbear drone if you can.");
                
            subentry.entries.listAppend("Try to run as many buffs as you can. (one removed per round, have " + my_effects().count() + ")");
            subentry.entries.listAppend("Try to have as many damage sources as possible. (40? damage cap per source)");
            subentry.entries.listAppend("Only your weapon, offhand, and familiar equipment(?) are relevant this fight.");
            if ($item[crayon shavings].available_amount() > 0)
                subentry.entries.listAppend("Try repeatedly using crayon shavings?");
            if ($skill[frigidalmatian].skill_is_usable() && my_maxmp() >= 300 && $effect[Frigidalmatian].have_effect() == 0)
                subentry.entries.listAppend("Try casting Frigidalmatian.");
        }
        if (my_hp() < my_maxhp() && !get_property("lastEncounter").contains_text("The Naughty Sorceress") && __last_adventure_location != $location[The Naughty Sorceress' Chamber] && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Restore your HP first.", "red"));
        }
        
	}
	else if (base_quest_state.state_boolean["king waiting to be freed"])
	{
		//King is waiting in his prism.
        
        boolean trophies_are_possible = false;
        
        //ehh, disable displaying this, mostly because it's in the way
        //if (in_hardcore())
            //trophies_are_possible = true; //Gourdcore, Golden Meat Stack
        
        if (trophies_are_possible)
            task_entries.listAppend(ChecklistEntryMake(14, "__item puzzling trophy", "trophy.php", ChecklistSubentryMake("Check for trophies", "10k meat, trophy requirements", "Certain trophies are missable after freeing the king")));
		should_output_main_entry = false;
        
        
        if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE)
        {
            if (availableDrunkenness() > 0)
            {
                task_entries.listAppend(ChecklistEntryMake(15, "__item gibson", "inventory.php?which=1", ChecklistSubentryMake("Drink " + availableDrunkenness() + " drunkenness", "", "Freeing the king reduces your liver capacity.")));
            }
        }
        
        if (my_path_id() == PATH_HEAVY_RAINS)
        {
            if ($skill[rain dance].skill_is_usable() && my_rain() >= 10)
            {
                int times = floor(my_rain().to_float() / 10.0);
                task_entries.listAppend(ChecklistEntryMake(16, "__effect Rain Dancin'", "skills.php", ChecklistSubentryMake("Cast Rain Dance " + pluraliseWordy(times, "time", "times"), "", "+20% item buff for aftercore.")));
            }
        }
        
        if ($item[Yearbook Club Camera].available_amount() > 0 && $item[Yearbook Club Camera].equipped_amount() == 0)
        {
            task_entries.listAppend(ChecklistEntryMake(17, "__item yearbook club camera", 
                generateEquipmentLink($item[yearbook club camera]), ChecklistSubentryMake("Equip the yearbook club camera", "", "Before prism break. Otherwise, it'll disappear.")));
        }
		
	}
    //I need to delete this code, but I love it so much. Look at all that towerkilling suggestions! sob
	/*else if (base_quest_state.mafia_internal_step > 4 && base_quest_state.mafia_internal_step < 11)
	{
        //step4 through step9 - 5 - 10
		//at tower, time to kill monsters!
        
        
        int level = -1;
        
        if (base_quest_state.mafia_internal_step == 5)
            level = 1;
        else if (base_quest_state.mafia_internal_step == 6)
            level = 2;
        else if (base_quest_state.mafia_internal_step == 7)
            level = 3;
        else if (base_quest_state.mafia_internal_step == 8)
            level = 4;
        else if (base_quest_state.mafia_internal_step == 9)
            level = 5;
        else if (base_quest_state.mafia_internal_step == 10)
            level = 6;
        
        boolean output_tower_killing_ideas = false;
        item monster_item = __misc_state_string["Tower monster item " + level].to_item();
        
        subentry.entries.listAppend("Tower monster on floor " + level + ".");
        if (monster_item != $item[none])
        {
            if (monster_item.available_amount() > 0)
                subentry.entries.listAppend("Use " + HTMLGenerateSpanOfClass(monster_item, "r_bold") + ".");
            else
            {
                subentry.entries.listAppend(HTMLGenerateSpanFont("Need " + HTMLGenerateSpanOfClass(monster_item, "r_bold") + ".", "red"));
                output_tower_killing_ideas = true;
            }
        }
        else
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Need unknown item.", "red"));
            output_tower_killing_ideas = true;
        }
        
        if (output_tower_killing_ideas)
        {
            string [int] tower_killing_ideas;
            
            if (my_path_id() == PATH_HEAVY_RAINS && $skill[thunder bird].skill_is_usable() && my_thunder() >= 5 && $skill[curse of weaksauce].skill_is_usable())
            {
                string [int] line;
                if ($skill[itchy curse finger].skill_is_usable())
                {
                    line.listAppend("cast curse of weaksauce");
                    line.listAppend("cast a stun");
                }
                else
                {
                    line.listAppend("cast a stun");
                    line.listAppend("cast curse of weaksauce");
                }
                line.listAppend("cast thunder bird/stun/staggers repeatedly under defense is below zero");
                line.listAppend("attack");
                tower_killing_ideas.listAppend(line.listJoinComponents(", ", "then").capitaliseFirstLetter());
            }
            else if ($skill[curse of weaksauce].skill_is_usable() && $item[crayon shavings].available_amount() >= 2) //currently disabled because while it'll work in theory, I haven't tested it
            {
                string [int] line;
                if ($skill[itchy curse finger].skill_is_usable())
                {
                    line.listAppend("cast curse of weaksauce");
                    line.listAppend("cast a stun");
                }
                else
                {
                    line.listAppend("cast a stun");
                    line.listAppend("cast curse of weaksauce");
                }
                line.listAppend("throw two crayon shavings");
                line.listAppend("stagger/stun until defense is below zero");
                
                line.listAppend("attack");
                tower_killing_ideas.listAppend(line.listJoinComponents(", ", "then").capitaliseFirstLetter());
            }
            
            //Familiar sources:
            if (!__misc_state["familiars temporarily blocked"])
            {
                string potato_suggestion = generatePotatoSuggestion();
                tower_killing_ideas.listAppend(potato_suggestion);
                
                
                //Bjorn:
                if ($familiar[mariachi chihuahua].have_familiar())
                {
                    if ($item[buddy bjorn].available_amount() > 0)
                    {
                        if (my_bjorned_familiar() != $familiar[mariachi chihuahua])
                            tower_killing_ideas.listAppend("Put your mariachi chihuahua in your buddy bjorn. (50% stagger)");
                    }
                    else if ($item[crown of thrones].available_amount() > 0)
                    {
                        if (my_enthroned_familiar() != $familiar[mariachi chihuahua])
                            tower_killing_ideas.listAppend("Put your mariachi chihuahua in your crown of thrones. (50% stagger)");
                    }
                }
            }
            
            if ($item[attorney's badge].available_amount() > 0 && $item[attorney's badge].equipped_amount() == 0)
                tower_killing_ideas.listAppend("Could equip attorney's badge for more blocking.");
            if ($item[navel ring of navel gazing].available_amount() > 0 && $item[navel ring of navel gazing].equipped_amount() == 0)
                tower_killing_ideas.listAppend("Could equip navel ring of navel gazing for more blocking.");
                
                
            
            string [int] stun_sources;
            string [int] stagger_sources;
            
            
            //Stun/stagger sources:
            //(this is not a comprehensive list)
            //shadow noodles, thunderstrike, soul bubble
            //potato, bjorned chihuahua, attorney's badge, navel ring
            
            //ply reality, entangling noodles as not-pastamancer, pantsgiving 2x, deft hands, DNA...?, 3x disco dances...
            //airblaster gun
            //club foot IF seal clubber
            //Break It On Down
            //gob of wet hair, gyroscope, macrame net, ornate picture frame, palm-frond net(?), Rain-Doh indigo cup, superamplified boom box, Throw Shield (OPS), tongue depressor
            
            //gas balloon, brick of sand(?), chloroform rag, naughty paper shuriken, sausage bomb, floorboard cruft
            //dumb mud will insta if available
            //finger cuffs (support acquiring)
            //Rain-Doh blue balls
            //CSA obedience grenade, The Lost Comb
            //Accordion Bash if AT wearing an accordion FIXME do that
            //Shell Up(?)
            //sooooooul finger? does it work? 40 saucery...
            
            if ($item[Game Grid ticket].item_amount() > 0 && $item[Game Grid ticket].is_unrestricted())
                tower_killing_ideas.listAppend("Could acquire " + $item[Game Grid ticket].item_amount() + " finger cuffs. (stun)");
            if ($skill[shadow noodles].skill_is_usable())
                stun_sources.listAppend("shadow noodles");
            if ($skill[thunderstrike].skill_is_usable())
                stun_sources.listAppend("thunderstrike");
            if ($skill[soul saucery].skill_is_usable() && my_class() == $class[sauceror])
                stun_sources.listAppend("soul bubble");
                
            foreach it in $items[gas balloon,brick of sand,chloroform rag,sausage bomb,floorboard cruft,finger cuffs,CSA obedience grenade,The Lost Comb]
            {
                if (it.item_amount() == 0 || !it.is_unrestricted())
                    continue;
                stun_sources.listAppend(it.pluraliseWordy());
            }
            if ($item[naughty paper shuriken].available_amount() > 0)
                stun_sources.listAppend("naughty paper shuriken");
            if ($item[Rain-Doh blue balls].available_amount() > 0)
                stun_sources.listAppend("Rain-Doh blue balls");
                
            if ($skill[shell up].skill_is_usable() && ($effect[Blessing of the Storm Tortoise].have_effect() > 0 || $effect[Grand Blessing of the Storm Tortoise].have_effect() > 0 || $effect[Glorious Blessing of the Storm Tortoise].have_effect() > 0))
                stun_sources.listAppend("Shell Up");
            if ($skill[Accordion Bash].skill_is_usable())
            {
                string line = "Accordion Bash";
                if ($slot[weapon].equipped_item().item_type() != "accordion")
                    line = HTMLGenerateSpanFont(line + " (equip accordion)", "gray");
                stun_sources.listAppend(line);
            }
            
            if ($item[thor's pliers].equipped_amount() > 0)
                stagger_sources.listAppend("ply reality");
            if (my_class() != $class[pastamancer] && $skill[entangling noodles].skill_is_usable())
                stagger_sources.listAppend("entangling noodles");
            if ($item[pantsgiving].equipped_amount() > 0)
            {
                stagger_sources.listAppend("pocket crumbs");
                stagger_sources.listAppend("air dirty laundry");
            }
            if (my_class() == $class[disco bandit] && $skill[deft hands].skill_is_usable())
                stagger_sources.listAppend("first combat item thrown");
            if (my_class() == $class[disco bandit] && $skill[Disco State of Mind].skill_is_usable() && $skill[Flashy Dancer].skill_is_usable())
            {
                if ($skill[disco dance of doom].skill_is_usable())
                    stagger_sources.listAppend("disco dance");
                if ($skill[Disco Dance II: Electric Boogaloo].skill_is_usable())
                    stagger_sources.listAppend("disco dance II");
                if ($skill[Disco Dance 3: Back in the Habit].skill_is_usable())
                    stagger_sources.listAppend("disco dance 3");
            }
            if ($item[airblaster gun].equipped_amount() > 0)
                stagger_sources.listAppend("air blast");
            if (my_class() == $class[seal clubber] && $skill[club foot].skill_is_usable())
            {
                int stun_rounds = 0;
                
                stun_rounds = MIN(3, my_fury());
                if ($slot[weapon].equipped_item().item_type() == "club")
                    stun_rounds += 1;
                
                if (stun_rounds == 1)
                    stagger_sources.listAppend("club foot");
                else if (stun_rounds > 1)
                    stun_sources.listAppend("club foot");
            }
            if ($skill[Break It On Down].skill_is_usable())
                stagger_sources.listAppend("break it on down");
            
            foreach it in $items[gob of wet hair,gyroscope,macrame net,ornate picture frame,palm-frond net,superamplified boom box]
            {
                if (it.item_amount() == 0 || !it.is_unrestricted())
                    continue;
                stagger_sources.listAppend(it.pluraliseWordy());
            }
            if ($item[operation patriot shield].equipped_amount() > 0)
                stagger_sources.listAppend("throw shield");
            if ($item[Rain-Doh indigo cup].available_amount() > 0)
                stagger_sources.listAppend("Rain-Doh indigo cup");
            if ($item[tongue depressor].available_amount() > 0)
                stagger_sources.listAppend("tongue depressor");
                
            if (stun_sources.count() > 0)
                tower_killing_ideas.listAppend("Stuns: " + stun_sources.listJoinComponents(", ", "and"));
            if (stagger_sources.count() > 0)
                tower_killing_ideas.listAppend("Stagger sources: " + stagger_sources.listJoinComponents(", ", "and"));
            
            
            
            
            if ($item[small golem].available_amount() > 0)
            {
                if ($skill[Ambidextrous Funkslinging].skill_is_usable() && $item[slime stack].available_amount() > 0)
                    tower_killing_ideas.listAppend("Small golem available. Funksling early in combat with a slime stack for 3k damage/round.");
                else
                    tower_killing_ideas.listAppend("Small golem available. Use early in combat for 3k damage/round.");
            }
            if ($item[slime stack].available_amount() > 0)
                tower_killing_ideas.listAppend($item[slime stack].pluralise() + " available. (15% damage)");
                
            if ($skill[frigidalmatian].skill_is_usable() && my_maxmp() >= 300 && $effect[Frigidalmatian].have_effect() == 0)
                tower_killing_ideas.listAppend("Possibly cast Frigidalmatian.");
                
            if (monster_level_adjustment() > 0)
                tower_killing_ideas.listAppend(HTMLGenerateSpanFont("Try to reduce your ML", "red") + ", as it reduces damage done to them.");
                
            if ((my_path_id() == PATH_HEAVY_RAINS || $item[water wings for babies].available_amount() >= 3) && $item[water wings for babies].equipped_amount() <3)
                tower_killing_ideas.listAppend("Equip three water wings for babies to reduce ML. (increased damage)");
            
            if (tower_killing_ideas.count() > 0)
                subentry.entries.listAppend("Or towerkill (very difficult):" + HTMLGenerateIndentedText(tower_killing_ideas.listJoinComponents("<hr>")));
            else
                subentry.entries.listAppend("Or towerkill.");
                
            if ($item[dumb mud].available_amount() > 0)
                subentry.entries.listAppend("Or just use dumb mud, which will insta-kill a tower monster.");
        }
            
        if (level <= 3)
            url = "lair4.php";
        else
            url = "lair5.php";
	}*/

	if (should_output_main_entry)
		task_entries.listAppend(ChecklistEntryMake(18, image_name, url, subentries));
}

void QManorInit()
{
	QuestState state;
    
    
    state.state_boolean["need ballroom song set"] = false;
    
    if (my_path_id() == PATH_GELATINOUS_NOOB || in_bad_moon())
        state.state_boolean["need ballroom song set"] = true;
    
    //Trace every quest where it's worth setting the song:
    //Let's see...
    //L2: relevant
    //L3: relevant...? (skipping NCs)
    //L5: theoretically relevant (acquiring the KGE outfit without semi-rare)
    //L6: relevant
    //L7: relevant (two areas)
    //L8: relevant (climbing the mountain, acquiring mining outfit)
    //L9: relevant (twin peak)
    //L10: relevant (everywhere)
    //HitS: relevant (unlock)
    //L11: relevant (black forest, ballroom, pirates, hidden park, temple unlock, city unlock without semi-rare)
    //L12: relevant (starting the war)
    //L13: relevant, but marginal (south of the border, zap wand)
    //Pirates: relevant (acquiring outfit)
    if (__misc_state["can reasonably reach -25% combat"])
        state.state_boolean["need ballroom song set"] = false;
    if (my_turncount() >= 200)
        state.state_boolean["need ballroom song set"] = false;
    
    
    if (__misc_state_string["ballroom song"] == "-combat")
        state.state_boolean["need ballroom song set"] = false;
    
    if ($location[the haunted ballroom].delayRemainingInLocation() == 0) //probably not worth it anymore
        state.state_boolean["need ballroom song set"] = false;
    
    if ($location[the haunted ballroom].delayRemainingInLocation() > 0)
        state.state_boolean["ballroom needs delay burned"] = true;
    
    state.state_boolean["ballroom song effectively set"] = !state.state_boolean["need ballroom song set"];
    if (combat_rate_modifier() <= -25.0)
        state.state_boolean["ballroom song effectively set"] = true;
    if (__quest_state["Level 13"].in_progress || (__quest_state["Level 13"].finished && my_path_id() != PATH_BUGBEAR_INVASION) || questPropertyPastInternalStepNumber("questL13Final", 1))
        state.state_boolean["ballroom song effectively set"] = true;
    
    if (state.state_boolean["ballroom song effectively set"])
        state.state_boolean["need ballroom song set"] = false;
    
    
    
	if (locationAvailable($location[the haunted ballroom]) && !(state.state_boolean["need ballroom song set"] || state.state_boolean["ballroom needs delay burned"]))
		QuestStateParseMafiaQuestPropertyValue(state, "finished");
	else
    {
		QuestStateParseMafiaQuestPropertyValue(state, "started");
    }
    if (my_path_id() == PATH_COMMUNITY_SERVICE) QuestStateParseMafiaQuestPropertyValue(state, "finished");
	state.quest_name = "Spookyraven Manor Unlock";
	state.image_name = "Spookyraven Manor";
    
	
	/*location zone_to_work_on = $location[none];
	if (!locationAvailable($location[the haunted billiards room]))
	{
		zone_to_work_on = $location[the haunted billiards room];
	}
	else if (!locationAvailable($location[the haunted library]))
	{
		zone_to_work_on = $location[the haunted library];
	}
	else if (!locationAvailable($location[the haunted bedroom]))
	{
		zone_to_work_on = $location[the haunted bedroom];
	}
	else if (!locationAvailable($location[the haunted ballroom]))
	{
		zone_to_work_on = $location[the haunted ballroom];
	}
	state.state_string["zone to work on"] = zone_to_work_on;*/
	
	__quest_state["Manor Unlock"] = state;
}


void QManorGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Manor Unlock"].in_progress && __misc_state["in run"])
		return;
    if (my_level() < 5 && my_ascensions() == 0 && !QuestState("questM21Dance").in_progress) return; //not yet possible
    
    boolean should_output_optionally = false;
    boolean should_output_futurally = false;
	QuestState base_quest_state = __quest_state["Manor Unlock"];
    
    boolean [location] relevant_locations = $locations[the haunted kitchen, the haunted library, the haunted billiards room, the haunted bedroom, the haunted ballroom, the haunted gallery, the haunted bathroom];
    //$locations[the haunted kitchen, the haunted library, the haunted billiards room, the haunted bedroom, the haunted ballroom];
    
    
    if (!__misc_state["in run"] && !(relevant_locations contains __last_adventure_location))
        return;
	ChecklistSubentry subentry;
	//subentry.header = "Unlock Spookyraven Manor";
    
    //This is currently very incomplete, sorry.
	
	string url = "";
	
	string image_name;
    
    boolean ballroom_probably_open = false;
    if ($location[the haunted ballroom].turnsAttemptedInLocation() > 0)
        ballroom_probably_open = true;
    if (__misc_state_string["ballroom song"] != "") //FALSE if they haven't ascended since the revamp, I guess
        ballroom_probably_open = true;
    if (get_property("questM21Dance") == "finished")
        ballroom_probably_open = true;
    
    boolean second_floor_probably_open = false;
    
    //if (to_item("7301").available_amount() == 0 || to_item("7302").available_amount() == 0) //first floor can be skipped via faxing
        //second_floor_probably_open = false;
    if (get_property_ascension("lastSecondFloorUnlock")) //updates properly now
        second_floor_probably_open = true;
    if (get_property("questM20Necklace") == "finished") //mafia will erroneously set questM20Necklace to finished in certain (unknown) cases. could be an error in QuestDatabase.java's reset(), but I am uncertain what caused the bug locally (it also set lastSecondFloorUnlock to current, though it is not unlocked) note - still in effect. additional information: south of the border?
        second_floor_probably_open = true;
    
    if ($item[Lady Spookyraven's necklace].available_amount() > 0) //mostly
        second_floor_probably_open = true;
    if ($item[telegram from Lady Spookyraven].available_amount() > 0)
        second_floor_probably_open = false;
    
    if (second_floor_probably_open && __misc_state["in run"])
    {
        if ($item[Lady Spookyraven's necklace].available_amount() > 0 && get_property("questM20Necklace") != "finished")
        {
            subentry.header = "Speak to Lady Spookyraven";
            url = $location[the haunted kitchen].getClickableURLForLocation();
            image_name = "Lady Spookyraven";
            subentry.entries.listAppend("Give her her necklace.");
        }
        else
        {
            QuestState dance_quest_state;
            QuestStateParseMafiaQuestProperty(dance_quest_state, "questM21Dance");
            if (!dance_quest_state.finished && !($location[the haunted ballroom].noncombat_queue.contains_text("Having a Ball in the Ballroom")))
            {
                ChecklistSubentry [int] subentries;
                //Haunted gallery, bathroom, bedroom
                url = $location[the haunted gallery].getClickableURLForLocation();
                
                
                if (dance_quest_state.mafia_internal_step <= 1)
                {
                    subentries.listAppend(ChecklistSubentryMake("Speak to Lady Spookyraven", "", "To open the haunted gallery, bathroom, and bedroom."));
                    image_name = "Lady Spookyraven";
                }
                else
                {
                    if ($item[Lady Spookyraven's dancing shoes].available_amount() == 0 && dance_quest_state.mafia_internal_step < 4)
                    {
                        //NC (louvre or leave it) in gallery
                        string [int] modifiers;
                        string [int] description;
                        
                        description.listAppend("Find Lady Spookyraven's dancing shoes in the Louvre non-combat.");
                        
                        subentries.listAppend(ChecklistSubentryMake("Search in the Haunted Gallery", modifiers, description));
                        if (image_name.length() == 0)
                            image_name = "__item antique painting of a landscape";
                        
                        boolean garden_banished = CounterLookup("Garden Banished").CounterExists();
                        
                        boolean need_minus_combat = false;
                            
                        if (delayRemainingInLocation($location[the haunted gallery]) > 0)
                        {
                            string line = "Delay for " + pluralise(delayRemainingInLocation($location[the haunted gallery]), "turn", "turns") + ".";
                            if (__misc_state["have hipster"])
                            {
                                modifiers.listAppend(__misc_state_string["hipster name"]+"?");
                            }
                            if (!garden_banished)
                            {
                                line += " Try to find the garden NC to banish it.";
                                need_minus_combat = true;
                            }
                            description.listAppend(line);
                        }
                        else
                            need_minus_combat = true;
                        
                        if (need_minus_combat)
                            modifiers.listAppend("-combat");
                        
                        modifiers.listAppend("+meat");
                    }
                    if ($item[Lady Spookyraven's powder puff].available_amount() == 0 && dance_quest_state.mafia_internal_step < 4)
                    {
                        string [int] modifiers;
                        string [int] description;
                        description.listAppend("Find Lady Spookyraven's powder puff. (NC leads to cosmetics wraith)");
                        //combat rate extremely approximate, needs spading
                        
                        if (delayRemainingInLocation($location[the haunted bathroom]) == 0)
                            description.listAppend(generateTurnsToSeeNoncombat(85, 1, "find cosmetics wraith", 10 - delayRemainingInLocation($location[the haunted bathroom]), delayRemainingInLocation($location[the haunted bathroom])));
                        subentries.listAppend(ChecklistSubentryMake("Search in the Haunted Bathroom", modifiers, description));
                        
                        if (image_name.length() == 0)
                            image_name = "__item bottle of Monsieur Bubble";
                        if (delayRemainingInLocation($location[the haunted bathroom]) > 0)
                        {
                            string line = "Delay for " + pluralise(delayRemainingInLocation($location[the haunted bathroom]), "turn", "turns") + ".";
                            if (__misc_state["have hipster"])
                            {
                                modifiers.listAppend(__misc_state_string["hipster name"]+"?");
                            }
                            description.listAppend(line);
                        }
                        else
                            modifiers.listAppend("-combat");
                    }
                    if ($item[Lady Spookyraven's finest gown].available_amount() == 0 && dance_quest_state.mafia_internal_step < 4)
                    {
                        //elegant nightstand in bedroom (banish?)
                        //also acquire disposable instant camera. spectacles...?
                        //banishing may not help much?
                        string [int] modifiers;
                        string [int] description;
                        
                        description.listAppend("Find Lady Spookyraven's finest gown in the elegant nightstand.");
                        
                        string [int] items_needed_from_ornate_drawer;
                        
                        if ($item[lord spookyraven's spectacles].available_amount() == 0 && __quest_state["Level 11 Manor"].state_boolean["Can use fast route"])
                            items_needed_from_ornate_drawer.listAppend("lord spookyraven's spectacles");
                        
                        if (__quest_state["Level 11 Palindome"].state_boolean["Need instant camera"] && 7266.to_item().available_amount() == 0)
                            items_needed_from_ornate_drawer.listAppend("disposable instant camera");
                            
                            
                        if (items_needed_from_ornate_drawer.count() > 0)
                        {
                            description.listAppend("Banish non-ornate drawers.");
                            modifiers.listAppend("banish non-ornate");
                        }
                        else
                        {
                            description.listAppend("Banish non-elegant drawers.");
                            modifiers.listAppend("banish non-elegant");
                        }
                        
                        if (items_needed_from_ornate_drawer.count() > 0)
                            description.listAppend("Also acquire " + items_needed_from_ornate_drawer.listJoinComponents(", ", "and") + " from the ornate drawer.");
                        
                            
                        if (delayRemainingInLocation($location[the haunted bedroom]) > 0)
                        {
                            string line = "Delay for " + pluralise(delayRemainingInLocation($location[the haunted bedroom]), "turn", "turns") + ".";
                            if (__misc_state["have hipster"])
                            {
                                line += " (use " + __misc_state_string["hipster name"] + ")";
                                modifiers.listAppend(__misc_state_string["hipster name"]);
                            }
                            description.listAppend(line);
                        }
                        
                        
                        subentries.listAppend(ChecklistSubentryMake("Search in the Haunted Bedroom", modifiers, description));
                        if (image_name.length() == 0)
                            image_name = "Haunted Bedroom";
                        
                    }
                    if ($item[Lady Spookyraven's dancing shoes].available_amount() > 0 && $item[Lady Spookyraven's powder puff].available_amount() > 0 && $item[Lady Spookyraven's finest gown].available_amount() > 0 || dance_quest_state.mafia_internal_step == 4)
                    {
                        if (dance_quest_state.mafia_internal_step < 4)
                        {
                            subentry.header = "Speak with Lady Spookyraven";
                            subentry.entries.listAppend("Dancing.");
                        }
                        else
                        {
                            subentry.header = "Dance with Lady Spookyraven";
                            subentry.entries.listAppend("Adventure in the Haunted Ballroom.");
                            subentry.entries.listAppend("Gives stats.");
                        }
                        image_name = "Lady Spookyraven";
                    }
                }
                //FIXME suggest acquiring instant camera and spectacles
                if (subentries.count() > 0)
                {
                    task_entries.listAppend(ChecklistEntryMake(84, image_name, url, subentries, relevant_locations));
                }
            }
            else
            {
                if (base_quest_state.state_boolean["ballroom needs delay burned"] && __quest_state["Level 11"].mafia_internal_step < 3)
                {
                    ChecklistSubentry [int] subentries2;
                    string [int] modifiers2;
                    if (__misc_state["have hipster"])
                        modifiers2.listAppend(__misc_state_string["hipster name"]);
                    if (__misc_state["free runs available"])
                        modifiers2.listAppend("free runs");
                        
                    subentries2.listAppend(ChecklistSubentryMake("Burn " + pluralise($location[the haunted ballroom].delayRemainingInLocation(), "turn", "turns") + " delay in haunted ballroom", modifiers2, ""));
                    ChecklistEntry entry2 = ChecklistEntryMake(85, "__half Haunted Ballroom", $location[the haunted ballroom].getClickableURLForLocation(), subentries2, $locations[the haunted ballroom]);
                    entry2.importance_level = 5;
                    optional_task_entries.listAppend(entry2);
                    //subentry.header = ;
                }
                if (base_quest_state.state_boolean["need ballroom song set"])
                {
                    subentry.header = "Possibly set -combat ballroom song";
                    url = $location[the haunted ballroom].getClickableURLForLocation();
                    image_name = "__item the Legendary Beat";
                    subentry.modifiers.listAppend("-combat");
                    
                    subentry.entries.listAppend("Adventure in the Haunted Ballroom. May not be relevant.");
                    if (!$location[the haunted ballroom].noncombat_queue.contains_text("Curtains")) //initiate NC rejection
                        subentry.entries.listAppend(HTMLGenerateSpanFont("Do not skip the curtains NC the first time", "red") + ", this will make the ballroom song more likely to appear.");
                    
                    if (my_turncount() > 200 || base_quest_state.state_boolean["ballroom song effectively set"])
                    {
                        should_output_optionally = true;
                    }
                    subentry.entries.listAppend(generateTurnsToSeeNoncombat(90, 2, "")); //may be 90% now? is this worth setting anymore?
                }
            }
        }
    }
    else if ($item[telegram from Lady Spookyraven].available_amount() > 0)
    {
        //telegram is removed on using it, even on old copies of mafia
        subentry.header = "Read telegram from Lady Spookyraven";
        url = "inventory.php?which=3&ftext=telegram+from+Lady+Spookyraven";
        image_name = "__item telegram from Lady Spookyraven";
    }
    else if (to_item("7301").available_amount() == 0) //Spookyraven billiards room key
    {
        if (my_path_id() == PATH_COMMUNITY_SERVICE && __last_adventure_location != $location[the haunted kitchen])
            return;
        if (!__misc_state["in run"] && __last_adventure_location != $location[the haunted kitchen]) return;
        subentry.header = "Adventure in the Haunted Kitchen";
        url = $location[the haunted kitchen].getClickableURLForLocation();
        image_name = "__item tiny knife and fork";
        subentry.entries.listAppend("To unlock the Haunted Billiards Room.");
        
        /*if (get_property_monster("romanticTarget") == $monster[writing desk] && get_property_int("_romanticFightsLeft") > 0 || get_property_int("writingDesksDefeated") > 0 && __misc_state["in run"])
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Avoid adventuring here,", "red") + " as you seem to be using the writing desk trick?|Need to fight " + pluraliseWordy(clampi(5 - get_property_int("writingDesksDefeated"), 0, 5), "more writing desk.", "more writing desks."));
            should_output_futurally = true;
        }*/
        
        float drawers_per_turn = 0.0;
        float hot_resistance = numeric_modifier("hot resistance");
        float stench_resistance = numeric_modifier("stench resistance");
        
        int more_hot_needed = MAX(0, 9 - hot_resistance.to_int());
        int more_stench_needed = MAX(0, 9 - stench_resistance.to_int());
        
        
        string [int] needed_resists;
        if (more_hot_needed > 0)
            needed_resists.listAppend(more_hot_needed + " more " + HTMLGenerateSpanOfClass("hot", "r_element_hot") + " resistance");
        if (more_stench_needed > 0)
            needed_resists.listAppend(more_stench_needed + " more " + HTMLGenerateSpanOfClass("stench", "r_element_stench") + " resistance");
        
        //subentry.entries.listAppend("Run 9 " + HTMLGenerateSpanOfClass("hot", "r_element_hot") + " resistance and " + HTMLGenerateSpanOfClass("stench", "r_element_stench") + " resistance to search faster.");
        
        drawers_per_turn = 0.5 * MIN(4.0, MAX(1.0, 1.0 + hot_resistance / 3.0)) + 0.5 * MIN(4.0, MAX(1.0, 1.0 + stench_resistance / 3.0));
        drawers_per_turn = MAX(1.0, drawers_per_turn); //zero-divide safety backup
        
        float drawers_needed = MAX(0, 21 - get_property_int("manorDrawerCount"));
        
        int total_turns = ceil(drawers_needed / drawers_per_turn) + 1;
        
        if (needed_resists.count() > 0 && total_turns > 1)
            subentry.entries.listAppend("Run " + needed_resists.listJoinComponents(", ", "and") + " to search faster.");
        subentry.entries.listAppend(drawers_per_turn.roundForOutput(1) + " drawers searched per turn.|~" + pluralise(total_turns, "turn", "turns") + " remaining.");
        
		if (__misc_state["have hipster"])
			subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
        if (total_turns > 1)
        {
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("hot res", "r_element_hot_desaturated"));
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("stench res", "r_element_stench_desaturated"));
        }
        
        if (!__misc_state["familiars temporarily blocked"] && $familiar[exotic parrot].familiar_is_usable() && my_familiar() != $familiar[exotic parrot] && (hot_resistance < 9.0 || stench_resistance < 9.0) && total_turns > 1)
        {
            subentry.entries.listAppend("Possibly bring along your exotic parrot.");
        }
        
        if (inebriety_limit() > 10 && my_inebriety() < 10)
            subentry.entries.listAppend("Try not to drink past ten, the billiards room is next.");
    }
    else if (to_item("7302").available_amount() == 0) //Spookyraven library key
    {
        //Find key:
        subentry.header = "Adventure in the Haunted Billiards Room";
        url = $location[the Haunted Billiards Room].getClickableURLForLocation();
        image_name = "__item pool cue";
        subentry.entries.listAppend("To unlock the Haunted Library.");
        
        int estimated_pool_skill = get_property_int("poolSkill");
        
        /*if ($effect[chalky hand].have_effect() > 0)
            estimated_pool_skill += 3;
            
        if ($item[2268].equipped_amount() > 0) //staff of fats
            estimated_pool_skill += 5;
        if (to_item("7961").equipped_amount() > 0)
            estimated_pool_skill += 5;
        if ($item[pool cue].equipped_amount() > 0)
            estimated_pool_skill += 3;
        if ($effect[chalked weapon].have_effect() > 0)
            estimated_pool_skill += 5;
        if ($effect[video... games?].have_effect() > 0)
            estimated_pool_skill += 5;
        if ($effect[swimming with sharks].have_effect() > 0)
            estimated_pool_skill += 3;*/
        estimated_pool_skill += numeric_modifier("pool skill");
        
        int theoretical_hidden_pool_skill = 0;
        if (my_inebriety() <= 10)
            theoretical_hidden_pool_skill = my_inebriety();
        else
            theoretical_hidden_pool_skill = 10 - (my_inebriety() - 10) * 2;
            
        estimated_pool_skill += theoretical_hidden_pool_skill;
        estimated_pool_skill += clampi(floor(2.0 * sqrt(get_property("poolSharkCount").to_float())), 0, 10);
        
        subentry.modifiers.listAppend("-combat");
        subentry.entries.listAppend("Train pool skill via -combat. Need 14 up to 18(?) total pool skill.|Have ~" + estimated_pool_skill + " pool skill.");
        
        int missing_pool_skill = MAX(18 - estimated_pool_skill, 0);
        
        if (missing_pool_skill > 0)
        {
            if ($item[Staff of Ed, almost].available_amount() > 0)
            {
                subentry.entries.listAppend("Untinker the Staff of Ed, almost.");
            }
            else if ($item[2268].available_amount() > 0) //staff of fats
            {
                if ($item[2268].equipped_amount() == 0) //staff of fats
                {
                    subentry.entries.listAppend("Equip the Staff of Fats for +pool skill.");
                }
            }
            else
            {
                if ($item[pool cue].available_amount() == 0)
                {
                    subentry.entries.listAppend("Find pool cue.");
                }
                else if (my_path_id() == PATH_GELATINOUS_NOOB)
                {
                    subentry.entries.listAppend("Absorb pool cue for +pool skill?");
                }
                else if ($item[pool cue].equipped_amount() == 0)
                {
                    subentry.entries.listAppend("Equip pool cue for +pool skill.");
                }
            }
            if ($effect[chalky hand].have_effect() == 0& $item[handful of hand chalk].available_amount() > 0)
            {
                subentry.entries.listAppend(HTMLGenerateSpanFont("Use handful of hand chalk", "red") + " for +pool skill and faster pool skill training.");
                url = "inventory.php?which=3";
            }
        }
        
        if (inebriety_limit() > 0)
        {
            int desired_drunkenness = MIN(inebriety_limit(), 10);
            if (my_inebriety() < desired_drunkenness)
            {
                int more_drunkenness = MIN(availableDrunkenness(), MIN(missing_pool_skill, desired_drunkenness - my_inebriety()));
                if (more_drunkenness > 0)
                    subentry.entries.listAppend("Consider drinking " + more_drunkenness + " more drunkenness.");
            }
            
            if (missing_pool_skill > 0 && my_inebriety() > 10)
                subentry.entries.listAppend(HTMLGenerateSpanFont("Consider waiting for rollover for better pool skill.", "red") + " (you're over 10 drunkenness.)");
        }
        if (my_inebriety() > 0 && false)
        {
            //shortly after rollover during the revamp, drunkenness affected listed pool skill in the quest log
            //exact values were 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 8, 6, 4, 2, 0, -2, -4, -6, -8
            
            string pool_skill_string;
            if (theoretical_hidden_pool_skill >= 0)
                pool_skill_string = "+";
            pool_skill_string += theoretical_hidden_pool_skill;
            subentry.entries.listAppend("Drunkenness effect: " + pool_skill_string + " pool skill.");
        }
    }
    else if (!second_floor_probably_open)
    {
        //Library:
        subentry.header = "Adventure in the Haunted Library";
        url = $location[the Haunted Billiards Room].getClickableURLForLocation();
        image_name = "__item very overdue library book";
        subentry.modifiers.listAppend("olfact writing desk");
        
        int desks_remaining = clampi(5 - get_property_int("writingDesksDefeated"), 0, 5);
        subentry.entries.listAppend("To unlock the second floor.");
        subentry.entries.listAppend("Defeat " + pluraliseWordy(desks_remaining, "more writing desk", "more writing desks") + " to acquire a necklace.");
        
        boolean need_killing_jar = false;
        if ($item[killing jar].available_amount() == 0 && !__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && !__quest_state["Level 11 Desert"].state_boolean["Killing Jar Given"])
        {
            need_killing_jar = true;
            subentry.modifiers.listAppend("+900% item");
            subentry.entries.listAppend("Try to acquire a killing jar to speed up the desert later.|10% drop from banshee librarian.");
        }
        if (!need_killing_jar && (!$monster[banshee librarian].is_banished() || !$monster[bookbat].is_banished()))
        {
            subentry.modifiers.listAppend("banish rest");
        }
        
    }
	if (subentry.header != "")
    {
        if (image_name.length() == 0)
            image_name = base_quest_state.image_name;
        ChecklistEntry entry = ChecklistEntryMake(86, image_name, url, subentry, relevant_locations);
        if (should_output_futurally)
            future_task_entries.listAppend(entry);
        else if (should_output_optionally)
            optional_task_entries.listAppend(entry);
        else
            task_entries.listAppend(entry);
    }
}

void QPirateInit()
{
	//questM12Pirate ?
	//lastPirateInsult1 through lastPirateInsult8
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questM12Pirate");
	state.quest_name = "Pirate Quest";
	state.image_name = "pirate quest";
	
	state.state_boolean["valid"] = true;
	if (__misc_state["mysterious island available"] && !(my_path_id() == PATH_COMMUNITY_SERVICE || __misc_state["in aftercore"]))
	{
		state.startable = true;
		if (!state.in_progress && !state.finished)
		{
			QuestStateParseMafiaQuestPropertyValue(state, "started");
		}
	}
    
    
	boolean hot_wings_relevant = knoll_available() || $item[frilly skirt].available_amount() > 0 || !in_hardcore();
    if (state.mafia_internal_step >= 4) //done that already
        hot_wings_relevant = false;
	boolean need_more_hot_wings = $item[hot wing].available_amount() <3 && hot_wings_relevant;
    
    state.state_boolean["hot wings relevant"] = hot_wings_relevant;
    state.state_boolean["need more hot wings"] = need_more_hot_wings;
    
    
	int insult_count = 0;
	for i from 1 to 8
	{
		if (get_property_boolean("lastPirateInsult" + i))
			insult_count += 1;
	}
    state.state_int["insult count"] = insult_count;
    
    if ($item[Orcish Frat House blueprints].available_amount() > 0 && state.mafia_internal_step <3 )
        QuestStateParseMafiaQuestPropertyValue(state, "step2");
    
	//Certain characters are in weird states, I think?
    if ($item[pirate fledges].available_amount() > 0 || $item[talisman o' namsilat].available_amount() > 0)
        QuestStateParseMafiaQuestPropertyValue(state, "finished");
	__quest_state["Pirate Quest"] = state;
	
	if (my_path_id() == PATH_POCKET_FAMILIARS || my_path_id() == PATH_G_LOVER || true)
	{
		state.state_boolean["valid"] = false;
        state.state_boolean["hot wings relevant"] = false;
        state.state_boolean["need more hot wings"] = false;
	}
}


void QPirateGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__quest_state["Pirate Quest"].in_progress)
		return;
    if (!__quest_state["Pirate Quest"].state_boolean["valid"] && !(get_property_boolean("kingLiberated") && $locations[Barrrney's Barrr,The F'c'le,The Poop Deck,Belowdecks] contains __last_adventure_location))
        return;
        
	QuestState base_quest_state = __quest_state["Pirate Quest"];
	ChecklistSubentry subentry;
	subentry.header = base_quest_state.quest_name;
    string url = "";
    
    
	boolean have_outfit = have_outfit_components("Swashbuckling Getup");
	if ($item[pirate fledges].available_amount() > 0)
		have_outfit = true;
        
    int insult_count = base_quest_state.state_int["insult count"];
	
	float [int] insult_success_likelyhood;
	//haven't verified these numbers, need to double-check
	insult_success_likelyhood[0] = 0.0;
	insult_success_likelyhood[1] = 0.0;
	insult_success_likelyhood[2] = 0.0;
	insult_success_likelyhood[3] = 0.0179;
	insult_success_likelyhood[4] = 0.071;
	insult_success_likelyhood[5] = 0.1786;
	insult_success_likelyhood[6] = 0.357;
	insult_success_likelyhood[7] = 0.625;
	insult_success_likelyhood[8] = 1.0;
	
    boolean delay_for_future = false;
    boolean can_acquire_cocktail_napkins = false;
    
    if (in_ronin() && $item[Talisman o' Namsilat].available_amount() == 0)
    	subentry.entries.listAppend(HTMLGenerateSpanFont("Pirates won't help you in-run anymore.", "red"));
	
	if (!have_outfit)
	{
        url = "island.php";
		string line = "Acquire outfit.";
		
		item [int] outfit_pieces = outfit_pieces("Swashbuckling Getup");
		item [int] outfit_pieces_needed;
		foreach key in outfit_pieces
		{
			item piece = outfit_pieces[key];
			if (piece.available_amount() == 0)
				outfit_pieces_needed.listAppend(piece);
		}
		line += " Need " + outfit_pieces_needed.listJoinComponents(", ", "and") + ".";
		subentry.entries.listAppend(line);
		
		subentry.modifiers.listAppend("+item");
		subentry.modifiers.listAppend("-combat");
        
        if ($familiar[slimeling].familiar_is_usable())
            subentry.modifiers.listAppend("slimeling?");
        
        int ncs_relevant = 0; //out of six
        if ($item[stuffed shoulder parrot].available_amount() == 0 || $item[eyepatch].available_amount() == 0)
            ncs_relevant += 1;
        if ($item[eyepatch].available_amount() == 0 || $item[swashbuckling pants].available_amount() == 0)
            ncs_relevant += 1;
        if ($item[swashbuckling pants].available_amount() == 0 || $item[stuffed shoulder parrot].available_amount() == 0)
            ncs_relevant += 1;
        
        float average_combat_rate = clampNormalf(.6 + combat_rate_modifier() / 100.0);
        float average_nc_rate = 1.0 - average_combat_rate;
        
        float average_useful_nc_rate = average_nc_rate * (ncs_relevant.to_float() / 6.0);
        //FIXME make this more accurate
        float turns_remaining = -1.0;
        if (average_useful_nc_rate != 0.0)
            turns_remaining = outfit_pieces_needed.count().to_float() / average_useful_nc_rate;
		subentry.entries.listAppend("Run -combat in the obligatory pirate's cove." + "|~" + turns_remaining.roundForOutput(1) + " turns remain at " + combat_rate_modifier().floor() + "% combat.");
        
        if (!__quest_state["Manor Unlock"].state_boolean["ballroom song effectively set"])
        {
            subentry.entries.listAppend(HTMLGenerateSpanOfClass("Wait until -combat ballroom song set.", "r_bold"));
            delay_for_future = true;
        }
	}
	else
	{
        url = "place.php?whichplace=cove";
        
        if (!is_wearing_outfit("Swashbuckling Getup") && $item[pirate fledges].equipped_amount() == 0)
            url = "inventory.php?which=2";
            
        boolean have_all_fcle_items = false;
        
		if (base_quest_state.mafia_internal_step == 1)
		{
            can_acquire_cocktail_napkins = true;
			//caronch gave you a map
			if ($item[Cap'm Caronch's nasty booty].available_amount() == 0 && $item[Cap'm Caronch's Map].available_amount() > 0)
			{
                url = "inventory.php?which=3";
				subentry.entries.listAppend("Use Cap'm Caronch's Map, fight a booty crab.");
				subentry.entries.listAppend("Possibly run +meat. (300 base drop)");
                subentry.modifiers.listAppend("+meat");
			}
			else if (have_outfit)
            {
                subentry.modifiers.listAppend("-combat");
				subentry.entries.listAppend("Find Cap'm Caronch in Barrrney's Barrr.");
            }
		}
		else if (base_quest_state.mafia_internal_step == 2)
		{
            can_acquire_cocktail_napkins = true;
			//give booty back to caronch
			subentry.entries.listAppend("Find Cap'm Caronch in Barrrney's Barrr.");
		}
		else if (base_quest_state.mafia_internal_step == 3)
		{
            can_acquire_cocktail_napkins = true;
			//have blueprints, catburgle
			string line = "Use the Orcish Frat House blueprints";
			if (insult_count < 6)
            {
                subentry.modifiers.listAppend("+20% combat");
				line += ", once you have at least six insults"; //in certain situations five might be slightly faster? but that skips a lot of combats, so probably not
            }
			line += ".";
			
            string method;
			if (have_outfit_components("Frat Boy Ensemble") && __misc_state["can equip just about any weapon"])
			{
				string [int] todo;
				if (!is_wearing_outfit("Frat Boy Ensemble"))
					todo.listAppend("wear frat boy ensemble");
				todo.listAppend("attempt a frontal assault");
				method = todo.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".";
			}
			else if ($item[mullet wig].available_amount() > 0 && $item[briefcase].available_amount() > 0)
			{
				string [int] todo;
				if ($item[mullet wig].equipped_amount() == 0)
					todo.listAppend("wear mullet wig");
				todo.listAppend("go in through the side door");
				method = todo.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".";
			}
			else if (knoll_available() || ($item[frilly skirt].available_amount() > 0 && $item[hot wing].available_amount() >= 3))
			{
				string [int] todo;
                if (insult_count < 6)
                    todo.listAppend("acquire at least six insults");
				if ($item[hot wing].available_amount() <3 )
					todo.listAppend("acquire " + pluralise((3 - $item[hot wing].available_amount()), "more hot wing", "more hot wings"));
				if ($item[frilly skirt].equipped_amount() == 0)
					todo.listAppend("wear frilly skirt");
				todo.listAppend("catburgle");
                string line2 = todo.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".";
				method = line2;
			}
			else
			{
                //Non-knoll sign.
                //I think the fastest method is frilly skirt?
                if ($item[hot wing].available_amount() >= 3 && my_familiar() != $familiar[black cat])
                    method = "Farm a frilly skirt in the knoll gym. (+300% item)";
                else
                {
                    method = "Acquire a frat boy outfit in the frat house? (-combat" + (my_level() < 9 ? " after level 9" : "") + ")";
                    if (!__quest_state["Level 6"].finished)
                        method += "|Or collect hot wings from the friar demons" + ($item[frilly skirt].available_amount() == 0 ? ", and frilly skirt from the knoll gym" : "") + ".";
                }
			}
            line += "|" + method;
			subentry.entries.listAppend(line);
		}
		else if (base_quest_state.mafia_internal_step == 4)
		{
			//acquired teeth, give them back
			subentry.entries.listAppend("Find Cap'm Caronch in Barrrney's Barrr. (next adventure)");
		}
		else if (base_quest_state.mafia_internal_step == 5)
		{
			//ricketing
			subentry.entries.listAppend("Play beer pong.");
			subentry.entries.listAppend("If you want more insults now, adventure in the Obligatory Pirate's Cove, not in the Barrr.");
		}
		else if (base_quest_state.mafia_internal_step == 6)
		{
			//f'c'le
			//We can't tell them which ones they need, precisely, since they may have already used them.
			//We can tell them which ones they have... but it's still unreliable. I guess a single message if they have all three?
			string line = "F'c'le.";
			string additional_line = "";
            
            item [int] missing_washing_items = $items[rigging shampoo,mizzenmast mop,ball polish].items_missing();
            
			if (missing_washing_items.count() == 0)
            {
                have_all_fcle_items = true;
                //url = "inventory.php?which=3";
                line += " Adventure once to complete quest.";
				//line += " " + HTMLGenerateSpanFont("Use rigging shampoo, mizzenmast mop, and ball polish", "red") + ", then adventure to complete quest.";
            }
			else
			{
                subentry.modifiers.listAppend("+234% item");
                subentry.modifiers.listAppend("+20% combat");
				line += " Run +234% item, +combat, and collect " + missing_washing_items.listJoinComponents(", ", "and") + ".";
				if ($location[the f'c'le].item_drop_modifier_for_location() < 234.0)
					additional_line = "This location can be a nightmare without +234% item.";
                    
                subentry.modifiers.listAppend("banish chatty/crusty pirate");
                if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
                {
                    monster [int] monsters_left;
                    if ($item[rigging shampoo].available_amount() == 0)
                        monsters_left.listAppend($monster[cleanly pirate]);
                    if ($item[mizzenmast mop].available_amount() == 0)
                        monsters_left.listAppend($monster[curmudgeonly pirate]);
                    if ($item[ball polish].available_amount() == 0)
                        monsters_left.listAppend($monster[creamy pirate]);
                    if (monsters_left.count() > 0)
                    {
                        string [int] monsters_left_string;
                        foreach key, m in monsters_left
                        {
                            if (last_monster() == m)
                                monsters_left_string.listAppend(HTMLGenerateSpanOfClass(m, "r_bold"));
                            else
                                monsters_left_string.listAppend(m);
                        }
                        string line2 = "Use";
                        if ($item[Talisman of Renenutet].available_amount() == 0)
                            line2 = "Acquire and use";
                        line2 += " the Talisman of Renenutet on " + monsters_left_string.listJoinComponents(", ", "and") + ".";
                        if ($item[Talisman of Renenutet].available_amount() == 0)
                            line2 = HTMLGenerateSpanFont(line2, "red");
                        subentry.entries.listAppend(line2);
                    }
                }
			}
            
			subentry.entries.listAppend(line);
			if (additional_line != "")
				subentry.entries.listAppend(additional_line);
            if (!($monster[clingy pirate (female)].is_banished() || $monster[clingy pirate (male)].is_banished()) && $item[cocktail napkin].available_amount() > 0 && !have_all_fcle_items)
            {
                subentry.entries.listAppend("Use cocktail napkin on clingy pirate to " + (__misc_state["free runs usable"] ? "free run/" : "") + "banish.");
            }
		}
        
        if (base_quest_state.mafia_internal_step <= 3 && my_inebriety() > 0)
        {
            subentry.entries.listAppend("Could wait until rollover; one of the non-combats can become a combat at zero drunkenness.");
        }
        
        
        if (__misc_state["free runs available"] && !can_acquire_cocktail_napkins && !have_all_fcle_items)
            subentry.modifiers.listAppend("free runs");
	}
	boolean should_output_insult_data = false;
	if ($item[the big book of pirate insults].available_amount() > 0 || have_outfit)
		should_output_insult_data = true;
	if (base_quest_state.mafia_internal_step >= 6)
		should_output_insult_data = false;
		
	if (should_output_insult_data)
	{
		string line = "At " + pluralise(insult_count, "insult", "insults") + ". " + roundForOutput(insult_success_likelyhood[insult_count] * 100, 1) + "% chance of beer pong success.";
		if (insult_count < 8)
			line += "|Insult every pirate with the big book of pirate insults.";
		subentry.entries.listAppend(line);
	}
	if ($item[the big book of pirate insults].available_amount() == 0 && base_quest_state.mafia_internal_step < 6 && have_outfit)
		subentry.entries.listAppend(HTMLGenerateSpanFont("Buy the big book of pirate insults.", "red"));
	
    if (can_acquire_cocktail_napkins && $item[cocktail napkin].available_amount() == 0)
    {
        subentry.modifiers.listAppend("+item");
        subentry.entries.listAppend("Try to acquire a cocktail napkin to speed up F'c'le. (10% drop, marginal)");
    }
    
	if (!is_wearing_outfit("Swashbuckling Getup") && have_outfit)
    {
        string [int] stats_needed;
        if (my_basestat($stat[moxie]) < 25)
            stats_needed.listAppend("moxie");
        if (my_basestat($stat[mysticality]) < 25)
            stats_needed.listAppend("mysticality");
        string line = "Wear swashbuckling getup.";
        
        if (stats_needed.count() > 0)
        {
            delay_for_future = true;
            line += HTMLGenerateSpanOfClass(" Need 25 " + stats_needed.listJoinComponents(", ", "and"), "r_bold") + ".";
        }
		subentry.entries.listAppend(line);
    }
        
    if (delay_for_future)
        future_task_entries.listAppend(ChecklistEntryMake(89, base_quest_state.image_name, url, subentry, $locations[the obligatory pirate's cove, barrrney's barrr, the f'c'le]));
    else
        task_entries.listAppend(ChecklistEntryMake(90, base_quest_state.image_name, url, subentry, $locations[the obligatory pirate's cove, barrrney's barrr, the f'c'le]));
}

//"started", "finished" observed for questG04Nemesis

void QNemesisInit()
{
    if (!($classes[seal clubber, turtle tamer, pastamancer, sauceror, disco bandit, accordion thief] contains my_class()))
        return;
	//questG04Nemesis
	QuestState state;
    
	
	QuestStateParseMafiaQuestProperty(state, "questG04Nemesis");
	
	state.quest_name = "Nemesis Quest";
	state.image_name = "__half Nemesis";
	
	if (my_basestat(my_primestat()) >= 12)
		state.startable = true;
	
	__quest_state["Nemesis"] = state;
}

void QNemesisGenerateIslandTasks(ChecklistSubentry subentry)
{
    if (my_class() == $class[disco bandit])
    {
        skill [int] rave_skills_needed;
        if (!$skill[Break It On Down].skill_is_usable())
            rave_skills_needed.listAppend($skill[Break It On Down]);
        if (!$skill[Pop and Lock It].skill_is_usable())
            rave_skills_needed.listAppend($skill[Pop and Lock It]);
        if (!$skill[Run Like the Wind].skill_is_usable())
            rave_skills_needed.listAppend($skill[Run Like the Wind]);
        
        monster [skill] rave_skills_to_monster;
        rave_skills_to_monster[$skill[Break It On Down]] = $monster[breakdancing raver];
        rave_skills_to_monster[$skill[Pop and Lock It]] = $monster[pop-and-lock raver];
        rave_skills_to_monster[$skill[run like the wind]] = $monster[running man];
        
        boolean have_all_rave_skills = (rave_skills_needed.count() == 0);
        if (!$skill[gothy handwave].skill_is_usable())
        {
            subentry.entries.listAppend("Talk to the girl in a black dress.");
        }
        else if (!have_all_rave_skills)
        {
            //Learn dance moves.
            string [int] monsters_to_fight;
            foreach key in rave_skills_needed
            {
                skill rave_skill = rave_skills_needed[key];
                monsters_to_fight.listAppend(rave_skills_to_monster[rave_skill].to_string());
            }
            subentry.entries.listAppend("Learn dance moves from the " + monsters_to_fight.listJoinComponents(", ", "and") + ".");
        }
        else
        {
            //Acquire ravosity.
            if (numeric_modifier("raveosity") >= 7)
            {
                subentry.entries.listAppend("Talk to the guard.");
            }
            else
            {
                int extra_raveosity_from_equip = 0;
                item [int] items_have_but_unequipped;
                foreach it in $items[rave visor,baggy rave pants,pacifier necklace,teddybear backpack,glowstick on a string,candy necklace,rave whistle,blue glowstick,green glowstick,purple glowstick,pink glowstick,orange glowstick,yellow glowstick]
                {
                    if (it.available_amount() > 0 && it.equipped_amount() == 0)
                    {
                        items_have_but_unequipped.listAppend(it);
                        extra_raveosity_from_equip += numeric_modifier(it, "raveosity").to_int();
                    }
                }
                
                int raveosity_needed = (7 - (extra_raveosity_from_equip + numeric_modifier("raveosity").to_int()));
                
                if (raveosity_needed > 0)
                {
                    string line = "Rave steal to find ";
                    
                    if (raveosity_needed == 1)
                        line += "One More Raveosity.";
                    else
                        line += raveosity_needed.int_to_wordy() + " more raveosity.";
                    subentry.entries.listAppend(line);
                }
                
                if (items_have_but_unequipped.count() > 0)
                    subentry.entries.listAppend("Wear " + items_have_but_unequipped.listJoinComponents(", ", "and") + ".");
            }
        }
    }
    else if (my_class() == $class[accordion thief])
    {
        if ($item[hacienda key].available_amount() >= 5)
            subentry.entries.listAppend("All keys found. Fight in the Hacienda.");
        else
        {
            subentry.modifiers.listAppend("-combat");
            int keys_needed = MAX(0, 5 - $item[hacienda key].available_amount());
            subentry.entries.listAppend(pluraliseWordy(keys_needed, "key", "keys").capitaliseFirstLetter() + " to go.");
            subentry.entries.listAppend("Four are from the non-combat; one is from pick-pocketing a mariachi.");
        }
    }
    else if (my_class() == $class[pastamancer])
    {
        if ($item[spaghetti cult robe].available_amount() > 0)
        {
            if ($item[spaghetti cult robe].equipped_amount() == 0)
                subentry.entries.listAppend("Equip spaghetti cult robe, then enter the lair.");
            else
                subentry.entries.listAppend("Enter the lair.");
        }
        else if (my_thrall() == $thrall[spaghetti elemental])
        {
            string [int] tasks;
            if ($thrall[spaghetti elemental].level <3)
            {
                string line = "level your cute and adorable spaghetti elemental to 3";
                if ($item[experimental carbon fiber pasta additive].available_amount() > 0)
                {
                    line += " (use the experimental carbon fiber pasta additive)";
                }
                tasks.listAppend(line);
            }
            tasks.listAppend("defeat an evil spaghetti cult middle-manager");
            
            subentry.entries.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
        }
        else if ($skill[Bind Spaghetti Elemental].skill_is_usable())
        {
            subentry.entries.listAppend("Cast Bind Spaghetti Elemental.");
        }
        else
        {
            if ($item[decoded cult documents].available_amount() > 0)
            {
                subentry.entries.listAppend("Use decoded cult documents.");
            }
            else
            {
                if ($item[encoded cult documents].available_amount() == 0)
                    subentry.entries.listAppend("Acquire encoded cult documents from a protestor.");
                
                int missing_cult_memos = MAX(0, 5 - $item[cult memo].available_amount());
                if (missing_cult_memos > 0)
                {
                    subentry.entries.listAppend("Acquire " + pluralise(missing_cult_memos, $item[cult memo]) + " more from middle-managers.");
                }
                else if ($item[encoded cult documents].available_amount() > 0)
                {
                    subentry.entries.listAppend("Use cult memos.");
                }
            }
        }
    }
    else if (my_class() == $class[turtle tamer])
    {
        if ($item[Fouet de tortue-dressage].available_amount() == 0)
            subentry.entries.listAppend("Talk to a guy in the bushes.");
        else
        {
            if ($item[Fouet de tortue-dressage].equipped_amount() == 0)
                subentry.entries.listAppend("Equip Fouet de tortue-dressage.");
            subentry.entries.listAppend("Use Apprivoisez la tortue on french turtles a bunch, save them!|Then talk to the guy in the bushes.");
        }
    }
    else if (my_class() == $class[sauceror])
    {
        if ($item[bottle of G&uuml;-Gone].available_amount() == 0)
            subentry.entries.listAppend("Visit the boat.");
        else
        {
            /*
            lastSlimeVial3891(user, now 'intensity', default )
            lastSlimeVial3892(user, now 'moxiousness', default )
            lastSlimeVial3893(user, now 'eyesight', default )
            lastSlimeVial3894(user, now 'mentalism', default )
            lastSlimeVial3895(user, now 'muscle', default )
            lastSlimeVial3896(user, now 'slimeform', default )
            */
            if ($effect[slimeform].have_effect() > 0)
                subentry.entries.listAppend("Wiggle into the lair.|Also, go visit your mom in the slimetube.");
            else
            {
                
                boolean [item] tertiary_potions = $items[vial of vermilion slime,vial of amber slime,vial of chartreuse slime,vial of teal slime,vial of purple slime,vial of indigo slime];
                
                item slimeform_potion = $item[none];
                item [int] creatable_unknown_potions;
                foreach potion in tertiary_potions
                {
                    string property_value = get_property("lastSlimeVial" + potion.to_int());
                    if (property_value.length() == 0)
                    {
                        if (potion.available_amount() + potion.creatable_amount() > 0)
                            creatable_unknown_potions.listAppend(potion);
                    }
                    else if (property_value == "slimeform")
                        slimeform_potion = potion;
                }
                if (slimeform_potion != $item[none] && slimeform_potion.creatable_amount() + slimeform_potion.available_amount() > 0)
                {
                    subentry.entries.listAppend("Use a " + slimeform_potion + " to gain slimeform.");
                    //FIXME URL
                }
                else
                {
                    subentry.entries.listAppend("Use the " + $item[bottle of G&uuml;-Gone] + " on slime, make potions to get slimeform.");
                    if (creatable_unknown_potions.count() > 0 && slimeform_potion == $item[none])
                    {
                        boolean need_to_make = false;
                        foreach key, it in creatable_unknown_potions
                        {
                            if (it.available_amount() == 0 && it.creatable_amount() > 0)
                                need_to_make = true;
                        }
                        
                        string line = "Try";
                        if (need_to_make)
                            line += " making and";
                        line += " using " + creatable_unknown_potions.listJoinComponents(", ", "or") + ".";
                        subentry.entries.listAppend(line);
                    }
                }
            }
        }
    }
    else if (my_class() == $class[seal clubber])
    {
        if ($item[hellseal disguise].available_amount() > 0)
        {
            subentry.entries.listAppend("Approach the dark cave.");
        }
        else if ($item[hellseal hide].available_amount() >= 6 && $item[hellseal sinew].available_amount() >= 6 && $item[hellseal brain].available_amount() >= 6)
        {
            subentry.entries.listAppend("Speak with Phineas.");
        }
        else
        {
            int seal_screeches = get_property_int("_sealScreeches");
            string screech_name = "screech";
            if (my_path_id() == PATH_KOLHS) //KOLHS support
                screech_name = "samuel powers";
            if ($item[seal tooth].available_amount() == 0)
            {
                subentry.entries.listAppend("Acquire a seal tooth from the hermit.");
            }
            else
                subentry.entries.listAppend("Use a seal tooth to damage the hellseal pups until they screech, once each.");
            if ($skill[lunging thrust-smack].have_skill())
            {
                subentry.entries.listAppend("Use lunging thrust-smack against the mother hell seals.");
            }
            else
            {
                subentry.entries.listAppend("Buy lunging thrust-smack from your guild.");
            }
            subentry.entries.listAppend(pluraliseWordy(seal_screeches, "seal " + screech_name, "seal " + screech_name + "es").capitaliseFirstLetter() + ".");
            
            
            int sinew_need = clampi(6 - $item[hellseal sinew].available_amount(), 0, 6);
            int brains_have = clampi(6 - $item[hellseal brain].available_amount(), 0, 6);
            int hides_have = clampi(6 - $item[hellseal hide].available_amount(), 0, 6);
            
            string [int] items_needed_list;
            foreach it in $items[hellseal sinew,hellseal brain,hellseal hide]
            {
                int remaining = clampi(6 - it.available_amount(), 0, 6);
                if (remaining == 0) continue;
                string name_short = it.to_string().replace_string("hellseal ", "");
                string name_short_plural = it.plural.to_string().replace_string("hellseal ", "");
                items_needed_list.listAppend(pluraliseWordy(remaining, "more " + name_short, "more " + name_short_plural));
            }
            if (items_needed_list.count() == 0)
            {
            }
            else
            {
                subentry.entries.listAppend("Need " + items_needed_list.listJoinComponents(", ", "and") + ".");
            }
            
            
            string [int] passive_uneffect_description = PDSGenerateDescriptionToUneffectPassives();
            if (passive_uneffect_description.count() > 0)
                subentry.entries.listAppend(HTMLGenerateSpanFont(passive_uneffect_description.listJoinComponents("|"), "red"));
                
            if (!$slot[weapon].equipped_item().weapon_is_club())
            {
                subentry.entries.listAppend(HTMLGenerateSpanFont("Equip a club" + ($effect[Iron Palms].have_effect() > 0 ? " or sword" : "") + " first.", "red"));
            }
        }
    }
}


void QNemesisGenerateClownTasks(ChecklistSubentry subentry)
{
    item [class] legendary_epic_weapon_craftable_source;
    legendary_epic_weapon_craftable_source[$class[seal clubber]] = $item[distilled seal blood];
    legendary_epic_weapon_craftable_source[$class[turtle tamer]] = $item[turtle chain];
    legendary_epic_weapon_craftable_source[$class[pastamancer]] = $item[high-octane olive oil];
    legendary_epic_weapon_craftable_source[$class[sauceror]] = $item[peppercorns of power];
    legendary_epic_weapon_craftable_source[$class[disco bandit]] = $item[vial of mojo];
    legendary_epic_weapon_craftable_source[$class[accordion thief]] = $item[golden reeds];
    
    subentry.modifiers.listAppend("-combat");
    subentry.entries.listAppend("Search in the Fun House.");
    int clownosity = numeric_modifier("Clowniness").floor();
    int clownosity_needed = MAX(100 - clownosity, 0);
    
    if (clownosity_needed > 0)
    {
        string [int] available_clown_sources;
        string [int] missing_sources;
        
        item [slot] possible_outfit;
        foreach it in $items[clown wig,clown whip,clownskin buckler,clownskin belt,clownskin harness,polka-dot bow tie,balloon sword,balloon helmet,foolscap fool's cap,bloody clown pants,clown shoes,big red clown nose]
        {
            int clownosity = numeric_modifier(it, "Clowniness").floor();
            string description = it + " (" + clownosity + ")";
            if (it.available_amount() + it.creatable_amount() > 0 && it.equipped_amount() == 0 && it.can_equip())
            {
                available_clown_sources.listAppend(description);
                if (possible_outfit[it.to_slot()].numeric_modifier("Clowniness").floor() < clownosity)
                    possible_outfit[it.to_slot()] = it;
            }
            if (it.available_amount() == 0)
                missing_sources.listAppend(description);
        }
        
        item [int] suggested_outfit;
        int clownosity_possible = 0;
        foreach key in possible_outfit
        {
            clownosity_possible += possible_outfit[key].numeric_modifier("Clowniness").floor();
            suggested_outfit.listAppend(possible_outfit[key]);
            if (clownosity_possible >= clownosity_needed)
                break;
        }
        //Remove extraneous pieces:
        foreach key in suggested_outfit
        {
            int clownosity = suggested_outfit[key].numeric_modifier("Clowniness").floor();
            if (clownosity_possible - clownosity >= clownosity_needed)
            {
                clownosity_possible -= clownosity;
                remove suggested_outfit[key];
            }
            
        }
        string line = "Need " + clownosity_needed + " more clowniness.";
        
        if (available_clown_sources.count() > 0)
        {
            if (clownosity_possible >= clownosity_needed)
            {
                string line2 = "Equip " + suggested_outfit.listJoinComponents(", ", "and") + ".";
                if (__last_adventure_location == $location[The "Fun" House])
                    line2 = HTMLGenerateSpanFont(line2, "red");
                line += "|" + line2;
            }
            else
                line += "|Equip " + available_clown_sources.listJoinComponents(", ", "or") + ".";
        }
        if (missing_sources.count() > 0 && clownosity_possible < clownosity_needed)
        {
            if (!in_ronin())
                line += "|Could buy " + missing_sources.listJoinComponents(", ", "or") + ".";
            else
                line += "|Find sources in the Fun House.";
        }
        int delay_turns_remaining = delayRemainingInLocation($location[the "fun" house]);
        if (delay_turns_remaining > 0)
        {
            subentry.entries.listAppend(pluraliseWordy(delay_turns_remaining, "more turn", "more turns").capitaliseFirstLetter() + " before non-combat can show up.");
        }
        
        subentry.entries.listAppend(line);
        
    }
}

void QNemesisGenerateCaveTasks(ChecklistSubentry subentry, item legendary_epic_weapon)
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questG05Dark", true);
    
    //place.php?whichplace=mountains&action=mts_caveblocked leads to an non-leaving NC (skippable)
    //place.php?whichplace=nemesiscave
    
    subentry.entries.listAppend("Visit the sinister cave, solve the new quest.");
    subentry.modifiers.listAppend("+item");
}

RegisterGenerationFunction("QNemesisGenerate");
void QNemesisGenerate(ChecklistCollection checklists)
{

    
    /*
    mafia ordering:
    1 -> acquire disco banjo
    2 -> defeat the clown prince
    3 -> make shagadelic disco banjo, talk to your guild
    4 -> wait for guild to find out where your nemesis is hiding
    5 -> time to visit the dark and dank and sinister cave
    6 -> defeated nemesis in cave, let's go talk to the guild
    7 -> they aren't impressed, wait for assassins
    8 -> first assassin appeared
    9 -> first assassin defeated
    10 -> second assassin appeared
    11 -> second assassin defeated
    12 -> third assassin appeared
    13 -> third assassin defeated
    14 -> final assassin appeared
    15 -> final assassin defeated, go find the lair
    16 -> we're at the island, do island stuff
    17 -> "got away. Again."
    18 -> lava maze solved
    19 -> final form [cue music]

    (same ordering we use)
    */
    
    
	QuestState base_quest_state = __quest_state["Nemesis"];
	if (base_quest_state.finished)
		return;
    if (!($classes[seal clubber,turtle tamer,pastamancer,sauceror,disco bandit,accordion thief] contains my_class()))
        return;
    if (!__misc_state["guild open"])
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    string url = "";
    
    //volcanoMaze1 through volcanoMaze5 is relevant, blank when not available
    
    boolean have_legendary_epic_weapon = false;
    boolean have_epic_weapon = false;
    
    item [class] class_epic_weapons;
    item [class] class_legendary_epic_weapons;
    item [class] class_ultimate_legendary_epic_weapons;
    
    class_epic_weapons[$class[seal clubber]] = $item[bjorn's hammer];
    class_epic_weapons[$class[turtle tamer]] = $item[mace of the tortoise];
    class_epic_weapons[$class[pastamancer]] = $item[pasta spoon of peril];
    class_epic_weapons[$class[sauceror]] = $item[5-alarm saucepan];
    class_epic_weapons[$class[disco bandit]] = $item[disco banjo];
    class_epic_weapons[$class[accordion thief]] = $item[rock and roll legend];
    item epic_weapon = class_epic_weapons[my_class()];
    
    
    class_legendary_epic_weapons[$class[seal clubber]] = $item[hammer of smiting];
    class_legendary_epic_weapons[$class[turtle tamer]] = $item[chelonian morningstar];
    class_legendary_epic_weapons[$class[pastamancer]] = $item[greek pasta spoon of peril];
    class_legendary_epic_weapons[$class[sauceror]] = $item[17-alarm saucepan];
    class_legendary_epic_weapons[$class[disco bandit]] = $item[shagadelic disco banjo];
    class_legendary_epic_weapons[$class[accordion thief]] = $item[squeezebox of the ages];
    item legendary_epic_weapon = class_legendary_epic_weapons[my_class()];
    
    
    
    class_ultimate_legendary_epic_weapons[$class[seal clubber]] = $item[Sledgehammer of the V&aelig;lkyr];
    class_ultimate_legendary_epic_weapons[$class[turtle tamer]] = $item[Flail of the Seven Aspects];
    class_ultimate_legendary_epic_weapons[$class[pastamancer]] = $item[Wrath of the Capsaician Pastalords];
    class_ultimate_legendary_epic_weapons[$class[sauceror]] = $item[Windsor Pan of the Source];
    class_ultimate_legendary_epic_weapons[$class[disco bandit]] = $item[Seeger's Unstoppable Banjo];
    class_ultimate_legendary_epic_weapons[$class[accordion thief]] = $item[The Trickster's Trikitixa];
    item ultimate_legendary_epic_weapon = class_ultimate_legendary_epic_weapons[my_class()];
    
    if (epic_weapon.available_amount_ignoring_storage() > 0)
        have_epic_weapon = true;
    if (legendary_epic_weapon.available_amount_ignoring_storage() > 0)
        have_legendary_epic_weapon = true;
        
	if (!__misc_state["in aftercore"] && !have_legendary_epic_weapon && $location[the unquiet garves].turns_spent == 0 && false)
		return;
        
        
    string [class] first_boss_name;
    first_boss_name[$class[Seal Clubber]] = "Gorgolok, the Infernal Seal";
    first_boss_name[$class[Turtle Tamer]] = "Stella, the Turtle Poacher";
    first_boss_name[$class[Pastamancer]] = "Spaghetti Elemental";
    first_boss_name[$class[Sauceror]] = "Lumpy, the Sinister Sauceblob";
    first_boss_name[$class[Disco Bandit]] = "The Spirit of New Wave";
    first_boss_name[$class[Accordion Thief]] = "Somerset Lopez, Dread Mariachi";
    
    if (!base_quest_state.started)
    {
    	//don't beckon them to start it
        return;   
        /*subentry.entries.listAppend("Speak to your guild to start the quest.|Then adventure in the Unquiet Garves until you unlock the tomb of the unknown, and solve the puzzle.");
        url = "guild.php";*/
    }
    else if (base_quest_state.mafia_internal_step <= 4)
    {
        //1	One of your guild leaders has tasked you to recover a mysterious and unnamed artifact stolen by your Nemesis. Your first step is to smith an Epic Weapon
        
        //1 can be when Tomb of the Unknown Your Class Here is unlocked (think there's a missing quest step here?)
        //2 can be fighting ghost
        //4 can be nearing end
        //5 -> return it
        //6 -> returning (?
        if (have_epic_weapon && false) //not true anymore
        {
            subentry.entries.listAppend("Speak to your guild.");
            url = "guild.php";
        }
        else
        {
            item starter_item_needed;
            if (my_class() == $class[seal clubber])
                starter_item_needed = $item[seal-clubbing club];
            else if (my_class() == $class[turtle tamer])
                starter_item_needed = $item[helmet turtle];
            else if (my_class() == $class[pastamancer])
                starter_item_needed = $item[pasta spoon];
            else if (my_class() == $class[sauceror])
                starter_item_needed = $item[saucepan];
            else if (my_class() == $class[disco bandit])
                starter_item_needed = $item[disco mask];
            else if (my_class() == $class[accordion thief])
                starter_item_needed = $item[stolen accordion];
                
            //subentry.entries.listAppend("Acquire " + epic_weapon + ".");
            if (starter_item_needed.item_amount() == 0)
                subentry.entries.listAppend("Acquire a " + starter_item_needed + ".");
            else if ($location[The Unquiet Garves].noncombat_queue.contains_text("Tomb of the Unknown Your Class Here"))
            {
                subentry.entries.listAppend("Solve the three puzzles at the unknown tomb.");
            }
            else
                subentry.entries.listAppend("Adventure in the Unquiet Garves until you unlock the tomb of the unknown, then solve the three puzzles.");
            url = "place.php?whichplace=cemetery";
        }
    }
    else if (base_quest_state.mafia_internal_step == 5)
    {
        subentry.entries.listAppend("Speak to your guild.");
        url = "guild.php";
    }
    else if (base_quest_state.mafia_internal_step <= 6)
    {
        //6	To unlock the full power of the Legendary Epic Weapon, you must defeat Beelzebozo, the Clown Prince of Darkness,
        QNemesisGenerateClownTasks(subentry);
        url = "place.php?whichplace=plains";
    }
    else if (base_quest_state.mafia_internal_step >= 7 && base_quest_state.mafia_internal_step <= 9)
    {
        if (have_legendary_epic_weapon)
        {
            subentry.entries.listAppend("Speak to your guild.");
            url = "guild.php";
        }
        else
        {
            subentry.entries.listAppend("Make " + legendary_epic_weapon + ".");
        }
    }
    else if (base_quest_state.mafia_internal_step == 10)
    {
        //???
        subentry.entries.listAppend("Speak to your guild?");
    }
    else if (base_quest_state.mafia_internal_step >= 11 && base_quest_state.mafia_internal_step <= 16)
    {
        //QNemesisGenerateCaveTasks(subentry, legendary_epic_weapon);
        if (base_quest_state.mafia_internal_step == 11 || base_quest_state.mafia_internal_step == 12)
        {
            url = "place.php?whichplace=mountains";
            //The hunt for your Nemesis is on! Better check out that cave they sent you to.
            //Figure out how to get into your Nemesis' cave. If you're stumped, maybe your guild can help?
            
            skill skill_needed;
            string skill_choice_name;
            
            if (my_class() == $class[seal clubber])
            {
                skill_needed = $skill[wrath of the wolverine];
                skill_choice_name = "wolverine";
            }
            else if (my_class() == $class[disco bandit])
            {
                //Focus on your disco state of mind
                skill_needed = $skill[disco state of mind];
                skill_choice_name = "disco state of mind";
            }
            else if (my_class() == $class[sauceror])
            {
                skill_needed = $skill[stream of sauce];
                skill_choice_name = "stream of sauce";
            }
            else if (my_class() == $class[turtle tamer])
            {
                skill_needed = $skill[amphibian sympathy];
                skill_choice_name = "sympathize with an amphibian";
            }
            else if (my_class() == $class[pastamancer])
            {
                skill_needed = $skill[entangling noodles];
                skill_choice_name = "entangle the wall with noodles";
            }
            else if (my_class() == $class[accordion thief])
            {
                skill_needed = $skill[accordion bash];
                skill_choice_name = "bash the wall with your accordion";
            }
            //Stream of sauce?
            //entangling noodles?
            if (skill_needed != $skill[none] && !skill_needed.have_skill())
            {
                subentry.entries.listAppend("Learn " + skill_needed + " from guild trainer.");
                url = "guild.php?place=trainer";
            }
            else if (skill_needed != $skill[none])
            {
                subentry.entries.listAppend("Click on the nemesis cave, choose " + skill_choice_name + ".");
            }
            else
                subentry.entries.listAppend("Solve the cave entrance puzzle.");
        }
        else if (base_quest_state.mafia_internal_step >= 13 && base_quest_state.mafia_internal_step <= 15)
        {
            url = "place.php?whichplace=nemesiscave";
            //The cavern is full of weird mushrooms, but where's your Nemesis?
            //more fizzing spore pods to blow up the blockade in your Nemesis' cave.
            //Take those fizzing spore pods to the rubble!
            
            item needed_item = $item[fizzing spore pod];
            
            if (needed_item.available_amount() < 6)
            {
                subentry.modifiers.listAppend("+item");
                subentry.modifiers.listAppend("olfact angry mushroom guy");
                subentry.entries.listAppend("Adventure in the fungal nethers, collect " + pluraliseWordy(clampi(6 - needed_item.item_amount(), 0, 6), needed_item) + ", make rubble go boom!");
            }
            else
            {
                if (needed_item.item_amount() < 6)
                {
                    int delta = 6 - needed_item.item_amount();
                    subentry.entries.listAppend("Pull " + pluralise(delta, $item[fizzing spore pod]) + " from hangk's, make rubble go boom!");
                }
                else
                    subentry.entries.listAppend("Make rubble go boom!");
            }
        }
        else if (base_quest_state.mafia_internal_step == 16)
        {
            url = "place.php?whichplace=nemesiscave";
            //Boom! Time to bring the fight to your stinking Nemesis in that stinking cave!
            subentry.entries.listAppend("Fight your nemesis in the nemesis cave.");
            subentry.entries.listAppend("Do nemesis caves just get rented out on a time-share nemesis basis?|For the month of june, you'll be rueing the day! What? I paid how much?");
        }
    }
    else if (base_quest_state.mafia_internal_step >= 17 && base_quest_state.mafia_internal_step < 26)
    {
        //	You have successfully shown your Nemesis what for, and claimed an ancient hat of power. It's pretty sweet
        //	You showed the Epic Hat to the class leader back at your guild, but they didn't seem much impressed. I guess all this Nemesis nonsense isn't quite finished yet, but at least with your Nemesis in hiding again you won't have to worry about it for a while.
        //	It appears as though some nefarious ne'er-do-well has put a contract on your head
        //	You handily dispatched some thugs who were trying to collect on your bounty, but something tells you they won't be the last ones to try
        
        //	Whoever put this hit out on you (like you haven't guessed already) has sent Mob Penguins to do their dirty work. Do you know any polar bears you could hire as bodyguards
        //	So much for those mob penguins that were after your head! If whoever put this hit out on you wants you killed (which, presumably, they do) they'll have to find some much more competent thugs
        //	have been confirmed: your Nemesis has put the order out for you to be hunted down and killed, and now they're sending their own guys instead of contracting out
        //	Bam! So much for your Nemesis' assassins! If that's the best they've got, you have nothing at all to worry about
        //	You had a run-in with some crazy mercenary or assassin or... thing that your Nemesis sent to do you in once and for all. A run-in followed by a run-out, evidently,
        string assassin_up_next = "";
        int assassins_left = -1;
        
        if (true)
        {
            if (base_quest_state.mafia_internal_step < 20)
            {
                assassin_up_next = "menacing thug";
                assassins_left = 4;
            }
            else if (base_quest_state.mafia_internal_step < 22)
            {
                assassin_up_next = "Mob Penguin hitman";
                assassins_left = 3;
            }
            else if (base_quest_state.mafia_internal_step < 24)
            {
                if (my_class() == $class[seal clubber])
                    assassin_up_next = "hunting seal";
                else if (my_class() == $class[turtle tamer])
                    assassin_up_next = "turtle trapper";
                else if (my_class() == $class[pastamancer])
                    assassin_up_next = "evil spaghetti cult assassin";
                else if (my_class() == $class[sauceror])
                    assassin_up_next = "barnaise zombie";
                else if (my_class() == $class[disco bandit])
                    assassin_up_next = "flock of seagulls";
                else if (my_class() == $class[accordion thief])
                    assassin_up_next = "mariachi bandolero";
                
                assassins_left = 2;
            }
            else
            {
                if (my_class() == $class[seal clubber])
                    assassin_up_next = "Argarggagarg the Dire Hellseal";
                else if (my_class() == $class[turtle tamer])
                    assassin_up_next = "Safari Jack, Small-Game Hunter";
                else if (my_class() == $class[pastamancer])
                    assassin_up_next = "Yakisoba the Executioner";
                else if (my_class() == $class[sauceror])
                    assassin_up_next = "Heimandatz, Nacho Golem";
                else if (my_class() == $class[disco bandit])
                    assassin_up_next = "Jocko Homo";
                else if (my_class() == $class[accordion thief])
                    assassin_up_next = "The Mariachi With No Name";
                assassins_left = 1;
            }
        }
        
        if (assassins_left != -1)
        {
            string line = "Wait for " + pluraliseWordy(assassins_left, "more assassin", "more assassins");
            
            //int min_turns_left = 0;
            //int max_turns_left = 0;
            float average_turns_left = 0;
            
            int effective_assassins_left = assassins_left;
            //35 to 50
            Counter nemesis_assassin_window = CounterLookup("Nemesis Assassin");
            if (nemesis_assassin_window.CounterExists() && nemesis_assassin_window.CounterIsRange())
            {
                //min_turns_left += nemesis_assassin_window.range_start_turn;
                //max_turns_left += nemesis_assassin_window.range_end_turn;
                average_turns_left += (nemesis_assassin_window.range_start_turn + nemesis_assassin_window.range_end_turn).to_float() / 2.0;
                effective_assassins_left -= 1;
            }
            
            
            effective_assassins_left = clampi(effective_assassins_left, 0, 4);
            //min_turns_left += 35 * effective_assassins_left;
            //max_turns_left += 50 * effective_assassins_left;
            average_turns_left += 42.5 * effective_assassins_left.to_float();
            
            //I wonder if showing max_turns_left would be less confusing here...
            line += " over ~" + average_turns_left.roundForOutput(0) + " turns.";
            subentry.entries.listAppend(line);
        }
        else
            subentry.entries.listAppend("Wait for assassins.");
        
        //if (base_quest_state.mafia_internal_step < 20)
            //subentry.entries.listAppend("Umm... you may need to talk to your guild(?)|Something about this step is weird.");
            
        if (assassin_up_next != "")
            subentry.entries.listAppend(assassin_up_next.capitaliseFirstLetter() + " up next.");
            
        if (my_basestat(my_primestat()) < 90)
            subentry.entries.listAppend("Level to 90 " + my_primestat().to_lower_case() + ".");
        
        if (my_class() == $class[pastamancer] && my_thrall() != $thrall[spaghetti elemental] && $skill[bind spaghetti elemental].have_skill() && $thrall[spaghetti elemental].level < 3)
        {
            subentry.entries.listAppend("Cast Bind Spaghetti Elemental to level up your spaghetti elemental to three in advance.");
        }
        if (base_quest_state.mafia_internal_step == 17)
        {
            subentry.entries.listAppend("Possibly speak to your guild?");
            url = "guild.php";
        }
    }
    else if (base_quest_state.mafia_internal_step == 15 && false)
    {
        //	Now that you've dealt with your Nemesis' assassins and found a map to the secret tropical island volcano lair, it's time to take the fight to your foe. Booyah
        //find island
        url = "inventory.php?which=3";
        subentry.entries.listAppend("Use the secret tropical island volcano lair map.");
    }
    else if (base_quest_state.mafia_internal_step == 27 || base_quest_state.mafia_internal_step == 26) //mafia bug(?) - doesn't advance properly
    {
        //	You've arrived at the secret tropical island volcano lair, and it's time to finally put a stop to this Nemesis nonsense once and for all. As soon as you can find where they're hiding. Maybe you can find someone to ask
        if ($location[The Nemesis' Lair].turnsAttemptedInLocation() > 0)
        {
            if (my_class() == $class[disco bandit])
                subentry.entries.listAppend("Fight daft punk, then your nemesis face to face.|Then solve the volcano maze.");
            else
                subentry.entries.listAppend("Fight goons, then your nemesis.|Then solve the volcano maze.");
        }
        else
            QNemesisGenerateIslandTasks(subentry);
        url = "volcanoisland.php";
    }
    else if (base_quest_state.mafia_internal_step >= 28 && base_quest_state.mafia_internal_step <= 30)
    {
        //	Congratulations on solving the lava maze, which is probably the biggest pain-in-the-ass puzzle in the entire game! Hooray! (Unless you cheated, in which case
        if (base_quest_state.mafia_internal_step == 21)
            subentry.entries.listAppend("Solve the volcano maze, then fight your nemesis.");
        else
            subentry.entries.listAppend("Fight your nemesis.");
        url = "volcanomaze.php";
        if (legendary_epic_weapon.equipped_amount() == 0 && ultimate_legendary_epic_weapon.equipped_amount() == 0)
            subentry.entries.listAppend("Equip " + legendary_epic_weapon + ".");
        if (my_class() == $class[sauceror])
        {
            string [int] missing_saucespheres;
            foreach s in $skills[elemental saucesphere,Jalape&ntilde;o Saucesphere,antibiotic saucesphere,scarysauce]
            {
                effect e = s.to_effect();
                if (e.have_effect() > 0)
                    continue;
                string line = s.to_string();
                
                if (!s.skill_is_usable())
                    line = HTMLGenerateSpanFont(line, "grey");
                
                missing_saucespheres.listAppend(line);
            }
            if (missing_saucespheres.count() > 0)
            {
                subentry.entries.listAppend("Acquire saucespheres: " + missing_saucespheres.listJoinComponents(", ", "and") + ".");
            }
        }
        if (my_class() == $class[pastamancer])
        {
            subentry.entries.listAppend("Run a potato familiar, and alternate casting entangling noodles twice/some sort of attack to keep the demon blocked.");
        }
    }
    
    boolean [location] relevant_locations;
    foreach l in $locations[the unquiet garves,the "fun" house, the nemesis' lair, the broodling grounds, the outer compound, the temple portico, convention hall lobby, outside the club, the island barracks, the poop deck]
        relevant_locations[l] = true;
    relevant_locations[$location[the fungal nethers]] = true;
	checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(94, base_quest_state.image_name, url, subentry, relevant_locations));
}
//merkinQuestPath

void QSeaInit()
{
    
    //Have they adventured anywhere underwater?
    boolean have_adventured_in_relevant_area = false;
    foreach l in $locations[the briny deeps, the brinier deepers, the briniest deepests, an octopus's garden,the wreck of the edgar fitzsimmons, the mer-kin outpost, madness reef,the marinara trench, the dive bar,anemone mine, the coral corral, mer-kin elementary school,mer-kin library,mer-kin gymnasium,mer-kin colosseum,the caliginous abyss]
    {
        if (l.turnsAttemptedInLocation() > 0 || my_location() == l)
        {
            have_adventured_in_relevant_area = true;
            break;
        }
    }
    //don't list the quest unless they've started on the path under the sea:
    if (!have_adventured_in_relevant_area && $items[Mer-kin trailmap,Mer-kin lockkey,Mer-kin stashbox,wriggling flytrap pellet,damp old boot,Grandma's Map,Grandma's Chartreuse Yarn,Grandma's Fuchsia Yarn,Grandma's Note].available_amount() == 0)
        return;
        
    
	//FIXME support mom
    if (true)
    {
        QuestState state;
        
        string quest_path = get_property("merkinQuestPath");
        if (quest_path == "done")
            QuestStateParseMafiaQuestPropertyValue(state, "finished");
        else
        {
            QuestStateParseMafiaQuestPropertyValue(state, "started");
        }
        
        state.quest_name = "Sea Quest";
        state.image_name = "Sea";
        
        __quest_state["Sea Temple"] = state;
    }
    if (true)
    {
        QuestState state;
        
        QuestStateParseMafiaQuestProperty(state, "questS02Monkees", false); //don't issue a quest load
        state.quest_name = "Hey, Hey, They're Sea Monkees";
        state.image_name = "Sea";
        
        
        __quest_state["Sea Monkees"] = state;
    }
}

void QSeaGenerateTempleEntry(ChecklistSubentry subentry, StringHandle image_name)
{
    string path = get_property("merkinQuestPath");
    
    boolean can_fight_dad_sea_monkee = $items[Goggles of Loathing,Stick-Knife of Loathing,Scepter of Loathing,Jeans of Loathing,Treads of Loathing,Belt of Loathing,Pocket Square of Loathing].items_missing().count() <= 1;
    
    boolean have_one_outfit = false;
    if (can_fight_dad_sea_monkee)
        have_one_outfit = true;
    foreach outfit_name in $strings[Mer-kin Scholar's Vestments,Mer-kin Gladiatorial Gear,Crappy Mer-kin Disguise]
    {
        if (have_outfit_components(outfit_name))
        {
            have_one_outfit = true;
            break;
        }
    }
    
    
    if (!have_one_outfit)
    {
        subentry.entries.listAppend("Acquire crappy mer-kin disguise from grandma sea monkee.");
        return;
    }
    
    boolean at_boss = false;
    boolean at_gladiator_boss = false;
    boolean at_scholar_boss = false;
    if (path == "gladiator")
    {
        image_name.s = "Shub-Jigguwatt";
        at_gladiator_boss = true;
    }
    else if (path == "scholar")
    {
        image_name.s = "Yog-Urt";
        at_scholar_boss = true;
    }
    at_boss = at_gladiator_boss || at_scholar_boss;
    
    if (!at_boss || at_gladiator_boss)
    {
        string [int] description;
        string [int] modifiers;
        //gladiator:
        if (at_gladiator_boss)
        {
            description.listAppend("Buff muscle, equip a powerful weapon.");
            description.listAppend("Delevel him with crayon shavings for a bit, then attack with your weapon.");
            description.listAppend("Make sure not to have anything along that will attack him. (familiars, etc)");
            //umm... this probably won't be updated:
            string [int] things_to_do;
            foreach it in $items[hand in glove,MagiMechTech NanoMechaMech,bottle opener belt buckle,old school calculator watch,ant hoe,ant pick,ant pitchfork,ant rake,ant sickle,fishy wand,moveable feast,oversized fish scaler,plastic pumpkin bucket,tiny bowler,cup of infinite pencils,double-ice box,smirking shrunken head,mr. haggis,stapler bear,dubious loincloth,muddy skirt,bottle of Goldschn&ouml;ckered,acid-squirting flower,ironic oversized sunglasses,hippy protest button,cannonball charrrm bracelet,groovy prism necklace,spiky turtle shoulderpads,double-ice cap,parasitic headgnawer,eelskin hat,balloon shield,hot plate,Ol' Scratch's stove door,Oscus's garbage can lid,eelskin shield,eelskin pants]
            {
                if (it.equipped_amount() > 0)
                    things_to_do.listAppend("unequip " + it);
            }
            foreach e in $effects[Skeletal Warrior,Skeletal Cleric,Skeletal Wizard,Bone Homie,Burning\, Man,Biologically Shocked,EVISCERATE!,Fangs and Pangs,Permanent Halloween,Curse of the Black Pearl Onion,Long Live GORF,Apoplectic with Rage,Dizzy with Rage,Quivering with Rage,Jaba&ntilde;ero Saucesphere,Psalm of Pointiness,Drenched With Filth,Stuck-Up Hair,It's Electric!,Smokin',Jalape&ntilde;o Saucesphere,Scarysauce,spiky shell]
            {
                if (e.have_effect() > 0)
                    things_to_do.listAppend("uneffect " + e);
            }
            if (things_to_do.count() > 0)
                description.listAppend(HTMLGenerateSpanFont(things_to_do.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".", "red"));
            
            if ($item[dark porquoise ring].equipped_amount() == 0)
            {
                string line = "Possibly ";
                if ($item[dark porquoise ring].available_amount() == 0)
                    line += "acquire and ";
                line += "equip a dark porquoise ring to use less crayon shavings.";
                description.listAppend(line);
            }
            if ($effect[Ruthlessly Efficient].have_effect() == 0)
            {
                if ($skill[Ruthless Efficiency].have_skill())
                {
                    description.listAppend("Possibly cast Ruthless Efficiency to delevel faster.");
                }
                else if ($item[Crimbot ROM: Ruthless Efficiency (dirty)].available_amount() > 0)
                {
                    description.listAppend("Possibly use Crimbot ROM: Ruthless Efficiency (dirty) and cast it to delevel faster.");
                }
                else if ($item[Crimbot ROM: Ruthless Efficiency].available_amount() > 0)
                {
                    description.listAppend("Possibly use Crimbot ROM: Ruthless Efficiency and cast it to delevel faster.");
                }
            }
            if (my_mp() > 0)
                description.listAppend(HTMLGenerateSpanFont("Try to reduce your MP to 0", "red") + " before fighting him.");
        }
        else
        {
            if (!have_outfit_components("Mer-kin Gladiatorial Gear"))
            {
                description.listAppend("Acquire gladiatorial outfit.|Components can be found by running +combat in the gymnasium.");
                modifiers.listAppend("+combat");
            }
            else
            {
                string shrap_suggestion = "Shrap is nice for this.";
                if (!$skill[shrap].skill_is_usable())
                {
                    if ($item[warbear metalworking primer (used)].available_amount() > 0)
                    {
                        shrap_suggestion += " (use your used copy of warbear metalworking primer)";
                    }
                    else
                        shrap_suggestion += " (from warbear metalworking primer)";
                }
                modifiers.listAppend("spell damage percent");
                modifiers.listAppend("mysticality");
                description.listAppend("Fight in the colosseum!");
                description.listAppend("Easy way is to buff mysticality and spell damage percent, then cast powerful spells.<br>" + shrap_suggestion);
                description.listAppend("There's another way, but it's a bit complicated. Check the wiki?");
            }
        }
        string modifier_string = "";
        if (modifiers.count() > 0)
            modifier_string = ChecklistGenerateModifierSpan(modifiers);
        if (description.count() > 0)
            subentry.entries.listAppend("Gladiator path" +  HTMLGenerateIndentedText(modifier_string + description.listJoinComponents("<hr>")));
    }
    if (!at_boss || at_scholar_boss)
    {
        string [int] description;
        string [int] modifiers;
        //scholar:
        if (at_scholar_boss)
        {
            description.listAppend("Wear several mer-kin prayerbeads and possibly a mer-kin gutgirdle.");
            description.listAppend("Avoid wearing any +hp gear or buffs. Ideally, you want low HP.");
            description.listAppend("Each round, use a different healing item, until you lose the Suckrament effect.<br>After that, your stats are restored. Fully heal, then " + HTMLGenerateSpanOfClass("attack with elemental damage", "r_bold") + ".");
            string [item] potential_healers;
            potential_healers[$item[mer-kin healscroll]] = "mer-kin healscroll (full HP)";
            potential_healers[$item[scented massage oil]] = "scented massage oil (full HP)";
            potential_healers[$item[soggy used band-aid]] = "soggy used band-aid (full HP)";
            potential_healers[$item[extra-strength red potion]] = "extra-strength red potion (+200 HP)";
            potential_healers[$item[red pixel potion]] = "red pixel potion (+100-120 HP)";
            potential_healers[$item[red potion]] = "red potion (+100 HP)";
            potential_healers[$item[filthy poultice]] = "filthy poultice (+80-120 HP)";
            potential_healers[$item[gauze garter]] = "gauze garter (+80-120 HP)";
            potential_healers[$item[green pixel potion]] = "green pixel potion (+40-60 HP)";
            potential_healers[$item[cartoon heart]] = "cartoon heart (40-60 HP)";
            potential_healers[$item[red plastic oyster egg]] = "red plastic oyster egg (+35-40 HP)";
            string [int] description_healers;
            
            foreach it in potential_healers
            {
                if (it.item_amount() > 0)
                    description_healers.listAppend(potential_healers[it]);
                else
                    description_healers.listAppend(HTMLGenerateSpanFont(potential_healers[it], "red"));
            }
            description.listAppend("Potential healing items:|*" + description_healers.listJoinComponents("|*"));
        }
        else
        {
            if (!have_outfit_components("Mer-kin Scholar's Vestments"))
            {
                description.listAppend("Acquire scholar outfit.|Components can be found by running -combat in the elementary school.");
                modifiers.listAppend("-combat");
            }
            else
            {
                if ($item[Mer-kin dreadscroll].available_amount() == 0)
                {
                    description.listAppend("Adventure in the library. Find the dreadscroll.");
                    modifiers.listAppend("-combat");
                }
                else
                {
                    if ($effect[deep-tainted mind].have_effect() > 0)
                        description.listAppend("Solve the dreadscroll.<br>Wait for Deep-Tainted Mind to wear off.");
                    else
                        description.listAppend("Solve the dreadscroll.");
                        
                    string [int] unknown_clues;
                    
                    /*
                    Mer-kin Library 1 -> dreadScroll1
                    Mer-kin healscroll -> dreadScroll2
                    Deep Dark Visions -> dreadScroll3
                    Mer-kin knucklebone -> dreadScroll4
                    Mer-kin killscroll -> dreadScroll5
                    Mer-kin Library 2 -> dreadScroll6
                    Mer-kin worktea -> dreadScroll7
                    Mer-kin Library 3 -> dreadScroll8
                    */
                    
                    int library_clues_known = 0;
                    if (get_property_int("dreadScroll1") > 0)
                        library_clues_known += 1;
                    if (get_property_int("dreadScroll6") > 0)
                        library_clues_known += 1;
                    if (get_property_int("dreadScroll8") > 0)
                        library_clues_known += 1;
                    
                    boolean need_to_learn_vocabulary = false;
                    
                    if (library_clues_known < 3)
                    {
                        unknown_clues.listAppend((3 - library_clues_known).int_to_wordy().capitaliseFirstLetter() + " non-combats in the library. (vocabulary)");
                        need_to_learn_vocabulary = true;
                    }
                    if (get_property_int("dreadScroll5") == 0)
                    {
                        unknown_clues.listAppend("Use a mer-kin killscroll in combat. (vocabulary)");
                        need_to_learn_vocabulary = true;
                    }
                    if (get_property_int("dreadScroll2") == 0)
                    {
                        unknown_clues.listAppend("Use a mer-kin healscroll in combat. (vocabulary)");
                        need_to_learn_vocabulary = true;
                    }
                    if (get_property_int("dreadScroll4") == 0)
                        unknown_clues.listAppend("Use a mer-kin knucklebone.");
                    if (get_property_int("dreadScroll3") == 0)
                        unknown_clues.listAppend("Cast deep dark visions.");
                    if (get_property_int("dreadScroll7") == 0)
                        unknown_clues.listAppend("Eat sushi with mer-kin worktea.");
                    
                    if (unknown_clues.count() > 0)
                        description.listAppend("Clues are from:|*-" + unknown_clues.listJoinComponents("|*-"));
                    
                    int known_clue_count = 0;
                    for i from 1 to 8
                    {
                        string property_name = "dreadScroll" + i;
                        int property_value = get_property_int(property_name);
                        
                        if (property_value >= 1 && property_value <= 4)
                        {
                            known_clue_count += 1;
                        }
                    }
                    
                    if (need_to_learn_vocabulary)
                    {
                        int vocabulary = get_property_int("merkinVocabularyMastery");
                        if (vocabulary < 100)
                        {
                            int word_quizzes_needed = clampi(10 - vocabulary / 10, 1, 10);
                            description.listAppend("At " + (vocabulary) + "% Mer-Kin vocabulary. (use " + pluralise(word_quizzes_needed, $item[mer-kin wordquiz]) + " with a mer-kin cheatsheet)");
                        }
                        else
                            description.listAppend("Mer-Kin vocabulary mastered.");
                    }
                    if (known_clue_count > 0)
                    {
                        if (known_clue_count == 8)
                            description.listAppend("Have all clues.");
                        else
                            description.listAppend("Have " + known_clue_count + " out of 8 clues.");
                    }
                }
            }
        }
        string modifier_string = "";
        if (modifiers.count() > 0)
            modifier_string = ChecklistGenerateModifierSpan(modifiers);
        if (description.count() > 0)
            subentry.entries.listAppend("Scholar path" +  HTMLGenerateIndentedText(modifier_string + description.listJoinComponents("<hr>")));
    }
    if (!at_boss && can_fight_dad_sea_monkee)
    {
        string [int] description;
        
        description.listAppend("Equip Clothing of Loathing, go to the temple.");
        description.listAppend("Cast 120MP hobopolis spells at him.");
        description.listAppend("Use Mafia's \"dad\" GCLI command to see which element to use which round.");
        if (my_mp() < 1200)
            description.listAppend("Will need 1200MP, or less if using shrap/volcanometeor showeruption.");
            
        string [int] modifiers_needed_150;
        foreach s in $stats[]
        {
            if (s.my_basestat() < 150)
                modifiers_needed_150.listAppend((150 - s.my_basestat()) + " more " + s.to_lower_case());
        }
        
        if (modifiers_needed_150.count() > 0)
            description.listAppend("Need " + modifiers_needed_150.listJoinComponents(", ", "and") + " to wear Clothing of Loathing.");
        
        if (description.count() > 0)
            subentry.entries.listAppend("Dad sea monkee path" + HTMLGenerateIndentedText(description.listJoinComponents("<hr>")));
    }
    
    item [class] class_to_scholar_item;
    item [class] class_to_gladiator_item;
    
    class_to_scholar_item[$class[seal clubber]] = $item[Cold Stone of Hatred];
    class_to_scholar_item[$class[turtle tamer]] = $item[Girdle of Hatred];
    class_to_scholar_item[$class[pastamancer]] = $item[Staff of Simmering Hatred];
    class_to_scholar_item[$class[sauceror]] = $item[Pantaloons of Hatred];
    class_to_scholar_item[$class[disco bandit]] = $item[Fuzzy Slippers of Hatred];
    class_to_scholar_item[$class[accordion thief]] = $item[Lens of Hatred];
    
    class_to_gladiator_item[$class[seal clubber]] = $item[Ass-Stompers of Violence];
    class_to_gladiator_item[$class[turtle tamer]] = $item[Brand of Violence];
    class_to_gladiator_item[$class[pastamancer]] = $item[Novelty Belt Buckle of Violence];
    class_to_gladiator_item[$class[sauceror]] = $item[Lens of Violence];
    class_to_gladiator_item[$class[disco bandit]] = $item[Pigsticker of Violence];
    class_to_gladiator_item[$class[accordion thief]] = $item[Jodhpurs of Violence];
    
    item scholar_item = class_to_scholar_item[my_class()];
    item gladiator_item = class_to_gladiator_item[my_class()];
    
    if (!at_boss)
    {
        string line = "Can acquire " + scholar_item + " (scholar) or " + gladiator_item + " (gladiator)";
        if (can_fight_dad_sea_monkee)
            line += " or " + $item[pocket square of loathing] + " (dad)";
        subentry.entries.listAppend(line);
    }
    else if (at_gladiator_boss)
        subentry.entries.listAppend("Will acquire " + gladiator_item + ".");
    else if (at_scholar_boss)
        subentry.entries.listAppend("Will acquire " + scholar_item + ".");
}

//Hmm. Possibly show taffy in resources, if they're under the sea?

void QSeaGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState temple_quest_state = __quest_state["Sea Temple"];
	QuestState monkees_quest_state = __quest_state["Sea Monkees"];
	
	if (!__misc_state["in aftercore"] && !monkees_quest_state.started)
		return;
    
	boolean have_something_to_do_in_sea = false;
	if (!temple_quest_state.finished && (temple_quest_state.in_progress || temple_quest_state.startable))
		have_something_to_do_in_sea = true;
		
	ChecklistSubentry subentry;
	string image_name = temple_quest_state.image_name;
	
	subentry.header = temple_quest_state.quest_name;
	string url = "seafloor.php";
    boolean need_minus_combat_modifier = false;
	
    
    if ($effect[fishy].have_effect() == 0)
    {
        string line = "Acquire fishy.|*Easy way: Semi-rare in the brinier deeps, 50 turns.";
        if ($item[fishy pipe].available_amount() > 0 && !get_property_boolean("_fishyPipeUsed"))
            line += "|*Use fishy pipe.";
        subentry.entries.listAppend(line);
    }
        
	if (!temple_quest_state.finished)
	{
		if (get_property("seahorseName").length() == 0)
		{
            boolean professional_roper = false;
            //merkinLockkeyMonster questS01OldGuy questS02Monkees
			//Need to reach the temple:
			if (get_property("lassoTraining") != "expertly")
			{
				string line = "";
				if ($item[sea lasso].item_amount() == 0)
					line += HTMLGenerateSpanFont((in_ronin() ? "Acquire" : "Buy") + " and use a sea lasso in each combat.", "red");
				else
					line += "Use a sea lasso in each combat.";
				if ($item[sea cowboy hat].equipped_amount() == 0)
					line += "|*Wear a sea cowboy hat to improve roping.";
				if ($item[sea chaps].equipped_amount() == 0)
					line += "|*Wear sea chaps to improve roping.";
				subentry.entries.listAppend(line);
			}
            else
            {
                professional_roper = true;
				string line = "";
				if ($item[sea lasso].item_amount() == 0)
					line += "Buy a sea lasso.";
				if ($item[sea cowbell].item_amount() <3 )
                {
                    int needed_amount = MAX(3 - $item[sea cowbell].item_amount(), 0);
                    if (line != "") line += " ";
					line += "Buy " + pluraliseWordy(needed_amount, "sea cowbell", "sea cowbells") + ".";
                }
                if (line != "")
                    subentry.entries.listAppend(line);
            }
            location class_grandpa_location;
            if (my_primestat() == $stat[muscle])
                class_grandpa_location = $location[Anemone Mine];
            if (my_primestat() == $stat[mysticality])
                class_grandpa_location = $location[The Marinara Trench];
            if (my_primestat() == $stat[moxie])
                class_grandpa_location = $location[the dive bar];
            
            int grandpa_ncs_remaining = 3;
            
            //Match NC names to prevent other NCs interfering with tracking:
            int [string] noncombat_names;
            noncombat_names["Lost and Found and Lost Again"] = 2;
            noncombat_names["Respect Your Elders"] = 1;
            noncombat_names["You've Hit Bottom"] = 0;
            noncombat_names["Kids Today"] = 1;
            noncombat_names["Not a Micro Fish"] = 0;
            noncombat_names["No Country Music for Old Men"] = 2;
            noncombat_names["Salty Old Men"] = 1;
            noncombat_names["Boxing the Juke"] = 0;
            noncombat_names["Bar Hunting"] = 2;
            noncombat_names["The Salt of the Sea"] = 1;
            noncombat_names["Ode to the Sea"] = 0;
            foreach nc in noncombat_names
            {
                if (class_grandpa_location.noncombat_queue.contains_text(nc))
                    grandpa_ncs_remaining = MIN(grandpa_ncs_remaining, noncombat_names[nc]);
            }
            
            //Detect where we are:
            //This won't work beyond talking to little brother, my apologies
            if ($location[the coral corral].turnsAttemptedInLocation() > 0)
            {
                //Coral corral. Banish strategy.
                string sea_horse_details;
                if (!professional_roper)
                    sea_horse_details = "|But first, train up your roping skills.";
                else
                    sea_horse_details = "|Once found, use three sea cowbells on him, then a sea lasso.";
                subentry.entries.listAppend("Look for your sea horse in the Coral Corral." + sea_horse_details);
                string [int] banish_monsters;
                monster [int] monster_list = $location[the coral corral].get_monsters();
                foreach key in monster_list
                {
                    monster m = monster_list[key];
                    if (!m.is_banished() && m != $monster[wild seahorse])
                        banish_monsters.listAppend(m.to_string());
                }
                if (banish_monsters.count() > 1)
                    subentry.entries.listAppend("Banish " + banish_monsters.listJoinComponents(", ", "and") + " with separate banish sources to speed up area.");
            }
            else if (false)
            {
                //Ask grandpa about currents.
            }
            else if (false)
            {
                //Use trailmap.
            }
            else if (false)
            {
                //Then stash box. Mention monster source.
            }
            else if ($location[the mer-kin outpost].turnsAttemptedInLocation() > 0 || grandpa_ncs_remaining == 0)
            {
                //Find lockkey as well.
                if ($item[Mer-kin trailmap].available_amount() > 0)
                {
                    subentry.entries.listAppend("Use Mer-kin trailmap.");
                }
                else if ($item[Mer-kin lockkey].available_amount() == 0)
                {
                    subentry.entries.listAppend("Ask grandpa about his wife, then adventure in the Mer-Kin outpost to acquire a lockkey.");
                    subentry.entries.listAppend("Unless you unlocked the currents already, in which case go to the corral.");
                }
                else if ($item[Mer-kin stashbox].available_amount() == 0)
                {
                    string nc_details = "";
                    monster lockkey_monster = get_property_monster("merkinLockkeyMonster");
                    if (lockkey_monster == $monster[Mer-kin burglar])
                    {
                        nc_details = "Stashbox is in the camouflaged tent.";
                    }
                    else if (lockkey_monster == $monster[Mer-kin raider])
                    {
                        nc_details = "Stashbox is in the skull-bedecked tent.";
                    }
                    else if (lockkey_monster == $monster[Mer-kin healer])
                    {
                        nc_details = "Stashbox is in the glyphed tent.";
                    }
                    
                    need_minus_combat_modifier = true;
                    subentry.entries.listAppend("Adventure in the Mer-Kin outpost, find non-combat.|" + nc_details);
                }
                else
                {
                    subentry.entries.listAppend("Open stashbox.");
                }
                
            }
            else if (monkees_quest_state.mafia_internal_step == 5 || class_grandpa_location.turnsAttemptedInLocation() > 0)
            {
                //Find grandpa in one of the three zones.
                need_minus_combat_modifier = true;
                subentry.entries.listAppend("Find grandpa sea monkee in " + class_grandpa_location + ".|" + pluraliseWordy(grandpa_ncs_remaining, "non-combat remains", "non-combats remain").capitaliseFirstLetter() + ".");
            }
            else if (monkees_quest_state.mafia_internal_step == 4)
            {
                //Talk to little brother.
                subentry.entries.listAppend("Talk to little brother.");
                url = "monkeycastle.php";
            }
            else if (monkees_quest_state.mafia_internal_step == 3)
            {
                //Talk to big brother.
                subentry.entries.listAppend("Talk to big brother.");
                url = "monkeycastle.php";
            }
            else if (monkees_quest_state.mafia_internal_step == 2 || $location[The Wreck of the Edgar Fitzsimmons].turnsAttemptedInLocation() > 0)
            {
                //Adventure in wreck, free big brother.
                need_minus_combat_modifier = true;
                subentry.entries.listAppend("Free big brother. Adventure in the wreck.|Then talk to him and little brother, find grandpa.");
            }
            else if (monkees_quest_state.mafia_internal_step == 1)
            {
                if ($item[wriggling flytrap pellet].available_amount() > 0)
                {
                    url = "inventory.php?which=3";
                    subentry.entries.listAppend("Open a wriggling flytrap pellet, talk to little brother.");
                }
                else
                {
                    //Talk to little brother
                    subentry.entries.listAppend("Talk to little brother.");
                    url = "monkeycastle.php";
                }
            }
            else
            {
                //Octopus's garden, obtain wriggling flytrap pellet
                if ($item[wriggling flytrap pellet].available_amount() == 0)
                {
                    subentry.entries.listAppend("Adventure in octopus's garden, find a wriggling flytrap pellet from a Neptune flytrap.");
                    subentry.modifiers.listAppend("olfact Neptune flytrap");
                }
                else
                {
                    url = "inventory.php?which=3";
                    subentry.entries.listAppend("Open a wriggling flytrap pellet, talk to little brother.");
                }
            }
            
            //Find grandma IF they don't have a disguise/cloathing.
		}
		else
		{
            url = "seafloor.php?action=currents";
            StringHandle image_name_handle;
            image_name_handle.s = image_name;
            QSeaGenerateTempleEntry(subentry, image_name_handle);
            image_name = image_name_handle.s;
        }
	}
            
    if ($item[damp old boot].available_amount() > 0)
    {
        string [int] description;
        if ($item[fishy pipe].available_amount() == 0)
            description.listAppend("Choose the fishy pipe.");
        else if ($item[das boot].available_amount() == 0)
            description.listAppend("Choose the das boot.");
        else
            description.listAppend("Choose the damp old wallet.");
        
		optional_task_entries.listAppend(ChecklistEntryMake(61, "__item damp old boot", "place.php?whichplace=sea_oldman", ChecklistSubentryMake("Return damp old boot to the old man", "", description)));
        
    }
    if ($items[Grandma's Map,Grandma's Chartreuse Yarn,Grandma's Fuchsia Yarn,Grandma's Note].available_amount() > 0)
    {
        string line = "Optionally, rescue grandma.";
        if ($item[grandma's map].available_amount() > 0)
        {
            line += "|Adventure at the mer-kin outpost, find her.";
            need_minus_combat_modifier = true;
        }
        else
        {
            item [int] missing_items = $items[Grandma's Chartreuse Yarn,Grandma's Fuchsia Yarn,Grandma's Note].items_missing();
            
            if (missing_items.count() == 0)
            {
                line += "|Ask grandpa about the note.";
            }
            else
            {
                line += "|Adventure at the mer-kin outpost, find " + missing_items.listJoinComponents(", ", "and") + ".";
                need_minus_combat_modifier = true;
            }
        }
        subentry.entries.listAppend(line);
    }
    
    if (need_minus_combat_modifier)
        subentry.modifiers.listAppend("-combat");
	
	if (have_something_to_do_in_sea)
		optional_task_entries.listAppend(ChecklistEntryMake(62, image_name, url, subentry, $locations[the brinier deepers, an octopus's garden,the wreck of the edgar fitzsimmons, the mer-kin outpost, madness reef,the marinara trench, the dive bar,anemone mine, the coral corral, mer-kin elementary school,mer-kin library,mer-kin gymnasium,mer-kin colosseum,the caliginous abyss]));
}
void QSpaceElvesInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questF04Elves");
	
	state.quest_name = "Repair the Elves' Shield Generator Quest";
	state.image_name = "spooky little girl";
	
	if (my_basestat(my_primestat()) >= 12)
		state.startable = true;
		
	
	__quest_state["Space Elves"] = state;
}


void QSpaceElvesGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Space Elves"];
	if (base_quest_state.finished)
		return;
    
    string url = "place.php?whichplace=spaaace";
    
    boolean turns_spent_in_locations_already = false;
    if ($locations[Domed City of Ronaldus,Domed City of Grimacia,Hamburglaris Shield Generator].turnsAttemptedInLocation() > 0)
        turns_spent_in_locations_already = true;
    
    if (!turns_spent_in_locations_already && $effect[transpondent].have_effect() == 0) //suggest it when they go to spaaace, otherwise, don't bug them?
        return;
    if (in_ronin() && $effect[transpondent].have_effect() == 0 && $item[transporter transponder].available_amount() == 0)
        return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    subentry.entries.listAppend("Gives 200 lunar isotopes and Elvish Paradise access.");
    
	if (base_quest_state.mafia_internal_step < 3)
	{
		string [int] ronald_map_entries;
		string [int] grimace_map_entries;
		if ($item[e.m.u. rocket thrusters].available_amount() == 0)
			ronald_map_entries.listAppend("Ronald map" + __html_right_arrow_character + "Try the Swimming Pool" + __html_right_arrow_character + "To the Left, to the Left" + __html_right_arrow_character + "Take the Red Door");
		if ($item[E.M.U. joystick].available_amount() == 0)
			ronald_map_entries.listAppend("Ronald map" + __html_right_arrow_character + "Check out the Armory" + __html_right_arrow_character + "My Left Door" + __html_right_arrow_character + "Crawl through the Ventilation Duct");
		if ($item[E.M.U. harness].available_amount() == 0)
			grimace_map_entries.listAppend("Grimace map" + __html_right_arrow_character + "Check out the Coat Check" + __html_right_arrow_character + "Exit, Stage Left" + __html_right_arrow_character + "Be the Duke of the Hazard");
		if ($item[E.M.U. helmet].available_amount() == 0)
			grimace_map_entries.listAppend("Grimace map" + __html_right_arrow_character + "Check out the Coat Check" + __html_right_arrow_character + "Stage Right, Even" + __html_right_arrow_character + "Try the Starboard Door");
		if (ronald_map_entries.count() > 0)
		{
			string header = "Ronald prime:";
			string [int] line;
			int maps_needed = ronald_map_entries.count() - $item[map to safety shelter ronald prime].available_amount();
			if (maps_needed > 0)
            {
                if (subentry.modifiers.count() == 0)
                    subentry.modifiers.listAppend("+item");
				line.listAppend("Acquire " + pluralise(maps_needed, $item[map to safety shelter ronald prime]));
            }
			
            line.listAppendList(ronald_map_entries);
			
				
			subentry.entries.listAppend(header + HTMLGenerateIndentedText(line.listJoinComponents("<hr>")));
		}
		if (grimace_map_entries.count() > 0)
		{
			string header = "Grimace prime:";
			string [int] line;
			int maps_needed = grimace_map_entries.count() - $item[map to safety shelter grimace prime].available_amount();
			if (maps_needed > 0)
            {
                if (subentry.modifiers.count() == 0)
                    subentry.modifiers.listAppend("+item");
				line.listAppend("Acquire " + pluralise(maps_needed, $item[map to safety shelter grimace prime]));
            }
				
            line.listAppendList(grimace_map_entries);
			subentry.entries.listAppend(header + HTMLGenerateIndentedText(line.listJoinComponents("<hr>")));
		}
		if (ronald_map_entries.count() == 0 && grimace_map_entries.count() == 0)
			subentry.entries.listAppend("Look for the spooky little girl on Grimacia or Ronaldus.");
        //else if ($items[map to safety shelter ronald prime, map to safety shelter grimace prime].available_amount() > 0)
        else if ((ronald_map_entries.count() > 0 && $item[map to safety shelter ronald prime].available_amount() > 0) || (grimace_map_entries.count() > 0 && $item[map to safety shelter grimace prime].available_amount() > 0))
            url = "inventory.php?which=3";
	}
	else if (base_quest_state.mafia_internal_step == 3)
	{
		if ($item[spooky little girl].equipped_amount() == 0)
			subentry.entries.listAppend("Equip spooky little girl.");
		else if ($item[spooky little girl].available_amount() == 0)
			subentry.entries.listAppend("spooky");
		else
		{
			subentry.entries.listAppend("Adventure in Grimacia with spooky little girl for eleven turns.");
		}
			
	}
	else if (base_quest_state.mafia_internal_step == 4)
	{
		if ($item[E.M.U. Unit].equipped_amount() == 0)
			subentry.entries.listAppend("Equip E.M.U. Unit.");
		else
			subentry.entries.listAppend("Adventure at the Hamburglaris Shield Generator, solve puzzle.");
	}
	if ($effect[Transpondent].have_effect() == 0)
	{
		subentry.entries.listClear();
        subentry.entries.listAppend("Gives 200 lunar isotopes and Elvish Paradise access.");
		subentry.entries.listAppend("Use transporter transponder to reach spaaace.");
        if ($item[transporter transponder].available_amount() > 0)
            url = "inventory.php?which=3";
        else
            url = "mall.php";
	}
	
	
	optional_task_entries.listAppend(ChecklistEntryMake(95, base_quest_state.image_name, url, subentry, $locations[domed city of ronaldus, domed city of grimacia,hamburglaris shield generator]));
}

void QAzazelInit()
{
	//questG04Azazel
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM10Azazel");
	
	state.quest_name = "Azazel Quest";
	state.image_name = "steel margarita";
	
	if (my_basestat(my_primestat()) >= 12 && __quest_state["Level 6"].finished)
		state.startable = true;
	
	__quest_state["Azazel"] = state;
}

record AzazelBandMember
{
    string name;
    item [int] desired_items;
};

AzazelBandMember AzazelBandMemberMake(string name, item [int] desired_items)
{
    AzazelBandMember result;
    result.name = name;
    result.desired_items = desired_items;
    return result;
}

AzazelBandMember AzazelBandMemberMake(string name, item it1, item it2)
{
    return AzazelBandMemberMake(name, listMake(it1, it2));
}

void listAppend(AzazelBandMember [int] list, AzazelBandMember entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void QAzazelGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Azazel"];
    
    foreach consumable in $items[steel lasagna,steel margarita,steel-scented air freshener]
    {
        if (consumable.available_amount() == 0)
            continue;
        ChecklistSubentry subentry;
        
        subentry.header = base_quest_state.quest_name;
        string line = "Consume " + consumable;
        if ((consumable == $item[steel lasagna] && availableFullness() < 5) || (consumable == $item[steel-scented air freshener] && availableSpleen() < 5))
            line += " once you have enough space";
        line += ".";
        subentry.entries.listAppend(line);
        optional_task_entries.listAppend(ChecklistEntryMake(5, base_quest_state.image_name, "", subentry));
        return;
    }
    
	if (base_quest_state.finished)
		return;
    
    
    if ($skill[Stomach of Steel].skill_is_usable() || $skill[Liver of Steel].skill_is_usable() || $skill[Spleen of Steel].skill_is_usable())
        return;
    
    if (!__quest_state["Level 6"].finished)
        return;
    
    //We don't suggest or give advice on this quest in-run unless the player spends an adventure in one of the zones.
    //If that happens, they're probably sure they want the consumable items.
	if (!__misc_state["in aftercore"] && $locations[The Laugh Floor, Infernal Rackets Backstage].turnsAttemptedInLocation() == 0 && $items[Azazel's unicorn,Azazel's lollipop,Azazel's tutu].available_amount() == 0 && !in_bad_moon())
		return;
    
        
	ChecklistEntry entry = ChecklistEntryMake(6);
	entry.url = "pandamonium.php";
	entry.image_lookup_name = base_quest_state.image_name;
	entry.should_indent_after_first_subentry = true;
    entry.should_highlight = $locations[the laugh floor, infernal rackets backstage] contains __last_adventure_location;
    
    if (true)
    {
        ChecklistSubentry subentry;
        
        subentry.header = base_quest_state.quest_name;
        
        subentry.entries.listAppend("Gives +5 consumable space.");
        
        if ($item[Azazel's unicorn].available_amount() > 0 && $item[Azazel's lollipop].available_amount() > 0 && $item[Azazel's tutu].available_amount() > 0)
        {
            subentry.entries.listAppend("Speak to Azazel.");
        }
        entry.subentries.listAppend(subentry);
    }
    
    boolean need_imp_airs = false;
    boolean need_bus_passes = false;
    if ($item[Azazel's tutu].available_amount() == 0)
    {
        //collect 5 cans of imp air and 5 bus passes
        ChecklistSubentry subentry;
        
        subentry.header = "Azazel's tutu";
        
        int imp_air_needed = MAX(0, 5 - $item[imp air].available_amount());
        int bus_passes_needed = MAX(0, 5 - $item[bus pass].available_amount());
        if (imp_air_needed == 0 && bus_passes_needed == 0)
        {
        	if ($item[imp air].item_amount() < 5)
            	subentry.entries.listAppend("Pull imp air.");
            if ($item[bus pass].item_amount() < 5)
                subentry.entries.listAppend("Pull bus passes.");
            subentry.entries.listAppend("Speak to the stranger.");
        }
        else
        {
            if (imp_air_needed > 0)
            {
                string line;
                line = "Need " + pluralise(imp_air_needed, $item[imp air]) + ", from the laugh floor.";
                if (!in_ronin())
                    line += " Or the mall.";
                subentry.entries.listAppend(line);
                need_imp_airs = true;
            }
            if (bus_passes_needed > 0)
            {
                string line;
                line = "Need " + pluralise(bus_passes_needed, $item[bus pass]) + ", from backstage.";
                if (!in_ronin())
                    line += " Or the mall.";
                subentry.entries.listAppend(line);
                need_bus_passes = true;
            }
        }
        entry.subentries.listAppend(subentry);
    }
	
    
    if ($item[Azazel's unicorn].available_amount() == 0)
    {
        ChecklistSubentry subentry;
        
        subentry.header = "Azazel's unicorn";
        
        int [item] band_items_available;
        int band_items_found = 0;
        foreach it in $items[comfy pillow,giant marshmallow,booze-soaked cherry,sponge cake,beer-scented teddy bear,gin-soaked blotter paper]
        {
            if (it.available_amount() > 0)
                band_items_found += 1;
            band_items_available[it] = it.available_amount();
        }
        
        //Try to solve the puzzle:
        //Hmm... FIXME is there any way to determine which ones we've given to band members?
        
        AzazelBandMember [int] band_members;
        band_members.listAppend(AzazelBandMemberMake("Bognort", $item[giant marshmallow], $item[gin-soaked blotter paper]));
        band_members.listAppend(AzazelBandMemberMake("Stinkface", $item[beer-scented teddy bear], $item[gin-soaked blotter paper]));
        band_members.listAppend(AzazelBandMemberMake("Flargwurm", $item[booze-soaked cherry], $item[sponge cake]));
        band_members.listAppend(AzazelBandMemberMake("Jim", $item[sponge cake], $item[comfy pillow]));
        
        string [int] quest_completion_instructions;
        boolean can_complete_quest = true;
        foreach key in band_members
        {
            AzazelBandMember musician = band_members[key];
            boolean found_item = false;
            foreach key2 in musician.desired_items
            {
                item it = musician.desired_items[key2];
                if (band_items_available[it] > 0)
                {
                    quest_completion_instructions.listAppend("Give " + musician.name + " a " + it + ".");
                    band_items_available[it] -= 1;
                    found_item = true;
                    break;
                }
            }
            if (!found_item)
                can_complete_quest = false;
        }
        
        if (can_complete_quest)
        {
            if (need_bus_passes)
                subentry.entries.listAppend("Run +item backstage.");
            subentry.entries.listAppend("Talk to Sven.|*" + quest_completion_instructions.listJoinComponents("|*"));
        }
        else
        {
            string and_item = "";
            if (need_bus_passes)
                and_item = " and +item";
            subentry.entries.listAppend("Run -combat" + and_item + " backstage.");
            subentry.entries.listAppend("Need band components.");
            subentry.modifiers.listAppend("-combat");
        }
        if (need_bus_passes)
        {
            subentry.modifiers.listAppend("+item");
            subentry.modifiers.listAppend("olfact serialbus");
        }
        
        entry.subentries.listAppend(subentry);
    }
    if ($item[Azazel's lollipop].available_amount() == 0)
    {
        //comedy club - fight on!
        ChecklistSubentry subentry;
        
        subentry.header = "Azazel's lollipop";
        
        
        if ($item[observational glasses].available_amount() > 0)
        {
            //talk to mourn
            string line = "Talk to Mourn.";
            if ($item[observational glasses].equipped_amount() == 0)
                line = "Equip the observational glasses, talk to mourn.";
            subentry.entries.listAppend(line);
        }
        else
        {
            subentry.modifiers.listAppend("+combat");
            string and_item = "";
            if (need_imp_airs)
                and_item = " and +item";
            subentry.entries.listAppend("Run +combat" + and_item + " on the laugh floor, find Larry.");
        }
        
        if (need_imp_airs)
        {
            subentry.modifiers.listAppend("+item");
            subentry.modifiers.listAppend("olfact ch imp");
        }
        entry.subentries.listAppend(subentry);
    }
    
    if ((my_path_id() == PATH_TEETOTALER || my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_ZOMBIE_SLAYER) && availableFullness() < 5)
        entry.subentries.listAppend(ChecklistSubentryMake(HTMLGenerateSpanFont("Won't work, need five fullness to eat lasagna.", "red"), "", ""));
        
    if (my_path_id() == PATH_OXYGENARIAN && availableSpleen() < 5)
        entry.subentries.listAppend(ChecklistSubentryMake(HTMLGenerateSpanFont("Won't work, need five spleen to consume steel-scented air freshener.", "red"), "", ""));
	
	optional_task_entries.listAppend(entry);
}

void QUntinkerInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM01Untinker");
	
	state.quest_name = "Untinker's Quest";
	state.image_name = "rusty screwdriver";
	
	state.startable = $location[the spooky forest].locationAvailable();
	
	__quest_state["Untinker"] = state;
}


void QUntinkerGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Untinker"];
	if (base_quest_state.finished || !base_quest_state.startable)
		return;
    
    if (my_path_id() == PATH_EXPLOSION) return;
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string url = "";
	
	if ($item[rusty screwdriver].available_amount() > 0 || base_quest_state.mafia_internal_step == 0)
	{
		subentry.entries.listAppend("Speak to the Untinker.");
		url = "place.php?whichplace=forestvillage&action=fv_untinker_quest";
	}
	else
	{
        //Acquire rusty screwdriver:
		if (knoll_available())
		{
			subentry.entries.listAppend("Speak to Innabox in Degrassi Knoll.");
			url = "place.php?whichplace=knoll_friendly";
		}
		else
		{
            url = "place.php?whichplace=knoll_hostile";
			subentry.entries.listAppend("Retrieve screwdriver from the Degrassi Knoll Garage.|(25% superlikely)");
			if (__misc_state["free runs available"])
			{
				subentry.modifiers.listAppend("free runs");
			}
			if (__misc_state["have hipster"])
			{
				subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
			}
		}
	}
	
	optional_task_entries.listAppend(ChecklistEntryMake(29, base_quest_state.image_name, url, subentry, $locations[the degrassi knoll garage]));
}

void QArtistInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM02Artist");
    
    if (!state.started && $items[pail of pretentious paint, pretentious paintbrush, pretentious palette].available_amount() > 0)
        QuestStateParseMafiaQuestPropertyValue(state, "started");
    
    if (my_path_id() == PATH_ZOMBIE_SLAYER) //cannot be done
        QuestStateParseMafiaQuestPropertyValue(state, "unstarted");
	
	state.quest_name = "Pretentious Artist's Quest";
	state.image_name = "__item pretentious palette";
	
	state.startable = true;
	
	__quest_state["Artist"] = state;
}


void QArtistGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Artist"];
	if (!base_quest_state.in_progress)
		return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "";
	
	boolean output_modifiers = false;
	if ($item[pretentious palette].available_amount() == 0)
	{
		//haunted pantry
        if (active_url == "")
            active_url = $location[the haunted pantry].getClickableURLForLocation();
		subentry.entries.listAppend("Adventure in the haunted pantry for palette. (25% superlikely)");
		output_modifiers = true;
	}
	if ($item[pretentious paintbrush].available_amount() == 0)
	{
		//cobb's knob
        if (active_url == "")
            active_url = $location[the outskirts of Cobb's Knob].getClickableURLForLocation();
		subentry.entries.listAppend("Adventure in the outskirts of Cobb's Knob for paintbrush. (25% superlikely)");
		output_modifiers = true;
	}
	if ($item[pail of pretentious paint].available_amount() == 0)
	{
		//sleazy back alley
        if (active_url == "")
            active_url = $location[the sleazy back alley].getClickableURLForLocation();
		subentry.entries.listAppend("Adventure in the sleazy back alley for pail of paint. (25% superlikely)");
		output_modifiers = true;
	}
	
	if (output_modifiers)
	{
		if (__misc_state["free runs available"])
		{
			subentry.modifiers.listAppend("free runs");
		}
		if (__misc_state["have hipster"])
		{
			subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
		}
	}
	
	if ($item[pretentious palette].available_amount() > 0 && $item[pretentious paintbrush].available_amount() > 0 && $item[pail of pretentious paint].available_amount() > 0)
	{
		subentry.entries.listAppend("Talk to the pretentious artist.");
        active_url = "place.php?whichplace=town_wrong";
	}
	
	optional_task_entries.listAppend(ChecklistEntryMake(71, base_quest_state.image_name, active_url, subentry, $locations[the sleazy back alley, the outskirts of cobb's knob, the haunted pantry]));
}
void QLegendaryBeatInit()
{
    if ($item[Map to Professor Jacking's laboratory].available_amount() == 0)
        return;
	//questI02Beat
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questI02Beat");
    
    if (!state.started)
    {
        QuestStateParseMafiaQuestPropertyValue(state, "started");
    }
	
	state.quest_name = "Quest for the Legendary Beat";
	state.image_name = "__item the Legendary Beat";
    
    if (state.in_progress)
    {
        //FIXME temporary code
        //no way to detect if the legendary beat was found
        //if (state.mafia_internal_step < 2 && $location[professor jacking's small-o-fier].turnsAttemptedInLocation() > 0 || $location[professor jacking's huge-a-ma-tron].turnsAttemptedInLocation() > 0)
            //state.mafia_internal_step = 2;
    }
	
	__quest_state["Legendary Beat"] = state;
}

void QLegendaryBeatGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($item[Map to Professor Jacking's laboratory].available_amount() == 0)
        return;
        
	QuestState base_quest_state = __quest_state["Legendary Beat"];
	if (!base_quest_state.in_progress)
		return;
    
    //FIXME temporary:
    if (!($locations[professor jacking's small-o-fier, professor jacking's huge-a-ma-tron] contains __last_adventure_location))
        return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
        
    //FIXME support for fruit machine sidequest?
    
    if (base_quest_state.mafia_internal_step == 1 && false)
    {
        subentry.entries.listAppend("Defeat Professor Jacking.");
    }
    else if (base_quest_state.mafia_internal_step == 2 || true)
    {
        //Main quest, in reverse order:
        if ($item[can-you-dig-it?].available_amount() > 0 && $effect[stubbly legs].have_effect() > 0)
        {
            subentry.modifiers.listAppend("-combat");
            //6/7
            string [int] tasks;
            if ($item[can-you-dig-it?].equipped_amount() == 0)
                tasks.listAppend("equip can-you-dig-it?");
            tasks.listAppend("adventure in Small-O-Fier, find non-combat, dig your way to safety");
            subentry.entries.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
        }
        else if ($item[can-you-dig-it?].available_amount() > 0 && $effect[smooth legs].have_effect() > 0)
        {
            //5
            subentry.entries.listAppend("Gaze into the mirror.");
            subentry.entries.listAppend("Before you do, though, possibly look for/copy smooth jazz scabie factoids in the Small-O-Fier.");
        }
        else if ($effect[smooth legs].have_effect() > 0)
        {
            //4
            if ($effect[literally insane].have_effect() > 0 && $effect[broken dancing].have_effect() > 0 && $item[crazyleg's razor].available_amount() > 0)
                subentry.entries.listAppend("Use Crazyleg's razor repeatedly to extend smooth legs effect.");

            subentry.modifiers.listAppend("-combat");
            subentry.modifiers.listAppend("+item");
            subentry.entries.listAppend("Adventure in Small-O-Fier, find ocean non-combat, fight a smooth jazz scabie for can-you-dig-it?");
            
        }
        else if ($effect[literally insane].have_effect() > 0 && $effect[broken dancing].have_effect() > 0 && $item[crazyleg's razor].available_amount() > 0)
        {
            //3
            subentry.entries.listAppend("Use Crazyleg's razor. (repeatedly)");
        }
        else if ($effect[literally insane].have_effect() + $item[world's most unappetizing beverage].available_amount() > 0 && $effect[broken dancing].have_effect() + $item[squirmy violent party snack].available_amount() > 0 && $item[crazyleg's razor].available_amount() > 0)
        {
            string [int] tasks;
            boolean waiting = false;
            if ($effect[literally insane].have_effect() == 0)
            {
                if (availableDrunkenness() < 1)
                {
                    waiting = true;
                    tasks.listAppend("wait until you have 1 drunkenness available");
                }
                else
                    tasks.listAppend("drink the world's most unappetizing beverage");
            }
            if ($effect[broken dancing].have_effect() == 0)
            {
                if (availableFullness() < 1)
                {
                    tasks.listAppend("wait until you have 1 fullness available");
                    waiting = true;
                }
                else if (!waiting)
                    tasks.listAppend("eat a squirmy violent party snack");
            }
            subentry.entries.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        }
        else
        {
            boolean need_nc = false;
            //Need:
            //crazyleg's razor
            //literally insane / world's most unappetizing beverage / (hair of the calf and can of depilatory cream)
            //broken dancing / squirmy violent party snack / (a dance upon the palate/tiny frozen prehistoric meteorite jawbreaker)
            if ($item[crazyleg's razor].available_amount() == 0)
            {
                subentry.entries.listAppend("Acquire crazyleg's razor.|*Adventure in the Huge-A-Ma-Tron, defeat the Fearsome Wacken.");
            }
            if ($effect[literally insane].have_effect() + $item[world's most unappetizing beverage].available_amount() > 0)
            {
                //nothing, have them
            }
            else if ($item[world's most unappetizing beverage].creatable_amount() > 0)
            {
                subentry.entries.listAppend("Create the world's most unappetizing beverage.");
            }
            else
            {
                //parts:
                if ($item[hair of the calf].available_amount() == 0)
                {
                    need_nc = true;
                    subentry.entries.listAppend("Acquire hair of the calf.|*Adventure in Small-O-Fier, climb up a hair.");
                }
                if ($item[can of depilatory cream].available_amount() == 0)
                {
                    need_nc = true;
                    subentry.entries.listAppend("Acquire can of depilatory cream.|*Adventure in Small-O-Fier, find non-combat.");
                }
            }
            
            if ($effect[broken dancing].have_effect() + $item[squirmy violent party snack].available_amount() > 0)
            {
                //nothing, have them
            }
            else if ($item[squirmy violent party snack].creatable_amount() > 0)
            {
                subentry.entries.listAppend("Create a squirmy violent party snack.");
            }
            else
            {
                //parts:
                if ($item[a dance upon the palate].available_amount() == 0)
                {
                    subentry.entries.listAppend("Acquire a dance upon the palate.|*Adventure in Huge-A-Ma-Tron, crouch down and lick the world.");
                }
                if ($item[tiny frozen prehistoric meteorite jawbreaker].available_amount() == 0)
                {
                    string [int] meteorite_details;
                    
                    boolean [item] relevant_fruits = $items[blackberry, cherry, olive, plum, sea blueberry, strawberry]; //cheap ones, not all of them
                    item chosen_fruit = $item[blackberry];
                    foreach it in relevant_fruits
                    {
                        if (it.available_amount() > 0)
                        {
                            chosen_fruit = it;
                            break;
                        }
                    }
                    
                    if (chosen_fruit.available_amount() == 0)
                        meteorite_details.listAppend("Acquire a " + chosen_fruit + ".");
                    meteorite_details.listAppend("Put a " + chosen_fruit + " in the fruit machine if you haven't.");
                    if ($effect[hurricane force].have_effect() == 0)
                    {
                        need_nc = true;
                        meteorite_details.listAppend("Adventure in the Huge-A-Ma-Tron, dance on top of the world.");
                    }
                    else
                    {
                        meteorite_details.listAppend("Adventure in the Huge-A-Ma-Tron, defeat a loose coalition of yetis, snowmen, and goats.");
                    }
                    subentry.entries.listAppend("Acquire a tiny frozen prehistoric meteorite jawbreaker.|*" + meteorite_details.listJoinComponents("|*"));
                    
                    
                }
            }
            
            if (need_nc)
                subentry.modifiers.listAppend("-combat");
        }
    }
    
	task_entries.listAppend(ChecklistEntryMake(92, base_quest_state.image_name, "", subentry, $locations[professor jacking's small-o-fier, professor jacking's huge-a-ma-tron]));
}
//Currently disabled. Complicated.

void QMemoriesInit()
{
    if (true)
        return;
    if (true)
    {
        QuestState state;
        QuestStateParseMafiaQuestProperty(state, "questF01Primordial");
        
        state.quest_name = "Primordial Fear Quest";
        state.image_name = "__item empty agua de vida bottle";
        
        
        __quest_state["Primordial Fear"] = state;
    }
    if (true)
    {
        QuestState state;
        QuestStateParseMafiaQuestProperty(state, "questF02Hyboria");
        
        state.quest_name = "Hyboria Quest";
        state.image_name = "__item empty agua de vida bottle";
        
        
        __quest_state["Hyboria"] = state;
    }
    if (true)
    {
        QuestState state;
        QuestStateParseMafiaQuestProperty(state, "questF03Future");
        
        state.quest_name = "Future Quest";
        state.image_name = "__item empty agua de vida bottle";
        
        
        __quest_state["Future"] = state;
    }
}


void QMemoriesPrimordialFearGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Primordial Fear"];
	if (!base_quest_state.in_progress)
		return;
    string active_url = "";
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    //FIXME implement this
    
	optional_task_entries.listAppend(ChecklistEntryMake(8, base_quest_state.image_name, active_url, subentry, $locations[the primordial soup]));
}

void QMemoriesHyboriaGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Hyboria"];
	if (!base_quest_state.in_progress)
		return;
    string active_url = "";
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    //FIXME implement this
    
    
	optional_task_entries.listAppend(ChecklistEntryMake(9, base_quest_state.image_name, active_url, subentry, $locations[the jungles of ancient loathing]));
}

void QMemoriesFutureGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Future"];
	if (!base_quest_state.in_progress)
		return;
    string active_url = "";
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    //FIXME implement this
    
    
	optional_task_entries.listAppend(ChecklistEntryMake(10, base_quest_state.image_name, active_url, subentry, $locations[seaside megalopolis]));
}

void QMemoriesGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (true)
        return;
    if (__quest_state["Primordial Fear"].in_progress)
    {
        QMemoriesPrimordialFearGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    else if (__quest_state["Hyboria"].in_progress)
    {
        QMemoriesHyboriaGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    else if (__quest_state["Future"].in_progress)
    {
        QMemoriesFutureGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
}

void QWhiteCitadelInit()
{
    QuestState state;
    QuestStateParseMafiaQuestProperty(state, "questG02Whitecastle");
    
    //sorry, no way to query for familiar name
    state.quest_name = my_name().HTMLEscapeString() + " and Kumar Go To White Citadel";
    if (my_familiar() == $familiar[black cat])
        state.quest_name = my_name().HTMLEscapeString() + " and Luna Go To White Citadel";
    state.image_name = "__item White Citadel burger";
    
    if ($item[White Citadel Satisfaction Satchel].available_amount() > 0 && state.mafia_internal_step < 11)
        QuestStateParseMafiaQuestPropertyValue(state, "step10");
    if ($effect[SOME PIGS].have_effect() == 2147483647 && state.mafia_internal_step < 7)
        QuestStateParseMafiaQuestPropertyValue(state, "step6");
    
    __quest_state["White Citadel"] = state;
}

void QWhiteCitadelGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__misc_state["in aftercore"] && !in_bad_moon() && my_location() != $location[the road to the white citadel] && __last_adventure_location != $location[the road to the white citadel]) //not yet
        return;
    if (!__misc_state["guild open"]) //bugged
        return;
	QuestState base_quest_state = __quest_state["White Citadel"];
	if (!base_quest_state.in_progress && !(in_bad_moon() && !base_quest_state.started))
		return;
    
    boolean using_black_cat_equivalent = ($familiars[O.A.F.,black cat] contains my_familiar());
    
    if (__misc_state["in run"] && $location[The Road to the White Citadel].turnsAttemptedInLocation() == 0 && !in_bad_moon()) //not until they're sure
        return;
    
    boolean add_as_future_task = false;
    
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "place.php?whichplace=woods";
    
    if (in_bad_moon())
    {
        string [int] reasons;
        if (base_quest_state.mafia_internal_step < 6)
            reasons.listAppend("duonoculars");
        if (base_quest_state.mafia_internal_step < 8)
            reasons.listAppend("food from the wand of pigification");
        if (base_quest_state.mafia_internal_step < 11)
            reasons.listAppend("an epic drink");
        
        if (reasons.count() > 0)
            subentry.entries.listAppend("Relevant in Bad Moon for " + reasons.listJoinComponents(", ", "and") + ".");
    }
    if (!base_quest_state.started)
    {
        if (QuestState("questG01Meatcar").finished || $item[bitchin' meatcar].available_amount() > 0)
        {
            subentry.entries.listAppend("Visit your friend at the guild to start the quest.");
            active_url = "guild.php";
        }
        else
        {
            subentry.entries.listAppend("Build a meatcar first.");
            active_url = "";
        }
    }
    else if (base_quest_state.mafia_internal_step == 1)
    {
        //1	Find the road to the White Citadel, somewhere in Whitey's Grove.
        //Unlock the road to white citadel:
        subentry.modifiers.listAppend("+15% combat");
        subentry.modifiers.listAppend("free runs");
        subentry.entries.listAppend("Adventure in Whitey's Grove, unlock the road to the White Citadel.");
    }
    else if (base_quest_state.mafia_internal_step >= 2 && base_quest_state.mafia_internal_step <= 4)
    {
        //2	You've found the Road to the White Citadel! Now you can begin your quest there.
        //3	Make your way through the dark forest near the Road to the White Citadel
        //4	pairs of burnouts near the Road to the White Citadel.
        int burnouts_defeated = get_property_int("burnoutsDefeated");
        int burnouts_remaining = 30 - burnouts_defeated;
        
        subentry.modifiers.listAppend("+item");
        
        subentry.entries.listAppend("Adventure on the Road to White Citadel, defeat " + pluraliseWordy(burnouts_remaining, "more set of burn-outs", "more burn-outs") + ".");
        
        item opium_grenade = $item[opium grenade];
        
        if (burnouts_remaining > 1)
        {
            if (opium_grenade.storage_amount() > 1 && pulls_remaining() == -1 && ceil(burnouts_remaining / 3.0) > $item[opium grenade].item_amount())
                subentry.entries.listAppend("Pull some opium grenades from hagnk's.");
            else if (opium_grenade.storage_amount() > 0 && pulls_remaining() == -1 && ceil(burnouts_remaining / 3.0) > $item[opium grenade].item_amount())
                subentry.entries.listAppend("Pull an opium grenade from hagnk's.");
            else if (opium_grenade.available_amount() == 1)
                subentry.entries.listAppend("Throw an opium grenade at burnouts.");
            else if (opium_grenade.available_amount() > 1)
                subentry.entries.listAppend("Throw opium grenades at burnouts.");
        }
        
        if ($item[poppy].available_amount() >= 2)
        {
            string line = "Make opium grenade. (meatpaste poppy + poppy)";
            if (opium_grenade.available_amount() == 0)
                line = HTMLGenerateSpanFont(line, "red");
            subentry.entries.listAppend(line);
        }
        
        //turn estimation why not?
        float grenades_have_now = opium_grenade.available_amount().to_float() + $item[poppy].available_amount().to_float() * 0.5;
        
        float poppy_one_drop_rate = clampNormalf(0.3 * (1.0 + $location[the road to the white citadel].item_drop_modifier_for_location() / 100.0));
        float poppy_two_drop_rate = clampNormalf(0.1 * (1.0 + $location[the road to the white citadel].item_drop_modifier_for_location() / 100.0));
        if (using_black_cat_equivalent)
        {
            //strangely, there's no public listing of the batting away rates of these familiars
            //umm... let's go with the assumption of 25%.
            //data we have: 35 items batted, 120 items not batted, 22.5% rate. so 20-25%?
            poppy_one_drop_rate *= 0.75;
            poppy_two_drop_rate *= 0.75;
        }
        
        if (my_path_id() == PATH_HEAVY_RAINS)
        {
            float washaway_rate = $location[The Road to the White Citadel].washaway_rate_of_location();
            
            poppy_one_drop_rate *= (1.0 - washaway_rate);
            poppy_two_drop_rate *= (1.0 - washaway_rate);
        }
        
        float grenades_per_combat = clampf((poppy_one_drop_rate + poppy_two_drop_rate) * 0.5, 0.0, 1.0);
        
        float turns_remaining = burnouts_remaining;
        float burnouts_defeated_per_turn = 1.0 + grenades_per_combat * 2.0;
        
        //How many can we cover with the grenades we have?
        int maximum_grenades_needed = ceil(burnouts_remaining / 3.0);
        grenades_have_now = MIN(maximum_grenades_needed, grenades_have_now);
        
        turns_remaining = grenades_have_now;
        int burnouts_remaining_after_turns = MAX(0, burnouts_remaining - turns_remaining * 3.0);
        
        if (burnouts_defeated_per_turn > 0.0)
            turns_remaining += burnouts_remaining_after_turns / burnouts_defeated_per_turn;
        
        //turns_remaining = burnouts_remaining - MIN(maximum_grenades_needed, grenades_have_now) * 3;
        
        /*if (burnouts_defeated_per_turn > 0.0)
        {
            //very approximate:
            float operating_burnouts_remaining = burnouts_remaining;
            
            operating_burnouts_remaining -= 3.0 * grenades_have_now;
            //turns_remaining = grenades_have_now * 1.0;
            
            turns_remaining = operating_burnouts_remaining / burnouts_defeated_per_turn;
        }*/
        
        turns_remaining = clampf(turns_remaining, 1.0, 30.0);
        if (turns_remaining < 1.05)
            subentry.entries.listAppend("One More Turn remaining.");
        else
            subentry.entries.listAppend("~" + turns_remaining.roundForOutput(1) + " turns remaining.");
        
    }
    else if (base_quest_state.mafia_internal_step == 5)
    {
        //5	Defeat the terrible biclops guarding the Road to the White Citadel.
        subentry.entries.listAppend("Defeat the terrible biclops on the Road to the White Citadel.");
    }
    else if (base_quest_state.mafia_internal_step == 6)
    {
        //6	(Make your way through the dark forest near the Road to the White Citadel)
        subentry.entries.listAppend("Adventure on the Road to the White Citadel.");
        
        string line;
        
        line = "Careful: this will turn your familiars into pigs";
        if (!using_black_cat_equivalent)
            line = HTMLGenerateSpanFont(line, "red"); //ruby red spanners
        line += ", who are unable to do anything, until you defeat Circe.";
        
        if (using_black_cat_equivalent)
            line += "|Um... not that you'll mind.";
        subentry.entries.listAppend(line);
    }
    else if (base_quest_state.mafia_internal_step == 7)
    {
        //7	Get into the witch's hut near the Road to the White Citadel. You could break the door down, but that seems risky. Maybe you can find a key somewhere?
        subentry.entries.listAppend("Kick in the front door of the witch, on the Road to the White Citadel.");
        subentry.entries.listAppend("This will bring back your familiars.");
        if (my_familiar() == $familiar[black cat])
        {
            add_as_future_task = true;
            subentry.entries.listAppend("Or possibly don't. Poor kitty...");
        }
        else if (my_familiar() == $familiar[O.A.F.])
        {
            add_as_future_task = true;
            subentry.entries.listAppend("Or possibly don't. Poor robot...");
        }
    }
    else if (base_quest_state.mafia_internal_step == 8 || base_quest_state.mafia_internal_step == 9)
    {
        //8	(Make your way through the dark forest near the Road to the White Citadel)
        //9	Get through the cave full of shiny, delicious, enticing treasure chests near the Road to the White Citadel.
        subentry.entries.listAppend("Adventure on the Road to the White Citadel, ignoring the treasure chests.");
    }
    else if (base_quest_state.mafia_internal_step == 10)
    {
        //10	Defeat the final obstacle on your way down the Road to the White Citadel.
        subentry.entries.listAppend("Defeat Elp&iacute;zo &amp; Crosybdis, on the Road to the White Citadel, then collect the White Citadel Satisfaction Satchel.");
    }
    else if (base_quest_state.mafia_internal_step == 11 && $item[White Citadel Satisfaction Satchel].available_amount() == 0)
    {
        //11	lunch at the White Citadel.
        subentry.entries.listAppend("Visit the white citadel for the White Citadel Satisfaction Satchel.");
    }
    else if (base_quest_state.mafia_internal_step == 11 || $item[White Citadel Satisfaction Satchel].available_amount() > 0)
    {
        //11	lunch at the White Citadel.
        //Visit guild:
        subentry.entries.listAppend("Visit your friend at the guild.");
        active_url = "guild.php";
    }
//final	You've delivered a satchel of incredibly greasy food to someone you barely know. Plus, you can now shop at White Citadel whenever you want. Awesome!
    
    
    boolean [location] relevant_locations;
    relevant_locations[$location[whitey's grove]] = true;
    relevant_locations[$location[the road to the white citadel]] = true;
    
    string image_name = base_quest_state.image_name;
    if (my_familiar() == $familiar[black cat])
        image_name = "__familiar black cat";
        
        
    ChecklistEntry entry = ChecklistEntryMake(75, image_name, active_url, subentry, relevant_locations);
    if (add_as_future_task)
        future_task_entries.listAppend(entry);
    else
        optional_task_entries.listAppend(entry);
}

void QWizardOfEgoInit()
{
    //if (!__misc_state["in aftercore"]) //not yet
        //return;
    if ($items[Manual of Dexterity,Manual of Labor,Manual of Transmission].available_amount() > 0) //finished already
        return;
        
	//questM02Artist
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questG03Ego");
    
    if (!state.finished)
    {
        //FIXME temporary code
        //Update internal step locally:
        //(this is buggy)
        if (state.mafia_internal_step < 7 && $item[dusty old book].available_amount() > 0)
        {
            state.mafia_internal_step = 7;
        }
        if (state.mafia_internal_step < 1 && $location[The Unquiet Garves].noncombat_queue.contains_text("A Grave Mistake") || $location[The VERY Unquiet Garves].noncombat_queue.contains_text("A Grave Mistake"))
            state.mafia_internal_step = 1;
        if (state.mafia_internal_step < 2 && $location[The Unquiet Garves].noncombat_queue.contains_text("A Grave Situation") || $location[The VERY Unquiet Garves].noncombat_queue.contains_text("A Grave Situation"))
            state.mafia_internal_step = 2;
        
        if (state.mafia_internal_step < 2 && $item[Fernswarthy's key].available_amount() > 0)
            state.mafia_internal_step = 2;
        
        if (state.mafia_internal_step < 4 && $location[tower ruins].turnsAttemptedInLocation() > 0 && $item[Fernswarthy's key].available_amount() > 0)
            state.mafia_internal_step = 4;
        
        if (state.mafia_internal_step < 5 && $location[tower ruins].noncombat_queue.contains_text("Staring into Nothing"))
            state.mafia_internal_step = 5;
        if (state.mafia_internal_step < 6 && $location[tower ruins].noncombat_queue.contains_text("Into the Maw of Deepness"))
            state.mafia_internal_step = 6;
        if (state.mafia_internal_step < 7 && $location[tower ruins].noncombat_queue.contains_text("Take a Dusty Look!"))
            state.mafia_internal_step = 7;
        
        if (!state.in_progress && state.mafia_internal_step > 0 && $item[Fernswarthy's key].available_amount() > 0)
        {
            QuestStateParseMafiaQuestPropertyValue(state, "step" + (state.mafia_internal_step - 1));
        }
    }
	
	state.quest_name = "The Wizard of Ego";
	state.image_name = "__item dilapidated wizard hat";
	
	state.startable = true;
	
	__quest_state["Wizard of Ego"] = state;
}


void QWizardOfEgoGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Wizard of Ego"];
	if (!base_quest_state.in_progress)
		return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string url = "";
    if (base_quest_state.mafia_internal_step == 7 || $item[dusty old book].available_amount() > 0)
    {
        //7	You found some kind of dusty old book in Fernswarthy's tower. Hopefully that's enough to keep that guy in your guild off your case.
        url = "guild.php";
        subentry.entries.listAppend("Speak to the guild.");
    }
    else if (base_quest_state.mafia_internal_step == 1)
    {
        url = "place.php?whichplace=plains";
        //1	You've been tasked with digging up the grave of an ancient and powerful wizard and bringing back a key that was buried with him. What could possibly go wrong?
        if ($item[Fernswarthy's key].available_amount() > 0)
        {
            url = "guild.php";
            subentry.entries.listAppend("Return to your guild.");
        }
        else if ($items[grave robbing shovel, rusty grave robbing shovel].item_amount() == 0 && $item[grave robbing shovel].equipped_amount() == 0 && $item[rusty grave robbing shovel].equipped_amount() == 0)
        {
            string line = "Acquire a grave robbing shovel.";
            if ($items[grave robbing shovel, rusty grave robbing shovel].available_amount() == 0)
                line += " (from mall)";
            else if ($item[grave robbing shovel].storage_amount() + $item[rusty grave robbing shovel].storage_amount() > 0)
            {
                line += " (from hagnk's)";
                url = "storage.php?which=2";
            }
            subentry.entries.listAppend(line);
        }
        else
        {
            url = "place.php?whichplace=cemetery";
            subentry.entries.listAppend("Adventure at the unquiet garves.");
        }
    }
    else if (base_quest_state.mafia_internal_step == 2)
    {
        //2	Well, you got the key and turned it in -- mission accomplished. How much do you wanna bet, though, that they won't be able to find anyone else to search the tower, and you'll be stuck with the dirty work again?
        url = "guild.php";
        subentry.entries.listAppend("Speak to the guild.");
    }
    else if (base_quest_state.mafia_internal_step == 3)
    {
        //3	Much as you expected, you've been given back the key to Fernswarthy's tower and ordered to investigate.
        url = "fernruin.php";
        subentry.entries.listAppend("Adventure in the tower ruins.");
    }
    else if (base_quest_state.mafia_internal_step == 4)
    {
        //4	You've unlocked Fernswarthy's tower. Now you just have to find something to show your guild leaders, to prove you haven't just been slacking off this whole time.
        //Unlocking just means visiting the area.
        url = "fernruin.php";
        subentry.entries.listAppend("Adventure in the tower ruins. Three more non-combats remain.");
    }
    else if (base_quest_state.mafia_internal_step == 5)
    {
        //5	You've found some stairs in Fernswarthy's tower, but they don't lead to much. Better keep looking.
        url = "fernruin.php";
        subentry.entries.listAppend("Adventure in the tower ruins. Two more non-combats remain.");
    }
    else if (base_quest_state.mafia_internal_step == 6)
    {
        //6	You've found a trapdoor to Fernswarthy's basement, which is potentially interesting and/or dangerous. It's probably not what your Guild is interested in, though, so you should probably keep looking.
        url = "fernruin.php";
        subentry.entries.listAppend("Adventure in the tower ruins. One more non-combat remain.");
    }
    
    boolean [location] relevant_locations;
    relevant_locations[$location[The Unquiet Garves]] = true;
    relevant_locations[$location[The VERY Unquiet Garves]] = true;
    relevant_locations[$location[Tower Ruins]] = true;
    
	optional_task_entries.listAppend(ChecklistEntryMake(96, base_quest_state.image_name, url, subentry, relevant_locations));
}
void QSpookyravenLightsOutGenerateEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task) //if from_task is false, assumed to be from resources
{
    //nextSpookyravenElizabethRoom
    //nextSpookyravenStephenRoom
    
    if (get_property_int("lastLightsOutTurn") >= total_turns_played())
        return;
    
    string next_elizabeth_room = get_property("nextSpookyravenElizabethRoom");
    string next_stephen_room = get_property("nextSpookyravenStephenRoom");
    location next_elizabeth_location = next_elizabeth_room.to_location();
    location next_stephen_location = next_stephen_room.to_location();
    
    int turns_until_next_lights_out = -1;
    
    //Thought about enabling this, but it's better to only show it when they ask for spookyraven tracking, I think...
    //then again, spookyraven tracking doesn't work well with automation (auto-aborts, even if adventuring in relevant locations)
    //turns_until_next_lights_out = 37 - total_turns_played() % 37;
    
    Counter lights_out_counter = CounterLookup("Spookyraven Lights Out");
    if (lights_out_counter.CounterExists() && !lights_out_counter.CounterIsRange())
    {
        //turns_until_next_lights_out = lights_out_counter.CounterGetNextExactTurn(); //LYING.
        turns_until_next_lights_out = 37 - total_turns_played() % 37;
    }
        
    
    if (turns_until_next_lights_out == 37)
        turns_until_next_lights_out = 0;
    
    if (turns_until_next_lights_out == -1)
        return;
    
    string url = "";
    
    ChecklistSubentry [int] important_subentries;
    if (turns_until_next_lights_out == 0 && from_task)
    {
        //now
        if (next_stephen_location != $location[none])
        {
            string [location][int] stephen_area_descriptions;
            stephen_area_descriptions[$location[The Haunted Bedroom]] = listMake("Search for a light", "Search a nearby nightstand", "Check a nightstand on your left");
            stephen_area_descriptions[$location[The Haunted Nursery]] = listMake("Search for a lamp", "Search over by the (gaaah) stuffed animals", "Examine the Dresser", "Open the bear and put your hand inside", "Unlock the box");
            stephen_area_descriptions[$location[The Haunted Conservatory]] = listMake("Make a torch", "Examine the graves", "Examine the grave marked \"Crumbles\"");
            stephen_area_descriptions[$location[The Haunted Billiards Room]] = listMake("Search for a light", "What the heck, let's explore a bit", "Examine the taxidermy heads");
            stephen_area_descriptions[$location[The Haunted Wine Cellar]] = listMake("Try to find a light", "Keep your cool", "Investigate the wine racks", "Examine the Pinot Noir rack");
            stephen_area_descriptions[$location[The Haunted Boiler Room]] = listMake("Look for a light", "Search the barrel", "No, but I will anyway");
            stephen_area_descriptions[$location[The Haunted Laboratory]] = listMake("Search for a light", "Check it out", "Examine the weird machines", "Enter 23-47-99 and turn on the machine", "Oh god");
        
            string [int] description;
            
            string first_line = "";
            if (__misc_state["in run"])
            {
                if (__misc_state["familiars temporarily blocked"])
                    first_line += "Not useful this run. ";
                else
                    first_line += "Situationally useful (+familiar weight) in-run. ";
            }
            if (next_stephen_location == $location[The Haunted Laboratory])
                first_line += HTMLGenerateSpanFont("Will take a turn.", "red");
            else
                first_line += "Will not take a turn.";
            
            if (first_line != "")
                description.listAppend(first_line);
            
            string line = "Adventure in " + next_stephen_room;
            if (next_stephen_location == $location[The Haunted Laboratory])
                line += " to fight Stephen Spookyraven";
            line += ".";
            if (stephen_area_descriptions contains next_stephen_location)
                line += "|*" + stephen_area_descriptions[next_stephen_location].listJoinComponents(__html_right_arrow_character) + ".";
            description.listAppend(line);
            
            url = next_stephen_location.getClickableURLForLocation();
            
            important_subentries.listAppend(ChecklistSubentryMake("Stephen Spookyraven Quest", "", description));
        }
        
        
        if (next_elizabeth_location != $location[none])
        {
            string [location][int] elizabeth_area_descriptions;
            elizabeth_area_descriptions[$location[The Haunted Storage Room]] = listMake("Look out the Window");
            elizabeth_area_descriptions[$location[The Haunted Laundry Room]] = listMake("Check a Pile of Stained Sheets");
            elizabeth_area_descriptions[$location[The Haunted Bathroom]] = listMake("Inspect the Bathtub");
            elizabeth_area_descriptions[$location[The Haunted Kitchen]] = listMake("Make a Snack");
            elizabeth_area_descriptions[$location[The Haunted Library]] = listMake("Go to the Childrens' Section");
            elizabeth_area_descriptions[$location[The Haunted Ballroom]] = listMake("Dance with Yourself");
            elizabeth_area_descriptions[$location[The Haunted Gallery]] = listMake("Check out the Tormented Damned Souls Painting");
        
            string [int] description;
            string first_line = "";
            if (__misc_state["in run"])
                first_line += "Not useful in-run. ";
            if (next_elizabeth_location == $location[The Haunted Gallery])
                first_line += HTMLGenerateSpanFont("Will take a turn.", "red");
            else
                first_line += "Will not take a turn.";
            
            if (first_line != "")
                description.listAppend(first_line);
            
            string line = "Adventure in " + next_elizabeth_room;
            if (next_elizabeth_location == $location[The Haunted Gallery])
                line += " to fight Elizabeth Spookyraven";
            line += ".";
            if (elizabeth_area_descriptions contains next_elizabeth_location)
                line += "|*" + elizabeth_area_descriptions[next_elizabeth_location].listJoinComponents(__html_right_arrow_character) + ".";
            description.listAppend(line);
            
            
            if (url.length() == 0)
                url = next_elizabeth_location.getClickableURLForLocation();
            
            important_subentries.listAppend(ChecklistSubentryMake("Elizabeth Spookyraven Quest", "", description));
        }
    }
    else if ((turns_until_next_lights_out < 6 && from_task) || (turns_until_next_lights_out >= 6 && !from_task))
    {
        //Soon...
        //FIXME should we show this?
        string [int] available_questlines;
        if (next_stephen_location != $location[none])
            available_questlines.listAppend("Stephen");
        if (next_elizabeth_location != $location[none])
            available_questlines.listAppend("Elizabeth");
        if (available_questlines.count() > 0)
        {
            optional_task_entries.listAppend(ChecklistEntryMake(30, "__half Lights Out", "", ChecklistSubentryMake("Lights Out in " + pluralise(turns_until_next_lights_out, "adventure", "adventures"), "", available_questlines.listJoinComponents(",", "and") + " quest " + (available_questlines.count() > 1 ? "lines" : "line") + "."), (from_task ? 5 : 8)));
        }
    }
    
    if (important_subentries.count() > 0)
    {
        if (url == "place.php?whichplace=manor2" && !get_property_ascension("lastSecondFloorUnlock"))
            url = "";
        task_entries.listAppend(ChecklistEntryMake(31, "__half Lights Out", url, important_subentries, -11));
    }
}

void QSpookyravenLightsOutGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QSpookyravenLightsOutGenerateEntry(task_entries, optional_task_entries, true);
    
    if (get_property_int("lastLightsOutTurn") < total_turns_played() && total_turns_played() % 37 == 0 && __misc_state["in run"])
    {
        string [int] exploit_description;
        string url = "";
        if (__iotms_usable[$item[haunted doghouse]])
        {
            location [int] possible_locations;
            boolean [location] all_lights_out_locations;
            all_lights_out_locations[$location[the haunted storage room]] = true;
            all_lights_out_locations[$location[the haunted Laundry Room]] = true;
            //all_lights_out_locations[$location[the haunted Bathroom]] = true; //Very small chance of a demon name, which costs a turn. It happened to me!
            all_lights_out_locations[$location[the haunted Kitchen]] = true;
            all_lights_out_locations[$location[the haunted Library]] = true;
            all_lights_out_locations[$location[the haunted Ballroom]] = true;
            all_lights_out_locations[$location[the haunted Gallery]] = true;
            if ($location[the haunted Bedroom].turns_spent < 10)
                all_lights_out_locations[$location[the haunted Bedroom]] = true;
            all_lights_out_locations[$location[the haunted Nursery]] = true;
            all_lights_out_locations[$location[the haunted Conservatory]] = true;
            all_lights_out_locations[$location[the haunted Billiards Room]] = true;
            all_lights_out_locations[$location[the haunted Wine Cellar]] = true;
            all_lights_out_locations[$location[the haunted Boiler Room]] = true;
            all_lights_out_locations[$location[the haunted Laboratory]] = true;
            
            foreach l in all_lights_out_locations
            {
                if (l.combatTurnsAttemptedInLocation() < 5)
                    continue;
                if (l.noncombat_queue.contains_text("Wooooooof!"))
                    continue;
                possible_locations.listAppend(l);
            }
            if (possible_locations.count() > 0)
            {
                exploit_description.listAppend("Adventure in " + possible_locations.listJoinComponents(", ", "or") + " to potentially trigger a halloweiner adventure.|It won't cost a turn.");
                url = possible_locations[0].getClickableURLForLocation();
            }
        }
        if ($item[turkey blaster].available_amount() + $item[turkey blaster].creatable_amount() > 0 && availableSpleen() >= 2 && get_property_int("_turkeyBlastersUsed") < 3)
        {
            location [int] possible_locations;
            foreach l in $locations[the haunted gallery,the haunted bathroom]
            {
                if (l.delayRemainingInLocation() >= 4 && l.locationAvailable())
                {
                    possible_locations.listAppend(l);
                    
                }
            }
            if (possible_locations.count() > 0)
            {
                exploit_description.listAppend("Adventure in " + possible_locations.listJoinComponents(", ", "or") + ", then chew a turkey blaster to burn delay.");
                if (url == "")
                    url = possible_locations[0].getClickableURLForLocation();
            }
        }
        if (exploit_description.count() > 0)
            task_entries.listAppend(ChecklistEntryMake(32, "__half Lights Out", url, ChecklistSubentryMake("Lights Out Exploit", "", exploit_description), -11));
    }
}

void QSpookyravenLightsOutGenerateResource(ChecklistEntry [int] resource_entries)
{
	QSpookyravenLightsOutGenerateEntry(resource_entries, resource_entries, false);
}

void QFeloniaInit()
{
	//questM03Bugbear
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM03Bugbear");
	
	state.quest_name = "Felonia";
	state.image_name = "__item knoll mushroom";
	
	state.startable = knoll_available();
	
	__quest_state["Felonia"] = state;
}


void QFeloniaGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Felonia"];
	if (!base_quest_state.in_progress)
		return;
    if (!knoll_available())
        return;
    if (__misc_state["familiars temporarily blocked"]) //cannot complete
        return;
    if (__misc_state["in run"] && $location[the bugbear pen].turnsAttemptedInLocation() == 0)
        return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string url = "place.php?whichplace=knoll_friendly";
	
    if (get_property("lastEncounter") == "Felonia, Queen of the Spooky Gravy Fairies")
    {
        subentry.header = "Speak to Mayor Zapruder";
    }
    else if (base_quest_state.mafia_internal_step == 1)
    {
        //Acquire annoying pitchfork:
        subentry.header = "Tame the Bugbears";
        if ($item[annoying pitchfork].available_amount() == 0)
        {
            if (!in_ronin())
            {
                subentry.entries.listAppend("Acquire annoying pitchfork in the mall.");
                url = "mall.php";
            }
            else
            {
                subentry.entries.listAppend("Acquire annoying pitchfork from an annoying spooky gravy fairy in the Bugbear Pens.");
            }
        }
        else
            subentry.entries.listAppend("Speak to Mayor Zapruder to give him the annoying pitchfork.");
    }
    else if (base_quest_state.mafia_internal_step == 2)
    {
        //Acquire the right mushroom:
        subentry.header = "Summon a Mushroom Familiar";
        
        if ($item[frozen mushroom].available_amount() > 0 && $item[stinky mushroom].available_amount() > 0 && $item[flaming mushroom].available_amount() > 0)
        {
            subentry.entries.listAppend("Speak to Mayor Zapruder to give him mushrooms.");
        }
        else
        {
            subentry.entries.listAppend("Grow the mushroom Mayor Zapruder wants.");
            url = "knoll_mushrooms.php";
        }
    }
    else if (base_quest_state.mafia_internal_step == 3)
    {
        //defeat felonia:
        subentry.header = "Defeat Felonia";
        
        boolean currently_using_a_relevant_familiar = false;
        familiar fairy_to_use = $familiar[none];
        foreach f in $familiars[Flaming Gravy Fairy,Frozen Gravy Fairy,Stinky Gravy Fairy,Sleazy Gravy Fairy,spooky gravy fairy]
        {
            if (f.have_familiar())
                fairy_to_use = f;
            if (my_familiar() == f)
                currently_using_a_relevant_familiar = true;
        }
        if ($familiar[spooky gravy fairy].have_familiar())
            fairy_to_use = $familiar[spooky gravy fairy];
        
        if (fairy_to_use == $familiar[none])
        {
            item [int] fairies_can_grow;
            foreach it in $items[pregnant flaming mushroom,pregnant frozen mushroom,pregnant stinky mushroom,pregnant oily golden mushroom,pregnant gloomy black mushroom]
            {
                fairies_can_grow.listAppend(it);
            }
            if (fairies_can_grow.count() == 0)
            {
                subentry.entries.listAppend("Um... try to find a gravy fairy somehow.");
            }
            else
            {
                subentry.entries.listAppend("Grow one of " + fairies_can_grow.listJoinComponents(", ", "or") + ".");
            }
        }
        else if (!currently_using_a_relevant_familiar)
        {
            subentry.entries.listAppend("Bring along a " + fairy_to_use + ".");
            url = "familiar.php";
        }
        else
        {
            boolean need_minus_combat = false;
            if ($item[inexplicably glowing rock].available_amount() > 0 && $item[spooky glove].available_amount() > 0)
            {
                string [int] tasks;
                if ($item[spooky glove].equipped_amount() == 0)
                {
                    tasks.listAppend("equip the spooky glove");
                    url = generateEquipmentLink($item[spooky glove]);
                }
                tasks.listAppend("defeat Felonia");
                
                subentry.entries.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + " in the Spooky Gravy Burrow.");
                need_minus_combat = true;
            }
            else
            {
                item [int] items_needed;
                if ($item[inexplicably glowing rock].available_amount() == 0)
                {
                    items_needed.listAppend($item[inexplicably glowing rock]);
                    need_minus_combat = true;
                }
                
                if ($item[spooky glove].available_amount() == 0)
                {
                    if ($item[spooky fairy gravy].available_amount() > 0 && $item[small leather glove].available_amount() > 0)
                    {
                        url = "craft.php?mode=cook";
                        subentry.entries.listAppend("Make and wear a spooky glove. (cook spooky fairy gravy + small leather glove)");
                    }
                    else
                    {
                        if ($item[spooky fairy gravy].available_amount() == 0)
                        {
                            items_needed.listAppend($item[spooky fairy gravy]);
                            need_minus_combat = true;
                        }
                        if ($item[small leather glove].available_amount() == 0)
                        {
                            subentry.modifiers.listAppend("+900% item");
                            items_needed.listAppend($item[small leather glove]);
                            subentry.entries.listAppend("Or buy small leather glove in the mall.");
                        }
                    }
                }
                if (items_needed.count() > 0)
                {
                    subentry.entries.listPrepend("Adventure in the Spooky Gravy Burrow for " + items_needed.listJoinComponents(", ", "and") + ".");
                }
            }
        
            if (need_minus_combat)
                subentry.modifiers.listPrepend("-combat?");
        }
    }
    
    boolean [location] relevant_locations;
    relevant_locations[$location[the bugbear pen]] = true;
    relevant_locations[$location[the spooky gravy burrow]] = true;
	
	optional_task_entries.listAppend(ChecklistEntryMake(64, base_quest_state.image_name, url, subentry, relevant_locations));
}

void QGuildInit()
{
    if (!($classes[seal clubber,turtle tamer,pastamancer,sauceror,disco bandit,accordion thief] contains my_class()))
        return;
    if (my_path_id() == PATH_POCKET_FAMILIARS)
        return;
	//questM02Artist
	QuestState state;
    
    if ($classes[seal clubber,turtle tamer] contains my_class())
        QuestStateParseMafiaQuestProperty(state, "questG09Muscle");
    if ($classes[pastamancer,sauceror] contains my_class())
        QuestStateParseMafiaQuestProperty(state, "questG07Myst");
    if ($classes[disco bandit,accordion thief] contains my_class())
        QuestStateParseMafiaQuestProperty(state, "questG08Moxie");
    if (guild_store_available())
        QuestStateParseMafiaQuestPropertyValue(state, "finished");
	
    
    
	//state.quest_name = "Guilded Youth";
    state.quest_name = "Join your guild";
    if (my_class() == $class[seal clubber])
        state.image_name = "__item seal-clubbing club";
    else if (my_class() == $class[turtle tamer])
        state.image_name = "__item helmet turtle";
    else if (my_class() == $class[pastamancer])
        state.image_name = "__item pasta spoon";
    else if (my_class() == $class[sauceror])
        state.image_name = "__item saucepan";
    else if (my_class() == $class[disco bandit])
        state.image_name = "__item disco mask";
    else if (my_class() == $class[accordion thief])
        state.image_name = "__item stolen accordion";
    
	if (state.mafia_internal_step < 2 && ($item[11-inch knob sausage].available_amount() > 0 || $item[exorcised sandwich].available_amount() > 0 && $location[the sleazy back alley].noncombat_queue.contains_text("Now's Your Pants!")))
	{
        QuestStateParseMafiaQuestPropertyValue(state, "step1");
	}
	
	state.startable = true;
	
	__quest_state["Guild"] = state;
}


void QGuildGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!($classes[seal clubber,turtle tamer,pastamancer,sauceror,disco bandit,accordion thief] contains my_class()))
        return;
    if (my_path_id() == PATH_POCKET_FAMILIARS)
        return;
    if (my_path_id() == PATH_NUCLEAR_AUTUMN)
        return;
	QuestState base_quest_state = __quest_state["Guild"];
	if (base_quest_state.finished)
		return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "";
    
    if (__misc_state["in run"] && my_path_id() != PATH_PICKY && !in_bad_moon())
    {
        if ($classes[pastamancer,sauceror] contains my_class() && $location[the haunted pantry].turnsAttemptedInLocation() == 0)
            return;
        if ($classes[disco bandit,accordion thief] contains my_class() && $location[the sleazy back alley].turnsAttemptedInLocation() == 0)
            return;
        if (!base_quest_state.started && !($classes[seal clubber,turtle tamer] contains my_class()))
            return;
    }
	
    boolean [location] relevant_location;
    
    if (!base_quest_state.started)
    {
		subentry.entries.listAppend("Talk to your guild chief.");
        active_url = "guild.php";
    }
    else if (base_quest_state.mafia_internal_step == 1)
    {
        boolean output_modifiers = false;
        if ($classes[seal clubber,turtle tamer] contains my_class())
        {
            //cobb's knob
            active_url = $location[the outskirts of Cobb's Knob].getClickableURLForLocation();
            relevant_location[$location[the outskirts of Cobb's Knob]] = true;
            subentry.entries.listAppend("Adventure in the outskirts of Cobb's Knob to find the sausage.");
            output_modifiers = true;
        }
        if ($classes[pastamancer,sauceror] contains my_class())
        {
            //haunted pantry
            active_url = $location[the haunted pantry].getClickableURLForLocation();
            relevant_location[$location[the haunted pantry]] = true;
            subentry.entries.listAppend("Adventure in the haunted pantry to exorcise the poltersandwich.");
            output_modifiers = true;
        }
        if ($classes[disco bandit,accordion thief] contains my_class())
        {
            //sleazy back alley
            relevant_location[$location[the sleazy back alley]] = true;
            if ($slot[pants].equipped_item() == $item[none])
            {
                active_url = "inventory.php?which=2";
                subentry.entries.listAppend("Equip some pants.");
            }
            else
            {
                active_url = $location[the sleazy back alley].getClickableURLForLocation();
                subentry.entries.listAppend("Adventure in the sleazy back alley to steal your own pants.");
                output_modifiers = true;
            }
        }
        
        if (output_modifiers)
        {
            if (__misc_state["free runs available"])
            {
                subentry.modifiers.listAppend("free runs");
            }
            if (__misc_state["have hipster"])
            {
                subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
            }
        }
	}
    else if (base_quest_state.mafia_internal_step == 2)
    {
		subentry.entries.listAppend("Talk to your guild chief.");
        active_url = "guild.php";
    }
	
	optional_task_entries.listAppend(ChecklistEntryMake(4, base_quest_state.image_name, active_url, subentry, relevant_location));
}
boolean __QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished = false;
ChecklistEntry QSleazeAirportGenerateQuestFramework(ChecklistEntry [int] task_entries, string quest_property_name, string quest_name, string image_name, int amount_of_something_to_collect, item item_to_collect, string property_name_to_collect, string item_to_collect_singular, string item_to_collect_plural, location target_location, string quest_giver, item item_to_equip)
{
    __QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished = false;
    QuestState state;
    state.image_name = image_name;
    state.quest_name = quest_name;
	QuestStateParseMafiaQuestProperty(state, quest_property_name);
    
    boolean should_ignore_for_now = false;
    
    if (quest_property_name == "questESlMushStash" || quest_property_name == "questESlBacteria")
    {
        //questESlAudit, questESlMushStash, questESlBacteria
        if (QuestState("questESlAudit").in_progress)
            should_ignore_for_now = true;
        if (quest_property_name == "questESlBacteria" && QuestState("questESlMushStash").in_progress)
            should_ignore_for_now = true;
    }
    
    if (!state.in_progress || should_ignore_for_now)
    {
        ChecklistEntry blank_entry;
        return blank_entry;
    }
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_sleaze";
    
    int remaining_of_item = 0;
    if (item_to_collect != $item[none])
    {
        remaining_of_item = amount_of_something_to_collect - item_to_collect.item_amount();
        if (item_to_collect_singular.length() == 0)
            item_to_collect_singular = item_to_collect.to_string();
        if (item_to_collect_plural.length() == 0)
            item_to_collect_plural = item_to_collect.plural;
    }
    else
    {
        remaining_of_item = amount_of_something_to_collect - get_property_int(property_name_to_collect);
    }
    
    remaining_of_item = MAX(0, remaining_of_item);
    
    if (state.mafia_internal_step <= 2 && remaining_of_item > 0)
    {
        string line = "Adventure in the " + target_location + " and collect ";
        line += remaining_of_item.int_to_wordy();
        line += " more ";
        if (remaining_of_item > 1)
            line += item_to_collect_plural;
        else
            line += item_to_collect_singular;
        line += ".";
        subentry.entries.listAppend(line);
        
        if (item_to_equip != $item[none] && item_to_equip.available_amount() > 0 && item_to_equip.equipped_amount() == 0)
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + item_to_equip + ".", "red"));
        if (target_location == $location[The Sunken Party Yacht] && $effect[fishy].have_effect() == 0)
        {
            subentry.entries.listAppend("Try to acquire Fishy effect.");
        }
        if (quest_property_name == "questESlAudit" || quest_property_name == "questESlMushStash")
        {
            string [int] remaining_quests_after_this;
            if (quest_property_name == "questESlAudit")
            {
                if (QuestState("questESlMushStash").in_progress)
                    remaining_quests_after_this.listAppend("Pencil-Thin Mush Stash");
            }
            if (QuestState("questESlBacteria").in_progress)
                remaining_quests_after_this.listAppend("Cultural Studies");
            
            //questESlAudit, questESlMushStash, questESlBacteria
            if (remaining_quests_after_this.count() > 0)
            {
                /*string line = "The quest";
                if (remaining_quests_after_this.count() > 1)
                    line += "s";
                line += " ";
                line += remaining_quests_after_this.listJoinComponents(", ", "and") + " will be available next.";*/
                string line = pluraliseWordy(remaining_quests_after_this.count(), "quest", "quests").capitaliseFirstLetter() + " will be available after this.";
                subentry.entries.listAppend(line);
            }
        }
    }
    else
    {
        subentry.entries.listAppend("Return to " + quest_giver + ".");
        __QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished = true;
    }
    
    
    ChecklistEntry output_entry = ChecklistEntryMake(37, state.image_name, url, subentry, locationToLocationMap(target_location));
    
    task_entries.listAppend(output_entry);
    
    return output_entry;
}

void QSleazeAirportMushStashGenerateTasks(ChecklistEntry [int] task_entries)
{
    //jimmy, fun-guy
    //run +item, collect 10 pencil thin mushrooms (item)
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlMushStash", "Pencil-Thin Mush Stash", "__item pencil thin mushroom", 10, $item[pencil thin mushroom], "", "", "", $location[The Fun-Guy Mansion], "Buff Jimmy", $item[none]);
    
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("+item");
}

void QSleazeAirportAuditGenerateTasks(ChecklistEntry [int] task_entries)
{
    //questESlAudit
    //taco dan, fun-guy
    //look for 10 Taco Dan's Taco Stand's Taco Receipt (item). requires Sleight of Mind effect from sleight-of-hand mushrooms dropped from area
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlAudit", "Audit-Tory Hallucinations", "__item Taco Dan's Taco Stand's Taco Receipt", 10, $item[Taco Dan's Taco Stand's Taco Receipt], "", "receipt", "receipts", $location[The Fun-Guy Mansion], "Taco Dan", $item[none]);
    
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    
    if ($effect[sleight of mind].have_effect() == 0 && $item[sleight-of-hand mushroom].available_amount() > 0)
    {
        entry.subentries[0].entries.listAppend(HTMLGenerateSpanFont("Use sleight-of-hand mushroom", "red") + " to acquire receipts.");
    }
}

void QSleazeAirportBacteriaGenerateTasks(ChecklistEntry [int] task_entries)
{
    //broden, fun-guy, brodenBacteria
    //+all(?) elemental resistance
    //collect 10 bacteria
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlBacteria", "Cultural Studies", "__item chainsaw chain", 10, $item[none], "brodenBacteria", "bacteria", "bacteria", $location[The Fun-Guy Mansion], "Broden", $item[none]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("+elemental resistance");
}


void QSleazeAirportCheeseburgerGenerateTasks(ChecklistEntry [int] task_entries)
{
    //jimmy, diner
    //buffJimmyIngredients - need 15(?)
    //equip Paradaisical Cheeseburger recipe, olfact Sloppy Seconds Burgers
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlCheeseburger", "Paradise Cheeseburger", "__item hamburger", 15, $item[none], "buffJimmyIngredients", "ingredient", "ingredients", $location[sloppy seconds diner], "Buff Jimmy", $item[Paradaisical Cheeseburger recipe]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("olfact Burgers");
}

void QSleazeAirportCocktailGenerateTasks(ChecklistEntry [int] task_entries)
{
    //taco dan, diner
    //tacoDanCocktailSauce
    //equip Taco Dan's Taco Stand Cocktail Sauce Bottle, olfact Sloppy Seconds Cocktails
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlCocktail", "Cocktail as old as Cocktime", "__item Taco Dan's Taco Stand Cocktail Sauce Bottle", 15, $item[none], "tacoDanCocktailSauce", "sauce", "sauce", $location[sloppy seconds diner], "Taco Dan", $item[Taco Dan's Taco Stand Cocktail Sauce Bottle]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("olfact Cocktails");
    entry.subentries[0].entries.listAppend("Or don't; the equipment is useful for PVP.");
}

void QSleazeAirportSprinklesGenerateTasks(ChecklistEntry [int] task_entries)
{
    //broden, diner
    //brodenSprinkles
    //equip sprinkle shaker, olfact Sloppy Seconds Sundaes
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlSprinkles", "A Light Sprinkle", "__item sprinkle shaker", 15, $item[none], "brodenSprinkles", "sprinkles", "sprinkles", $location[sloppy seconds diner], "Broden", $item[sprinkle shaker]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("olfact Sundaes");
}


void QSleazeAirportSaltGenerateTasks(ChecklistEntry [int] task_entries)
{
    //jimmy, yacht
    //collect 50 salty sailor salts (item), olfact son of a son of a sailor, run +ML, want fishy
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlSalt", "Lost Shaker of Salt", "__item salty sailor salt", 50, $item[salty sailor salt], "", "salt", "salts", $location[The Sunken Party Yacht], "Buff Jimmy", $item[none]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("+ML");
    entry.subentries[0].modifiers.listAppend("olfact son of a son of a sailor");
}

void QSleazeAirportFishGenerateTasks(ChecklistEntry [int] task_entries)
{
    //taco dan, yacht
    //tacoDanFishMeat
    //collect 300 fish meat, olfact taco fish, run +meat, want fishy
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlFish", "Dirty Fishy Dish", "__item fishy fish", 300, $item[none], "tacoDanFishMeat", "fish meat", "fish meat", $location[The Sunken Party Yacht], "Taco Dan", $item[none]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("+meat");
    entry.subentries[0].modifiers.listAppend("olfact taco fish");
}

void QSleazeAirportDebtGenerateTasks(ChecklistEntry [int] task_entries)
{
    //broden, yacht
    //collect 15 bike rental broupon (item), olfact drownedbeat, want fishy
    ChecklistEntry entry = QSleazeAirportGenerateQuestFramework(task_entries, "questESlDebt", "Beat Dead the Deadbeats", "__item fixed-gear bicycle", 15, $item[bike rental broupon], "", "", "", $location[The Sunken Party Yacht], "Broden", $item[none]);
    if (__QSleazeAirportGenerateQuestFramework_return_quest_nearly_finished)
        return;
    entry.subentries[0].modifiers.listAppend("olfact drownedbeat");
}


void QSleazeAirportGenerateTasks(ChecklistEntry [int] task_entries)
{
    /*
    questESlMushStash - (?)Jimmy, Fun-Guy
    questESlAudit - (?)Taco Dan, Fun-Guy
    questESlBacteria - Broden, Fun-Guy, brodenBacteria
    
    questESlCheeseburger - Jimmy, Sloppy Seconds Diner, buffJimmyIngredients(?)
    questESlCocktail - Taco Dan, Sloppy Seconds Diner, tacoDanCocktailSauce
    questESlSprinkles - Broden, Sloppy Seconds Diner, brodenSprinkles
    
    questESlSalt - Jimmy, Sunken Yacht
    questESlFish - Taco Dan, Sunken Yacht, tacoDanFishMeat
    questESlDebt - (?)Broden, Sunken Yacht
    */
    //if (__misc_state["in run"] && !($locations[the sunken party yacht,sloppy seconds diner,the fun-guy mansion] contains __last_adventure_location)) //too many
        //return;
    ChecklistEntry [int] subtask_entries;
    QSleazeAirportMushStashGenerateTasks(subtask_entries); //
    QSleazeAirportAuditGenerateTasks(subtask_entries); //
    QSleazeAirportBacteriaGenerateTasks(subtask_entries); //
    QSleazeAirportCheeseburgerGenerateTasks(subtask_entries); //
    QSleazeAirportCocktailGenerateTasks(subtask_entries); //
    QSleazeAirportSprinklesGenerateTasks(subtask_entries); // mostly - quest didn't set to finish at the end (mafia bug?)
    QSleazeAirportSaltGenerateTasks(subtask_entries); //
    QSleazeAirportFishGenerateTasks(subtask_entries); //
    QSleazeAirportDebtGenerateTasks(subtask_entries); //
    
    if (subtask_entries.count() > 0)
    {
        //Combine them into one entry, for convenience:
        ChecklistEntry final_entry;
        boolean first = true;
        foreach key, entry in subtask_entries
        {
            if (first)
            {
                final_entry = entry;
                first = false;
            }
            else
            {
                foreach key2, subentry in entry.subentries
                {
                    final_entry.subentries.listAppend(subentry);
                }
                if (entry.should_highlight)
                    final_entry.should_highlight = true;
            }
            
        }
        
        task_entries.listAppend(final_entry);
    }
}

void QSleazeAirportGenerate(ChecklistCollection checklists)
{
    if (!__misc_state["sleaze airport available"])
        return;
    if (get_property("umdLastObtained") != "" && !__misc_state["in run"])
    {
        string umd_date_obtained = get_property("umdLastObtained");
        
        int day_in_year_acquired_umd = format_date_time("yyyy-MM-dd", umd_date_obtained, "D").to_int();
        int year_umd_acquired = format_date_time("yyyy-MM-dd", umd_date_obtained, "yyyy").to_int();
        
        string todays_date = today_to_string();
        int today_day_in_year = format_date_time("yyyyMMdd", todays_date, "D").to_int();
        int todays_year = format_date_time("yyyyMMdd", todays_date, "yyyy").to_int();
        
        //We compute the delta of days since last UMD obtained. If it's seven or higher, they can obtain it.
        //If the year is different, more complicated.
        //Umm... this will inevitably have an off by one error from me not looking closely enough.
        
        boolean has_been_seven_days = false;
        if (year_umd_acquired != todays_year)
        {
            //Query the number of days in last year, then subtract it from day_in_year_acquired_umd.
            
            int days_in_last_year = format_date_time("yyyy-MM-dd", todays_year + "-12-31", "D").to_int(); //this may work well past the year 10k. if it doesn't and you track down this bug and it's a problem, hello from eight thousand years ago!
            
            day_in_year_acquired_umd -= days_in_last_year * (todays_year - year_umd_acquired); //this is technically incorrect due to leap years, but it'll still result in proper checking. do not use for delta code
        }
        
        if (today_day_in_year - day_in_year_acquired_umd >= 7)
            has_been_seven_days = true;
        if (has_been_seven_days)
        {
            string [int] description;
            description.listAppend("Adventure in the Sunken Party Yacht.|Choose the first option from a non-combat that appears every twenty adventures.");
            description.listAppend("Found once every seven days.");
            if ($effect[fishy].have_effect() == 0)
                description.listAppend("Possibly acquire fishy effect first.");
            if ($item[clara's bell].available_amount() > 0 && !get_property_boolean("_claraBellUsed"))
                description.listAppend("Use clara's bell to instantly acquire. Won't need fishy.");
            ChecklistEntry entry = ChecklistEntryMake(38, "__item ultimate mind destroyer", $location[The Sunken Party Yacht].getClickableURLForLocation(), ChecklistSubentryMake("Ultimate Mind Destroyer collectable", "free runs", description), $locations[The Sunken Party Yacht]);
            entry.importance_level = 8;
            checklists.add(C_AFTERCORE_TASKS, entry);
        }
    }
}

//

void QSpookyAirportJunglePunGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item encrypted micro-cassette recorder";
    state.quest_name = "Pungle in the Jungle";
	QuestStateParseMafiaQuestProperty(state, "questESpJunglePun");
    
    if (!state.in_progress)
        return;
    item recorder = $item[encrypted micro-cassette recorder];
    
    if (recorder.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    int puns_remaining = 11 - get_property_int("junglePuns");
    if (state.mafia_internal_step <= 2 && puns_remaining > 0)
    {
        subentry.entries.listAppend("Adventure in The Deep Dark Jungle.");
        subentry.modifiers.listAppend("+myst");
        
        string [int] items_to_equip;
        if (recorder.equipped_amount() == 0)
        {
            items_to_equip.listAppend("encrypted micro-cassette recorder");
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        
        subentry.entries.listAppend(pluraliseWordy(puns_remaining, "pun", "puns").capitaliseFirstLetter() + " remaining.");
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
    
	task_entries.listAppend(ChecklistEntryMake(39, state.image_name, url, subentry, $locations[The Deep Dark Jungle]));
}

void QSpookyAirportFakeMediumGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__familiar happy medium";
    state.quest_name = "Fake Medium at Large";
	QuestStateParseMafiaQuestProperty(state, "questESpFakeMedium");
    
    if (!state.in_progress)
        return;
    item collar = $item[ESP suppression collar];
    
    
	ChecklistSubentry subentry;
    
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    if (state.mafia_internal_step == 1 && collar.available_amount() == 0)
    {
        subentry.entries.listAppend("Adventure in The Secret Government Laboratory, find a non-combat every twenty turns.");
		if (__misc_state["free runs available"])
			subentry.modifiers.listAppend("free runs");
		if (__misc_state["have hipster"])
			subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
        
        string [int,int] solutions;
        
        solutions.listAppend(listMake("dust motes float", "star"));
        solutions.listAppend(listMake("circle of light", "circle"));
        solutions.listAppend(listMake("waves a fly away", "waves"));
        solutions.listAppend(listMake("square one", "square"));
        solutions.listAppend(listMake("expression only adds to your anxiety", "plus"));
        
        
        subentry.entries.listAppend("The last line of the adventure text gives the solution:|*" + HTMLGenerateSimpleTableLines(solutions));
        
        string [int] items_to_equip;
        if ($item[Personal Ventilation Unit].equipped_amount() == 0 && $item[Personal Ventilation Unit].available_amount() > 0)
        {
            items_to_equip.listAppend("Personal Ventilation Unit");
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
    
	task_entries.listAppend(ChecklistEntryMake(40, state.image_name, url, subentry, $locations[The Secret Government Laboratory]));
}


void QSpookyAirportClipperGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item military-grade fingernail clippers";
    state.quest_name = "The Big Clipper";
	QuestStateParseMafiaQuestProperty(state, "questESpClipper");
    
    if (!state.in_progress)
        return;
    item clipper = $item[military-grade fingernail clippers];
    
    if (clipper.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    int fingernails_remaining = 23 - get_property_int("fingernailsClipped");
    if (state.mafia_internal_step == 1 && fingernails_remaining > 0)
    {
        subentry.entries.listAppend("Adventure in The Mansion of Dr. Weirdeaux, use the military-grade fingernail clippers on the monsters three times per fight.");
        
        int turns_remaining = ceil(fingernails_remaining.to_float() / 3.0);
        
        subentry.entries.listAppend(fingernails_remaining + " fingernails / " + pluralise(turns_remaining, "turn", "turns") + " remaining.");
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
    
	task_entries.listAppend(ChecklistEntryMake(41, state.image_name, url, subentry, $locations[The Mansion of Dr. Weirdeaux]));
}

void QSpookyAirportEveGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item vial of patchouli oil"; //science lab
    state.quest_name = "Choking on the Rind";
	QuestStateParseMafiaQuestProperty(state, "questESpEVE");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    if (state.mafia_internal_step < 2)
    {
        subentry.entries.listAppend("Adventure in The Secret Government Laboratory, find a non-combat every twenty turns.|At the choice adventure, choose " + listMake("Left", "Left", "Right", "Left", "Right").listJoinComponents(__html_right_arrow_character) + ".");
		if (__misc_state["free runs available"])
			subentry.modifiers.listAppend("free runs");
		if (__misc_state["have hipster"])
			subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
        string [int] items_to_equip;
        if ($item[Personal Ventilation Unit].equipped_amount() == 0 && $item[Personal Ventilation Unit].available_amount() > 0)
        {
            items_to_equip.listAppend("Personal Ventilation Unit");
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
	task_entries.listAppend(ChecklistEntryMake(42, state.image_name, url, subentry, $locations[The Secret Government Laboratory]));
}



void QSpookyAirportSmokesGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item pack of smokes";
    state.quest_name = "Everyone's Running Out of Smokes";
	QuestStateParseMafiaQuestProperty(state, "questESpSmokes");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    item smokes = $item[pack of smokes];
    
    if (state.mafia_internal_step < 2 && smokes.available_amount() < 10)
    {
        subentry.entries.listAppend("Adventure in The Deep Dark Jungle and collect smokes from the smoke monster.");
        subentry.modifiers.listAppend("olfact smoke monster");
        
        if (smokes != $item[none])
        {
            subentry.entries.listAppend(pluraliseWordy(clampi(10 - smokes.available_amount(), 0, 10), "more pack of smokes", "more packs of smokes").capitaliseFirstLetter() + " remaining.");
        }
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
	task_entries.listAppend(ChecklistEntryMake(43, state.image_name, url, subentry, $locations[The Deep Dark Jungle]));
}


void QSpookyAirportGoreGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item gore bucket";
    state.quest_name = "Gore Tipper";
	QuestStateParseMafiaQuestProperty(state, "questESpGore");
    
    if (!state.in_progress)
        return;
    item bucket = $item[gore bucket];
    
    if (bucket.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    int gore_remaining = 100 - get_property_int("goreCollected");
    if (state.mafia_internal_step <= 2 && gore_remaining > 0)
    {
        subentry.entries.listAppend("Adventure in The Secret Government Laboratory.");
        subentry.modifiers.listAppend("+meat");
        string [int] items_to_equip;
        if (bucket.equipped_amount() == 0)
        {
            items_to_equip.listAppend("gore bucket");
        }
        if ($item[Personal Ventilation Unit].equipped_amount() == 0 && $item[Personal Ventilation Unit].available_amount() > 0)
        {
            items_to_equip.listAppend("Personal Ventilation Unit");
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        subentry.entries.listAppend(pluralise(gore_remaining, "pound", "pounds") + " remaining.");
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
	task_entries.listAppend(ChecklistEntryMake(44, state.image_name, url, subentry, $locations[The Secret Government Laboratory]));
}


void QSpookyAirportOutOfOrderGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item GPS-tracking wristwatch";
    state.quest_name = "Out of Order";
	QuestStateParseMafiaQuestProperty(state, "questESpOutOfOrder");
    
    if (!state.in_progress)
        return;
    item wristwatch = $item[GPS-tracking wristwatch];
    
    if (wristwatch.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    if (state.mafia_internal_step <= 2 && $item[Project T. L. B.].item_amount() == 0)
    {
        subentry.modifiers.listAppend("+init");
        
        string [int] items_to_equip;
        if (wristwatch.equipped_amount() == 0)
        {
            items_to_equip.listAppend(wristwatch);
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        else
            subentry.entries.listAppend("Adventure in The Deep Dark Jungle.");
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
    
	task_entries.listAppend(ChecklistEntryMake(45, state.image_name, url, subentry, $locations[The Deep Dark Jungle]));
}


void QSpookyAirportSerumGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item experimental serum P-00";
    state.quest_name = "Serum Sortie";
	QuestStateParseMafiaQuestProperty(state, "questESpSerum");
    
    if (!state.in_progress)
        return;
    item serum = $item[experimental serum P-00];
    
    if (serum == $item[none])
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_spooky";
    
    
    if (state.mafia_internal_step <= 2 && serum.item_amount() < 5)
    {
        if (serum.available_amount() >= 5)
        {
            subentry.entries.listAppend("Pull " + pluralise(5 - serum.item_amount(), serum) + ".");
        }
        else
        {
            subentry.modifiers.listAppend("+item");
            
            subentry.entries.listAppend("Adventure in The Mansion of Dr. Weirdeaux, collect " + int_to_wordy(5 - serum.available_amount()) + " more " + serum.plural + ".");
        }
    }
    else
    {
        url = "place.php?whichplace=airport_spooky&action=airport2_radio";
        subentry.entries.listAppend("Return to the radio and reply.");
    }
    
	task_entries.listAppend(ChecklistEntryMake(46, state.image_name, url, subentry, $locations[The Mansion of Dr. Weirdeaux]));
}

void QSpookyAirportWeirdeauxGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (__last_adventure_location != $location[The Mansion of Dr. Weirdeaux] || my_level() >= 256)
        return;
    if (in_ronin())
        return;
    if (QuestState("questESpClipper").in_progress)
        return;
    
    string url = "place.php?whichplace=airport_spooky";
    string [int] description;
    string [int] modifiers;
    if (!$skill[curse of marinara].have_skill())
    {
        if (my_class() == $class[sauceror])
        {
            description.listAppend("Buy curse of marinara from the guild trainer.");
            url = "guild.php?place=trainer";
        }
        else if ($classes[disco bandit,disco bandit,seal clubber,turtle tamer,disco bandit,pastamancer,accordion thief,disco bandit] contains my_class())
        {
            description.listAppend("Ascend sauceror to buy curse of marinara.");
            url = "ascend.php";
        }
        else
            description.listAppend("Become a sauceror at the end of this ascension, to buy curse of marinara.");
    }
    else
    {
        if ($skill[utensil twist].have_skill() && $item[dinsey's pizza cutter].available_amount() > 0)
        {
            string [int] tasks;
            if ($item[dinsey's pizza cutter].equipped_amount() == 0)
                tasks.listAppend("equip Dinsey's Pizza Cutter");
            tasks.listAppend("cast curse of marinara");
            tasks.listAppend("keep monster stunned");
            tasks.listAppend("cast utensil twist repeatedly in combat");
            
            description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        }
        else
        {
            if ($skill[utensil twist].have_skill())
            {
                description.listAppend("Possibly acquire Dinsey's pizza cutter by fighting Wart Dinsey as a Pastamancer.");
            }
            else if ($item[dinsey's pizza cutter].available_amount() > 0)
            {
                description.listAppend("Possibly acquire the pastamancer skill Utensil Twist.");
            }
            else
            {
                description.listAppend("Possibly acquire the pastamancer skill Utensil Twist and Dinsey's pizza cutter by fighting Wart Dinsey as a Pastamancer.");
            }
            //Drunkula's bell - 15% to 20% of your buffed myst as damage?
            //right bear arm - Grizzly Scene, once/fight, 50% HP damage
            //Staff of the Headmaster's Victuals - chefstaff (requires skill), jiggle does 30% of monster HP
            //Great Wolf's lice - reduces monster attack/def by 30%. ???
            //great wolf's right paw, great wolf's left paw - gives Great Slash ability, which deals 1/3rd buffed muscle damage per paw equipped
            description.listAppend("Cast curse of marinara at the start of combat, and keep monster stunned.");
            string [item] other_relevant_items;
            other_relevant_items[$item[drunkula's bell]] = "throw in combat to deal damage";
            other_relevant_items[$item[right bear arm]] = "grizzly scene deals 50% HP damage";
            if ($skill[Spirit of Rigatoni].skill_is_usable())
                other_relevant_items[$item[Staff of the Headmaster's Victuals]] = "jiggle for 30% HP damage";
            other_relevant_items[$item[Great Wolf's lice]] = "throw in combat to deal damage";
            other_relevant_items[$item[great wolf's left paw]] = "great slash skill deals damage";
            other_relevant_items[$item[great wolf's right paw]] = "great slash skill deals damage";
            
            string [int] possibilities;
            foreach it, desc in other_relevant_items
            {
                if (it.available_amount() == 0)
                    continue;
                string line = it.capitaliseFirstLetter() + " - " + desc + ".";
                if (it.to_slot() != $slot[none] && it.equipped_amount() == 0)
                    line += " (equip)";
                possibilities.listAppend(line);
            }
            if (possibilities.count() > 0)
                description.listAppend("Try:|*" + possibilities.listJoinComponents("|*").capitaliseFirstLetter());
        }
        
        modifiers.listAppend("+spooky resistance");
        
        string [int] blocking_sources;
        if (!__misc_state["familiars temporarily blocked"])
            blocking_sources.listAppend("a potato familiar");
        foreach it in $items[Drunkula's ring of haze,Mesmereyes&trade; contact lenses,attorney's badge,ancient stone head,navel ring of navel gazing]
        {
            if (it.available_amount() == 0)
                continue;
            if (it.equipped_amount() > 0)
                continue;
            string line = it;
            if (it.equipped_amount() == 0)
                line += " (equip)";
            blocking_sources.listAppend(line);
        }
        if (my_class() == $class[pastamancer])
            blocking_sources.listAppend("spaghetti elemental thrall");
        if (blocking_sources.count() > 0)
            description.listAppend("Use sources of blocking, like " + blocking_sources.listJoinComponents(", ", "and") + ".");
    }
    
    //description.listAppend("Or use " + pluralise(clampi(256 - my_level(), 0, 256), "ultimate wad", "ultimate wads") + "."); //reasonable
    
	task_entries.listAppend(ChecklistEntryMake(47, "__effect Incredibly Hulking", url, ChecklistSubentryMake("Gain " + pluralise(clampi(256 - my_level(), 0, 256), "level", "levels"), modifiers, description), $locations[The Mansion of Dr. Weirdeaux]));
}

void QSpookyAirportGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (!__misc_state["spooky airport available"])
        return;
    //if (__misc_state["in run"] && !($locations[the mansion of dr. weirdeaux,the secret government laboratory,the deep dark jungle] contains __last_adventure_location)) //a common strategy is to accept an island quest in-run, then finish it upon prism break to do two quests in a day. so, don't clutter their interface unless they're adventuring there? hmm...
        //return;
    
    QSpookyAirportClipperGenerateTasks(task_entries);
    QSpookyAirportEVEGenerateTasks(task_entries);
    QSpookyAirportSmokesGenerateTasks(task_entries);
    QSpookyAirportSerumGenerateTasks(task_entries);
    QSpookyAirportOutOfOrderGenerateTasks(task_entries);
    QSpookyAirportFakeMediumGenerateTasks(task_entries);
    QSpookyAirportGoreGenerateTasks(task_entries);
    QSpookyAirportJunglePunGenerateTasks(task_entries);
    QSpookyAirportWeirdeauxGenerateTasks(task_entries);
}

void QStenchAirportFishTrashGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item trash net";
    state.quest_name = "Teach a Man to Fish Trash";
	QuestStateParseMafiaQuestProperty(state, "questEStFishTrash");
    
    if (!state.in_progress)
        return;
    item trash_net = $item[trash net];
    
    if (trash_net.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    
    if (state.mafia_internal_step <= 2)
    {
        string [int] items_to_equip;
        if (trash_net.equipped_amount() == 0)
        {
            items_to_equip.listAppend(trash_net);
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        else
        {
            int turns_remaining = clampi(get_property_int("dinseyFilthLevel") / 5, 0, 20);
            subentry.entries.listAppend("Adventure in Pirates of the Garbage Barges for " + pluraliseWordy(turns_remaining, "more turn", "more turns") + ".");
        }
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
        
	task_entries.listAppend(ChecklistEntryMake(48, state.image_name, url, subentry, $locations[pirates of the garbage barges]));
}

void QStenchAirportNastyBearsGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item black picnic basket";
    state.quest_name = "Nasty, Nasty Bears";
	QuestStateParseMafiaQuestProperty(state, "questEStNastyBears");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    
    int bears_left = 8 - get_property_int("dinseyNastyBearsDefeated");
    if (state.mafia_internal_step < 3 && bears_left > 0)
    {
        subentry.entries.listAppend("Adventure in Uncle Gator's Country Fun-Time Liquid Waste Sluice, defeat " + pluraliseWordy(bears_left, "more nasty bear", "more nasty bears") + ".");
        
        if (__misc_state["have olfaction equivalent"])
            subentry.modifiers.listAppend("olfact nasty bears?");
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
    
	task_entries.listAppend(ChecklistEntryMake(49, state.image_name, url, subentry, $locations[Uncle Gator's Country Fun-Time Liquid Waste Sluice]));
}

void QStenchAirportSocialJusticeIGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item ms. accessory";
    state.quest_name = "Social Justice Adventurer I";
	QuestStateParseMafiaQuestProperty(state, "questEStSocialJusticeI");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    
    int adventures_left = 15 - get_property_int("dinseySocialJusticeIProgress");
    if (state.mafia_internal_step < 2 && adventures_left > 0)
    {
        subentry.entries.listAppend("Adventure in Pirates of the Garbage Barges " + pluraliseWordy(adventures_left, "more time", "more times") + ".");
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
    
	task_entries.listAppend(ChecklistEntryMake(50, state.image_name, url, subentry, $locations[Pirates of the Garbage Barges]));
}

void QStenchAirportSocialJusticeIIGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__monster black knight";
    state.quest_name = "Social Justice Adventurer II";
	QuestStateParseMafiaQuestProperty(state, "questEStSocialJusticeII");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    
    if (state.mafia_internal_step < 2)
    {
        int adventures_left = clampi(15 - get_property_int("dinseySocialJusticeIIProgress"), 0, 15);
        subentry.entries.listAppend("Adventure in Uncle Gator's Country Fun-Time Liquid Waste Sluice " + pluraliseWordy(adventures_left, "more time", "more times") + ".");
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
    
	task_entries.listAppend(ChecklistEntryMake(51, state.image_name, url, subentry, $locations[Uncle Gator's Country Fun-Time Liquid Waste Sluice]));
}

void QStenchAirportSuperLuberGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item lube-shoes";
    state.quest_name = "Super Luber";
	QuestStateParseMafiaQuestProperty(state, "questEStSuperLuber");
    
    if (!state.in_progress)
        return;
    item quest_item = $item[lube-shoes];
    
    if (quest_item.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    
    if (state.mafia_internal_step <= 2)
    {
        string [int] items_to_equip;
        if (quest_item.equipped_amount() == 0)
        {
            items_to_equip.listAppend(quest_item);
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        else
        {
            subentry.entries.listAppend("Adventure in Barf Mountain, return to the kiosk after riding the rollercoaster.");
            subentry.modifiers.listAppend("optional +meat");
            if ($effect[How to Scam Tourists].have_effect() == 0 && $item[How to Avoid Scams].available_amount() > 0)
                subentry.entries.listAppend("Use How to Avoid Scams to farm extra meat, if you want.");
            
        }
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
        
	task_entries.listAppend(ChecklistEntryMake(52, state.image_name, url, subentry, $locations[barf mountain]));
}

void QStenchAirportZippityDooDahGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item tea for one";
    state.quest_name = "Whistling Zippity-Doo-Dah";
	QuestStateParseMafiaQuestProperty(state, "questEStZippityDooDah");
    
    if (!state.in_progress)
        return;
    item quest_item = $item[Dinsey mascot mask];
    
    if (quest_item.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    int turns_remaining = clampi(15 - get_property_int("dinseyFunProgress"), 0, 15);
    
    if (state.mafia_internal_step <= 2)
    {
        string [int] items_to_equip;
        if (quest_item.equipped_amount() == 0)
        {
            items_to_equip.listAppend(quest_item);
        }
        if (items_to_equip.count() > 0)
        {
            subentry.entries.listAppend(HTMLGenerateSpanFont("Equip the " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
            url = "inventory.php?which=2";
        }
        else
        {
            subentry.entries.listAppend("Adventure in the Toxic Teacups for " + pluraliseWordy(turns_remaining, "more turn", "more turns") + ".");
        }
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
        
	task_entries.listAppend(ChecklistEntryMake(53, state.image_name, url, subentry, $locations[the toxic teacups]));
}

void QStenchAirportWillWorkForFoodGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item complimentary Dinsey refreshments";
    state.quest_name = "Will Work With Food";
	QuestStateParseMafiaQuestProperty(state, "questEStWorkWithFood");
    
    if (!state.in_progress)
        return;
        
    item quest_item = $item[complimentary Dinsey refreshments];
    
    if (quest_item.available_amount() == 0)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    int tourists_to_feed = clampi(30 - get_property_int("dinseyTouristsFed"), 0, 30);
    if (state.mafia_internal_step == 1)
    {
        subentry.entries.listAppend("Adventure in Barf Mountain, use complimentary Dinsey refreshments on garbage/angry tourists.");
        subentry.entries.listAppend(pluraliseWordy(tourists_to_feed, "more remains", "more remain").capitaliseFirstLetter() + ".");
        subentry.modifiers.listAppend("olfact angry/garbage tourists");
        
    }
    else
    {
        subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
        state.image_name = "stench airport kiosk";
        url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
    }
        
	task_entries.listAppend(ChecklistEntryMake(54, state.image_name, url, subentry, $locations[barf mountain]));
}

void QStenchAirportGiveMeFuelGenerateTasks(ChecklistEntry [int] task_entries)
{
    QuestState state;
    state.image_name = "__item toxic globule";
    state.quest_name = "Give me fuel";
	QuestStateParseMafiaQuestProperty(state, "questEStGiveMeFuel");
    
    if (!state.in_progress)
        return;
    
	ChecklistSubentry subentry;
	
	subentry.header = state.quest_name;
	string url = "place.php?whichplace=airport_stench";
    
    if ($item[toxic globule].available_amount() < 20)
    {
        int globules_needed = clampi(20 - $item[toxic globule].available_amount(), 0, 20);
        if (!in_ronin())
        {
            subentry.entries.listAppend("Buy " + pluralise(globules_needed, "more toxic globule", "more toxic globules") + " in the mall.");
            url = "mall.php";
        }
        else
        {
            subentry.modifiers.listAppend("+unknown");
            subentry.entries.listAppend("Adventure in the Toxic Teacups and collect " + pluralise(globules_needed, "more toxic globule", "more toxic globules") + ".");
        }
    }
    else
    {
        if ($item[toxic globule].item_amount() < 20)
        {
            int globules_needed = clampi(20 - $item[toxic globule].item_amount(), 0, 20);
            subentry.entries.listAppend("Pull " + pluralise(globules_needed, "more toxic globule", "more toxic globules") + ".");
        }
        else
        {
            subentry.entries.listAppend("Collect wages from the employee assignment kiosk.");
            state.image_name = "stench airport kiosk";
            url = "place.php?whichplace=airport_stench&action=airport3_kiosk";
        }
    }
    
	task_entries.listAppend(ChecklistEntryMake(55, state.image_name, url, subentry, $locations[the toxic teacups]));
}

void QStenchAirportGarbageGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (get_property_boolean("_dinseyGarbageDisposed"))
        return;
    ChecklistSubentry subentry;
    /*subentry.header = "Turn in garbage";
    subentry.entries.listAppend("Maintenance Tunnels Access" + __html_right_arrow_character + "Waste Disposal.");
    task_entries.listAppend(ChecklistEntryMake(56, "__item bag of park garbage", "place.php?whichplace=airport_stench&action=airport3_tunnels", subentry));*/
    if ($item[bag of park garbage].item_amount() > 0)
    {
    }
    else if ($item[bag of park garbage].available_amount() > 0)
    {
    }
    else if (!in_ronin())
    {
        
    }
}

void QStenchAirportWartDinseyGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (get_property_ascension("lastWartDinseyDefeated"))
        return;
        
    item dinsey_item;
    if (my_class() == $class[seal clubber])
        dinsey_item = $item[Dinsey's oculus];
    else if (my_class() == $class[turtle tamer])
        dinsey_item = $item[Dinsey's radar dish];
    else if (my_class() == $class[pastamancer])
        dinsey_item = $item[Dinsey's pizza cutter];
    else if (my_class() == $class[sauceror])
        dinsey_item = $item[Dinsey's brain];
    else if (my_class() == $class[disco bandit])
        dinsey_item = $item[Dinsey's pants];
    else if (my_class() == $class[accordion thief])
        dinsey_item = $item[Dinsey's glove];
    if (!($classes[seal clubber,turtle tamer,pastamancer,sauceror,disco bandit,accordion thief] contains my_class())) //class-specific items only drop when you're class-specific
        return;
        
    if (last_monster() != $monster[Wart Dinsey])
    {
        if (dinsey_item == $item[none] || haveAtLeastXOfItemEverywhere(dinsey_item, 1))
            return;
    }
    boolean [item] keycards = $items[keycard &alpha;,keycard &beta;,keycard &gamma;,keycard &delta;];
    
    item [int] missing_keycards;
    foreach it in keycards
    {
        if (it.available_amount() == 0)
        {
            missing_keycards.listAppend(it);
        }
    }
    if (missing_keycards.count() > 0)
        return;
        
        
	string url = "place.php?whichplace=airport_stench&action=airport3_tunnels";
    string [int] description;
    string [int] modifiers;
    modifiers.listAppend("+" + MAX(250, $monster[Wart Dinsey].base_initiative) + "% init");
    modifiers.listAppend("+lots all resistance");
    
    item mercenary_pistol = $item[mercenary pistol];
    description.listAppend("Run +resistance, deal many sources of non-stench damage to him. (100 damage cap)");
    if (mercenary_pistol.available_amount() > 0)
    {
        string [int] tasks;
        if (mercenary_pistol.equipped_amount() == 0)
            tasks.listAppend("equip a mercenary pistol");
        item clip = $item[special clip: boneburners];
        if (clip.item_amount() == 0 && $item[special clip: splatterers].item_amount() > 0)
            clip = $item[special clip: splatterers];
        if (clip.item_amount() == 0)
        {
            tasks.listAppend("acquire a few clips of " + clip);
        }
        tasks.listAppend("throw " + clip + " in combat");
        
        description.listAppend(tasks.listJoinComponents(", ").capitaliseFirstLetter() + ".");
    }
    else
    {
        description.listAppend("The mercenary pistol is useful for this, if you can acquire one.");
    }
    description.listAppend("Will acquire a " + dinsey_item + ".");
    
	task_entries.listAppend(ChecklistEntryMake(57, "__item " + dinsey_item, url, ChecklistSubentryMake("Defeat Wart Dinsey", modifiers, description)));
}

void QStenchAirportGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (!__misc_state["stench airport available"])
        return;
    //if (__misc_state["in run"] && !($locations[Pirates of the Garbage Barges,Barf Mountain,The Toxic Teacups,Uncle Gator's Country Fun-Time Liquid Waste Sluice] contains __last_adventure_location))
        //return;
    QStenchAirportFishTrashGenerateTasks(task_entries);
    QStenchAirportNastyBearsGenerateTasks(task_entries);
    QStenchAirportSocialJusticeIGenerateTasks(task_entries);
    QStenchAirportSocialJusticeIIGenerateTasks(task_entries);
    QStenchAirportSuperLuberGenerateTasks(task_entries);
    QStenchAirportZippityDooDahGenerateTasks(task_entries);
    QStenchAirportGarbageGenerateTasks(task_entries);
    QStenchAirportGiveMeFuelGenerateTasks(task_entries);
    QStenchAirportWillWorkForFoodGenerateTasks(task_entries);
    QStenchAirportWartDinseyGenerateTasks(task_entries);
}

void QHotAirportLavaCoLampGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (in_ronin())
        return;
        
    if (__last_adventure_location != $location[LavaCo&trade; Lamp Factory]) //dave's not here, man
        return;
    
    item [int] missing_lamps = $items[Red LavaCo Lamp&trade;,Green LavaCo Lamp&trade;,Blue LavaCo Lamp&trade;].items_missing();
    
    if (missing_lamps.count() == 0)
        return;
        
    string url = "place.php?whichplace=airport_hot";
    string [int] modifiers;
    string [int] description;
    
    
    description.listAppend("+5 adventures/+sleepstatgain offhand, useful in ascension.");
    
    //One at a time:
    
    item targeting_lamp = missing_lamps[0];
    string [int] colours_missing;
    foreach key, it in missing_lamps
        colours_missing.listAppend(it.to_string().replace_string(" LavaCo Lamp&trade;", ""));
        
    string colour = colours_missing[0];
    
    item capped_item = to_item("capped " + colour + " lava bottle");
    item uncapped_item = to_item("uncapped " + colour + " lava bottle");
    item lava_glob_item = to_item(colour + " lava globs");
    
        
    if (capped_item.available_amount() == 0)
    {
        boolean have_all_items = true;
        if ($item[SMOOCH bottlecap].available_amount() == 0)
        {
            have_all_items = false;
            string line;
            line = "Acquire a SMOOCH bottlecap by eating SMOOCH soda";
            if (availableFullness() == 0)
                line += " later";
            line += ".";
            
            description.listAppend(line);
        }
        //uncapped red lava bottle
        if (uncapped_item.available_amount() == 0)
        {
            have_all_items = false;
            string [int] subdescription;
            if (lava_glob_item.available_amount() == 0)
            {
                subdescription.listAppend("Acquire " + lava_glob_item + " in LavaCo NC: Use the glob dyer" + __html_right_arrow_character + "Dye them " + colour + ".");
            }
            if ($item[full lava bottle].available_amount() > 0)
            {
                if (lava_glob_item.available_amount() > 0)
                {
                    subdescription.listAppend("Use " + lava_glob_item + ".");
                    url = "inventory.php?which=3";
                }
            }
            else
            {
                if ($item[empty lava bottle].item_amount() > 0)
                {
                    subdescription.listAppend("Adventure in the LavaCo&trade; Lamp Factory, use the squirter.");
                }
                else if ($item[empty lava bottle].available_amount() > 0)
                {
                    subdescription.listAppend("Acquire an empty lava bottle. (From hagnk's?)");
                }
                else
                {
                    if ($item[New Age healing crystal].item_amount() > 0)
                    {
                        subdescription.listAppend("Adventure in the LavaCo&trade; Lamp Factory, use the klin.");
                    }
                    else
                        subdescription.listAppend("Acquire New Age healing crystal from the mall or the mine.");
                }
            }
            
            description.listAppend("Acquire an " + uncapped_item + ".|*" + subdescription.listJoinComponents("|*"));
        }
        if (have_all_items) //capped_item.creatable_amount() > 0) //BUG: capped_item.creatable_amount() > 0 when only having cap
        {
            description.listAppend("Make " + capped_item + " (" + uncapped_item + " + SMOOCH bottlecap)");
            url = "craft.php?mode=combine";
        }
    }
    else if ($item[LavaCo&trade; Lamp housing].available_amount() > 0)
    {
        description.listAppend("Combine " + capped_item + " and LavaCo&trade; Lamp housing.");
        url = "craft.php?mode=combine";
    }
    
    if ($item[LavaCo&trade; Lamp housing].available_amount() == 0)
    {
        boolean have_all_items = true;
        if ($item[crystalline light bulb].item_amount() == 0)
        {
            have_all_items = false;
            
            if ($item[glowing New Age crystal].item_amount() > 0)
            {
                description.listAppend("Adventure in the LavaCo&trade; Lamp Factory, use the bulber.");
            }
            else
            {
                description.listAppend("Acquire glowing New Age crystal. (mall, or healing crystal golem in the mine))");
            }
        }
        if ($item[heat-resistant sheet metal].item_amount() == 0)
        {
            have_all_items = false;
            description.listAppend("Buy heat-resistant sheet metal from the mall.");
        }
        if ($item[insulated gold wire].item_amount() == 0)
        {
            have_all_items = false;
            
            
            if ($item[insulated gold wire].available_amount() > 0)
            {
                description.listAppend("Acquire insulated gold wire. (in hagnk's?)");
            }
            else if ($item[insulated gold wire].creatable_amount() > 0)
            {
                description.listAppend("Make insulated gold wire. (thin gold wire + unsmoothed velvet");
                url = "craft.php?mode=combine";
            }
            else
            {
                if ($item[thin gold wire].available_amount() == 0)
                {
                    if ($item[1\,970 carat gold].item_amount() == 0)
                    {
                        description.listAppend("Acquire 1,970 carat gold by mining in the mine.");
                    }
                    else
                    {
                        description.listAppend("Adventure in the LavaCo&trade; Lamp Factory, use the wire puller.");
                    }
                }
                if ($item[unsmoothed velvet].available_amount() == 0)
                    description.listAppend("Buy unsmoothed velvet in the mall.");
            }
        }
        
        if (have_all_items)
        {
            description.listAppend("At the LavaCo&trade; NC, use the chassis assembler.");
        }
    }
    
    
	task_entries.listAppend(ChecklistEntryMake(58, "__item " + missing_lamps[0], url, ChecklistSubentryMake("Make a " + colours_missing.listJoinComponents(", ", "and") + " LavaCo Lamp&trade;", modifiers, description), $locations[LavaCo&trade; Lamp Factory]));
}

void QHotAirportGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (!__misc_state["hot airport available"])
        return;
    
    QHotAirportLavaCoLampGenerateTasks(task_entries);
}

void QHotAirportGenerate(ChecklistCollection checklists)
{
    if (!__misc_state["hot airport available"])
        return;
    //Elevator:
    if (!get_property_boolean("_infernoDiscoVisited")) //FIXME replace with what this is named
    {
        int potential_disco_style_level = 0;
        int current_disco_style_level = 0;
        item [int] items_to_equip_for_additional_style;
        foreach it in $items[smooth velvet pocket square,smooth velvet socks,smooth velvet hat,smooth velvet shirt,smooth velvet hanky,smooth velvet pants]
        {
            if (it.equipped_amount() > 0)
                current_disco_style_level += 1;
            else if (it.available_amount() > 0)
                potential_disco_style_level += 1;
        }
        potential_disco_style_level += current_disco_style_level;
        
        string [int] description;
        string url = "place.php?whichplace=airport_hot&action=airport4_zone1";
        if (current_disco_style_level == 0)
            url = "inventory.php?which=2";
        /*
        Requires... disco style? (velvet gear)
        Floor 1: Gain 100 points in each stat!
        Floor 2: Get a temporary boost to Item Drops!
        Floor 3: Fight Travoltron!
        Floor 4: Reduce your Drunkenness by 1
        Floor 5: Go backwards in time by 5 Adventures!
        Floor 6: Get a Volcoino!
        */
        Record DiscoFloor
        {
            int floor_number;
            string description;
            boolean grey_out;
        };
        DiscoFloor DiscoFloorMake(int floor_number, string description, boolean grey_out)
        {
            DiscoFloor floor;
            floor.floor_number = floor_number;
            floor.description = description;
            floor.grey_out = grey_out;
            return floor;
        }
        DiscoFloor DiscoFloorMake(int floor_number, string description)
        {
            return DiscoFloorMake(floor_number, description, false);
        }
        void listAppend(DiscoFloor [int] list, DiscoFloor entry)
        {
            int position = list.count();
            while (list contains position)
                position += 1;
            list[position] = entry;
        }
        
        DiscoFloor [int] floors;
        if (__misc_state["need to level"])
            floors.listAppend(DiscoFloorMake(1, "+100 all substats."));
        
        floors.listAppend(DiscoFloorMake(2, "+100% item for 20 turns."));
        floors.listAppend(DiscoFloorMake(3, "Fight Travoltron."));
        if (inebriety_limit() > 0)
        {
            if (my_inebriety() == 0)
                floors.listAppend(DiscoFloorMake(4, "-1 drunkenness. (drink first)", true));
            else
                floors.listAppend(DiscoFloorMake(4, "-1 drunkenness."));
        }
        if (my_path_id() != PATH_SLOW_AND_STEADY)
            floors.listAppend(DiscoFloorMake(5, "+5 adventures, extend effects."));
        floors.listAppend(DiscoFloorMake(6, "Gain a volcoino."));
        
        foreach key, floor in floors
        {
            if (floor.floor_number > potential_disco_style_level)
                continue;
            
            string line = "Floor " + floor.floor_number + ": " + floor.description;
            if (floor.floor_number > current_disco_style_level || floor.grey_out)
            {
                if (floor.floor_number > current_disco_style_level)
                    line += " (wear smooth velvet)";
                line = HTMLGenerateSpanFont(line, "grey");
            }
            description.listAppend(line);
        }
        
        if (items_to_equip_for_additional_style.count() > 0 && potential_disco_style_level > current_disco_style_level)
            description.listAppend("Can equip " + items_to_equip_for_additional_style.listJoinComponents(", ", "and") + " for more style.");
        
        //fancy tophat, insane tophat, brown felt tophat, isotophat, tiny top hat and cane
        if (potential_disco_style_level > 0)
            checklists.add(C_RESOURCES, ChecklistEntryMake(59, "__item disco ball", url, ChecklistSubentryMake("One elevator ride", "", description), 5));
    }
}

void QColdAirportGenerateTasks(ChecklistEntry [int] task_entries)
{
    if (!__misc_state["cold airport available"])
        return;
    string desired_walford_item = get_property("walfordBucketItem").to_lower_case();
    if ($item[Walford's bucket].available_amount() > 0 && QuestState("questECoBucket").in_progress && desired_walford_item != "") //need quest tracking as well, you keep the bucket. FIXME should we be testing against desired_walford_item?
    {
        string title = "";
        string [int] modifiers;
        string [int] description;
        string url = $location[The Ice Hotel].getClickableURLForLocation();
        int progress = get_property_int("walfordBucketProgress");
        if (progress >= 100)
        {
            url = "place.php?whichplace=airport_cold&action=glac_walrus";
            title = "Talk to Walford";
            description.listAppend("Turn in the quest.");
        }
        else
        {
            title = "Walford's quest";
            
            modifiers.listAppend("-combat");
            string [int] options;
            
            options.listAppend("The Ice Hole" + ($effect[fishy].have_effect() == 0 ? " with fishy" : "") + ". (5% per turn)");
            
            string [int] tasks;
            string hotel_string = "The Ice Hotel.";
            boolean nc_helps_in_hotel = true;
            if (desired_walford_item == "milk" || desired_walford_item == "rain")
                nc_helps_in_hotel = false;
            if (nc_helps_in_hotel)
            {
                if ($item[bellhop's hat].equipped_amount() == 0 && desired_walford_item != "moonbeams")
                    tasks.listAppend("equip bellhop's hat");
                tasks.listAppend("run -combat");
            }
            if (desired_walford_item == "moonbeams" && $slot[hat].equipped_item() != $item[none])
            {
                tasks.listAppend("unequip your hat");
            }
            if (desired_walford_item == "blood")
                tasks.listAppend("use tin snips every fight");
            if (desired_walford_item == "chicken" && numeric_modifier("food drop") < 50.0)
            {
                modifiers.listAppend("+50% food drop");
                tasks.listAppend("run +50% food drop");
            }
            if (desired_walford_item == "milk" && numeric_modifier("booze drop") < 50.0)
            {
                modifiers.listAppend("+50% booze drop");
                tasks.listAppend("run +50% booze drop");
            }
            if (desired_walford_item == "rain")
                tasks.listAppend("cast hot spells");
            //FIXME verify all (ice?)
            
            if (!get_property_boolean("_iceHotelRoomsRaided"))
                tasks.listAppend("collect once/day certificates");
            if (tasks.count() > 0)
                hotel_string += " " + tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
            
            options.listAppend(hotel_string);
            
            tasks.listClear();
            string vkyea_string = "VYKEA.";
            boolean nc_helps_in_vykea = true;
            if (desired_walford_item == "blood")
                nc_helps_in_vykea = false;
            if (nc_helps_in_vykea)
            {
                tasks.listAppend("run -combat");
            }
            if (desired_walford_item == "moonbeams" && $slot[hat].equipped_item() != $item[none])
            {
                tasks.listAppend("unequip your hat");
            }
            if (desired_walford_item == "blood")
                tasks.listAppend("use tin snips every fight");
            if (desired_walford_item == "bolts" && $item[VYKEA hex key].equipped_amount() == 0)
                tasks.listAppend("equip VYKEA hex key");
            if (desired_walford_item == "chum" && meat_drop_modifier() < 250.0)
            {
                modifiers.listAppend("+250% meat");
                tasks.listAppend("run +250% meat");
            }
            if (desired_walford_item == "balls" && item_drop_modifier() < 50)
            {
                modifiers.listAppend("+50% item");
                tasks.listAppend("run +50% item");
            }
            if (!get_property_boolean("_VYKEALoungeRaided"))
                tasks.listAppend("collect once/day certificates");
            
            if (tasks.count() > 0)
                vkyea_string += " " + tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
            
            options.listAppend(vkyea_string);
            
            tasks.listClear();
            if ($item[Walford's bucket].equipped_amount() == 0)
            {
                url = generateEquipmentLink($item[walford's bucket]);
                tasks.listAppend("equip walford's bucket");
            }
            tasks.listAppend("adventure on the glacier");
            description.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ":|*" + options.listJoinComponents("<hr>|*"));
            
            
            description.listAppend(progress + "% done collecting " + desired_walford_item + ".");
        }
        task_entries.listAppend(ChecklistEntryMake(60, "__item Walford's bucket", url, ChecklistSubentryMake(title, modifiers, description), $locations[The Ice Hotel,VYKEA,The Ice Hole]));
    }
}

RegisterGenerationFunction("QAirportGenerate");
void QAirportGenerate(ChecklistCollection checklists)
{
	//trying to port this file over to the new system would be a nightmare; do it this way
    ChecklistEntry [int] chosen_entries = checklists.lookup(C_AFTERCORE_TASKS).entries;
    
    QSleazeAirportGenerateTasks(chosen_entries);
    QSpookyAirportGenerateTasks(chosen_entries);
    QStenchAirportGenerateTasks(chosen_entries);
    QHotAirportGenerateTasks(chosen_entries);
    QColdAirportGenerateTasks(chosen_entries);
    
    QSleazeAirportGenerate(checklists);
    QHotAirportGenerate(checklists);
}

void QSubject37Init()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM13Escape");
    
    
	state.quest_name = "The Pretty Good Escape";
	state.image_name = "__item mysterious silver lapel pin";
	
	state.startable = true;
	
	__quest_state["Subject 37"] = state;
}


void QSubject37GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Subject 37"];
	if (!base_quest_state.in_progress)
		return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    
    string active_url = $location[Cobb's Knob Menagerie, Level 1].getClickableURLForLocation();
    
    /*
started	Subject 37 wants you to investigate the Cobb's Knob Laboratories and find out what they're planning.
step1	Take the file you found back to Subject 37.
step2	Subject 37 wants something from the BASIC Elementals on level 1 of the Cobb's Knob Menagerie.
step3	Take the GOTO back to Subject 37.
step4	Subject 37 wants some weremoose spit from level 2 of the Cobb's Knob Menagerie.
step5	Take the spit back to Subject 37.
step6	Subject 37 wants some abominable blubber from level 3 of the Cobb's Knob Menagerie.
step7	Take the blubber back to Subject 37.
step8	You've done a good turn, and helped Subject 37 make his escape from the Cobb's Knob Menagerie.
    */
    
    boolean need_to_return_goto = base_quest_state.mafia_internal_step <= 3;
    boolean need_to_return_weremoose = base_quest_state.mafia_internal_step <= 5;
    boolean need_to_return_blubber = base_quest_state.mafia_internal_step <= 7;
    
    if (base_quest_state.mafia_internal_step == 1)
    {
        subentry.entries.listAppend("Acquire a subject 37 file from Knob Goblin Very Mad Scientist.");
        if (!$monster[Knob Goblin Mad Scientist].is_banished())
            subentry.modifiers.listAppend("banish Knob Goblin Mad Scientist");
        active_url = $location[Cobb's Knob Laboratory].getClickableURLForLocation();
    }
    else if (base_quest_state.mafia_internal_step == 2)
    {
        subentry.entries.listAppend("Return the file to Subject 37.");
    }
    else
    {
    	boolean [item] items_needed;
     
        item [int] items_to_buy_in_mall;
        if (need_to_return_goto && $item[goto].available_amount() == 0)
        {
            //234% item from BASIC elemental
            if (!in_ronin())
            {
            	items_needed[$item[goto]] = true;
            }
            else
            {
                subentry.modifiers.listAppend("+234% item");
                subentry.entries.listAppend("10 ADVENTURE \"MENAGERIE LEVEL 1\"|20 PRINT \"COLLECT GOTO FROM BASIC ELEMENTAL\"|30 GOTO 10");
            }
        }
        if (need_to_return_weremoose && $item[weremoose spit].available_amount() == 0)
        {
            //+item? from weremoose
            if (!in_ronin())
            {
                items_needed[$item[weremoose spit]] = true;
            }
            else
            {
                if (subentry.modifiers.count() == 0)
                    subentry.modifiers.listAppend("+item?");
                subentry.entries.listAppend("Collect weremoose spit from a weremoose in Menagerie Level 2.");
            }
        }
        if (need_to_return_blubber && $item[abominable blubber].available_amount() == 0)
        {
            //234% item from Portly Abomination
            if (!in_ronin())
            {
                items_needed[$item[abominable blubber]] = true;
            }
            else
            {
                if (subentry.modifiers.count() == 0)
                    subentry.modifiers.listAppend("+234% item");
                subentry.entries.listAppend("Collect abominable blubber from a Portly Abomination in Menagerie Level 3.");
            }
        }
        foreach it in items_needed
        {
        	if (it.available_amount() == 0)
                items_to_buy_in_mall.listAppend(it);
            else
                subentry.entries.listAppend("Acquire " + it + ", from storage(?).");
        }
        if (items_to_buy_in_mall.count() > 0)
        {
            subentry.entries.listAppend("Buy " + items_to_buy_in_mall.listJoinComponents(", ", "and") + " from the mall.");
            active_url = "mall.php";
        }
        if (subentry.entries.count() == 0)
        {
            subentry.entries.listAppend("Speak to Subject 37.");
        }
    }
		
	optional_task_entries.listAppend(ChecklistEntryMake(28, base_quest_state.image_name, active_url, subentry, $locations[]));
}
void QMartyInit()
{
	//questM03Bugbear
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM18Swamp");
	
	state.quest_name = "Marty's Quest";
	state.image_name = "__item maple leaf";
	
	state.startable = knoll_available();
	
	__quest_state["Marty"] = state;
}

void QMartyGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	QuestState base_quest_state = __quest_state["Marty"];
	if (!base_quest_state.in_progress)
		return;
    if (!canadia_available())
        return;
    if (__misc_state["in run"] && $location[the bugbear pen].turnsAttemptedInLocation() == 0)
        return;
        
	string url = "place.php?whichplace=marais";
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
    
    //FIXME use locationAvailable(), as mafia has tracking for area unlocks:
    
    int fork_ncs_seen = 0;
    foreach key, NC in $location[the edge of the swamp].locationSeenNoncombats()
    {
        if (NC == "Stick a Fork In It")
            fork_ncs_seen += 1;
    }
    boolean minus_combat_relevant = false;
    
    if (fork_ncs_seen < 2)
    {
        subentry.entries.listAppend("Adventure in the edge of the swamp, unlock both the left and right paths in the fork.");
        minus_combat_relevant = true;
    }
    else
    {
        int sophies_seen = 0;
        foreach key, NC in $location[the Dark and Spooky Swamp].locationSeenNoncombats()
        {
            if (NC == "Sophie's Choice")
                sophies_seen += 1;
        }
        if (sophies_seen < 2)
        {
            subentry.entries.listAppend("Adventure in the Dark and Spooky Swamp, unlock both paths from Sophie's Choice.");
            minus_combat_relevant = true;
        }
        else
        {
            //corpse bog, ruined wizard tower
            if ($item[Phil Bunion's axe].available_amount() == 0)
            {
                //corpse bog
                subentry.entries.listAppend("Adventure in the Corpse Bog to defeat the ghost of Phil Bunion.");
            }
            if (!$location[the ruined wizard tower].noncombat_queue.contains_text("How to Get a Head in Navigating"))
            {
                subentry.entries.listAppend("Adventure in the Ruined Wizard Tower to find a shrunken navigator head.");
                minus_combat_relevant = true;
            }
        }
        int bad_to_worses_seen = 0;
        foreach key, NC in $location[the Wildlife Sanctuarrrrrgh].locationSeenNoncombats()
        {
            if (NC == "From Bad to Worst")
                bad_to_worses_seen += 1;
        }
        if (bad_to_worses_seen < 2)
        {
            subentry.entries.listAppend("Adventure in the Wildlife Sanctuarrrrrgh, unlock both paths from From Bad to Worst.");
            minus_combat_relevant = true;
        }
        else
        {
            //swamp beaver territory, weird swamp village
            if ($item[bouquet of swamp roses].available_amount() == 0)
            {
                subentry.entries.listAppend("Adventure in the Weird Swamp Village to defeat a swamp skunk.");
                subentry.modifiers.listAppend("+item?");
            }
            if ($item[shrunken navigator head].available_amount() > 0 && $item[branch from the Great Tree].available_amount() == 0)
            {
                minus_combat_relevant = true;
                subentry.entries.listAppend("Adventure in the Swamp Beaver Territory, follow the shrunken navigator head's directions, and defeat a conservationist hippy.");
            }
        }
    }
    if (minus_combat_relevant) //....?
        subentry.modifiers.listAppend("-combat?");
        
    if ($items[Phil Bunion's axe,bouquet of swamp roses,branch from the Great Tree].items_missing().count() == 0)
    {
        subentry.entries.listAppend("Go talk to Marty to finish the quest.");
        url = "place.php?whichplace=canadia";
    }
	
    boolean [location] relevant_locations;
    relevant_locations[$location[the edge of the swamp]] = true;
    relevant_locations[$location[The Dark and Spooky Swamp]] = true;
    relevant_locations[$location[The Corpse Bog]] = true;
    relevant_locations[$location[The Ruined Wizard Tower]] = true;
    relevant_locations[$location[The Wildlife Sanctuarrrrrgh]] = true;
    relevant_locations[$location[Swamp Beaver Territory]] = true;
    relevant_locations[$location[The Weird Swamp Village]] = true;
	
	optional_task_entries.listAppend(ChecklistEntryMake(81, base_quest_state.image_name, url, subentry, relevant_locations));
    
    
}

void QMeatsmithInit()
{
	//questM23Meatsmith
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM23Meatsmith");
	
	state.quest_name = "Helping Make Ends Meat";
	state.image_name = "__item gnawed-up dog bone";
	
	state.startable = true;
	
	__quest_state["Meatsmith"] = state;
}

RegisterGenerationFunction("QMeatsmithGenerate");
void QMeatsmithGenerate(ChecklistCollection checklists)
{
	QuestState base_quest_state = __quest_state["Meatsmith"];
    if (base_quest_state.finished)
        return;
    
    //if (__last_adventure_location != $location[the skeleton store] || __last_adventure_location == $location[none])
        //return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "place.php?whichplace=town_market";
    
    boolean done = false;
    boolean have_reason_to_add = false;
    
	if (!base_quest_state.started)
    {
        have_reason_to_add = true;
        subentry.entries.listAppend("Go talk to the meatsmith to start the quest.");
    }
    else if (base_quest_state.mafia_internal_step == 1)
    {
        have_reason_to_add = true;
        if ($item[skeleton store office key].available_amount() == 0)
        {
            subentry.entries.listAppend("Check out the cash register at the NC.");
        }
        else
        {
            subentry.entries.listAppend("Head into the manager's office at the NC.");
        }
    }
    else if (base_quest_state.mafia_internal_step == 2)
    {
        have_reason_to_add = true;
        done = true;
        subentry.entries.listAppend("Return to the meatsmith.");
        active_url = "shop.php?whichshop=meatsmith";
    }
    
    if ($item[ring of telling skeletons what to do].item_amount() == 0)
    {
        if (!have_reason_to_add)
            subentry.header = "The Skeleton Store";
        string line = "Could acquire a ring of telling skeletons what to do, by opening the chest at the NC";
        if ($item[skeleton key].item_amount() == 0)
            line += HTMLGenerateSpanFont(" after acquiring a skeleton key", "red");
            
        line += ".";
        subentry.entries.listAppend(line);
        have_reason_to_add = true;
    }
    
    if (!done)
        subentry.entries.listAppend("Non-combat appears every fourth adventure."); //except the first time for some reason? needs spading
    
    if (have_reason_to_add)
        checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(11, base_quest_state.image_name, active_url, subentry, locationToLocationMap($location[the skeleton store])));
}
void QGalaktikInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM24Doc");
    
	
	state.quest_name = "What's Up, Doc?";
	state.image_name = "__item pretty flower";
	
	state.startable = true;
	
	__quest_state["Galaktik"] = state;
}


RegisterGenerationFunction("QGalaktikGenerate");
void QGalaktikGenerate(ChecklistCollection checklists)
{
	QuestState base_quest_state = __quest_state["Galaktik"];
	if (!base_quest_state.in_progress)
		return;
		
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "place.php?whichplace=town_wrong";
    string image_name = base_quest_state.image_name;
    
    string [int] missing_item_descriptions;
    foreach it in $items[swindleblossom,fraudwort,shysterweed]
    {
        if (it.available_amount() >= 3)
            continue;
        missing_item_descriptions.listAppend(pluraliseWordy(3 - it.available_amount(), "more " + it, "more " + it.plural));
    }
    
    if (missing_item_descriptions.count() > 0)
    {
        subentry.entries.listAppend("Collect " + missing_item_descriptions.listJoinComponents(", ", "and") + " in the overgrown lot.");
        if ($item[brown paper bag mask].available_amount() > 0 && $item[brown paper bag mask].equipped_amount() == 0)
            subentry.entries.listAppend("Could equip the brown paper bag mask to meet the Lot's wife, if you haven't already.");
        
        //if (__misc_state["in run"] && __last_adventure_location != $location[the overgrown lot] && !in_bad_moon())
            //return;
    }
    else
    {
        //shop.php?whichshop=doc&action=talk
        active_url = "shop.php?whichshop=doc&action=talk";
        subentry.entries.listAppend("Return to Doc Galaktik.");
        //image_name = "__familiar o.a.f.";
    }
	
	checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(35, image_name, active_url, subentry, $locations[the overgrown lot]));
}

void QOldLandfillInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM19Hippy");
	
	state.quest_name = "Give a Hippy a Boat";
	state.image_name = "__item junk junk";
	
	state.startable = true;
	
	__quest_state["Old Landfill"] = state;
}


RegisterGenerationFunction("QOldLandfillGenerate");
void QOldLandfillGenerate(ChecklistCollection collection)
{
	QuestState base_quest_state = __quest_state["Old Landfill"];
	//if (!base_quest_state.in_progress) //this isn't actively tracked, so the best we can do is checking the last adventure location
		//return;
    if ($item[junk junk].available_amount() > 0) //FIXME returning to the hippy
        return;
    if (__last_adventure_location != $location[the old landfill] && !base_quest_state.in_progress)
        return;
    if (__misc_state["mysterious island available"])
        return;
		
	ChecklistSubentry subentry;
    subentry.entries.listAppend("Unlocks the Mysterious Island.");
    
    item [int] missing_boat_items = $items[old claw-foot bathtub,old clothesline pole,antique cigar sign].items_missing();
	
	subentry.header = base_quest_state.quest_name;
	
	string active_url = "place.php?whichplace=woods";
    
    if ($item[worse homes and gardens].available_amount() > 0 && missing_boat_items.count() == 0)
    {
        active_url = "shop.php?whichshop=junkmagazine";
        subentry.entries.listAppend("Use worse homes and gardens, craft a junk junk.");
    }
    else
    {
        string [int] nc_instructions = listMake("Go left", "Flush a bunch of toilets");
        
        if ($item[old claw-foot bathtub].available_amount() == 0)
        {
            nc_instructions = listMake("Go left", "Take the tub");
        }
        else if ($item[old clothesline pole].available_amount() == 0)
        {
            nc_instructions = listMake("Go center", "Take the antenna");
        }
        else if ($item[antique cigar sign].available_amount() == 0)
        {
            nc_instructions = listMake("Go right", "Take the sign");
        }
        
        
        if (missing_boat_items.count() > $item[funky junk key].available_amount() || $item[worse homes and gardens].available_amount() == 0)
        {
            subentry.modifiers.listAppend("+item");
            subentry.entries.listAppend("Adventure in the Old Landfill with +item.");
        }
        else
            subentry.entries.listAppend("Adventure in the Old Landfill.");
        
        subentry.entries.listAppend("At the choice adventure, choose:|*" + nc_instructions.listJoinComponents(__html_right_arrow_character) + ".");
    }
	
    
	collection.add(C_OPTIONAL_TASKS, ChecklistEntryMake(93, base_quest_state.image_name, active_url, subentry, $locations[the old landfill]));
}
//questM25Armorer
void QMadnessBakeryInit()
{
	QuestState state;
	
	QuestStateParseMafiaQuestProperty(state, "questM25Armorer");
	
	state.quest_name = "Lending a Hand (and a Foot)";
	state.image_name = "__item unlit birthday cake";
    
	
	__quest_state["Madness Bakery"] = state;
}


RegisterGenerationFunction("QMadnessBakeryGenerate");
void QMadnessBakeryGenerate(ChecklistCollection checklists)
{
	QuestState base_quest_state = __quest_state["Madness Bakery"];
	if (!base_quest_state.in_progress)
		return;
    
	ChecklistSubentry subentry;
	
	subentry.header = base_quest_state.quest_name;
	
	string url = "place.php?whichplace=town_right";
    
    if ($item[no-handed pie].available_amount() > 0 || base_quest_state.mafia_internal_step >= 5)
    {
        subentry.entries.listAppend("Talk to the leggerer.");
        url = "place.php?whichplace=town_market";
    }
    else
    {
        //step1 seems to exist, but no information on office visits left
        //step2 - cake lord
        //step3 - in the progress of talking to madeline
        //step4 - acquire cake
        //step5 - melon lord?
        subentry.entries.listAppend("Adventure in the Madness Bakery|Choose the first option in the non-combat repeatedly.");
    }
		
	checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(1, base_quest_state.image_name, url, subentry, $locations[Madness Bakery]));
}


void QuestsInit()
{
	QPirateInit();
	QLevel2Init();
	QLevel3Init();
	QLevel4Init();
	QLevel5Init();
	QLevel6Init();
	QLevel7Init();
	QLevel8Init();
	QLevel9Init();
	QLevel10Init();
	QLevel11Init();
	QLevel12Init();
	QLevel13Init();
	QNemesisInit();
	QSeaInit();
	QSpaceElvesInit();
	QAzazelInit();
	QUntinkerInit();
	QArtistInit();
	QLegendaryBeatInit();
	QMemoriesInit();
	QWhiteCitadelInit();
	QWizardOfEgoInit();
    QFeloniaInit();
    QGuildInit();
    QSubject37Init();
    QMartyInit();
    QMeatsmithInit();
    QGalaktikInit();
    QOldLandfillInit();
    QMadnessBakeryInit();
    
    //has to happen after level 13 init... or not?
	QManorInit();
}


void QuestsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	//ideally, remove this entirely:
	QLevel2GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel3GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel4GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel5GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel6GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel7GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel8GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel9GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel10GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel11GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel12GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLevel13GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	
	QManorGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QPirateGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QSeaGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QSpaceElvesGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QAzazelGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QGuildGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    
	QUntinkerGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QArtistGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QLegendaryBeatGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QMemoriesGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QWhiteCitadelGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QWizardOfEgoGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QSpookyravenLightsOutGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QFeloniaGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    
    QSubject37GenerateTasks(task_entries, optional_task_entries, future_task_entries);
    QMartyGenerateTasks(task_entries, optional_task_entries, future_task_entries);
}

void QuestsGenerateResources(ChecklistEntry [int] resource_entries)
{
    QSpookyravenLightsOutGenerateResource(resource_entries);
}



record LocationChoice
{
    location place;
    string [int] reasons;
    int importance;
};

LocationChoice LocationChoiceMake(location place, string [int] reasons, int importance)
{
    LocationChoice result;
    result.place = place;
    result.reasons = reasons;
    result.importance = importance;
    return result;
}

LocationChoice LocationChoiceMake(location place, string reason, int importance)
{
    return LocationChoiceMake(place, listMake(reason), importance);
}

LocationChoice LocationChoiceMake(location place, string reason)
{
    return LocationChoiceMake(place, reason, 0);
}

void listAppend(LocationChoice [int] list, LocationChoice entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void LocationChoiceSort(LocationChoice [int] list)
{
	sort list by value.importance;
}

string [int] LocationChoiceGenerateDescription(LocationChoice [int] list)
{
    string [int] description;
    foreach key in list
	{
		LocationChoice lc = list[key];
		string [int] explanation = lc.reasons;
		
		if (explanation.count() == 0)
			continue;
		string first = lc.place.to_string();
		if (lc.place == $location[none])
			first = "";
			
		string line;
		if (explanation.count() > 1)
		{
			line = first + HTMLGenerateIndentedText(HTMLGenerateDiv(explanation.listJoinComponents("<hr>")));
		}
		else
		{
			line = listFirstObject(explanation);
			if (line.stringHasPrefix("|") || first == "")
				line = first + line;
			else
				line = first + ": " + line;
		}
		//string line = first + HTMLGenerateIndentedText(HTMLGenerateDiv(explanation.listJoinComponents(HTMLGenerateDivOfStyle("", "border-top:1px solid;width:30%;"))));
		if (!locationAvailable(lc.place) && lc.place != $location[none])
		{
			line = HTMLGenerateDivOfClass(line, "r_future_option");
		}
		description.listAppend(line);
	}
    return description;
}

void SemirareGenerateDescription(string [int] description)
{
	if (CounterLookup("Semi-rare").CounterIsRange())
    {
        boolean fortune_output = false;
        string line;
        if (__misc_state["can eat just about anything"] && my_path_id() != PATH_NUCLEAR_AUTUMN && my_path_id() != PATH_G_LOVER)
        {
            line = "Eat a fortune cookie";
            if (availableFullness() <= 0)
                line += " later.";
            else
                line += ".";
            fortune_output = true;
        }
        if (__misc_state["VIP available"] && __misc_state["can drink just about anything"] && $item[Clan speakeasy].is_unrestricted())
        {
            if (fortune_output)
                line += " Or drink a Lucky Lindy";
            else
                line += "Drink a Lucky Lindy";
            if (availableDrunkenness() <= 0 || get_property_int("_speakeasyDrinksDrunk") >= 3)
                line += " later.";
            else
                line += ".";
            
        }
        if (CounterLookup("Semi-rare").CounterMayHitNextTurn())
        {
            description.listAppend("Already in counter window, probably should ignore this?");
        }
        else if (line != "")
            description.listAppend(line);
	}
	location last_location = $location[none];
	if (get_property_ascension("lastSemirareReset") && get_property("semirareLocation") != "")
	{
		last_location = get_property_location("semirareLocation");
        if (last_location != $location[none])
            description.listAppend("Last semi-rare: " + last_location);
	}
	
	
    LocationChoice [int] semirares;
	//Generate things to do:
	
	if (my_path_id() == PATH_GREY_GOO)
	{
		//The Haunted Library - black eyedrops, spooky resistance
        //FIXME calculate amount needed
        string description_library = "|*+9 spooky resistance potion, for collecting grey goo.";
        if ($item[black eyedrops].have())
        	description_library += " (have " + $item[black eyedrops].available_amount() + ")"; 
        string description_border = "|*+9 sleaze resistance potion, for collecting grey goo.";
        if ($item[donkey flipbook].have())
        	description_border += " (have " + $item[donkey flipbook].available_amount() + ")";
        semirares.listAppend(LocationChoiceMake($location[The Haunted Library], description_library, 0));
        semirares.listAppend(LocationChoiceMake($location[South of The Border], description_border, 0));
        
	}
	//The Copperhead Club/zeppelin goes here
	if (__misc_state["in run"])
	{
		if (__misc_state["can equip just about any weapon"])
		{
			if (!have_outfit_components("Knob Goblin Elite Guard Uniform"))
			{
				string [int] reasons;
				if (!__quest_state["Level 5"].finished)
					reasons.listAppend("Cobb's Knob quest");
                if (!dispensary_available() && false)
                {
                    if (__misc_state["familiars temporarily blocked"])
                        reasons.listAppend("dispensary access (+item, cheapish MP)");
                    else
                        reasons.listAppend("dispensary access (+item, +familiar weight, cheapish MP)");
                }
                if (reasons.count() > 0)
                    semirares.listAppend(LocationChoiceMake($location[cobb's knob barracks], "|*Acquire KGE outfit for " + reasons.listJoinComponents(", ", "and"), 0));
			}
			if (!have_outfit_components("Mining Gear") && !__quest_state["Level 8"].state_boolean["Past mine"])
				semirares.listAppend(LocationChoiceMake($location[Itznotyerzitz Mine], "|*Acquire mining gear for trapper quest.|*Run +234% item to get drop.", 0));
		}
        int wool_needed = 1;
        if ($item[the nostril of the serpent].available_amount() == 0)
            wool_needed += 1;
		if ($item[stone wool].available_amount() < wool_needed && !locationAvailable($location[the hidden park]) && !__quest_state["Level 11 Hidden City"].finished)
		{
			semirares.listAppend(LocationChoiceMake($location[The Hidden Temple], "|*Acquire stone wool for unlocking hidden city.|*Run +100% item. (or up to +400% item for +3 adventures)", 0));
		}
		if ($item[Mick's IcyVapoHotness Inhaler].available_amount() == 0 && $effect[Sinuses For Miles].have_effect() == 0 && !__quest_state["Level 12"].state_boolean["Nuns Finished"])
			semirares.listAppend(LocationChoiceMake($location[the castle in the clouds in the sky (top floor)], "|*+200% meat inhaler (10 turns), for nuns quest.", 0));
	
		//limerick dungeon - +100% item
		if ($item[cyclops eyedrops].available_amount() == 0 && $effect[One Very Clear Eye].have_effect() == 0)
			semirares.listAppend(LocationChoiceMake($location[the limerick dungeon], "|*+100% items eyedrops (10 turns), for tomb rats and low drops.", 0));
        if (in_bad_moon() && $item[bram's choker].available_amount() == 0)
			semirares.listAppend(LocationChoiceMake($location[The Haunted Boiler Room], "|*-5% combat accessory.", 0));
        if (__quest_state["Level 11 Ron"].mafia_internal_step <= 2 && __quest_state["Level 11 Ron"].state_int["protestors remaining"] > 1 && my_path_id() != PATH_COMMUNITY_SERVICE)
            semirares.listAppend(LocationChoiceMake($location[A Mob of Zeppelin Protesters], "|*Instant choice non-combat.", 0));
		//three turn generation SRs go here
		if (my_path_id() != PATH_SLOW_AND_STEADY)
		{
			LocationChoice food_semirares;
			food_semirares.importance = 11;
		
			string [int] line;
			if (__misc_state["can eat just about anything"] && last_location != $location[the haunted pantry])
				line.listAppend("The Haunted Pantry: 3 epic fullness food");
			if (__misc_state["can drink just about anything"] && last_location != $location[the sleazy back alley])
				line.listAppend("The Sleazy Back Alley: 3 epic drunkenness drink");
			if (__misc_state["can eat just about anything"] && __misc_state["can drink just about anything"] && last_location != $location[the outskirts of cobb's knob])
				line.listAppend("The Outskirts of Cobb's Knob: 3 epic full drunkenness food/drink");
			food_semirares.reasons.listAppend(line.listJoinComponents("|"));
			if (line.count() > 0)
				semirares.listAppend(food_semirares);
		}
        
        //FIXME does small golem cause the wall of bones to reform?
        /*if (!__quest_state["Level 13"].state_boolean["past tower monsters"] && $item[small golem].available_amount() == 0 && (get_property("grimstoneMaskPath") == "gnome" || $item[grimstone mask].available_amount() > 0))
        {
            boolean can_create_golem = false;
            if ($item[clay].available_amount() >= 1 && ($item[leather].available_amount() >= 3 || $item[parchment].available_amount() >= 1))
                can_create_golem = true;
            if (!can_create_golem)
                semirares.listAppend(LocationChoiceMake($location[Ye Olde Medievale Villagee], "Small golem (towerkilling)", 0));
        }*/
        if ((in_bad_moon() || my_path_id() == PATH_EXPLOSIONS) && __quest_state["Level 13"].state_boolean["shadow will need to be defeated"] && $item[scented massage oil].available_amount() + $item[scented massage oil].closet_amount() == 0 && !$skill[Ambidextrous Funkslinging].have_skill())
            semirares.listAppend(LocationChoiceMake($location[Cobb's Knob Harem], "|*Scented massage oil for shadow.", 0)); //theoretically, we could ignore this for DBs that aren't in a black cat run
	}
		
	//aftercore? sea quest, sand dollars, giant pearl
	
    LocationChoiceSort(semirares);
    
    //Post-process:
    foreach key in semirares
    {
		LocationChoice sr = semirares[key];
		if (last_location == sr.place && sr.place != $location[none])
			sr.reasons.listAppend(HTMLGenerateSpanOfClass("Can't use yet, last semi-rare was here", "r_bold"));
    }
	
    description.listAppendList(LocationChoiceGenerateDescription(semirares));
	/*foreach key in semirares
	{
		LocationChoice sr = semirares[key];
		string [int] explanation = sr.reasons;
		
		if (explanation.count() == 0)
			continue;
		string first = sr.place.to_string();
		if (sr.place == $location[none])
			first = "";
			
		string line;
		if (explanation.count() > 1)
		{
			line = first + HTMLGenerateIndentedText(HTMLGenerateDiv(explanation.listJoinComponents("<hr>")));
		}
		else
		{
			line = listFirstObject(explanation);
			if (line.stringHasPrefix("|") || first == "")
				line = first + line;
			else
				line = first + ": " + line;
		}
		//string line = first + HTMLGenerateIndentedText(HTMLGenerateDiv(explanation.listJoinComponents(HTMLGenerateDivOfStyle("", "border-top:1px solid;width:30%;"))));
		if (!locationAvailable(sr.place) && sr.place != $location[none])
		{
			line = HTMLGenerateDivOfClass(line, "r_future_option");
		}
		description.listAppend(line);
	}*/
}



void SSemirareGenerateEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task) //if from_task is false, assumed to be from resources
{
    Counter semirare_counter = CounterLookup("Semi-rare");
    if (!semirare_counter.CounterExists())
        return;
    
	boolean very_important = false;
	int show_up_in_tasks_turn_cutoff = 10;
	string title = "";
	int min_turns_until = -1;
    
    if (semirare_counter.CounterIsRange())
	{
        Vec2i turn_range = semirare_counter.CounterGetWindowRange();
        
        string turn_range_x_string = turn_range.x;
        if (turn_range.x <= -1)
            turn_range_x_string = "Past";
        if (turn_range.x == 0)
            turn_range_x_string = "Now";
        
        title = "[" + turn_range_x_string + " to " + turn_range.y + "] turns until semi-rare";
        
        min_turns_until = turn_range.x;
        
        if (turn_range.x <= 0)
            very_important = true;
        if (turn_range.y < 0)
            return;
	}
	else if (semirare_counter.exact_turns.count() > 0)
	{
        if (semirare_counter.exact_turns.count() == 1)
        {
			int turns_until = semirare_counter.exact_turns[0];
			if (turns_until == 0)
			{
				very_important = true;
				title = "Semi-rare now";
			}
			else
				title = pluralise(turns_until, "turn", "turns") + " until semi-rare";
				
			min_turns_until = turns_until;
        }
        else
        {
			min_turns_until = semirare_counter.exact_turns[0];
            string [int] turn_list;
            
            foreach key in semirare_counter.exact_turns
            {
                int value = semirare_counter.exact_turns[key];
                if (value == 0)
                {
                    very_important = true;
                    turn_list.listAppend("Now");
                }
                else if (!(value < 0))
                    turn_list.listAppend(value.to_string());
            }
            
			title = turn_list.listJoinComponents(", ", "or") + " turns until semi-rare";
        }
			
	}
	else
        return;
	
	if (from_task && min_turns_until > show_up_in_tasks_turn_cutoff)
		return;
	if (!from_task && min_turns_until <= show_up_in_tasks_turn_cutoff)
		return;
		
	string [int] description;
	if (title != "")
	{
		SemirareGenerateDescription(description);
	}
    if (very_important && __misc_state["monsters can be nearly impossible to kill"] && monster_level_adjustment() > 0)
        description.listAppend(HTMLGenerateSpanFont("Possibly remove +ML to survive. (at +" + monster_level_adjustment() + " ML)", "red"));
	boolean very_important_reduces_size = description.count() > 1;
    
	if (title != "")
	{
		int importance = 4;
		if (very_important)
        {
            if (very_important_reduces_size)
                importance = -10;
            else
                importance = -11;
        }
		ChecklistEntry entry = ChecklistEntryMake(234, "__item fortune cookie", "", ChecklistSubentryMake(title, "", description), importance);
		if (very_important)
        {
			task_entries.listAppend(entry);
            
            if (very_important_reduces_size)
            {
                boolean setting_use_mouse_over_technique = false;
                string secondary_description = "[...]";
                if (!setting_use_mouse_over_technique)
                    secondary_description = "Scroll up for full description.";
                ChecklistEntry pop_up_reminder_entry = ChecklistEntryMake(235, "__item fortune cookie", "", ChecklistSubentryMake(title, "", secondary_description), -11);
                pop_up_reminder_entry.only_show_as_extra_important_pop_up = true;
                pop_up_reminder_entry.container_div_attributes["onclick"] = "navbarClick(0, 'Tasks_checklist_container')";
                pop_up_reminder_entry.container_div_attributes["class"] = "r_clickable";
                
                //this feature is very, very buggy, so disable it:
                if (setting_use_mouse_over_technique)
                    pop_up_reminder_entry.subentries_on_mouse_over = entry.subentries;
                task_entries.listAppend(pop_up_reminder_entry);
            }
        }
		else
			optional_task_entries.listAppend(entry);
			
	}
}

void SSemirareGenerateResource(ChecklistEntry [int] resource_entries)
{
	SSemirareGenerateEntry(resource_entries, resource_entries, false);
}

void SSemirareGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	SSemirareGenerateEntry(task_entries, optional_task_entries, true);
}

boolean HITSStillRelevant()
{
	if (__misc_state["Example mode"])
		return true;
	if (!__misc_state["in run"])
		return false;
	if (__quest_state["Level 13"].state_boolean["Richard's star key used"])
		return false;
	if (!__quest_state["Level 10"].finished && my_path_id() != PATH_EXPLOSIONS)
		return false;
        
	return true;
}

void QHitsInit()
{
    //This isn't really a quest...
	QuestState state;
    
    state.quest_name = "Hole in the Sky";
    state.image_name = "Hole in the Sky";
    
    
    int charts_want = 0;
    int stars_want = 0;
    int lines_want = 0;
    
	if ($item[richard's star key].available_amount() == 0)
    {
		charts_want += 1;
		stars_want += 8;
		lines_want += 7;
    }
    
    if (!HITSStillRelevant())
    {
        charts_want = 0;
        stars_want = 0;
        lines_want = 0;
    }
    
    state.state_int["star charts needed"] = MAX(0, charts_want - $item[star chart].available_amount());
    state.state_int["stars needed"] = MAX(0, stars_want - $item[star].available_amount());
    state.state_int["lines needed"] = MAX(0, lines_want - $item[line].available_amount());
    
	__quest_state["Hole in the Sky"] = state;
}

void QHitsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!HITSStillRelevant())
		return;
	ChecklistSubentry subentry;
	subentry.header = "Hole in the Sky";
	
    string active_url = "";
    //Super unclear code. Sorry.
    //FIXME rewrite now that we don't need equipment
    
    int star_charts_needed = 0;
    int stars_needed_base = 0;
    int lines_needed_base = 0;
    
    string [int] item_names_needed;
    
	if ($item[richard's star key].available_amount() == 0)
	{
		star_charts_needed += 1;
		stars_needed_base += 8;
		lines_needed_base += 7;
		item_names_needed.listAppend($item[richard's star key]);
	}
    int [int] stars_needed_options;
    int [int] lines_needed_options;
    string [int] needed_options_names;
	if (needed_options_names.count() == 0)
	{
		stars_needed_options.listAppend(stars_needed_base + 0);
		lines_needed_options.listAppend(lines_needed_base + 0);
	}
	
	//Convert what we need total to what's remaining:
	int star_charts_remaining = MAX(0, star_charts_needed - $item[star chart].available_amount());
    int [int] stars_remaining;
    int [int] lines_remaining;
    string [int] remaining_options_names;
    
    boolean have_met_stars_requirement = true;
    boolean have_met_lines_requirement = true;
    
    foreach key in stars_needed_options
    {
    	if (needed_options_names contains key)
	    	remaining_options_names[key] = needed_options_names[key];
    	stars_remaining[key] = MAX(0, stars_needed_options[key] - $item[star].available_amount());
    	lines_remaining[key] = MAX(0, lines_needed_options[key] - $item[line].available_amount());
    	
    	if (stars_remaining[key] > 0)
    		have_met_stars_requirement = false;
    	if (lines_remaining[key] > 0)
    		have_met_lines_requirement = false;
    }
    
    if (__misc_state["Example mode"])
    {
        star_charts_remaining = 1;
        have_met_stars_requirement = false;
        have_met_lines_requirement = false;
    }
    
    if (have_met_stars_requirement)
    {
    	//Have all stars, suggest star sword (least lines)
    	//Remove non-sword:
    	foreach key in remaining_options_names
    	{
    		if (remaining_options_names[key] != "star sword")
    		{
    			remove remaining_options_names[key];
    			remove stars_remaining[key];
    			remove lines_remaining[key];
    		}
    	}
    }
    else if (have_met_lines_requirement)
    {
    	//Have all lines, suggest star crossbow (least stars)
    	//Remove non-crossbow:
    	foreach key in remaining_options_names
    	{
    		if (remaining_options_names[key] != "star crossbow")
    		{
    			remove remaining_options_names[key];
    			remove stars_remaining[key];
    			remove lines_remaining[key];
    		}
    	}
    }
    if (remaining_options_names.count() > 0)
    {
        item_names_needed.listAppend(remaining_options_names.listJoinComponents("/", ""));
    }
	
	if (item_names_needed.count() == 0)
		return;
		
	
	if (!$location[the hole in the sky].locationAvailable())
	{
		//find a way to space:
		subentry.modifiers.listAppend("-combat");
		subentry.entries.listAppend("Run -combat on the top floor of the castle for the steam-powered model rocketship.|From steampunk non-combat, unlocks Hole in the Sky.");
        active_url = "place.php?whichplace=giantcastle";
        
        
        subentry.entries.listAppend(generateTurnsToSeeNoncombat(95, 1, "", 9));
	}
	else
	{
        active_url = "place.php?whichplace=beanstalk";
		//We've made it out to space:
		subentry.entries.listAppend("Need " + item_names_needed.listJoinComponents(", ", "and") + ".");
		
		string [int] required_components;
		if (star_charts_remaining > 0)
			required_components.listAppend(pluralise(star_charts_remaining, $item[star chart]));
		foreach key in stars_remaining
		{
			string [int] line;
			if (stars_remaining[key] > 0)
				line.listAppend(pluralise(stars_remaining[key], $item[star]));
			if (lines_remaining[key] > 0)
				line.listAppend(pluralise(lines_remaining[key], $item[line]));
			string route = "";
			if (remaining_options_names contains key)
			{
				route = " (" + remaining_options_names[key];
				if (stars_remaining.count() > 1)
					route += " route";
				route += ")";
			}
			if (line.count() > 0)
				required_components.listAppend(line.listJoinComponents(" / ") + route);
		}
		if (required_components.count() > 0)
		{
            if (star_charts_remaining == 1 && have_met_stars_requirement && have_met_lines_requirement && !in_hardcore())
            {
                subentry.entries.listAppend("Can pull a star chart.");
            }
			//require more components:
			if (remaining_options_names.count() <= 1)
				subentry.entries.listAppend("Need " + required_components.listJoinComponents(", ", ""));
			else
				subentry.entries.listAppend("Need:|*" + required_components.listJoinComponents("|*", "or"));
        
            //FIXME if we need only one type, recommend a different monster to olfact
            
            if (star_charts_remaining > 0 && in_hardcore())
            {
                //olfact nothing, interferes with astronomers
                //they prefer interferometry
            }
            else if (!have_met_stars_requirement || !have_met_lines_requirement)
            {
                if (my_ascensions() % 2 == 0)
                    subentry.entries.listAppend("Olfact skinflute.");
                else
                    subentry.entries.listAppend("Olfact camel's toe.");
            }
            
			if (!have_met_stars_requirement || !have_met_lines_requirement)
				subentry.modifiers.listAppend("+234% item");
                
            if ($familiar[space jellyfish].familiar_is_usable())
            {
                //Space Directions NC:
                //39, 46
                int turns_spent = $location[the hole in the sky].turns_spent;
                boolean nc_up = false;
                int turns_to_next_nc = 0;
                if (turns_spent < 2)
                    turns_to_next_nc = 2 - turns_spent;
                else
                    turns_to_next_nc = 7 - (turns_spent - 2) % 7;
                    
                if (turns_spent == 2)
                    nc_up = true;
                else if ((turns_spent - 2) % 7 == 0)
                    nc_up = true;
                if (nc_up)
                {
                    //Apparently skipping the NC just makes it re-appear the next adventure?
                    if (true) //get_property("lastEncounter") != "Space Directions")
                    {
                        string line = "";
                        string [int] choices;
                        boolean an = false;
                        if (star_charts_remaining > 0)
                        {
                            choices.listAppend("astronomer");
                            an = true;
                        }
                        if (!have_met_stars_requirement || !have_met_lines_requirement)
                        {
                            choices.listAppend("camel's toe");
                        }
                        if ($familiar[space jellyfish] != my_familiar())
                            line = HTMLGenerateSpanFont("Bring along your space jellyfish", "red") + ", it'll let you choose a " + choices.listJoinComponents(", ", "or");
                        else
                            line = "Jellyfish NC next adventure. Will let you fight a" + (an ? "n" : "") + " " + choices.listJoinComponents(", ", "or");
                        /*if (star_charts_remaining > 0)
                        {
                            choices.listAppend("astronomer");
                            line = HTMLGenerateSpanFont("Bring along your space jellyfish", colour) + ", it'll let you choose an astronomer/camel";
                        }
                        else
                            line = HTMLGenerateSpanFont("Possibly bring along your space jellyfish", colour) + ", it'll let you choose an camel";*/
                        line += " this adventure.";
                        if (!have_met_stars_requirement || !have_met_lines_requirement)
                            line += "|Though that will reduce your +item, so choose wisely.";
                        subentry.entries.listAppend(line);
                    }
                }
                else
                {
                    if (get_property_int("singleFamiliarRun").to_familiar() != $familiar[space jellyfish] && $familiar[space jellyfish] == my_familiar())
                    {
                        subentry.entries.listAppend(HTMLGenerateSpanFont("Switch to another familiar?", "red"));
                    }
                    string line = pluraliseWordy(turns_to_next_nc, "more turn", "more turns").capitaliseFirstLetter() + " to jellyfish choice NC.";
                    subentry.entries.listAppend(line);
                }
            }
		}
		else
			subentry.entries.listAppend("Can make Richard's Star Key.");
	}
	optional_task_entries.listAppend(ChecklistEntryMake(388, "hole in the sky", active_url, subentry, $locations[the hole in the sky, the castle in the clouds in the sky (top floor)]));
}


void QHitsGenerateMissingItems(ChecklistEntry [int] items_needed_entries)
{
	if (!__misc_state["in run"] && !__misc_state["Example mode"])
		return;
	if (__quest_state["Level 13"].state_boolean["Richard's star key used"])
		return;
	//is this the best way to convey this information?
	//maybe all together instead? complicated...
    string url = $location[the hole in the sky].getClickableURLForLocation();
    if (!$location[the hole in the sky].locationAvailable())
        url = $location[The Castle in the Clouds in the Sky (basement)].getClickableURLForLocation();
	if ($item[richard's star key].available_amount() == 0)
	{
		string [int] oh_my_stars_and_gauze_garters;
		oh_my_stars_and_gauze_garters.listAppend(MIN(1, $item[star chart].available_amount()) + "/1 star chart");
		oh_my_stars_and_gauze_garters.listAppend(MIN(8, $item[star].available_amount()) + "/8 stars");
		oh_my_stars_and_gauze_garters.listAppend(MIN(7, $item[line].available_amount()) + "/7 lines");
		items_needed_entries.listAppend(ChecklistEntryMake(389, "__item richard's star key", url, ChecklistSubentryMake("Richard's star key", "", oh_my_stars_and_gauze_garters.listJoinComponents(", ", "and"))));
	}
}
void SFamiliarsGenerateEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task)
{
	if (get_property_int("_badlyRomanticArrows") == 0 && (familiar_is_usable($familiar[obtuse angel]) || familiar_is_usable($familiar[reanimated reanimator])) && my_path_id() != PATH_LIVE_ASCEND_REPEAT)
	{
        if (!__misc_state["in aftercore"] && !from_task)
            return;
        if (__misc_state["in aftercore"] && from_task)
            return;
		string familiar_image = "__familiar " + __misc_state_string["obtuse angel name"];
        string [int] description;
        string title = "Arrow monster";
        if (familiar_image == "reanimated reanimator")
            title = "Wink at monster";
        string url;
        if (!($familiars[obtuse angel, reanimated reanimator] contains my_familiar()))
            url = "familiar.php";
		
		if ($familiar[reanimated reanimator].familiar_is_usable() || ($familiar[obtuse angel].familiar_is_usable() && $familiar[obtuse angel].familiar_equipment() == $item[quake of arrows]))
            description.listAppend("Three wandering copies.");
        else
            description.listAppend("Two wandering copies.");
		
		string [int] potential_targets;
        //a short list:
        //FIXME writing desk
        if (__quest_state["Level 7"].state_int["alcove evilness"] > 31)
            potential_targets.listAppend("modern zmobie");
            
        if (!__quest_state["Level 8"].state_boolean["Mountain climbed"] && $items[ninja rope,ninja carabiner,ninja crampons].available_amount() == 0 && !have_outfit_components("eXtreme Cold-Weather Gear"))
            potential_targets.listAppend("ninja assassin");
        
        if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
            potential_targets.listAppend("lobsterfrogman");
        
        if (!__quest_state["Level 12"].state_boolean["Nuns Finished"] && have_outfit_components("Frat Warrior Fatigues") && have_outfit_components("War Hippy Fatigues")) //brigand trick
            potential_targets.listAppend("brigand");
        
        if (!familiar_is_usable($familiar[angry jung man]) && in_hardcore() && !__quest_state["Level 13"].state_boolean["digital key used"] && ($item[digital key].available_amount() + creatable_amount($item[digital key])) == 0 && __misc_state["fax equivalent accessible"])
            potential_targets.listAppend("ghost");
        
        if (__misc_state["in run"] && ($items[bricko eye brick,bricko airship,bricko bat,bricko cathedral,bricko elephant,bricko gargantuchicken,bricko octopus,bricko ooze,bricko oyster,bricko python,bricko turtle,bricko vacuum cleaner].available_amount() > 0 || $skill[summon brickos].skill_is_usable()))
            potential_targets.listAppend("BRICKO monster");
        
        if (potential_targets.count() > 0)
            description.listAppend("Possibly a " + potential_targets.listJoinComponents(", ", "or") + ".");
        
		optional_task_entries.listAppend(ChecklistEntryMake(403, familiar_image, url, ChecklistSubentryMake(title, "", description), 6));
	}
    
    
    if ($familiar[Crimbo Shrub].familiar_is_usable())
    {
        boolean should_output = false;
        if (__misc_state["in run"])
        {
            if (from_task)
                should_output = true;
        }
        else
        {
            if (!from_task)
                should_output = true;
        }
        if (get_property("shrubGifts") == "meat" && $effect[everything looks red].have_effect() == 0 && should_output)
        {
            string url = "";
            string title = "Open a Big Red Present in combat";
            if (!from_task)
                title = "Big Red Present openable in combat";
            string description = "Gives 2.5k meat.";
            if (my_familiar() != $familiar[Crimbo Shrub])
            {
                url = "familiar.php";
                if (from_task)
                    title = "Switch to Crimbo Shrub to open a big red present";
                else
                    description = "Switch to Crimbo Shrub first.|" + description;
            }
            optional_task_entries.listAppend(ChecklistEntryMake(404, "__item dense meat stack", url, ChecklistSubentryMake(title, "", description), 6).ChecklistEntrySetShortDescription("2.5k"));
        }
    }
}

void SFamiliarsPuckGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__misc_state["in run"])
        return;
    ChecklistSubentry [int] puck_subentries;
    item yellow_pixel = $item[yellow pixel];
    string url = "";
    familiar relevant_familiar = $familiar[Ms. Puck Man];
    if (!relevant_familiar.familiar_is_usable() && $familiar[Puck Man].familiar_is_usable())
        relevant_familiar = $familiar[Puck Man];
    if ($item[power pill].available_amount() > 0)
    {
        string header = $item[power pill].pluralise().capitaliseFirstLetter();
        int power_pill_uses_left = clampi(20 - get_property_int("_powerPillUses"), 0, 20);
        if (power_pill_uses_left < $item[power pill].available_amount())
        {
            if (power_pill_uses_left == 0)
                header += " (not usable today)";
            else
                header += " (" + power_pill_uses_left + " usable today)";
        }
        resource_entries.listAppend(ChecklistEntryMake(405, "__item power pill", "", ChecklistSubentryMake(header, "", "Use in combat to instakill without costing a turn.")).ChecklistEntryTag("free instakill").ChecklistEntrySetShortDescription(power_pill_uses_left));
    }
    if ($familiar[Ms. Puck Man].familiar_is_usable() || $familiar[Puck Man].familiar_is_usable())
    {
        int power_pills_remaining = MAX(0, MIN(11, my_daycount() + 1) - get_property_int("_powerPillDrops"));
        if (power_pills_remaining > 0)
        {
            string [int] description;
            
            string line = "Saves a turn each.";
            if (my_familiar() != $familiar[Ms. Puck Man] && my_familiar() != $familiar[Puck Man] && url.length() == 0)
            {
                url = "familiar.php";
                line += " Drops from " + relevant_familiar + ".";
            }
            description.listAppend(line);
            
            puck_subentries.listAppend(ChecklistSubentryMake(pluralise(power_pills_remaining, "power pill", "power pills") + " obtainable", "", description));
        }
    }
    if (yellow_pixel != $item[none] && yellow_pixel.available_amount() > 0 && in_ronin())
    {
        string title = pluralise(yellow_pixel);
        string [int] description;
        url = "shop.php?whichshop=mystic"; //"place.php?whichplace=forestvillage&action=fv_mystic";
        //Pixel coin - 10 yellow pixels - 2k autosell (marginal)
        //minature power pill - 15 yellow pixels - +100% all stats, 30 turns
        //pixel star - 15 yellow pixels, 2 black pixels - 30 turns of +100% HP/MP/spell damage/weapon damage
        //pixel banana - 10 yellow pixels, 1 black pixel - 2-size awesome food, 10 turns of +30% item
        //pixel beer - 10 yellow pixels, 5 white pixels - 2-size awesome drunk, 10 turns of +3 stats/fight (15 mainstat)
        boolean [item] items_to_always_show;
        items_to_always_show[$item[yellow pixel potion]] = true;
        if (!__misc_state["mysterious island available"])
            items_to_always_show[$item[yellow submarine]] = true;
        
        item [int] evalulation_order;
        evalulation_order.listAppend($item[yellow pixel potion]);
        evalulation_order.listAppend($item[pixel coin]); //before potions
        
        string [item] reasons;
        reasons[$item[pixel coin]] = "Autosells for 2000 meat.";
        reasons[$item[pixel star]] = "+100% HP/MP/spell/weapon damage. (30 turns)";
        reasons[$item[miniature power pill]] = "+100% stats. (30 turns)";
        reasons[$item[yellow pixel potion]] = "+20ML. (20 turns)";
        if (!__misc_state["mysterious island available"])
            reasons[$item[yellow submarine]] = "island unlock";
        //these (should) show up in mafia's consumption manager, so disabled
        /*if (__misc_state["can eat just about anything"])
            reasons[$item[pixel banana]] = "2-size awesome food, 10 turns of +30% item.";
        if (__misc_state["can drink just about anything"])
            reasons[$item[pixel beer]] = "2-size awesome drunk, 10 turns of +3 stats/fight.";*/
        
        boolean [item] evaluated;
        foreach key, it in evalulation_order
            evaluated[it] = true;
        foreach it in reasons
        {
            if (!(evaluated contains it))
            {
                evaluated[it] = true;
                evalulation_order.listAppend(it);
            }
        }
        
        foreach key, it in evalulation_order
        {
            string reason = reasons[it];
            if (reason.length() == 0)
                continue;
            if (it == $item[none])
                continue;
            if (it.creatable_amount() == 0 && !items_to_always_show[it])
                continue;
            string line;
            line = it.capitaliseFirstLetter() + ": " + reason;
            if (it.creatable_amount() == 0)
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);
        }
        string [int] consumables;
        if (__misc_state["can eat just about anything"])
            consumables.listAppend("food");
        if (__misc_state["can drink just about anything"])
            consumables.listAppend("drink");
        if (consumables.count() > 0)
        {
            string line = consumables.listJoinComponents(", ").capitaliseFirstLetter() + ".";
            if ($item[yellow pixel].available_amount() < 10)
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);
        }
        int importance = 9;
        puck_subentries.listAppend(ChecklistSubentryMake(title, "", description));
    }
    if (puck_subentries.count() > 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(406, "__familiar " + relevant_familiar, url, puck_subentries, 9));
    }

}

void SFamiliarsGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (__misc_state["free runs usable"] && ($familiar[pair of stomping boots].familiar_is_usable() || ($skill[the ode to booze].skill_is_usable() && $familiar[Frumious Bandersnatch].familiar_is_usable())))
	{
		int runaways_used = get_property_int("_banderRunaways");
		string name = runaways_used + " familiar runaways used";
		string [int] description;
		string image_name = "";
        
        string url = "";
		
		if ($familiar[Frumious Bandersnatch].familiar_is_usable() && $skill[the ode to booze].skill_is_usable())
		{
			image_name = "__familiar Frumious Bandersnatch";
		}
		else if ($familiar[pair of stomping boots].familiar_is_usable())
		{
			image_name = "__familiar pair of stomping boots";
		}
        
        if (!($familiars[Frumious Bandersnatch, pair of stomping boots] contains my_familiar()))
            url = "familiar.php";
        
        if (my_path_id() != PATH_HEAVY_RAINS)
        {
            int snow_suit_runs = floor(numeric_modifier($item[snow suit], "familiar weight") / 5.0);
            
            if ($item[snow suit].available_amount() == 0)
                snow_suit_runs = 0;
                
            if (snow_suit_runs >= 2)
                description.listAppend("Snow Suit available (+" + snow_suit_runs + " runs)");
            else if ($item[sugar shield].available_amount() > 0)
                description.listAppend("Sugar shield available (+2 runs)");
        }
			
		resource_entries.listAppend(ChecklistEntryMake(407, image_name, url, ChecklistSubentryMake(name, "", description)));
	}
	
	if (true)
	{
		int hipster_fights_available = __misc_state_int["hipster fights available"];
			
		if (($familiar[artistic goth kid].familiar_is_usable() || $familiar[Mini-Hipster].familiar_is_usable()) && hipster_fights_available > 0 && my_path_id() != PATH_LIVE_ASCEND_REPEAT)
		{
			string name = "";
			string [int] description;
            string hipster_image = __misc_state_string["hipster name"];

            string hipster_name = __misc_state_string["hipster name"];
            if ($familiar[artistic goth kid].familiar_is_usable() && $familiar[Mini-Hipster].familiar_is_usable())
            {
                hipster_name = "goth kid / mini-hipster";
                hipster_image = "__familiar Mini-hipster";
            }
                
			name = pluralise(hipster_fights_available, __misc_state_string["hipster name"] + " fight", hipster_name + " fights");
			
			int [int] hipster_chances;
			hipster_chances[7] = 50;
			hipster_chances[6] = 40;
			hipster_chances[5] = 30;
			hipster_chances[4] = 20;
			hipster_chances[3] = 10;
			hipster_chances[2] = 10;
			hipster_chances[1] = 10;
            
            string url = "";
            if (!($familiars[artistic goth kid,mini-hipster] contains my_familiar()))
                url = "familiar.php";
			
			description.listAppend(hipster_chances[hipster_fights_available] + "% chance of appearing.");
			int importance = 0;
            if (!__misc_state["in run"])
                importance = 6;
			resource_entries.listAppend(ChecklistEntryMake(408, hipster_image, url, ChecklistSubentryMake(name, "", description), importance));
		}
	}
	
	
	if ($familiar[nanorhino].familiar_is_usable() && get_property_int("_nanorhinoCharge") == 100)
	{
		ChecklistSubentry [int] subentries;
		string [int] description_banish;
		
        string url = "";
        
        if (my_familiar() != $familiar[nanorhino])
            url = "familiar.php";
		
        boolean tag_with_banish_tag = false;
        if (get_property("_nanorhinoBanishedMonster") != "") description_banish.listAppend(get_property("_nanorhinoBanishedMonster").HTMLEscapeString().capitaliseFirstLetter() + " currently banished.");
        if (get_property_int("_nanorhinoCharge") >= 100)
        {
        	tag_with_banish_tag = true;
            description_banish.listAppend("All day. Cast muscle combat skill" + (my_familiar() == $familiar[nanorhino] ? "" : " with nanorhino as your familiar") + ".");
        }
		if (__misc_state["have muscle class combat skill"])
        {
        	if (tag_with_banish_tag)
            	resource_entries.listAppend(ChecklistEntryMake(409, "__familiar nanorhino", "", ChecklistSubentryMake("Nanorhino Banish", "", description_banish), 2).ChecklistEntryTag("banish"));
            else
				subentries.listAppend(ChecklistSubentryMake("Nanorhino Banish", "", description_banish));
        }
		if (__misc_state["need to level"] && __misc_state["have mysticality class combat skill"])
			subentries.listAppend(ChecklistSubentryMake("Nanorhino Gray Goo", "", "130? mainstat, fire against non-item monster with >90 attack. Cast mysticality combat skill."));
		if (!$familiar[he-boulder].familiar_is_usable() && __misc_state["have moxie class combat skill"] && __misc_state["in run"])
        {
            if ($effect[everything looks yellow].have_effect() > 0)
                subentries.listAppend(ChecklistSubentryMake(HTMLGenerateSpanFont("Nanorhino Yellow Ray", "gray"), "", HTMLGenerateSpanFont("Cast moxie combat skill once everything looks yellow is gone.", "gray")));
            else
                subentries.listAppend(ChecklistSubentryMake("Nanorhino Yellow Ray", "", "Cast moxie combat skill."));
        }
		if (subentries.count() > 0)
			resource_entries.listAppend(ChecklistEntryMake(410, "__familiar nanorhino", url, subentries, 5).ChecklistEntrySetCategory("blank"));
	}
	if (__misc_state["yellow ray available"] && !__misc_state["in run"])
    {
        resource_entries.listAppend(ChecklistEntryMake(411, __misc_state_string["yellow ray image name"], "", ChecklistSubentryMake("Yellow ray available", "", "From " + __misc_state_string["yellow ray source"] + "."), 6).ChecklistEntrySetShortDescription("YR"));
    }
    
    if (my_familiar() == $familiar[happy medium] || $familiar[happy medium].charges > 0 && $familiar[happy medium].familiar_is_usable()) //|| stuff
    {
        //FIXME request support for tracking medium combats.
        string title;
        string [int] description;
        
        int charges = $familiar[happy medium].charges;
        int siphons = get_property_int("_mediumSiphons");
        
        int adventures_to_next_at_most = 3 + siphons;
        
        if (charges == 3)
        {
            title = "Red medium";
            description.listAppend("4.25 turns/drunkenness.");
        }
        else if (charges == 2)
        {
            title = "Orange medium";
            description.listAppend("3.25 turns/drunkenness.");
            description.listAppend(pluraliseWordy(adventures_to_next_at_most, "turn", "turns").capitaliseFirstLetter() + " (at most) to red.");
        }
        else if (charges == 1)
        {
            title = "Blue medium";
            description.listAppend("2.25 turns/drunkenness.");
            description.listAppend(pluraliseWordy(adventures_to_next_at_most, "turn", "turns").capitaliseFirstLetter() + " (at most) to orange.");
        }
        else
        {
            title = "Uncharged medium";
            description.listAppend(pluraliseWordy(adventures_to_next_at_most, "turn", "turns").capitaliseFirstLetter() + " (at most) to blue. ");
        }
        string url;
        if (my_familiar() != $familiar[happy medium])
            url = "familiar.php";
        
        int importance = 6;
        if (my_familiar() == $familiar[happy medium] || charges > 0)
            importance = 0;
        resource_entries.listAppend(ChecklistEntryMake(412, "__familiar happy medium", url, ChecklistSubentryMake(title, "", description), importance));
    }
    if (my_familiar() == $familiar[steam-powered cheerleader] || $familiar[steam-powered cheerleader].familiar_is_usable() && get_property_int("_cheerleaderSteam") < 200)
    {
        string title;
        string [int] description;
        
        int steam_remaining = get_property_int("_cheerleaderSteam");
        float multiplier = 1.0;
        float next_multiplier_level = 1.0;
        
        int next_steam_level = 0;
        
        boolean has_socket_set = $familiar[steam-powered cheerleader].familiar_equipped_equipment() == $item[school spirit socket set];
        
        if (steam_remaining >= 151)
        {
            multiplier = 1.4;
            next_multiplier_level = 1.3;
            next_steam_level = 150;
        }
        else if (steam_remaining >= 101)
        {
            multiplier = 1.3;
            next_multiplier_level = 1.2;
            next_steam_level = 100;
        }
        else if (steam_remaining >= 51)
        {
            multiplier = 1.2;
            next_multiplier_level = 1.1;
            next_steam_level = 50;
        }
        else if (steam_remaining >= 1)
        {
            multiplier = 1.1;
            next_multiplier_level = 1.0;
            next_steam_level = 0;
        }
        
        int steam_at_this_level_remaining = steam_remaining - next_steam_level;
        int turns_remaining_at_this_level = steam_at_this_level_remaining;
        if (!has_socket_set)
            turns_remaining_at_this_level = turns_remaining_at_this_level / 2;
        
        
        
        title = multiplier + "x fairy steam-powered cheerleader";
        
        if (turns_remaining_at_this_level > 0)
            description.listAppend(pluralise(turns_remaining_at_this_level, "turn remains", "turns remain") + " until " + next_multiplier_level + "x.");
        
        int importance = 6;
        if (my_familiar() == $familiar[steam-powered cheerleader])
            importance = 0;
        
    
        string url;
        if (my_familiar() != $familiar[steam-powered cheerleader])
            url = "familiar.php";
        
        
        resource_entries.listAppend(ChecklistEntryMake(413, "__familiar steam-powered cheerleader", url, ChecklistSubentryMake(title, "", description), importance));
    }
    
    if ($familiar[grim brother].familiar_is_usable() && !get_property_boolean("_grimBuff") && __misc_state["in run"]) //in aftercore, let the maximizer handle it?
    {
        string title;
        string [int] description;
        string url = "familiar.php?action=chatgrim&amp;pwd=" + my_hash();
        
        title = "Chat with grim brother";
        
        description.listAppend("30 turns of +20% init or +HP/MP or +damage.");
        int importance = 9;
        resource_entries.listAppend(ChecklistEntryMake(414, "__familiar grim brother", url, ChecklistSubentryMake(title, "", description), importance).ChecklistEntrySetCategory("buff"));
    }
    
    
    SFamiliarsPuckGenerateResource(resource_entries);
    
    //FIXME small medium, organ grinder, charged boots
	SFamiliarsGenerateEntry(resource_entries, resource_entries, false);
}

void SFamiliarsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_familiar() == $familiar[none] && !__misc_state["single familiar run"] && !__misc_state["familiars temporarily blocked"])
	{
		string image_name = "black cat";
		optional_task_entries.listAppend(ChecklistEntryMake(415, image_name, "familiar.php", ChecklistSubentryMake("Bring along a familiar", "", "")));
	}
    
    if ($familiar[Crimbo Shrub].familiar_is_usable())
    {
        boolean configured = get_property("shrubGarland") != "" || get_property("shrubGifts") != "" || get_property("shrubLights") != "" || get_property("shrubTopper") != "";
        if (my_daycount() == 1 && get_property("_shrubDecorated") == "false") //default configuration exists, but
            configured = false;
        if (!configured && (__misc_state["in run"] || my_familiar() == $familiar[Crimbo Shrub]) && get_property("_shrubDecorated") == "false")
        {
            string [int] description;
            
            string [int] configuration_idea;
            if (my_primestat() == $stat[muscle])
                configuration_idea.listAppend("Veiny Star");
            else if (my_primestat() == $stat[mysticality])
                configuration_idea.listAppend("LED Mandala");
            else if (my_primestat() == $stat[moxie])
                configuration_idea.listAppend("Angel With Sunglasses");
            
            configuration_idea.listAppend("Frosted Lights"); //random pick really
            
            if (hippy_stone_broken())
                configuration_idea.listAppend("Barbed Wire");
            else
                configuration_idea.listAppend("Popcorn Strands");
            
            if (!__misc_state["yellow ray potentially available"] && my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST) //you really want the meat one in WOTSF (this works!)
                configuration_idea.listAppend("Big Yellow-Wrapped Presents");
            else
                configuration_idea.listAppend("Big Red-Wrapped Presents");
            
            description.listAppend("Maybe " + configuration_idea.listJoinComponents(" / ") + "?");
            
            string url = "familiar.php";
            
            if ($item[box of old Crimbo decorations].available_amount() > 0)
                url = "inv_use.php?pwd=" + my_hash() + "&whichitem=7958";
            
            optional_task_entries.listAppend(ChecklistEntryMake(416, "__item box of old Crimbo decorations", url, ChecklistSubentryMake("Configure your Crimbo Shrub", "", description), 6));
        }
        /*
        shrubGarland(user, now 'PvP', default )
        shrubGifts(user, now 'meat', default )
        shrubLights(user, now 'Cold', default )
        shrubTopper(user, now 'Moxie', default )
        */
    }
    
	SFamiliarsGenerateEntry(task_entries, optional_task_entries, true);
}
void SDispensaryGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	//Not sure how I feel about this. The dispensary is very useful, but not necessary to complete an ascension.
	if (dispensary_available())
		return;
    //It's even less useful now that they've changed the buffs. Sorry, dispensary.
    if (true)
    	return;
	if (!__misc_state["can equip just about any weapon"]) //need to wear KGE to learn the password
		return;
	
	if (!__quest_state["Level 5"].started || !$location[cobb's knob barracks].locationAvailable())
		return;
    if (__quest_state["Level 5"].finished && !have_outfit_components("Knob Goblin Elite Guard Uniform")) //level 5 quest completed, but they don't have KGE - I think we'll close the suggestion here, as they probably don't want to go back? maybe? it'll still show up in semi-rare if they care to
        return;
    if (!have_outfit_components("Knob Goblin Elite Guard Uniform") && __misc_state["in run"]) //don't bother unless they have the uniform
    	return;
	
	ChecklistSubentry subentry;
	subentry.header = "Unlock Cobb's Knob Dispensary";
	
	string [int] dispensary_advantages;
	if (!black_market_available() && !__misc_state["MMJs buyable"])
		dispensary_advantages.listAppend("MP Restorative");
	dispensary_advantages.listAppend("+30% meat");
	dispensary_advantages.listAppend("+15% items");
	if (my_path_id() != PATH_BEES_HATE_YOU && !__misc_state["familiars temporarily blocked"])
		dispensary_advantages.listAppend("+5 familiar weight");
	dispensary_advantages.listAppend("+1 mainstat/fight");
	
	if (dispensary_advantages.count() > 0)
		subentry.entries.listAppend("Access to " + dispensary_advantages.listJoinComponents(", ", "and") + " buff items.");
		
	if ($item[Cobb's Knob lab key].available_amount() == 0)
		subentry.entries.listAppend("Find the cobb's knob lab key either laying around, or defeat the goblin king.");
	else
	{
		if (have_outfit_components("Knob Goblin Elite Guard Uniform"))
		{
			if (!is_wearing_outfit("Knob Goblin Elite Guard Uniform"))
				subentry.entries.listAppend("Wear KGE outfit, adventure in Cobb's Knob Barracks.");
			else
				subentry.entries.listAppend("Adventure in Cobb's Knob Barracks.");
		}
		else
			subentry.entries.listAppend("Acquire KGE outfit");
	}
	optional_task_entries.listAppend(ChecklistEntryMake(218, "Dispensary", "cobbsknob.php", subentry, 10));
}
string [int] SSkillsPotentialCraftingOptions()
{
    string [int] potential_options;
    if ($item[knob cake].available_amount() == 0 && !__quest_state["Level 6"].finished)
        potential_options.listAppend("knob cake");
    if (__misc_state["can eat just about anything"])
        potential_options.listAppend("food");
    if (__misc_state["can drink just about anything"])
        potential_options.listAppend("drink");
    if ($skill[advanced saucecrafting].skill_is_usable())
        potential_options.listAppend("sauceror potions");
    return potential_options;
}


RegisterTaskGenerationFunction("SSkillsGenerateTasks");
void SSkillsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($skill[Lock Picking].skill_is_usable() && !get_property_boolean("lockPicked") && (__quest_state["Level 13"].state_boolean["need to find Boris's key"] || __quest_state["Level 13"].state_boolean["need to find Jarlsberg's key"] || __quest_state["Level 13"].state_boolean["need to find Sneaky Pete's key"]))
    {
    	boolean [item] missing_items;
        if (__quest_state["Level 13"].state_boolean["need to find Boris's key"])
        	missing_items[$item[Boris's key]] = true;
        if (__quest_state["Level 13"].state_boolean["need to find Jarlsberg's key"])
        	missing_items[$item[Jarlsberg's key]] = true;
        if (__quest_state["Level 13"].state_boolean["need to find Sneaky Pete's key"])
        	missing_items[$item[Sneaky Pete's key]] = true;
        
        optional_task_entries.listAppend(ChecklistEntryMake(220, "__skill Lock Picking", "skillz.php", ChecklistSubentryMake("Cast Lock Picking", "", "Collect " + (missing_items.count() > 1 ? "either " : " ") + missing_items.listInvert().listJoinComponents(", ", "or") + "."), 5));
    }
}

void SSkillsGenerateResource(ChecklistEntry [int] resource_entries)
{
    string url;
	if (skill_is_usable($skill[inigo's incantation of inspiration]))
	{
		int inigos_casts_remaining = 5 - get_property_int("_inigosCasts");
		string description = SSkillsPotentialCraftingOptions().listJoinComponents(", ").capitaliseFirstLetter();
		if (inigos_casts_remaining > 0)
			resource_entries.listAppend(ChecklistEntryMake(221, "__effect Inigo's Incantation of Inspiration", "skills.php", ChecklistSubentryMake(pluralise(inigos_casts_remaining, "Inigo's cast", "Inigo's casts") + " remaining", "", description), 10).ChecklistEntrySetCategory("buff"));
	}
	int free_crafts_left = 0;
	if ($effect[Inigo's Incantation of Inspiration].have_effect() >= 5)
	{
        free_crafts_left += $effect[Inigo's Incantation of Inspiration].have_effect() / 5;
	}
    if ($skill[rapid prototyping].skill_is_usable())
    {
        free_crafts_left += clampi(5 - get_property_int("_rapidPrototypingUsed"), 0, 5);
    }
    if ($skill[Expert Corner-Cutter].skill_is_usable())
    {
        free_crafts_left += clampi(5 - get_property_int("_expertCornerCutterUsed"), 0, 5);
    }
    if (free_crafts_left > 0)
    {
        string description = SSkillsPotentialCraftingOptions().listJoinComponents(", ").capitaliseFirstLetter();
        resource_entries.listAppend(ChecklistEntryMake(222, "__item tenderizing hammer", "", ChecklistSubentryMake(pluralise(free_crafts_left, "free craft", "free crafts") + " remaining", "", description), 10));
    }
	ChecklistSubentry [int] subentries;
	int importance = 11;
	
	string [skill] skills_to_details;
	string [skill] skills_to_urls;
    string [skill] skills_to_title_notes;
	skill [string][int] property_summons_to_skills;
	int [string] property_summon_limits;
	
    if ($skill[advanced saucecrafting].have_skill())
        property_summons_to_skills["reagentSummons"] = listMake($skill[advanced saucecrafting], $skill[the way of sauce]);
    if ($skill[Pastamastery].have_skill())
        property_summons_to_skills["noodleSummons"] = listMake($skill[Pastamastery], $skill[Transcendental Noodlecraft]);
    if ($skill[Advanced Cocktailcrafting].have_skill())
        property_summons_to_skills["cocktailSummons"] = listMake($skill[Advanced Cocktailcrafting], $skill[Superhuman Cocktailcrafting]);
	property_summons_to_skills["_coldOne"] = listMake($skill[Grab a Cold One]);
	property_summons_to_skills["_spaghettiBreakfast"] = listMake($skill[spaghetti breakfast]);
	property_summons_to_skills["_discoKnife"] = listMake($skill[that's not a knife]);
	property_summons_to_skills["_lunchBreak"] = listMake($skill[lunch break]);
	property_summons_to_skills["_psychokineticHugUsed"] = listMake($skill[Psychokinetic Hug]);
	property_summons_to_skills["_pirateBellowUsed"] = listMake($skill[Pirate Bellow]);
	property_summons_to_skills["_holidayFunUsed"] = listMake($skill[Summon Holiday Fun!]);
	property_summons_to_skills["_summonCarrotUsed"] = listMake($skill[Summon Carrot]);
	property_summons_to_skills["_summonAnnoyanceUsed"] = listMake($skill[summon annoyance]);
    property_summons_to_skills["_perfectFreezeUsed"] = listMake($skill[Perfect Freeze]);
    property_summons_to_skills["_communismUsed"] = listMake($skill[Communism!]);
    property_summons_to_skills["_preventScurvy"] = listMake($skill[Prevent Scurvy and Sobriety]);
    
    skills_to_title_notes[$skill[summon annoyance]] = get_property_int("summonAnnoyanceCost") + " swagger";
    
    
    
    
    
    if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE)
    {
		property_summons_to_skills["_petePartyThrown"] = listMake($skill[Throw Party]);
		property_summons_to_skills["_peteRiotIncited"] = listMake($skill[Incite Riot]);
        
        int audience_max = 30;
        int hate_useful_max = 25; //ashes and soda max out early; more audience hatred only gives crates and grenades, not of absolute importance
        if ($item[Sneaky Pete's leather jacket].equipped_amount() > 0 || $item[Sneaky Pete's leather jacket (collar popped)].equipped_amount() > 0)
        {
            audience_max = 50;
            hate_useful_max = 41;
        }
            
        if (my_audience() < audience_max)
            skills_to_details[$skill[Throw Party]] = "Ideally have " + audience_max + " audience love before casting.";
        else
            skills_to_details[$skill[Throw Party]] = "Gain party supplies.";
        
        if (my_audience() > -hate_useful_max)
            skills_to_details[$skill[Incite Riot]] = "Ideally have " + hate_useful_max + " audience hate before casting.";
        else
            skills_to_details[$skill[Incite Riot]] = "This fire is out of control";
    }
	//Jarlsberg:
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG)
	{
		property_summons_to_skills["_jarlsCreamSummoned"] = listMake($skill[Conjure Cream]);
		property_summons_to_skills["_jarlsEggsSummoned"] = listMake($skill[Conjure Eggs]);
		property_summons_to_skills["_jarlsDoughSummoned"] = listMake($skill[Conjure Dough]);
		property_summons_to_skills["_jarlsVeggiesSummoned"] = listMake($skill[Conjure Vegetables]);
		property_summons_to_skills["_jarlsCheeseSummoned"] = listMake($skill[Conjure Cheese]);
		property_summons_to_skills["_jarlsPotatoSummoned"] = listMake($skill[Conjure Potato]);
		property_summons_to_skills["_jarlsMeatSummoned"] = listMake($skill[Conjure Meat Product]);
		property_summons_to_skills["_jarlsFruitSummoned"] = listMake($skill[Conjure Fruit]);
	}
	if (my_path_id() == PATH_AVATAR_OF_BORIS)
	{
		property_summons_to_skills["_demandSandwich"] = listMake($skill[Demand Sandwich]);
		property_summon_limits["_demandSandwich"] = 3;
	}
    
	property_summons_to_skills["_requestSandwichSucceeded"] = listMake($skill[Request Sandwich]);
    
    property_summons_to_skills["grimoire1Summons"] = listMake($skill[Summon Hilarious Objects]);
    property_summons_to_skills["grimoire2Summons"] = listMake($skill[Summon Tasteful Items]);
    property_summons_to_skills["grimoire3Summons"] = listMake($skill[Summon Alice's Army Cards]);
    property_summons_to_skills["_grimoireGeekySummons"] = listMake($skill[Summon Geeky Gifts]);
    property_summons_to_skills["_grimoireConfiscatorSummons"] = listMake($skill[Summon Confiscated Things]);
    skills_to_urls[$skill[Summon Confiscated Things]] = "campground.php?action=bookshelf";
    property_summons_to_skills["_candySummons"] = listMake($skill[Summon Crimbo Candy]);
    property_summons_to_skills["_summonResortPassUsed"] = listMake($skill[Summon Kokomo Resort Pass]);
    property_summons_to_skills["_incredibleSelfEsteemCast"] = listMake($skill[Incredible Self-Esteem]);
    skills_to_details[$skill[Incredible Self-Esteem]] = "Gives or extends affirmation buffs.";
    if (__misc_state["in run"] && $item[Daily Affirmation: Always be Collecting].available_amount() > 0 && $item[Daily Affirmation: Always be Collecting].to_effect().have_effect() == 0)
        skills_to_details[$skill[Incredible Self-Esteem]] += "|Possibly use Always be Collecting affirmation before casting.";
    
    foreach s in $skills[Summon Hilarious Objects,Summon Tasteful Items,Summon Alice's Army Cards,Summon Geeky Gifts]
        skills_to_urls[s] = "campground.php?action=bookshelf";
    
	
	
    int muscle_basestat = my_basestat($stat[muscle]);
	item summoned_knife = $item[none];
	if (muscle_basestat < 10)
		summoned_knife = $item[boot knife];
	else if (muscle_basestat < 20)
		summoned_knife = $item[broken beer bottle];
	else if (muscle_basestat < 40)
		summoned_knife = $item[sharpened spoon];
	else if (muscle_basestat < 60)
		summoned_knife = $item[candy knife];
	else
		summoned_knife = $item[soap knife];
	if (summoned_knife.available_amount() > 0 && summoned_knife != $item[none])
    {
        //already have the knife, don't annoy them:
        //(or ask them to closet the knife?)
        remove property_summons_to_skills["_discoKnife"];
		//skills_to_details[$skill[that's not a knife]] = "Closet " + summoned_knife + " first.";
    }
	
	foreach property in property_summons_to_skills
	{
		if (get_property_int(property) >= property_summon_limits[property] || get_property_boolean(property))
			continue;
		foreach key in property_summons_to_skills[property]
		{
			skill s = property_summons_to_skills[property][key];
			if (!s.skill_is_usable())
				continue;
				
			string line = s.to_string();
			string [int] description;
			if (s.mp_cost() > 0)
			{
				line += " (" + s.mp_cost() + " MP)";
				//description.listAppend(s.mp_cost() + " MP");
			}
            if (skills_to_title_notes contains s)
            {
				line += " (" + skills_to_title_notes[s] + " )";
            }
			string details = skills_to_details[s];
			if (details != "")
				description.listAppend(details);
                
                
            if (url.length() == 0)
            {
                if (skills_to_urls contains s)
                    url = skills_to_urls[s];
                else
                    url = "skills.php";
            }
			
			subentries.listAppend(ChecklistSubentryMake(line, "", description));
			break;
		}
	}
	
	if (subentries.count() > 0)
	{
		subentries.listPrepend(ChecklistSubentryMake("Skill summons:"));
		ChecklistEntry entry = ChecklistEntryMake(223, "__item Knob Goblin love potion", url, subentries, importance);
		entry.should_indent_after_first_subentry = true;
		resource_entries.listAppend(entry);
	}

    
    if ($skill[Evoke Eldritch Horror].skill_is_usable() && !get_property_boolean("_eldritchHorrorEvoked"))
    {
        resource_entries.listAppend(ChecklistEntryMake(224, "__skill Evoke Eldritch Horror", "skillz.php", ChecklistSubentryMake("Evoke Eldritch Horror", "", "Free fight."), 5).ChecklistEntryTag("daily free fight"));
    }
    if (!get_property_boolean("_eldritchTentacleFought") && my_path_id() != PATH_EXPLOSIONS)
    {
        resource_entries.listAppend(ChecklistEntryMake(225, "__skill Evoke Eldritch Horror", "place.php?whichplace=forestvillage", ChecklistSubentryMake("Free Science Tent Tentacle fight", "", ""), 5).ChecklistEntryTag("daily free fight"));
    }
}
void SMiscItemsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($item[the crown of ed the undying].equipped_amount() > 0 && get_property("edPiece").length() == 0)
    {
        string [int] description;
        
        if (__misc_state["need to level"])
        {
            if (my_primestat() == $stat[muscle])
                description.listAppend("Bear - +2 mainstat/fight");
            else if (my_primestat() == $stat[mysticality])
                description.listAppend("Owl - +2 mainstat/fight");
            else if (my_primestat() == $stat[moxie])
                description.listAppend("Puma - +2 mainstat/fight");
            description.listAppend("Hyena - +20 ML");
        }
        description.listAppend("Mouse - +10% item, +20% meat");
        description.listAppend("Weasel - survive first hit, regenerate HP");
        optional_task_entries.listAppend(ChecklistEntryMake(292, "__item the crown of ed the undying", "inventory.php?action=activateedhat", ChecklistSubentryMake("Configure the Crown of Ed the Undying", "", description), 5));
    }
    
    if (__misc_state["in run"])
    {
        //Suggest acquiring a stasis source:
        //If you're not in ronin, you should acquire a source from hangk's.
        //If you are: suckerpunch as DB -> dictionary -> facsimile dictionary -> seal tooth
        
        boolean currently_have_source = false;
        if (my_class() == $class[disco bandit])
            currently_have_source = true;
        else if ($items[dictionary,facsimile dictionary,seal tooth].item_amount() > 0)
            currently_have_source = true;
        
        boolean have_reason = false;
        //Try not to annoy anyone that doesn't currently have a reason to stasis:
        if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING) //to always trigger the underworld
            have_reason = true;
        if ($effect[everything looks yellow].have_effect() == 0 && $familiar[he-boulder].familiar_is_usable()) //to reach the correct eye
            have_reason = true;
        if ($familiars[stocking mimic,cocoabo,star starfish,Animated Macaroni Duck,Midget Clownfish,Rock Lobster,Snow Angel,Twitching Space Critter,slimeling,mini-hipster] contains my_familiar()) //MP delaying. grill intentionally left off, because it doesn't act as often in later rounds(?)
            have_reason = true;
        if (__quest_state["Level 12"].state_boolean["War started"] && __quest_state["Level 12"].in_progress && !__quest_state["Level 12"].state_boolean["Junkyard Finished"])
            have_reason = true;
        
        if (!currently_have_source && have_reason)
        {
            boolean try_for_seal_tooth = false;
            if (in_ronin())
            {
                item pull_item = $item[none];
                foreach it in $items[dictionary,facsimile dictionary,seal tooth]
                {
                    if (it.available_amount() > 0)
                    {
                        pull_item = it;
                        break;
                    }
                }
                if (pull_item != $item[none])
                {
                    string [int] description;
                    description.listAppend("Useful for delaying in-fight.");
                    optional_task_entries.listAppend(ChecklistEntryMake(293, "__item " + pull_item, "storage.php?which=3", ChecklistSubentryMake("Pull a " + pull_item, "", description), 5));
                }
                else
                    try_for_seal_tooth = true;
            }
            else
            {
                try_for_seal_tooth = true;
            }
            if (my_path_id() == PATH_NUCLEAR_AUTUMN)
                try_for_seal_tooth = false;
            
            if (try_for_seal_tooth)
            {
                string url = "";
                string [int] description;
                if ($items[worthless trinket,worthless gewgaw,worthless knick-knack].available_amount() == 0)
                {
                    url = "shop.php?whichshop=generalstore";
                    description.listAppend("Use chewing gum on a string.");
                }
                else
                {
                    url = "hermit.php";
                    description.listAppend("From the hermit.");
                }
                
                description.listAppend("Useful for delaying in-fight.");
                optional_task_entries.listAppend(ChecklistEntryMake(294, "__item seal tooth", url, ChecklistSubentryMake("Acquire a seal tooth", "", description), 5));
            }
        }
    }
}

void SMiscItemsGenerateResource(ChecklistEntry [int] resource_entries)
{
	int importance_level_item = 7;
	int importance_level_unimportant_item = 8;
    
    boolean in_run = __misc_state["in run"] && in_ronin();
    
	int navel_percent_chance_of_runaway = 20;
	if (true)
	{
        //Look up navel ring chances:
		int [int] navel_ring_runaway_chance;
		navel_ring_runaway_chance[0] = 100;
		navel_ring_runaway_chance[1] = 100;
		navel_ring_runaway_chance[2] = 100;
		navel_ring_runaway_chance[3] = 80;
		navel_ring_runaway_chance[4] = 80;
		navel_ring_runaway_chance[5] = 80;
		navel_ring_runaway_chance[6] = 50;
		navel_ring_runaway_chance[7] = 50;
		navel_ring_runaway_chance[8] = 50;
		navel_ring_runaway_chance[9] = 20;
		int navel_runaway_progress = get_property_int("_navelRunaways");
        
		if (navel_ring_runaway_chance contains navel_runaway_progress)
            navel_percent_chance_of_runaway = navel_ring_runaway_chance[navel_runaway_progress];
	}
    string navel_short_description;
    if (navel_percent_chance_of_runaway != 100)
        navel_short_description = navel_percent_chance_of_runaway + "%";
    else
    	navel_short_description = "free";
	boolean have_navel_type_equipment = false;
	if ($item[navel ring of navel gazing].available_amount() > 0 && $item[navel ring of navel gazing].is_unrestricted())
	{
        have_navel_type_equipment = true;
		string name = "Navel Ring runaways";
        
        string url = "";
        url = generateEquipmentLink($item[navel ring of navel gazing]); //&ftext=navel+ring+of+navel+gazing
		
		string [int] description;
		description.listAppend(navel_percent_chance_of_runaway + "% chance of free runaway.");
		resource_entries.listAppend(ChecklistEntryMake(295, "__item navel ring of navel gazing", url, ChecklistSubentryMake(name, "", description)).ChecklistEntrySetShortDescription(navel_short_description));
	}
	if ($item[greatest american pants].available_amount() > 0 && $item[greatest american pants].is_unrestricted())
	{
        have_navel_type_equipment = true;
		string name = "Greatest American Pants";
		
        string url = "";
        url = generateEquipmentLink($item[greatest american pants]); //&ftext=greatest+american+pants
        
		string [int] description;
		description.listAppend(navel_percent_chance_of_runaway + "% chance of free runaway.");
        
        int buffs_remaining = 5 - get_property_int("_gapBuffs");
        if (buffs_remaining > 0)
            description.listAppend(pluralise(buffs_remaining, "buff", "buffs") + " remaining.");
		resource_entries.listAppend(ChecklistEntryMake(296, "__item greatest american pants", url, ChecklistSubentryMake(name, "", description)).ChecklistEntrySetShortDescription(navel_short_description));
	}
    if ($item[peppermint parasol].available_amount() > 0 && in_run && !have_navel_type_equipment)
	{
		int parasol_progress = get_property_int("parasolUsed");
		string name = "";
		
		name = parasol_progress + "/10 peppermint parasol uses";
		string [int] description;
		description.listAppend(navel_percent_chance_of_runaway + "% chance of free runaway.");
		resource_entries.listAppend(ChecklistEntryMake(297, "__item peppermint parasol", "", ChecklistSubentryMake(name, "", description)).ChecklistEntrySetShortDescription((10 - parasol_progress)));
	}
	if ($item[pantsgiving].available_amount() > 0)
	{
		ChecklistSubentry subentry = ChecklistSubentryMake("Pantsgiving", "", "");
        
        string url = "";
        
        url = generateEquipmentLink($item[pantsgiving]);
		
		
		int banishes_available = 5 - get_property_int("_pantsgivingBanish");
		if (banishes_available > 0)
        {
        	//subentry.entries.listAppend(pluralise(banishes_available, "banish", "banishes") + " available.");
            string [int] tasks;
            if ($item[pantsgiving].equipped_amount() == 0)
            	tasks.listAppend("equip pantsgiving");
            tasks.listAppend("cast talk about politics");
            resource_entries.listAppend(ChecklistEntryMake(298, "__item pantsgiving", url, ChecklistSubentryMake(pluralise(banishes_available, "Pantsgiving banish", "Pantsgiving banishes"), "", tasks.listJoinComponents(", ").capitaliseFirstLetter() + "."), 2).ChecklistEntryTag("banish"));
            
        }
        
		int pantsgiving_fullness_used = get_property_int("_pantsgivingFullness");
		int pantsgiving_adventures_used = get_property_int("_pantsgivingCount");
		int pantsgiving_pocket_crumbs_found = get_property_int("_pantsgivingCrumbs");
		int pantsgiving_potential_crumbs_remaining = 10 - pantsgiving_pocket_crumbs_found;
		
		int adventures_needed_for_fullness_boost = 5 * powi(10, pantsgiving_fullness_used);
		int adventures_needed_for_fullness_boost_x2 = 5 * powi(10, 1 + pantsgiving_fullness_used);
		int adventures_needed_for_fullness_boost_x3 = 5 * powi(10, 2 + pantsgiving_fullness_used);
		int adventures_needed_for_fullness_boost_x4 = 5 * powi(10, 3 + pantsgiving_fullness_used);
		string short_description;
		if (adventures_needed_for_fullness_boost > pantsgiving_adventures_used)
		{
			int number_left = adventures_needed_for_fullness_boost - pantsgiving_adventures_used;
			subentry.entries.listAppend(pluralise(number_left, "adventure", "adventures") + " until next fullness.");
            short_description = number_left;
		}
		else //already there
		{
  	      	short_description = "now";
			string extra_fullness_available = "Fullness";
			if (pantsgiving_adventures_used > adventures_needed_for_fullness_boost_x2)
                extra_fullness_available = "2x fullness";
			if (pantsgiving_adventures_used > adventures_needed_for_fullness_boost_x3)
                extra_fullness_available = "3x fullness";
			if (pantsgiving_adventures_used > adventures_needed_for_fullness_boost_x4)
                extra_fullness_available = "4x fullness (wh.. what?)";
			if (availableFullness() == 0)
			{
				subentry.entries.listAppend(extra_fullness_available + " available next adventure.");
			}
			else
                subentry.entries.listAppend(extra_fullness_available + " available when you're full.");
		}
		
		if (pantsgiving_potential_crumbs_remaining > 0)
			subentry.entries.listAppend(pluralise(pantsgiving_potential_crumbs_remaining, " pocket crumb item", " pocket crumb items") + " left.");
		
		if (subentry.entries.count() > 0)
		{
			ChecklistEntry entry = ChecklistEntryMake(299, "__item pantsgiving", url, subentry);
			entry.should_indent_after_first_subentry = true;
            entry.ChecklistEntrySetShortDescription(short_description);
			resource_entries.listAppend(entry);
		}
	}
    
    
    
    if (__misc_state["free runs usable"] && in_run && $item[bottle of blank-out].available_amount() > 0)
	{
		string [int] description;
		string name;
		int blankout_count = $item[bottle of blank-out].available_amount();
		name += pluralise(blankout_count, "blank-out", "blank-out");
        
		if ($item[glob of blank-out].available_amount() == 0)
            description.listAppend("Use blank-out for glob.");
        if (get_property_boolean("_blankoutUsed"))
            description.listAppend("Will have to wait until tomorrow to open.");
        
		resource_entries.listAppend(ChecklistEntryMake(300, "__item Bottle of Blank-Out", "inventory.php?which=3&ftext=bottle+of+blank-out", ChecklistSubentryMake(name, "", description)));
	}
    if (__misc_state["free runs usable"] && $item[glob of blank-out].available_amount() > 0)
    {
		int uses_remaining = 5 - get_property_int("blankOutUsed");
		string [int] description;
		string name;
        description.listAppend("Use glob of blank-out in combat.");
        if (!in_run)
            description.listAppend("Will disappear when you ascend.");
        
        name = pluralise(uses_remaining, "blank-out runaway", "blank-out runaways");
		resource_entries.listAppend(ChecklistEntryMake(301, "__item glob of blank-out", "", ChecklistSubentryMake(name, "", description)));
    }

	if ($item[BitterSweetTarts].available_amount() > 0 && __misc_state["need to level"])
	{
		int modifier = min(11, my_level());
		string [int] description;
		description.listAppend("+" + modifier + " stats/fight, 10 turns");
		if (my_level() < 11)
		{
			description.listAppend("Wait until level 11 for full effectiveness");
		}
		resource_entries.listAppend(ChecklistEntryMake(302, "__item BitterSweetTarts", "inventory.php?which=3&ftext=bittersweettarts", ChecklistSubentryMake(pluralise($item[BitterSweetTarts]), "", description), importance_level_item));
	}
	if ($item[polka pop].available_amount() > 0 && in_run)
	{
		int modifier = 5 * min(11, my_level());
		string [int] description;
        description.listAppend("+" + modifier + "% item, " + "+" + modifier + "% meat");
		if (my_level() < 11)
		{
			description.listAppend("Wait until level 11 for full effectiveness");
		}
		resource_entries.listAppend(ChecklistEntryMake(303, "__item polka pop", "", ChecklistSubentryMake(pluralise($item[polka pop]), "10 turns", description), importance_level_item));
	}
        
    if ($item[frost flower].available_amount() > 0 && in_run)
    {
        string [int] description;
        description.listAppend("+100% item, +200% meat, +25 ML, +100% init");
        resource_entries.listAppend(ChecklistEntryMake(304, "__item frost flower", "inventory.php?which=3&ftext=frost+flower", ChecklistSubentryMake($item[frost flower].pluralise(), "50 turns", description), importance_level_item));
    }
	if (in_run)
	{
		//Resolutions:
		string [item] resolution_descriptions;
		resolution_descriptions[$item[resolution: be happier]] = "+15% item (20 turns)";
		//resolution_descriptions[$item[resolution:be feistier]] = "+20 spell damage"; //information overload?
		if (__misc_state["need to level"])
		{
			resolution_descriptions[$item[resolution: be stronger]] = "+2 muscle stats/combat (20 turns)";
			resolution_descriptions[$item[resolution: be smarter]] = "+2 mysticality stats/combat (20 turns)";
			resolution_descriptions[$item[resolution: be sexier]] = "+2 moxie stats/combat (20 turns)";
		}
		resolution_descriptions[$item[resolution: be kinder]] = "+5 familiar weight (20 turns)";
		resolution_descriptions[$item[resolution: be luckier]] = "+5% item, +5% meat, +10% init, others (20 turns)"; //???
        if (my_path_id() != PATH_SLOW_AND_STEADY)
            resolution_descriptions[$item[resolution: be more adventurous]] = "+2 adventures at rollover";
		resolution_descriptions[$item[resolution: be wealthier]] = "+30% meat";
        
        
	
		ChecklistSubentry [int] resolution_lines;
		foreach it in resolution_descriptions
		{
			if (it.available_amount() == 0)
				continue;
			string description = resolution_descriptions[it];
			
			resolution_lines.listAppend(ChecklistSubentryMake(pluralise(it), "",  description));
		}
		if (resolution_lines.count() > 0)
			resource_entries.listAppend(ChecklistEntryMake(305, "__item resolution: be luckier", "inventory.php?which=3&ftext=resolution:+be", resolution_lines, importance_level_item));
			
	}
	if (in_run)
	{
        //doesn't show how much, because wahh I don't wanna write taffy code
		string [item] taffy_descriptions;
		taffy_descriptions[$item[pulled yellow taffy]] = "+meat, +item";
		if (__misc_state["need to level"])
		{
            taffy_descriptions[$item[pulled red taffy]] = "+moxie stats/fight";
            taffy_descriptions[$item[pulled orange taffy]] = "+muscle stats/fight";
            taffy_descriptions[$item[pulled violet taffy]] = "+mysticality stats/fight";
		}
		taffy_descriptions[$item[pulled blue taffy]] = "+familiar weight, +familiar experience";
        string image_name = "";
		ChecklistSubentry [int] taffy_lines;
		foreach it in taffy_descriptions
		{
			if (it.available_amount() == 0)
				continue;
			string description = taffy_descriptions[it];
			if (image_name == "")
                image_name = "__item " + it;
			taffy_lines.listAppend(ChecklistSubentryMake(pluralise(it), "",  description));
		}
		if (taffy_lines.count() > 0)
			resource_entries.listAppend(ChecklistEntryMake(306, image_name, "inventory.php?which=3&ftext=pulled", taffy_lines, importance_level_item));
			
	}
	
	
	
	if (in_run)
	{
		if (7014.to_item().available_amount() > 0)
			resource_entries.listAppend(ChecklistEntryMake(307, "__item " + 7014.to_item().to_string(), "", ChecklistSubentryMake(pluralise(7014.to_item()), "", "Free run, banish for 20 turns"), importance_level_item).ChecklistEntryTag("free banish"));
		if ($item[crystal skull].available_amount() > 0)
			resource_entries.listAppend(ChecklistEntryMake(308, "__item crystal skull", "", ChecklistSubentryMake(pluralise($item[crystal skull]), "", "Turn-costing banishing"), importance_level_item).ChecklistEntryTag("banish"));
            
		if ($item[harold's bell].available_amount() > 0)
			resource_entries.listAppend(ChecklistEntryMake(309, "__item harold's bell", "", ChecklistSubentryMake(pluralise($item[harold's bell]), "", "Turn-costing banishing"), importance_level_item).ChecklistEntryTag("banish"));
        
		if ($item[lost key].available_amount() > 0)
        {
            string [int] details;
            details.listAppend("Lost pill bottle is mini-fridge, take a nap, open the pill bottle.");
            //FIXME does stunning work on tower monsters?
            //if (!__quest_state["Level 13"].state_boolean["past tower monsters"] && (!$item[munchies pill].is_unrestricted() || !__misc_state["can eat just about anything"]))
                //details.listAppend("The lost comb is turn on the TV, take a nap, pick up the comb. (towerkilling)");
            if ($classes[pastamancer,sauceror] contains my_class() && $skill[Transcendental Noodlecraft].skill_is_usable() && $skill[The Way of Sauce].skill_is_usable() && $skill[pulverize].skill_is_usable())
                details.listAppend("The lost glasses is mini-fridge, TV, glasses.");
			resource_entries.listAppend(ChecklistEntryMake(310, "__item lost key", "inventory.php?which=3&ftext=lost+key", ChecklistSubentryMake(pluralise($item[lost key]), "", details), importance_level_item));
        }
			
		if ($item[soft green echo eyedrop antidote].available_amount() > 0 && $skill[Transcendent Olfaction].skill_is_usable())
			resource_entries.listAppend(ChecklistEntryMake(311, "__item soft green echo eyedrop antidote", "", ChecklistSubentryMake(pluralise($item[soft green echo eyedrop antidote]), "", "Removes on the trail, teleportitis"), importance_level_unimportant_item));
			
		if ($item[sack lunch].available_amount() > 0)
		{
			string [int] description;
			int importance = importance_level_item;
			if (my_level() < 11)
			{
				description.listAppend("Wait until level 11+ to open for best food.");
				importance = importance_level_unimportant_item;
			}
			else
			{
				description.listAppend("Safe to open.");
			}
			resource_entries.listAppend(ChecklistEntryMake(312, "__item sack lunch", "inventory.php?which=3&ftext=sack+lunch", ChecklistSubentryMake(pluralise($item[sack lunch]), "", description), importance));
		}
        
        if (true)
        {
			ChecklistSubentry [int] subentries;
            string image_name = "";
            
            string [item] descriptions;
            descriptions[$item[NPZR chemistry set]] = "Open for 20 invisibility/irresistibility/irritability potions.";
            descriptions[$item[invisibility potion]] = "-5% combat (20 turns)";
            descriptions[$item[irresistibility potion]] = "+5% combat (20 turns)";
            descriptions[$item[irritability potion]] = "+15 ML (20 turns)";
            
            foreach it in $items[NPZR chemistry set,invisibility potion,irresistibility potion,irritability potion]
            {
                if (it.available_amount() == 0)
                    continue;
                if (image_name.length() == 0)
                    image_name = "__item " + it;
                    
                subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", descriptions[it]));
            }
            
            if (subentries.count() > 0)
                resource_entries.listAppend(ChecklistEntryMake(313, image_name, "inventory.php?which=3", subentries, importance_level_item));
        }
	}
	if ($item[smut orc keepsake box].available_amount() > 0 && !__quest_state["Level 9"].state_boolean["bridge complete"] && __misc_state["in run"])
		resource_entries.listAppend(ChecklistEntryMake(314, "__item smut orc keepsake box", "inventory.php?which=3&ftext=smut+orc+keepsake+box", ChecklistSubentryMake(pluralise($item[smut orc keepsake box]), "", "Open for bridge building."), 0));
		
    if ($item[wand of pigification].available_amount() > 0 && in_bad_moon() && __misc_state["in run"])
    {
		resource_entries.listAppend(ChecklistEntryMake(315, "__item wand of pigification", "", ChecklistSubentryMake("Wand of pigification", "", "Use twice a day on monsters for good-level food."), 6));
    }
		
	int clovers_available = $items[disassembled clover,ten-leaf clover].available_amount() + $item[disassembled clover].closet_amount() + $item[ten-leaf clover].closet_amount();
	if (my_path_id() == PATH_BEES_HATE_YOU || my_path_id() == PATH_G_LOVER)
		clovers_available = $item[ten-leaf clover].item_amount() + $item[ten-leaf clover].closet_amount();
	if (clovers_available > 0 && in_run)
	{
		ChecklistSubentry subentry;
		subentry.header = pluralise(clovers_available, "clover", "clovers") + " available";
        
		
		if (!__quest_state["Level 9"].state_boolean["bridge complete"])
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Orc logging camp, for bridge building. (3/3)", $location[the smut orc logging camp]));
		if ($item[a-boo clue].available_amount() < 4 && (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0 || !__quest_state["Level 9"].state_boolean["bridge complete"]) && my_path_id() != PATH_G_LOVER)
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("A-Boo clues. (2)", $location[a-boo peak]));
		if (__misc_state["wand of nagamar needed"] && $item[wand of nagamar].creatable_amount() == 0)
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Wand of nagamar components (castle basement)", $location[the castle in the clouds in the sky (basement)]));
		boolean have_all_gum = $item[pack of chewing gum].available_amount() > 0 || ($item[jaba&ntilde;ero-flavored chewing gum].available_amount() > 0 && $item[lime-and-chile-flavored chewing gum].available_amount() > 0 && $item[pickle-flavored chewing gum].available_amount() > 0 && $item[tamarind-flavored chewing gum].available_amount() > 0);
		if (__quest_state["Level 4"].state_int["areas unlocked"] + $item[sonar-in-a-biscuit].available_amount() < 2)
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("2 sonar-in-a-biscuit (Guano Junction)", $location[guano junction]));
   
   		if (__quest_state["Level 11 Ron"].mafia_internal_step <= 2 && __quest_state["Level 11 Ron"].state_int["protestors remaining"] > 1)
            subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Mob of zeppelin protestors NC", $location[A Mob of Zeppelin Protesters]));         
		if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && !(get_property_boolean("lovebugsUnlocked") && $item[bottle of lovebug pheromones].is_unrestricted())) //taking a gamble here - I'm assuming you'd never clover for ultrahydrated if you have lovebugs. even if you run out of ultrahydrated, you'll likely get it again in a hurry
        {
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Ultrahydrated (Oasis)", $location[the oasis]));
        }
        if (!__quest_state["Level 8"].state_boolean["Past mine"])
        {
            item ore_needed = __quest_state["Level 8"].state_string["ore needed"].to_item();
            if (ore_needed == $item[none])
                subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Mining ore. (1)", $location[itznotyerzitz mine]));
            else
                subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability(ore_needed.capitaliseFirstLetter() + ". (1)", $location[itznotyerzitz mine]));
        }
		if (__misc_state["need to level"] && !__misc_state["Stat gain from NCs reduced"])
        {
            location l = $location[none];
            if (my_primestat() == $stat[moxie])
                l = $location[the haunted ballroom];
            else if (my_primestat() == $stat[mysticality])
                l = $location[the haunted bathroom];
            else if (my_primestat() == $stat[muscle])
                l = $location[the haunted gallery];
			subentry.entries.listAppend(HTMLGenerateFutureTextByLocationAvailability("Powerlevelling (" + l + ")", l));
        }
		//put relevant tower items here
		
		resource_entries.listAppend(ChecklistEntryMake(316, "clover", "", subentry, 7).ChecklistEntryTag("clovers"));
	}
	if (in_run && $item[lucky pill].have() && availableSpleen() > 0)
	{
		string [int] description;
        description.listAppend("Chew for clovers.");
        resource_entries.listAppend(ChecklistEntryMake(317, "__item lucky pill", "inventory.php?which=3&ftext=lucky+pill", ChecklistSubentryMake(pluralise($item[lucky pill]), "", description), importance_level_unimportant_item).ChecklistEntryTag("clovers"));
	}
	if (in_run)
	{
		if ($item[gameinformpowerdailypro magazine].available_amount() > 0)
		{
			string [int] description;
			description.listAppend("Zero-turn free SGEAA and scrolls");
			resource_entries.listAppend(ChecklistEntryMake(318, "__item gameinformpowerdailypro magazine", "inventory.php?which=3&ftext=gameinformpowerdailypro+magazine", ChecklistSubentryMake(pluralise($item[gameinformpowerdailypro magazine]), "", description), importance_level_unimportant_item));
		}
	}
    if ($item[divine champagne popper].available_amount() > 0 && in_run)
    {
        resource_entries.listAppend(ChecklistEntryMake(319, "__item divine champagne popper", "", ChecklistSubentryMake(pluralise($item[divine champagne popper]), "", "Free run and five-turn banish."), importance_level_unimportant_item).ChecklistEntryTag("free banish"));
    }
    if (__misc_state["need to level"])
    {
		if ($item[dance card].available_amount() > 0 && my_primestat() == $stat[moxie] && in_ronin())
        {
			string [int] description;
			description.listAppend("Gain ~" + round(__misc_state_float["dance card average stats"]) + " mainstat from delayed adventure in the haunted ballroom.");
			resource_entries.listAppend(ChecklistEntryMake(320, "__item dance card", "inventory.php?which=3&ftext=dance+card", ChecklistSubentryMake(pluralise($item[dance card]), "", description), importance_level_unimportant_item));
        }
    }
	if ($item[stone wool].available_amount() > 0 && in_ronin() && $item[stone wool].item_is_usable())
	{
		string [int] description;
		string url = "inventory.php?which=3&ftext=stone+wool";
		int quest_needed = 2;
		if ($item[the nostril of the serpent].available_amount() > 0)
			quest_needed -= 1;
		if (locationAvailable($location[the hidden park]) || !in_run)
			quest_needed = 0;
		
		if (quest_needed > 0)
			description.listAppend(quest_needed + " to unlock hidden city.");
		if (__misc_state["need to level"])
			description.listAppend("Cave bar.");
		if (!get_property_ascension("lastTempleAdventures") && my_path_id() != PATH_SLOW_AND_STEADY)
        {
            string line = "+3 adventures, +3 duration to ten effects. (once/ascension)";
            if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
                line += "|Can use to extend effects at nuns.";
			description.listAppend(line);
        }
        if (!__misc_state["in run"] && $effect[stone-faced].have_effect() > 0)
            url = $location[the hidden temple].getClickableURLForLocation();
		if (description.count() > 0)
			resource_entries.listAppend(ChecklistEntryMake(321, "__item stone wool", url, ChecklistSubentryMake(pluralise($item[stone wool]), "", description), importance_level_unimportant_item));
	}
    if ($item[the legendary beat].available_amount() > 0 && !get_property_boolean("_legendaryBeat"))
    {
        resource_entries.listAppend(ChecklistEntryMake(322, "__item The Legendary Beat", "inventory.php?which=3&ftext=the+legendary+beat", ChecklistSubentryMake("The Legendary Beat", "", "+50% item. (20 turns)"), importance_level_item).ChecklistEntrySetCategory("buff"));
        
    }
    item zap_wand_owned;
	if (true)
	{
		zap_wand_owned = $item[none];
		foreach wand in $items[aluminum wand,ebony wand,hexagonal wand,marble wand,pine wand]
		{
			if (wand.available_amount() > 0)
			{
				zap_wand_owned = wand;
				break;
			}
		}
		if (zap_wand_owned != $item[none])
		{
            string url = "wand.php?whichwand=" + zap_wand_owned.to_int();
			int zaps_used = get_property_int("_zapCount");
			string [int] details;
			if (zaps_used == 0)
				details.listAppend("Can zap safely.");
			else
            {
                float [int] chances;
                chances[1] = 75.0;
                chances[2] = 18.75;
                chances[3] = 1.5625;
                float chance = chances[zaps_used];
                
                if (zaps_used >= 4)
                    details.listAppend("Warning: Cannot zap.");
                else
					details.listAppend("Warning: " + roundForOutput(100.0 - chance, 1) + "% chance of explosion.");
				if ($item[Platinum Yendorian Express Card].available_amount() > 0 && !get_property_boolean("expressCardUsed"))
					details.listAppend("Platinum Yendorian Express Card usable.");
            }
			resource_entries.listAppend(ChecklistEntryMake(323, zap_wand_owned, url, ChecklistSubentryMake(pluralise(zaps_used, "zap", "zaps") + " used with " + zap_wand_owned, "", details), 10));
		}
	}
    
    if (!get_property_boolean("_defectiveTokenChecked") && get_property_ascension("lastArcadeAscension"))
    {
        resource_entries.listAppend(ChecklistEntryMake(324, "__item jackass plumber home game", "place.php?whichplace=arcade", ChecklistSubentryMake("Broken arcade game", "", "May find a defective game grid token."), importance_level_item));
    }
    if ($item[picky tweezers].available_amount() > 0 && !get_property_boolean("_pickyTweezersUsed"))
    {
        resource_entries.listAppend(ChecklistEntryMake(325, "__item picky tweezers", "inventory.php?which=3&ftext=picky+tweezers", ChecklistSubentryMake("Picky tweezers", "", "Acquire a single atom."), importance_level_unimportant_item));
    }
    if ($item[defective Game Grid token].available_amount() > 0 && !get_property_boolean("_defectiveTokenUsed"))
    {
        string [int] description;
        description.listAppend("+5 to everything. (5 turns)");
        
        resource_entries.listAppend(ChecklistEntryMake(326, "__item defective Game Grid token", "inventory.php?which=3&ftext=defective+game+grid+token", ChecklistSubentryMake("Defective Game Grid Token", "", description), importance_level_item).ChecklistEntrySetCategory("buff"));
    }
    if ($item[Platinum Yendorian Express Card].available_amount() > 0 && !get_property_boolean("expressCardUsed"))
    {
        string [int] description;
        string line = "Extends buffs, restores MP";
        if (get_property_int("_zapCount") > 0 && zap_wand_owned != $item[none] && zap_wand_owned.available_amount() > 0)
            line += ", cools down " + zap_wand_owned;
        line += ".";
        description.listAppend(line);
        resource_entries.listAppend(ChecklistEntryMake(327, "__item Platinum Yendorian Express Card", "", ChecklistSubentryMake("Platinum Yendorian Express Card", "", description), importance_level_item));
    }
    
    
    if ($item[mojo filter].available_amount() > 0 && get_property_int("currentMojoFilters") <3 && in_run)
    {
        int mojo_filters_usable = MIN(my_spleen_use(), MIN(3 - get_property_int("currentMojoFilters"), $item[mojo filter].available_amount()));
        string line = "Removes one spleen each.";
        if (mojo_filters_usable != $item[mojo filter].available_amount())
            line += "|" + pluralise(mojo_filters_usable, "filter", "filters") + " usable.";
        
        if (mojo_filters_usable > 0)
            resource_entries.listAppend(ChecklistEntryMake(328, "__item mojo filter", "inventory.php?which=3&ftext=mojo+filter", ChecklistSubentryMake(pluralise($item[mojo filter]), "", line), importance_level_unimportant_item));
    }
    if ($item[distention pill].available_amount() > 0 && !get_property_boolean("_distentionPillUsed") && in_run)
    {
        resource_entries.listAppend(ChecklistEntryMake(329, "__item distention pill", "inventory.php?which=3&ftext=distention+pill", ChecklistSubentryMake(pluralise($item[distention pill]), "", "Adds one extra fullness.|Once/day."), importance_level_unimportant_item));
    }
    if ($item[synthetic dog hair pill].available_amount() > 0 && !get_property_boolean("_syntheticDogHairPillUsed") && in_run)
    {
        resource_entries.listAppend(ChecklistEntryMake(330, "__item synthetic dog hair pill", "inventory.php?which=3&ftext=synthetic+dog+hair+pill", ChecklistSubentryMake(pluralise($item[synthetic dog hair pill]), "", "Adds one extra drunkenness.|Once/day."), importance_level_unimportant_item));
    }
    if ($item[the lost pill bottle].available_amount() > 0 && in_run && my_path_id() != PATH_BEES_HATE_YOU)
    {
        string header = pluralise($item[the lost pill bottle]);
        if ($item[the lost pill bottle].available_amount() == 1)
            header = $item[the lost pill bottle];
        resource_entries.listAppend(ChecklistEntryMake(331, "__item the lost pill bottle", "inventory.php?which=3&ftext=the+lost+pill+bottle", ChecklistSubentryMake(header, "", "Open it."), importance_level_unimportant_item));
    }
    if (__misc_state["need to level"] && in_ronin())
    {
        if ($item[Marvin's marvelous pill].available_amount() > 0 && __misc_state["need to level moxie"])
        {
            resource_entries.listAppend(ChecklistEntryMake(332, "__item Marvin's marvelous pill", "", ChecklistSubentryMake(pluralise($item[Marvin's marvelous pill]), "", "+20% to moxie gains. (10 turns)"), importance_level_unimportant_item));
        }
        if ($item[drum of pomade].available_amount() > 0 && __misc_state["need to level moxie"])
        {
            resource_entries.listAppend(ChecklistEntryMake(333, "__item drum of pomade", "", ChecklistSubentryMake(pluralise($item[drum of pomade]), "", "+15% to moxie gains. (10 turns)"), importance_level_unimportant_item));
        }
        if ($item[baobab sap].available_amount() > 0 && __misc_state["need to level muscle"])
        {
            resource_entries.listAppend(ChecklistEntryMake(334, "__item baobab sap", "", ChecklistSubentryMake(pluralise($item[baobab sap]), "", "+20% to muscle gains. (10 turns)"), importance_level_unimportant_item));
        }
        if ($item[desktop zen garden].available_amount() > 0 && __misc_state["need to level mysticality"])
        {
            resource_entries.listAppend(ChecklistEntryMake(335, "__item desktop zen garden", "", ChecklistSubentryMake(pluralise($item[desktop zen garden]), "", "+20% to mysticality gains. (10 turns)"), importance_level_unimportant_item));
        }
    }
    if ($item[munchies pill].available_amount() > 0 && fullness_limit() > 0 && in_run && my_path_id() != PATH_SLOW_AND_STEADY)
    {
        resource_entries.listAppend(ChecklistEntryMake(336, "__item munchies pill", "", ChecklistSubentryMake(pluralise($item[munchies pill]), "", "+3 turns from fortune cookies and other low-fullness foods."), importance_level_unimportant_item));
    }
    if ($item[snow cleats].available_amount() > 0 && in_run)
        resource_entries.listAppend(ChecklistEntryMake(337, "__item snow cleats", "", ChecklistSubentryMake(pluralise($item[snow cleats]), "", "-5% combat, 30 turns."), importance_level_item));
        
    if ($item[vitachoconutriment capsule].available_amount() > 0 && get_property_int("_vitachocCapsulesUsed") <3 && in_run)
    {
        string [int] adventures_remaining;
        int capsules_remaining = $item[vitachoconutriment capsule].available_amount();
        int vita_used = get_property_int("_vitachocCapsulesUsed");
        if (vita_used < 1)
        {
            adventures_remaining.listAppend("+5");
            vita_used += 1;
            capsules_remaining -= 1;
        }
        if (vita_used < 2 && capsules_remaining > 0)
        {
            adventures_remaining.listAppend("+3");
            vita_used += 1;
            capsules_remaining -= 1;
        }
        if (vita_used < 3 && capsules_remaining > 0)
        {
            adventures_remaining.listAppend("+1");
        }
        string line;
        line = adventures_remaining.listJoinComponents("/") + " adventures";
        if (adventures_remaining.count() == 1) //hacky
        {
            if (adventures_remaining[0] == "+1")
                line = "+1 adventure";
        }
        line += ".";
        resource_entries.listAppend(ChecklistEntryMake(338, "__item vitachoconutriment capsule", "inventory.php?which=3&ftext=vitachoconutriment+capsule", ChecklistSubentryMake(pluralise($item[vitachoconutriment capsule]), "", line), importance_level_unimportant_item));
    }
    if (__misc_state["in run"] && $item[tryptophan dart].available_amount() > 0 && in_ronin() && $item[tryptophan dart].item_is_usable())
    {
        resource_entries.listAppend(ChecklistEntryMake(339, "__item tryptophan dart", "", ChecklistSubentryMake(pluralise($item[tryptophan dart]), "", "Free run/banish."), 6).ChecklistEntryTag("banish"));
    }
    
    if ($item[drum machine].available_amount() > 0 && in_run && (my_adventures() <= 1 || (availableDrunkenness() < 0 && availableDrunkenness() > -4 && my_adventures() >= 1)) && __quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && $item[drum machine].item_is_usable())
    {
        //Daycount strategy that never works, suggest:
        string line = (100.0 * ((item_drop_modifier_ignoring_plants() / 100.0 + 1.0) * (1.0 / 1000.0))).roundForOutput(2) + "% chance of spice melange.";
        if (my_adventures() == 0)
            line += "|Need one adventure.";
        resource_entries.listAppend(ChecklistEntryMake(340, "__item drum machine", "inventory.php?which=3&ftext=drum+machine", ChecklistSubentryMake(pluralise($item[drum machine]), "", line), importance_level_unimportant_item));
    }
    
    
    if ($items[stinky cheese sword,stinky cheese diaper,stinky cheese wheel,stinky cheese eye,Staff of Queso Escusado].available_amount() > 0 && !get_property_boolean("_stinkyCheeseBanisherUsed"))
    {
        resource_entries.listAppend(ChecklistEntryMake(341, "__item stinky cheese eye", "", ChecklistSubentryMake("Stinky cheese eye banish", "", "Free run.")).ChecklistEntryTag("free banish"));
    }
    
    if (in_run)
    {
		if ($item[tattered scrap of paper].available_amount() > 0 && __misc_state["free runs usable"] && $item[tattered scrap of paper].item_is_usable())
		{
			string [int] description;
			description.listAppend(($item[tattered scrap of paper].available_amount() / 2.0).roundForOutput(1) + " free runs.");
            if (in_bad_moon())
                description.listAppend("Or save for demon summoning.");
			resource_entries.listAppend(ChecklistEntryMake(342, "__item tattered scrap of paper", "", ChecklistSubentryMake(pluralise($item[tattered scrap of paper]), "", description), importance_level_unimportant_item));
		}
		if (2371.to_item().available_amount() > 0 && __misc_state["free runs usable"])
		{
            item it = 2371.to_item();
			string [int] description;
			description.listAppend((it.available_amount() * 0.9).roundForOutput(1) + " free runs.");
			resource_entries.listAppend(ChecklistEntryMake(343, "__item " + it, "", ChecklistSubentryMake(pluralise(it), "", description), importance_level_unimportant_item));
		}
		if ($item[dungeoneering kit].available_amount() > 0)
		{
			string line = "Open it.";
			if ($item[dungeoneering kit].available_amount() > 1)
				line = "Open them.";
			resource_entries.listAppend(ChecklistEntryMake(344, "__item dungeoneering kit", "inventory.php?which=3&ftext=dungeoneering+kit", ChecklistSubentryMake(pluralise($item[dungeoneering kit]), "", line), importance_level_unimportant_item));
		}
        if ($item[Box of familiar jacks].available_amount() > 0)
            resource_entries.listAppend(ChecklistEntryMake(345, "__item box of familiar jacks", "", ChecklistSubentryMake(pluralise($item[Box of familiar jacks]), "", "Gives current familiar equipment."), importance_level_unimportant_item));
        if ($item[csa fire-starting kit].available_amount() > 0 && !get_property_boolean("_fireStartingKitUsed"))
        {
            string [int] description;
            description.listAppend("All-day 4 HP/MP regeneration.");
            if (hippy_stone_broken())
                description.listAppend("3 PVP fights.");
            resource_entries.listAppend(ChecklistEntryMake(346, "__item csa fire-starting kit", "inventory.php?which=3&ftext=csa+fire-starting+kit", ChecklistSubentryMake($item[csa fire-starting kit], "", description), importance_level_unimportant_item));
        }
        
        if ($item[transporter transponder].available_amount() > 0)
        {
            string [int] options;
            if (__misc_state["need to level"])
                options.listAppend("powerleveling");
            if (fullness_limit() > 0 || inebriety_limit() > 0)
                options.listAppend("yellow ray in grimace for synthetic dog hair/distention pill");
            
            string description = "Spaaaaace access.";
            if (options.count() > 0)
                description += "|" + options.listJoinComponents(", ", "and").capitaliseFirstLetter();
            resource_entries.listAppend(ChecklistEntryMake(347, "__item transporter transponder", "", ChecklistSubentryMake(pluralise($item[transporter transponder]), "", description), importance_level_unimportant_item));
        }
    }
    
    foreach it in $items[carton of astral energy drinks,astral hot dog dinner,astral six-pack]
    {
        if (it.available_amount() == 0)
            continue;
        resource_entries.listAppend(ChecklistEntryMake(348, "__item " + it, "inventory.php?which=3&ftext=" + it.replace_string(" ", "+"), ChecklistSubentryMake(pluralise(it), "", "Open for astral consumables."), importance_level_unimportant_item));
    }
    
    if ($item[map to safety shelter grimace prime].available_amount() > 0)
    {
        string line = "Use for synthetic dog hair or distention pill.";
        if (__misc_state["in aftercore"])
            line += "|Will disappear when you ascend.";
        resource_entries.listAppend(ChecklistEntryMake(349, "__item " + $item[map to safety shelter grimace prime], "inventory.php?which=3&ftext=map+to+safety+shelter+grimace+prime", ChecklistSubentryMake(pluralise($item[map to safety shelter grimace prime]), "", line), importance_level_unimportant_item));
    }
    if ($item[rusty hedge trimmers].available_amount() > 0 && __quest_state["Level 9"].state_int["twin peak progress"] != 15 && in_run)
    {
        string [int] description;
        description.listAppend("Use to visit the Twin Peak non-combat.");
        resource_entries.listAppend(ChecklistEntryMake(350, "__item " + $item[rusty hedge trimmers], "inventory.php?which=3&ftext=rusty+hedge+trimmers", ChecklistSubentryMake(pluralise($item[rusty hedge trimmers]), "", description), importance_level_unimportant_item));
    }
    
    if (in_run && my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST)
    {
        string image_name = "";
        string [int] autosell_list;
        boolean [item] autosellable_items = $items[meat stack, dense meat stack, really dense meat stack, solid gold bowling ball, fancy seashell necklace, commemorative war stein,huge gold coin].makeConstantItemArrayMutable();
        if ($item[pixel coin] != $item[none])
            autosellable_items[$item[pixel coin]] = true;
        foreach it in autosellable_items
        {
            if (it.available_amount() == 0)
                continue;
            autosell_list.listAppend(it.pluralise());
            
            if (image_name.length() == 0)
                image_name = "__item " + it;
        }
            
        string [int] open_list;
        foreach it in lookupItems("old coin purse, old leather wallet, black pension check, ancient vinyl coin purse, warm subject gift certificate,shiny stones, envelope full of Meat")
        {
            if (it.available_amount() == 0)
                continue;
            if (!it.item_is_usable()) continue;
            open_list.listAppend(it.pluralise());
            
            if (image_name.length() == 0)
                image_name = "__item " + it;
        }
        
        string url = "";
        string [int] description;
        if (autosell_list.count() > 0)
        {
            url = "sellstuff_ugly.php";
            description.listAppend("Autosell " + autosell_list.listJoinComponents(", ", "and") + ".");
        }
        if (open_list.count() > 0)
        {
            url = "inventory.php?which=3";
            description.listAppend("Open " + open_list.listJoinComponents(", ", "and") + ".");
        }
        
        if (description.count() > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(351, image_name, url, ChecklistSubentryMake("Meat", "", description), importance_level_unimportant_item).ChecklistEntrySetShortDescription("meat"));
        }
    }
    //Penultimate Fantasy chest?
    
    item odd_silver_coin = $item[odd silver coin];
    if (odd_silver_coin.available_amount() > 0 && in_run)
    {
        string [int] description;
        string [int][int] table;
        //cinnamon cannoli - 2 - 1 fullness awesome food. not worthwhile?
        //expensive champagne - 3 - 1-drunkness epic drink. not worthwhile?
        //polo trophy - 3 - +50ML for 15 turns
        //table.listAppend(listMake("polo trophy", "+50ML for 15 turns, marginal?", "3 coins")); //costs three adventures to find. I guess it'd only be relevant for cave bars? even then...
        //fancy oil painting - 4 - bridge building. 10 progress
        if (!__quest_state["Level 9"].state_boolean["bridge complete"] && (__quest_state["Level 9"].state_int["bridge fasteners needed"] > 0 || __quest_state["Level 9"].state_int["bridge lumber needed"] > 0))
            table.listAppend(listMake("fancy oil painting", "10 fasteners, 10 lumber", "4 coins"));
        //solid gold rosary - 5 - better cyrpt progression. need details (-4.5 evil?)
        if (!__quest_state["Level 7"].state_boolean["alcove finished"] || !__quest_state["Level 7"].state_boolean["cranny finished"] || !__quest_state["Level 7"].state_boolean["niche finished"] || !__quest_state["Level 7"].state_boolean["nook finished"])
            table.listAppend(listMake("solid gold rosary", "-4.5? evilness from cyrpt", "5 coins"));
        //ornate dowsing rod - 5 - better desert exploration (+2%)
        
        if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && $item[ornate dowsing rod].available_amount() == 0)
            table.listAppend(listMake("ornate dowsing rod", "+2% desert exploration", "5 coins"));
        description.listAppend(HTMLGenerateSimpleTableLines(table));
        
        resource_entries.listAppend(ChecklistEntryMake(352, "__item " + odd_silver_coin, "shop.php?whichshop=cindy", ChecklistSubentryMake(odd_silver_coin.pluralise(), "", description), importance_level_item));
    }
    item grimstone_mask = $item[grimstone mask];
    if (grimstone_mask.available_amount() > 0 && in_run)
    {
        string [int] description;
        
        description.listAppend("Wear to take you places.");
        description.listAppend("The prince's ball (stepmother) lets you find odd silver coins.|Up to six, one adventure each.");
        //description.listAppend("Rumpelstiltskin's for towerkilling with small golem.|Small golem is a 5k/round combat item.|Involves the semi-rare in village. Don't know the details, sorry."); //only somewhat relevant in obscure edge cases
        if ($effect[Human-Fish Hybrid].have_effect() == 0 && __iotms_usable[$item[Little Geneticist DNA-Splicing Lab]] && !__misc_state["familiars temporarily blocked"])
            description.listAppend("Candy witch for human-fish hybrid. (+10 familiar weight)");
        if (get_property("grimstoneMaskPath") != "")
            description.listAppend("Currently on the path of " + get_property("grimstoneMaskPath") + ".");
        
        resource_entries.listAppend(ChecklistEntryMake(353, "__item " + grimstone_mask, "inventory.php?which=3&ftext=grimstone+mask", ChecklistSubentryMake(grimstone_mask.pluralise(), "", description), importance_level_item));
    }
    
    if (get_campground()[$item[spinning wheel]] > 0 && !get_property_boolean("_spinningWheel"))
    {
        string [int] description;
        int meat_gained = powi(MIN(30, my_level()), 3);
        description.listAppend("Will gain " + meat_gained + " meat.");
        if (availableDrunkenness() >= 0)
        {
            if (my_level() < 8)
                description.listAppend("Wait until you've leveled up more.");
            else if (my_level() < 13)
                description.listAppend("Possibly wait until you've leveled up more?");
        }
        resource_entries.listAppend(ChecklistEntryMake(354, "__item spinning wheel", "campground.php?action=workshed", ChecklistSubentryMake("Spinning wheel meat", "", description), importance_level_unimportant_item));
    }
    
    if ($item[very overdue library book].available_amount() > 0 && in_run && __misc_state["need to level"] && $item[very overdue library book].item_is_usable())
    {
        resource_entries.listAppend(ChecklistEntryMake(355, "__item very overdue library book", "inventory.php?which=3&ftext=very+overdue+library+book", ChecklistSubentryMake("Very overdue library book", "", "Open for 63 moxie/mysticality/muscle."), importance_level_unimportant_item));
    }
    
    if ($item[chest of the Bonerdagon].available_amount() > 0 && in_run)
    {
        string description = "Open for 150 muscle/mysticality/moxie and 3k meat.";
        if (!$familiar[ninja pirate zombie robot].have_familiar())
            description += "|Unless you want to make an NPZR this ascension.";
        resource_entries.listAppend(ChecklistEntryMake(356, "__item chest of the Bonerdagon", "inventory.php?which=3&ftext=chest+of+the+Bonerdagon", ChecklistSubentryMake("chest of the Bonerdagon", "", description), importance_level_unimportant_item));
    }
    
    if ($item[smoke grenade].available_amount() > 0 && in_run)
    {
        string description = "Turn-costing banish. (lasts 20 turns, no stats, no items, no meat)";
        resource_entries.listAppend(ChecklistEntryMake(357, "__item smoke grenade", "", ChecklistSubentryMake(pluralise($item[Smoke grenade]), "", description), importance_level_unimportant_item).ChecklistEntryTag("banish"));
    }
    
    if ($item[pile of ashes].available_amount() > 0 && in_run)
    {
        string description = "-10% combat. (20 turns)";
        resource_entries.listAppend(ChecklistEntryMake(358, "__item pile of ashes", "inventory.php?which=3&ftext=pile+of+ashes", ChecklistSubentryMake(pluralise($item[pile of ashes]), "", description), importance_level_unimportant_item));
    }
    if (to_item("7259").available_amount() > 0 && in_run)
    {
        string description = "Open for elemental damage combat items.";
        resource_entries.listAppend(ChecklistEntryMake(359, "__item " + to_item("7259"), "inventory.php?which=3&ftext=" + to_item("7259").replace_string(" ", "+"), ChecklistSubentryMake(pluralise(to_item("7259")), "", description), importance_level_unimportant_item));
    }
    
    if ($item[gym membership card].available_amount() > 0 && in_run && __misc_state["need to level"])
    {
        int importance = importance_level_item;
        string description = "Gives 30 muscle/mysticality/moxie stats.|Once per day.";
        if (my_level() < 4)
        {
            description += "|Not usable until level 4.";
            importance = importance_level_unimportant_item;
        }
        resource_entries.listAppend(ChecklistEntryMake(360, "__item gym membership card", "inventory.php?which=3&ftext=gym+membership+card", ChecklistSubentryMake(pluralise($item[gym membership card]), "", description), importance_level_item));
    }
    
    if (!get_property_boolean("_warbearGyrocopterUsed"))
    {
        if ($item[warbear gyrocopter].available_amount() > 0)
        {
            string [int] description;
            description.listAppend("Usable once/day for a gyro. Only breaks a quarter of the time.");
            if (!in_ronin())
                description.listAppend("Could always send it to yourself.");
            resource_entries.listAppend(ChecklistEntryMake(361, "__item warbear gyrocopter", "curse.php?whichitem=7038", ChecklistSubentryMake(pluralise($item[warbear gyrocopter]), "", description), importance_level_unimportant_item));
            
        }
        else if ($item[broken warbear gyrocopter].available_amount() > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(362, "__item broken warbear gyrocopter", "inventory.php?which=3&ftext=broken+warbear+gyrocopter", ChecklistSubentryMake(pluralise($item[broken warbear gyrocopter]), "", "Gyrocopters dream of the sky. Set one free!"), importance_level_unimportant_item));
            
        }
    }
    if ($item[burned government manual fragment].available_amount() > 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(363, "__item burned government manual fragment", "inventory.php?which=3&ftext=burned+government+manual+fragment", ChecklistSubentryMake(pluralise($item[burned government manual fragment]), "", "Foreign language study.|Will disappear on ascension."), importance_level_unimportant_item));
    }
    if ($item[lynyrd snare].available_amount() > 0 && get_property_int("_lynyrdSnareUses") < 3 && my_path_id() != PATH_G_LOVER && $item[lynyrd snare].historical_price() < 5000)// && in_run && __misc_state["need to level"])
    {
        int uses_remaining = MIN($item[lynyrd snare].available_amount(), clampi(3 - get_property_int("_lynyrdSnareUses"), 0, 3));
        resource_entries.listAppend(ChecklistEntryMake(364, "__monster lynyrd", "inventory.php?which=3&ftext=lynyrd+snare", ChecklistSubentryMake(pluralise(uses_remaining,$item[lynyrd snare]), "", "Free fight when used."), importance_level_unimportant_item).ChecklistEntryTag("daily free fight"));
    }
    if (in_run && $item[red box].available_amount() > 0 && my_path_id() != PATH_G_LOVER)
    {
        resource_entries.listAppend(ChecklistEntryMake(365, "__item red box", "inventory.php?which=3&ftext=red+box", ChecklistSubentryMake(pluralise($item[red box]), "", "Open for stuff."), importance_level_unimportant_item));
    }
    
    if (in_run && $item[llama lama gong].available_amount() > 0)
    {
        //fiddle fiddle fiddle
        //I'm not sure anyone should actually do this, so fiddly!
        boolean need_pickpocket = true;
        if (my_primestat() == $stat[moxie])
            need_pickpocket = false;
            
        string [int] description;
        string [int] birdform_description;
        
        //options:
        
        string [int] possible_pickpocket_locations;
        
        if (need_pickpocket)
        {
            //bird form for pickpocket in crypt, filthworms, golems
            
            if (__quest_state["Level 7"].state_boolean["nook needs speed tricks"])
                possible_pickpocket_locations.listAppend("Cyrpt Nook");
            if (!__quest_state["Level 12"].state_boolean["Orchard Finished"])
                possible_pickpocket_locations.listAppend("filthworms");
                
            if (possible_pickpocket_locations.count() == 0)
                birdform_description.listAppend("Gives pickpocketing ability.");
            else
                birdform_description.listAppend("Gives pickpocketing ability for stealing from the " + possible_pickpocket_locations.listJoinComponents(", ", "and") + ".");
        }
        
        string [element][int] element_options;
        
        foreach e in $elements[]
            element_options[e] = listMakeBlankString();
        if (!__quest_state["Level 6"].finished)
            element_options[$element[hot]].listAppend("friars quest");
        
        if (__quest_state["Level 9"].state_float["oil peak pressure"] > 0.0)
            element_options[$element[sleaze]].listAppend("oil peak");
            
        if (!__quest_state["Level 12"].finished && __quest_state["Level 12"].state_string["Side seemingly fighting for"] == "hippy")
            element_options[$element[sleaze]].listAppend("frat boys");
            
        
        if (!__quest_state["Level 7"].finished)
            element_options[$element[spooky]].listAppend("cyrpt");
        
        
        if (!__quest_state["Level 12"].state_boolean["War started"])
            element_options[$element[stench]].listAppend("starting war against hippies");
        if (!__quest_state["Level 12"].state_boolean["Orchard Finished"])
            element_options[$element[stench]].listAppend("filthworms");
        
        if (__quest_state["Level 11 Manor"].mafia_internal_step < 2)
            element_options[$element[spooky]].listAppend("spookyraven ballroom");
        if (get_property("questM20Necklace") != "finished" && $item[Lady Spookyraven's powder puff].available_amount() == 0)
            element_options[$element[spooky]].listAppend("spookyraven bathroom");
            
            
            
        string [element] element_to_potion;
        
        if (__misc_state["need to level"])
            element_to_potion[$element[hot]] = "+6 stats/fight";
        element_to_potion[$element[sleaze]] = "+20 ML";
        element_to_potion[$element[spooky]] = "+60% item";
        
        if (!__quest_state["Level 12"].state_boolean["Nuns Finished"] && $item[glimmering raven feather].available_amount() == 0 && $effect[Melancholy Burden].have_effect() == 0)
            element_to_potion[$element[stench]] = "+60% meat";
        
        
        //string [int][int] monster_fight_table;
        //monster_fight_table.listAppend(listMake(HTMLGenerateSpanOfClass("Monster element", "r_bold"), HTMLGenerateSpanOfClass("Areas", "r_bold"), HTMLGenerateSpanOfClass("Gives potion", "r_bold")));
        foreach e in element_options
        {
            if (element_options[e].count() == 0)
                continue;
            if (!(element_to_potion contains e))
                continue;
                
            //monster_fight_table.listAppend(listMake(e.to_string(), element_options[e].listJoinComponents("<br>"), element_to_potion[e]));
            birdform_description.listAppend("Fight " + e + " monsters (" + element_options[e].listJoinComponents(", ", "and") + ") for " + element_to_potion[e] + " spleen potion.");
        }
        
        //if (monster_fight_table.count() > 1)
            //birdform_description.listAppend(HTMLGenerateSimpleTableLines(monster_fight_table));
        
        //against hot (friars) for +6 stats/fight potion
        //against sleaze (oil peak) for +ML potion
        //against spooky (cyrpt, spookyraven ballroom/bathroom) for +60% items from monsters potion
        //against stench (filthworms, starting war against hippy) for +60% meat potion
        
        //cast boner battalion to handle birdform?
        //can only cast vicious talon slash/All-You-Can-Beat Wing Buffet 14 times, 15 leads to the feather you don't want (property birdformRoc maybe?)
        
        //FIXME implement birdform reminders? (like AVOID CASTING X)
        
        if (my_maxmp() >= 200 && $skill[Summon &quot;Boner Battalion&quot;].skill_is_usable() && !get_property_boolean("_bonersSummoned"))
            description.listAppend("Possibly cast the battalion to handle birdform."); //yojimbos_law wants this here, so..
        
        if (birdform_description.count() > 0)
            description.listAppend(HTMLGenerateSpanOfClass("Birdform", "r_bold") + "|*" + birdform_description.listJoinComponents("|*<hr>"));
        
        resource_entries.listAppend(ChecklistEntryMake(366, "__item llama lama gong", "inventory.php?which=3&ftext=llama+lama+gong", ChecklistSubentryMake(pluralise($item[llama lama gong]), "", description), importance_level_item));
        
    }
    
    if (!in_run && get_property("_bittycar").length() == 0 && $items[BittyCar HotCar, BittyCar MeatCar,BittyCar SoulCar].available_amount() > 0)
    {
        string [int] available_items;
        string [int] available_descriptions;
        string [item] item_descriptions;
        item_descriptions[$item[BittyCar HotCar]] = "hot damage";
        item_descriptions[$item[BittyCar MeatCar]] = "extra meat";
        item_descriptions[$item[BittyCar SoulCar]] = "HP/MP";
        
        
        foreach it in $items[BittyCar MeatCar,BittyCar SoulCar,BittyCar HotCar]
        {
            if (it.available_amount() > 0)
            {
                available_items.listAppend(it.to_string().replace_string("BittyCar ", ""));
                available_descriptions.listAppend(item_descriptions[it]);
            }
        }
        string description = "Reusable once/day for occasional " + available_descriptions.listJoinComponents(", ", "or") + " in combat.";
        resource_entries.listAppend(ChecklistEntryMake(367, "__item BittyCar MeatCar", "inventory.php?which=3&ftext=bittycar", ChecklistSubentryMake("BittyCar " + available_items.listJoinComponents(", ", "or") + " usable", "", description), importance_level_unimportant_item).ChecklistEntrySetAbridgedHeader("BittyCar usable"));
    }
    
    if (in_run && !__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "mysticality" && !get_property_ascension("lastGoofballBuy") && __quest_state["Level 3"].started)
    {
        resource_entries.listAppend(ChecklistEntryMake(368, "__item bottle of goofballs", "tavern.php?place=susguy", ChecklistSubentryMake("Bottle of goofballs obtainable", "", "For the lair stat test.|Costs nothing, but be careful..."), importance_level_unimportant_item));
    }
    
    if ($item[tonic djinn].available_amount() > 0 && in_ronin() && in_run && !get_property_boolean("_tonicDjinn") && my_path_id() != PATH_G_LOVER)
    {
        string [int] possibilities;
        possibilities.listAppend("~450 meat (Wealth!)");
        if (__misc_state["need to level"])
        {
            string mainstat_choice;
            if (my_primestat() == $stat[muscle])
                mainstat_choice = "Strength!";
            else if (my_primestat() == $stat[mysticality])
                mainstat_choice = "Wisdom!";
            else if (my_primestat() == $stat[moxie])
                mainstat_choice = "Panache!";
            
            if (mainstat_choice.length() != 0)
                possibilities.listAppend("~60 mainstats (" + mainstat_choice + ")");
        }
        
        string [int] description;
        description.listAppend("Use for " + possibilities.listJoinComponents(", ", "or"));
        
        resource_entries.listAppend(ChecklistEntryMake(369, "__item tonic djinn", "inventory.php?which=3&ftext=tonic+djinn", ChecklistSubentryMake("Tonic djinn", "", description), importance_level_unimportant_item));
    }
    
    if ($item[V for Vivala mask].have() && $item[V for Vivala mask].is_unrestricted() && !get_property_boolean("_vmaskBanisherUsed"))
    {
        string url;
        string [int] description;
        if (__misc_state["free runs usable"])
            description.listAppend("Once/day free run/banisher. (combat skill)");
        else
            description.listAppend("Once/day banisher. (combat skill)");
        
        if ($item[V for Vivala mask].equipped_amount() == 0)
        {
            description.listAppend("Equip V for Vivala mask first.");
        }
        url = generateEquipmentLink($item[v for vivala mask]);
        string line = "Costs ";
        if (my_mp() < 30)
            line += HTMLGenerateSpanFont("30 MP", "red");
        else
            line += "30 MP";
        line += ".";
        description.listAppend(line);
        
        boolean skip = false;
        if (my_path_id() == PATH_ZOMBIE_SLAYER) //probably a lot of paths?
        	skip = true;
        
        if (!skip)
	        resource_entries.listAppend(ChecklistEntryMake(370, "__item V for Vivala mask", url, ChecklistSubentryMake("Creepy Grin usable", "", description), importance_level_item).ChecklistEntryTag("free banish"));
    }
    
    if ($item[moveable feast].available_amount() > 0 && $item[moveable feast].is_unrestricted() && get_property_int("_feastUsed") < 5)
    {
        string [int] description;
        string url = generateEquipmentLink($item[moveable feast]); //&ftext=moveable+feast
        int feastings_left = clampi(5 - get_property_int("_feastUsed"), 0, 5);
        
        description.listAppend("Gives +10 familiar weight for twenty turns to a specific familiar.");
        string [int] familiars_used_on = get_property("_feastedFamiliars").split_string_alternate(";"); //separator: ";"
        if (in_run && __misc_state["free runs usable"])
        {
            string [int] familiars_could_imbue_for_del_shannon;
            boolean [familiar] familiars_used_on_inverse;
            foreach key, f_name in familiars_used_on
            {
                familiar f = f_name.to_familiar();
                if (f != $familiar[none])
                    familiars_used_on_inverse[f] = true;
            }
            foreach f in $familiars[pair of stomping boots,Frumious Bandersnatch]
            {
                if (f.familiar_is_usable() && !(familiars_used_on_inverse contains f))
                {
                    familiars_could_imbue_for_del_shannon.listAppend(f);
                }
            }
            if (familiars_could_imbue_for_del_shannon.count() > 0)
            {
                description.listAppend("Could feed " + familiars_could_imbue_for_del_shannon.listJoinComponents(", ", "or") + " for +2 free runs.");
            }
        }
        
        if (familiars_used_on.count() > 0)
            description.listAppend("Already used on " + familiars_used_on.listJoinComponents(", ", "and") + ".");
        resource_entries.listAppend(ChecklistEntryMake(371, "__item moveable feast", url, ChecklistSubentryMake(pluralise(feastings_left, "moveable feasting", "moveable feastings"), "", description), importance_level_item));
        //_feastedFamiliars
    }
    
    if ($item[cosmic calorie].available_amount() > 0 && in_run)
    {
        string [int][int] table;
        table.listAppend(listMake("Cost", "Item", "Effect"));
        
        string [item] celestial_descriptions;
        celestial_descriptions[$item[celestial olive oil]] = "+1 all res";
        celestial_descriptions[$item[celestial carrot juice]] = "+30% item";
        celestial_descriptions[$item[celestial au jus]] = "+5% combat";
        celestial_descriptions[$item[celestial squid ink]] = "-5% combat";
        int [item] calories_required;
        calories_required[$item[celestial olive oil]] = 20;
        calories_required[$item[celestial carrot juice]] = 30;
        calories_required[$item[celestial au jus]] = 50;
        calories_required[$item[celestial squid ink]] = 60;
        foreach it in $items[celestial olive oil,celestial carrot juice,celestial au jus,celestial squid ink]
        {
            int amount = it.creatable_amount() + it.available_amount();
                
            string [int] line;
            line = listMake(calories_required[it], it, celestial_descriptions[it]);
            if (amount == 0)
            {
                foreach key, s in line
                {
                    line[key] = HTMLGenerateSpanFont(s, "grey");
                }
            }
            table.listAppend(line);
        }
        string [int] description;
        description.listAppend(HTMLGenerateSimpleTableLines(table));
        resource_entries.listAppend(ChecklistEntryMake(372, "__item cosmic calorie", "inventory.php?which=3", ChecklistSubentryMake(pluralise($item[cosmic calorie]), "", description), importance_level_item));
        
    }
    
    if ($item[portable cassette player].available_amount() > 0 && (__misc_state["in run"] || $item[portable cassette player].equipped_amount() > 0) && $item[portable cassette player].is_unrestricted())
    {
        string [int] description;
        string url = "";
        int modulus = total_turns_played() % 40;
        
        string [effect] buff_descriptions;
        buff_descriptions[$effect[Dark Orchestral Song]] = "+5 moxie";
        buff_descriptions[$effect[Pet Shop Song]] = "+10% init";
        buff_descriptions[$effect[Dangerous Zone Song]] = "+25% meat";
        buff_descriptions[$effect[Flashy Dance Song]] = "+10% item";
        
        effect [int] buffs_activate_at; //NOT a linear list
        buffs_activate_at[0] = $effect[Dark Orchestral Song];
        buffs_activate_at[10] = $effect[Pet Shop Song];
        buffs_activate_at[20] = $effect[Dangerous Zone Song];
        buffs_activate_at[30] = $effect[Flashy Dance Song];
        
        boolean [effect] buffs_to_display_for_future = $effects[Dangerous Zone Song,Flashy Dance Song];
        
        boolean [effect] buffs_to_not_bother_display_current_for = $effects[Dark Orchestral Song,Pet Shop Song]; //+10% init is like +1% chance of extra modern zmobies, which saves an extremely small fraction of a turn. ignore, because cognitive load + you might run better accessories instead, like +ML. plus, you have to use that weird fiddly technique because of +combat
        string [int] future_buffs;
        foreach mod_value, buff in buffs_activate_at
        {
            string buff_description = buff_descriptions[buff];
            if (modulus >= mod_value && modulus < mod_value + 10)
            {
                if (buffs_to_not_bother_display_current_for contains buff)
                {
                    continue;
                }
                int turns_remaining = 10 - modulus % 10;
                string line = buff_description;
                if (buff.have_effect() == 0)
                    line += " obtainable";
                else
                {
                    if (turns_remaining < buff.have_effect())
                    {
                        turns_remaining = buff.have_effect();
                        line += " active";
                    }
                }
                line += " for " + pluralise(turns_remaining, " more turn", " more turns");
                boolean have_other_song_active = false;
                effect other_song = $effect[none];
                foreach e in $effects[Dark Orchestral Song,Pet Shop Song,Dangerous Zone Song,Flashy Dance Song]
                {
                    if (e != buff && e.have_effect() > 0)
                    {
                        other_song = e;
                        have_other_song_active = true;
                    }
                }
                if (have_other_song_active)
                {
                    line += " after losing current";
                    if (!(buffs_to_not_bother_display_current_for contains other_song))
                        line += " " + buff_descriptions[other_song];
                    line += " song. (unequip cassette for a turn)";
                }
                else
                    line += ".";
                if (buff.have_effect() == 0 && !have_other_song_active && $item[portable cassette player].equipped_amount() == 0)
                    line += " (equip player)";
                description.listAppend(line);
                continue;
            }
            if (buffs_to_display_for_future contains buff)
            {
                int turns_until = mod_value - modulus;
                if (turns_until < 0)
                    turns_until += 40;
                future_buffs.listAppend(pluralise(turns_until, "more turn", "more turns") + " until " + buff_description);
            }
        }
        if (future_buffs.count() > 0)
            description.listAppend(future_buffs.listJoinComponents(", ").capitaliseFirstLetter() + ".");
        
        //description.listAppend("Modulus " + modulus + ".");
        resource_entries.listAppend(ChecklistEntryMake(373, "__item portable cassette player", url, ChecklistSubentryMake("Portable cassette player buffs", "", description), 10));
    }
    if (is_wearing_outfit("Hodgman's Regal Frippery"))
    {
        int underling_summons_remaining = clampi(5 - get_property_int("_hoboUnderlingSummons"), 0, 5);
        if (underling_summons_remaining > 0)
        {
            string [int] description;
            description.listAppend("Combat skill while wearing the frippery. For a single fight, adds +100% meat (joke) or +100% item (dance).");
            resource_entries.listAppend(ChecklistEntryMake(374, "__skill Summon hobo underling", "", ChecklistSubentryMake(pluralise(underling_summons_remaining, "hobo underling summon", "hobo underling summons"), "", description), -1));
        }
    }
    if ($item[license to chill].available_amount() > 0 && !get_property_boolean("_licenseToChillUsed"))
    {
        resource_entries.listAppend(ChecklistEntryMake(375, "__item License to Chill", "inventory.php?which=3&ftext=license+to+chill", ChecklistSubentryMake("License to Chill", "", "+5 adventures, extend effects by one turn, HP/MP restore, statgain."), 10));
        
    }
    if ($item[etched hourglass].available_amount() > 0 && !get_property_boolean("_etchedHourglassUsed"))
    {
        resource_entries.listAppend(ChecklistEntryMake(376, "__item etched hourglass", "inventory.php?which=3&ftext=etched+hourglass", ChecklistSubentryMake("Etched Hourglass", "", "+5 adventures."), 10));
        
    }
    if ($item[mafia middle finger ring].available_amount() > 0 && !get_property_boolean("_mafiaMiddleFingerRingUsed"))
    {
        resource_entries.listAppend(ChecklistEntryMake(377, "__item mafia middle finger ring",  generateEquipmentLink($item[mafia middle finger ring]), ChecklistSubentryMake("Mafia middle finger ring banish/free run", "", "Once/day, 60 turn duration." + ($item[mafia middle finger ring].equipped_amount() == 0 ? " Equip first." : "")), 10).ChecklistEntryTag("free banish")); //&ftext=mafia+middle+finger+ring
    	
    }
}

void SCouncilGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__misc_state["in run"])
        return;
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
        return;
	boolean council_probably_wants_to_speak_to_you = false;
	string [int] reasons;
    boolean [string] seen_quest_name;
	foreach quest_name in __quest_state
	{
		QuestState state = __quest_state[quest_name];
        if (state.quest_name == "Island War Quest" && my_path_id() == PATH_EXPLOSION) continue;
		if (state.startable && !state.in_progress && !state.finished && state.council_quest)
		{
            if (seen_quest_name[state.quest_name])
                continue;
            seen_quest_name[state.quest_name] = true;
			reasons.listAppend(state.quest_name);
			council_probably_wants_to_speak_to_you = true;
		}
	}
	if (!council_probably_wants_to_speak_to_you)
		return;
    
    string [int] description;
    
    description.listAppend("Start the " + reasons.listJoinComponents(", ", "and") + ".");
    
    if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues") && !have_outfit_components("Filthy Hippy Disguise") && __quest_state["Level 12"].startable && !__quest_state["Level 12"].in_progress && !__quest_state["Level 12"].finished && my_path_id() != PATH_EXPLOSIONS)
        description.listAppend(HTMLGenerateSpanFont("May want to wait", "red") + " until you've acquired a filthy hippy disguise for acquiring a war outfit?");
	if (my_path_id() == PATH_EXPLOSIONS)
		description.listAppend("You might need to visit your quest log afterwards, to update mafia's tracking.");
	task_entries.listAppend(ChecklistEntryMake(384, "council", "place.php?whichplace=town", ChecklistSubentryMake("Visit the Council of Loathing", "", description)));
}

static
{
    //NOTE: this array does not support non-tradeable, quest, or non-discardable items. It could, but then I'd have to filter those out later, and I'm not sure how fast get_related is.
    int [item][item] __inverse_pulverisation;
    
    void initialisePulverisations()
    {
        foreach smashing_item in $items[]
        {
            if (!smashing_item.tradeable || smashing_item.quest || !smashing_item.discardable)
                continue;
            if (smashing_item.to_slot() == $slot[none])
                continue;
            int [item] pulverisations = smashing_item.get_related("pulverize");
            if (pulverisations.count() == 0)
                continue;
            foreach smash_result, value in pulverisations
            {
                __inverse_pulverisation[smash_result][smashing_item] = value;
            }
        }
    }
    
    initialisePulverisations();
}

record SmashableItem
{
    item it;
    float products_found;
};

SmashableItem SmashableItemMake(item it, float products_found)
{
    SmashableItem result;
    result.it = it;
    result.products_found = products_found;
    return result;
}

void listAppend(SmashableItem [int] list, SmashableItem entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

        
void pulveriseAlterOutputList(string [int] output_list)
{
    //Alter lines so items aren't split up by word wrap:
    int number_seen = 0;
    foreach key in output_list
    {
        string line = output_list[key];
        
        if (number_seen < output_list.count() - 1) //comma needs to be part of the group
            line += ",";
        line = HTMLGenerateDivOfClass(line, "r_word_wrap_group");
        
        output_list[key] = line;
        number_seen += 1;
    }
}

string [int] pulveriseGenerateOutputListForProducts(boolean [item] products_wanted, boolean [item] blocklist)
{
    int [item] smashables_found;
    foreach product in products_wanted
    {
        foreach smashable in __inverse_pulverisation[product]
        {
            if (smashable.available_amount() == 0)
                continue;
            if (blocklist[smashable])
                continue;
            int value = __inverse_pulverisation[product][smashable];
            smashables_found[smashable] += value;
        }
    }
    
    
    SmashableItem [int] available_smashed_items;
    
    foreach smashable, product_count in smashables_found
    {
        float average_products_acquired = product_count.to_float() / 1000000.0;
        available_smashed_items.listAppend(SmashableItemMake(smashable, average_products_acquired));
    }

    sort available_smashed_items by -(value.products_found * value.it.available_amount());
    
    string [int] result;
    foreach key in available_smashed_items
    {
        SmashableItem smashable_item = available_smashed_items[key];
        string line;
        
        line = smashable_item.it;
        
        result.listAppend(line);
    }
    

    
    pulveriseAlterOutputList(result);
    return result;
}

void pulveriseAppendOutputListForProducts(string [int] description, string category, boolean [item] products_wanted, boolean [item] blocklist)
{
    string [int] output_list = pulveriseGenerateOutputListForProducts(products_wanted, blocklist);

    if (output_list.count() > 0)
    {
        description.listAppend(HTMLGenerateSpanOfClass(category.capitaliseFirstLetter() + ": ", "r_bold") + output_list.listJoinComponents(" ", "and") + ".");
    }
}

void SPulveriseGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$skill[pulverize].skill_is_usable())
        return;
    if (!in_ronin()) //list is far too long with your main inventory, and you can buy wads at this point
        return;
    
    
    /*
     Smashable item types:
     BRICKO brick
     candycaine powder
     chunk of depleted Grimacite
     cold cluster
     cold nuggets
     cold powder
     cold wad
     corrupted stardust
     effluvious emerald
     epic wad
     glacial sapphire
     handful of Smithereens
     hot cluster
     hot nuggets
     hot powder
     hot wad
     sea salt crystal
     sleaze cluster
     sleaze nuggets
     sleaze powder
     sleaze wad
     spooky cluster
     spooky nuggets
     spooky powder
     spooky wad
     steamy ruby
     stench cluster
     stench nuggets
     stench powder
     stench wad
     sugar shard
     tawdry amethyst
     twinkly nuggets
     twinkly powder
     twinkly wad
     ultimate wad
     unearthly onyx
     useless powder
     wad of Crovacite
     */
    
    
    boolean [item] blocklist;
    blocklist.listAppendList($items[fireman's helmet,fire axe,enchanted fire extinguisher,fire hose,rainbow pearl earring,rainbow pearl necklace,rainbow pearl ring,steaming evil,ring of detect boring doors,giant discarded torn-up glove,giant discarded plastic fork,giant discarded bottlecap,toy ray gun,toy space helmet,toy jet pack,MagiMechTech NanoMechaMech,astronaut pants,ancient hot dog wrapper,bram's choker]);
    
    if (!__quest_state["Level 12"].finished)
        blocklist.listAppendList($items[reinforced beaded headband,bullet-proof corduroys,round purple sunglasses,beer helmet,distressed denim pants,bejeweled pledge pin]);
    if (!__quest_state["Level 11 Hidden City"].state_boolean["Hospital finished"])
        blocklist.listAppendList($items[head mirror,surgical apron,bloodied surgical dungarees,surgical mask,half-size scalpel]);
    
    string [int] details;
    
    //not relevant for adventures anymore:
    /*if (availableSpleen() > 0 && my_path_id() != PATH_SLOW_AND_STEADY)
    {
        pulveriseAppendOutputListForProducts(details, "spleen wads", $items[cold wad,hot wad,sleaze wad,spooky wad,stench wad,twinkly wad], blocklist);
    }*/
    
    /*if (__misc_state["mysticality guild store available"] && $skill[Transcendental Noodlecraft].skill_is_usable() && $skill[The Way of Sauce].skill_is_usable()) //can make hi mein?
    {
        pulveriseAppendOutputListForProducts(details, "hi mein elemental nuggets", $items[cold nuggets,hot nuggets,sleaze nuggets,spooky nuggets,stench nuggets], blocklist);
    }*/
    
    
    pulveriseAppendOutputListForProducts(details, "handful of smithereens", $items[handful of smithereens], blocklist);
    
    //Elemental powder, for +1 resistances?
    //Elemental nuggets, for +3 tower test? (very marginal)
    
    if (details.count() > 0)
    {
        string title;
        title = "Pulverisable equipment";
        string url = "craft.php?mode=smith";
        if ($item[tenderizing hammer].available_amount() == 0)
        {
            url = "shop.php?whichshop=meatsmith";
            details.listAppend("Acquire a tenderizing hammer.");
        }
        resource_entries.listAppend(ChecklistEntryMake(387, "__skill pulverize", url, ChecklistSubentryMake(title, "", details), 10));
    }
}
void SAftercoreThingsToDoGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //To implement:
    //The Sea - rescuing mom, temple boss if they're missing anything, that one skater quest, whatever else is there
    //The suburbs of dis? Is this detectable?
    //Farming four shore inc. trip scrip for ascension.
    //Space elves.
    //telescope upgrades - telescopeUpgrades (needs basement level check)
    //dungeons? slime tube, hobopolis, dreadsylvania, library, items and skills and such
    //hobo codes? (no support)
    //demon names
    //el vibrato island - familiar, mostly, plus items? (bad moon check)
    //agua de vida memories quest?
    //artist quest?
    //going postal quest
    //bounty hunting
    //starting SBB quests / UMD in inventory to use
    //examine http://kol.coldfront.net/thekolwiki/index.php/Quest_Spoilers
    //jung jar items
    //dwarven factory
    
    Record AftercoreOption
    {
        string header;
        string url;
        string [int] description;
    };
    AftercoreOption AftercoreOptionMake(string header, string url, string [int] description)
    {
        AftercoreOption task;
        task.header = header;
        task.url = url;
        task.description = description;
        return task;
    }
    void listAppend(AftercoreOption [int] list, AftercoreOption entry)
    {
        int position = list.count();
        while (list contains position)
            position += 1;
        list[position] = entry;
    }

    
    AftercoreOption [int] options;
    
    if (knoll_available() && !QuestState("questM03Bugbear").started)
    {
        options.listAppend(AftercoreOptionMake("Felonia quest", "place.php?whichplace=knoll_friendly", listMake("speak to Mayor Zapruder", "rewards once/ascension mushroom fermenting solution")));
    }
    
    if (!QuestState("questG04Nemesis").started)
    {
        string [int] things_gives;
        things_gives.listAppend("instant karma");
        if (my_class() == $class[disco bandit])
            things_gives.listAppend("rave skills");
        options.listAppend(AftercoreOptionMake("Nemesis quest", "guild.php", listMake("Rewards " + things_gives.listJoinComponents(", ", "and"))));
    }
    
    if (!QuestState("questF04Elves").started && $effect[transpondent].have_effect() == 0)
    {
        string url;
        string first_task;
        if ($item[transporter transponder].available_amount() > 0)
        {
            url = "inventory.php?which=3";
            first_task = "use transporter transponder";
        }
        else
        {
            url = "mall.php";
            first_task = "buy and use transporter transponder";
        }
        options.listAppend(AftercoreOptionMake("Repair the Elves' Shield Generator", url, listMake(first_task, "rewards 200 lunar isotopes, and space store access")));
    }
    
    
    if (false) //disabled for now - we don't have suggestions for every path, and this may be too much information to list? need to decide
    {
        //Grimstone:
        string [item] grimstone_paths;
        grimstone_paths[$item[silver cow creamer]] = "stepmother";
        grimstone_paths[$item[wolf whistle]] = "wolf";
        grimstone_paths[$item[witch's bra]] = "witch";
        if (get_campground()[$item[spinning wheel]] == 0)
            grimstone_paths[$item[spinning wheel]] = "gnome";
        grimstone_paths[$item[hare pin]] = "hare";
        
        string [int] relevant_grimstone_paths;
        item [int] relevant_rewards;
        foreach it in grimstone_paths
        {
            if (haveAtLeastXOfItemEverywhere(it, 1))
                continue;
            relevant_grimstone_paths.listAppend(grimstone_paths[it]);
            relevant_rewards.listAppend(it);
        }
        if (relevant_grimstone_paths.count() > 0)
        {
            string path_string = "path available";
            if (relevant_grimstone_paths.count() > 1)
                path_string = "paths available";
                
            options.listAppend(AftercoreOptionMake("grimstone mask quests", "", listMake(relevant_grimstone_paths.listJoinComponents(", ", "and") + " " + path_string, "Rewards " + relevant_rewards.listJoinComponents(", ", "or"))));
        }
    }
    
    if (get_property("merkinQuestPath") == "none" || get_property("merkinQuestPath").length() == 0)
    {
        //Do they need to complete that quest? Let's find out.
        item [class][int] class_temple_items;
        boolean [item] loathing_craftable_items = $items[belt of loathing,goggles of loathing,jeans of loathing,scepter of loathing,stick-knife of loathing,treads of loathing];
        class_temple_items[$class[seal clubber]] = listMake($item[Cold Stone of Hatred], $item[Ass-Stompers of Violence]);
        class_temple_items[$class[turtle tamer]] = listMake($item[Girdle of Hatred], $item[Brand of Violence]);
        class_temple_items[$class[pastamancer]] = listMake($item[Staff of Simmering Hatred], $item[Novelty Belt Buckle of Violence]);
        class_temple_items[$class[sauceror]] = listMake($item[Pantaloons of Hatred], $item[Lens of Violence]);
        class_temple_items[$class[disco bandit]] = listMake($item[Fuzzy Slippers of Hatred], $item[Pigsticker of Violence]);
        class_temple_items[$class[accordion thief]] = listMake($item[Lens of Hatred], $item[Jodhpurs of Violence]);
        
        //For our class, determine what items we're missing:
        item [int] our_class_items = class_temple_items[my_class()];
        int [item] total_amount_of_item_wanted;
        boolean [item] want_item_for_crafting_loathing;
        foreach key, it in our_class_items
        {
            total_amount_of_item_wanted[it] = 1;
        }
        foreach loathing_piece in loathing_craftable_items
        {
            if (haveAtLeastXOfItemEverywhere(loathing_piece, 1))
                continue;
            int [item] components = loathing_piece.get_ingredients_fast();
            foreach component in components
            {
                if (total_amount_of_item_wanted contains component) //if this component is part of our class components
                {
                    total_amount_of_item_wanted[component] += 1;
                    want_item_for_crafting_loathing[component] = true;
                }
            }
        }
        string [int] description_items;
        foreach it, amount in total_amount_of_item_wanted
        {
            int missing = amount - it.item_amount_almost_everywhere();
            if (missing <= 0)
                continue;
            string line = "a " + it;
            if (it.to_string().contains_text("Violence"))
                line += " (gladiator path)";
            else
                line += " (scholar path)";
            if (want_item_for_crafting_loathing[it])
            {
                line += " for loathing gear piece";
                if (missing >= 2)
                    line += "/to own";
            }
            description_items.listAppend(line);
        }
        if (description_items.count() > 0)
            options.listAppend(AftercoreOptionMake("mer-kin temple in the sea", "", listMake("can find " + description_items.listJoinComponents(", ", "or"))));
    }
    if (__misc_state["stench airport available"] && !get_property_ascension("lastWartDinseyDefeated"))
    {
        item dinsey_item;
        if (my_class() == $class[seal clubber])
            dinsey_item = $item[Dinsey's oculus];
        else if (my_class() == $class[turtle tamer])
            dinsey_item = $item[Dinsey's radar dish];
        else if (my_class() == $class[pastamancer])
            dinsey_item = $item[Dinsey's pizza cutter];
        else if (my_class() == $class[sauceror])
            dinsey_item = $item[Dinsey's brain];
        else if (my_class() == $class[disco bandit])
            dinsey_item = $item[Dinsey's pants];
        else if (my_class() == $class[accordion thief])
            dinsey_item = $item[Dinsey's glove];
        
        if (dinsey_item != $item[none] && !haveAtLeastXOfItemEverywhere(dinsey_item, 1))
        {
            location [item] keycards;
            
            keycards[$item[keycard &alpha;]] = $location[Barf Mountain];
            keycards[$item[keycard &beta;]] = $location[Pirates of the Garbage Barges];
            keycards[$item[keycard &gamma;]] = $location[The Toxic Teacups];
            keycards[$item[keycard &delta;]] = $location[Uncle Gator's Country Fun-Time Liquid Waste Sluice];
            location [int] missing_locations;
            item [int] missing_keycards;
            foreach it, l in keycards
            {
                if (it.available_amount() == 0)
                {
                    missing_keycards.listAppend(it);
                    missing_locations.listAppend(l);
                }
                    
            }
            if (missing_keycards.count() > 0)
            {
                options.listAppend(AftercoreOptionMake("defeat Wart Dinsey", "", listMake("Find keycards in " + missing_locations.listJoinComponents(", ", "and"))));
            }
        }
    }
    
    if (options.count() > 0)
    {
        string [int] description;
        string url = "";
        foreach key, option in options
        {
            option.header = option.header.capitaliseFirstLetter();
            foreach key in option.description
            {
                option.description[key] = option.description[key].capitaliseFirstLetter() + ".";
            }
            if (url.length() == 0)
                url = option.url;
            description.listAppend(option.header + HTMLGenerateIndentedText(option.description.listJoinComponents("<br>")));
        }
        optional_task_entries.listAppend(ChecklistEntryMake(288, "__effect confused", url, ChecklistSubentryMake("Try an optional quest", "", description), 8));
    }
}

void SAftercoreGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__misc_state["in aftercore"])
        return;
    //Campground items:
    int [item] campground_items = get_campground();
    
    if (campground_items[$item[clockwork maid]] == 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(289, "__item sprocket", "", ChecklistSubentryMake("Install a clockwork maid", "", listMake("+8 adventures/day.", "Buy from mall."))));
    }
    if (campground_items[$item[pagoda plans]] == 0 && $location[Pandamonium Slums].locationAvailable())
    {
        string url;
        string [int] details;
        details.listAppend("+3 adventures/day.");
        
        if ($item[hey deze nuts].item_amount() == 0)
        {
            if ($item[hey deze map].item_amount() == 0)
            {
                url = "pandamonium.php";
                details.listAppend("Adventure in Pandamonium Slums for Hey Deze Map. (25% superlikely)");
            }
            else
            {
                string [int] things_to_do;
                string [int] things_to_buy;
                if ($item[heavy metal sonata].item_amount() == 0)
                    things_to_buy.listAppend("heavy metal sonata");
                if ($item[heavy metal thunderrr guitarrr].item_amount() == 0)
                    things_to_buy.listAppend("heavy metal thunderrr guitarrr");
                if ($item[guitar pick].item_amount() == 0)
                    things_to_buy.listAppend("guitar pick");
                if (things_to_buy.count() > 0)
                    things_to_do.listAppend("buy " + things_to_buy.listJoinComponents(", ", "and") + " in mall, ");
                things_to_do.listAppend("use hey deze map");
				details.listAppend(things_to_do.listJoinComponents("", "then").capitaliseFirstLetter() + ".");
            }
        }
        if ($item[pagoda plans].item_amount() == 0)
        {
            if ($item[Elf Farm Raffle ticket].item_amount() == 0)
            {
                details.listAppend("Buy a Elf Farm Raffle ticket from the mall.");
            }
            else
            {
                if (url.length() == 0)
                    url = "inventory.php?which=3";
                if (in_bad_moon()) //Does bad moon aftercore require a clover?
                {
                    details.listAppend("Use Elf Farm Raffle ticket.");
                }
                else
                {
                    details.listAppend("Acquire ten-leaf clover, then use Elf Farm Raffle ticket.");
                }
            }
        }
        if ($item[ketchup hound].item_amount() == 0)
        {
            if (url.length() == 0)
                url = "mall.php";
            details.listAppend("Buy a ketchup hound from the mall.");
        }
        if ($item[ketchup hound].item_amount() > 0 && $item[hey deze nuts].item_amount() > 0 && $item[pagoda plans].item_amount() > 0)
        {
            if (url.length() == 0)
                url = "inventory.php?which=3";
            details.listAppend("Use a ketchup hound to install pagoda.");
        }
        optional_task_entries.listAppend(ChecklistEntryMake(290, "__item pagoda plans", url, ChecklistSubentryMake("Install a pagoda", "", details)));
    }
    
    if (knoll_available() && !have_mushroom_plot() && get_property("plantingScript") != "")
    {
        //They can plant a mushroom plot, and they have a planting script. But they haven't yet, so let's suggest it:
        optional_task_entries.listAppend(ChecklistEntryMake(291, "__item knob mushroom", "knoll_mushrooms.php", ChecklistSubentryMake("Plant a mushroom plot", "", "Degrassi Knoll")));
    }
    
    
    SAftercoreThingsToDoGenerateTasks(task_entries, optional_task_entries, future_task_entries);
}
void S8bitRealmGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	int total_white_pixels = $item[white pixel].available_amount() + $item[white pixel].creatable_amount();
        
	if (__quest_state["Level 13"].state_boolean["digital key used"] || (total_white_pixels >= 30 || $item[digital key].available_amount() > 0))
    {
        return;
    }
    boolean need_route_output = true;
    //Need white pixels for digital key.
    if (familiar_is_usable($familiar[angry jung man]) && $item[psychoanalytic jar].available_amount() == 0 && $item[jar of psychoses (The Crackpot Mystic)].available_amount() == 0 && !get_property_boolean("_psychoJarUsed"))
    {
        //They have a jung man, but haven't acquired a jar yet.
        ChecklistSubentry subentry;
    
        string url = "";
        if (my_familiar() != $familiar[angry jung man])
            url = "familiar.php";
        int jung_mans_charge_turns_remaining = 1 + (30 - MIN(30, get_property_int("jungCharge")));

        subentry.header = "Bring along the angry jung man";
    
        subentry.entries.listAppend(pluralise(jung_mans_charge_turns_remaining, "turn", "turns") + " until jar drops. (skip 8-bit realm)");
        if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
            subentry.entries.listAppend("Or wait for pixellated monsters.");
    
        optional_task_entries.listAppend(ChecklistEntryMake(268, "__familiar angry jung man", url, subentry));
        need_route_output = false;
    }
    if ($item[psychoanalytic jar].available_amount() > 0 || $item[jar of psychoses (The Crackpot Mystic)].available_amount() > 0 || get_property_boolean("_psychoJarUsed")) //FIXME check which jar used
    {
        string active_url = "";
        string title = "Adventure in fear man's level";
        //Have a jar, or jar was installed.
        string [int] description;
        string [int] modifiers;
        
        if (get_property_boolean("_psychoJarUsed"))
        {
            active_url = "place.php?whichplace=junggate_3";
            modifiers.listAppend("+150% item");
            modifiers.listAppend("olfact morbid skull");
            description.listAppend("Run +150% item, olfact morbid skull.");
            description.listAppend(total_white_pixels + "/30 white pixels found.");
            if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                description.listAppend("Or wait for pixellated monsters.");
        }
        else if ($item[jar of psychoses (The Crackpot Mystic)].available_amount() > 0)
        {
            active_url = "inventory.php?which=3";
            title = "Open the " + $item[jar of psychoses (The Crackpot Mystic)];
            description.listAppend("Fear Man's level access, for digital key.");
            if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                description.listAppend("Or wait for pixellated monsters.");
        }
        else if ($item[psychoanalytic jar].available_amount() > 0)
        {
            if (my_level() < 2) //no woods yet
                return;
            active_url = "place.php?whichplace=forestvillage&action=fv_mystic";
            title = "Psychoanalyze the crackpot mystic";
            description.listAppend("Fear Man's level access, for digital key.");
            if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                description.listAppend("Or wait for pixellated monsters.");
        }
        optional_task_entries.listAppend(ChecklistEntryMake(269, "__item digital key", active_url, ChecklistSubentryMake(title, modifiers, description), $locations[fear man's level]));
        need_route_output = false;
    }
    if (my_path_id() == PATH_EXPLOSIONS) need_route_output = false;
    if (need_route_output)
    {
        if (in_hardcore() || !$item[jar of psychoses (The Crackpot Mystic)].is_unrestricted())
        {
            string url = "place.php?whichplace=woods";
            string [int] description;
            string [int] modifiers;
            modifiers.listAppend("olfact bloopers");
            modifiers.listAppend("+100% item");
            
            description.listAppend("Run +100% item, olfact bloopers.");
            description.listAppend(total_white_pixels + "/30 white pixels found.");
            if (__misc_state["VIP available"] && __misc_state["fax equivalent accessible"])
                description.listAppend("Possibly consider faxing/copying a ghost. (+150% item, drops five white pixels)");
            if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                description.listAppend("Or wait for pixellated monsters.");
            if ($item[continuum transfunctioner].equipped_amount() == 0)
            {
                url = generateEquipmentLink($item[continuum transfunctioner]);
                description.listAppend("Equip the continuum transfunctioner.");
            }
            //No other choice. 8-bit realm.
            //Well, I suppose they could fax and arrow a ghost.
            if ($item[continuum transfunctioner].available_amount() > 0)
                optional_task_entries.listAppend(ChecklistEntryMake(270, "inexplicable door", url, ChecklistSubentryMake("Adventure in the 8-bit realm", modifiers, description), $locations[8-bit realm]));
            else if (my_level() >= 2)
                optional_task_entries.listAppend(ChecklistEntryMake(271, "__item continuum transfunctioner", "place.php?whichplace=forestvillage&action=fv_mystic", ChecklistSubentryMake("Acquire a continuum transfunctioner", "", "From the crackpot mystic.")));
        }
        else
        {
            //softcore, suggest pulling a jar of psychoses.
            string [int] description;
            description.listAppend("To make digital key.");
            if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                description.listAppend("Or wait for pixellated monsters.");
            optional_task_entries.listAppend(ChecklistEntryMake(272, "__item psychoanalytic jar", "", ChecklistSubentryMake("Pull a jar of psychoses (The Crackpot Mystic)", "", description)));
        }
    }
}

void S8bitRealmGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!(__quest_state["Level 13"].state_boolean["digital key used"] || $item[digital key].available_amount() > 0))
        return;
    if (!__misc_state["in run"] || !in_ronin())
        return;
    //This is mainly for one crazy random summer, where you have many pixels.
    //Blue pixel potion - [50,80] MP restore
    //monster bait - +5% combat
    //pixel sword - ? - +15% init
    //red pixel potion - [100,120] HP restore - the shadow knows
    //pixel whip - useful against vampires
    //pixel grappling hook would be useful, but it's unlikely anyone would defeat all four bosses in-run (resets upon ascension)
    string [item] craftables;
    int [item] max_craftables_wanted;
    craftables[$item[blue pixel potion]] = "~65 MP restore";
    craftables[$item[monster bait]] = "+5% combat";
    max_craftables_wanted[$item[monster bait]] = 1;
    //pixel sword?
    if (__quest_state["Level 13"].state_boolean["shadow will need to be defeated"])
        craftables[$item[red pixel potion]] = "~110 HP restore for shadow";
    if ($locations[dreadsylvanian castle,the spooky forest,The Haunted Sorority House,The Daily Dungeon] contains __last_adventure_location) //known vampire locations. it's perfectly reasonable to test against the sorority house, here in 2015
    {
        craftables[$item[pixel whip]] = "vampire killer";
        max_craftables_wanted[$item[pixel whip]] = 1;
    }
    
    max_craftables_wanted[$item[blue pixel potion]] = 11;
    max_craftables_wanted[$item[red pixel potion]] = 4; //4 minimum to out-shadow
    
    string [int] crafting_list_have;
    string [int] crafting_list_cannot;
    foreach it, reason in craftables
    {
        if (it.available_amount() >= MAX(1, max_craftables_wanted[it]))
            continue;
        string line = it;
        
        if (max_craftables_wanted[it] != 1 && it.creatable_amount() > 0)
            line = pluralise(it.creatable_amount(), it);
        line += ": " + reason;
        if (it.creatable_amount() == 0)
        {
            line = HTMLGenerateSpanFont(line, "grey");
            crafting_list_cannot.listAppend(line);
        }
        else
            crafting_list_have.listAppend(line);
    }
    if (crafting_list_have.count() > 0)
    {
        string [int] crafting_list = crafting_list_have;
        crafting_list.listAppendList(crafting_list_cannot);
        string pixels_have = "Pixel crafting";
        resource_entries.listAppend(ChecklistEntryMake(273, "__item white pixel", "shop.php?whichshop=mystic", ChecklistSubentryMake(pixels_have,  "", crafting_list), 10));
    }
}
void SDailyDungeonGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	
	if (__last_adventure_location == $location[The Daily Dungeon])
	{
		if ($item[ring of detect boring doors].equipped_amount() == 0 && $item[ring of detect boring doors].available_amount() > 0 && !get_property_boolean("dailyDungeonDone") && get_property_int("_lastDailyDungeonRoom") < 13)
		{
			task_entries.listAppend(ChecklistEntryMake(274, "__item ring of detect boring doors", generateEquipmentLink($item[ring of detect boring doors]), ChecklistSubentryMake("Wear ring of detect boring doors", "", "Speeds up daily dungeon"), -11));
		}
		if (familiar_is_usable($familiar[gelatinous cubeling]) && ($item[pick-o-matic lockpicks].available_amount() == 0 || $item[eleven-foot pole].available_amount() == 0 || $item[Ring of Detect Boring Doors].available_amount() == 0)) //have familiar, but not the drops
		{
			task_entries.listAppend(ChecklistEntryMake(275, "__familiar gelatinous cubeling", "", ChecklistSubentryMake("Use a gelatinous cubeling first.", "", "You're adventuring in the daily dungeon without cubeling drops."), -11));
		}
	}
	
	
	boolean need_to_do_daily_dungeon = false;
	
	if (__misc_state_int["fat loot tokens needed"] > 0)
		need_to_do_daily_dungeon = true;
	
	string [int] daily_dungeon_aftercore_items_wanted; 
	
	if (__misc_state["in aftercore"])
	{
		int tokens_needed = 0;
		if (!__misc_state["familiars temporarily missing"])
		{
			if (!have_familiar_replacement($familiar[gelatinous cubeling]) && $item[dried gelatinous cube].available_amount() == 0)
			{
				daily_dungeon_aftercore_items_wanted.listAppend("gelatinous cubeling");
				tokens_needed += 27;
			}
		}
		if (!__misc_state["skills temporarily missing"])
		{
			if (!$skill[singer's faithful ocelot].skill_is_usable() && $item[Spellbook: Singer's Faithful Ocelot].available_amount() == 0)
			{
				daily_dungeon_aftercore_items_wanted.listAppend("Singer's faithful ocelot");
				tokens_needed += 15;
			}
			if (!$skill[Drescher's Annoying Noise].skill_is_usable() && $item[Spellbook: Drescher's Annoying Noise].available_amount() == 0)
			{
				daily_dungeon_aftercore_items_wanted.listAppend("Drescher's Annoying Noise");
				tokens_needed += 15;
			}
			if (!$skill[Walberg's Dim Bulb].skill_is_usable() && $item[Spellbook: Walberg's Dim Bulb].available_amount() == 0)
			{
				daily_dungeon_aftercore_items_wanted.listAppend("Walberg's Dim Bulb");
				tokens_needed += 15;
			}
		}
		if (tokens_needed > $item[fat loot token].available_amount())
		{
			need_to_do_daily_dungeon = true;
			__misc_state_int["fat loot tokens needed"] += tokens_needed - $item[fat loot token].available_amount();
		}
	}
    //When we're down to two potential skeleton keys, mention they shouldn't use them in the door.
    int skeleton_key_amount = $item[skeleton key].available_amount() + $item[skeleton key].creatable_amount();
    boolean avoid_using_skeleton_key = ($item[Platinum Yendorian Express Card].available_amount() == 0 && $item[pick-o-matic lockpicks].available_amount() == 0 && (skeleton_key_amount) <= 2 && skeleton_key_amount > 0 && !__quest_state["Level 13"].state_boolean["Past keys"] && in_ronin());
	
	boolean delay_daily_dungeon = false;
	string delay_daily_dungeon_reason = "";
	if (need_to_do_daily_dungeon)
	{
		if (familiar_is_usable($familiar[gelatinous cubeling]))
		{
            item [int] missing_items;
            int priority = CHECKLIST_DEFAULT_IMPORTANCE;
            
            missing_items = $items[eleven-foot pole,ring of detect boring doors,pick-o-matic lockpicks].items_missing();
			if (missing_items.count() > 0)
			{
				delay_daily_dungeon = true;
				delay_daily_dungeon_reason = "Use your gelatinous cubeling in other areas, first.";
				ChecklistSubentry subentry;
			
                string url = "";
                if (my_familiar() != $familiar[gelatinous cubeling])
                    url = "familiar.php";
				subentry.header = "Bring along the gelatinous cubeling";
			
				subentry.entries.listAppend("Acquire " + missing_items.listJoinComponents(", ", "and") + " to speed up the daily dungeon.");
                
                if (missing_items.count() == 1 && missing_items[0] == $item[pick-o-matic lockpicks] && skeleton_key_amount > 1)
                {
                    subentry.entries.listAppend("Or ignore this and use the skeleton keys. (slightly risky)");
                    priority = 8;
                }
			
				optional_task_entries.listAppend(ChecklistEntryMake(276, "__familiar gelatinous cubeling", url, subentry, priority));
			}
		}
		else
		{
			//No gelatinous cubeling.
			//But! We can acquire a skeleton key in-run.
			//So suggest doing that:
			boolean can_make_skeleton_key = ($items[loose teeth,skeleton bone].items_missing().count() == 0);
			
			if (!avoid_using_skeleton_key && ($item[pick-o-matic lockpicks].available_amount() == 0 && $item[Platinum Yendorian Express Card].available_amount() == 0 && $item[skeleton key].available_amount() == 0 && (!__quest_state["Level 7"].state_boolean["nook finished"] || can_make_skeleton_key))) //they don't have lockpicks or a key, and they can reasonably acquire a key
			{
				delay_daily_dungeon = true;
				if (can_make_skeleton_key)
					delay_daily_dungeon_reason = "Make a skeleton key first. (you have the ingredients)";
				else
                {
					delay_daily_dungeon_reason = "Acquire a skeleton key first. (from defiled nook)";
                    if (!in_bad_moon() && my_path_id() != PATH_OXYGENARIAN) //FIXME state track this elsewhere
                        delay_daily_dungeon_reason += "|Unless you can't reach that by the end of today.";
                }
					
					
				if (can_make_skeleton_key)
				{
					ChecklistEntry cl = ChecklistEntryMake(277, "__item skeleton key", "", ChecklistSubentryMake("Make a skeleton key", "", listMake("You have the ingredients.", "Speeds up the daily dungeon.")));
                    if (__last_adventure_location == $location[The Daily Dungeon])
                    {
                        cl.importance_level = -11;
                        task_entries.listAppend(cl);
                    }
                    else
                        optional_task_entries.listAppend(cl);
				}
			}
		}
	}
    
    
    //Pop up a warning:
    if (__last_adventure_location == $location[the daily dungeon] && avoid_using_skeleton_key && $item[skeleton key].available_amount() > 0)
    {
        task_entries.listAppend(ChecklistEntryMake(278, "__item skeleton key", "", ChecklistSubentryMake("Avoid using the skeleton key in the daily dungeon", "", listMake("Running low, will need one for the tower.")), -11));
    }
    
    if (get_property_int("_lastDailyDungeonRoom") > 0)
        need_to_do_daily_dungeon = true;
	if (need_to_do_daily_dungeon && !get_property_boolean("dailyDungeonDone"))
	{
		if (delay_daily_dungeon)
		{
			future_task_entries.listAppend(ChecklistEntryMake(279, "daily dungeon", "da.php", ChecklistSubentryMake("Daily Dungeon", "", delay_daily_dungeon_reason), $locations[the daily dungeon]));
		}
		else
		{
            string url = "da.php";
			string [int] description;
			string l;
            
            if (__misc_state_int["fat loot tokens needed"] > 0)
                l = pluralise(__misc_state_int["fat loot tokens needed"], "token", "tokens") + " needed.";
			
			if (daily_dungeon_aftercore_items_wanted.count() > 0)
            {
                if (l != "")
                    l += "|";
                l += "Missing " + daily_dungeon_aftercore_items_wanted.listJoinComponents(", ", "and") + ". Possibly buy ";
                if (daily_dungeon_aftercore_items_wanted.count() > 1)
                    l += "them";
                else
                    l += "it";
                l += " in the mall?";
            }
            if (l != "")
                description.listAppend(l);
			if (!__misc_state["in aftercore"])
			{
				string submessage = "";
				if (familiar_is_usable($familiar[gelatinous cubeling]))
					submessage = "";
				if (__misc_state["zap wand available"] && __misc_state_int["DD Tokens and keys available"] > 0)
					submessage = "Or zap for it";
				if (submessage != "")
					description.listAppend(submessage);
			}
			
			if (!in_ronin() && !have_familiar_replacement($familiar[gelatinous cubeling]))
			{
				string [int] shopping_list;
				foreach it in $items[eleven-foot pole,ring of detect boring doors,pick-o-matic lockpicks]
				{
					if (it.available_amount() > 0)
						continue;
					if (it == $item[pick-o-matic lockpicks] && $item[skeleton key].available_amount() > 0)
						continue;
					shopping_list.listAppend(it);
				}
				if (shopping_list.count() > 0)
					description.listAppend("Buy " + shopping_list.listJoinComponents(", ", "and") + " from mall.");
			}
			
            int rooms_left = MAX(0, 15 - get_property_int("_lastDailyDungeonRoom"));
            boolean need_ring = true;
            if (get_property_int("_lastDailyDungeonRoom") > 10)
            {
                need_ring = false;
            }
			if ($item[ring of detect boring doors].available_amount() > 0 && need_ring)
			{
				if ($item[ring of detect boring doors].equipped_amount() == 0)
                {
                    url = generateEquipmentLink($item[ring of detect boring doors]);
					description.listAppend("Wear the ring of detect boring doors.");
                }
				else
					description.listAppend("Keep the ring of detect boring doors equipped.");
			}
            
			
            if (rooms_left < 15)
                description.listAppend(pluraliseWordy(rooms_left, "room", "rooms").capitaliseFirstLetter() + " left.");
            
            if (avoid_using_skeleton_key && $item[skeleton key].available_amount() > 0)
                description.listAppend(HTMLGenerateSpanOfClass("Avoid using your skeleton key, you don't have many left.", "r_bold"));
			
			optional_task_entries.listAppend(ChecklistEntryMake(280, "daily dungeon", url, ChecklistSubentryMake("Daily Dungeon", "", description), $locations[the daily dungeon]));
		}
	}
}

boolean [string] getHolidaysForDate(string realworld_date, int game_day)
{
    boolean [string] holidays;
    
    if (realworld_date == "0202")
        holidays["Groundhog Day"] = true;
    //april fools
    else if (realworld_date == "0401")
        holidays["April Fool's Day"] = true;
    //Talk Like a Pirate Day - september 19th
    else if (realworld_date == "0919")
        holidays["Talk Like a Pirate Day"] = true;
    else if (realworld_date == "1031")
        holidays["Halloween"] = true;
    else if (realworld_date == "0214")
        holidays["Valentine's Day"] = true;
    else if (realworld_date == "0525")
        holidays["Towel Day"] = true;
    else if (realworld_date == "0704")
        holidays["Dependence Day"] = true;
    
    //Crimbo
    if (now_to_string("M").to_int_silent() == 12)
        holidays["Crimbo"] = true;
        
    //Friday the 13th
    if (format_today_to_string("EEE d") == "Fri 13")
        holidays["Friday the 13th"] = true;
    
    
    
    //Festival of Jarlsberg - acquire the party hat? - Jarlsuary 1
    if (game_day == 0)
        holidays["Festival of Jarlsberg"] = true;
    //Valentine's Day! - Frankuary 4
    else if (game_day == 11)
        holidays["Valentine's Day"] = true;
    //St. Sneaky Pete's Day - Starch 3
    else if (game_day == 18)
        holidays["St. Sneaky Pete's Day"] = true;
    //Oyster Egg Day - April 2
    else if (game_day == 25)
        holidays["Oyster Egg Day"] = true;
    //El Dia de Los Muertos Borrachos? just wandering monsters... - Martinus 2
    else if (game_day == 33)
        holidays["El Dia de Los Muertos Borrachos"] = true;
    //Generic Summer Holiday - Bill 3
    else if (game_day == 42)
        holidays["Generic Summer Holiday"] = true;
    //Dependence Day - Bor 4
    else if (game_day == 51)
        holidays["Dependence Day"] = true;
    //Arrrbor Day - Petember 4
    else if (game_day == 59)
        holidays["Arrrbor Day"] = true;
    //Labr Day - Carlvember 6
    else if (game_day == 69)
        holidays["Labr Day"] = true;
    //Halloween / halloween tomorrow, save adventures? - Porktober 8
    else if (game_day == 79)
        holidays["Halloween"] = true;
    //feast of boris...? - Boozember 7
    else if (game_day == 86)
        holidays["Feast of Boris"] = true;
    //Yuletide? - Dougtember 4
    else if (game_day == 91)
        holidays["Yuletide"] = true;
        
    
    return holidays;
}

boolean [string] getHolidaysToday()
{
    boolean [string] holidays = getHolidaysForDate(format_today_to_string("MMdd"), gameday_to_int()); //FIXME Y10K error
    if (holiday() != "")
        holidays[holiday()] = true;
    return holidays;
}

boolean [string] getHolidaysTomorrow()
{
    //FIXME support next real-world day
    return getHolidaysForDate("", ((gameday_to_int() + 1) % 96));
}


                
location [int] generatePossibleLocationsToBurnDelay()
{
	location [int] possible_locations;
    foreach l in __place_delays
    {
        if (l == $location[the hidden park] && __dense_liana_machete_items.available_amount() > 0)
        {
            continue;
        }
        if (l == $location[the oasis]) continue;
        if (l.delayRemainingInLocation() > 0 && l.locationAvailable())
            possible_locations.listAppend(l);
    }
    return possible_locations;
}
void SCountersInit()
{
    CountersInit();
}

string [int] SCountersGenerateDescriptionForRainMonster()
{
    string [int] description;
    
    string last_terrain = __last_adventure_location.environment;
    
    string [int] waterbending_skills_can_cast;
    
    if ($effect[Personal Thundercloud].have_effect() == 0 && $skill[Thundercloud].skill_is_usable())
        waterbending_skills_can_cast.listAppend("Thundercloud");
    
    if ($effect[The Rain In Loathing].have_effect() == 0 && $skill[Rainy Day].skill_is_usable())
        waterbending_skills_can_cast.listAppend("Rainy Day");
    
    int water_level_modifier = numeric_modifier("water level");
    
    string [string][int] monster_for_terrain_depth;
    int [string] base_depth_for_terrain;
    
    foreach terrain in $strings[underground,indoor,outdoor]
    {
        monster_for_terrain_depth[terrain][1] = "giant isopod";
        monster_for_terrain_depth[terrain][2] = "gourmet gourami";
        monster_for_terrain_depth[terrain][3] = "freshwater bonefish";
        monster_for_terrain_depth[terrain][4] = "alley catfish";
        monster_for_terrain_depth[terrain][5] = "piranhadon";
    }
    base_depth_for_terrain["underground"] = 5;
    base_depth_for_terrain["indoor"] = 3;
    base_depth_for_terrain["outdoor"] = 1;
    monster_for_terrain_depth["underground"][6] = "giant tardigrade";
    monster_for_terrain_depth["indoor"][6] = "aquaconda";
    monster_for_terrain_depth["outdoor"][6] = "storm cow";
    
    string [string] monster_descriptions;
    monster_descriptions["giant isopod"] = "fishbone";
    monster_descriptions["freshwater bonefish"] = "2x fishbone";
    monster_descriptions["piranhadon"] = "3x fishbone";
    monster_descriptions["gourmet gourami"] = "+init potion";
    monster_descriptions["alley catfish"] = "-washaway potion";
    
    //init potion
    //-washaway potion
    //
    
    monster_descriptions["giant tardigrade"] = "thunder skill";
    monster_descriptions["aquaconda"] = "rain skill";
    monster_descriptions["storm cow"] = "lightning skill";
    
    if (__iotms_usable[$item[Little Geneticist DNA-Splicing Lab]] && !get_property_boolean("_dnaHybrid") && $effect[Human-Fish Hybrid].have_effect() == 0 && !__misc_state["familiars temporarily blocked"])
    {
        //FIXME all once spaded
        //NOT giant isopod
        //gourmet gourami?
        //freshwater bonefish
        //alley catfish
        //piranhadon
        foreach s in $strings[gourmet gourami,freshwater bonefish,alley catfish,piranhadon]
        {
            monster_descriptions[s] = monster_descriptions[s] + " (fish DNA)";
        }
    }
    
    
    if (my_mp() > 50)
    {
        monster_descriptions["storm cow"] += HTMLGenerateSpanFont(", burn MP to 50 to survive", "red");
    }
    
    boolean have_usable_last_terrain = (last_terrain == "outdoor" || last_terrain == "indoor" || last_terrain == "underground");
    foreach terrain in $strings[outdoor,indoor,underground]
    {
        int depth_min = base_depth_for_terrain[terrain] + water_level_modifier;
        int depth_max = depth_min + 1;
        
        depth_min = clampi(depth_min, 1, 6);
        depth_max = clampi(depth_max, 1, 6);
        
        string [int] terrain_monsters;
        string line = monster_for_terrain_depth[terrain][depth_min];
        //if (monster_descriptions contains line)
            //line += " (" + monster_descriptions[line] + ")";
        if (monster_descriptions contains line)
            line = monster_descriptions[line];
        if (last_terrain == terrain && (__last_adventure_location.recommended_stat < 40 || depth_min == depth_max))
            line = HTMLGenerateSpanOfClass(line, "r_bold");
        terrain_monsters.listAppend(line);
        
        if (depth_min != depth_max)
        {
            line = monster_for_terrain_depth[terrain][depth_max];
            //if (monster_descriptions contains line)
                //line += " (" + monster_descriptions[line] + ")";
            if (monster_descriptions contains line)
                line = monster_descriptions[line];
            if (last_terrain == terrain && __last_adventure_location.recommended_stat >= 40)
                line = HTMLGenerateSpanOfClass(line, "r_bold");
            terrain_monsters.listAppend(line);
        }
        
        line = terrain.capitaliseFirstLetter() + ": ";
        if (!have_usable_last_terrain || last_terrain == terrain)
            line = HTMLGenerateSpanOfClass(line, "r_bold");
        line += terrain_monsters.listJoinComponents(", ", "or");
        //if (last_terrain == terrain)
            //line = HTMLGenerateSpanOfClass(line, "r_bold");
        description.listAppend(line);
    }
    
    if (waterbending_skills_can_cast.count() > 0)
        description.listAppend("Can cast " + waterbending_skills_can_cast.listJoinComponents(", ", "and") + " for deeper water.");
    
    
    return description;
}

void SCountersGenerateEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task)
{
    string [string] window_image_names;
    window_image_names["Nemesis Assassin"] = "__familiar Penguin Goodfella"; //technically not always a penguin, but..
    window_image_names["Bee"] = "__effect Float Like a Butterfly, Smell Like a Bee"; //bzzz!
    window_image_names["Holiday Monster"] = "__familiar hand turkey";
    if (getHolidaysToday()["El Dia De Los Muertos Borrachos"])
        window_image_names["Holiday Monster"] = "__item corpse island iced tea";
    window_image_names["Rain Monster"] = "__familiar personal raincloud";
    window_image_names["WoL Monster"] = "__effect Cowrruption";
    window_image_names["Digitize Monster"] = "__item source essence";
    window_image_names["Romantic Monster"] = "__familiar " + __misc_state_string["obtuse angel name"];
    window_image_names["Enamorang Monster"] = "__item lov enamorang";
    window_image_names["portscan.edu"] = "__item gyroscope";
    //window_image_names["Event Monster"] = ""; //no idea
    
    
    
    boolean [string] counter_blocklist = $strings[Semi-rare]; //Romantic Monster,
    boolean [string] non_range_allowlist = $strings[Digitize Monster,Enamorang Monster,portscan.edu];
    
    string [int] all_counter_names = CounterGetAllNames(true);
    
    foreach key in all_counter_names
    {
        string window_name = all_counter_names[key];
        if (window_name == "")
            continue;
        if (counter_blocklist contains window_name)
            continue;
        
        Counter c = CounterLookup(window_name, ErrorMake(), true);
        if (!c.CounterIsRange() && !(non_range_allowlist contains window_name))
            continue;
        boolean counter_is_range = c.CounterIsRange();
        Vec2i turn_range = c.CounterGetWindowRange();
        int next_exact_turn = c.CounterGetNextExactTurn();
        
        if (counter_is_range && !(turn_range.x <= 10 && from_task) && !(turn_range.x > 10 && !from_task) && window_name != "Romantic Monster")
            continue;
        
        //print_html("c = " + c.to_json());
        boolean very_important = false;
        if (turn_range.x <= 0 && counter_is_range)
            very_important = true;
        if (!counter_is_range && next_exact_turn <= 3) //warn three turns ahead
            very_important = true;
        
        
        ChecklistSubentry subentry;
        string url;
        string window_display_name = window_name;
        
        monster fighting_monster;
        if (window_name == "Digitize Monster")
        {
            fighting_monster = get_property_monster("_sourceTerminalDigitizeMonster");
            string monster_name = fighting_monster.to_lower_case();
            if (monster_name == "")
                window_display_name = "Digitised monster";
            else
                window_display_name = "Digitised " + monster_name;
        }
        if (window_name == "Enamorang Monster")
        {
            fighting_monster = get_property_monster("enamorangMonster");
            string monster_name = fighting_monster.to_lower_case();
            if (monster_name == "")
                window_display_name = "Boomerang'd monster";
            else
                window_display_name = "Boomerang'd " + monster_name;
        }
        if (window_name == "Romantic Monster")
        {
            fighting_monster = get_property_monster("romanticTarget");
            window_display_name = "Arrowed " + __misc_state_string["Romantic Monster Name"].to_lower_case();
        }
        if (window_name == "Nemesis Assassin" && __quest_state["Nemesis"].mafia_internal_step >= 26)
        {
            //someone reported they saw this window after going past the relevant quest step; safety ignore
            continue;
        }
        if (window_name == "WoL Monster" && my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING)
        	continue;
        subentry.header = window_display_name;
        
        
        string short_description;
        if (!counter_is_range)
        {
            if (next_exact_turn <= 0)
            {
                subentry.header += HTMLGenerateSpanFont(" now", "red");
                short_description = "now";
            }
            else
            {
                subentry.header += " after " + pluralise(next_exact_turn, "More Turn", "more turns");
                short_description = next_exact_turn;
            }
        }
        else if (turn_range.y <= 0)
        {
            subentry.header += " now or soon";
            short_description = "now?";
        }
        else if (turn_range.x <= 0)
        {
            subentry.header += " between now and " + turn_range.y + " turns.";
            short_description = "0-" + turn_range.y;
        }
        else
        {
            subentry.header += " in [" + turn_range.x + " to " + turn_range.y + "] turns.";
            short_description = turn_range.x + "-" + turn_range.y;
        }
        
        
        if (window_name == "Digitize Monster")
        {
            //Display next window:
            int next_window_count = get_property_int("_sourceTerminalDigitizeMonsterCount") + 1;
            //Vec2i next_window_range = Vec2iMake(15 + 10 * next_window_count, 25 + 10 * next_window_count);
            int next_turn_count = next_window_count * 10 + 10;
            //subentry.entries.listAppend("Next window will be [" + next_window_range.x + " to " + next_window_range.y + "] turns.");
            subentry.entries.listAppend("Next gap will be " + next_turn_count + " turns.");
            
            //calculate the limit:
            boolean [string] chips = getInstalledSourceTerminalSingleChips();
            int digitisations = get_property_int("_sourceTerminalDigitizeUses");
            int digitisation_limit = 1;
            if (chips["TRAM"])
                digitisation_limit += 1;
            if (chips["TRIGRAM"])
                digitisation_limit += 1;
            int digitisations_left = clampi(digitisation_limit - digitisations, 0, 3);
            if (get_property_int("_sourceTerminalDigitizeMonsterCount") >= 2 && digitisations < digitisation_limit)
                subentry.entries.listAppend("Could re-digitise to reset the window.");
        }
        if (window_name == "Rain Monster" && my_path_id() == PATH_HEAVY_RAINS)
        {
            subentry.entries = SCountersGenerateDescriptionForRainMonster();
        }
        if (fighting_monster != $monster[none])
        {
            CopiedMonstersGenerateDescriptionForMonster(fighting_monster, subentry.entries, (turn_range.x <= 0), false);
        }
        if (c.waiting_for_adventure_php)
            subentry.entries.listAppend("Need to adventure in adventure.php to start counting.");
        
        if (turn_range.x <= 0) // && counter_is_range || (!counter_is_range && next_exact_turn <= 0))
        {
            if (my_path_id() != PATH_COMMUNITY_SERVICE && __misc_state["in run"])
            {
                if (window_name == "portscan.edu" && $skill[macrometeorite].skill_is_usable() && get_property_int("_macrometeoriteUses") < 10 && !__quest_state["Level 12"].finished && !__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
                {
                    subentry.entries.listAppend("Adventure in sonofa beach, macrometeorite the government agent to gain a LFM.");
                    url = $location[sonofa beach].getClickableURLForLocation();
                }
                location [int] possible_locations = generatePossibleLocationsToBurnDelay();
                if (possible_locations.count() > 0)
                {
                    subentry.entries.listAppend("Adventure in " + possible_locations.listJoinComponents(", ", "or") + " to burn delay.");
                    if (url == "")
                        url = possible_locations[0].getClickableURLForLocation();
                }
            }
            /*if (get_property_boolean("dailyDungeonDone"))
            {
                url = "da.php";
                subentry.entries.listAppend("Could check for free in the daily dungeon.");
            }
            else if (get_property_int("hiddenApartmentProgress") >= 1 && get_property_int("hiddenBowlingAlleyProgress") >= 1 && get_property_int("hiddenHospitalProgress") >= 1 && get_property_int("hiddenOfficeProgress") >= 1) //we could support suggesting each shrine individually, but effort
            {
                url = $location[the hidden park].getClickableURLForLocation();
                subentry.entries.listAppend("Could check for free in one of the shrines.");
            }*/
        }
        
        string image_name = "__item Pok&euml;mann figurine: Frank"; //default - some person
        if (window_image_names contains window_name)
            image_name = window_image_names[window_name];
        if (fighting_monster != $monster[none])
        	image_name = "__itemsize __monster " + fighting_monster;
        
        int importance = 10;
        if (very_important)
            importance = -11;
        ChecklistEntry entry = ChecklistEntryMake(378, image_name, url, subentry, importance).ChecklistEntrySetShortDescription(short_description);
        
        if (very_important)
            task_entries.listAppend(entry);
        else
            optional_task_entries.listAppend(entry);
        
    }
}

void SCountersGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (true)
    {
        //dance card:
        int turns_until_dance_card = CounterLookup("Dance Card").CounterGetNextExactTurn();
        
        if (turns_until_dance_card >= 0)
        {
            string stats = "Gives ~" + __misc_state_float["dance card average stats"].round() + " ";
            if (my_primestat() == $stat[moxie])
                stats += "mainstat";
            else
                stats += "moxie";
            stats += ".";
            if (turns_until_dance_card == 0)
            {
                task_entries.listAppend(ChecklistEntryMake(379, "__item dance card", $location[the haunted ballroom].getClickableURLForLocation(), ChecklistSubentryMake("Dance card up now.", "", "Adventure in haunted ballroom. " + stats), -11));
            }
            else
            {
                optional_task_entries.listAppend(ChecklistEntryMake(380, "__item dance card", "", ChecklistSubentryMake("Dance card up after " + pluralise(turns_until_dance_card, "adventure", "adventures") + ".", "", "Haunted ballroom. " + stats)));
            }
        }
    }
    
	SCountersGenerateEntry(task_entries, optional_task_entries, true);
}

void SCountersGenerateResource(ChecklistEntry [int] resource_entries)
{
	SCountersGenerateEntry(resource_entries, resource_entries, false);
}
Record BountyFileEntry
{
    string plural;
    string difficulty;
    string image;
    int amount_needed;
    monster bounty_monster;
};


location [int] locationsForMonster(monster m)
{
    //hacky, slow, sorry
    location [int] result;
    if (m == $monster[none])
        return result;
    foreach l in $locations[]
    {
        monster [int] location_monsters = l.get_monsters();
        foreach key in location_monsters
        {
            if (location_monsters[key] == m)
                result.listAppend(l);
        }
    }
    
    return result;
}

ChecklistSubentry SBHHGenerateHunt(string bounty_item_name, int amount_found, int amount_needed, monster target_monster, location [int] relevant_locations, StringHandle url)
{
    //FIXME update to use new bounty API once 16.3 is out for a sufficient time
    ChecklistSubentry subentry;
    
    subentry.header = "Bounty hunt for " + bounty_item_name.HTMLEscapeString();
    
    
    
    
    //Look up monster location:
    location [int] monster_locations = locationsForMonster(target_monster);
    
    relevant_locations.listAppendList(monster_locations);
    
    
    boolean [location] skippable_ncs_locations = $locations[the stately pleasure dome, the poop deck, the spooky forest,The Haunted Gallery,tower ruins,the castle in the clouds in the sky (top floor), the castle in the clouds in the sky (ground floor), the castle in the clouds in the sky (basement), mt. molehill, the jungles of ancient loathing];
    
    boolean [location] want_nc_locations = $locations[the penultimate fantasy airship];
    
    string turns_remaining_string = "";
    
    boolean need_plus_combat = false;
    int plus_combat_needed = 25;
    boolean need_minus_combat = false;
    
    
    location [int] target_locations;
    if (amount_needed != -1 && target_monster != $monster[none] && monster_locations.count() > 0)
    {
        float min_turns_remaining = 100000000.0;
        foreach key in monster_locations
        {
            location l = monster_locations[key];
            boolean noncombats_skippable = (skippable_ncs_locations contains l);
            boolean noncombats_wanted = (want_nc_locations contains l);
            float [monster] appearance_rates = l.appearance_rates_adjusted();
            int number_remaining = amount_needed - amount_found;
            
            
            if (number_remaining == 0)
            {
                if (url.s.length() == 0)
                    url.s = "place.php?whichplace=forestvillage";
                subentry.header = "Return to the bounty hunter hunter";
                return subentry;
            }
            string clickable_url = getClickableURLForLocation(l);
            if (clickable_url != "" && (url.s.length() == 0 || url.s == "place.php?whichplace=forestvillage")) //if it's that URL, then it's back to the BHH - we'd rather override that with a bounty
                url.s = clickable_url;
            
            float bounty_appearance_rate = appearance_rates[target_monster] / 100.0;
            if (noncombats_skippable)
            {
                //Recorrect for NC:
                float nc_rate = appearance_rates[$monster[none]] / 100.0;
                if (nc_rate != 1.0)
                    bounty_appearance_rate /= (1.0 - nc_rate);
            }
            else if (noncombats_wanted)
            {
                //Recorrect for NC:
                float nc_rate = appearance_rates[$monster[none]] / 100.0;
                bounty_appearance_rate += nc_rate;
            }
            
            
            if (bounty_appearance_rate != 0.0)
            {
                float turns_remaining = number_remaining.to_float() / bounty_appearance_rate;
                if (turns_remaining <= min_turns_remaining)
                {
                    if (turns_remaining != min_turns_remaining)
                        target_locations.listClear();
                    target_locations.listAppend(l);
                    
                    min_turns_remaining = turns_remaining;
                    turns_remaining_string = " ~" + pluralise(round(turns_remaining), "turn remains", "turns remain") + ".";
                }
            }
            int base_combat_rate = appearance_rates[$monster[none]];
            if (base_combat_rate != 0)
                base_combat_rate += combat_rate_modifier();
            base_combat_rate = MAX(0.0, base_combat_rate);
            
            if (noncombats_wanted && base_combat_rate != 0.0)
                need_minus_combat = true;
            else if (!noncombats_skippable && base_combat_rate != 0.0)
            {
                need_plus_combat = true;
                plus_combat_needed = base_combat_rate;
            }
        }
    }
    
    
    if (need_plus_combat)
        subentry.modifiers.listAppend("+" + plus_combat_needed + "% combat");
    if (need_minus_combat)
        subentry.modifiers.listAppend("-combat");
    
    if (target_monster != $monster[none])
    {
        string monster_text = target_monster;
        if (last_monster() == target_monster)
            monster_text = HTMLGenerateSpanOfClass(monster_text, "r_bold");
        subentry.entries.listAppend("From " + monster_text + " in " + target_locations.listJoinComponents(", ", "or") + ".");
        subentry.modifiers.listAppend("olfact " + target_monster);
        subentry.modifiers.listAppend("banish");
    }
    
    
    if (amount_needed == -1)
    {
        subentry.entries.listAppend(amount_found + " found." + turns_remaining_string);
    }
    else
    {
        int amount_remaining = amount_needed - amount_found;
        subentry.entries.listAppend(amount_remaining.int_to_wordy().capitaliseFirstLetter() + " left." + turns_remaining_string);
        //subentry.entries.listAppend(amount_found + " out of " + amount_needed + " found." + turns_remaining_string);
    }
    
    item [string] bounty_item_to_unlock;
    
    bounty_item_to_unlock["glittery skate key"] = $item[tiny bottle of absinthe];
    bounty_item_to_unlock["pile of country guano"] = $item[astral mushroom];
    if (!get_property_boolean("_psychoJarUsed"))
    {
        bounty_item_to_unlock["greasy string"] = $item[jar of psychoses (The Meatsmith)];
        bounty_item_to_unlock["pixellated ashes"] = $item[jar of psychoses (The Crackpot Mystic)];
        bounty_item_to_unlock["unlucky claw"] = $item[jar of psychoses (The Suspicious-Looking Guy)];
    }
    bounty_item_to_unlock["pop art banana peel"] = $item[llama lama gong];
    bounty_item_to_unlock["wig powder"] = $item[&quot;DRINK ME&quot; potion];
    bounty_item_to_unlock["grizzled stubble"] = $item[transporter transponder];
    bounty_item_to_unlock["hickory daiquiri"] = $item[devilish folio];
    
    if (bounty_item_to_unlock contains bounty_item_name)
        subentry.entries.listAppend("Accessed with " + bounty_item_to_unlock[bounty_item_name] + ".");
    
        
    if ((bounty_item_name == "half-empty bottle of eyedrops" || bounty_item_name == "broken plunger handle") && knoll_available())
    {
        url.s = "place.php?whichplace=forestvillage";
        subentry.entries.listClear();
        subentry.modifiers.listClear();
        subentry.entries.listAppend("Unable to complete this bounty under knoll sign.");
        subentry.header = "Cancel bounty hunt for " + bounty_item_name.HTMLEscapeString();
    }
    
    if (bounty_item_name == "greasy string")
        subentry.entries.listAppend("Run away from non-salaminders to complete this bounty in a day.");
    
    if (bounty_item_name == "burned-out arcanodiode")
    {
        if (monster_level_adjustment() < 20)
            subentry.entries.listAppend(HTMLGenerateSpanFont("Run +20 ML to find more MechaMechs.", "red"));
    }
    
    return subentry;
}

void SBountyHunterHunterGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //Preliminary support, this may break.
    //currentEasyBountyItem, currentHardBountyItem, currentSpecialBountyItem
    
    //FIXME add suggesting taking bounties if we can detect if they have a bounty available
    ChecklistSubentry [int] subentries;
    string [int] bounty_property_names = split_string_alternate("currentEasyBountyItem,currentHardBountyItem,currentSpecialBountyItem", ",");
    string [string] bounty_properties;
    boolean on_bounty = false;
    
    foreach key in bounty_property_names
    {
        string property_name = bounty_property_names[key];
        string property_value = get_property(property_name);
        if (property_value.length() == 0)
            continue;
        bounty_properties[property_name] = property_value;
        on_bounty = true;
    }
    
    StringHandle url_handle;
    
    
    if (!on_bounty)
        return;
    
    
    //Load bounty.txt, not sure how else to acquire this data:
    BountyFileEntry [string] bounty_file;
    file_to_map("bounty.txt", bounty_file);
    
    location [int] relevant_locations;
    foreach bounty_name in bounty_properties
    {
        string property_value = bounty_properties[bounty_name];
        
        //Parse:
        //Format is bounty_item:number_found
        string [int] split = split_string_alternate(property_value, ":");
        if (split.count() != 2)
            continue;
        string bounty_item_name = split[0];
        int amount_found = split[1].to_int_silent();
        
        if (bounty_item_name.length() == 0 || bounty_item_name == "null") //unknown
            bounty_item_name = "unknown";
        
        int amount_needed = -1;
        monster target_monster = $monster[none];
        
        if (bounty_file contains bounty_item_name)
        {
            BountyFileEntry file_entry = bounty_file[bounty_item_name];
            amount_needed = file_entry.amount_needed;
            target_monster = file_Entry.bounty_monster;
        }
        subentries.listAppend(SBHHGenerateHunt(bounty_item_name, amount_found, amount_needed, target_monster, relevant_locations, url_handle));
        
    }
    
    boolean [location] highlight_locations = listInvert(relevant_locations);
    if (subentries.count() > 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(227, "__item bounty-hunting helmet", url_handle.s, subentries, highlight_locations));
    }
}

void SOldLevel9GenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($location[The Valley of Rof L'm Fao].turnsAttemptedInLocation() == 0)
        return;
    //if (__misc_state["in run"])
        //return;
	QuestState state;
	QuestStateParseMafiaQuestProperty(state, "questM15Lol", false); //don't issue a quest log load for this, no information gained
    if (!state.in_progress)
        return;
        
    string url = "place.php?whichplace=mountains";
    
    string [int] description;
    
    if ($item[64735 scroll].item_amount() > 0)
    {
        description.listAppend("Use the 64735 scroll.");
        url = "inventory.php?which=3";
    }
    else
    {
        description.listAppend("Make the 64735 scroll using the rampaging adding machine.");
        
        item [int] components_testing;
        if ($item[64067 scroll].item_amount() == 0)
        {
            components_testing.listAppend($item[30669 scroll]);
            components_testing.listAppend($item[33398 scroll]);
        }
        if ($item[668 scroll].item_amount() == 0)
        {
            components_testing.listAppend($item[334 scroll]);
            components_testing.listAppend($item[334 scroll]);
        }
        string [int] components_needed;
        int [item] amount_used;
        foreach key in components_testing
        {
            item it = components_testing[key];
            if (it.item_amount() - amount_used[it] <= 0)
            {
                components_needed.listAppend(it.to_string());
            }
            else
                amount_used[it] += 1;
        }
        if (components_needed.count() > 0)
            description.listAppend("Need " + components_needed.listJoinComponents(", ", "and") + ".");
        
        //suggest faxing?
        if (__misc_state["fax equivalent accessible"])
            description.listAppend("Possibly fax the rampaging adding machine (with all scroll components) for one-turn quest.");
        description.listAppend("Find rampaging adding machine, feed it 334 + 334, 30669 + 33398, 64067 + 668.");
        description.listAppend("31337 scroll is 30669 + 668. (334 + 334)");
    }
    ChecklistSubentry [int] subentries;
    subentries.listAppend(ChecklistSubentryMake("A Quest, LOL", "", description));
    optional_task_entries.listAppend(ChecklistEntryMake(226, "__item 64735 scroll", url, subentries, 10, $locations[the valley of rof l'm fao]));
}

string [int] SFaxGeneratePotentialFaxes(boolean suggest_less_powerful_faxes, boolean [monster] blocked_monsters)
{
    string [int] potential_faxes;
    boolean can_arrow = false;
    if (get_property_int("_badlyRomanticArrows") == 0 && (familiar_is_usable($familiar[obtuse angel]) || familiar_is_usable($familiar[reanimated reanimator])))
        can_arrow = true;
    
    
    if (get_auto_attack() != 0)
    {
        potential_faxes.listAppend("Auto attack is on, disable it?");
    }
    
    if (__misc_state["in run"])
    {
        
        if (!familiar_is_usable($familiar[angry jung man]))
        {
            //Can't pull for jar of psychoses, no jung man...
            //It's time for a g-g-g-ghost! zoinks!
            if (!__quest_state["Level 13"].state_boolean["digital key used"] && ($item[digital key].available_amount() + creatable_amount($item[digital key])) == 0)
            {
                string line = "Ghost - only if you can copy it.";
                if (can_arrow)
                    line += " (arrow?)";
                line += "|*5 white pixels drop per ghost, speeds up digital key. Run +150% item.";
                potential_faxes.listAppend(line);
            }
        }
        //sleepy mariachi
        if (familiar_is_usable($familiar[fancypants scarecrow]) || familiar_is_usable($familiar[mad hatrack]))
        {
            if ($item[spangly mariachi pants].available_amount() == 0 && in_hardcore() && $item[li'l ninja costume].available_amount() == 0)
            {
                string fax = "";
                fax += ChecklistGenerateModifierSpan("yellow ray");
                
                if (familiar_is_usable($familiar[fancypants scarecrow]))
                {
                    fax += "Makes scarecrow into superfairy";
                    if (my_primestat() == $stat[moxie] && __misc_state["need to level"])
                    {
                        fax += " and +3 mainstat/turn hat";
                    }
                }
                else if (familiar_is_usable($familiar[mad hatrack]))
                    fax += "Makes hatrack into superfairy";
                fax += ".";
                
                fax = "sleepy mariachi" + HTMLGenerateIndentedText(fax);
                potential_faxes.listAppend(fax);
            }
        }
        
        //ninja snowman assassin (copy only)
        if (!__quest_state["Level 8"].state_boolean["Mountain climbed"] && !blocked_monsters[$monster[ninja snowman assassin]])
        {
            int equipment_missing_count = $items[ninja carabiner,ninja crampons,ninja rope].items_missing().count();
            if (equipment_missing_count > 0)
            {
                string fax = "";
                string modifier_text = "+150% init or more";
                if (equipment_missing_count == 3)
                    modifier_text += ", two copies";
                if (equipment_missing_count == 2)
                    modifier_text += ", one copy";
                fax += ChecklistGenerateModifierSpan(modifier_text);
                if (equipment_missing_count == 3)
                    fax += "Copy twice for recreational mountain climbing.<br>";
                else if (equipment_missing_count == 2)
                    fax += "Copy once for recreational mountain climbing.<br>";
                fax += generateNinjaSafetyGuide(false);
                if ($familiar[obtuse angel].familiar_is_usable() && $familiar[reanimated reanimator].familiar_is_usable())
                    fax += "<br>Make sure to copy with angel, not the reanimator.";
                
            
                fax = "ninja snowman assassin" + HTMLGenerateIndentedText(fax);
                potential_faxes.listAppend(fax);
            }
        }
        
        int missing_ore = MAX(0, 3 - __quest_state["Level 8"].state_string["ore needed"].to_item().available_amount());
        if (!__quest_state["Level 8"].state_boolean["Past mine"] && missing_ore > 0)// && !$skill[unaccompanied miner].skill_is_usable())
        {
            string fax = "";			
            fax += ChecklistGenerateModifierSpan("+150% item or ideally YR");
            fax += "Mining ores. Try to copy a few times.";
            if (__misc_state_string["obtuse angel name"] != "")
            {
                string arrow_text = " (arrow?)";
                if (get_property_int("_badlyRomanticArrows") > 0)
                    arrow_text = HTMLGenerateSpanFont(arrow_text, "gray");
                fax += arrow_text;
            }
        
            fax = "mountain man" + HTMLGenerateIndentedText(fax);
            potential_faxes.listAppend(fax);
        }
        
        
        if (!(__quest_state["Level 12"].finished || __quest_state["Level 12"].state_boolean["Lighthouse Finished"] || $item[barrel of gunpowder].available_amount() == 5))
        {
            string line = "Lobsterfrogman (lighthouse quest";
            if ($item[barrel of gunpowder].available_amount() < 4)
            {
                    line += "; copy";
                if (can_arrow)
                    line += "/arrow";
            }
            line += ")";
            potential_faxes.listAppend(line);
        }
        
        //orcish frat boy spy / war hippy
        if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues") && !__quest_state["Level 12"].finished)
            potential_faxes.listAppend("Bailey's Beetle (YR) / Hippy spy (30% drop) / Orcish frat boy spy (30% drop) - war outfit");
            
        //dirty thieving brigand...? 
        
        if (!__misc_state["can eat just about anything"]) //can't eat, can't fortune cookie
        {
            //Suggest kge, miner, baabaaburan:
            if (!dispensary_available() && !have_outfit_components("Knob Goblin Elite Guard Uniform"))
            {
                potential_faxes.listAppend("Knob Goblin Elite Guard Captain - ???");
            }
            if (!__quest_state["Level 8"].state_boolean["Past mine"] && !have_outfit_components("Mining Gear") && __misc_state["can equip just about any weapon"])
                potential_faxes.listAppend("7-Foot Dwarf Foreman - Mining gear for level 8 quest. Need YR or +234% items.");
            if (!locationAvailable($location[the hidden park]) && ($item[stone wool].available_amount()) < (2 - MIN(1, $item[the nostril of the serpent].available_amount())))
                potential_faxes.listAppend("Baa'baa'bu'ran - Stone wool for hidden city unlock. Need +100% items (or as much as you can get for extra wool)");
        }
        
        /*if (to_item("7301").available_amount() == 0 && get_property("questM20Necklace") != "finished" && $item[Lady Spookyraven's necklace].available_amount() == 0)
        {
            int effective_writing_desks_encountering = get_property_int("writingDesksDefeated");
            if (get_property_monster("romanticTarget") == $monster[writing desk])
                effective_writing_desks_encountering += get_property_int("_romanticFightsLeft");
            if (effective_writing_desks_encountering < 5)
            {
                string line = "Writing desk - <strong>only if you can copy it four times</strong>. Skips the manor's first floor if you fight five total.";
                
                if ($item[telegram from Lady Spookyraven].available_amount() > 0)
                    line += HTMLGenerateSpanFont("<br>Read the telegram from Lady Spookyraven first.", "red");
                potential_faxes.listAppend(line);
            }
        }*/
        
        if (!__misc_state["can reasonably reach -25% combat"] && in_hardcore() && $item[Bram's choker].available_amount() == 0 && combat_rate_modifier() > -25.0 && !(__quest_state["Level 13"].in_progress || (__quest_state["Level 13"].finished && my_path_id() != PATH_BUGBEAR_INVASION)))
        {
            string line = "Bram the Stoker - drops a -5% combat accessory.";
            if (my_basestat($stat[mysticality]) < 50)
                line += " (requires 50 myst)";
            potential_faxes.listAppend(line);
        }
        
        if (!in_hardcore() && $item[richard's star key].available_amount() + $item[richard's star key].creatable_amount() == 0 && !__quest_state["Level 13"].state_boolean["Richard's star key used"] && !($item[star].available_amount() >= 8 && $item[line].available_amount() >= 7))
        {
            string copy_type = "arrow";
            if (my_path_id() == PATH_HEAVY_RAINS) //arrows mean washaway in flooded areas
                copy_type = "copy";
            potential_faxes.listAppend("Skinflute - +234% item, fight 4 times (" + copy_type + ") to skip HITS with pulls.");
        }
        
        if (suggest_less_powerful_faxes)
        {
            //giant swarm of ghuol whelps
            if (__quest_state["Level 7"].state_boolean["cranny needs speed tricks"] && !blocked_monsters[$monster[giant swarm of ghuol whelps]])
            {
                string line = "Giant swarm of ghuol whelps - +ML - with a copy possibly";
                if (!__quest_state["Level 7"].started)
                {
                    line = HTMLGenerateSpanFont(line + " (wait until quest started)", "gray");
                }
                potential_faxes.listAppend(line);
            }
            //modern zmobie
            if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"] && !blocked_monsters[$monster[modern zmobie]])
            {
                string line = "Modern zmobie - with copies/arrows";
                if (!__quest_state["Level 7"].started)
                {
                    line = HTMLGenerateSpanFont(line + " (wait until quest started)", "gray");
                }
                
                potential_faxes.listAppend(line);
            }
            //gaudy pirate (use for insults!)
            /*if (!__quest_state["Level 11 Palindome"].finished && $item[talisman o' namsilat].available_amount() == 0 && $items[snakehead charrrm,gaudy key].available_amount() < 2 && $items[Copperhead Charm,Copperhead Charm (rampant)].available_amount() < 2 && my_path_id() != PATH_G_LOVER && __quest_state["Pirate Quest"].state_boolean["valid"])
            {
                string description = "Gaudy pirate - two fights for talisman o' nam. (copy once)";
                if ($items[snakehead charrrm,gaudy key].available_amount() == 1)
                    description = "Gaudy pirate - one fight for talisman o' nam.";
                if (__quest_state["Pirate Quest"].mafia_internal_step < 6 && __quest_state["Pirate Quest"].state_int["insult count"] < 8)
                {
                    string l = "Pirate insult them!";
                    if ($item[the big book of pirate insults].available_amount() == 0)
                        l += " (get the big book of pirate insults first)";
                    
                    description += HTMLGenerateIndentedText(l);
                }
                potential_faxes.listAppend(description);
            }*/
            
            //screambat for sonar replacement
            if ((3 - __quest_state["Level 4"].state_int["areas unlocked"]) > $item[sonar-in-a-biscuit].available_amount())
            {
                string description = "Screambat - unlocks a single bat lair area";
                if (!__quest_state["Level 4"].in_progress)
                    description = HTMLGenerateSpanFont(description, "gray");
                potential_faxes.listAppend(description);
            }
            //drunken half-orc hobo (smiths)
            if (in_hardcore() && $skill[summon smithsness].skill_is_usable() && $items[dirty hobo gloves,hand in glove].available_amount() == 0 && false) //umm... I don't think this matters anymore
            {
                string hobo_name = "Drunken half-orc hobo";
                if (my_ascensions() % 2 == 1)
                    hobo_name = "Hung-over half-orc hobo";
                potential_faxes.listAppend(hobo_name + " - run +234% item to make +ML smithness accessory.");
            }
            //nuns bandit for trickery
            /*if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
            {
                string description = "Dirty thieving brigand - nuns trick.";
                if (!__quest_state["Level 12"].state_boolean["War started"])
                    description = HTMLGenerateSpanFont(description, "gray");
                potential_faxes.listAppend(description);
            }*/
            //monstrous boiler
            if (__quest_state["Level 11 Manor"].mafia_internal_step < 4 && $item[wine bomb].available_amount() == 0)
            {
                string description = "Monstrous boiler - charge up unstable fulminate.";
                if ($item[unstable fulminate].available_amount() == 0)
                    description = HTMLGenerateSpanFont(description, "gray");
                potential_faxes.listAppend(description);
            }
            if (true) //not sure about this
            {
                //marginal stuff:
                //whitesnake, white lion
                if (in_hardcore() && $items[wet stunt nut stew,mega gem].available_amount() == 0 && !__quest_state["Level 11 Palindome"].finished)
                {
                    string [int] stew_source_monsters;
                    if ($item[bird rib].available_amount() == 0)
                    {
                        stew_source_monsters.listAppend("whitesnake");
                    }
                    if ($item[lion oil].available_amount() == 0)
                    {
                        stew_source_monsters.listAppend("white lion");
                    }
                    if (stew_source_monsters.count() > 0)
                    {
                        string description = stew_source_monsters.listJoinComponents("/").capitaliseFirstLetter() + " - run +300% item/food drops for wet stunt nut stew components. (marginal?)";
                        
                        potential_faxes.listAppend(description);
                    }
                }
            }
            //blur
            if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && $item[drum machine].available_amount() == 0 && !__quest_state["Level 11 Desert"].state_boolean["Wormridden"] && in_hardcore())
            {
                potential_faxes.listAppend("Blur - +234% item " + (item_drop_modifier() >= 234 ? "(have) " : "(don't have) ") + "for drum machine for possible desert exploration route.");
            }
            
            if (in_hardcore() && knoll_available() && __quest_state["Level 11 Hidden City"].state_boolean["need machete for liana"] && $item[forest tears].available_amount() == 0)
            {
                potential_faxes.listAppend("forest spirit - +234% item - forest tears can meatsmith into a muculent machete for dense liana" + (($familiar[intergnat].familiar_is_usable() && my_level() <= 11) ? " (or use intergnat summon)" : ""));
            }
            //green ops
            //baa'baa'bu'ran
            //grungy pirate - for guitar (need 400% item/YR)
            //harem girl
            
            //FIXME rest
            //f'c'le - cleanly pirate/curmudgeonly pirate/that other pirate (and insults)
            //KGE
            
            //dairy goat? mostly for early milk of magnesium (stunt runs)
            //possessed wine rack / cabinet
            //pygmy shaman / accountant - if you absolutely have to
            //barret / aerith for equipment
            //racecar bob to olfact
            
            //brainsweeper for chef-in-the-box / bartender-in-the-box?
            //gremlins?
            
            //FIXME handsome mariachi/etc?
        }
    }
    else
    {
        //aftercore:
        //potential_faxes.listAppend("Adventurer Echo - event chroner");
        potential_faxes.listAppend("Clod Hopper (YR/+item) - floaty sand");
        potential_faxes.listAppend("Swarm of fudgewasps - fudge");
    }
    
    return potential_faxes;
}

string [int] SFaxGeneratePotentialFaxes(boolean suggest_less_powerful_faxes)
{
    boolean [monster] blank;
    return SFaxGeneratePotentialFaxes(suggest_less_powerful_faxes, blank);
}

void SFaxGenerateEntry(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, boolean from_task)
{
    if (!__misc_state["in aftercore"] && !from_task)
        return;
    if (__misc_state["in aftercore"] && from_task)
        return;
    string url = "clan_viplounge.php?action=faxmachine";
    
    if (get_auto_attack() != 0)
    {
        url = "account.php?tab=combat";
    }
    
	if (__misc_state["fax available"] && $item[photocopied monster].available_amount() == 0)
        optional_task_entries.listAppend(ChecklistEntryMake(390, "fax machine", url, ChecklistSubentryMake("Fax", "", listJoinComponents(SFaxGeneratePotentialFaxes(true), "|<hr>"))));
    if ($skill[Rain Man].skill_is_usable() && my_rain() >= 50)
    {
        ChecklistEntry entry = ChecklistEntryMake(391, "__skill rain man", "skills.php", ChecklistSubentryMake("Rain man copy", "50 rain drops", listJoinComponents(SFaxGeneratePotentialFaxes(true), "<hr>")));
        
        if (my_rain() > 93)
        {
            entry.importance_level = -10;
            task_entries.listAppend(entry);
        }
        else
            optional_task_entries.listAppend(entry);
    }
}

void SFaxGenerateResource(ChecklistEntry [int] resource_entries)
{
	SFaxGenerateEntry(resource_entries, resource_entries, false);
}


void SFaxGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	SFaxGenerateEntry(task_entries, optional_task_entries, true);

}

void SDungeonsOfDoomGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //Let's see...
    //Normally, we assume the best path is to fax a quantum mechanic (in HC) or pull a large box (in SC)
    //However, that won't work for paths without a fax machine, or for people without a VIP key, or for people who desire to open the dungeons of doom regardless.
    //So, we suggest it in those cases.
    //We also want to work in aftercore - if they haven't unlocked the DOD yet and they've started, give suggestions.
    
    //lastPlusSignUnlock is set by the oracle, not reading the book.
    string title = "Dungeons of Doom";
    string image_name = "Dungeons of Doom";
    string [int] description;
    string [int] modifiers;
    string url = "da.php";
    
    boolean should_output = true;
    
    int turns_attempted = $location[The Enormous Greater-Than Sign].turnsAttemptedInLocation() + $location[the dungeons of doom].turnsAttemptedInLocation();
    
    if (my_basestat(my_primestat()) < 45) //not yet
        return;
    if (turns_attempted == 0) //no, they haven't started yet
        return;
    
    if (get_property_ascension("lastPlusSignUnlock"))
    {
        should_output = false;
        //Dungeons of doom unlocked.
        if ($item[plus sign].available_amount() > 0)
        {
            should_output = true;
            //Read plus sign:
            title = "Read plus sign";
            image_name = "__item plus sign";
            url = "inventory.php?which=3";
        }
    }
    else
    {
        boolean adventuring_in_sign = true;
        string [int] tasks;
        if (my_meat() < 1000)
            tasks.listAppend("acquire 1000 meat");
        if ($item[plus sign].available_amount() == 0)
            tasks.listAppend("acquire plus sign from non-combat");
        else if ($effect[Teleportitis].have_effect() == 0)
            tasks.listAppend("acquire teleportitis from non-combat or uppercase Q hitting you");
        else
        {
            adventuring_in_sign = false;
            tasks.listAppend("find the oracle, pay for major consultation");
        }
        
        title = "Unlock dungeons of doom";
        if (adventuring_in_sign)
        {
            modifiers.listAppend("-combat");
            description.listAppend("Run -combat in the enormous greater-than sign.");
            
        }
        description.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
    }
    
    if (should_output)
        optional_task_entries.listAppend(ChecklistEntryMake(282, image_name, url, ChecklistSubentryMake(title, modifiers, description), $locations[the enormous greater-than sign,the dungeons of doom]));
}
void SOlfactionGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!$skill[Transcendent Olfaction].skill_is_usable())
        return;
    if ($effect[On the trail].have_effect() == 0)
        return;
    if ($item[soft green echo eyedrop antidote].available_amount() == 0) //no removal method
        return;
    
    //Add in some basic reminders to remove olfaction if adventuring in certain areas.
    
    monster olfacted_monster = get_property_monster("olfactedMonster");
    if (olfacted_monster == $monster[none] || __last_adventure_location == $location[none])
        return;
    
    monster [location] location_wanted_monster;
    
    if (__misc_state["in run"])
    {
        if ($item[talisman o' namsilat].available_amount() == 0 && !__quest_state["Level 11 Palindome"].finished)
            location_wanted_monster[$location[belowdecks]] = $monster[gaudy pirate];
        if (!__quest_state["Level 8"].state_boolean["Past mine"])
            location_wanted_monster[$location[the goatlet]] = $monster[dairy goat];
        if (!__quest_state["Level 7"].state_boolean["niche finished"])
            location_wanted_monster[$location[the defiled niche]] = $monster[dirty old lihc];
        
        if (!__quest_state["Azazel"].finished)
        {
            location_wanted_monster[$location[infernal rackets backstage]] = $monster[serialbus];
            location_wanted_monster[$location[the laugh floor]] = $monster[CH Imp];
        }
        //Deliberately ignored - the quiet healer. (she's used to it) It's possible they may want to olfact the burly sidekick instead, and there's plenty of time in that area.
        
        if (!__quest_state["Level 11 Hidden City"].finished)
        {
            if (!__quest_state["Level 11 Hidden City"].state_boolean["Apartment finished"] && $effect[thrice-cursed].have_effect() == 0)
                location_wanted_monster[$location[the hidden apartment building]] = $monster[pygmy shaman];
                
            if (!__quest_state["Level 11 Hidden City"].state_boolean["Hospital finished"] && $items[surgical apron,bloodied surgical dungarees,surgical mask,head mirror,half-size scalpel].items_missing().count() > 0)
                location_wanted_monster[$location[the hidden hospital]] = $monster[pygmy witch surgeon];
                
                
            if (!__quest_state["Level 11 Hidden City"].state_boolean["Office finished"] && $item[McClusky file (page 5)].available_amount() == 0 && $item[McClusky file (complete)].available_amount() == 0)
                location_wanted_monster[$location[the hidden office building]] = $monster[pygmy witch accountant];
                
            if (!__quest_state["Level 11 Hidden City"].state_boolean["Bowling alley finished"])
                location_wanted_monster[$location[the hidden bowling alley]] = $monster[pygmy bowler];
        }
        if (!have_outfit_components("Knob Goblin Harem Girl Disguise"))
            location_wanted_monster[$location[cobb's knob harem]] = $monster[Knob Goblin Harem Girl];
        //if (in_hardcore())
            //location_wanted_monster[$location[The Dark Neck of the Woods]] = $monster[Hellion];
        if ($skill[summon smithsness].skill_is_usable() && $item[dirty hobo gloves].available_amount() == 0 && $item[hand in glove].available_amount() == 0 && __misc_state["need to level"])
        {
            location_wanted_monster[$location[The Sleazy Back Alley]] = $monster[drunken half-orc hobo];
            location_wanted_monster[$location[The Haunted Pantry]] = $monster[drunken half-orc hobo];
        }
        location_wanted_monster[$location[fear man's level]] = $monster[morbid skull];
        if ($item[digital key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["digital key used"] && $item[white pixel].available_amount() + $item[white pixel].creatable_amount() < 27)
            location_wanted_monster[$location[8-bit realm]] = $monster[Blooper];
        
        
        if (!__quest_state["Level 11 Pyramid"].finished && olfacted_monster != $monster[tomb servant])
            location_wanted_monster[$location[the middle chamber]] = $monster[tomb rat];
    }
    
    if (!($monsters[ferocious roc,giant man-eating shark,Bristled Man-O-War,The Cray-Kin,Deadly Hydra] contains olfacted_monster))
        location_wanted_monster[$location[the old man's bathtime adventures]] = $monster[none];
    
    
    foreach l in location_wanted_monster
    {
        monster m = location_wanted_monster[l];
        if (l == $location[none])
            continue;
        if (__last_adventure_location != l)
            continue;
        if (m == olfacted_monster)
            continue;
        
        boolean all_other_monsters_banished = true;
        foreach key, m2 in l.get_monsters()
        {
            if (m == m2)
                continue;
            if (!m2.is_banished())
            {
                all_other_monsters_banished = false;
                break;
            }
        }
        if (all_other_monsters_banished)
            continue;
        
        string [int] description;
        
        string line;
        
        if (m != $monster[none])
            line += "To olfact " + m.HTMLEscapeString() + " instead of " + olfacted_monster.HTMLEscapeString() + ".|";
        else
            line += "To olfact in " + l + ".|";
            
        if (in_ronin())
            line += $item[soft green echo eyedrop antidote].pluralise() + " available.";
        
        description.listAppend(line);
        
        
        //Suggestion time!
        task_entries.listAppend(ChecklistEntryMake(383, "__item " + $item[soft green echo eyedrop antidote], "inventory.php?which=1", ChecklistSubentryMake("Remove " + $effect[on the trail], "", description), -11));
        
        break;
    }
    
}


void SHolidayGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    boolean [string] todays_holidays = getHolidaysToday();
    boolean [string] all_tomorrows_parties = getHolidaysTomorrow();
    
    if (todays_holidays["Halloween"])
    {
        if (__misc_state["in run"])
        {
            string [int] description;
            description.listAppend("Free stats/items from monsters on the first block.");
            if (knoll_available() && !have_outfit_components("Filthy Hippy Disguise"))
            {
                item [int] missing_components = missing_outfit_components("Bugbear Costume");
                if (missing_components.count() > 0)
                    description.listAppend("If you need an outfit, buy a " + missing_components.listJoinComponents(", ", "and") + " from the knoll.");
            }
            optional_task_entries.listAppend(ChecklistEntryMake(228, "__item plastic pumpkin bucket", "place.php?whichplace=town&action=town_trickortreat", ChecklistSubentryMake("Trick or treat for one block", "+" + my_primestat().to_lower_case(), description), $locations[trick-or-treating]));
        }
        else
        {
            string [int] description;
            description.listAppend("Wear an outfit, go from house to house.");
            description.listAppend("Remember you can trick-or-treat while drunk.");
            optional_task_entries.listAppend(ChecklistEntryMake(229, "__item plastic pumpkin bucket", "place.php?whichplace=town&action=town_trickortreat", ChecklistSubentryMake("Trick or treat", "", description), $locations[trick-or-treating]));
        }
    }
    if (all_tomorrows_parties["Halloween"] && !__misc_state["in run"])
        optional_task_entries.listAppend(ChecklistEntryMake(230, "__item plastic pumpkin bucket", "", ChecklistSubentryMake("Save turns for Halloween tomorrow", "", ""), 8));
    
    if (todays_holidays["Arrrbor Day"])
    {
        string [int] description;
        boolean [item] outfit_pieces_needed;
        foreach it in $items[crotchety pants,Saccharine Maple pendant,willowy bonnet]
        {
            if (!it.haveAtLeastXOfItemEverywhere(1))
                outfit_pieces_needed[it] = true;
        }
        //FIXME detect collecting reward?
        if ($items[bag of Crotchety Pine saplings,bag of Saccharine Maple saplings,bag of Laughing Willow saplings].available_amount() == 0)
        {
            description.listAppend("Choose a sapling type.");
            string [int] suggestions;
            if (outfit_pieces_needed[$item[crotchety pants]])
                suggestions.listAppend("Crotchety Pine");
            if (outfit_pieces_needed[$item[Saccharine Maple pendant]])
                suggestions.listAppend("Saccharine Maple");
            if (outfit_pieces_needed[$item[willowy bonnet]])
                suggestions.listAppend("Laughing Willow");
            if (suggestions.count() > 0)
                description.listAppend("Could try " + suggestions.listJoinComponents(", ", "or") + " for the reward item" + (suggestions.count() > 1 ? "s" : "") + ".");
        }
        else
        {
            item [int] bag_types;
            boolean have_a_bag_equipped = false;
            foreach it in $items[bag of Crotchety Pine saplings,bag of Saccharine Maple saplings,bag of Laughing Willow saplings]
            {
                if (it.available_amount() > 0)
                    bag_types.listAppend(it);
                if (it.equipped_amount() > 0)
                    have_a_bag_equipped = true;
            }
            if (!have_a_bag_equipped)
            {
                description.listAppend("Equip your " + bag_types.listJoinComponents(", ", "or") + ".");
            }
            else if (outfit_pieces_needed.count() > 0)
            {
                description.listAppend("Adventure for at least one hundred adventures to collect the outfit piece next holiday.");
            }
            else
            {
                description.listAppend("Adventure for at least two adventures to collect the potion reward next holiday.");
            }
        }
        optional_task_entries.listAppend(ChecklistEntryMake(231, "__item spooky sapling", "place.php?whichplace=woods", ChecklistSubentryMake("Plant trees", "", description), 8, $locations[The Arrrboretum]));
    }
}

void SRemindersGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{

    
    if ($effect[beaten up].have_effect() > 0)
    {
        string [int] methods;
        string url;
        if ($skill[tongue of the walrus].skill_is_usable())
        {
            methods.listAppend("Cast Tongue of the Walrus.");
            url = "skills.php";
        }
        else if (__misc_state["VIP available"] && __misc_state_int["hot tub soaks remaining"] > 0)
        {
            methods.listAppend("Soak in VIP hot tub.");
            url = "clan_viplounge.php";
        }
        else if ($skill[Shake it off].skill_is_usable())
        {
            methods.listAppend("Cast shake it off.");
            url = "skills.php";
        }
        else if (__misc_state_int["free rests remaining"] > 0)
        {
            methods.listAppend("Free rest at " + __misc_state_string["resting description"] + ".");
            url = __misc_state_string["resting url"];
        }
        
        foreach it in $items[tiny house,space tours tripple,personal massager,forest tears,csa all-purpose soap]
        {
            if (it.available_amount() > 0 && methods.count() == 0)
            {
                url = "inventory.php?which=1"; //may not be correct in all cases
                methods.listAppend("Use " + it + ".");
                break;
            }
        }
        
        boolean [location] ignoring_locations;
        ignoring_locations[$location[The Crimbonium Mine]] = true;
        
        if (methods.count() > 0 && $effect[thrice-cursed].have_effect() == 0 && !((ignoring_locations contains __last_adventure_location) && __last_adventure_location != $location[none]))
            task_entries.listAppend(ChecklistEntryMake(238, "__effect beaten up", url, ChecklistSubentryMake("Remove beaten up", "", methods), -11));
    }
    
    if (true)
    {
        //Don't get poisoned.
        effect [int] poison_effects;
        poison_effects.listAppend($effect[Hardly poisoned at all]);
        //if (!hippy_stone_broken()) //FIXME remove next PVP season
        poison_effects.listAppend($effect[A Little Bit Poisoned]);
        poison_effects.listAppend($effect[Somewhat Poisoned]);
        poison_effects.listAppend($effect[Really Quite Poisoned]);
        poison_effects.listAppend($effect[Majorly Poisoned]);
        poison_effects.listAppend($effect[Toad In The Hole]);
        
        effect have_poison = $effect[none];
        foreach key in poison_effects
        {
            effect e = poison_effects[key];
            if (e.have_effect() > 0)
            {
                have_poison = e;
                break;
            }
        }
        if (have_poison != $effect[none] && my_path_id() != PATH_G_LOVER)
        {
            string url = "";
            string [int] methods;
            
            /*if ($skill[disco nap].skill_is_usable() && $skill[adventurer of leisure].skill_is_usable())
            {
                url = "skills.php";
                methods.listAppend("Cast Disco Nap.");
            }
            else*/
            if (true)
            {
                url = "shop.php?whichshop=doc";
                methods.listAppend("Use Doc Galaktik's anti-anti-antidote.");
                if ($item[anti-anti-antidote].available_amount() > 0)
                    url = "inventory.php?which=1";
            }
            
            task_entries.listAppend(ChecklistEntryMake(239, "__effect " + have_poison, url, ChecklistSubentryMake("Remove " + have_poison, "", methods), -11));
        }
	}
        if ($effect[Cunctatitis].have_effect() > 0 && $skill[disco nap].skill_is_usable() && $skill[adventurer of leisure].skill_is_usable())
    {
        string url = "skills.php";
        string method = "Cast disco nap.";
        task_entries.listAppend(ChecklistEntryMake(240, "__effect Cunctatitis", url, ChecklistSubentryMake("Remove Cunctatitis", "", method), -11));
    }
    
    if ($effect[Down the Rabbit Hole].have_effect() > 0 && __last_adventure_location == $location[The Red Queen's Garden] && (!in_ronin() || $item[&quot;DRINK ME&quot; potion].available_amount() > 0) && get_property_int("pendingMapReflections") <= 0)
    {
        string url = "mall.php";
        
        if ($item[&quot;DRINK ME&quot; potion].available_amount() > 0)
            url = "inventory.php?which=3";
        
        task_entries.listAppend(ChecklistEntryMake(241, "__item &quot;DRINK ME&quot; potion", url, ChecklistSubentryMake("Drink " + $item[&quot;DRINK ME&quot; potion], "+madness", "Otherwise, no reflections of a map will drop."), -11));
    }
    
    if ($effect[Merry Smithsness].have_effect() == 0 && (!in_ronin() || $item[flaskfull of hollow].available_amount() > 0) && $items[Meat Tenderizer is Murder,Ouija Board\, Ouija Board,Hand that Rocks the Ladle,Saucepanic,Frankly Mr. Shank,Shakespeare's Sister's Accordion,Sheila Take a Crossbow,A Light that Never Goes Out,Half a Purse,loose purse strings,Hand in Glove].equipped_amount() > 0 && $item[flaskfull of hollow].item_is_usable() && my_path_id() != PATH_2CRS)
    {
        //They (can) have a flaskfull of hollow and have a smithsness item equipped, but no merry smithsness.
        //So, suggest a high-priority task.
        //I suppose in theory they could be saving the flaskfull of hollow for later, for +item? In that case, we would be annoying them. They can closet the flask, but that isn't perfect...
        //Still, I feel as though having this reminder is better than not having it.
        
        //Four items are not on the list due to their marginal bonus: Hairpiece On Fire (+maximum MP), Vicar's Tutu (+maximum HP), Staff of the Headmaster's Victuals (+spell damage), Work is a Four Letter Sword (+weapon damage)
        string url = "mall.php";
        
        if ($item[flaskfull of hollow].available_amount() > 0)
            url = "inventory.php?which=3";
        
        task_entries.listAppend(ChecklistEntryMake(242, "__item flaskfull of hollow", url, ChecklistSubentryMake("Drink " + $item[flaskfull of hollow], "", "Gives +25 smithsness"), -11));
    }
    
	if ($effect[QWOPped Up].have_effect() > 0 && ((__misc_state["VIP available"] && __misc_state_int["hot tub soaks remaining"] > 0) || $skill[Shake It Off].skill_is_usable())) //only suggest if they have hot tub access; other route is a SGEEA, too valuable
    {
        string [int] description;
        string url = "";
        if ($skill[Shake It Off].skill_is_usable())
        {
            url = "skills.php";
            description.listAppend("Shake it off.");
        }
        else
        {
            url = "clan_viplounge.php";
            description.listAppend("Use hot tub.");
        }
        
		task_entries.listAppend(ChecklistEntryMake(243, "__effect qwopped up", url, ChecklistSubentryMake("Remove QWOPped up effect", "", description), -11));
    }
    
    boolean [monster] awkwards;
    awkwards[$monster[Dr. Awkward]] = true;
    awkwards[$monster[Dr. Aquard]] = true;

    if ((awkwards contains get_property_monster("lastEncounter")) && $item[mega gem].equipped_amount() > 0 && ($items[2268, Staff of Ed\, almost].available_amount() > 0 || $item[2325].available_amount() > 0))
    {
        //Just defeated Dr. Awkward.
        //This will disappear once they adventure somewhere else.
        string [int] description;
        
        description.listAppend("It's not useful now, wear a better accessory?");
        if ($item[talisman o' namsilat].equipped_amount() > 0)
            description.listAppend("Possibly the talisman as well.");
    
		task_entries.listAppend(ChecklistEntryMake(244, "__item mega gem", "inventory.php?which=2", ChecklistSubentryMake("Possibly unequip the Mega Gem", "", description), -11));
    }
    
    if (__misc_state["need to level"])
    {
        ChecklistEntry stat_items;
        stat_items.image_lookup_name = "";
        stat_items.url = "inventory.php?which=3";
        stat_items.importance_level = 0;
        
        effect [item] item_effects;
        string [item] item_descriptions;
        
        if ($effect[Purple Tongue].have_effect() == 0 && $effect[Green Tongue].have_effect() == 0 && $effect[Red Tongue].have_effect() == 0 && $effect[Blue Tongue].have_effect() == 0 && $effect[Black Tongue].have_effect() == 0)
        {
            item_descriptions[$item[orange snowcone]] = "+1.5 mainstat/fight (20 turns)";
            item_effects[$item[orange snowcone]] = $effect[Orange Tongue];
        }
        
        if (in_ronin())
        {
            item_descriptions[$item[Effermint&trade; tablets]] = "+1.5 mainstat/fight (10 turns)";
        }
        
        if (__misc_state["need to level moxie"])
        {
            item_descriptions[$item[Ye Olde Bawdy Limerick]] = "+2 moxie stats/fight (20 turns)";
            item_effects[$item[Ye Olde Bawdy Limerick]] = $effect[From Nantucket];
            
            
            item_descriptions[$item[resolution: be sexier]] = "+2 moxie stats/fight (20 turns)";
            item_effects[$item[resolution: be sexier]] = $effect[Irresistible Resolve];
            
            //Always better used for +init, since the tower tests came into existence?
            /*if (in_ronin() && !in_bad_moon() && my_primestat() == $stat[moxie]) //better used for +init otherwise
            {
                item_descriptions[$item[old bronzer]] = "+2 moxie stats/fight (25 turns)";
                item_effects[$item[old bronzer]] = $effect[Sepia Tan];
            }*/
        }

        if (__misc_state["need to level muscle"])
        {
            item_descriptions[$item[Squat-Thrust Magazine]] = "+3 muscle stats/fight (20 turns)";
            item_effects[$item[Squat-Thrust Magazine]] = $effect[Squatting and Thrusting];
            
            
            item_descriptions[$item[resolution: be stronger]] = "+2 muscle stats/fight (20 turns)";
            item_effects[$item[resolution: be stronger]] = $effect[Strong Resolve];
            
            
            /*if (in_ronin() && !in_bad_moon())
            {
                item_descriptions[$item[old eyebrow pencil]] = "+2 muscle stats/fight (25 turns)";
                item_effects[$item[old eyebrow pencil]] = $effect[Browbeaten];
            }*/
        }
        if (__misc_state["need to level mysticality"])
        {
            item_descriptions[$item[O'RLY Manual]] = "+4 mysticality stats/fight (20 turns)";
            item_effects[$item[O'RLY Manual]] = $effect[You Read The Manual];
            
            
            item_descriptions[$item[resolution: be smarter]] = "+2 mysticality stats/fight (20 turns)";
            item_effects[$item[resolution: be smarter]] = $effect[Brilliant Resolve];
            
            
            /*if (in_ronin() && !in_bad_moon())
            {
                item_descriptions[$item[old rosewater cream]] = "+2 mysticality stats/fight (25 turns)";
                item_effects[$item[old rosewater cream]] = $effect[Rosewater Mark];
            }*/
        }
        
        if (my_level() >= 11)
        {
            item_descriptions[$item[BitterSweetTarts]] = "+5.5 " + my_primestat().to_lower_case() + " stats/fight (10 turns)";
            item_effects[$item[BitterSweetTarts]] = $effect[Full of Wist];
        }
        
        item [int] relevant_items;
        string [int] relevant_descriptions;
        foreach it in item_descriptions
        {
            if (it.item_amount() == 0)
                continue;
            if (!it.item_is_usable()) continue;
            effect e = item_effects[it];
            if (e == $effect[none])
                e = it.to_effect();
            if (!e.effect_is_usable()) continue;
            if (e.have_effect() > 0)
                continue;
            if (stat_items.image_lookup_name.length() == 0)
                stat_items.image_lookup_name = "__item " + it;
            //stat_items.subentries.listAppend(ChecklistSubentryMake("Use " + it, "", item_descriptions[it]));
            relevant_items.listAppend(it);
            relevant_descriptions.listAppend(item_descriptions[it]);
        }
        
        ChecklistSubentry subentry;
        if (relevant_items.count() > 0)
        {
            subentry.header = "Use " + relevant_items.listJoinComponents(", ", "and");
            subentry.entries.listAppend(relevant_descriptions.listJoinComponents(", ", "and"));
        }
        
        
        if (subentry.header != "")
            stat_items.subentries.listAppend(subentry);
        if (stat_items.subentries.count() > 0)
        {
            optional_task_entries.listAppend(stat_items);
        }
    }
    
    if ($item[evil eye].available_amount() > 0 && __quest_state["Level 7"].state_int["nook evilness"] > 25 && my_path_id() != PATH_G_LOVER)
    {
        task_entries.listAppend(ChecklistEntryMake(245, "__item " + $item[evil eye], "inventory.php?which=3", ChecklistSubentryMake("Use " + $item[evil eye], "", "Three cyrpt nook beeps."), -11));
    }
    
    if ($familiars[mini-hipster, artistic goth kid] contains my_familiar() && __misc_state["need to level"] && __misc_state_int["hipster fights available"] > 0 && !__misc_state["single familiar run"])
    {
        task_entries.listAppend(ChecklistEntryMake(246, "__familiar " + my_familiar(), "", ChecklistSubentryMake("Buff " + my_primestat(), "", "Extra stats from " + my_familiar() + " fights."), -11));
    }
    
    boolean have_blacklight_bulb = (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && get_property("peteMotorbikeHeadlight") == "Blacklight Bulb");
    boolean have_alternate_uv_source = false;
    if (have_blacklight_bulb)
        have_alternate_uv_source = true;
    if (my_path_id() == PATH_LICENSE_TO_ADVENTURE && get_property_boolean("bondDesert"))
        have_alternate_uv_source = true;
    if (__last_adventure_location == $location[the arid\, extra-dry desert] && !__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && __misc_state["in run"] && !have_alternate_uv_source && __quest_state["Level 11 Desert"].state_int["Desert Exploration"] < 99)
    {
        boolean have_uv_compass_equipped = __quest_state["Level 11 Desert"].state_boolean["Have UV-Compass eqipped"];
        
        if (!have_uv_compass_equipped)
        {
            string title;
            item compass_item = $item[UV-resistant compass];
            if ($item[ornate dowsing rod].available_amount() > 0)
                compass_item = $item[ornate dowsing rod];
            
            title = "Equip " + compass_item;
            if (compass_item.available_amount() == 0)
                title = "Find and equip " + compass_item;
            task_entries.listAppend(ChecklistEntryMake(247, "__item " + compass_item, "", ChecklistSubentryMake(title, "", "Explore more efficiently."), -11));
        }
        
    }
    if ($item[bottle of blank-out].available_amount() > 0 && $item[glob of blank-out].available_amount() == 0 && __misc_state["in run"] && __misc_state["free runs usable"] && !get_property_boolean("_blankoutUsed") && in_ronin())
    {
        task_entries.listAppend(ChecklistEntryMake(248, "__item " + $item[bottle of blank-out], "inventory.php?which=3", ChecklistSubentryMake("Use " + $item[bottle of blank-out], "", "Acquire glob to run away with."), -11));
    
    }
    if (__last_adventure_location == $location[the haunted ballroom] && $item[dance card].available_amount() > 0 && __misc_state["need to level"] && my_primestat() == $stat[moxie] && CounterLookup("Dance Card").CounterGetNextExactTurn() == -1)
    {
        boolean delay_for_semirare = CounterLookup("Semi-rare").CounterWillHitExactlyInTurnRange(3, 3);
        
        if (delay_for_semirare)
            task_entries.listAppend(ChecklistEntryMake(249, "__item " + $item[dance card], "", ChecklistSubentryMake(HTMLGenerateSpanFont("Avoid using " + $item[dance card], "red"), "", HTMLGenerateSpanFont("You have a semi-rare coming up then, wait a turn first.", "red")), -11));
        else
        {
            string [int] description;
            description.listAppend("Gives ~" + __misc_state_float["dance card average stats"].round() + " mainstat in four turns.");
            if ($item[dance card].available_amount() > 1)
                description.listAppend("Have " + $item[dance card].pluraliseWordy() + ".");
            task_entries.listAppend(ChecklistEntryMake(250, "__item " + $item[dance card], "inventory.php?which=3", ChecklistSubentryMake("Use " + $item[dance card], "", description), -11));
        }
    }
    if (!__quest_state["Level 11 Hidden City"].finished && (__quest_state["Level 11 Hidden City"].state_boolean["Apartment finished"] || get_property_int("hiddenApartmentProgress") >= 7) && $effect[thrice-cursed].have_effect() > 0 && my_path_id() != PATH_G_LOVER)
    {
        string curse_removal_method;
        string url;
        
        if (__misc_state["VIP available"] && __misc_state_int["hot tub soaks remaining"] > 0)
        {
            curse_removal_method = "Relax in hot tub.";
            url = "clan_viplounge.php";
        }
        if ($skill[Shake It Off].skill_is_usable())
        {
            curse_removal_method = "Cast shake it off.";
            url = "skills.php";
        }
        
        if (curse_removal_method != "")
        {
            task_entries.listAppend(ChecklistEntryMake(251, "__effect thrice-cursed", url, ChecklistSubentryMake("Remove Thrice-Cursed", "", curse_removal_method), -11));
        }
    }
    
    if (my_path_id() == PATH_HEAVY_RAINS && my_familiar() != $familiar[none] && $slot[familiar].equipped_item() == $item[none])
    {
        boolean [familiar] safely_underwater_familiars = $familiars[black cat,Barrrnacle,Emo Squid,Cuddlefish,Imitation Crab,Magic Dragonfish,Midget Clownfish,Rock Lobster,Urchin Urchin,Grouper Groupie,Squamous Gibberer,Dancing Frog,Adorable Space Buddy]; //cat can swim!
        
        if (!(safely_underwater_familiars contains my_familiar()))
        {
            //mafia has code to do this, but it doesn't always work - had it not equip on the blackbird once, another time after the L13 entryway
            //plus they have to buy one anyways
            string url = "familiar.php";
            string [int] description;
            description.listAppend("Otherwise it'll (probably) be blocked.");
            if ($item[miniature life preserver].available_amount() == 0)
            {
                description.listAppend("Buy from the general store.");
                url = "shop.php?whichshop=generalstore";
            }
            
            task_entries.listAppend(ChecklistEntryMake(252, "__item miniature life preserver", url, ChecklistSubentryMake(HTMLGenerateSpanFont("Equip miniature life preserver", "red"), "", description), -11));
        }
    }
    
    Counter semirare_counter = CounterLookup("Semi-rare");
    if (semirare_counter.CounterIsRange() && semirare_counter.range_start_turn <= 3 && semirare_counter.range_start_turn >= 1)
    {
        //can we reasonably discover the secret?
        string [int] description;
        int upcoming_in = semirare_counter.range_start_turn;
        description.listAppend("Window starts after " + pluraliseWordy(upcoming_in, "turn", "turns") + ".");
        
        string [int] options;
        if (__misc_state["can eat just about anything"] && my_path_id() != PATH_NUCLEAR_AUTUMN && my_path_id() != PATH_G_LOVER)
        {
            options.listAppend("eat a fortune cookie");
        }
        if (__misc_state["VIP available"] && __misc_state["can drink just about anything"] && $item[Clan speakeasy].is_unrestricted())
        {
            options.listAppend("drink a lucky lindy");
        }
        
        description.listAppend(options.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
        
        if (options.count() > 0)
            task_entries.listAppend(ChecklistEntryMake(253, "__item fortune cookie", "", ChecklistSubentryMake(HTMLGenerateSpanFont("Learn semi-rare number", "red"), "", description), -11));
    }
    
    if (__last_adventure_location == $location[a maze of sewer tunnels] && $item[hobo code binder].equipped_amount() == 0 && haveAtLeastXOfItemEverywhere($item[hobo code binder], 1))
    {
        task_entries.listAppend(ChecklistEntryMake(254, "__item hobo code binder", "inventory.php?which=2", ChecklistSubentryMake(HTMLGenerateSpanFont("Equip hobo code binder", "red"), "", "Speeds up sewer tunnel exploration."), -11));
    }
    
}



Record Banish
{
    monster banished_monster;
    string banish_source;
    int turn_banished;
    int banish_turn_length;
    string custom_reset_conditions;
};

void listAppend(Banish [int] list, Banish entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

int BanishTurnsLeft(Banish b)
{
    if (b.banish_turn_length == -1)
        return 2147483647;
    return b.turn_banished + b.banish_turn_length - my_turncount();
}

static
{
    int [string] __banish_source_length;
    //FIXME request this be exposed in ASH?
    //all of these must be lowercase. because.
    __banish_source_length["banishing shout"] = -1;
    __banish_source_length["batter up!"] = -1;
    __banish_source_length["chatterboxing"] = 20;
    __banish_source_length["classy monkey"] = 20;
    __banish_source_length["cocktail napkin"] = 20;
    __banish_source_length["crystal skull"] = 20;
    __banish_source_length["deathchucks"] = -1;
    __banish_source_length["dirty stinkbomb"] = -1;
    __banish_source_length["divine champagne popper"] = 5;
    __banish_source_length["harold's bell"] = 20;
    __banish_source_length["howl of the alpha"] = -1;
    __banish_source_length["ice house"] = -1;
    __banish_source_length["louder than bomb"] = 20;
    __banish_source_length["nanorhino"] = -1;
    __banish_source_length["pantsgiving"] = 30;
    __banish_source_length["peel out"] = -1;
    __banish_source_length["pulled indigo taffy"] = 40;
    __banish_source_length["smoke grenade"] = 20;
    __banish_source_length["spooky music box mechanism"] = -1;
    __banish_source_length["staff of the standalone cheese"] = -1;
    __banish_source_length["stinky cheese eye"] = 10;
    __banish_source_length["thunder clap"] = 40;
    __banish_source_length["v for vivala mask"] = 10;
    __banish_source_length["walk away from explosion"] = 30;
    __banish_source_length["tennis ball"] = 30;
    __banish_source_length["curse of vacation"] = -1;
    __banish_source_length["ice hotel bell"] = -1;
    __banish_source_length["bundle of &quot;fragrant&quot; herbs"] = -1;
    __banish_source_length["snokebomb"] = 30;
    __banish_source_length["beancannon"] = -1;
    __banish_source_length["kgb tranquilizer dart"] = 20;
    __banish_source_length["spring-loaded front bumper"] = 30;
    __banish_source_length["mafia middle finger ring"] = 60;
    __banish_source_length["throw latte on opponent"] = 30; //Throw Latte on Opponent
    __banish_source_length["saber force"] = 30;
    
    int [string] __banish_simultaneous_limit;
    __banish_simultaneous_limit["beancannon"] = 5;
    __banish_simultaneous_limit["banishing shout"] = 3;
    __banish_simultaneous_limit["howl of the alpha"] = 3;
    __banish_simultaneous_limit["staff of the standalone cheese"] = 5;
}

Banish [int] __banishes_active_cache;
string __banishes_active_cache_cached_monsters_string;

Banish [int] BanishesActive()
{
    //banishedMonsters(user, now 'a.m.c. gremlin:ice house:2890', default )
    
    string banished_monsters_string = get_property("banishedMonsters");
    
    if (banished_monsters_string == __banishes_active_cache_cached_monsters_string && __banishes_active_cache_cached_monsters_string != "")
        return __banishes_active_cache;
    
    __banishes_active_cache_cached_monsters_string = ""; //invalidate the cache
    
    Banish [int] result;
    
    string [int] banished_monsters_string_split = banished_monsters_string.split_string(":");

    foreach key, s in banished_monsters_string_split
    {
        if (s.length() == 0)
            continue;
        if (key % 3 != 0)
            continue;
        //string [int] entry = s.split_string(":");
        
        //if (entry.count() != 3)
            //continue;
        if (!(banished_monsters_string_split contains (key + 1)) || !(banished_monsters_string_split contains (key + 2)))
            continue;
        
        Banish b;
        b.banished_monster = banished_monsters_string_split[key + 0].to_monster();
        b.banish_source = banished_monsters_string_split[key + 1];
        b.turn_banished = banished_monsters_string_split[key + 2].to_int();
        b.banish_turn_length = 0;
        if (__banish_source_length contains b.banish_source.to_lower_case())
            b.banish_turn_length = __banish_source_length[b.banish_source.to_lower_case()];
        if (b.banish_source == "batter up!" || b.banish_source == "deathchucks" || b.banish_source == "dirty stinkbomb" || b.banish_source == "nanorhino" || b.banish_source == "spooky music box mechanism" || b.banish_source == "ice hotel bell" || b.banish_source == "beancannon")
            b.custom_reset_conditions = "rollover";
        if (b.banish_source == "ice house" && (!$item[ice house].is_unrestricted() || in_bad_moon())) //not relevant
            continue;
        result.listAppend(b);
    }
    
    __banishes_active_cache_cached_monsters_string = banished_monsters_string;
    __banishes_active_cache = result;
    
    return result;
}


Banish [int] BanishesActiveInLocation(location l)
{
    boolean [monster] location_monsters;
    foreach key, m in l.get_monsters()
        location_monsters[m] = true;
    Banish [int] banishes_active = BanishesActive();
    Banish [int] result;
    foreach key, b in banishes_active
    {
        if (location_monsters contains b.banished_monster)
            result.listAppend(b);
    }
    return result;
}

int BanishShortestBanishForLocation(location l)
{
    Banish [int] active_banishes = BanishesActiveInLocation(l);
    int minimum = 2147483647;
    foreach key, b in active_banishes
    {
        minimum = MIN(minimum, b.BanishTurnsLeft());
    }
    return minimum;
}

Banish BanishForMonster(monster m)
{
    foreach key, b in BanishesActive()
    {
        if (b.banished_monster == m)
            return b;
    }
    Banish blank;
    return blank;
}

string BanishSourceForMonster(monster m)
{
    return BanishForMonster(m).banish_source;
}

int [string] activeBanishNameCountsForLocation(location l)
{
    Banish [int] banishes_active = BanishesActive();
    
    string [monster] names;
    foreach key, banish in banishes_active
    {
        if (banish.banished_monster.is_banished()) //zuko wrote this code
        {
            names[banish.banished_monster] = banish.banish_source;
        }
    }
    
    int [string] banish_name_counts;
    foreach key, m in l.get_monsters()
    {
        if (names contains m)
            banish_name_counts[names[m]] += 1;
        if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
        {
            foreach m2 in names
            {
                if (m2.to_string().to_lower_case().contains_text(m.to_string().to_lower_case())) //FIXME complete hack, wrong, substrings, 1337, etc
                    banish_name_counts[names[m2]] += 1;
            }
        }
    }
    return banish_name_counts;
}

boolean [string] activeBanishNamesForLocation(location l)
{
    boolean [string] result;
    
    foreach banish_name, count in l.activeBanishNameCountsForLocation()
        result[banish_name] = (count > 0);
    return result;
}

Banish BanishByName(string name)
{
    foreach key, banish in BanishesActive()
    {
        if (banish.banish_source == name)
            return banish;
    }
    Banish blank;
    return blank;
}

int BanishLength(string banish_name)
{
    int length = __banish_source_length[banish_name.to_lower_case()];
    if (length < 0)
        length = 2147483647;
    return length;
}

boolean BanishIsActive(string name)
{
    foreach key, banish in BanishesActive()
    {
        if (banish.banish_source == name)
            return true;
    }
    return false;
}

void SEventsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    return;
}

void SCrimbo2015GenerateResource(ChecklistEntry [int] resource_entries)
{
    string year_and_month = format_today_to_string("yyyyMM");
    if (year_and_month != "201512")
        return;
    if (!in_ronin())
    {
        int herb_uses_left = clampi(10 - get_property_int("_fragrantHerbsUsed"), 0, 10);
        if ($item[bundle of &quot;fragrant&quot; herbs].available_amount() > 0 && herb_uses_left > 0)
        {
            string [int] description;
            description.listAppend("Free run/banish three monsters at once.");
            monster [int] banished_monsters;
            foreach key, b in BanishesActive()
            {
                if (b.banish_source == "bundle of &quot;fragrant&quot; herbs")
                {
                    banished_monsters.listAppend(b.banished_monster);
                }
            }
            if (banished_monsters.count() > 0)
                description.listAppend("Have " + banished_monsters.listJoinComponents(", ", "and") + " banished.");
            resource_entries.listAppend(ChecklistEntryMake(381, "__item bundle of &quot;fragrant&quot; herbs", "", ChecklistSubentryMake(pluralise(herb_uses_left, "fragrant herb banish", "fragrant herb banishes"), "", description), 3));
        }
        int stockpile_uses_left = clampi(10 - get_property_int("_nuclearStockpileUsed"), 0, 10);
        if ($item[nuclear stockpile].available_amount() > 0 && stockpile_uses_left > 0)
        {
            string [int] description;
            description.listAppend("Does not cost a turn.");
            resource_entries.listAppend(ChecklistEntryMake(382, "__item nuclear stockpile", "", ChecklistSubentryMake(pluralise(stockpile_uses_left, "nuclear stockpile instakill", "nuclear stockpile instakills"), "", description), 3));
        }
    }
}

void SEventsGenerateResource(ChecklistEntry [int] resource_entries)
{
    SCrimbo2015GenerateResource(resource_entries);
}
Record SealSummon
{
    monster summoned_monster;
    item figurine;
    boolean can_buy_in_store_or_hermit;
    int seal_clubber_candles_required;
    int imbued_seal_blubber_candles_required; //0 or 1
    int minimum_level;
    item item_dropped;
    item equipment_dropped;
    string item_dropped_description;
};

SealSummon SealSummonMake(monster summoned_monster, item figurine, boolean can_buy_in_store_or_hermit, int seal_clubber_candles_required, int imbued_seal_blubber_candles_required, int minimum_level, item item_dropped, string item_dropped_description, item equipment_dropped)
{
    SealSummon summon;
    summon.summoned_monster = summoned_monster;
    summon.figurine = figurine;
    summon.can_buy_in_store_or_hermit = can_buy_in_store_or_hermit;
    summon.seal_clubber_candles_required = seal_clubber_candles_required;
    summon.imbued_seal_blubber_candles_required = imbued_seal_blubber_candles_required;
    summon.minimum_level = minimum_level;
    summon.item_dropped = item_dropped;
    summon.equipment_dropped = equipment_dropped;
    summon.item_dropped_description = item_dropped_description;
    
    return summon;
}

void listAppend(SealSummon [int] list, SealSummon entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void SSealClubberInfernalSealsGenerateResource(ChecklistEntry [int] resource_entries)
{
    string [int] description;
    int seal_summon_limit = 5;
    if ($item[Claw of the Infernal Seal].available_amount() > 0)
    {
        seal_summon_limit = 10;
        if ($item[Claw of the Infernal Seal].item_amount() + $item[Claw of the Infernal Seal].equipped_amount() == 0 && $item[Claw of the Infernal Seal].storage_amount() > 0)
            description.listAppend("Pull the Claw of the Infernal Seal from hangk's.");
    }
    int seals_summoned = get_property_int("_sealsSummoned");
    int summons_remaining = MAX(seal_summon_limit - seals_summoned, 0);
    if (summons_remaining == 0)
        return;
    
    //Seal summons:
    //FIXME suggest they equip a club (support swords with iron palms)
    
    if (!$slot[weapon].equipped_item().weapon_is_club())
    {
        description.listAppend("Equip a club" + ($effect[Iron Palms].have_effect() > 0 ? " or sword" : "") + " first.");
    }
    
    
    //initialise all the seals:
    SealSummon [int] seal_summons;
    //seal_summons.listAppend(SealSummonMake($monster[SUMMONED_MONSTER], $item[FIGURINE], CAN_BUY_IN_STORE_OR_HERMIT, SEAL_CLUBBER_CANDLES_REQUIRED, IMBUED_SEAL_BLUBBER_CANDLES_REQUIRED, MINIMUM_LEVEL, $item[ITEM_DROPPED], "ITEM_DROPPED_DESCRIPTION"));
    seal_summons.listAppend(SealSummonMake($monster[broodling seal], $item[figurine of a cute baby seal], true, 5, 0, 5, $item[severed flipper], "low-level club", $item[none]));
    
    seal_summons.listAppend(SealSummonMake($monster[Centurion of Sparky], $item[figurine of an armored seal], true, 10, 0, 9, $item[ingot of seal-iron], ($items[ingot of seal-iron,bad-ass club,creepy-ass club,evil-ass club,frigid-ass club,hot-ass club,nasty-ass club].available_amount() == 0 ? "+10ML craftable club" : ""), $item[none]));
    
    seal_summons.listAppend(SealSummonMake($monster[hermetic seal], $item[figurine of an ancient seal], true, 3, 0, 6, $item[powdered sealbone], "imbued candle source", $item[none]));
    
    seal_summons.listAppend(SealSummonMake($monster[Spawn of Wally], $item[figurine of a wretched-looking seal], true, 1, 0, 1, $item[tainted seal's blood], "minor potion", $item[none]));
    
    seal_summons.listAppend(SealSummonMake($monster[heat seal], $item[figurine of a charred seal], false, 0, 1, 6, $item[sizzling seal fat], "+init, +hot damage potion", $item[Abyssal ember]));
    
    seal_summons.listAppend(SealSummonMake($monster[navy seal], $item[figurine of a cold seal], false, 0, 1, 6, $item[frost-rimed seal hide], "+cold damage, +HP potion", $item[frozen seal spine]));
    
    seal_summons.listAppend(SealSummonMake($monster[Servant of Grodstank], $item[figurine of a stinking seal], false, 0, 1, 6, $item[fustulent seal grulch], "+20 ML, +stench damage potion", $item[infernal toilet brush]));
    
    seal_summons.listAppend(SealSummonMake($monster[shadow of Black Bubbles], $item[figurine of a shadowy seal], false, 0, 1, 6, $item[scrap of shadow], "+spooky damage potion", $item[shadowy seal eye]));
    
    seal_summons.listAppend(SealSummonMake($monster[watertight seal], $item[figurine of a sleek seal], false, 0, 1, 12, $item[hyperinflated seal lung], "underwater breathing potion", $item[none]));
    
    seal_summons.listAppend(SealSummonMake($monster[wet seal], $item[figurine of a slippery seal], false, 0, 1, 6, $item[seal lube], "+sleaze damage, +moxie potion", $item[mannequin leg]));
    
    seal_summons.listAppend(SealSummonMake($monster[none], $item[depleted uranium seal figurine], false, 0, 1, 0, $item[none], "random", $item[none]));
    
    //description left blank, due to possible revamp?
    string url = "";
    if (guild_store_available())
        url = "shop.php?whichshop=guildstore3";
        
    boolean want_output_ml = __misc_state["need to level"];
    
        
    string [int][int] options;
    
    if (true)
    {
        string [int] option;
        option.listAppend("figurine");
        option.listAppend("candles");
        if (want_output_ml)
            option.listAppend("ML");
        option.listAppend("drops");
        foreach key, s in option
        {
            option[key] = HTMLGenerateSpanOfClass(s, "r_bold");
        }
        options.listAppend(option);
    }
        
    if ($item[powdered sealbone].available_amount() > 0 && $item[imbued seal-blubber candle].available_amount() == 0)
    {
        description.listAppend("Can make an imbued seal-blubber candle.");
    }
    
    foreach key, summon in seal_summons
    {
        if (summon.minimum_level > my_level())
            continue;
        if (!summon.can_buy_in_store_or_hermit && summon.figurine.available_amount() == 0)
            continue;
        string figurine_name_simple = summon.figurine.to_string().replace_string("figurine of an ", "").replace_string("figurine of a ", "");
        
        string candles_required = summon.seal_clubber_candles_required;
        if ($item[seal-blubber candle].available_amount() < summon.seal_clubber_candles_required)
            candles_required = HTMLGenerateSpanFont(candles_required, "grey");
        if (summon.imbued_seal_blubber_candles_required > 0)
        {
            candles_required = "imbued";
        }
        string ml_description;
        if (summon.summoned_monster != $monster[none])
        {
            ml_description = summon.summoned_monster.base_attack;
        }
        
        string item_description = summon.item_dropped_description;
        
        string [int] option;
        option.listAppend(figurine_name_simple);
        option.listAppend(candles_required);
        if (want_output_ml)
            option.listAppend(ml_description);
        option.listAppend(item_description);
        if (summon.imbued_seal_blubber_candles_required > 0 && $items[imbued seal-blubber candle,powdered sealbone].available_amount() == 0)
        {
            foreach key, s in option
            {
                option[key] = HTMLGenerateSpanFont(s, "grey");
            }
        }
        options.listAppend(option);
    }
    description.listPrepend(HTMLGenerateSimpleTableLines(options));
        
    resource_entries.listAppend(ChecklistEntryMake(283, "__item figurine of an ancient seal", url, ChecklistSubentryMake(pluralise(summons_remaining, "seal summon", "seal summons"), "", description), 10));
}

void SSealClubberGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (my_class() != $class[seal clubber])
        return;

    SSealClubberInfernalSealsGenerateResource(resource_entries);
}

void STurtleTamerGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_class() != $class[turtle tamer])
        return;
    
    if (__misc_state["in run"] && guild_store_available() && my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST && $effect[Eau de Tortue].have_effect() == 0 && my_meat() >= 200)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(284, "__item helmet turtle", "shop.php?whichshop=guildstore3", ChecklistSubentryMake("Buy and use turtle pheromones", "", "Lets you encounter more turtles.")));
    }
}

void SDiscoBanditGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (my_class() != $class[disco bandit])
        return;
    if ($skill[Break It On Down].have_skill() && $skill[Run Like the Wind].have_skill() && $skill[Pop and Lock It].have_skill())
    {
        int steals_done = get_property_int("_raveStealCount");
        int steals_remaining = clampi(30 - steals_done, 0, 30);
        if (steals_done > 0 && steals_remaining > 0)
        {
            string [int] description;
            description.listAppend("Knocks loose a pickpocketable item.");
            //raveCombo5 is rave steal
            //FIXME list combo order
            string rave_combo_number_5 = get_property("raveCombo5");
            if (rave_combo_number_5 != "")
            {
                string [int] skill_order = rave_combo_number_5.split_string(",");
                description.listAppend(skill_order.listJoinComponents(__html_right_arrow_character).capitaliseFirstLetter() + ".");
            }
            resource_entries.listAppend(ChecklistEntryMake(285, "__skill Disco Dance 3: Back in the Habit", "", ChecklistSubentryMake(pluralise(steals_remaining, "Rave Steal", "Rave Steals"), "", description), 8));
        }
    }
}

void SPastamancerGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_class() != $class[pastamancer])
        return;
    if (__quest_state["Nemesis"].finished && !$skill[Canticle of Carboloading].have_skill())
    {
        if ($item[black hymnal].available_amount() == 0)
        {
            optional_task_entries.listAppend(ChecklistEntryMake(286, "__skill Canticle of Carboloading", "volcanoisland.php", ChecklistSubentryMake("Collect the black hymnal from the Nemesis Temple", "", "Unlocks Carboloading.")));
        }
        else
        {
            optional_task_entries.listAppend(ChecklistEntryMake(287, "__skill Canticle of Carboloading", "inventory.php?which=3&ftext=black+hymnal", ChecklistSubentryMake("Use the black hymnal", "", "Unlocks Carboloading.")));
        }
    }
}

void SClassesGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    STurtleTamerGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    SPastamancerGenerateTasks(task_entries, optional_task_entries, future_task_entries);
}

void SClassesGenerateResource(ChecklistEntry [int] resource_entries)
{
    SSealClubberGenerateResource(resource_entries);
    SDiscoBanditGenerateResource(resource_entries);
}

string [int] SEquipmentGenerateXiblaxianHoloWristPuterDescription()
{
    string [int] description;
    string [int][int] table;
    table.listAppend(listMake("Outdoor", "polymer"));
    table.listAppend(listMake("Indoor", "circuitry"));
    table.listAppend(listMake("Underground", "alloy"));
    table.listAppend(listMake("Underwater", "polymer"));
    //this is kind of a hack:
    int index_to_bold = -1;
    if (__last_adventure_location.environment == "outdoor")
        index_to_bold = 0;
    else if (__last_adventure_location.environment == "indoor")
        index_to_bold = 1;
    else if (__last_adventure_location.environment == "underground")
        index_to_bold = 2;
    if (__last_adventure_location.environment == "underwater")
        index_to_bold = 3;
    
    if (index_to_bold != -1)
    {
        foreach key, v in table[index_to_bold]
            table[index_to_bold][key] = HTMLGenerateSpanOfClass(v, "r_bold");
    }
    description.listAppend(HTMLGenerateSimpleTableLines(table));
    
    if (!get_property_boolean("_holoWristCrystal"))
    	description.listAppend("Can acquire a crystal by mining. (once/day)");
    
    string [int] items_owned;
    foreach it in $items[Xiblaxian alloy,Xiblaxian circuitry,Xiblaxian polymer,Xiblaxian crystal]
    {
        if (it.available_amount() > 0)
            items_owned.listAppend(it.available_amount() + " " + it);
    }
    
    description.listAppend("Own " + items_owned.listJoinComponents(", ", "and") + ".");
    return description;
}

void SEquipmentGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($item[Xiblaxian holo-wrist-puter].equipped_amount() > 0)
    {
        int turns_left = XiblaxianHoloWristPuterTurnsUntilNextItem();
        if (turns_left == 1 || turns_left == 0)
        {
            string [int] description = SEquipmentGenerateXiblaxianHoloWristPuterDescription();
            task_entries.listAppend(ChecklistEntryMake(385, "__item Xiblaxian holo-wrist-puter", "", ChecklistSubentryMake("Xiblaxian item next combat", "", description), -11));
        }
    }
}

void SEquipmentGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[Xiblaxian holo-wrist-puter].equipped_amount() > 0)
    {
        int turns_left = XiblaxianHoloWristPuterTurnsUntilNextItem();
        if (turns_left != -1 || true)
        {
            string [int] description = SEquipmentGenerateXiblaxianHoloWristPuterDescription();
            //description.listAppend("_holoWristDrops = " + get_property_int("_holoWristDrops"));
            //description.listAppend("_holoWristProgress = " + get_property_int("_holoWristProgress"));
            
            string header = turns_left + " combats to Xiblaxian item";
            if (turns_left <= 1)
                header = "Xiblaxian next turn";
            resource_entries.listAppend(ChecklistEntryMake(386, "__item Xiblaxian holo-wrist-puter", "", ChecklistSubentryMake(header, "", description), 8));
        }
    }
}
static
{
	int [string] __moon_sign_id_lookup;
	void initialiseMoonSignIDLookup()
	{
        __moon_sign_id_lookup[""] = 0;
        __moon_sign_id_lookup["None"] = 0;
		__moon_sign_id_lookup["Mongoose"] = 1;
		__moon_sign_id_lookup["Wallaby"] = 2;
		__moon_sign_id_lookup["Vole"] = 3;
		__moon_sign_id_lookup["Platypus"] = 4;
		__moon_sign_id_lookup["Opossum"] = 5;
		__moon_sign_id_lookup["Marmot"] = 6;
		__moon_sign_id_lookup["Wombat"] = 7;
		__moon_sign_id_lookup["Blender"] = 8;
		__moon_sign_id_lookup["Packrat"] = 9;
		__moon_sign_id_lookup["Bad Moon"] = 10; //confirmed
	}
	initialiseMoonSignIDLookup();
}

Record NumberologyCacheState
{
	int b;
	int c;
	int [int] input_to_outputs;
	int [int] input_deltas;
};

NumberologyCacheState NumberologyCacheStateMake()
{
	NumberologyCacheState r;
	r.b = -1;
	r.c = -1;
	return r;
}

static
{
	NumberologyCacheState __numberology_cache = NumberologyCacheStateMake();
}

void calculateNumberologyInputValuesForOutputs(boolean [int] desired_digits_in, int [int] digit_inputs_to_outputs_out, int [int] digit_inputs_to_deltas_out)
{
    if (!(__moon_sign_id_lookup contains my_sign())) //not computable
        return;
    
	boolean [int] desired_digits_left;
	foreach digit in desired_digits_in
	{
		desired_digits_left[digit] = true;
		digit_inputs_to_deltas_out[digit] = 99;
	}
	int mood_sign_id = __moon_sign_id_lookup[my_sign()];
	
	int b = my_spleen_use() + my_level();
	int c = (my_ascensions() + mood_sign_id) * b + my_adventures();
	
	if (__numberology_cache.b == b && __numberology_cache.c == c)
	{
        //Cache lookup:
        foreach digit in desired_digits_in
        {
            if (__numberology_cache.input_to_outputs contains digit)
            {
                digit_inputs_to_outputs_out[digit] = __numberology_cache.input_to_outputs[digit];
                remove desired_digits_left[digit];
            }
            else if (__numberology_cache.input_deltas contains digit)
            {
                digit_inputs_to_deltas_out[digit] = __numberology_cache.input_deltas[digit];
                remove desired_digits_left[digit];
            }
        }
	}
	if (desired_digits_left.count() == 0)
		return;
    
	int last_x = -1;
    //Brute force method:
	for x from 0 to 99
	{
		int v = x * b + c;
		int last_two_digits = v % 100;
		if (desired_digits_left contains last_two_digits)
		{
			remove desired_digits_left[last_two_digits];
			remove digit_inputs_to_deltas_out[last_two_digits];
			digit_inputs_to_outputs_out[last_two_digits] = x;
			if (desired_digits_left.count() == 0)
			{
				last_x = x;
				break;
			}
		}
		foreach digit in desired_digits_left
		{
			int delta = digit - last_two_digits;
			if (delta <= 0)
				digit_inputs_to_deltas_out[digit] = min(digit_inputs_to_deltas_out[digit], -delta);
			else
			{
				delta = digit - (last_two_digits + 100);
				if (delta <= 0)
                    digit_inputs_to_deltas_out[digit] = min(digit_inputs_to_deltas_out[digit], -delta);
			}
		}
	}
	
	//Save cache:
	if (__numberology_cache.b != b || __numberology_cache.c != c)
		__numberology_cache = NumberologyCacheStateMake();
	__numberology_cache.b = b;
	__numberology_cache.c = c;
	foreach input, output in digit_inputs_to_outputs_out
		__numberology_cache.input_to_outputs[input] = output;
	foreach input, delta in digit_inputs_to_deltas_out
		__numberology_cache.input_deltas[input] = delta;
}
void SCalculateUniverseGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$skill[Calculate the Universe].skill_is_usable())
        return;
    int uses_remaining = 1;
    if (get_property_boolean("_universeCalculated"))
        return;
    if (true)
    {
        int universe_calculated = get_property_int("_universeCalculated");
        int limit = 1;
        int skill_number = get_property_int("skillLevel144");
        limit = max(skill_number, limit);
        if (universe_calculated >= limit)
            return;
        uses_remaining = limit - universe_calculated;
    }
    
    string [int] description;
    
    string [int] useful_digits_and_their_reasons;
    if (__setting_enable_outputting_all_numberology_options)
    {
        for digit from 0 to 99
        {
            if (!($ints[24,25,26,28,29,31,32,39,41,42,46,52,53,54,55,56,59,60,61,62,64,65,67,72,73,74,76,79,80,81,82,84,85,86,91,92,94,95,96] contains digit)) //Try Again
                useful_digits_and_their_reasons[digit] = "";
        }
    }
    //Set up useful digits:
    if (my_path_id() != PATH_SLOW_AND_STEADY)
        useful_digits_and_their_reasons[69] = "+3 adventures";
    if (hippy_stone_broken())
        useful_digits_and_their_reasons[37] = "+3 fights";
    if (__misc_state["in run"])
    {
        if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues") && !__quest_state["Level 12"].finished)
            useful_digits_and_their_reasons[51] = "War frat orc to YR";
        useful_digits_and_their_reasons[14] = "1400 meat (autosell 14 moxie weeds)";
        
        int ice_cubes_needing_creation = $item[perfect ice cube].available_amount();
        if ($skill[Perfect Freeze].skill_is_usable() && !get_property_boolean("_perfectFreezeUsed"))
            ice_cubes_needing_creation += 1;
        if (ice_cubes_needing_creation > 0 && $items[bottle of rum,bottle of vodka,boxed wine,bottle of gin,bottle of whiskey,bottle of tequila].available_amount() < ice_cubes_needing_creation && __misc_state["can drink just about anything"])
        {
            //FIXME 18, 44, 75, and 99 are all valid for this - pick whichever we can summon now?
            useful_digits_and_their_reasons[99] = "base booze for perfect ice cube";
        }
        if (__quest_state["Level 5"].mafia_internal_step < 3 && $item[Knob Goblin Perfume].available_amount() == 0 && $effect[Knob Goblin Perfume].have_effect() == 0 && in_ronin()) //have_outfit_components("Knob Goblin Harem Girl Disguise")
        {
            useful_digits_and_their_reasons[9] = "knob goblin perfume for boss fight";
        }
    }
    if (my_level() < 13)
    {
        //making a guess here - 89 is 89 mainstat with bonus experience percent (seems logical with the limited data we have)
        float mainstat_gained = 89.0 * (1.0 + numeric_modifier(my_primestat() + " experience percent") / 100.0);
        useful_digits_and_their_reasons[89] = roundForOutput(mainstat_gained, 0) + " mainstats";
    }
    
    //useful_digits_and_their_reasons[44] = "is very bad to steal jobu's rum";
    
    //Run complicated calculation code:
    boolean [int] desired_digits;
    foreach digit in useful_digits_and_their_reasons
        desired_digits[digit] = true;
    int [int] digit_inputs_to_outputs;
    int [int] digit_inputs_to_deltas;
    calculateNumberologyInputValuesForOutputs(desired_digits, digit_inputs_to_outputs, digit_inputs_to_deltas);
    
    string [int][int] table;
    table.listAppend(listMake(HTMLGenerateSpanOfClass("Enter", "r_bold"), HTMLGenerateSpanOfClass("For", "r_bold")));
    string [int][int] mappings;
    
    foreach digit, reason in useful_digits_and_their_reasons
    {
        string what_to_do;
        if (digit_inputs_to_outputs contains digit)
        {
            if (__setting_enable_outputting_all_numberology_options)
                mappings.listAppend(listMake(digit_inputs_to_outputs[digit].to_string(), digit.to_string()));
                //mappings.listAppend(digit_inputs_to_outputs[digit] + " -> " + digit);
            what_to_do = digit_inputs_to_outputs[digit].to_string();// + HTMLGenerateSpanFont(" (" + digit + ")", "gray", "0.9em");
        }
        else if (digit_inputs_to_deltas contains digit)
        {
            what_to_do = "Wait " + digit_inputs_to_deltas[digit] + " adv";
        }
        else
            what_to_do = "Unknown result to end in " + digit;
        if (reason != "")
        {
            //table.listAppend(listMake(what_to_do, reason));
            table.listAppend(listMake(what_to_do, reason + HTMLGenerateSpanFont(" (" + digit + ")", "gray", "0.9em")));
        }
    }
    
    string table_description;
    if (table.count() > 0)
        table_description += "|*" + HTMLGenerateSimpleTableLines(table);
    if (mappings.count() > 0)
    {
        //FIXME full description?
        string [int][int] mappings_final;
        //Compress mappings:
        mappings_final[0] = listMakeBlankString();
        foreach key in mappings
        {
            string [int] mapping = mappings[key];
            string [int] line = listMake(" ", mapping[0], __html_right_arrow_character, mapping[1]);
            
            if (mappings_final[mappings_final.count() - 1].count() >= 12)
                mappings_final.listAppend(listMakeBlankString());
            mappings_final[mappings_final.count() - 1].listAppendList(line);
        }
        
        
        buffer tooltip_text;
        tooltip_text.HTMLAppendTagWrap("div", "Values to input for " + __html_right_arrow_character + " output", mapMake("class", "r_bold r_centre", "style", "padding-bottom:0.25em;"));
        tooltip_text.append(HTMLGenerateSimpleTableLines(mappings_final));
        
        string line = HTMLGenerateSpanOfClass(HTMLGenerateSpanOfClass(tooltip_text, "r_tooltip_inner_class") + "Full table", "r_tooltip_outer_class");
        //we can't do full-width table entries because of colspan and display:table, so mimic it:
        //description.listAppend(line);
        //table.listAppend(listMake(line));
        if (table_description != "")
            table_description += "<hr>";
        table_description += line;
    }
    if (table_description != "")
        description.listAppend("Cast skill, enter the right number: (this changes)" + table_description);
    else
        description.listAppend("Cast skill, enter the right number.");
    
    /*if (table.count() > 1)
        description.listAppend("Cast skill, enter the right number: (this changes, and is still being spaded)|*" + HTMLGenerateSimpleTableLines(table));
    else
        description.listAppend("Cast skill, enter the right number.");*/
    string title = "Calculate the Universe";
    if (uses_remaining > 1)
        title = pluralise(uses_remaining, "Calculate the Universe", "Calculate the Universes");
    resource_entries.listAppend(ChecklistEntryMake(233, "__skill Calculate the Universe", "skillz.php", ChecklistSubentryMake(title, "", description), 0));
}
string SPVPGenerateTooltipForConsumables(string underline_text, boolean [item] consumables, string tooltip_extra_text)
{
    string tooltip_text = consumables.listInvert().listJoinComponents("<hr>");
    tooltip_text += tooltip_extra_text;

    return HTMLGenerateTooltip(underline_text, tooltip_text);
}

string SPVPGenerateTooltipForConsumables(string underline_text, boolean [item] consumables)
{
	return SPVPGenerateTooltipForConsumables(underline_text, consumables, "");
}


void SPVPGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!hippy_stone_broken())
        return;
    if (pvp_attacks_left() > 0 && today_is_pvp_season_end())
    {
        optional_task_entries.listAppend(ChecklistEntryMake(236, "__effect Swordholder", "peevpee.php?place=fight", ChecklistSubentryMake("Run all of your fights", "", listMake("Season ends today.", "Make sure to get the seasonal item if you haven't, as well."))));
    }
    
    int [string] mini_names = current_pvp_stances();
    
    ChecklistEntry entry = ChecklistEntryMake(237);
    
    
    string [int] attacking_description;
    string [int] attacking_modifiers;
    
    string [int] overall_modifiers;
    string [int] overall_description;
    foreach mini in mini_names
    {
    	string [int] modifiers;
        string [int] description;
        if (mini == "Maul Power")
        {
            if ($skill[Kung Fu Hustler].have_skill() && $effect[Kung Fu Fighting].have_effect() == 0)
                attacking_description.listPrepend("run a combat without a weapon first");
            attacking_modifiers.listAppend("weapon damage");
            continue;
        }
        else if (mini == "15 Minutes of Fame" || mini == "Beary Famous" || mini == "Upward Mobility Contest" || mini == "Optimal PvP")
        {
            //attacking_description.listAppend("hit for fame");
            attacking_description.listAppend("maximise fightgen and hit for fame");
            continue;
        }
        else if (mini == "80 Days and Counting")
        {
            description.listAppend("Drink Around the Worlds.");
            if (have_outfit_components("Hodgman's Regal Frippery"))
            {
            	if (get_property_int("_hoboUnderlingSummons") < 5)
	            	description.listAppend("Equip Hodgman's Regal Frippery, summon hobo underling, ask for a drink."); 
            }
            else if (QuestState("questL12War").mafia_internal_step == 2)
            {
            	description.listAppend("Finish the war.");
            }
            else if ($item[Spanish fly trap].available_amount() == 0)
            {
            	modifiers.listAppend("-combat");
                if ($location[Frat House].noncombat_queue.contains_text("I Just Wanna Fly") || $location[The Orcish Frat House (Bombed Back to the Stone Age)].noncombat_queue.contains_text("Me Just Want Fly"))
                {
                    description.listAppend("Run -combat in The Obligatory Pirate's Cove, acquire Spanish fly trap.");
                }
            	else
             	   description.listAppend("Adventure in the Orcish Frat House until you meet the I Just Wanna Fly adventure.|Then run -combat in The Obligatory Pirate's Cove, acquire Spanish fly trap.");
            }
            else
            {
                string [int] tasks;
            	if ($item[Spanish fly trap].equipped_amount() == 0)
                {
                	tasks.listAppend("equip Spanish fly trap");
                }
                modifiers.listAppend("+item");
                tasks.listAppend("adventure in the Hippy Camp, collecting spanish flies");// + (my_level() >= 9 ? " (+combat)" : ""));
                if ($item[Spanish fly].available_amount() >= 5)
                	tasks.listAppend("turn in " + pluralise($item[Spanish fly]) + " in the orcish frat house (-combat)");
                description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            }
        }
        else if (mini == "Totally Optimal")
        {
        	if (__quest_state["Level 11 Ron"].state_int["protestors remaining"] > 0)
                description.listAppend("Fight zeppelin protestors, and don't try to speed them up.");
            else
        		description.listAppend("Ascend to fight more Zeppelin Protestors.");
        }
        else if (mini == "Optimal Drinking")
        {
        	if (inebriety_limit() == 0)
            	description.listAppend("Ascend a path you can drink on.");
            else
	        	description.listAppend("When drinking, prefer drinks that have effects.");
        }
        else if (mini == "Nog Lover" || mini == "Nog Lover ") //it has a space at the end?
        {
        	if (inebriety_limit() == 0)
            	description.listAppend("Ascend a path you can drink on.");
            else
            {
                boolean [item] consumables = $items[eggnog, spooky eggnog, nanite-infested eggnog, gamma nog, green eggnog, oozenog, robin nog, haunted eggnog];

	        	description.listAppend(SPVPGenerateTooltipForConsumables("Drink eggnog.", consumables));
            }
        }
        else if (mini == "What's in the Basket?")
        {
        	if (fullness_limit() == 0)
            	description.listAppend("Ascend a path you can eat on.");
            else
            {
                boolean [item] consumables = $items[Boris's key lime pie,Jarlsberg's key lime pie,Sneaky Pete's key lime pie,digital key lime,star key lime,digital key lime pie,star key lime pie];

	        	description.listAppend(SPVPGenerateTooltipForConsumables("Eat key lime pie.", consumables));
            }
        }
        else if (mini == "Briniest Liver")
        {
        	if (inebriety_limit() == 0)
            	description.listAppend("Ascend a path you can drink on.");
            else
            {
                boolean [item] consumables = $items[Alewife&trade; Ale, dew yoana lei, dew yoana salacious lei, lychee chuhai, salacious lychee chuhai, salacious screwdiver, salinated mint julep, screwdiver, slug of vodka, slug of rum, slug of shochu];

	        	description.listAppend(SPVPGenerateTooltipForConsumables("Drink drinks that give the Brined Liver effect.", consumables));
                description.listAppend("Possibly use mayozapine if you have that IOTM.");
            }
        }
        else if (mini == "Hibernation Preparation")
        {
        	modifiers.listAppend("+familiar experience");
        	description.listAppend("Gain as much familiar experience as possible.|Ideally, run +familiar experience against free fights.");
        }
        else if (mini == "Familiar Rotation")
        {
        	if (in_ronin())
	        	description.listAppend("Pick a different familiar than your last ascensions this season.");
            else
                description.listAppend("Ascend to rotate your familiar.");
        }
        else if (mini == "Foreigner Reference")
        {
            description.listAppend("Drink ice-cold Sir Schlitzs or ice-cold Willers." + (in_ronin() ? "|The Orcish Frat House has them. Run +400% item" + (my_level() >= 9 ? " and +15% combat." : "") : ""));
        }
        else if (mini == "Best Served Repeatedly")
        {
            description.listAppend("Attack the same target repeatedly. Ideally, lose.");
        }
        else if (mini == "Burrowing Deep" || mini == "Obviously Optimal" || mini == "Gargle Blaster Collector" || mini == "Holiday Shopping")
        {
        	if (__misc_state_int["Basement Floor"] > 400)
            {
            	description.listAppend("Ascend to basement more.");
            }
            else if (__misc_state_int["Basement Floor"] <= 1) //this test could be better
            {
            	description.listAppend("Unlock Fernswarthy's basement via your guild.");
            }
            else
            {
            	int floors_remaining = 200 - __misc_state_int["Basement Floor"];
                if (floors_remaining < 0)
                	floors_remaining = 400 - __misc_state_int["Basement Floor"];
	            description.listAppend("Collect a Pan-Dimensional Gargle Blaster from Fernswarthy's basement. " + pluraliseWordy(floors_remaining, "floor", "floors") + " to go.");
            }
        }
        else if (mini == "Frostily Ephemeral" || mini == "Newest Born" || mini == "SELECT asc_time FROM zzz_players WHERE player_id=%playerid%" || mini == "Optimal Ascension" || mini  == "Freshman Rule!")
        {
            description.listAppend("Ascend to reset timer.");
        }
        else if (mini == "Karrrmic Battle" || mini == "Karmic Battle" || mini == "On the Nice List" || mini == "Lifelong Learning")
        {
            description.listAppend("Ascend to gain more karma.");
        }
        else if (mini == "Back to Square One")
        {
            description.listAppend("Ascend.");
        }
        else if (mini == "Baker's Dozen")
        {
            description.listAppend("Adventure as often as possible in Madness Bakery.");
        }
        else if (mini == "Fahrenheit 451" || mini == "Hot for Teacher")
        {
            attacking_modifiers.listAppend("hot damage");
            attacking_modifiers.listAppend("hot spell damage");
            continue;
        }
        else if (mini == "I Like Pi")
        {
            description.listAppend("Eat key lime pies.");
        }
        else if (mini == "School Lunch")
        {
            description.listAppend("Eat pizza.");
        }
        else if (mini == "HTTP 301 Moved Permanently")
        {
            description.listAppend("Adventure in as many different locations as you can.");
        }
        else if (mini == "Quality Assurance")
        {
            description.listAppend("Defeat bug-phylum monsters.");
        }
        else if (mini == "Free.Willy.1993.1080p.BRRip.x265.torrent")
        {
            description.listAppend("Fight dolphins.|Farm sand dollars, turn them into dolphin whistles, and use them.");
        }
        else if (mini == "Installation Wizard")
        {
            modifiers.listAppend("+item");
            if (!canadia_available())
            {
                description.listAppend("Farm dilapidated wizard hats from copied swamp owls.|Or ascend canadia moon sign.");
            }
            else
            {
            	description.listAppend("Farm dilapidated wizard hats from swamp owls in The Weird Swamp Village.");
            }
        }
        else if (mini == "Who's the Boss?")
        {
            description.listAppend("Fight school of wizardfish in the Briny Deeps, repeatedly.|Or school of many in the The Caliginous Abyss.|Or the school of gummi piranhas in the Sweet-Ade Lake. (best)");
        }
        else if (mini == "The Chalk Dust Fiasco")
        {
            description.listAppend("Fight chalkdust wraiths in the Haunted Billiards Room, repeatedly.");
        }
        else if (mini == "Conservational Yule")
        {
            if (!canadia_available())
            {
                description.listAppend("Fight copied lumberjacks.|Or ascend canadia moon sign.");
            }
            else
            {
            	description.listAppend("Fight lumberjacks in Camp Logging Camp.");
            }
        }
        else if (mini == "Illegal Operation")
        {
            description.listAppend("Buy goofballs from the suspicious-looking guy. If they're too expensive, ascend to reset the price.");
        }
        else if (mini == "Fotoshop.CS11.Keygen.exe [legit]")
        {
            description.listAppend("Eat digital key lime pies.");
        }
        else if (mini == "Most Murderous" || mini == "Icy Revenge")
        {
        	//FIXME list
            description.listAppend("Defeat once/ascension bosses.");
        }
        else if (mini == "Grave Robbery" || mini == "Bear Hunter")
        {
        	if ($item[wand of nagamar].available_amount() > 0)
				description.listAppend("Ascend.");
            else
                description.listAppend("Avoid making the wand of nagamar, lose to the naughty sorceress (3), and look for the wand in the very unquiet garves");
        }
        else if (mini == "Basket Reaver")
        {
        	if (my_level() < 11)
            {
            	description.listAppend("Level up.");
            }
            else
            {
                modifiers.listAppend("+5% combat");
                modifiers.listAppend("olfact black widow");
                modifiers.listAppend("+item");
                description.listAppend("Run +item% and farm black widows in the black forest.");
            }
        }
        else if (mini == "Rule 42")
        {
        	if ($location[the Haunted Bathroom].noncombat_queue.contains_text("Off the Rack")) //not perfect
         		continue;   
        	modifiers.listAppend("-combat");
            if ($location[the Haunted Bathroom].locationAvailable())
	            description.listAppend("Collect a towel in the Haunted Bathroom.");
            else
                description.listAppend("Unlock the Haunted Bathroom in Spookyraven Manor.");
        }
        else if (mini == "Tea for 2, 3, 4 or More")
        {
        	boolean [item] consumables = $items[Corpse Island iced tea,cup of lukewarm tea,cup of &quot;tea&quot;,hippy herbal tea,Ice Island Long Tea,New Zealand iced tea];
            
            description.listAppend(SPVPGenerateTooltipForConsumables("Drink tea.", consumables, "<hr>Cheapest is cup of lukewarm tea.<hr>Hippy herbal tea is guano coffee cup (bat guano, batrat, batrat burrow) + herbs (hippy store)."));
        }
        else if (mini == "Scurvy Challenge")
        {
            boolean [item] consumables = $items[grapefruit,kumquat,lemon,lime,orange,pixel lemon,sea tangelo,tangerine,vinegar-soaked lemon slice];
            
            description.listAppend(SPVPGenerateTooltipForConsumables("Eat fruit.", consumables, "<hr>Check the hippy store, on the island."));
        }
        else if (mini == "Raw Carnivorery")
        {
        	//FIXME This could be dynamic, I bet the game is dynamic.
            boolean [item] meat = $items[beefy fish meat, glistening fish meat, slick fish meat, &quot;meat&quot; stick, raw mincemeat, alien meat, dead meat bun, consummate meatloaf, VYKEA meatballs];
            
            string [int] entries;
            foreach it in meat
            {
            	string entry = it;
                if (entries.count() == 0) entry = entry.capitaliseFirstLetter();
            	if (it.fullness == 1)
                	entry = HTMLGenerateSpanOfClass(entry, "r_bold");
                entries.listAppend(entry);
            }
            
            string tooltip_text = entries.listJoinComponents("<hr>");
            
            description.listAppend(HTMLGenerateTooltip("Eat meat.", tooltip_text));
        }
        else if (mini == "That Britney Spears Number")
        {
        	string [int] tasks;
            if ($item[wooden stakes].available_amount() == 0)
            {
                description.listAppend("Adventure in the Spooky Forest, collect wooden stakes from the noncombat.");
                description.listAppend("Follow the old road " + __html_right_arrow_character + " Knock on the cottage door.");
                modifiers.listAppend("-combat");
            }
            else
            {
                if ($item[wooden stakes].equipped_amount() == 0)
                {
                    tasks.listAppend("equip wooden stakes");
                }
                modifiers.listAppend("olfact spooky vampire");
                tasks.listAppend("fight vampires in the Spooky Forest");
                description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            }
        }
        else if (mini == "The Purity is Right" || mini == "Polar Envy" || mini == "Purity" || mini == "An Open Mind")
        {
            attacking_description.listAppend("run zero effects");
            continue;
        }
        else if (mini == "Purrrity")
        {
            attacking_description.listAppend("run zero effects with R in their name");
            continue;
        }
        else if (mini == "The Optimal Stat")
        {
            attacking_modifiers.listAppend("+item drop");
            continue;
        }
        else if (mini == "A Nice Cold One" || mini == "Thirrrsty forrr Booze" || mini == "Holiday Spirit(s)!")
        {
            attacking_modifiers.listAppend("+booze drop");
            continue;
        }
        else if (mini == "Smellin' Like a Stinkin' Rose" || mini == "Peace on Earth")
        {
            attacking_modifiers.listAppend("-combat");
            continue;
        }
        else if (mini == "Ready to Melt")
        {
            attacking_modifiers.listAppend("hot damage");
            attacking_modifiers.listAppend("hot spell damage");
            continue;
        }
        else if (mini == "Zero Tolerance")
        {
        	description.listAppend("Don't drink booze.");
        }
        else if (mini == "Biggest Fruitcake")
        {
        	description.listAppend("Eat cake and fruit.");
        }
        else if (mini == "Visiting the Cousins" || mini == "Visiting The Co@^&$`~")
        {
        	if (knoll_available())
                description.listAppend("Adventure in the bugbear pens.");
            else
				description.listAppend("Ascend knoll moon sign.");
        }
        else if (mini == "Craft Brew is Optimal")
        {
            if (gnomads_available())
                description.listAppend("Drink from the Gnomish Microbrewery.");
            else
                description.listAppend("Ascend Gnomish moon sign.");
        }
        else if (mini == "Who Runs Bordertown?" || mini == "Spirit of Gnoel")
        {
        	if (gnomads_available())
                description.listAppend("Adventure in the Thugnderdome.");
            else
                description.listAppend("Ascend Gnomish moon sign.");
        }
        else if (mini == "Pirate Wars!")
        {
        	description.listAppend("Fight pirates, but not too many; the count resets every day.");
        }
        else if (mini == "Bilge Hunter")
        {
            description.listAppend("Run +300 ML and +combat, and fight drunken rat kings in the Typical Tavern basement.");
            modifiers.listAppend("+300 ML");
            modifiers.listAppend("+combat");
        }
        else if (mini == "Death to Ninja!")
        {
        	string [int] tasks;
            if (!is_wearing_outfit("Swashbuckling Getup"))
            	tasks.listAppend("equip swashbuckling getup");
            tasks.listAppend("fight ninja");
            description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        }
        else if (mini == "Swimming with the Fishes")
        {
            description.listAppend("Spend turns underwater.");
        }
        else if (mini == "(Fur) Shirts and Skins")
        {
            description.listAppend("Collect furs and skins from monsters. (+item)|The icy peak? Olfact yeti.");
        }
        else if (mini == "With Your Bare Hands")
        {
            description.listAppend("Fight beast-type monsters without a weapon equipped.|The icy peak (olfact yeti) or the dire warren?");
        }
        else if (mini == "Daily Optimizer")
        {
            description.listAppend("Run +adventures gear at rollover.");
        }
        else if (mini == "Northern Digestion" || mini == "Frozen Dinners")
        {
        	if (canadia_available())
            {
            	if (availableFullness() > 0)
	                description.listAppend("Eat in Chez Snote.");
            }
            else
                description.listAppend("Ascend canadia moon sign.");
        }
        else if (mini == "ERR_VOLUME_FULL")
        {
            description.listAppend("Don't eat anything.");
        }
        else if (mini == "Really Bloody")
        {
        	if (inebriety_limit() == 0)
    	        description.listAppend("Ascend to drink Bloody Mary.");
            else
	            description.listAppend("Drink Bloody Mary.");
        }
        else if (mini == "System Clock Reset: It's 2006 again!")
        {
            if (inebriety_limit() == 0)
                description.listAppend("Ascend to drink White Canadians.");
            else
                description.listAppend("Drink White Canadians.");
        }
        else if (mini == "Liver of the Damned")
        {
            if (inebriety_limit() == 0)
                description.listAppend("Ascend to drink cursed bottles of rum.");
            else
                description.listAppend("Drink cursed bottles of rum.");
            description.listAppend("Run -combat at the Poop Deck, set an open course to 1,1, open the cursed chests.");
            modifiers.listAppend("-combat");
        }
        else if (mini == "Beast Master")
        {
            attacking_modifiers.listAppend("familiar weight");
            continue;
        }
        else if (mini == "Letter of the Moment" || mini == "Spirit Day")
        {
            attacking_modifiers.listAppend("letter of the moment");
            continue;
        }
        else if (mini == "ASCII-7 of the moment")
        {
            attacking_modifiers.listAppend("letter <strong>a</strong> in equipment");
            continue;
        }
        else if (mini == "Spirit of Noel")
        {
            attacking_modifiers.listAppend("letter <strong>L</strong> in equipment");
            continue;
        }
        else if (mini == "Barely Dressed")
        {
            attacking_description.listAppend("do not equip equipment");
            continue;
        }
        else if (mini == "DEFACE")
        {
            attacking_description.listAppend("wear equipment with A/B/C/D/E/F/numbers in them");
            continue;
        }
        else if (mini == "Dressed to the 9s")
        {
            attacking_description.listAppend("wear equipment with numbers in them");
            continue;
        }
        else if (mini == "Most Unbalanced")
        {
            attacking_description.listAppend("maximise mainstat, minimise off-stats");
            continue;
        }
        else if (mini == "Well-Rounded")
        {
            attacking_description.listAppend("maximise off-stats");
            continue;
        }
        else if (mini == "School Pride")
        {
            attacking_description.listAppend("wear high-power shirt/hat/pants");
            continue;
        }
        else if (mini == "Optimal Dresser" || mini == "Lightest Load")
        {
            attacking_description.listAppend("wear low-power shirt/hat/pants");
            continue;
        }
        else if (mini == "Dressed in Rrrags" || mini == "Outfit Compression")
        {
            attacking_description.listAppend("wear short-named equipment");
            continue;
        }
        else if (mini == "Verbosity Demonstration")
        {
            attacking_description.listAppend("wear long-named equipment");
            continue;
        }
        else if (mini == "Hibernation Ready" || mini == "All Bundled Up")
        {
            attacking_modifiers.listAppend("cold resistance");
            continue;
        }
        else if (mini == "Loot Hunter" || mini == "The Optimal Stat")
        {
            attacking_modifiers.listAppend("+item");
            continue;
        }
        else if (mini == "Safari Chic")
        {
            attacking_modifiers.listAppend("equipment autosell value");
            continue;
        }
        else if (mini == "Checking It Twice")
        {
            attacking_description.listAppend("target players you haven't fought twice");
            continue;
        }
        else if (mini == "Ice Hunter")
        {
            description.listAppend("Fight ice skates. Either fax/wish/copy them, or olfact them in the The Skate Park underwater.");
        }
        else if (mini == "Bearly Legal")
        {
        	modifiers.listAppend("+meat");
            description.listAppend("Fight Mer-kin Miners with +meat. Either fax/wish/copy them, or olfact them in the Anemone Mine underwater.");
        }
        else if (mini == "Bear Hugs All Around" || mini == "Sharing the Love (to stay warm)" || mini == "Fair Game")
        {
            description.listAppend("Maximise fightgen, attack as many unique opponents as possible.");
        }
        else if (mini == "Most Things Eaten")
        {
        	string line = "Eat as many one-fullness foods as possible.";
            if (get_campground()[$item[portable mayo clinic]] > 0 && availableDrunkenness() > 0)
                line += "|Also use mayodiol.";
            description.listAppend(line);
        }
        else if (mini == "Creative Holiday Feasting")
        {
            description.listAppend("Eat as many unique foods as possible, ideally 1-fullness.");
        }   
    	else if (mini == "Getting in the Holiday Spirits")
        {
            description.listAppend("Drink as many one-inebriety drinks as possible.");
        }   
        else if (mini == "What is it Good For?" || mini == "Beta Tester" || mini == "Optimal War" || mini == "Decisions, decisions?")
        {
            if (__quest_state["Level 12"].finished)
            {
                description.listAppend("Ascend to fight in war.");
            }
            else if (!__quest_state["Level 12"].started)
            {
                description.listAppend("Start the war.");
            }
            else
            {
            	if (mini == "Beta Tester" || mini == "Optimal War")
                {
                	description.listAppend("Finish the war for the frat side, with five sidequests completed. (iron beta of industry reward)");
                }
                else if (mini == "Snow Patrol")
                {
                    modifiers.listAppend("+4 cold res");
                    string line = "Fight on the battlefield";
                    if (numeric_modifier("cold resistance") < 4)
                        line += HTMLGenerateSpanFont(" with +4 cold resistance", "red");
                    line += ".";
                    description.listAppend(line);
                }
                else if (mini == "What is it Good For?" || mini == "Decisions, decisions?")
                {
                	description.listAppend("Spend as many turns in the war as possible.");
                }
            }
        }
        else
        {
            description.listAppend(HTMLGenerateSpanFont("Unknown mini \"" + mini + "\".", "red"));
        }
        overall_modifiers.listAppendList(modifiers);
        if (description.count() > 0)
	        overall_description.listAppend(description.listJoinComponents("|*"));
        //entry.subentries.listAppend(ChecklistSubentryMake(mini, modifiers, description));
    }
    if (overall_description.count() > 0)
    {
    	entry.subentries.listAppend(ChecklistSubentryMake("Work on PVP minis", overall_modifiers, overall_description));
    }
    if (attacking_modifiers.count() > 0)
    	attacking_description.listAppend("maximise " + attacking_modifiers.listJoinComponents(" / "));
    if (attacking_description.count() > 0)
    {
        entry.subentries.listAppend(ChecklistSubentryMake("When attacking", attacking_modifiers, attacking_description.listJoinComponents(", ", "and ").capitaliseFirstLetter() + "."));
    }
    
    if (entry.subentries.count() > 0)
    {
        entry.image_lookup_name = "__effect Swordholder";
        entry.url = "peevpee.php";
        entry.importance_level = 10;
        entry.ChecklistEntrySetAbridgedHeader(pluralise(pvp_attacks_left(), "PVP fight", "PVP fights"));
        optional_task_entries.listAppend(entry);
    }
}
//demonSummoned
RegisterResourceGenerationFunction("SDemonSummonGenerateResource");
void SDemonSummonGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!QuestState("questL11Manor").finished)
        return;
    if (get_property_boolean("demonSummoned"))
        return;
    //thin black candle >= 3
    //scroll of ancient forbidden unspeakable evil
    //FIXME suggest running intergnat?
    
    if ($item[thin black candle].available_amount() >= 3 && $item[scroll of ancient forbidden unspeakable evil].available_amount() + $item[scroll of ancient forbidden unspeakable evil].creatable_amount() > 0)
    {
        string [int] description;
        string url = "place.php?whichplace=manor4&action=manor4_chamber";
        
        if ($item[thin black candle].item_amount() < 3 && $item[thin black candle].available_amount() >= 3)
        {
            description.listAppend("Pull 3 thin black candles.");
            url = "";
        }
        if ($item[scroll of ancient forbidden unspeakable evil].available_amount() == 0 && $item[scroll of ancient forbidden unspeakable evil].creatable_amount() > 0)
        {
            description.listAppend("Create a scroll of scroll of ancient forbidden unspeakable evil.");
            url = "";
        }
        
        string [int][int] john;
        //Prenatural greed.
        string [string] demons;
        demons["demonName2"] = "+100% meat";
        if ($familiar[intergnat].familiar_is_usable() && in_ronin())
        {
            if (!get_property("demonName12").contains_text("Neil")) //FIXME what if neil is on their friends list?
            {
                description.listAppend("Could run intergnat for demon name.");
            }
            else
            {
                if (my_level() == 11)
                {
                    if (__dense_liana_machete_items.available_amount() == 0)
                        demons["demonName12"] += "Antique machete, tomb ratchet, and cigarette lighter.";
                    else
                        demons["demonName12"] += "Tomb ratchet, and cigarette lighter.";
                }
                else if (my_level() == 12)
                {
                    if ($items[richard's star key,star chart].available_amount() == 0)
                        demons["demonName12"] += "Star chart.";
                }
                else if (my_level() == 13)
                    demons["demonName12"] += "+50% init buff.";
                else
                    demons["demonName12"] += "1000 meat.";
                if (demons["demonName12"] != "")
                    demons["demonName12"] += "|";
                demons["demonName12"] += "+10% item, +20% meat, +50% init, +spell/weapon damage buff.";
                if (my_familiar() != $familiar[intergnat])
                    demons["demonName12"] += "|Make sure to switch to your intergnat familiar before summoning.";
            }
        }
        //Intergnat.
        
        foreach property, description in demons
        {
            string property_value = get_property(property);
            if (property_value == "")
                continue;
            john.listAppend(listMake(property_value, description));
        }
        
        if (john.count() > 0)
            description.listAppend(HTMLGenerateSimpleTableLines(john));
        
        resource_entries.listAppend(ChecklistEntryMake(219, "__item thin black candle", url, ChecklistSubentryMake("Demon summonable", "", description), 7));
    }
}
RegisterTaskGenerationFunction("SAreaUnlocksGenerateTasks");
void SAreaUnlocksGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__misc_state["desert beach available"] && __misc_state["in run"] && my_path_id() != PATH_NUCLEAR_AUTUMN)
	{
        string url;
		ChecklistSubentry subentry;
        boolean optional = false;
		subentry.header = "Unlock desert beach";
        boolean [location] relevant_locations;
        if (my_path_id() == PATH_COMMUNITY_SERVICE)
        {
            subentry.header = "Optionally unlock desert beach";
            subentry.entries.listAppend("Not needed to finish path.");
            optional = true;
        }
        if (my_path_id() == PATH_NUCLEAR_AUTUMN)
        {
            subentry.entries.listAppend("Wait until level eleven, which will unlock it autumnaically.");
        }
		else if (!knoll_available())
		{
            relevant_locations[$location[the degrassi knoll garage]] = true;
			string meatcar_line = "Build a bitchin' meatcar.";
			if ($item[bitchin' meatcar].creatable_amount() > 0)
				meatcar_line += "|*You have all the parts, build it!";
			else
			{
				item [int] missing_parts_list = missingComponentsToMakeItem($item[bitchin' meatcar]);
                boolean [item] missing_parts = missing_parts_list.listInvert();
                
                //Tires - 100% drop - Gnollish Tirejuggler in The Degrassi Knoll Garage
                //empty meat tank, cog, spring, sprocket - Gnollish toolbox - Gnollish Gearhead in The Degrassi Knoll Garage
                //
                string [int] meatcar_modifiers;
                if (missing_parts[$item[empty meat tank]] || missing_parts[$item[cog]] || missing_parts[$item[spring]] || missing_parts[$item[sprocket]])
                {
                    meatcar_modifiers.listAppend("+34% item");
                    meatcar_modifiers.listAppend("olfact gnollish gearhead");
                }
                
                    
                meatcar_modifiers.listAppend("banish guard bugbear");
                    
                if (meatcar_modifiers.count() > 0)
                    meatcar_line += "|*" + ChecklistGenerateModifierSpan(meatcar_modifiers);
				
				meatcar_line += "|*Parts needed: " + missing_parts_list.listJoinComponents(", ", "and") + ".";
                if (missing_parts[$item[tires]] || missing_parts[$item[empty meat tank]] || missing_parts[$item[cog]] || missing_parts[$item[spring]] || missing_parts[$item[sprocket]])
                    meatcar_line += " (found in the degrassi knoll garage?)";
			}
			subentry.entries.listAppend(meatcar_line);
			
            if (my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST)
                subentry.entries.listAppend("Or buy a desert bus pass. (5000 meat)");
			if ($item[pumpkin].available_amount() > 0)
				subentry.entries.listAppend("Or build a pumpkin carriage.");
            if ($items[can of Br&uuml;talbr&auml;u,can of Drooling Monk,can of Impetuous Scofflaw,fancy tin beer can].available_amount() > 0)
				subentry.entries.listAppend("Or build a tin lizzie.");
            url = "place.php?whichplace=knoll_hostile";
		}
		else
		{
            url = "shop.php?whichshop=gnoll";
			int meatcar_price = $item[spring].npc_price() + $item[sprocket].npc_price() + $item[cog].npc_price() + $item[empty meat tank].npc_price() + 100 + $item[tires].npc_price() + $item[sweet rims].npc_price() + $item[spring].npc_price();
			subentry.entries.listAppend("Build a bitchin' meatcar. (" + meatcar_price + " meat)");
		}
		
        ChecklistEntry entry = ChecklistEntryMake(266, "__item bitchin' meatcar", url, subentry, relevant_locations);
        if (optional)
            optional_task_entries.listAppend(entry);
        else
            task_entries.listAppend(entry);
	}
	else if (!__misc_state["mysterious island available"] && __misc_state["in run"])
	{
		ChecklistSubentry subentry;
		subentry.header = "Unlock mysterious island";
		if (my_path_id() == PATH_COMMUNITY_SERVICE)
        {
        	subentry.header += "?";
            subentry.entries.listAppend("Or not...?");
        }
        
        string url;
        boolean suggest_hippy_alternative = false;
        if (my_path_id() == PATH_NUCLEAR_AUTUMN)
        {
            suggest_hippy_alternative = true;
        }
        
        
        if (!(my_path_id() == PATH_NUCLEAR_AUTUMN && in_hardcore()))
        {
            if (__misc_state["desert beach available"])
                url = "place.php?whichplace=desertbeach";
            int scrip_number = $item[Shore Inc. Ship Trip Scrip].available_amount();
            int trips_needed = MAX(0, 3 - scrip_number);
            
            if ($item[dinghy plans].available_amount() > 0)
            {
                if ($item[dingy planks].available_amount() > 0)
                {
                    url = "inventory.php?which=3";
                    subentry.entries.listAppend("Use dinghy plans.");
                }
                else
                {
                    if (my_path_id() == PATH_NUCLEAR_AUTUMN)
                    {
                        subentry.entries.listAppend("Pull dingy planks, then build dinghy dinghy.");
                    }
                    else
                    {
                        url = "shop.php?whichshop=generalstore";
                        subentry.entries.listAppend("Buy dingy planks, then build dinghy dinghy.");
                    }
                }
                    
            }
            else if (trips_needed > 0)
            {
                int trip_adventure_cost = 3;
                int trip_meat_cost = 500;
                if (my_path_id() == PATH_WAY_OF_THE_SURPRISING_FIST)
                {
                    trip_adventure_cost = 5;
                    trip_meat_cost = 5;
                }
                string line_string = "Shore, " + (trip_adventure_cost * trips_needed) + " adventures";
                if (!__misc_state["desert beach available"])
                    line_string += ", once the desert beach is unlocked";
                line_string += ".";
                int meat_needed = trip_meat_cost * trips_needed;
                if (my_meat() < meat_needed)
                    line_string += "|Need " + meat_needed + " meat for vacations, have " + my_meat() + ".";
                subentry.entries.listAppend(line_string);
                if ($item[skeleton].available_amount() > 0)
                    subentry.entries.listAppend("Skeletal skiff?");
            }
            else
            {
                url = "shop.php?whichshop=shore";
                subentry.entries.listAppend("Redeem scrip at shore for dinghy plans.");
            }
        }
        if (suggest_hippy_alternative)
        {
            string line_string = "Or try";
            if (my_path_id() == PATH_NUCLEAR_AUTUMN && in_hardcore())
                line_string = "Try";
            line_string += " the hippy quest in the woods";
            if (my_basestat(my_primestat()) < 25)
                line_string += ", once your mainstat reaches 25";
            else if (url == "")
                url = "place.php?whichplace=woods";
            line_string += ".";
            if (my_path_id() != PATH_NUCLEAR_AUTUMN)
                line_string += " (probably slower?)";
            subentry.entries.listAppend(line_string);
        }
        if (my_path_id() == PATH_NUCLEAR_AUTUMN && ($familiar[ms. puck man].familiar_is_usable() || $familiar[puck man].familiar_is_usable()))
        {
            string line = "Or build a yellow submarine.";
            string [int] missing_components = $item[yellow submarine].missingComponentsToMakeItemInHumanReadableFormat();
            if (missing_components.count() > 0)
                line += " Need " + missing_components.listJoinComponents(", ", "and") + ".";
            subentry.entries.listAppend(line);
        }
        
        if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && get_property("peteMotorbikeGasTank").length() == 0)
            subentry.entries.listAppend("Possibly upgrade your motorcycle's gas tank. (extra-buoyant)");
        
        
		ChecklistEntry entry = ChecklistEntryMake(267, "__item dingy dinghy", url, subentry, $locations[the shore\, inc. travel agency]);
        if (my_path_id() == PATH_COMMUNITY_SERVICE)
        	optional_task_entries.listAppend(entry);
        else
        	task_entries.listAppend(entry);
        
	}
}
RegisterTaskGenerationFunction("SPowerlevelGenerateTasks");
void SPowerlevelGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (__misc_state["need to level"] && my_path_id() != PATH_EXPLOSION)
	{
        string url = "";
		int mcd_max_limit = 10;
		boolean have_mcd = false;
		if (canadia_available() || knoll_available() || gnomads_available() && __misc_state["desert beach available"] || in_bad_moon())
			have_mcd = true;
        if (canadia_available())
        {
            mcd_max_limit = 11;
            url = "place.php?whichplace=canadia&action=lc_mcd";
        }
        else if (knoll_available())
        {
            if ($item[detuned radio].available_amount() > 0)
                url = "inventory.php?which=3";
            else
                url = "shop.php?whichshop=gnoll";
        }
        else if (gnomads_available())
            url = "gnomes.php?place=machine";
        //FIXME URLs for the other ones
		if (current_mcd() < mcd_max_limit && have_mcd && monster_level_adjustment() < 150 && !in_bad_moon() && !(my_path_id() == PATH_G_LOVER && knoll_available()))
		{
			optional_task_entries.listAppend(ChecklistEntryMake(264, "__item detuned radio", url, ChecklistSubentryMake("Set monster control device to " + mcd_max_limit, "", roundForOutput(mcd_max_limit * __misc_state_float["ML to mainstat multiplier"], 2) + " mainstats/turn")));
		}
	}
    
	if (__misc_state["need to level"] && my_path_id() != PATH_COMMUNITY_SERVICE)
	{
		ChecklistSubentry subentry;
		
		int main_substats = my_basestat(my_primesubstat());
		int substats_remaining = substatsForLevel(my_level() + 1) - main_substats;
		
		subentry.header = "Level to " + (my_level() + 1);
		
		subentry.entries.listAppend("Gain " + pluralise(substats_remaining, "substat", "substats") + ".");
        
        string url = "";
        
        boolean spooky_airport_unlocked = __misc_state["spooky airport available"];
        boolean stench_airport_unlocked = __misc_state["stench airport available"];
        
        if (__misc_state["Chateau Mantegna available"] && __misc_state_int["free rests remaining"] > 0)
            url = "place.php?whichplace=chateau";
        else if (stench_airport_unlocked && monster_level_adjustment() >= 150)
            url = $location[Uncle Gator's Country Fun-Time Liquid Waste Sluice].getClickableURLForLocation();
        else if (spooky_airport_unlocked && ($effect[jungle juiced].have_effect() > 0 || ($item[jungle juice].available_amount() > 0 && availableDrunkenness() > 0 && __misc_state["can drink just about anything"])))
            url = $location[the deep dark jungle].getClickableURLForLocation();
        else if (__misc_state["Chateau Mantegna available"])
            url = "place.php?whichplace=chateau";
        else if (__misc_state["sleaze airport available"])
            url = $location[sloppy seconds diner].getClickableURLForLocation();
        else if (spooky_airport_unlocked)
            url = $location[the deep dark jungle].getClickableURLForLocation();
        else if ($item[GameInformPowerDailyPro walkthru].available_amount() > 0)
            url = $location[video game level 1].getClickableURLForLocation();
        else if (my_primestat() == $stat[muscle] && $location[the haunted billiards room].locationAvailable())
            url = $location[the haunted gallery].getClickableURLForLocation();
        else if (my_primestat() == $stat[mysticality] && $location[the haunted bedroom].locationAvailable())
            url = $location[the haunted bathroom].getClickableURLForLocation();
        else if (my_primestat() == $stat[moxie] && $location[the haunted bedroom].locationAvailable())
            url = $location[the haunted ballroom].getClickableURLForLocation();
            
        
        //133.33333333333333 meat per stat
        int maximum_allowed_to_donate = 10000 * my_level();
        int cost_to_donate_for_level = ceil(substats_remaining.to_float() / 1.5) * 200.0;
        int min_cost_to_donate_for_level = ceil(substats_remaining.to_float() / 2.0) * 200.0;
        if (min_cost_to_donate_for_level <= my_meat() && min_cost_to_donate_for_level <= maximum_allowed_to_donate)
        {
            string statue_name = "";
            if (my_primestat() == $stat[muscle] && $item[boris's key].available_amount() > 0)
            {
                statue_name = "Boris";
                if (cost_to_donate_for_level < 2000 || cost_to_donate_for_level < my_meat() * 0.2)
                    url = "da.php?place=gate1";
            }
            else if (my_primestat() == $stat[mysticality] && $item[jarlsberg's key].available_amount() > 0 && my_path_id() != PATH_AVATAR_OF_JARLSBERG)
            {
                statue_name = "Jarlsberg";
                if (cost_to_donate_for_level < 2000 || cost_to_donate_for_level < my_meat() * 0.2)
                    url = "da.php?place=gate2";
            }
            else if (my_primestat() == $stat[moxie] && $item[sneaky pete's key].available_amount() > 0 && my_path_id() != PATH_AVATAR_OF_SNEAKY_PETE)
            {
                statue_name = "Sneaky Pete";
                if (cost_to_donate_for_level < 2000 || cost_to_donate_for_level < my_meat() * 0.2)
                    url = "da.php?place=gate3";
            }
                
            if (statue_name != "" && !(!in_ronin() && cost_to_donate_for_level > 20000))
            {
                buffer line = "Possibly donate ".to_buffer();
                if (cost_to_donate_for_level == min_cost_to_donate_for_level)
                    line.append(cost_to_donate_for_level);
                else
                {
                    line.append(min_cost_to_donate_for_level);
                    line.append(" to ");
                    line.append(cost_to_donate_for_level);
                }
                line.append(" meat to the statue of ");
                line.append(statue_name);
                line.append(".");
                subentry.entries.listAppend(line);
                
            }
        }
        
        
        
        string image_name = "player character";
        
        if (false)
        {
            //vertically less imposing:
            //disabled for now - player avatars look better. well, sneaky pete's avatar looks better...
            image_name = "mini-adventurer blank female";
            
            string [class] class_images;
            class_images[$class[seal clubber]] = "mini-adventurer seal clubber female";
            class_images[$class[turtle tamer]] = "mini-adventurer turtle tamer female";
            class_images[$class[pastamancer]] = "mini-adventurer pastamancer female";
            class_images[$class[sauceror]] = "mini-adventurer sauceror female";
            class_images[$class[disco bandit]] = "mini-adventurer disco bandit female";
            class_images[$class[accordion thief]] = "mini-adventurer accordion thief female";
            
            if (class_images contains my_class())
                image_name = class_images[my_class()];
        }
		
		
		task_entries.listAppend(ChecklistEntryMake(265, image_name, url, subentry, 11));
	}
}
//FIXME this should be customizable. But an interface for that would be tricky...

record PlantSuggestion
{
	location loc;
	string plant_name;
	string details;
    
    boolean no_stat_remove; //for +ML plants mainly
};

PlantSuggestion PlantSuggestionMake(location loc, string plant_name, string details)
{
	PlantSuggestion result;
	result.loc = loc;
	result.plant_name = plant_name;
	result.details = details;
	return result;
}


void listAppend(PlantSuggestion [int] list, PlantSuggestion entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}


PlantSuggestion [int] __plants_suggested_locations;

record Plant
{
	string name;
	string image_lookup_name; //auto-generated
	string zone_effect;
	string terrain;
	boolean territorial;
};

Plant PlantMake(string name, string zone_effect, string terrain, boolean territorial)
{
	Plant result;
	result.name = name;
	result.image_lookup_name = "Plant " + name;
	result.zone_effect = zone_effect;
	result.terrain = terrain;
	result.territorial = territorial;
	return result;
}
Plant [string] __plant_properties;
string [int] __plant_output_order; //MUST contain all plants


void finaliseSetUpFloristState()
{
	if (!__iotms_usable[$item[Order of the Green Thumb Order Form]])
		return;
	
	//Set up suggestions:
	//We can have this as either plants keeping track of a bunch of locations, or locations keeping track of a bunch of plants.
	//Keeping it the same as get_florist_plants makes it mentally easier to track, I guess.
	
	
	__plant_properties["Rabid Dogwood"] = PlantMake("Rabid Dogwood", "+30 ML", "outdoor", true);
	__plant_properties["Rutabeggar"] = PlantMake("Rutabeggar", "+25% item", "outdoor", true);
	__plant_properties["Rad-ish Radish"] = PlantMake("Rad-ish Radish", "+5 moxie stats/fight", "outdoor", true);
	
	__plant_properties["War Lily"] = PlantMake("War Lily", "+30 ML", "indoor", true);
	__plant_properties["Stealing Magnolia"] = PlantMake("Stealing Magnolia", "+25% item", "indoor", true);
	__plant_properties["Canned Spinach"] = PlantMake("Canned Spinach", "+5 muscle stats/fight", "indoor", true);
	
	__plant_properties["Blustery Puffball"] = PlantMake("Blustery Puffball", "+30 ML", "underground", true);
	__plant_properties["Horn of Plenty"] = PlantMake("Horn of Plenty", "+25% item", "underground", true);
	__plant_properties["Wizard's Wig"] = PlantMake("Wizard's Wig", "+5 myst stats/fight", "underground", true);
	__plant_properties["Shuffle Truffle"] = PlantMake("Shuffle Truffle", "+25% init", "underground", false);
	
	
	__plant_output_order = split_string("Rabid Dogwood,Rutabeggar,Rad-ish Radish,Artichoker,Smoke-ra,Skunk Cabbage,Deadly Cinnamon,Celery Stalker,Lettuce Spray,Seltzer Watercress,War Lily,Stealing Magnolia,Canned Spinach,Impatiens,Spider Plant,Red Fern,BamBOO!,Arctic Moss,Aloe Guv'nor,Pitcher Plant,Blustery Puffball,Horn of Plenty,Wizard's Wig,Shuffle Truffle,Dis Lichen,Loose Morels,Foul Toadstool,Chillterelle,Portlybella,Max Headshroom,Spankton,Kelptomaniac,Crookweed,Electric Eelgrass,Duckweed,Orca Orchid,Sargassum,Sub-Sea Rose,Snori,Up Sea Daisy", ",");
    
	//Go through all potentials:
	boolean [string] plants_used;
	if (true)
	{
		string [int] internal_plants_used = split_string_alternate(get_property("_floristPlantsUsed"), ",");
		foreach key in internal_plants_used
			plants_used[internal_plants_used[key]] = true;
	}
	//Shuffle Truffle - underground, init:
	if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"])
    {
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[the defiled alcove], "Shuffle Truffle", "+2.5% modern zmobie"));
	}
	//Horn of Plenty - underground, +item:
	if (__quest_state["Level 7"].state_boolean["nook needs speed tricks"] && $location[the defiled nook].item_drop_modifier_for_location() < 400.0)
	{
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[the defiled nook], "Horn of Plenty", "Evil eye, 20% drop."));
	}
	if (!__quest_state["Level 11"].finished && $location[the middle chamber].item_drop_modifier_for_location() < 400.0)
	{
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[the middle chamber], "Horn of Plenty", "Tomb ratchets, 20% drop."));
	}
	if (__quest_state["Level 4"].state_int["areas unlocked"] + $item[sonar-in-a-biscuit].available_amount() < 3)
	{
        string description = "Sonars-in-a-biscuit, 15% drop.";
        if (!__quest_state["Level 7"].state_boolean["nook finished"]) //FIXME test if that plant is planted already
            description += " Or ignore in favor of the defiled nook?";
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[the batrat and ratbat burrow], "Horn of Plenty", description));
	}
    //Intentionally ignored: +item plants in the orchard. Normally you'd plant in the upper chamber instead, since both of these quests often happen on the same day? And there's three zones to plant in - way too complicated.
	if (!__quest_state["Level 12"].finished && __misc_state["need to level"] && __quest_state["Level 12"].state_int["frat boys left on battlefield"] != 0 && __quest_state["Level 12"].state_int["hippies left on battlefield"] != 0)
	{
		location battlefield_zone = $location[the battlefield (hippy uniform)];
        if (__quest_state["Level 12"].state_int["frat boys left on battlefield"] > __quest_state["Level 12"].state_int["hippies left on battlefield"])
            battlefield_zone = $location[the battlefield (frat uniform)];
		if (my_primestat() == $stat[moxie])
			__plants_suggested_locations.listAppend(PlantSuggestionMake(battlefield_zone, "Rad-ish Radish", ""));
		else
			__plants_suggested_locations.listAppend(PlantSuggestionMake(battlefield_zone, "Rabid Dogwood", ""));
	}
	if (__misc_state["need to level mysticality"])
	{
		//Wizard's Wig - underground, +5 myst stats/fight:
        //in SC, can reach level 7 first, so ignore this one:
        //if (!__quest_state["Level 4"].finished)
            //__plants_suggested_locations.listAppend(PlantSuggestionMake($location[The Boss Bat's Lair], "Wizard's Wig", ""));
        if (!__quest_state["Level 7"].state_boolean["niche finished"])
            __plants_suggested_locations.listAppend(PlantSuggestionMake($location[The Defiled Niche], "Wizard's Wig", ""));
	}
	//Blustery Puffball - underground, +ML:
	if (__quest_state["Level 7"].state_int["cranny evilness"] > 25 + 3)
	{
        PlantSuggestion ps = PlantSuggestionMake($location[the defiled cranny], "Blustery Puffball", "More beeps from swarm of ghuol whelps.");
        ps.no_stat_remove = true;
		__plants_suggested_locations.listAppend(ps);
	}
	//Canned Spinach - indoor, +5 muscle stats/fight:
    if (my_primestat() == $stat[muscle] && __misc_state["need to level"])
    {
        //castle?
        if ($item[Spookyraven gallery key].available_amount() > 0 && !__misc_state["Stat gain from NCs reduced"])
        {
            __plants_suggested_locations.listAppend(PlantSuggestionMake($location[the haunted gallery], "Canned Spinach", "While powerlevelling."));
        }
    }
	
	//Stealing Magnolia - indoor, +item:
	//War Lily - indoor, +ML:
    if (__misc_state["need to level"])
    {
        if ((my_path_id() != PATH_PICKY || my_primestat() == $stat[moxie]) && $location[The Castle in the Clouds in the Sky (Ground Floor)].turnsAttemptedInLocation() < 11) //nightmare in picky
            __plants_suggested_locations.listAppend(PlantSuggestionMake($location[The castle in the clouds in the sky (ground floor)], "War Lily", ""));
        //Haunted bedroom?
    }
	//Rad-ish Radish - outdoor, +5 moxie stats/fight:
    if (__misc_state["need to level moxie"])
    {
        //you wouldn't plant +30ML at airship - because oil peak may need it today. FIXME suggest if oil peak done/planted? HCO I guess? I dunno
        __plants_suggested_locations.listAppend(PlantSuggestionMake($location[The Spooky Forest], "Rad-ish Radish", ""));
        __plants_suggested_locations.listAppend(PlantSuggestionMake($location[The Penultimate Fantasy Airship], "Rad-ish Radish", ""));
    }
	//Rutabeggar - outdoor, +item:
	if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0)
	{
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[a-boo peak], "Rutabeggar", "A-boo clue, 15% drop."));
	}
	
	//Rabid Dogwood - outdoor, +ML:
	if (__quest_state["Level 9"].state_float["oil peak pressure"] > 0 && monster_level_adjustment() < 100)
    {
        PlantSuggestion ps = PlantSuggestionMake($location[oil peak], "Rabid Dogwood", "");
        ps.no_stat_remove = true;
		__plants_suggested_locations.listAppend(ps);
    }
	if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && __misc_state["need to level"]) //you spend a lot of turns in the desert
		__plants_suggested_locations.listAppend(PlantSuggestionMake($location[the arid, extra-dry desert], "Rabid Dogwood", ""));
	
	//Now, go through results, and remove all plants that are already in that location:
	
	string [location][int] current_plants = get_florist_plants();
	boolean [location][string] current_plants_used; //inverse of current_plants, used for quick searching
	foreach l in current_plants
	{
		foreach key in current_plants[l]
		{
			string plant = current_plants[l][key];
			current_plants_used[l][plant] = true;
		}
	}
	
	int [int] keys_removing;
	foreach key in __plants_suggested_locations
	{
		PlantSuggestion suggestion = __plants_suggested_locations[key];
        
        boolean should_remove = false;
		if (current_plants_used[suggestion.loc][suggestion.plant_name] || plants_used[suggestion.plant_name])
		{
			should_remove = true;
		}
        else
        {
            if (suggestion.plant_name == "Rad-ish Radish" || suggestion.plant_name == "Canned Spinach" || suggestion.plant_name == "Wizard's Wig") //+stat plants
            {
                boolean area_has_ml_plant = false;
                if (current_plants_used[suggestion.loc]["Rabid Dogwood"])
                    area_has_ml_plant = true;
                if (current_plants_used[suggestion.loc]["War Lily"])
                    area_has_ml_plant = true;
                if (current_plants_used[suggestion.loc]["Blustery Puffball"])
                    area_has_ml_plant = true;
                if (area_has_ml_plant)
                    should_remove = true;
            }
            
            //opposite:
            if (suggestion.plant_name == "Rabid Dogwood" || suggestion.plant_name == "War Lily" || suggestion.plant_name == "Blustery Puffball")
            {
                boolean area_has_stat_plant = false;
                if (current_plants_used[suggestion.loc]["Rad-ish Radish"])
                    area_has_stat_plant = true;
                if (current_plants_used[suggestion.loc]["Canned Spinach"])
                    area_has_stat_plant = true;
                if (current_plants_used[suggestion.loc]["Wizard's Wig"])
                    area_has_stat_plant = true;
                if (area_has_stat_plant && !suggestion.no_stat_remove)
                    should_remove = true;
            }
            
        }
        
        if (should_remove)
            keys_removing.listAppend(key);
	}
	foreach key in keys_removing
	{
		remove __plants_suggested_locations[keys_removing[key]];
	}
}

void generateFloristFriar(Checklist [int] checklists)
{
	if (!__iotms_usable[$item[Order of the Green Thumb Order Form]])
		return;
    if (!__misc_state["in run"]) //currently, these suggestions are in-run only
        return;
	ChecklistEntry [int] florist_entries;
	
    ChecklistSubentry [int] subentries;
	foreach key in __plant_output_order
	{
		string plant_name = __plant_output_order[key];
		if (!(__plant_properties contains plant_name))
			continue;
		Plant plant = __plant_properties[plant_name];
		
		ChecklistSubentry subentry;
		subentry.header = plant_name + ", " + plant.terrain;
		subentry.modifiers.listAppend(plant.zone_effect);
		
		//See if we suggested this plant anywhere:
		foreach key in __plants_suggested_locations
		{
			PlantSuggestion suggestion = __plants_suggested_locations[key];
			if (suggestion.plant_name == plant_name)
			{
				//we did
				string suggestion_text = suggestion.loc;
				if (suggestion.details != "")
					suggestion_text += " (" + suggestion.details + ")";
				if (!locationAvailable(suggestion.loc))
					subentry.entries.listAppend(HTMLGenerateSpanOfClass(suggestion_text, "r_future_option"));
				else
					subentry.entries.listAppend(suggestion_text);
			}
		}
        
        string image_name = plant.image_lookup_name;
		if (subentry.entries.count() > 0)
        {
            if (false)
                florist_entries.listAppend(ChecklistEntryMake(138, image_name, "place.php?whichplace=forestvillage&amp;action=fv_friar", subentry));
            else
                subentries.listAppend(subentry);
        }
	}
    if (subentries.count() > 0)
    {
        florist_entries.listAppend(ChecklistEntryMake(139, "plant up sea daisy", "place.php?whichplace=forestvillage&amp;action=fv_friar", subentries));
    }
	
	checklists.listAppend(ChecklistMake("Florist Friar", florist_entries));
}

//Does not return colour formatting for elemental damage; will need to add that yourself.
string getPlantDescription(string plant_name)
{
    switch (plant_name)
    {
        case "Rabid Dogwood":
        case "War Lily":
        case "Blustery Puffball":
            return "+30 ML";
        case "Rutabeggar":
        case "Stealing Magnolia":
        case "Horn of Plenty":
            return "+25% item";
        case "Aloe Guv'nor":
            return "HP regen";
        case "Artichoker":
            return "delevel";
        case "Canned Spinach":
            return "5 muscle/fight";
        case "Crookweed":
            return "+60% meat";
        case "Dis Lichen":
            return "delevel";
        case "Duckweed":
            return "hiding";
        case "Electric Eelgrass":
            return "block";
        case "Impatiens":
            return "+25% init";
        case "Kelptomaniac":
            return "+40% item";
        case "Lettuce Spray":
            return "HP regen";
        case "Max Headshroom":
            return "MP regen";
        case "Orca Orchid":
            return "attack";
        case "Pitcher Plant":
            return "MP regen";
        case "Portlybella":
            return "HP regen";
        case "Rad-ish Radish":
            return "5 moxie/fight";
        case "Red Fern":
            return "delevel";
        case "Seltzer Watercress":
            return "MP regen";
        case "Shuffle Truffle":
            return "+25% init";
        case "Smoke-ra":
            return "block";
        case "Snori":
            return "HP/MP regen";
        case "Spankton":
            return "delevel";
        case "Spider Plant":
            return "poison";
        case "Up Sea Daisy":
            return "30 stats/fight";
        case "Wizard's Wig":
            return "5 myst/fight";
        case "Arctic Moss":
        case "Sub-Sea Rose":
        case "Chillterelle":
            return "cold attack";
        case "Celery Stalker":
        case "BamBOO!":
            return "spooky attack";
        case "Deadly Cinnamon":
            return "hot attack";
        case "Loose Morels":
            return "sleaze attack";
        case "Sargassum":
        case "Skunk Cabbage":
        case "Foul Toadstool":
            return "stench attack";
    }
    return "";
}

RegisterTaskGenerationFunction("SFloristGenerateTasks");
void SFloristGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //Friar:
	if (__iotms_usable[$item[Order of the Green Thumb Order Form]])
	{
        string image_name = "sunflower face";
		ChecklistSubentry subentry;
		subentry.header = "Plant florist plants in " + __last_adventure_location;
        
        PlantSuggestion [int] area_relevant_suggestions;
		foreach key, suggestion in __plants_suggested_locations
		{
			
			if (suggestion.loc != __last_adventure_location)
				continue;
            
            area_relevant_suggestions.listAppend(suggestion);
        }
        
        boolean single_mode_only = false;
        if (area_relevant_suggestions.count() == 1)
        {
            single_mode_only = true;
			PlantSuggestion suggestion = area_relevant_suggestions[0];
			string plant_name = suggestion.plant_name.capitaliseFirstLetter();
        
            subentry.header = "Plant " + plant_name + " in " + __last_adventure_location;
        }
		
		foreach key, suggestion in area_relevant_suggestions
		{
			string plant_name = suggestion.plant_name.capitaliseFirstLetter();
			Plant plant = __plant_properties[plant_name];
			
			string line;
            
            if (single_mode_only)
            {
                line = plant.zone_effect + ", " + plant.terrain;
                if (plant.territorial)
                    line = line + ", territorial";
                
                if (suggestion.details != "")
                    line += "|*" + suggestion.details;
            }
            else
            {
                line = plant_name + " (" + plant.zone_effect + ", " + plant.terrain;
                if (plant.territorial)
                    line = line + ", territorial";
                
                line += ")";
                if (suggestion.details != "")
                    line += "|*" + suggestion.details;
            }
			
            if (plant_name == "War Lily" || plant_name == "Rabid Dogwood" || plant_name == "Blustery Puffball")
            {
                if (monster_level_adjustment() + 30 > 150)
                {
                    //subentry.header = "Optionally plant florist plants in " + __last_adventure_location;
                    image_name = "__item pirate fledges";
                    
                    subentry.header += "?";
                    line += "|" + HTMLGenerateSpanFont("Very dangerous", "red") + ", monsters ";
                    if (monster_level_adjustment() > 150)
                        line += "are";
                    else
                        line += "will be";
                    line += " stagger immune.";
                }
            }
            
			subentry.entries.listAppend(line);
		}
		if (subentry.entries.count() > 0)
			task_entries.listAppend(ChecklistEntryMake(402, image_name, "place.php?whichplace=forestvillage&amp;action=fv_friar", subentry, -11));
	}
}
RegisterTaskGenerationFunction("SMiscTasksGenerateTasks");
void SMiscTasksGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //From tasks.ash. May be able to split off some of these into their own files:
	if (__misc_state["yellow ray available"] && __misc_state["in run"])
	{
		string [int] potential_targets;
		
		if (!have_outfit_components("Filthy Hippy Disguise") && !(get_property("sidequestOrchardCompleted") == "hippy" || get_property("sidequestOrchardCompleted") == "fratboy"))
			potential_targets.listAppend("Mysterious Island Hippy for outfit. (allows hippy store access; free redorant for +combat)");
		if (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues"))
			potential_targets.listAppend("Hippy/frat war outfit?");
		//fax targets?
		if (__misc_state["fax available"] || $skill[Rain Man].skill_is_usable())
		{
			potential_targets.listAppend("Anything on the fax list.");
		}
		
		if (!__quest_state["Level 10"].finished && $item[mohawk wig].available_amount() == 0)
			potential_targets.listAppend("Burly Sidekick (Mohawk wig) - speed up top floor of castle.");
		if (!__quest_state["Level 12"].state_boolean["Orchard Finished"])
			potential_targets.listAppend("Filthworms.");
		
		if (__quest_state["Boss Bat"].state_int["areas unlocked"] + $item[sonar-in-a-biscuit].available_amount() <3)
		{
			if ($item[enchanted bean].available_amount() == 0 && !__misc_state["beanstalk grown"])
				potential_targets.listAppend("Beanbat. (enchanted bean, sonar-in-a-biscuit)");
			else
				potential_targets.listAppend("A bat. (sonar-in-a-biscuit)");
		}
        
        if (__misc_state["stench airport available"] && $item[filthy child leash].available_amount() == 0 && !__misc_state["familiars temporarily blocked"] && $items[ittah bittah hookah,astral pet sweater,snow suit,lead necklace].available_amount() == 0 && in_ronin() && my_path_id() != PATH_HEAVY_RAINS && my_path_id() != PATH_GELATINOUS_NOOB && my_path_id() != PATH_G_LOVER)
        {
            potential_targets.listAppend("Horrible tourist family (barf mountain) - +5 familiar weight leash.");
        }
		
		
		if (item_drop_modifier_ignoring_plants() < 234.0 && !__misc_state["in aftercore"])
			potential_targets.listAppend("Anything with 30% drop if you can't 234%. (dwarf foreman, bob racecar, drum machines, etc)");
            
        
        if (__misc_state_string["yellow ray source"] == "Unleash Cowrruption" && $effect[Cowrruption].have_effect() == 0)
        {
            potential_targets.listAppend(HTMLGenerateSpanFont("Acquire cowrruption first.", "red"));
        }
		
		optional_task_entries.listAppend(ChecklistEntryMake(392, __misc_state_string["yellow ray image name"], "", ChecklistSubentryMake("Fire yellow ray", "", potential_targets), 5));
	}
    
    if (__misc_state["in run"] && !have_mushroom_plot() && knoll_available() && __misc_state["can eat just about anything"] && fullness_limit() >= 4 && $item[spooky mushroom].available_amount() == 0 && my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST && my_meat() >= 5000 && my_path_id() != PATH_SLOW_AND_STEADY && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
    {
        string [int] description;
        description.listAppend("For spooky mushrooms, to cook a grue egg omelette. (epic food)|Will " + ((my_meat() < 5000) ? "need" : "cost") + " 5k meat. Plant a spooky spore.");
		optional_task_entries.listAppend(ChecklistEntryMake(393, "__item spooky mushroom", "knoll_mushrooms.php", ChecklistSubentryMake("Possibly plant a mushroom plot", "", description), 5));
    
    }
	
	if (!have_outfit_components("Filthy Hippy Disguise") && __misc_state["mysterious island available"] && __misc_state["in run"] && !__quest_state["Level 12"].finished && !__quest_state["Level 12"].state_boolean["War started"] && !have_outfit_components("Frat Warrior Fatigues") && my_path_id() != PATH_EXPLOSION)
	{
		item [int] missing_pieces = missing_outfit_components("Filthy Hippy Disguise");
        
		string [int] description;
		string [int] modifiers;
        boolean should_be_future_task = false;
        
		description.listAppend("Missing " + missing_pieces.listJoinComponents(", ", "and") + ".");
        string next_line_intro = "";
        if (!__misc_state["yellow ray almost certainly impossible"])
        {
            description.listAppend("Yellow-ray a hippy in the hippy camp if you can.");
            next_line_intro = "Otherwise, ";
        }
        else if (my_level() < 9)
            should_be_future_task = true;
        
		if (my_level() >= 9)
		{
			description.listAppend((next_line_intro + "run -combat " + (next_line_intro == "" ? " in the hippy camp" : "there") + ".").capitaliseFirstLetter());
			modifiers.listAppend("-combat");
		}
		else
		{
			description.listAppend((next_line_intro + "wait for level 9 for the non-combats.").capitaliseFirstLetter());
		}
        if ($familiar[slimeling].familiar_is_usable())
            modifiers.listAppend("slimeling?");
            
        ChecklistEntry entry = ChecklistEntryMake(394, "__item filthy knitted dread sack", "island.php", ChecklistSubentryMake("Acquire a filthy hippy disguise", modifiers, description), $locations[hippy camp]);
        if (should_be_future_task)
            future_task_entries.listAppend(entry);
        else
            optional_task_entries.listAppend(entry);
	}
    
    if (__misc_state["in run"] && (inebriety_limit() == 0 || my_path_id() == PATH_SLOW_AND_STEADY) && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
    {
        string url = "";
        string [int] modifiers;
		if (__misc_state["have hipster"] && get_property_int("_hipsterAdv") < 7)
		{
			modifiers.listAppend(__misc_state_string["hipster name"]);
		}
        string [int] description = listMake("At the end of the day, enter a combat, but don't finish it. Rollover will end it for you.", "This gives an extra chance to look for a non-combat.");
        if (__quest_state["Level 3"].in_progress)
        {
            description.listAppend("Try using it to explore the typical tavern.");
            url = "cellar.php";
        }
		optional_task_entries.listAppend(ChecklistEntryMake(395, "__item dead guy's watch", url, ChecklistSubentryMake("Use rollover runaway", modifiers, description), 8));
    }
    
    //I'm not sure if you ever need a frat boy ensemble in-run, even if you're doing the hippy side on the war? If you need war hippy fatigues, the faster (?) way is acquire hippy outfit -> frat warrior fatigues -> start the war / use desert adventure for hippy fatigues. But if they're sure...
	if (!have_outfit_components("Frat boy ensemble") && __misc_state["mysterious island available"] && __misc_state["in run"] && !__quest_state["Level 12"].finished && !__quest_state["Level 12"].started && $location[frat house].turnsAttemptedInLocation() >= 3 && ($location[frat house].combatTurnsAttemptedInLocation() > 0 || $location[frat house].noncombat_queue.contains_text("Sing This Explosion to Me") || $location[frat house].noncombat_queue.contains_text("Sing This Explosion to Me") || $location[frat house].noncombat_queue.contains_text("Murder by Death") || $location[frat house].noncombat_queue.contains_text("I Just Wanna Fly") || $location[frat house].noncombat_queue.contains_text("From Stoked to Smoked") || $location[frat house].noncombat_queue.contains_text("Purple Hazers")))
    {
        //they don't have a frat boy ensemble, but they adventured in the pre-war frat house
        //I'm assuming this means they want the outfit, for whatever reason. So, suggest it, until the level 12 starts:
		item [int] missing_pieces = missing_outfit_components("Frat boy ensemble");
        
		string [int] description;
		string [int] modifiers;
		description.listAppend("Missing " + missing_pieces.listJoinComponents(", ", "and") + ".");
        if (my_level() >= 9)
        {
            modifiers.listAppend("-combat");
            description.listAppend("Run -combat.");
        }
        else
            description.listAppend("Possibly wait until level 9, to unlock NCs in the area.");
		optional_task_entries.listAppend(ChecklistEntryMake(396, "__item orcish frat-paddle", "island.php", ChecklistSubentryMake("Acquire a frat boy ensemble?", modifiers, description), $locations[frat house]));
    }
		
	if ($item[strange leaflet].available_amount() > 0 && __misc_state["in run"])
	{
        boolean leaflet_quest_probably_finished = false;
        
        if ($item[giant pinky ring].available_amount() > 0) //invalid in casual, but eh
            leaflet_quest_probably_finished = true;
        if ($item[Frobozz Real-Estate Company Instant House (TM)].available_amount() > 0 || get_dwelling() == $item[Frobozz Real-Estate Company Instant House (TM)])
            leaflet_quest_probably_finished = true;
        
        if (!leaflet_quest_probably_finished)
        {
            string [int] description;
            boolean future_task = false;
            description.listAppend("Quests Menu" + __html_right_arrow_character + "Leaflet (With Stats)");
            
            if (__misc_state["need to level"])
            {
                item relevant_lamp;
                effect relevant_lamp_effect;
                if (my_primestat() == $stat[muscle])
                {
                    relevant_lamp = $item[red LavaCo Lamp&trade;];
                    relevant_lamp_effect = $effect[Red Menace];
                }
                else if (my_primestat() == $stat[mysticality])
                {
                    relevant_lamp = $item[blue LavaCo Lamp&trade;];
                    relevant_lamp_effect = $effect[Blue Eyed Devil];
                }
                else if (my_primestat() == $stat[moxie])
                {
                    relevant_lamp = $item[green LavaCo Lamp&trade;];
                    relevant_lamp_effect = $effect[Green Peace];
                }
                if (relevant_lamp != $item[none] && relevant_lamp_effect != $effect[none] && relevant_lamp.available_amount() > 0 && relevant_lamp_effect.have_effect() == 0)
                {
                    future_task = true;
                    description.listAppend("Possibly wait until tomorrow. The " + relevant_lamp + " bonus will give extra stats.");
                }
                else if (relevant_lamp_effect.have_effect() > 0)
                    description.listAppend("Soon, before the lava lamp effect runs out.");
                
                item [int] items_equipping = generateEquipmentToEquipForExtraExperienceOnStat(my_primestat());
                if (items_equipping.count() > 0)
                    description.listAppend("Could equip " + items_equipping.listJoinComponents(", ", "or") + " for more stats.");
            }
            
            ChecklistEntry entry = ChecklistEntryMake(397, "__item strange leaflet", "", ChecklistSubentryMake("Strange leaflet quest", "", description));
            if (future_task)
                future_task_entries.listAppend(entry);
            else
                optional_task_entries.listAppend(entry);
        }
	}
	

	

    
    boolean have_spaghetti_breakfast = (($skill[spaghetti breakfast].skill_is_usable() && !get_property_boolean("_spaghettiBreakfast")) || $item[spaghetti breakfast].available_amount() > 0);
    if (__misc_state["in run"] && __misc_state["can eat just about anything"] && !get_property_boolean("_spaghettiBreakfastEaten") && my_fullness() == 0 && have_spaghetti_breakfast && my_path_id() != PATH_SLOW_AND_STEADY)
    {
    
        string [int] adventure_gain;
        adventure_gain[1] = "1";
        adventure_gain[2] = "1-2";
        adventure_gain[3] = "2";
        adventure_gain[4] = "2-3";
        adventure_gain[5] = "3";
        adventure_gain[6] = "3-4";
        adventure_gain[7] = "4";
        adventure_gain[8] = "4-5";
        adventure_gain[9] = "5";
        adventure_gain[10] = "5-6";
        adventure_gain[11] = "6";
        
        string adventures_gained = adventure_gain[MAX(1, MIN(11, my_level()))];
        
        string level_string = "";
        if (my_level() < 11)
            level_string = " Gain levels for more.";
        string url = "inventory.php?which=1";
        string [int] description;
        description.listAppend("Inedible if you eat anything else.|" + adventures_gained + " adventures/fullness." + level_string);
        if ($item[spaghetti breakfast].available_amount() == 0)
        {
            description.listAppend("Obtained by casting spaghetti breakfast.");
            url = "skills.php";
        }
        optional_task_entries.listAppend(ChecklistEntryMake(398, "__item spaghetti breakfast", url, ChecklistSubentryMake("Eat " + $item[spaghetti breakfast] + " first", "", description), 8));
    }
    
    if (my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING && my_path_id() != PATH_NUCLEAR_AUTUMN)
    {
        item dwelling = get_dwelling();
        item upgraded_dwelling = $item[none];
        if ($item[Frobozz Real-Estate Company Instant House (TM)].available_amount() > 0 && (dwelling == $item[big rock] || dwelling == $item[Newbiesport&trade; tent] || get_dwelling() == $item[cottage]) && my_path_id() != PATH_G_LOVER)
        {
            upgraded_dwelling = $item[Frobozz Real-Estate Company Instant House (TM)];
        }
        else if ($item[Newbiesport&trade; tent].available_amount() > 0 && dwelling == $item[big rock] && my_path_id() != PATH_G_LOVER)
        {
            upgraded_dwelling = $item[Newbiesport&trade; tent];
        }
        if (upgraded_dwelling != $item[none])
        {
            string [int] reasons;
            reasons.listAppend("rollover");
            
            if (__misc_state_int["total free rests possible"] > 0)
                reasons.listAppend("free rests");
            
            string description = "Better HP/MP restoration via " + reasons.listJoinComponents(", ", "and") + ".";
            optional_task_entries.listAppend(ChecklistEntryMake(399, "__item " + upgraded_dwelling, "inventory.php?which=3", ChecklistSubentryMake("Use " + upgraded_dwelling, "", description), 8));
            
        }
    }
    
    if (__misc_state["in run"] && $item[dry cleaning receipt].available_amount() > 0)
    {
        item receipt_item = $item[none];
        if (my_primestat() == $stat[muscle])
            receipt_item = $item[power sock];
        else if (my_primestat() == $stat[mysticality])
            receipt_item = $item[wool sock];
        else if (my_primestat() == $stat[moxie])
            receipt_item = $item[moustache sock];
        if (receipt_item != $item[none] && receipt_item.available_amount() == 0)
        {
            optional_task_entries.listAppend(ChecklistEntryMake(400, "__item " + $item[dry cleaning receipt], "inventory.php?which=3", ChecklistSubentryMake("Use " + $item[dry cleaning receipt], "", "For " + receipt_item + " accessory."), 8));
        }
    }
}

static
{
    boolean [item] __simple_candy = $items[1702, 1962, 4341, 913, 1652, 2942, 3455, 3449, 3454, 3453, 3452, 3451, 4152, 1501, 5455, 5478, 5476, 5477, 1344, 5188, 4340, 1161, 912, 4342, 5454, 2941, 1346, 4192, 1494, 5456, 617, 3496, 2734, 933, 908, 3450, 1783, 2088, 2576, 907, 1767, 906, 911, 540, 263, 909, 905, 5180, 2309, 300, 2307, 298, 1163, 2306, 299, 2305, 297, 2304, 2308, 5892, 6792, 5435, 7677, 7785];
    boolean [item] __complex_candy = lookupItems("5495,5496,5494,5458,5421,4851,2197,1382,4334,4333,5424,3269,5422,921,5425,5423,3091,2955,5416,5419,5418,5417,5420,5381,5319,5400,4330,4332,5406,5405,4818,5402,5318,5384,4331,5320,5382,5398,5401,5397,5317,5385,5321,5383,3290,3760,2193,5413,5459,5483,3584,5395,5396,5482,4256,5484,2943,4329,3054,4758,4163,4466,4464,4465,4462,4467,4463,4623,5157,4395,4394,4393,4518,5189,4151,5023,3428,3423,3424,5457,3425,5480,5474,5479,5473,5481,5475,4164,3631,4853,5414,5415,3046,5345,1345,5103,2220,4746,4389,3125,4744,4273,3422,1999,3426,4181,4180,4176,4183,4179,4191,4182,4178,4745,5526,6835,6852,6833,6834,6836,7499,7915,8257,7914,6837,8151,3124,8149,8154,7919,6840,5736,6831,7917,8150,6404,6841,6904,6903,7918,7710,6399,9146,8537,6405,6843,7474,6172,9252,5913];");
}



int synthesis_price(item it)
{
    if (!it.tradeable)
        return 999999999;
    int price = it.historical_price();
    if (price <= 0)
        return 999999999;
    return price;
}

Record CandyCombination
{
    item candy_1;
    item candy_2;
};

CandyCombination CandyCombinationMake(item candy_1, item candy_2)
{
    CandyCombination cc;
    cc.candy_1 = candy_1;
    cc.candy_2 = candy_2;
    return cc;
}

static
{
    CandyCombination [int][int][int] __candy_combination_cache;
}

CandyCombination [int] calculateSweetSynthesisCandyCombinations(int tier, int subid)
{
    if (__candy_combination_cache[tier][subid].count() > 0)
        return __candy_combination_cache[tier][subid];
    
    CandyCombination [int] result;
    boolean [item] candy_1;
    boolean [item] candy_2;
    
    if (tier == 1)
    {
    	candy_1 = __simple_candy;
    	candy_2 = __simple_candy;
    }
    else if (tier == 2)
    {
    	candy_1 = __simple_candy;
    	candy_2 = __complex_candy;
    }
    else if (tier == 3)
    {
    	candy_1 = __complex_candy;
    	candy_2 = __complex_candy;
    }
    foreach item_1 in candy_1
    {
        int item_1_id = item_1.to_int();
        
        foreach item_2 in candy_2
        {
            int item_2_id = item_2.to_int();
            if ((item_1_id + item_2_id) % 5 != (subid - 1))
                continue;
            result[result.count()] = CandyCombinationMake(item_1, item_2);
        }
    }
    sort result by (value.candy_1.synthesis_price() + value.candy_2.synthesis_price());
    __candy_combination_cache[tier][subid] = result;
    return result;
}

static
{
    string [effect] __sweet_synthesis_buff_descriptions;
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Hot]] = "+9 hot res";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Cold]] = "+9 cold res";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Pungent]] = "+9 stench res";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Scary]] = "+9 spooky res";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Greasy]] = "+9 sleaze res";
    
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Strong]] = "+300% muscle";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Smart]] = "+300% myst";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Cool]] = "+300% moxie";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Hardy]] = "+300% max HP";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Energy]] = "+300% max MP";
    
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Greed]] = "+300% meat";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Collection]] = "+150% item";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Movement]] = "+50% muscle gain";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Learning]] = "+50% myst gain";
    __sweet_synthesis_buff_descriptions[$effect[Synthesis: Style]] = "+50% moxie gain";
    
    int [effect] __sweet_synthesis_buff_tiers;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Hot]] = 1;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Cold]] = 1;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Pungent]] = 1;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Scary]] = 1;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Greasy]] = 1;
    
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Strong]] = 2;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Smart]] = 2;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Cool]] = 2;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Hardy]] = 2;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Energy]] = 2;
    
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Greed]] = 3;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Collection]] = 3;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Movement]] = 3;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Learning]] = 3;
    __sweet_synthesis_buff_tiers[$effect[Synthesis: Style]] = 3;
    
    int [effect] __sweet_synthesis_buff_subid;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Hot]] = 1;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Cold]] = 2;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Pungent]] = 3;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Scary]] = 4;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Greasy]] = 5;
    
    __sweet_synthesis_buff_subid[$effect[Synthesis: Strong]] = 1;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Smart]] = 2;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Cool]] = 3;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Hardy]] = 4;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Energy]] = 5;
    
    __sweet_synthesis_buff_subid[$effect[Synthesis: Greed]] = 1;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Collection]] = 2;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Movement]] = 3;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Learning]] = 4;
    __sweet_synthesis_buff_subid[$effect[Synthesis: Style]] = 5;
    
    effect [int] __sweet_synthesis_buff_output_order;
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Greed]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Collection]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Movement]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Learning]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Style]);
    
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Strong]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Smart]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Cool]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Hardy]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Energy]);
    
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Hot]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Cold]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Pungent]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Scary]);
    __sweet_synthesis_buff_output_order.listAppend($effect[Synthesis: Greasy]);
}

RegisterResourceGenerationFunction("SSweetSynthesisGenerateResource");
void SSweetSynthesisGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$skill[Sweet Synthesis].skill_is_usable())
        return;
    if (availableSpleen() == 0)
        return;
    
    //Calculate potential combinations from inventory, if we're in-run.
    //If we're in aftercore, suggest a cheap candy for each buff. Breath mints are forever, right?
    
    
    //We only display a handful of combinations in-run, because honestly there's no room.
    int setting_maximum_display_limit = 2;
    
    
    string [int] description;
    
    string [int][int] table;
    //table.listAppend(listMake(HTMLGenerateSpanOfClass("Effect", "r_bold"), HTMLGenerateSpanOfClass("Candies", "r_bold")));
    
    int approximate_line_count = 0;
    string [int] table_lines;
    foreach key, e in __sweet_synthesis_buff_output_order
    {
        if (e == $effect[none])
            continue;
        CandyCombination [int] combinations = calculateSweetSynthesisCandyCombinations(__sweet_synthesis_buff_tiers[e], __sweet_synthesis_buff_subid[e]);
        
        
        //If we're in aftercore, show the cheapest combination.
        //If we're in ronin, show all combinations we have components for.
        CandyCombination [int] final_combinations;
        //final_combinations = combinations;
        if (in_ronin())
        {
            //All we have enough for:
            //int [int][item] combinations_seen;
            
            
            /*item [int][int] second_stage_combinations;
            //Sort on smaller list:
            //Note that combinations is, like, 4426, 4371, 4450, 4465, 4489, 1919, 1952, 1913, 1890, 1862, 813, 790, 805, 832, and 856.
            foreach key in combinations
            {
                item item_1 = combinations[key][0];
                
                if (item_1.available_amount() + item_1.closet_amount() == 0)
                    continue;
                item item_2 = combinations[key][1];
                if (item_2.available_amount() + item_2.closet_amount() == 0)
                    continue;
                //if (!(item_1.available_amount() + item_1.closet_amount() > 0 && item_2.available_amount() + item_2.closet_amount() > 0 && !(item_1 == item_2 && item_1.available_amount() < 2)))
                if (item_1 == item_2 && item_1.available_amount() + item_1.closet_amount() < 2)
                    continue;
                second_stage_combinations.listAppend(combinations[key]);
            }
            sort second_stage_combinations by (value[0].synthesis_price() + value[1].synthesis_price()); //fast reject - we'll stop running once we reach the display limit
            */
            boolean [string] combinations_seen_json;
            foreach key, cc in combinations
            {
                if (final_combinations.count() >= setting_maximum_display_limit + 1)
                    break;
                //So, using item_amount() is three times faster than available_amount(), even though it ignores a bunch of stuff. Which is a difference of 0.3 seconds vs 0.1 seconds.
                if (cc.candy_1.item_amount() + cc.candy_1.closet_amount() == 0)
                    continue;
                if (cc.candy_2.item_amount() + cc.candy_2.closet_amount() == 0)
                    continue;
                if (cc.candy_1 == cc.candy_2 && cc.candy_1.item_amount() + cc.candy_1.closet_amount() < 2)
                    continue;
                
                //if (!(item_1.available_amount() + item_1.closet_amount() > 0 && item_2.available_amount() + item_2.closet_amount() > 0 && !(item_1 == item_2 && item_1.available_amount() < 2)))
                    //continue;
                int [item] combination_presence;
                combination_presence[cc.candy_1] += 1;
                combination_presence[cc.candy_2] += 1;
                //Use a JSON to discover if we've seen this combination before. Seems to be the fastest way to check if we've seen a map before?
                //It shouldn't be too slow... right? Right?
                string presence_json = combination_presence.to_json();
                boolean already_seen = (combinations_seen_json contains presence_json);
                //Have we seen this particular combination yet?
                //Lovely slow O(N^2) algorithm:
                /*foreach key in combinations_seen
                {
                    boolean identical = true;
                    foreach it, amount in combinations_seen[key]
                    {
                        if (combination_presence[it] != amount)
                        {
                            identical = false;
                            break;
                        }
                    }
                    if (identical)
                    {
                        already_seen = true;
                        break;
                    }
                }*/
                if (already_seen)
                {
                    continue;
                }
                
                
                final_combinations[final_combinations.count()] = cc;
                //combinations_seen[combinations_seen.count()] = combination_presence;
                combinations_seen_json[presence_json] = true;
            }
        }
        else
        {
            //Find cheapest:
            //This is already pre-sorted.
            final_combinations[final_combinations.count()] = combinations[0];
        }
        if (final_combinations.count() > 0)
        {
            buffer line;
            foreach key in final_combinations
            {
                if (key >= setting_maximum_display_limit) //unrealistic to show that many
                {
                    line.append("<br>[...]");
                    break;
                }
                approximate_line_count += 1;
                if (line.length() != 0)
                    line.append("<br>");
                line.append(final_combinations[key].candy_1);
                line.append(" + ");
                line.append(final_combinations[key].candy_2);
            }
            table_lines.listAppend(HTMLGenerateSpanOfClass(__sweet_synthesis_buff_descriptions[e], "r_bold") + "<br>" + HTMLGenerateSpanOfStyle(line, "font-size:0.8em;color:#333333"));
            //table.listAppend(listMake(__sweet_synthesis_buff_descriptions[e], line));
        }
    }
    string [int] building_line;
    foreach key in table_lines
    {
        building_line.listAppend(table_lines[key]);
        if (key % 2 == 1)
        {
            table.listAppend(building_line);
            building_line = listMakeBlankString();
        }
    }
    if (building_line.count() > 0)
        table.listAppend(building_line);
    int estimated_margin = approximate_line_count * 1.2;
    //description.listAppend("Costs one spleen and two candies.");
    description.listAppend(HTMLGenerateSpanOfClass(HTMLGenerateTagWrap("span",HTMLGenerateSimpleTableLines(table, false), mapMake("class", "r_tooltip_inner_class r_tooltip_inner_class_margin", "style", "margin-top:-" + estimated_margin + "em;margin-left:-5em;")) + "Costs one spleen and two candies.", "r_tooltip_outer_class"));
    
    
    if (table.count() > 0)
        resource_entries.listAppend(ChecklistEntryMake(232, "__skill Sweet Synthesis", "runskillz.php?action=Skillz&whichskill=166&targetplayer=" + my_id() + "&pwd=" + my_hash() + "&quantity=1", ChecklistSubentryMake("Sweet Synthesis Buff", "30 turns", description), 10).ChecklistEntrySetCategory("buff"));
}
RegisterTaskGenerationFunction("SBuffUpkeepGenerateTasks");
void SBuffUpkeepGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //Least-effort (basically a copy-paste from my ascension script), needs examining:
    if (!__misc_state["in run"])
        return;
    if (my_meat() < 1000) return; //save
    skill [int] skills_want_running;
    int [skill] minimum_meat_for_skill;
    
    skills_want_running.listAppend($skill[iron palm technique]);
    
    if (in_bad_moon() && my_mp() >= 1)
    {
        if (my_class() == $class[disco bandit])
            skills_want_running.listAppend($skill[disco aerobics]);
    }
    if (!__misc_state["familiars temporarily blocked"] && my_familiar() != $familiar[none])
    {
        skills_want_running.listAppend($skill[leash of linguini]);
        skills_want_running.listAppend($skill[empathy of the newt]);
    }
    if (get_property("peteMotorbikeMuffler").length() == 0)
        skills_want_running.listAppend($skill[rev engine]);
    if (my_primestat() == $stat[mysticality] && my_hp() < 500)
    {
        if ($item[turtle totem].available_amount() > 0)
        {
            skills_want_running.listAppend($skill[reptilian fortitude]);
            skills_want_running.listAppend($skill[astral shell]);
            skills_want_running.listAppend($skill[ghostly shell]);
        }
    }
    boolean have_facial_expression = false;
    foreach s in $skills[Arched Eyebrow of the Archmage,Disco Leer,Disco Smirk,Icy Glare,Knowing Smile,Patient Smile,Scowl of the Auk,Snarl of the Timberwolf,Stiff Upper Lip,Suspicious Gaze,Wizard Squint,Wry Smile]
    {
        if (s == $skill[suspicious gaze] && get_property_int("cyrptAlcoveEvilness") <= 26 && QuestState("questL07Cyrptic").started) //only need suspicious gaze there
            continue;
        if (s.to_effect().have_effect() > 0)
            have_facial_expression = true;
    }
    if ($skill[Inscrutable Gaze].to_effect().have_effect() > 0)
        have_facial_expression = true;
    
    if (__misc_state["need to level"] && !have_facial_expression)
    {
        if (my_primestat() == $stat[mysticality])
            skills_want_running.listAppend($skill[Wry Smile]);
        else if (my_primestat() == $stat[moxie])
            skills_want_running.listAppend($skill[knowing smile]);
        else if (my_primestat() == $stat[muscle])
            skills_want_running.listAppend($skill[Patient Smile]);
    }
    
    //UNDYING!
    if (my_level() >= 3)
        skills_want_running.listAppend($skill[Purr of the Feline]);
    skills_want_running.listAppend($skill[Prayer of Seshat]);
    if (__misc_state["need to level"])
        skills_want_running.listAppend($skill[Blessing of Serqet]);
    skills_want_running.listAppend($skill[Hide of Sobek]);
    if (!in_hardcore())
        skills_want_running.listAppend($skill[Bounty of Renenutet]);
    skills_want_running.listAppend($skill[Power of Heka]);
    skills_want_running.listAppend($skill[Wisdom of Thoth]);
    if (my_primestat() == $stat[mysticality] && my_level() < 13)
	    skills_want_running.listAppend($skill[Inscrutable Gaze]);
    
    
    
    minimum_meat_for_skill[$skill[The Magical Mojomuscular Melody]] = 100;
    minimum_meat_for_skill[$skill[blessing of serqet]] = 500;
    minimum_meat_for_skill[$skill[Prayer of Seshat]] = 500;
    minimum_meat_for_skill[$skill[Power of Heka]] = 500;
    minimum_meat_for_skill[$skill[Purr of the Feline]] = 500;
    minimum_meat_for_skill[$skill[leash of linguini]] = 2000;
    minimum_meat_for_skill[$skill[empathy of the newt]] = 3000;
    foreach s in $skills[ur-kel's aria of annoyance,drescher's annoying noise,pride of the puffin]
        minimum_meat_for_skill[s] = 2000;
    
    
    skill [int] final_skills;
    foreach key, s in skills_want_running
    {
        if (!s.skill_is_usable() || !s.is_unrestricted())
            continue;
        effect e = s.to_effect();
        if (e == $effect[none])
            continue;
        if (e.have_effect() > 1)
            continue;
        if (my_maxmp() < s.mp_cost())
            continue;
        final_skills.listAppend(s);
    }
    if (final_skills.count() > 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(281, "__skill " + final_skills[0], "skillz.php", ChecklistSubentryMake("Upkeep buffs", "", "Cast " + final_skills.listJoinComponents(", ", "and") + ".")));
    }
}

RegisterTaskGenerationFunction("SBugsGenerateTasks");
void SBugsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_id() != 1557284) return;
	
	string [int] bugs;
	
	//bugs are here
	//bugs.listAppend("In firefox, resource bar text is not aligned properly."); //still in effect, but not relevant to modern layout
	//bugs.listAppend("resource bar should remember open/closed");
	//bugs.listAppend("resource bar resolve subicons"); //disabled, unviable
	//bugs.listAppend("floating icons do not work well with fade to black. specifically, the reload button");
	//bugs.listAppend("Resource bar, when moused over, does not survive reloading Guide. Set it to continuous and debug.|same with location bar");
	//bugs.listAppend("Should the resource info popup have some sort of solid separation from the resource bar itself?"); //ignored, don't care
	bugs.listAppend("Guide takes too long to start up. 2.56s last measure on local.");
	bugs.listAppend("camel needs targets for spit.");
	bugs.listAppend("camel needs buff when that is trackable.");
	bugs.listAppend("make turn-costing banishes be vaguely near the free ones");
	//bugs.listAppend("ZS changes?");
	bugs.listAppend("robot path");
	bugs.listAppend("grey goo? (do absolutely nothing)");
	//bugs.listAppend("implement showhide");
	//bugs.listAppend("emotion chip - if we don't have the skill but we can acquire it via the item, do that");
	//bugs.listAppend("location bar's text is obscured by the scroll bar.");
	//bugs.listAppend("Location bar, when changing location, will 'peek' due to .bottom.");
	//bugs.listAppend("resource bar popup info text is misplaced because of scroll bar");
	//bugs.listAppend("In the resource bar, free fights go past the screen limit. Split it up into original parts?");
	//bugs.listAppend("barrel worship in resource bar has bad background");
	//bugs.listAppend("in the resource bar, popup does not have correct icon");
	//bugs.listAppend("set to continuously load and look at importance bar; the shadow keeps on animating");
	
	bugs.listAppend("cartography - various changes from adventures it gives. in particular, always worry about pool adventure?");
	bugs.listAppend("superhero cape in state.ash YR detection");
	bugs.listAppend("when generating blank showhides, there's no link");
	//bugs.listAppend("for entries, there's no link in blank space");
	bugs.listAppend("for entries with no showhide, there's no link in the showhide spot");
	//bugs.listAppend("sync showhide on importance bar with entry on main");
	//bugs.listAppend("speakeasy drinks goes past limit in showhide when on left for doubles");
	//bugs.listAppend("resolve show/noshow when clicking showhide outside of appearance - test mouse checking code");
	//bugs.listAppend("solve popup 2x on same line problem - we need full width yet");
	//bugs.listAppend("line on top entry for each checklist");
	bugs.listAppend("showhide popup ignores highlighted - fix via transparency on popup");
	bugs.listAppend("refresh button vs importance bar");
	//bugs.listAppend("top hover buttons aren't clickable always");
	//bugs.listAppend("reload should always appear in independent window");
	bugs.listAppend("write support for preserving showhide clicks across versions - currently storing the abridged description, may mean removing numbers, partial matches...|also worst case, if they don't show up on page, do they get a transition? probably... not? unless we keep a dynamic system...");
	//bugs.listAppend("resource bar does not interact with hidden entries");
	//bugs.listAppend("if all entries are on the last line, and the scroll bar is all the way at the bottom, the popup causes problems in chromium, because chromium is constantly jumping down and up. don't know how to fix this - appear above instead of below if we're near the end...?"); //fixed via constant position testing
	bugs.listAppend("requested movable entries. major project");
	//bugs.listAppend("superhero cape in L7 code");
	
	
	string [int] iotms;
	
	
	int yooi = 2019;
	int mooi = 11;
	
	
	int current_year = format_today_to_string("yyyy").to_int();
	int current_month = format_today_to_string("MM").to_int();
	
	
	int i_year = yooi;
	int i_month = mooi;
	
	
	string [int] months = 
	{
    1:"January",
    2:"February",
    3:"March",
    4:"April",
    5:"May",
    6:"June",
    7:"July",
    8:"August",
    9:"September",
    10:"October",
    11:"November",
    12:"December",
	};
	
	string [int] iotm_canonical_list = 
	{
        //2019:
        "Kramco Industries packing carton",
        "mint condition Lil' Doctor bag",
        "vampyric cloake pattern",
        "PirateRealm membership packet",
        "Fourth of May Cosplay Saber kit",
        "rune-strewn spoon cocoon",
        "Beach Comb Box",
        "Distant Woods Getaway Brochure",
        "packaged Pocket Professor",
        "Unopened Eight Days a Week Pill Keeper",
        "unopened diabolic pizza cube box",
        "red-spotted snapper roe",

        //2020:
        "unopened Bird-a-Day calendar",
        "mint-in-box Powerful Glove",
        "Better Shrooms and Gardens catalog",
        "Left-Hand Man",
        "Guzzlr application",
        "bag of Iunion stones",
        "baby camelCalf",
        "packaged SpinMaster lathe",
        "Bagged Cargo Cultist Shorts",
        "Comprehensive Cartographic Compendium",
        "packaged knock-off retro superhero cape",
        "box o' ghosts",

        //2021:
        "packaged miniature crystal ball",
        "emotion chip",
	};
	
	int breakout = 77;
	while (i_year <= current_year && breakout > 0)
	{
		breakout -= 1;
        string description;
        
        description = months[i_month] + " " + i_year;
        
        
        int description_index = (i_year - 2019) * 12 + (i_month - 1);
        
        if (iotm_canonical_list contains description_index)
        	description = iotm_canonical_list[description_index];
        
        
        description += " IOTM";
        
        
        if (!description.contains_text(""))
        	iotms.listAppend(description);
  
        i_month += 1;
        if (i_month >= 13)
        {
        	i_month = 1;
            i_year += 1;
        }
        
        if (i_year == current_year && i_month > current_month)
        	break;
	}
	
	
	bugs.listAppendList(iotms);
	
	if (bugs.count() > 0)
	{
        task_entries.listAppend(ChecklistEntryMake(401, "__item software bug", "", ChecklistSubentryMake(HTMLGenerateSpanFont("Fix " + pluralise(bugs.count(), "bug", "bugs"), "red"), "", bugs), -10));
	}
}

void SetsInit()
{
    SCountersInit();
    QHitsInit();
}


void SetsGenerateResources(ChecklistEntry [int] resource_entries)
{
	SFamiliarsGenerateResource(resource_entries);
	SSemirareGenerateResource(resource_entries);
	SSkillsGenerateResource(resource_entries);
	SMiscItemsGenerateResource(resource_entries);
	SCopiedMonstersGenerateResource(resource_entries);
    SPulveriseGenerateResource(resource_entries);
    SCountersGenerateResource(resource_entries);
    SFaxGenerateResource(resource_entries);
    SClassesGenerateResource(resource_entries);
    SEquipmentGenerateResource(resource_entries);
    S8bitRealmGenerateResource(resource_entries);
    SCalculateUniverseGenerateResource(resource_entries);
    SEventsGenerateResource(resource_entries);
}

void SetsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	SFamiliarsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SSemirareGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SDispensaryGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SCouncilGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SCopiedMonstersGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SAftercoreGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	QHitsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	S8bitRealmGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SDailyDungeonGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SCountersGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SBountyHunterHunterGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SOldLevel9GenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SFaxGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SDungeonsOfDoomGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SOlfactionGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SHolidayGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SRemindersGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SEventsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SClassesGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SEquipmentGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SMiscItemsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    SPVPGenerateTasks(task_entries, optional_task_entries, future_task_entries);
}


void SetsGenerateMissingItems(ChecklistEntry [int] items_needed_entries)
{
    QHitsGenerateMissingItems(items_needed_entries);
}



boolean [item] __pulls_reasonable_to_buy_in_run;

int pullable_amount(item it, int maximum_total_wanted)
{
	boolean buyable_in_run = false;
	if (__pulls_reasonable_to_buy_in_run contains it)
		buyable_in_run = true;
    if (it.tradeable && it.historical_price() > 0 && it.historical_price() < 50000)
    	buyable_in_run = true;
	if (maximum_total_wanted == 0)
		maximum_total_wanted = __misc_state_int["pulls available"] + it.available_amount();
	if (__misc_state["Example mode"]) //simulate pulls
	{
		if (buyable_in_run)
			return min(__misc_state_int["pulls available"], maximum_total_wanted);
		else
			return min(__misc_state_int["pulls available"], min(storage_amount(it) + it.available_amount(), maximum_total_wanted));
	}
	
	int amount = storage_amount(it);
	if (buyable_in_run)
		amount = 20;
	int total_amount = amount + it.available_amount();
	
	if (total_amount > maximum_total_wanted)
	{
		amount = maximum_total_wanted - it.available_amount();
	}
	
	if (amount < 0) amount = 0;
	return min(__misc_state_int["pulls available"], amount);
}

int pullable_amount(item it)
{
	return pullable_amount(it, 0);
}


//generic pull item
record GPItem
{
	//Either item OR alternate_name
	item it;
	string alternate_name;
	string alternate_image_name;
	
	string reason;
	int max_wanted;
};

GPItem GPItemMake(item it, string reason, int max_wanted)
{
	GPItem result;
	result.it = it;
	result.reason = reason;
	result.max_wanted = max_wanted;
	return result;
}

GPItem GPItemMake(item it, string reason)
{
	return GPItemMake(it, reason, 1);
}

GPItem GPItemMake(string alternate_name, string alternate_image_name, string reason)
{
	GPItem result;
	result.alternate_name = alternate_name;
	result.alternate_image_name = alternate_image_name;
	result.reason = reason;
	result.max_wanted = 1;
	return result;
}

void listAppend(GPItem [int] list, GPItem entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

void generatePullList(Checklist [int] checklists)
{
    //Needs improvement.
	ChecklistEntry [int] pulls_entries;
	
	int pulls_available = __misc_state_int["pulls available"];
	if (pulls_available <= 0)
		return;
	if (pulls_available > 0)
		pulls_entries.listAppend(ChecklistEntryMake(97, "special subheader", "", ChecklistSubentryMake(pluralise(pulls_available, "pull", "pulls") + " remaining")));
	
	item [int] pullable_list_item;
	int [int] pullable_list_max_wanted;
	string [int] pullable_list_reason;
	
	GPItem [int] pullable_item_list;
    
    boolean combat_items_usable = true;
    if (my_path_id() == PATH_POCKET_FAMILIARS)
    	combat_items_usable = false;
    
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
    	pullable_item_list.listAppend(GPItemMake($item[pocket wish], "Saves turns on everything in Community Service.", 20));
    if (__misc_state["need to level"])
    {
        if (my_primestat() == $stat[muscle])
        {
            pullable_item_list.listAppend(GPItemMake($item[fake washboard], "+25% to mainstat gain, offhand."));
            pullable_item_list.listAppend(GPItemMake($item[red LavaCo Lamp&trade;], "+5 adventures, 50 turns of +50% mainstat gain after rollover."));
        }
        else if (my_primestat() == $stat[mysticality])
        {
            pullable_item_list.listAppend(GPItemMake($item[basaltamander buckler], "+25% to mainstat gain, offhand."));
            pullable_item_list.listAppend(GPItemMake($item[blue LavaCo Lamp&trade;], "+5 adventures, 50 turns of +50% mainstat gain after rollover."));
            if (my_path_id() == PATH_THE_SOURCE)
            {
                int amount = 3;
                if ($item[battle broom].available_amount() > 0)
                    amount = 2;
                pullable_item_list.listAppend(GPItemMake($item[wal-mart nametag], "+4 mainstat/fight", amount));
            }
        }
        else if (my_primestat() == $stat[moxie])
        {
            pullable_item_list.listAppend(GPItemMake($item[backwoods banjo], "+20% to mainstat gain, 2h weapon."));
            pullable_item_list.listAppend(GPItemMake($item[green LavaCo Lamp&trade;], "+5 adventures, 50 turns of +50% mainstat gain after rollover."));
            if (my_path_id() == PATH_THE_SOURCE)
                pullable_item_list.listAppend(GPItemMake($item[wal-mart overalls], "+4 mainstat/fight"));
        }
    }
	
	//IOTMs:
	if ($item[empty rain-doh can].available_amount() == 0 && $item[can of rain-doh].available_amount() == 0)
		pullable_item_list.listAppend(GPItemMake($item[can of rain-doh], "5 copies/day|everything really", 1));
	if ($items[empty rain-doh can,can of rain-doh,spooky putty monster].available_amount() == 0)
		pullable_item_list.listAppend(GPItemMake($item[spooky putty sheet], "5 copies/day", 1));
    if (true)
    {
        string line = "So many things!";
        if ($item[over-the-shoulder folder holder].storage_amount() > 0)
        {
            string [int] description;
            string [item] folder_descriptions;
            
            folder_descriptions[$item[folder (red)]] = "+20 muscle";
            folder_descriptions[$item[folder (blue)]] = "+20 myst";
            folder_descriptions[$item[folder (green)]] = "+20 moxie";
            folder_descriptions[$item[folder (magenta)]] = "+15 muscle +15 myst";
            folder_descriptions[$item[folder (cyan)]] = "+15 myst +15 moxie";
            folder_descriptions[$item[folder (yellow)]] = "+15 muscle +15 moxie";
            folder_descriptions[$item[folder (smiley face)]] = "+2 muscle stat/fight";
            folder_descriptions[$item[folder (wizard)]] = "+2 myst stat/fight";
            folder_descriptions[$item[folder (space skeleton)]] = "+2 moxie stat/fight";
            folder_descriptions[$item[folder (D-Team)]] = "+1 stat/fight";
            folder_descriptions[$item[folder (Ex-Files)]] = "+5% combat";
            folder_descriptions[$item[folder (skull and crossbones)]] = "-5% combat";
            folder_descriptions[$item[folder (Knight Writer)]] = "+40% init";
            folder_descriptions[$item[folder (Jackass Plumber)]] = "+25 ML";
            folder_descriptions[$item[folder (holographic fractal)]] = "+4 all res";
            folder_descriptions[$item[folder (barbarian)]] = "stinging damage";
            folder_descriptions[$item[folder (rainbow unicorn)]] = "prismatic stinging damage";
            folder_descriptions[$item[folder (Seawolf)]] = "-pressure penalty";
            folder_descriptions[$item[folder (dancing dolphins)]] = "+50% item (underwater)";
            folder_descriptions[$item[folder (catfish)]] = "+15 familiar weight (underwater)";
            folder_descriptions[$item[folder (tranquil landscape)]] = "15 DR / 15 HP & MP regen";
            folder_descriptions[$item[folder (owl)]] = "+500% item (dreadsylvania)";
            folder_descriptions[$item[folder (Stinky Trash Kid)]] = "passive stench damage";
            folder_descriptions[$item[folder (sports car)]] = "+5 adv";
            folder_descriptions[$item[folder (sportsballs)]] = "+5 PVP fights";
            folder_descriptions[$item[folder (heavy metal)]] = "+5 familiar weight";
            folder_descriptions[$item[folder (Yedi)]] = "+50% spell damage";
            folder_descriptions[$item[folder (KOLHS)]] = "+50% item (KOLHS)";
            
            foreach s in $slots[folder1,folder2,folder3]
            {
                item folder = s.equipped_item();
                if (folder == $item[none]) continue;
                
                if (folder_descriptions contains folder)
                    description.listAppend(folder_descriptions[folder]);
            }
            if (description.count() > 0)
                line = description.listJoinComponents(" / ");
        }
        pullable_item_list.listAppend(GPItemMake($item[over-the-shoulder folder holder], line, 1));
    }
    
	pullable_item_list.listAppend(GPItemMake($item[pantsgiving], "5x banish/day|+2 stats/fight|+15% items|2 extra fullness (realistically)", 1));
    if (!__misc_state["familiars temporarily blocked"]) //relevant in heavy rains, on the +item/+meat underwater familiars
        pullable_item_list.listAppend(GPItemMake($item[snow suit], "+20 familiar weight for a while" + (($familiar[pair of stomping boots].is_unrestricted() && __misc_state["free runs usable"]) ? ", +4 free runs" : "") + "|+10% item|spleen items", 1));
    if (!__misc_state["familiars temporarily blocked"] && ($item[protonic accelerator pack].available_amount() == 0 || $familiar[machine elf].familiar_is_usable())) //if you have a machine elf, it might be worth pulling a bjorn with a protonic pack anyways
    {
        if ($item[Buddy Bjorn].storage_amount() > 0)
            pullable_item_list.listAppend(GPItemMake($item[Buddy Bjorn], "+10ML/+lots MP hat|or +item/+init/+meat/etc", 1));
        else if ($item[buddy bjorn].available_amount() == 0)
            pullable_item_list.listAppend(GPItemMake($item[crown of thrones], "+10ML/+lots MP hat|or +item/+init/+meat/etc", 1));
    }
	pullable_item_list.listAppend(GPItemMake($item[boris's helm], "+15ML/+5 familiar weight/+init/+mp regeneration/+weapon damage", 1));
    if (__misc_state["need to level"])
    {
        pullable_item_list.listAppend(GPItemMake($item[plastic vampire fangs], "Large stat gain, once/day.", 1));
        pullable_item_list.listAppend(GPItemMake($item[operation patriot shield], "+america", 1));
        pullable_item_list.listAppend(GPItemMake($item[the crown of ed the undying], "Various in-run modifiers. (init, HP, ML/item/meat/etc)", 1));
    }
    pullable_item_list.listAppend(GPItemMake($item[v for vivala mask], "?", 1));
	
	if (my_primestat() == $stat[mysticality] && my_path_id() != PATH_HEAVY_RAINS) //should we only suggest this for mysticality classes?
		pullable_item_list.listAppend(GPItemMake($item[Jarlsberg's Pan], "?", 1)); //"
	pullable_item_list.listAppend(GPItemMake($item[loathing legion knife], "?", 1));
	pullable_item_list.listAppend(GPItemMake($item[greatest american pants], "navel runaways|others", 1));
	pullable_item_list.listAppend(GPItemMake($item[juju mojo mask], "?", 1));
    if (__misc_state["free runs usable"])
    {
        pullable_item_list.listAppend(GPItemMake($item[navel ring of navel gazing], "free runaways|easy fights", 1));
        if (combat_items_usable)
	        pullable_item_list.listAppend(GPItemMake($item[mafia middle finger ring], "one free runaway/banish/day", 1));
    }
	//pullable_item_list.listAppend(GPItemMake($item[haiku katana], "?", 1));
	pullable_item_list.listAppend(GPItemMake($item[bottle-rocket crossbow], "?", 1));
	pullable_item_list.listAppend(GPItemMake($item[jekyllin hide belt], "+variable% item", 3));
    
    if (__misc_state["need to level"])
    {
        pullable_item_list.listAppend(GPItemMake($item[hockey stick of furious angry rage], "+30ML accessory.", 1));
    }
    pullable_item_list.listAppend(GPItemMake($item[ice sickle], "+15ML 1h weapon|+item/+meat/+init foldables", 1));
    if ($item[buddy bjorn].available_amount() == 0)
        pullable_item_list.listAppend(GPItemMake($item[camp scout backpack], "+15% items on back", 1));
    if (__misc_state["Torso aware"])
    {
        pullable_item_list.listAppend(GPItemMake($item[flaming pink shirt], "+15% items on shirt. (marginal)" + (__misc_state["familiars temporarily blocked"] ? "" : "|Or extra experience on familiar. (very marginal)"), 1));
        if (__misc_state["need to level"] && $item[Sneaky Pete's leather jacket (collar popped)].available_amount() == 0 && $item[Sneaky Pete's leather jacket].available_amount() == 0)
        {
            
            if ($item[Sneaky Pete's leather jacket (collar popped)].storage_amount() + $item[Sneaky Pete's leather jacket].storage_amount() > 0)
            {
                if (my_path_id() != PATH_AVATAR_OF_SNEAKY_PETE)
                    pullable_item_list.listAppend(GPItemMake($item[Sneaky Pete's leather jacket], "+30ML/+meat/+adv/+init/+moxie shirt", 1));
            }
            else
                pullable_item_list.listAppend(GPItemMake($item[cane-mail shirt], "+20ML shirt", 1));
        }
    }
    if (__quest_state["Level 10"].mafia_internal_step >= 8)
    {
    	if (__quest_state["Level 10"].mafia_internal_step == 8 && $item[amulet of extreme plot significance].available_amount() == 0)
        {
        	pullable_item_list.listAppend(GPItemMake($item[amulet of extreme plot significance], "Speeds up castle basement.", 1));
        }
        if (!__quest_state["Level 10"].finished && $item[mohawk wig].available_amount() == 0)
        {
            pullable_item_list.listAppend(GPItemMake($item[mohawk wig], "Speeds up top floor of castle.", 1));
        }
    }
    if (my_path_id() != PATH_G_LOVER)
	    pullable_item_list.listAppend(GPItemMake($item[Clara's Bell], "Forces a non-combat, once/day.", 1));
    if (combat_items_usable)
    	pullable_item_list.listAppend(GPItemMake($item[replica bat-oomerang], "Saves three turns/day.", 1));
    
    if (__misc_state["spooky airport available"] && __misc_state["need to level"] && __misc_state["can drink just about anything"] && $effect[jungle juiced].have_effect() == 0)
    {
        pullable_item_list.listAppend(GPItemMake($item[jungle juice], "Drink that doubles stat-gain in the deep dark jungle.", 1));
    }
    
	
	boolean have_super_fairy = false;
	if ((familiar_is_usable($familiar[fancypants scarecrow]) && $item[spangly mariachi pants].available_amount() > 0) || (familiar_is_usable($familiar[mad hatrack]) && $item[spangly sombrero].available_amount() > 0))
		have_super_fairy = true;
	if (!have_super_fairy && my_path_id() != PATH_HEAVY_RAINS && false)
	{
		if (familiar_is_usable($familiar[fancypants scarecrow]))
			pullable_item_list.listAppend(GPItemMake($item[spangly mariachi pants], "2x fairy on fancypants scarecrow", 1));
		else if (familiar_is_usable($familiar[mad hatrack]))
			pullable_item_list.listAppend(GPItemMake($item[spangly sombrero], "2x fairy on mad hatrack", 1));
	}
	//pullable_item_list.listAppend(GPItemMake($item[jewel-eyed wizard hat], "a wizard is you!", 1));
	//pullable_item_list.listAppend(GPItemMake($item[origami riding crop], "+5 stats/fight, but only if the monster dies quickly", 1)); //not useful?
	//pullable_item_list.listAppend(GPItemMake($item[plastic pumpkin bucket], "don't know", 1)); //not useful?
	//pullable_item_list.listAppend(GPItemMake($item[packet of mayfly bait], "why let it go to waste?", 1));
	
	if ($items[greatest american pants, navel ring of navel gazing].available_amount() + pullable_amount($item[greatest american pants]) + pullable_amount($item[navel ring of navel gazing]) == 0)
		pullable_item_list.listAppend(GPItemMake($item[peppermint parasol], "free runaways", 1));
    
    
	if (__misc_state["can eat just about anything"] && availableFullness() > 0)
	{
        string [int] food_selections;
        
        if (__misc_state_int["fat loot tokens needed"] > 0)
        {
            string [int] which_pies;
            if ($items[boris's key,boris's key lime pie].available_amount() == 0 && my_path_id() != PATH_G_LOVER)
                which_pies.listAppend("Boris");
            if ($items[jarlsberg's key,jarlsberg's key lime pie].available_amount() == 0)
                which_pies.listAppend("Jarlsberg");
            if ($items[sneaky pete's key,sneaky pete's key lime pie].available_amount() == 0 && my_path_id() != PATH_G_LOVER)
                which_pies.listAppend("Sneaky Pete");
            string line;
            if (which_pies.count() > 0)
                line += which_pies.listJoinComponents("/") + "'s ";
            line += "key lime pie";
            if (which_pies.count() > 1)
                line += "s";
            food_selections.listAppend(line);
        }
        if (availableFullness() >= 5)
        {
            if (my_level() >= 13 && my_path_id() != PATH_G_LOVER)
                food_selections.listAppend("hi meins");
            else if ($item[moon pie].is_unrestricted() && my_path_id() != PATH_G_LOVER)
                food_selections.listAppend("moon pies");
            
            if (my_path_id() != PATH_G_LOVER)
	            food_selections.listAppend("fleetwood mac 'n' cheese" + (my_level() < 8 ? " (level 8)" : ""));
            if ($item[karma shawarma].is_unrestricted())
                food_selections.listAppend("karma shawarma? (expensive" + (my_level() < 7 ? ", level 7" : "") + ")");
            //FIXME maybe the new pasta?
        }
        
        string description;
        if (food_selections.count() > 0)
            description = food_selections.listJoinComponents(", ") + ", etc.";
		pullable_item_list.listAppend(GPItemMake("Food", "hell ramen", description));
	}
	if (__misc_state["can drink just about anything"] && availableDrunkenness() >= 0 && inebriety_limit() >= 5)
	{
        string [int] drink_selections;
        if ($item[wrecked generator].is_unrestricted())
            drink_selections.listAppend("wrecked generators");
        if ($item[Ice Island Long Tea].is_unrestricted())
            drink_selections.listAppend("Ice Island Long Tea");
        
        string description;
        if (drink_selections.count() > 0)
            description = drink_selections.listJoinComponents(", ") + ", etc.";
        
		pullable_item_list.listAppend(GPItemMake("Drink", "gibson", description));
	}
    
    //pullable_item_list.listAppend(GPItemMake($item[slimy alveolus], "40 turns of +50ML (" + floor(40 * 50 * __misc_state_float["ML to mainstat multiplier"]) +" mainstat total, cave bar levelling)|1 spleen", 3)); //marginal now. low-skill oil peak/cyrpt?
	
	
    if (!get_property_boolean("_blankoutUsed") && __misc_state["free runs usable"])
        pullable_item_list.listAppend(GPItemMake($item[bottle of blank-out], "run away from your problems", 1));
	
	
    if (!__quest_state["Level 11 Hidden City"].finished && !__quest_state["Level 11"].finished && (get_property_int("hiddenApartmentProgress") < 1 || get_property_int("hiddenBowlingAlleyProgress") < 1 || get_property_int("hiddenHospitalProgress") < 1 || get_property_int("hiddenOfficeProgress") < 1) && __misc_state["can equip just about any weapon"] && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        boolean have_machete = false;
        foreach it in __dense_liana_machete_items
        {
            if (it.available_amount() > 0 && it.is_unrestricted())
                have_machete = true;
        }
        if (!have_machete)
        {
            if (my_basestat($stat[muscle]) < 62 && $item[machetito].is_unrestricted())
            {
                //machetito
                pullable_item_list.listAppend(GPItemMake($item[machetito], "Machete for dense liana", 1));
            }
            else if ($item[muculent machete].is_unrestricted() && my_path_id() != PATH_G_LOVER) //my_basestat($stat[muscle]) < 62 &&
            {
                //muculent machete, also gives +5% meat, op ti mal
                pullable_item_list.listAppend(GPItemMake($item[muculent machete], "Machete for dense liana", 1));
            }
            else
            {
                //antique machete
                pullable_item_list.listAppend(GPItemMake($item[antique machete], "Machete for dense liana", 1));
            }
        }
    }
	
	//Quest-relevant items:
	if ($familiar[Intergnat].familiar_is_usable() && my_path_id() != PATH_G_LOVER)
    {
        pullable_item_list.listAppend(GPItemMake($item[infinite BACON machine], "One copy/day with ~seven turns of intergnat.", 1));
    }
	if (!__quest_state["Level 9"].state_boolean["bridge complete"])
	{
		int boxes_needed = MIN(__quest_state["Level 9"].state_int["bridge fasteners needed"], __quest_state["Level 9"].state_int["bridge lumber needed"]) / 5;
		
		boxes_needed = MIN(6, boxes_needed); //bridge! farming?
		
		if (boxes_needed > 0 && my_path_id() != PATH_G_LOVER)
			pullable_item_list.listAppend(GPItemMake($item[smut orc keepsake box], "Skip level 9 bridge building.", boxes_needed));
	}
    if (__quest_state["Level 9"].state_int["peak tests remaining"] > 0)
    {
        int trimmers_needed = clampi(__quest_state["Level 9"].state_int["peak tests remaining"], 0, 4);
        if (trimmers_needed > 0)
			pullable_item_list.listAppend(GPItemMake($item[rusty hedge trimmers], "Speed up twin peak, burn delay.|Saves ~2 turns each?", trimmers_needed));
    }
	if (!__quest_state["Level 11 Palindome"].finished && $item[mega gem].available_amount() == 0 && ($item[wet stew].available_amount() + $item[wet stunt nut stew].available_amount() + $item[wet stew].creatable_amount() == 0) && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
		pullable_item_list.listAppend(GPItemMake($item[wet stew], "make into wet stunt nut stew|skip whitey's grove", 1));
    
    if (__quest_state["Level 11"].mafia_internal_step < 2)
        pullable_item_list.listAppend(GPItemMake($item[blackberry galoshes], "speed up black forest by 2-3? turns", 1));
        
    if (my_path_id() == PATH_HEAVY_RAINS)
        pullable_item_list.listAppend(GPItemMake($item[fishbone catcher's mitt], "offhand, less items washing away", 1));
    
        
    //OUTFITS: Pirate outfit, War outfit, Ninja "outfit"
    if (!__quest_state["Level 12"].finished && (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues")))
    {
        item [int] missing_hippy_components = missing_outfit_components("War Hippy Fatigues");
        item [int] missing_frat_components = missing_outfit_components("Frat Warrior Fatigues");
        pullable_item_list.listAppend(GPItemMake("Island War Outfit", "__item round purple sunglasses", "<strong>Hippy</strong>: " + missing_hippy_components.listJoinComponents(", ", "and") + ".|<strong>Frat boy</strong>: " + missing_frat_components.listJoinComponents(", ", "and") + "."));
    }
    
    if (!__quest_state["Level 8"].state_boolean["Mountain climbed"] && !have_outfit_components("eXtreme Cold-Weather Gear"))
    {
        item [int] missing_ninja_components = items_missing($items[ninja carabiner, ninja crampons, ninja rope]);
        if (missing_ninja_components.count() > 0)
        {
            string description = missing_ninja_components.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
            
            if (numeric_modifier("cold resistance") < 5.0)
                description += "|Will require five " + HTMLGenerateSpanOfClass("cold", "r_element_cold") + " resist to use properly.";
            pullable_item_list.listAppend(GPItemMake("Ninja peak climbing", "__item " + missing_ninja_components[0], description));
        }
    }
    
    if (!__quest_state["Level 8"].state_boolean["Past mine"] && __quest_state["Level 8"].state_string["ore needed"] != "" && !$skill[unaccompanied miner].skill_is_usable())
    {
        item ore_needed = __quest_state["Level 8"].state_string["ore needed"].to_item();
        if (ore_needed != $item[none] && ore_needed.available_amount() < 3)
        {
            pullable_item_list.listAppend(GPItemMake(ore_needed, "Level 8 quest.", 3));
        }
    }
    
    //alas
    if (($item[talisman o' namsilat].available_amount() == 0 || !__quest_state["Level 9"].state_boolean["bridge complete"]) && !have_outfit_components("Swashbuckling Getup") && $item[pirate fledges].available_amount() == 0 && false)// && !__quest_state["Pirate Quest"].finished)
    {
        item [int] missing_outfit_components = missing_outfit_components("Swashbuckling Getup");
        if (missing_outfit_components.count() > 0)
        {
            string entry = missing_outfit_components.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
            if ($item[eyepatch].available_amount() == 0)
                entry += "|Or NPZR head/clockwork pirate skull to untinker for eyepatch/clockwork maid.";
            if (!__quest_state["Pirate Quest"].state_boolean["valid"])
            	entry += "|No, really! You can get a free bridge!";
            pullable_item_list.listAppend(GPItemMake("Swashbuckling Getup", "__item " + missing_outfit_components[0], entry));
        }
    }
    
    //FIXME suggest machetito?
    //FIXME suggest super marginal stuff in SCO or S&S
    //Ideas: Goat cheese, keepsake box, spooky-gro fertilizer, harem outfit, perfume, rusty hedge trimmers, bowling ball, surgeon gear, tomb ratchets or tangles, all the other pies
    //FIXME suggest ore when we don't have access to free mining
    
    if (!have_outfit_components("Knob Goblin Elite Guard Uniform") && !__quest_state["Level 5"].finished)
    {
        item [int] missing_outfit_components = missing_outfit_components("Knob Goblin Harem Girl Disguise");
        
        string entry = missing_outfit_components.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
        entry += " Level 5 quest.";
        if (missing_outfit_components.count() > 0)
            pullable_item_list.listAppend(GPItemMake("Knob Goblin Harem Girl Disguise", "__item " + missing_outfit_components[0], entry));
    }
    if (!__misc_state["can reasonably reach -25% combat"])
    {
        if ((my_primestat() == $stat[moxie] || my_basestat($stat[moxie]) >= 35) && $item[iFlail].item_is_usable())
            pullable_item_list.listAppend(GPItemMake($item[iFlail], "-combat, +11 ML, +5 familiar weight"));
        if (__misc_state["Torso aware"] && $item[xiblaxian stealth vest].item_is_usable()) //FIXME exclusiveness with camouflage T-shirt. probably should pull camou if we're over muscle stat, otherwise stealth vest, or whichever we have
            pullable_item_list.listAppend(GPItemMake($item[xiblaxian stealth vest], "-combat shirt"));
        if ($item[duonoculars].item_is_usable())
	        pullable_item_list.listAppend(GPItemMake($item[duonoculars], "-combat, +5 ML"));
        pullable_item_list.listAppend(GPItemMake($item[ring of conflict], "-combat"));
        if (($item[red shoe].can_equip() || my_path_id() == PATH_GELATINOUS_NOOB) && $item[red shoe].item_is_usable())
            pullable_item_list.listAppend(GPItemMake($item[red shoe], "-combat"));
    }
	
	if (my_path_id() != PATH_COMMUNITY_SERVICE)
		pullable_item_list.listAppend(GPItemMake($item[ten-leaf clover], "Various turn saving.|Generic pull.", 20));
    
    if (!get_property_ascension("lastTempleUnlock") && $item[spooky-gro fertilizer].item_amount() == 0 && my_path_id() != PATH_G_LOVER && !__quest_state["Level 11"].finished)
        pullable_item_list.listAppend(GPItemMake($item[spooky-gro fertilizer], "Saves 2.5 turns while unlocking temple."));
	
	string [int] scrip_reasons;
	int scrip_needed = 0;
	if (!__misc_state["mysterious island available"] && $item[dinghy plans].available_amount() == 0)
	{
		scrip_needed += 3;
		scrip_reasons.listAppend("mysterious island");
	}
	if ($item[uv-resistant compass].available_amount() == 0 && $item[ornate dowsing rod].available_amount() == 0 && __misc_state["can equip just about any weapon"] && !__quest_state["Level 11 Desert"].state_boolean["Desert Explored"])
	{
		scrip_needed += 1;
		scrip_reasons.listAppend($item[uv-resistant compass].to_string());
	}
	if (scrip_needed > 0 && my_path_id() != PATH_COMMUNITY_SERVICE && my_path_id() != PATH_EXPLOSIONS)
	{
		pullable_item_list.listAppend(GPItemMake($item[Shore Inc. Ship Trip Scrip], "Saves three turns each.|" + scrip_reasons.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".", scrip_needed));
	}
    //FIXME add hat/stuffing fluffer/blank-out
    if (availableSpleen() >= 2 && my_path_id() != PATH_NUCLEAR_AUTUMN && my_path_id() != PATH_G_LOVER && my_path_id() != PATH_COMMUNITY_SERVICE)
    {
		pullable_item_list.listAppend(GPItemMake($item[turkey blaster], "Burns five turns of delay in last adventured area. Costs spleen, limited uses/day.", MIN(3 - get_property_int("_turkeyBlastersUsed"), MIN(availableSpleen() / 2, 3)))); //FIXME learn what this limit is. also suggest in advance?
    }
    if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"]) //only area that realistically could use it
    {
        pullable_item_list.listAppend(GPItemMake($item[gravy boat], "Wear to save two turns in the cyrpt.")); //marginal, especially since you're pulling a bunch of turkey blasters, but...
        
    }
    if (!__quest_state["Level 12"].finished && __quest_state["Level 12"].state_int["frat boys left on battlefield"] >= 936 && __quest_state["Level 12"].state_int["hippies left on battlefield"] >= 936)
    {
        pullable_item_list.listAppend(GPItemMake($item[stuffing fluffer], "Saves eight turns if you use two at the start of fighting in the war.", 2));
    }
    
    if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && __quest_state["Level 11 Desert"].state_int["Desert Exploration"] < 95)
    {
        if (!__quest_state["Level 11 Desert"].state_boolean["Wormridden"] && my_path_id() != PATH_G_LOVER)
            pullable_item_list.listAppend(GPItemMake($item[drum machine], "30% desert exploration with pages.", 1));
        if (!__quest_state["Level 11 Desert"].state_boolean["Killing Jar Given"] && $location[the haunted bedroom].locationAvailable())
            pullable_item_list.listAppend(GPItemMake($item[killing jar], "15% desert exploration.", 1));
        if (!__quest_state["Level 11 Desert"].state_boolean["Black Paint Given"] && my_path_id() == PATH_NUCLEAR_AUTUMN)
            pullable_item_list.listAppend(GPItemMake($item[can of black paint], "15% desert exploration.", 1));
    }
    if (__quest_state["Level 11 Ron"].mafia_internal_step <= 2 && __quest_state["Level 11 Ron"].state_int["protestors remaining"] > 1)
    {
        item [int] missing_freebird_components = items_missing($items[lynyrdskin cap,lynyrdskin tunic,lynyrdskin breeches,lynyrd musk]);
        if (missing_freebird_components.count() > 0)
        {
            string description = missing_freebird_components.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".";
            description += "|Plus four clovers. Skips the entire protestor zone in like four turns?";
            pullable_item_list.listAppend(GPItemMake("Weird copperhead NC strategy", "__item " + missing_freebird_components[0], description));
        }
        if (my_path_id() != PATH_GELATINOUS_NOOB)
	        pullable_item_list.listAppend(GPItemMake($item[deck of lewd playing cards], "+138 sleaze damage equip for copperhead NC.", 1));
        
    }
    
    if (__misc_state["need to level"] && __misc_state["Chateau Mantegna available"] && __misc_state_int["free rests remaining"] > 0 && false)
    {
        //This is not currently suggested because I'm not sure if it's worth it for anyone but unrestricted or the very high end speed ascension.
        //It seems to give about as much stats as a good clover, which you can also pull, and are much cheaper.
        //Unrestricted has up to 17 free rests. That's around 680 extra stats, which is fairly good. But leveling isn't as much of a problem either... or is it?
        item dis_item = $item[none];
        if (my_primestat() == $stat[muscle])
            dis_item = $item[baobab sap];
        else if (my_primestat() == $stat[mysticality])
            dis_item = $item[desktop zen garden];
        else if (my_primestat() == $stat[moxie])
            dis_item = $item[Marvin's marvelous pill];
        int ideal_extra_stats_worth = 20 * (__misc_state_int["free rests remaining"] + total_free_rests());
        if (dis_item != $item[none] && dis_item.to_effect().have_effect() == 0)
            pullable_item_list.listAppend(GPItemMake(dis_item, "+20% mainstat gain.|Use with Chateau resting; at the end of the day, rest with this potion active to gain extra stats.<br>Then rest again after rollover.<br>Worth up to " + ideal_extra_stats_worth + " " + my_primestat() + ".", 1));
        
    }
    if ($item[Mr. Cheeng's spectacles] != $item[none])
        pullable_item_list.listAppend(GPItemMake($item[Mr. Cheeng's spectacles], "+15% item, +30% spell damage, acquire random potions in-combat.|Not particularly optimal, but fun."));
    if (availableSpleen() > 0 && my_path_id() != PATH_LIVE_ASCEND_REPEAT)
	    pullable_item_list.listAppend(GPItemMake($item[stench jelly], "Skips ahead to an NC, saves 2.5? turns each.", 20));
     
    if ($item[pocket wish].item_is_usable())
	    pullable_item_list.listAppend(GPItemMake($item[pocket wish], "Saves turns?", 20));   
    
    //int pills_pullable = clampi(20 - (get_property_int("_powerPillUses") + $item[power pill].available_amount()), 0, 20);
    int pills_pullable = clampi(20 - get_property_int("_powerPillUses"), 0, 20);
    if (pills_pullable > 0 && ($familiar[ms. puck man].have_familiar() || $familiar[puck man].have_familiar()))
    {
        pullable_item_list.listAppend(GPItemMake($item[power pill], "Saves one turn each.", pills_pullable));
    }
    if (my_meat() < 1000)
        pullable_item_list.listAppend(GPItemMake($item[1\,970 carat gold], "Autosells for 19700 meat.|Not optimal in the slightest.", 1));
	if ($skill[ancestral recall].have_skill() && my_adventures() < 10)
    {
        int casts = get_property_int("_ancestralRecallCasts");
        if (casts < 10)
            pullable_item_list.listAppend(GPItemMake($item[blue mana], "+3 adventures each.|Probably a bad idea.", clampi(10 - casts, 0, 10)));
    }
    if (my_path_id() == PATH_GELATINOUS_NOOB || my_path_id() == PATH_NUCLEAR_AUTUMN)
    {
        pullable_item_list.listAppend(GPItemMake($item[filthy lucre], "Turn into odor extractors for olfaction.", 6));
    }
    if (my_path_id() != PATH_SLOW_AND_STEADY)
    {
    	//unify these... later...
        foreach it in $items[mafia thumb ring,License to Chill,etched hourglass]
            pullable_item_list.listAppend(GPItemMake(it, "lazy turngen", 1));
    }
    
	
	boolean currently_trendy = (my_path_id() == PATH_TRENDY);
	foreach key in pullable_item_list
	{
		GPItem gp_item = pullable_item_list[key];
		string reason = gp_item.reason;
		string [int] reason_list = split_string_alternate(reason, "\\|");
		
		if (gp_item.alternate_name != "")
		{
			pulls_entries.listAppend(ChecklistEntryMake(98, gp_item.alternate_image_name, "storage.php", ChecklistSubentryMake(gp_item.alternate_name, "", reason_list)));
			continue;
		}
		
		
		item [int] items;
		int [item] related_items = get_related(gp_item.it, "fold");
		if (related_items.count() == 0)
			items.listAppend(gp_item.it);
		else
		{
			foreach it in related_items
				items.listAppend(it);
		}
		
		
		int max_wanted = gp_item.max_wanted;
		
        int found_total;
        foreach key, it in items
        {
            found_total += it.available_amount();
        }
        if (found_total >= max_wanted)
            continue;
        if (my_path_id() == PATH_GELATINOUS_NOOB)
        {
            boolean allowed = false;
            boolean [item] allowlist = $items[gravy boat,blackberry galoshes,machetito,muculent machete,antique machete,Mr. Cheeng's spectacles,buddy bjorn,crown of thrones,navel ring of navel gazing,greatest american pants,plastic vampire fangs,the jokester's gun];
            foreach key, it in items
            {
                if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains it.to_slot() && !(allowlist contains it) && !it.discardable && !__items_in_outfits[it])
                {
                }
                else
                    allowed = true;
            }
            if (!allowed)
            {
                //print_html("Rejecting " + items[0]);
                continue;
            }
        }
		
		foreach key in items
		{
			item it = items[key];
			if (currently_trendy && !is_trendy(it))
				continue;
            if (!is_unrestricted(it))
                continue;
            slot item_slot = it.to_slot();
            if (item_slot == $slot[off-hand] && !__misc_state["can equip just about any off-hand"]) continue;
            if (item_slot == $slot[weapon] && !__misc_state["can equip just about any weapon"]) continue;
            //if (!it.is_unrestricted()) continue; //FIXME uncomment next point release
			int actual_amount = pullable_amount(it, max_wanted);
			if (actual_amount > 0)
			{
                string url = "storage.php";
                if (it != $item[none])
                {
                    if (it.fullness > 0 || it.inebriety > 0)
                        url = "storage.php?which=1";
                    if (it.to_slot() != $slot[none])
                        url = "storage.php?which=2";
                }
              
                if (it.storage_amount() == 0 && (__pulls_reasonable_to_buy_in_run contains it) && it != $item[ten-leaf clover] && it != $item[none])
                    url = "mall.php";
              
				if (max_wanted == 1)
					pulls_entries.listAppend(ChecklistEntryMake(99, it, url, ChecklistSubentryMake(it, "", reason_list)));
				else
					pulls_entries.listAppend(ChecklistEntryMake(100, it, url, ChecklistSubentryMake(pluralise(actual_amount, it), "", reason_list)));
				break;
			}
		}
	}
	
	checklists.listAppend(ChecklistMake("Suggested Pulls", pulls_entries));
}

void PullsInit()
{
    //Pulls which are reasonable to buy in the mall, then pull:
	__pulls_reasonable_to_buy_in_run = $items[peppermint parasol,slimy alveolus,bottle of blank-out,disassembled clover,ten-leaf clover,ninja rope,ninja crampons,ninja carabiner,clockwork maid,sonar-in-a-biscuit,knob goblin perfume,chrome ore,linoleum ore,asbestos ore,goat cheese,enchanted bean,dusty bottle of Marsala,dusty bottle of Merlot,dusty bottle of Muscat,dusty bottle of Pinot Noir,dusty bottle of Port,dusty bottle of Zinfandel,ketchup hound,lion oil,bird rib,stunt nuts,drum machine,beer helmet,distressed denim pants,bejeweled pledge pin,reinforced beaded headband,bullet-proof corduroys,round purple sunglasses,wand of nagamar,ng,star crossbow,star hat,star staff,star sword,Star key lime pie,Boris's key lime pie,Jarlsberg's key lime pie,Sneaky Pete's key lime pie,tomb ratchet,tangle of rat tails,swashbuckling pants,stuffed shoulder parrot,eyepatch,Knob Goblin harem veil,knob goblin harem pants,knob goblin elite polearm,knob goblin elite pants,knob goblin elite helm,cyclops eyedrops,mick's icyvapohotness inhaler,large box,marzipan skull,jaba&ntilde;ero-flavored chewing gum,handsomeness potion,Meleegra&trade; pills,pickle-flavored chewing gum,lime-and-chile-flavored chewing gum,gremlin juice,wussiness potion,Mick's IcyVapoHotness Rub,super-spiky hair gel,adder bladder,black no. 2,skeleton,rock and roll legend,wet stew,glass of goat's milk,hot wing,frilly skirt,pygmy pygment,wussiness potion,gremlin juice,adder bladder,Angry Farmer candy,thin black candle,super-spiky hair gel,Black No. 2,Mick's IcyVapoHotness Rub,Frigid ninja stars,Spider web,Sonar-in-a-biscuit,Black pepper,Pygmy blowgun,Meat vortex,Chaos butterfly,Photoprotoneutron torpedo,Fancy bath salts,inkwell,Hair spray,disease,bronzed locust,Knob Goblin firecracker,powdered organs,leftovers of indeterminate origin,mariachi G-string,NG,plot hole,baseball,razor-sharp can lid,tropical orchid,stick of dynamite,barbed-wire fence,smut orc keepsake box,spooky-gro fertilizer,machetito,muculent machete,antique machete,rusty hedge trimmers,Ice Island Long Tea,killing jar,can of black paint,gravy boat,ring of conflict,bram's choker,duonoculars];
}


void setUpExampleState()
{
	__misc_state["in run"] = true;
    
	//Do a default reset of each quest:
	
	foreach quest_name in __quest_state
	{
		QuestState state = __quest_state[quest_name];
		
		
		QuestStateParseMafiaQuestPropertyValue(state, "started");
		
		
		__quest_state[quest_name] = state;
	}
	
	__misc_state_int["pulls available"] = 17;
}


//We call this twice - once at the start, once after __quest_state["Level 13"] becomes available. I would just call it once but that could break things? (very old code)
void computeFatLootTokens()
{
    int dd_tokens_and_keys_available = 0;
    int tokens_needed = 0;
    int keys_missing = 0;
    boolean need_boris_key = true;
    boolean need_jarlsberg_key = true;
    boolean need_sneaky_pete_key = true;
    
    if ($item[boris's key].available_amount() > 0)
        need_boris_key = false;
    if ($item[jarlsberg's key].available_amount() > 0)
        need_jarlsberg_key = false;
    if ($item[sneaky pete's key].available_amount() > 0)
        need_sneaky_pete_key = false;
        
    if (__quest_state["Level 13"].state_boolean["Sneaky Pete's key used"])
        need_sneaky_pete_key = false;
    if (__quest_state["Level 13"].state_boolean["Boris's key used"])
        need_boris_key = false;
    if (__quest_state["Level 13"].state_boolean["Jarlsberg's key used"])
        need_jarlsberg_key = false;
        
    if (need_boris_key)
        tokens_needed += 1;
    if (need_jarlsberg_key)
        tokens_needed += 1;
    if (need_sneaky_pete_key)
        tokens_needed += 1;
    
    keys_missing = tokens_needed;
    tokens_needed -= $item[fat loot token].available_amount();
    tokens_needed = MAX(0, tokens_needed);
    
    dd_tokens_and_keys_available += $item[fat loot token].available_amount();
    dd_tokens_and_keys_available += $item[boris's key].available_amount();
    dd_tokens_and_keys_available += $item[jarlsberg's key].available_amount();
    dd_tokens_and_keys_available += $item[sneaky pete's key].available_amount();

    __misc_state_int["fat loot tokens needed"] = MAX(0, tokens_needed);
    __misc_state_int["hero keys missing"] = keys_missing;
    
    __misc_state_int["DD Tokens and keys available"] = dd_tokens_and_keys_available;
}


void setUpState()
{
    __misc_state.listClear();
	__last_adventure_location = get_property_location("lastAdventure");
    if (__misc_state["Example mode"])
    {
        int wanted_index = random_safe($locations[].count());
        int i = 0;
        foreach l in $locations[]
        {
            if (i == wanted_index)
            {
                __last_adventure_location = l;
                break;
            }
            i += 1;
        }
    }	
	if (__setting_debug_mode && __setting_debug_enable_example_mode_in_aftercore && get_property_boolean("kingLiberated"))
	{
		__misc_state["Example mode"] = true;
	}
    
	__misc_state["in aftercore"] = get_property_boolean("kingLiberated");
    //if (get_property_ascension("lastKingLiberation") && my_ascensions() != 0)
        //__misc_state["in aftercore"] = true;
	__misc_state["in run"] = !__misc_state["in aftercore"];
    if (__misc_state["Example mode"] || debug)
        __misc_state["in run"] = true;
    __misc_state["In valhalla"] = (my_class().to_string() == "Astral Spirit");
    
    
	if (my_turncount() >= 30 && get_property_int("singleFamiliarRun") != -1)
		__misc_state["single familiar run"] = true;
	if ($item[Clan VIP Lounge key].available_amount() > 0 && !in_bad_moon())
		__misc_state["VIP available"] = true;
	boolean fax_available = false;
	if (__misc_state["VIP available"])
	{
		if (!get_property_boolean("_photocopyUsed"))
			fax_available = true;
		__misc_state["fax accessible"] = true;
	}
	
	if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_TRENDY)
	{
		__misc_state["fax accessible"] = false;
	}
    if (!$item[deluxe fax machine].is_unrestricted())
        __misc_state["fax accessible"] = false;
    
    if (!__misc_state["fax accessible"])
		fax_available = false;
	__misc_state["fax available"] = fax_available;
    
    __misc_state["fax equivalent accessible"] = __misc_state["fax available"];
    if (my_path_id() == PATH_HEAVY_RAINS && $skill[rain man].skill_is_usable())
        __misc_state["fax equivalent accessible"] = true;
	
    if (__misc_state["VIP available"])
    {
        int soaks_remaining = MAX(0, 5 - get_property_int("_hotTubSoaks"));
        __misc_state_int["hot tub soaks remaining"] = soaks_remaining;
    }
	
	__misc_state["can eat just about anything"] = true;
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_ZOMBIE_SLAYER || fullness_limit() == 0 || my_path_id() == PATH_VAMPIRE)
	{
		__misc_state["can eat just about anything"] = false;
	}
	
	__misc_state["can drink just about anything"] = true;
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_KOLHS || my_path_id() == PATH_LICENSE_TO_ADVENTURE || inebriety_limit() == 0 || my_path_id() == PATH_VAMPIRE)
	{
		__misc_state["can drink just about anything"] = false;
	}
	
	
	__misc_state["can equip just about any weapon"] = true;
	__misc_state["can equip just about any off-hand"] = true;
	if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_WAY_OF_THE_SURPRISING_FIST)
	{
		__misc_state["can equip just about any weapon"] = false;
        __misc_state["can equip just about any off-hand"] = false;
	}
	
	
	__misc_state["MMJs buyable"] = false;
	if (get_property_ascension("lastGuildStoreOpen"))
	{
		if (my_class() == $class[pastamancer] || my_class() == $class[sauceror] || (my_class() == $class[accordion thief] && my_level() >= 9))
            __misc_state["MMJs buyable"] = true;
	}
	
	//Check for moxie/mysticality/muscle combat skills:
	
	foreach s in $skills[]
	{
		if (!s.combat)
			continue;
		if (!s.skill_is_usable())
			continue;
		if (s.class == $class[accordion thief] || s.class == $class[disco bandit])
			__misc_state["have moxie class combat skill"] = true;
		if (s.class == $class[pastamancer] || s.class == $class[sauceror])
			__misc_state["have mysticality class combat skill"] = true;
		if (s.class == $class[seal clubber] || s.class == $class[turtle tamer])
			__misc_state["have muscle class combat skill"] = true;
	}
	
	
	
	boolean yellow_ray_available = false;
	string yellow_ray_source = "";
	string yellow_ray_image_name = "__effect everything looks yellow";
	boolean yellow_ray_potentially_available = false;
    
    foreach source in $items[4766,5229,6673,7013]
    {
        if (!(source.available_amount() > 0 || (source == $item[4766] && $item[4761].available_amount() > 0)))
            continue;
		yellow_ray_available = true;
		yellow_ray_source = source.to_string();
		yellow_ray_image_name = "__item " + source.to_string();
    }
    if ($item[viral video].available_amount() > 0)
    {
		yellow_ray_available = true;
		yellow_ray_source = "viral video";
		yellow_ray_image_name = "__item viral video";
    }
    if (lookupItem("micronova").available_amount() > 0)
    {
		yellow_ray_available = true;
		yellow_ray_source = "micronova";
		yellow_ray_image_name = "__item micronova";
    }
    
    if ($item[mayo lance].available_amount() > 0 && get_property_int("mayoLevel") > 0)
    {
        yellow_ray_available = true;
        yellow_ray_source = "Mayo Lance";
        yellow_ray_image_name = "__item mayo lance";
    }
    if ($skill[Unleash Cowrruption].have_skill())
    {
        yellow_ray_available = true;
        yellow_ray_source = "Unleash Cowrruption";
        yellow_ray_image_name = "__skill Unleash Cowrruption";
    }
    if ($familiar[Crimbo Shrub].familiar_is_usable() && get_property("shrubGifts") == "yellow" && !(my_daycount() == 1 && get_property("_shrubDecorated") == "false"))
    {
        yellow_ray_available = true;
        yellow_ray_source = "Crimbo Shrub";
        yellow_ray_image_name = "__item DNOTC Box"; //uncertain
    }
	if (familiar_is_usable($familiar[nanorhino]) && __misc_state["have moxie class combat skill"] && get_property_int("_nanorhinoCharge") == 100)
	{
		yellow_ray_available = true;
		yellow_ray_source = "Nanorhino";
		yellow_ray_image_name = "nanorhino";
		
	}
    if ($skill[Ball Lightning].skill_is_usable() && my_path_id() == PATH_HEAVY_RAINS && my_lightning() >= 5)
    {
        yellow_ray_available = true;
        yellow_ray_source = "Ball Lightning";
        yellow_ray_image_name = "__skill Ball Lightning";
    }
    if ($skill[wrath of ra].skill_is_usable() && my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
    {
        yellow_ray_available = true;
        yellow_ray_source = "Wrath of Ra";
        yellow_ray_image_name = "__skill wrath of ra";
    }
	if (familiar_is_usable($familiar[he-boulder]))
	{
		yellow_ray_available = true;
		yellow_ray_source = "He-Boulder";
		yellow_ray_image_name = "he-boulder";
	}
    if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && $skill[Flash Headlight].skill_is_usable() && get_property("peteMotorbikeHeadlight") == "Ultrabright Yellow Bulb")
    {
		yellow_ray_available = true;
		yellow_ray_source = "Flash Headlight";
		yellow_ray_image_name = "__skill Easy Riding";
    }
    if ($skill[disintegrate].have_skill() && my_maxmp() >= 150)
    {
		yellow_ray_available = true;
		yellow_ray_source = "Disintegrate";
		yellow_ray_image_name = "__skill Disintegrate";
    }
	
	if (yellow_ray_available)
		yellow_ray_potentially_available = true;
	
	if (my_path_id() == PATH_KOLHS)
		yellow_ray_potentially_available = true;
		
	
	if ($effect[Everything looks yellow].have_effect() > 0)
		yellow_ray_available = false;
	if (!yellow_ray_available)
		yellow_ray_source = "";
	__misc_state["yellow ray available"] = yellow_ray_available;
	__misc_state_string["yellow ray source"] = yellow_ray_source;
	__misc_state_string["yellow ray image name"] = yellow_ray_image_name;
	__misc_state["yellow ray potentially available"] = yellow_ray_potentially_available;
    
    
    if (in_bad_moon() && !__misc_state["yellow ray potentially available"] && !__misc_state["yellow ray available"])
    {
        __misc_state["yellow ray almost certainly impossible"] = true;
    }
    
    int [item] campground_items = get_campground();
    __misc_state["can cook for free"] = false;
    if (campground_items[$item[chef-in-the-box]] > 0 || campground_items[$item[clockwork chef-in-the-box]] > 0 || $effect[Inigo's Incantation of Inspiration].have_effect() >= 5)
        __misc_state["can cook for free"] = true;
    
    
    __misc_state["can bartend for free"] = false;
    if (campground_items[$item[bartender-in-the-box]] > 0 || campground_items[$item[clockwork bartender-in-the-box]] > 0 || $effect[Inigo's Incantation of Inspiration].have_effect() >= 5)
        __misc_state["can bartend for free"] = true;
    
    if ($skill[Rapid Prototyping].skill_is_usable() && get_property_int("_rapidPrototypingUsed") < 5)
    {
        __misc_state["can cook for free"] = true;
        __misc_state["can bartend for free"] = true;
    }
    if ($skill[Expert Corner-Cutter].skill_is_usable() && get_property_int("_expertCornerCutterUsed") < 5)
    {
        __misc_state["can cook for free"] = true;
        __misc_state["can bartend for free"] = true;
    }
	
	boolean free_runs_usable = true;
	if (my_path_id() == PATH_BIG || my_path_id() == PATH_POCKET_FAMILIARS) //more like "combat items not usable" but
		free_runs_usable = false;
	__misc_state["free runs usable"] = free_runs_usable;
	
	boolean blank_outs_usable = true;
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG)
		blank_outs_usable = false;
	if (!free_runs_usable)
		blank_outs_usable = false;
	__misc_state["blank outs usable"] = free_runs_usable;
	
	
	boolean free_runs_available = false;
	if (familiar_is_usable($familiar[pair of stomping boots]) || ($skill[the ode to booze].skill_is_usable() && familiar_is_usable($familiar[Frumious Bandersnatch])))
		free_runs_available = true;
	if ($item[goto].available_amount() > 0 || $item[tattered scrap of paper].available_amount() > 0)
		free_runs_available = true;
	if ($item[greatest american pants].available_amount() > 0 || $item[navel ring of navel gazing].available_amount() > 0 || $item[peppermint parasol].available_amount() > 0)
		free_runs_available = true;
	if ($item[divine champagne popper].available_amount() > 0 || 2371.to_item().available_amount() > 0 || 7014.to_item().available_amount() > 0 || $item[handful of Smithereens].available_amount() > 0)
		free_runs_available = true;
	if ($item[V for Vivala mask].available_amount() > 0 && !get_property_boolean("_vmaskBanisherUsed"))
		free_runs_available = true;
	if (blank_outs_usable)
	{
		if ($item[bottle of Blank-Out].available_amount() > 0 || get_property_int("blankOutUsed") > 0)
			free_runs_available = true;
	}
    if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE && $skill[Peel Out].skill_is_usable())
    {
        
        int total_free_peel_outs_available = 10;
        if (get_property("peteMotorbikeTires") == "Racing Slicks")
            total_free_peel_outs_available += 20;
        int free_peel_outs_available = MAX(0, total_free_peel_outs_available - get_property_int("_petePeeledOut"));
        if (free_peel_outs_available > 0)
            free_runs_available = true;
    }
    if (my_path_id() == PATH_HEAVY_RAINS && $skill[Lightning Strike].skill_is_usable())
        free_runs_available = true;
	if (!free_runs_usable)
		free_runs_available = false;
	__misc_state["free runs available"] = free_runs_available;
	
	
	string olfacted_monster = "";
	boolean some_olfact_available = false;
    boolean some_reusable_olfact_available = false;
	if ($skill[Transcendent Olfaction].skill_is_usable())
    {
		some_olfact_available = true;
        some_reusable_olfact_available = true;
        if ($effect[on the trail].have_effect() > 0)
            olfacted_monster = get_property("olfactedMonster");
    }
    if ($item[odor extractor].available_amount() > 0)
    {
        some_olfact_available = true;
    }
    if ($familiar[nosy nose].familiar_is_usable()) //weakened, but still relevant
    {
        some_olfact_available = true;
    }
    if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
    {
        some_olfact_available = true;
        some_reusable_olfact_available = true;
    }
	__misc_state["have olfaction equivalent"] = some_olfact_available;
    __misc_state_string["olfaction equivalent monster"] = olfacted_monster;
	__misc_state["have reusable olfaction equivalent"] = some_reusable_olfact_available;
	
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_NUCLEAR_AUTUMN)
        __misc_state["campground unavailable"] = true;
	
	boolean skills_temporarily_missing = false;
	boolean familiars_temporarily_blocked = false;
	boolean familiars_temporarily_missing = false;
	if (in_bad_moon())
	{
		skills_temporarily_missing = true;
		familiars_temporarily_missing = true;
	}
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_VAMPIRE)
	{
		skills_temporarily_missing = true;
		familiars_temporarily_missing = true;
		familiars_temporarily_blocked = true;
	}
	if (my_path_id() == PATH_ZOMBIE_SLAYER)
	{
		skills_temporarily_missing = true;
	}
	if (my_path_id() == PATH_CLASS_ACT || my_path_id() == PATH_CLASS_ACT_2)
	{
		//not sure how mafia interprets "have_skill" under class act
		skills_temporarily_missing = true;
	}
	if (my_path_id() == PATH_TRENDY)
	{
		//not sure if this is correct
		//skills_temporarily_missing = true;
		//familiars_temporarily_missing = true;
	}
    if (my_path_id() == PATH_AVATAR_OF_WEST_OF_LOATHING || my_path_id() == PATH_NUCLEAR_AUTUMN || my_path_id() == PATH_GELATINOUS_NOOB || my_path_id() == PATH_G_LOVER)
    {
        skills_temporarily_missing = true;
    }
    if (my_path_id() == PATH_LICENSE_TO_ADVENTURE || my_path_id() == PATH_POCKET_FAMILIARS)
        familiars_temporarily_blocked = true;
	__misc_state["skills temporarily missing"] = skills_temporarily_missing;
	__misc_state["familiars temporarily missing"] = familiars_temporarily_missing;
	__misc_state["familiars temporarily blocked"] = familiars_temporarily_blocked;
	
	
	__misc_state["AT skills available"] = true;
	if (my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_ZOMBIE_SLAYER || ((my_path_id() == PATH_CLASS_ACT || my_path_id() == PATH_CLASS_ACT_2) && my_class() != $class[accordion thief]))
		__misc_state["AT skills available"] = false;
	
	
    __misc_state_float["Non-combat statgain multiplier"] = 1.0;
	__misc_state_float["ML to mainstat multiplier"] = 1.0 / (2.0 * 3.0);
	/*if (my_path_id() == PATH_CLASS_ACT_2)
	{
		__misc_state_float["ML to mainstat multiplier"] = 1.0 / (2.0 * 2.0);
	}*/
    if (false)
    {
        //this does not seem to be the case? FIXME spade please
        __misc_state_float["Non-combat statgain multiplier"] = 0.5;
        __misc_state["Stat gain from NCs reduced"] = false;
    }
	
	int pulls_available = 0;
	pulls_available = pulls_remaining();
    if (__setting_debug_mode && in_ronin())
        pulls_available = MAX(pulls_available, 4);
	__misc_state_int["pulls available"] = pulls_available;
	
    //Calculate free rests available:
    int rests_used = get_property_int("timesRested");
    int total_rests_available = total_free_rests();
    
    __misc_state_int["total free rests possible"] = total_rests_available;
	__misc_state_int["free rests remaining"] = MAX(total_rests_available - rests_used, 0);
    
	
	//monster.monster_initiative() is usually what you need, but just in case:
    __misc_state_float["init ML penalty"] = monsterExtraInitForML(monster_level_adjustment_ignoring_plants());

	
	
	int ngs_needed = 0;
	
    //stats:
    
	if (my_level() < 13 && !__misc_state["in aftercore"])
	{
		__misc_state["need to level"] = true;
	}
    __misc_state["need to level muscle"] = false;
    __misc_state["need to level mysticality"] = false;
    __misc_state["need to level moxie"] = false;
    
    if (__misc_state["in run"])
    {
        //62 muscle for antique machete/hidden hospital
        //70 moxie, 70 mysticality for war outfits
        if (my_primestat() == $stat[muscle] && __misc_state["need to level"])
            __misc_state["need to level muscle"] = true;
        if (my_primestat() == $stat[mysticality] && __misc_state["need to level"])
            __misc_state["need to level mysticality"] = true;
        if (my_primestat() == $stat[moxie] && __misc_state["need to level"])
            __misc_state["need to level moxie"] = true;
        
        if (my_basestat($stat[muscle]) < 62)
            __misc_state["need to level muscle"] = true;
        if (my_basestat($stat[mysticality]) < 70)
            __misc_state["need to level mysticality"] = true;
        if (my_basestat($stat[moxie]) < 70)
            __misc_state["need to level moxie"] = true;
    }
	
	//wand
	
	boolean wand_of_nagamar_needed = true;
	if (my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_BUGBEAR_INVASION || my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_KOLHS || my_path_id() == PATH_HEAVY_RAINS || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_THE_SOURCE || my_path_id() == PATH_LICENSE_TO_ADVENTURE || my_path_id() == PATH_POCKET_FAMILIARS || my_path_id() == PATH_VAMPIRE || my_path_id() == PATH_LUIGI || my_path_id() == PATH_GREY_GOO)
		wand_of_nagamar_needed = false;
		
	int ruby_w_needed = 1;
	int metallic_a_needed = 1;
	int lowercase_n_needed = 1;
	int heavy_d_needed = 1;
	int [string] letters_needed;
	letters_needed["w"] = 1;
	letters_needed["a"] = 1;
	letters_needed["n"] = 1;
	letters_needed["d"] = 1;
	letters_needed["g"] = 0;
	
	int [string] letters_available;
	letters_available["w"] = $item[ruby w].available_amount() + $item[wa].available_amount();
	letters_available["a"] = $item[metallic a].available_amount() + $item[wa].available_amount();
	letters_available["n"] = $item[lowercase n].available_amount() + $item[nd].available_amount() + $item[ng].available_amount();
	letters_available["d"] = $item[heavy d].available_amount() + $item[nd].available_amount();
	letters_needed["n"] += ngs_needed;
	letters_needed["g"] += ngs_needed;
	
	if ($item[wand of nagamar].available_amount() > 0)
		wand_of_nagamar_needed = false;
		
		
		
	if (!wand_of_nagamar_needed)
	{
		letters_needed["w"] -= 1;
		letters_needed["a"] -= 1;
		letters_needed["n"] -= 1;
		letters_needed["d"] -= 1;
	}
	
	letters_needed["w"] = MAX(0, letters_needed["w"] - letters_available["w"]);
	letters_needed["a"] = MAX(0, letters_needed["a"] - letters_available["a"]);
	letters_needed["n"] = MAX(0, letters_needed["n"] - letters_available["n"]);
	letters_needed["d"] = MAX(0, letters_needed["d"] - letters_available["d"]);
		
	__misc_state["wand of nagamar needed"] = wand_of_nagamar_needed;
	__misc_state_int["ruby w needed"] = letters_needed["w"];
	__misc_state_int["metallic a needed"] = letters_needed["a"];
	__misc_state_int["lowercase n needed"] = letters_needed["n"];
	__misc_state_int["lowercase n available"] = letters_available["n"];
	__misc_state_int["heavy d needed"] = letters_needed["d"];
	__misc_state_int["original g needed"] = letters_needed["g"];
	
	
    computeFatLootTokens();
	
	boolean mysterious_island_unlocked = false;
	if ($items[dingy dinghy, skeletal skiff].available_amount() > 0) //junk junk requires completing the quest first
		mysterious_island_unlocked = true;
    
    if (get_property("peteMotorbikeGasTank") == "Extra-Buoyant Tank")
        mysterious_island_unlocked = true;
    if (get_property_ascension("lastIslandUnlock"))
        mysterious_island_unlocked = true;
    if (my_path_id() == PATH_EXPLOSION)
    	mysterious_island_unlocked = true; //kinda
            
    
        
    __misc_state["mysterious island available"] = mysterious_island_unlocked;
    
    
	
	__misc_state["desert beach available"] = false;
    if (get_property("peteMotorbikeGasTank") == "Large Capacity Tank")
        __misc_state["desert beach available"] = true;
    if (get_property_ascension("lastDesertUnlock"))
        __misc_state["desert beach available"] = true;
	if ($location[south of the border].locationAvailable())
		__misc_state["desert beach available"] = true;
	if ($locations[The Shore\, Inc. Travel Agency,the arid\, extra-dry desert,the oasis, south of the border].turnsAttemptedInLocation() > 0) //weird issues with detecting the beach. check if we've ever adventured there as a back-up
		__misc_state["desert beach available"] = true;
    if (my_path_id() == PATH_EXPLOSION)
        __misc_state["desert beach available"] = true;
	
	string ballroom_song = "";
	if (get_property_ascension("lastQuartetAscension"))
	{
		//1 and 3 are a guess
		if (get_property("lastQuartetRequest") == "1")
		{
			ballroom_song = "+ML";
		}
		else if (get_property("lastQuartetRequest") == "2")
		{
			ballroom_song = "-combat";
		}
		else if (get_property("lastQuartetRequest") == "3")
		{
			ballroom_song = "+item";
		}
	}
	__misc_state_string["ballroom song"] = ballroom_song;
	
	__misc_state["Torso aware"] = false;
    if (lookupSkill("Torso Awareness").skill_is_usable() || $skill[Best Dressed].skill_is_usable())
        __misc_state["Torso aware"] = true;
	
	int hipster_fights_used = get_property_int("_hipsterAdv");
	if (hipster_fights_used < 0) hipster_fights_used = 0;
	if (hipster_fights_used > 7) hipster_fights_used = 7;
	
	if (familiar_is_usable($familiar[artistic goth kid])) //goth kid has crayon shavings, which help survivability, though it has that weirdness with early runaways (have to defeat a monster first)
	{
		__misc_state_string["hipster name"] = "goth kid";
		__misc_state_int["hipster fights available"] = 7 - hipster_fights_used;
		__misc_state["have hipster"] = true;
	}
	else if (familiar_is_usable($familiar[Mini-Hipster]))
	{
		__misc_state_string["hipster name"] = "hipster";
		__misc_state_int["hipster fights available"] = 7 - hipster_fights_used;
		__misc_state["have hipster"] = true;
	}
	__misc_state_string["obtuse angel name"] = "";
	if (familiar_is_usable($familiar[reanimated reanimator]))
		__misc_state_string["obtuse angel name"] = "Reanimated Reanimator";
	else if (familiar_is_usable($familiar[obtuse angel]))
		__misc_state_string["obtuse angel name"] = "Obtuse Angel";
	
	if (get_property_ascension("lastPlusSignUnlock"))
		__misc_state["dungeons of doom unlocked"] = true;
	else
		__misc_state["dungeons of doom unlocked"] = false;
	
	__misc_state["can use clovers"] = true;
	if (in_bad_moon() && $items[ten-leaf clover, disassembled clover].available_amount() == 0)
		__misc_state["can use clovers"] = false;
		
		
	__misc_state["bookshelf accessible"] = true;
	if (my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE)
		__misc_state["bookshelf accessible"] = false;
        
    
	__misc_state["can pickpocket"] = false;
    if (my_class() == $class[disco bandit] || my_class() == $class[accordion thief] || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || $item[tiny black hole].equipped_amount() > 0 || $effect[Form of...Bird!].have_effect() > 0)
        __misc_state["can pickpocket"] = true;
    
    if (CounterLookup("Romantic Monster").CounterExists() || get_property_int("_romanticFightsLeft") > 0)
        __misc_state_string["Romantic Monster Name"] = get_property("romanticTarget").HTMLEscapeString();
        
        //Moxie Experience Percent
    float dance_card_average_stat_gain = MIN(2.25 * my_basestat($stat[moxie]), 300.0) * __misc_state_float["Non-combat statgain multiplier"] * (1.0 + numeric_modifier("Moxie Experience Percent") / 100.0);
    __misc_state_float["dance card average stats"] = dance_card_average_stat_gain;
    
    //don't know if there's any way to query this information directly, so indirectly calculate it from scaling monsters in the area:
    __misc_state_int["Basement Floor"] = MAX(1, round(powf(MAX(0.0, ($monster[Ghost of Fernswarthy's Grandfather].raw_defense - monster_level_adjustment()).to_float() / 2.0), 5.0 / 7.0)));
    
    if (true)
    {
        //calculate if we need -combat sources:
        int minus_combat_source_count = 0;
        int minus_combat_from_accessories = 0;
        
        foreach it in __minus_combat_equipment
        {
            if (!(it.can_equip() && it.available_amount() > 0))
                continue;
            if (it == $item[none])
                continue;
            if (it == $item[over-the-shoulder folder holder])
            {
            }
            int value = -it.numeric_modifier("combat rate");
            if ($slots[acc1,acc2,acc3] contains it.to_slot())
                minus_combat_from_accessories += value;
            else
                minus_combat_source_count += value;
        }
        if ($item[over-the-shoulder folder holder].available_amount() > 0)
        {
            //check if we have the -combat folder:
            boolean [item] equipped_folders;
            foreach s in $slots[folder1,folder2,folder3,folder4,folder5]
            {
                equipped_folders[s.equipped_item()] = true;
            }
            if (!(equipped_folders contains $item[folder (Ex-Files)]))
            {
                if (equipped_folders contains $item[folder (skull and crossbones)])
                {
                    minus_combat_from_accessories += 5;
                }
            }
        }
        
        minus_combat_source_count += MIN(3 * 5, minus_combat_from_accessories); //three at most
        
        if ($skill[smooth movement].skill_is_usable())
            minus_combat_source_count += 5;
        if ($skill[the sonata of sneakiness].skill_is_usable())
            minus_combat_source_count += 5;
        if ($items[crown of thrones,buddy bjorn].available_amount() > 0 && $familiar[grimstone golem].have_familiar() && !__misc_state["familiars temporarily blocked"])
            minus_combat_source_count += 5;
        if (my_path_id() == PATH_AVATAR_OF_BORIS && $skill[song of solitude].skill_is_usable())
            minus_combat_source_count += 5 * 4;
        if (my_path_id() == PATH_ZOMBIE_SLAYER && $skill[disquiet riot].skill_is_usable())
            minus_combat_source_count += 5 * 4;
        if (my_path_id() == PATH_AVATAR_OF_JARLSBERG && $skill[chocolatesphere].skill_is_usable())
            minus_combat_source_count += 5 * 3;
        if (__iotms_usable[$item[Asdon Martin keyfob]])
            minus_combat_source_count += 10;
        if (my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE)
        {
            if ($skill[Brood].skill_is_usable())
                minus_combat_source_count += 5 * 2;
            if (get_property("peteMotorbikeMuffler") == "Extra-Quiet Muffler" && $skill[Rev Engine].skill_is_usable())
                minus_combat_source_count += 5 * 3;
        }
        if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        {
            if ($skill[Shelter of Shed].have_skill())
                minus_combat_source_count += 5 * 4;
        }
        if (minus_combat_source_count >= 25)
            __misc_state["can reasonably reach -25% combat"] = true;
    }
    if (my_path_id() == PATH_LIVE_ASCEND_REPEAT)
        __misc_state["can reasonably reach -25% combat"] = true;
    
    if (!in_bad_moon() && $item[hand turkey outline].is_unrestricted())
    {
        foreach s in $strings[spooky,sleaze,hot,cold,stench]
        {
            if (get_property_boolean(s + "AirportAlways") || get_property_boolean("_" + s + "AirportToday"))
                __misc_state[s + " airport available"] = true;
        }
    }
    
    if (get_property_boolean("chateauAvailable") && !in_bad_moon() && $item[Chateau Mantegna room key].is_unrestricted())
    {
        __misc_state["Chateau Mantegna available"] = true;
    }
    
    
    __misc_state_string["resting url"] = "campground.php";
    __misc_state_string["resting description"] = "your campsite";
    __misc_state["recommend resting at campsite"] = true;
    if (__misc_state["Chateau Mantegna available"])// && (my_level() < 13 || __misc_state["need to level"] || $item[pantsgiving].available_amount() == 0))
    {
        __misc_state_string["resting url"] = "place.php?whichplace=chateau";
        __misc_state_string["resting description"] = "Chateau Mantegna";
        __misc_state["recommend resting at campsite"] = false;
    }
    
    if ($classes[seal clubber,turtle tamer] contains my_class())
        __misc_state["guild open"] = QuestState("questG09Muscle").finished;
    else if ($classes[pastamancer,sauceror] contains my_class())
        __misc_state["guild open"] = QuestState("questG07Myst").finished;
    else if ($classes[disco bandit,accordion thief] contains my_class())
        __misc_state["guild open"] = QuestState("questG08Moxie").finished;
    if (guild_store_available())
        __misc_state["guild open"] = true;
    
    
    __misc_state["muscle guild store available"] = false;
    __misc_state["mysticality guild store available"] = false;
    __misc_state["moxie guild store available"] = false;
    if (guild_store_available())
    {
        if ($classes[seal clubber, turtle tamer] contains my_class())
            __misc_state["muscle guild store available"] = true;
        if ($classes[pastamancer, sauceror] contains my_class())
            __misc_state["mysticality guild store available"] = true;
        if ($classes[disco bandit,accordion thief] contains my_class())
            __misc_state["moxie guild store available"] = true;
        
        if (my_class() == $class[accordion thief] && my_level() >= 9)
        {
            __misc_state["muscle guild store available"] = true;
            __misc_state["mysticality guild store available"] = true;
        }
    }

    __misc_state["can purchase magical mystery juice"] = __misc_state["mysticality guild store available"];
    __misc_state["have some reasonable way of restoring MP"] = false;
    
    if (__misc_state["can purchase magical mystery juice"] || black_market_available() || dispensary_available() || true)
        __misc_state["have some reasonable way of restoring MP"] = true;
    
    if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
        __misc_state["monsters can be nearly impossible to kill"] = true;
    
    int tonic_price = $item[Doc Galaktik's Invigorating Tonic].npc_price();
    if (tonic_price == 0)
        tonic_price = 90; //wrong, but w/e
    __misc_state_float["meat per MP"] = tonic_price.to_float() / 10.0;
    
    float soda_cost = -1.0;
    if (black_market_available())
        soda_cost = $item[black cherry soda].npc_price();
    else if (dispensary_available())
        soda_cost = $item[knob goblin seltzer].npc_price();
    else if (!in_ronin()) //can't buy from NPC, so have to use mall price:
        soda_cost = 100; //$item[knob goblin seltzer].mall_price(); //don't issue a mall search, we don't need it
    
    if (soda_cost > 0.0)
    {
        __misc_state_float["meat per MP"] = MIN(__misc_state_float["meat per MP"], soda_cost / 10.0);
    }
    
    if (__misc_state["can purchase magical mystery juice"])
    {
        float juice_cost = $item[magical mystery juice].npc_price();
        float mp_restored = 5.0 + my_level().to_float() * 1.5;
        
        if (juice_cost > 0.0)
            __misc_state_float["meat per MP"] = MIN(__misc_state_float["meat per MP"], juice_cost / mp_restored);
    }
    
    //FIXME all avatar paths:
    if (my_path_id() == PATH_GELATINOUS_NOOB || my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_AVATAR_OF_BORIS || my_path_id() == PATH_AVATAR_OF_JARLSBERG || my_path_id() == PATH_KOLHS || my_path_id() == PATH_CLASS_ACT_2 || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_COMMUNITY_SERVICE || my_path_id() == PATH_THE_SOURCE || my_path_id() == PATH_EXPLOSIONS)
        __misc_state["sea access blocked"] = true;

}


void setUpQuestStateViaMafia()
{
	QuestsInit();
	SetsInit();
    
    foreach key, function_name in __init_functions
        call function_name();
	
	//Opening guild quest
	if (true)
	{
		//???
		QuestState state;
		state.startable = true;
	}
}


void finaliseSetUpState()
{
	//done after quest parsing
	
	if (__misc_state["Example mode"])
	{
		__misc_state["need to level"] = true;
        if (my_primestat() == $stat[muscle])
            __misc_state["need to level muscle"] = true;
        if (my_primestat() == $stat[mysticality])
            __misc_state["need to level mysticality"] = true;
        if (my_primestat() == $stat[moxie])
            __misc_state["need to level moxie"] = true;
	}
	
	if (__misc_state_int["pulls available"] > 0)
	{
		PullsInit();
	}
    computeFatLootTokens();
	
	finaliseSetUpFloristState();
}

void setUpQuestState()
{
    if (__misc_state["In valhalla"])
        return;
	setUpQuestStateViaMafia();
}




RegisterGenerationFunction("MissingItemsGenerate");
//void generateMissingItems(Checklist [int] checklists)
void MissingItemsGenerate(ChecklistCollection checklists)
{
	ChecklistEntry [int] items_needed_entries;
	
	if (!__misc_state["in run"])
		return;
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
        return;
	
    //thought about using getClickableURLForLocationIfAvailable for these, but our location detection is very poor, and there are corner cases regardless
	
	if (__misc_state["wand of nagamar needed"])
	{
		ChecklistSubentry [int] subentries;
		
		subentries.listAppend(ChecklistSubentryMake("Wand of Nagamar", "", ""));
		
        Record WandComponentSource
        {
            item component;
            int drop_rate;
            monster monster_dropped_from;
            location location_dropped_from;
        };
        void listAppend(WandComponentSource [int] list, WandComponentSource entry)
        {
            int position = list.count();
            while (list contains position)
                position += 1;
            list[position] = entry;
        }
        
        WandComponentSource [int] component_sources;
        
        if (__misc_state_int["ruby w needed"] > 0)
        {
            WandComponentSource source;
            source.component = $item[ruby w];
            source.drop_rate = 30;
            source.monster_dropped_from = $monster[W imp];
            if (__quest_state["Level 6"].finished)
                source.location_dropped_from = $location[Pandamonium Slums];
            else
                source.location_dropped_from = $location[the dark neck of the woods];
            component_sources.listAppend(source);
        }
        
		if (__misc_state_int["metallic a needed"] > 0)
        {
            WandComponentSource source;
            source.component = $item[metallic a];
            source.drop_rate = 30;
            source.monster_dropped_from = $monster[MagiMechTech MechaMech];
            source.location_dropped_from = $location[The Penultimate Fantasy Airship];
            component_sources.listAppend(source);
        }
        
        if (__misc_state_int["lowercase n needed"] > 0 && __misc_state_int["lowercase n available"] == 0)
        {
            WandComponentSource source;
            source.component = $item[lowercase n];
            source.drop_rate = 30;
            source.monster_dropped_from = $monster[XXX pr0n];
            source.location_dropped_from = $location[The Valley of Rof L'm Fao];
            component_sources.listAppend(source);
        }
        
		if (__misc_state_int["heavy d needed"] > 0)
        {
            WandComponentSource source;
            source.component = $item[heavy d];
            source.drop_rate = 40;
            source.monster_dropped_from = $monster[Alphabet Giant];
            source.location_dropped_from = $location[The Castle in the Clouds in the Sky (Basement)];
            component_sources.listAppend(source);
        }
        
        foreach key, source in component_sources
        {
            if (source.component.available_amount() > 0)
                continue;
            string modifier_text = "";
            if (!in_bad_moon())
                modifier_text = "Clover or ";
            if (source.drop_rate > 0 && source.drop_rate < 100)
            {
                int drop_rate_inverse = ceil(100.0 / source.drop_rate.to_float() * 100.0 - 100.0);
                modifier_text += "+" + drop_rate_inverse + "% item";
            }
            
            string [int] description;
            if (!in_bad_moon())
                description.listAppend("Clover the castle basement.");
            description.listAppend(source.monster_dropped_from + " - " + source.location_dropped_from + " - " + source.drop_rate + "% drop");
			subentries.listAppend(ChecklistSubentryMake(source.component, modifier_text, description));
        }
        
        if (subentries.count() == 1)
            subentries[0].entries.listAppend("Can create it.");
        else if (!__misc_state["can use clovers"])
            subentries[0].entries.listAppend("Either meatpaste together, or find after losing to the naughty sorceress. (" + (in_bad_moon() ? "probably faster" : "usually slower") + ")");
			
		ChecklistEntry entry = ChecklistEntryMake(206, "__item wand of nagamar", $location[the castle in the clouds in the sky (basement)].getClickableURLForLocation(), subentries);
		entry.should_indent_after_first_subentry = true;
		
		items_needed_entries.listAppend(entry);
	}
	
	if (!__quest_state["Level 13"].state_boolean["past keys"])
	{
		//Key items:
		
		if ($item[skeleton key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["skeleton key used"])
		{
			string line = "loose teeth";
			if ($item[loose teeth].available_amount() == 0)
				line += " (need)";
			else
				line += " (have)";
			line += " + skeleton bone";
			if ($item[skeleton bone].available_amount() == 0)
				line += " (need)";
			else
				line += " (have)";
			items_needed_entries.listAppend(ChecklistEntryMake(207, "__item skeleton key", $location[the defiled nook].getClickableURLForLocation(), ChecklistSubentryMake("Skeleton key", "", line)));
		}
		
		if ($item[digital key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["digital key used"])
		{
			string [int] options;
            if ($item[digital key].creatable_amount() > 0)
            {
                options.listAppend("Have enough pixels, make it.");
            }
            else
            {
            	if ($item[jar of psychoses (The Crackpot Mystic)].is_unrestricted() && (!in_hardcore() || $familiar[angry jung man].have_familiar()))
	                options.listAppend("Fear man's level (jar)");
                if (__misc_state["fax equivalent accessible"] && in_hardcore()) //not suggesting this in SC
                    options.listAppend("Fax/copy a ghost");
                options.listAppend("8-bit realm (olfact blooper, slow)");
                if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
                    options.listAppend("Wait for pixellated monsters");
                
                int total_white_pixels = $item[white pixel].available_amount() + $item[white pixel].creatable_amount();
                if (total_white_pixels > 0)
                    options.listAppend(total_white_pixels + "/30 white pixels found.");
            }
            //FIXME URL?
			items_needed_entries.listAppend(ChecklistEntryMake(208, "__item digital key", "", ChecklistSubentryMake("Digital key", "", options)));
		}
		string from_daily_dungeon_string = "From daily dungeon";
		if ($item[fat loot token].available_amount() > 0)
			from_daily_dungeon_string += "|" + pluralise($item[fat loot token]) + " available";
		if ($item[sneaky pete's key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["Sneaky Pete's key used"])
		{
			string [int] options;
			options.listAppend(from_daily_dungeon_string);
			if (__misc_state_int["pulls available"] > 0 && __misc_state["can eat just about anything"])
				options.listAppend("From key lime pie");
			items_needed_entries.listAppend(ChecklistEntryMake(209, "__item Sneaky Pete's key", "da.php", ChecklistSubentryMake("Sneaky Pete's key", "", options)));
		}
		if ($item[jarlsberg's key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["Jarlsberg's key used"])
		{
			string [int] options;
			options.listAppend(from_daily_dungeon_string);
			if (__misc_state_int["pulls available"] > 0 && __misc_state["can eat just about anything"])
				options.listAppend("From key lime pie");
			items_needed_entries.listAppend(ChecklistEntryMake(210, "__item jarlsberg's key", "da.php", ChecklistSubentryMake("Jarlsberg's key", "", options)));
		}
		if ($item[Boris's key].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["Boris's key used"])
		{
			string [int] options;
			options.listAppend(from_daily_dungeon_string);
			if (__misc_state_int["pulls available"] > 0 && __misc_state["can eat just about anything"])
				options.listAppend("From key lime pie");
			items_needed_entries.listAppend(ChecklistEntryMake(211, "__item Boris's key", "da.php", ChecklistSubentryMake("Boris's key", "", options)));
		}
        
	}
	
	if ($item[lord spookyraven's spectacles].available_amount() == 0 && __quest_state["Level 11 Manor"].state_boolean["Can use fast route"] && !__quest_state["Level 11 Manor"].finished)
		items_needed_entries.listAppend(ChecklistEntryMake(212, "__item lord spookyraven's spectacles", $location[the haunted bedroom].getClickableURLForLocation(), ChecklistSubentryMake("Lord Spookyraven's spectacles", "", "Found in Haunted Bedroom")));
    
    if ($item[enchanted bean].available_amount() == 0 && !__quest_state["Level 10"].state_boolean["beanstalk grown"])
    {
		items_needed_entries.listAppend(ChecklistEntryMake(213, "__item enchanted bean", $location[The Beanbat Chamber].getClickableURLForLocation(), ChecklistSubentryMake("Enchanted bean", "", "Found in the beanbat chamber.")));
    }
    
    if (__quest_state["Level 13"].state_boolean["shadow will need to be defeated"])
    {
        //Let's see
        //5 gauze garters + filthy poultices
        //Or...
        //red pixel potion (not worth farming, but if they have it...)
        //red potion
        //extra-strength red potion (they might find it)
        
    }
    if (__quest_state["Level 11 Palindome"].state_boolean["Need instant camera"])
    {
        item camera = 7266.to_item();
        if (camera != $item[none])
        {
            items_needed_entries.listAppend(ChecklistEntryMake(214, "__item " + camera, $location[the haunted bedroom].getClickableURLForLocation(), ChecklistSubentryMake("Disposable instant camera", "", "Found in the Haunted Bedroom.")));
        }
    }
    
    if ($item[electric boning knife].available_amount() == 0 && __quest_state["Level 13"].state_boolean["wall of bones will need to be defeated"] && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        string [int] description;
        description.listAppend("Found from an NC on the ground floor of the castle in the clouds in the sky.");
        boolean can_towerkill = false;
        if ($skill[garbage nova].skill_is_usable())
        {
            description.listAppend("Ignore this, you can towerkill with Garbage Nova.");
            can_towerkill = true;
        }
        else if (!in_bad_moon())
            description.listAppend("Or towerkill.");
        if (!can_towerkill && !__quest_state["Level 13"].state_boolean["past tower level 2"] && $location[the castle in the clouds in the sky (top floor)].locationAvailable())
            description.listAppend("Don't collect this right now; wait until you're at the wall of bones.|(probability of appearing increases)");
        items_needed_entries.listAppend(ChecklistEntryMake(215, "__item electric boning knife", $location[the castle in the clouds in the sky (ground floor)].getClickableURLForLocation(), ChecklistSubentryMake("Electric boning knife", "-combat", description)));
    }
    if ($item[beehive].available_amount() == 0 && __quest_state["Level 13"].state_boolean["wall of skin will need to be defeated"] && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        string [int] description;
        
        description.listAppend("Found from an NC in the black forest.");
        
        if (get_property_int("blackForestProgress") >= 1)
            description.listAppend(listMake("Head toward the blackberry patch", "Head toward the buzzing sound", "Keep going", "Almost... there...").listJoinComponents(__html_right_arrow_character));
        else
            description.listAppend("Not available yet.");
        if (!in_bad_moon())
            description.listAppend("Or towerkill.");
        
        items_needed_entries.listAppend(ChecklistEntryMake(216, "__item beehive", $location[the black forest].getClickableURLForLocation(), ChecklistSubentryMake("Beehive", "-combat", description)));
    }
    
    if (!__quest_state["Level 13"].state_boolean["Init race completed"])
    {
        ChecklistSubentry subentry = ChecklistSubentryMake("Sources", "", "For the lair races.");
        string [int] sources;
        if (!__quest_state["Level 13"].state_boolean["Init race completed"])
        {
            subentry.modifiers.listAppend("+init");
            sources.listAppend("init");
            //subentries.listAppend(ChecklistSubentryMake("+init sources", "+init", "For the lair races."));
        }
        if (!__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "")
        {
            //
            subentry.modifiers.listAppend("+" + __quest_state["Level 13"].state_string["Stat race type"]);
            sources.listAppend(__quest_state["Level 13"].state_string["Stat race type"]);
        }
        if (!__quest_state["Level 13"].state_boolean["Elemental damage race completed"] && __quest_state["Level 13"].state_string["Elemental damage race type"] != "")
        {
            //
            string type = __quest_state["Level 13"].state_string["Elemental damage race type"];
            string type_class = "r_element_" + type + "_desaturated";
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+" + type + " damage", type_class));
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+" + type + " spell damage", type_class));
            sources.listAppend(type);
        }
        string [int] relevant_elements;
        foreach s in $strings[nsChallenge3,nsChallenge4,nsChallenge5]
        {
            element e = get_property_element(s);
            if (e == $element[none]) continue;
            if (numeric_modifier(e + " resistance") >= 7)
                continue;
            string type_class = "r_element_" + e;
            string type_class_desaturated = "r_element_" + e + "_desaturated";
            relevant_elements.listAppend(HTMLGenerateSpanOfClass("+" + e, type_class) + " resistance");
            subentry.modifiers.listAppend(HTMLGenerateSpanOfClass("+" + e, type_class_desaturated) + " res");
        }
        if (relevant_elements.count() > 0)
            subentry.entries.listAppend(relevant_elements.listJoinComponents(", ", "and").capitaliseFirstLetter() + " for the hedge maze.");
        
        subentry.header = sources.listJoinComponents(", ", "and").capitaliseFirstLetter() + " sources";
        if (subentry.modifiers.count() > 0)
            items_needed_entries.listAppend(ChecklistEntryMake(217, "__item vial of patchouli oil", "", subentry));
    }
                               
    SetsGenerateMissingItems(items_needed_entries);
	
	foreach key, entry in items_needed_entries
		checklists.add(C_REQUIRED_ITEMS, entry);
}







void generateTasks(Checklist [int] checklists)
{
	ChecklistEntry [int] task_entries;
	
	ChecklistEntry [int] optional_task_entries;
		
	ChecklistEntry [int] future_task_entries;
	
	QuestsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
	SetsGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    
	checklists.listAppend(ChecklistMake("Tasks", task_entries));
	checklists.listAppend(ChecklistMake("Optional Tasks", optional_task_entries));
	checklists.listAppend(ChecklistMake("Future Tasks", future_task_entries));
}
/*
Random notes:
-Having both a torch and mining helmet equipped will drop items from both, but not sure if at the same time.

Relevant URLs:
http://forums.kingdomofloathing.com/vb/showthread.php?p=4721915#post4721915
http://forums.kingdomofloathing.com/vb/showthread.php?p=4713383#post4713383
http://forums.kingdomofloathing.com/vb/showthread.php?p=4717434#post4717434
http://forums.kingdomofloathing.com/vb/showthread.php?p=4730373#post4730373
http://forums.kingdomofloathing.com/vb/showpost.php?p=4749602&postcount=19
*/

//should we record spelunkyUpgrades here? may not use them
Record SpelunkingStatus
{
    boolean [location] areas_unlocked;
    boolean altar_unlocked;
    boolean noncombat_due_next_adventure;
    boolean sticky_bombs_unlocked;
    int turns_left;
    int gold;
    int bombs;
    int ropes;
    int keys;
    int sacrifices;
    string buddy;
};

location SpelunkingLookupLocationStatusName(string entry)
{
    if (entry == "Burial Ground")
        return $location[The Ancient Burial Ground];
    if (entry == "LOLmec's Lair")
        return $location[LOLmec's Lair];
    if (entry == "Hell")
        return $location[Hell];
    if (entry == "Yomama's Throne")
        return $location[Yomama's Throne];
    return ("The " + entry).to_location();
}

SpelunkingStatus SpelunkingParseStatus()
{
    //spelunkyStatus(user, now 'Turns: 3, Gold: 150, Bombs: 2, Ropes: 0, Keys: 0, Buddy: A Helpful Guy, Unlocks: , Jungle, Burial Ground, Spider Hole, Sticky Bombs', default )
    //spelunkyStatus(user, now 'Turns: 10, Gold: 209, Bombs: 6, Ropes: 3, Keys: 0, Buddy: , Unlocks: Jungle, Ice Caves, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit, Snake Pit', default )
    SpelunkingStatus spelunking_status;
    spelunking_status.areas_unlocked[$location[The Mines]] = true;
    
    boolean past_unlocks = false;
    string [int] status_split = get_property("spelunkyStatus").split_string(", ");
    
    spelunking_status.sacrifices = get_property_int("spelunkySacrifices");
    foreach key, entry in status_split
    {
        if (entry == "Non-combat Due")
        {
            spelunking_status.noncombat_due_next_adventure = true;
            continue;
        }
        if (entry.stringHasPrefix("Unlocks:"))
        {
            past_unlocks = true;
            entry = entry.replace_string("Unlocks: ", "");
        }
        if (past_unlocks)
        {
            if (entry == "Sticky Bombs") //this is treated as an "Unlocks"
                spelunking_status.sticky_bombs_unlocked = true;
            else if (entry == "Altar")
                spelunking_status.altar_unlocked = true;
            else
            {
                location l = SpelunkingLookupLocationStatusName(entry);
                if (l != $location[none])
                    spelunking_status.areas_unlocked[l] = true;
            }
        }
        
        if (entry.contains_text(": "))
        {
            string [int] split_entry = entry.split_string(": "); //hopefully, there isn't one that has a : inside of it... FIXME
            if (split_entry.count() < 2)
                continue;
            string header = split_entry[0];
            if (header == "Turns")
                spelunking_status.turns_left = split_entry[1].to_int_silent();
            else if (header == "Gold")
                spelunking_status.gold = split_entry[1].to_int_silent();
            else if (header == "Bombs")
                spelunking_status.bombs = split_entry[1].to_int_silent();
            else if (header == "Ropes")
                spelunking_status.ropes = split_entry[1].to_int_silent();
            else if (header == "Keys")
                spelunking_status.keys = split_entry[1].to_int_silent();
            else if (header == "Buddy")
                spelunking_status.buddy = split_entry[1].replace_string("A ", "");
            else
            {
                if (__setting_debug_mode)
                {
                    print_html("Unknown entry type \"" + entry + "\"");
                }
            }
        }
    }
    return spelunking_status;
}

void SpelunkingGenerateNCInformation(SpelunkingStatus spelunking_status, ChecklistEntry [int] task_entries, ChecklistEntry [int] future_task_entries)
{
    
    ChecklistEntry entry = ChecklistEntryMake(417);
    entry.image_lookup_name = "__item sunken chest";
    entry.should_indent_after_first_subentry = true;
    
    string first_entry_title = "";
    boolean very_important = false;
    if (spelunking_status.noncombat_due_next_adventure)
    {
        very_important = true;
        first_entry_title = "Non-combat next adventure";
        entry.url = "place.php?whichplace=spelunky";
    }
    else
    {
        int turns_left = clampi(3 - get_property_int("spelunkyWinCount"), 0, 3);
        first_entry_title = "Non-combat after " + pluraliseWordy(turns_left, "combat", "combats");
    }
    int phase = get_property_int("spelunkyNextNoncombat");
    entry.subentries.listAppend(ChecklistSubentryMake(first_entry_title, "", "Next phase is " + phase.int_to_wordy() + "."));
    
    
    location [int] shopping_areas;
    location [int] crate_areas;
    location [int] tombstone_areas;
    
    location [int] evaluation_order;
    evaluation_order.listAppend($location[The Snake Pit]);
    evaluation_order.listAppend($location[The Mines]);
    evaluation_order.listAppend($location[The Spider Hole]);
    evaluation_order.listAppend($location[The Ancient Burial Ground]);
    evaluation_order.listAppend($location[The Jungle]);
    evaluation_order.listAppend($location[The Beehive]);
    evaluation_order.listAppend($location[the crashed u. f. o.]);
    evaluation_order.listAppend($location[The Ice Caves]);
    evaluation_order.listAppend($location[The City of Goooold]);
    evaluation_order.listAppend($location[The Temple Ruins]);
    
    //FIXME Some of these gold listings are inaccurate, I think.
    foreach key, l in evaluation_order
    {
        if (!spelunking_status.areas_unlocked[l])
            continue;
        string [int] description;
        if (l == $location[the mines])
        {
            if (phase == 1)
            {
                description.listAppend("20 gold.");
                if ($item[pot].available_amount() == 0)
                    description.listAppend("A pot. (deals 20 damage, gives 10 gold once when thrown)");
            }
            else if (phase == 2)
            {
                shopping_areas.listAppend(l);
                continue;
            }
            else if (phase == 3)
            {
                //
                if (!spelunking_status.areas_unlocked[$location[the snake pit]] && spelunking_status.bombs > 0 && !spelunking_status.areas_unlocked[$location[the spider hole]])
                {
                    description.listAppend("Unlock the Snake Pit, at the cost of a bomb.|Blocks out the Spider Hole.");
                }
                if (!spelunking_status.areas_unlocked[$location[the spider hole]] && spelunking_status.bombs > 0 && !spelunking_status.areas_unlocked[$location[the snake pit]])
                {
                    description.listAppend("Unlock the Spider Hole, at the cost of a rope.|Leads to sticky bombs. Blocks out the Snake Pit.");
                }
                
                string [int] damage_avoidance;
                if ($item[trusty whip].available_amount() > 0)
                {
                    string line = "take 0 or 5 damage";
                    if ($item[trusty whip].equipped_amount() == 0)
                        line += " (equip whip first)";
                    damage_avoidance.listAppend(line);
                }
                if ($slot[off-hand].equipped_item() != $item[none])
                    damage_avoidance.listAppend("sacrifice an off-hand");
                
                if (damage_avoidance.count() == 0)
                    damage_avoidance.listAppend("take 10 damage");
                description.listAppend(damage_avoidance.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
            }
        }
        else if (l == $location[the jungle])
        {
            if (phase == 1)
            {
                shopping_areas.listAppend(l);
                continue;
            }
            else if (phase == 2)
            {
                tombstone_areas.listAppend(l);
                continue;
            }
            else if (phase == 3)
            {
                if (!spelunking_status.areas_unlocked[$location[The Beehive]] && spelunking_status.bombs > 0 && !spelunking_status.areas_unlocked[$location[The Ancient Burial Ground]])
                {
                    string line = "Unlock the Beehive, at the cost of a bomb";
                    if (!spelunking_status.sticky_bombs_unlocked)
                        line += " and 15 damage";
                    
                    line += ".|Blocks out the Ancient Burial Ground.";
                    description.listAppend(line);
                }
                if (!spelunking_status.areas_unlocked[$location[The Ancient Burial Ground]] && spelunking_status.ropes > 0 && !spelunking_status.areas_unlocked[$location[The Beehive]])
                {
                    string line = "Unlock the Ancient Burial Ground, at the cost of a rope";
                    if ($item[yellow cape].available_amount() == 0 && $item[jetpack].available_amount() == 0)
                        line += " and 15 damage";
                    line += ".";
                    
                    if ($item[yellow cape].equipped_amount() == 0 && $item[jetpack].equipped_amount() == 0)
                    {
                        if ($item[jetpack].available_amount() > 0)
                            line += " (equip jetpack first)";
                        else if ($item[yellow cape].available_amount() > 0)
                            line += " (equip yellow cape first)";
                    }
                    line += "|Useful for a different-phase Clown Crown. Blocks out the Beehive.";
                    description.listAppend(line);
                }
                
                if ($item[spring boots].available_amount() > 0)
                {
                    string line = "Nothing.";
                    if ($item[spring boots].equipped_amount() == 0)
                        line += " (equip spring boots first)";
                    description.listAppend(line);
                }
                else
                    description.listAppend("Take 30 damage.");
            }
        }
        else if (l == $location[The Ice Caves])
        {
            if (phase == 1)
            {
                shopping_areas.listAppend(l);
                continue;
            }
            else if (phase == 2)
            {
                string line = "+50-60 gold";
                if ($item[cursed coffee cup].available_amount() > 0)
                {
                    line += ", restore 30 HP.";
                    if ($item[cursed coffee cup].equipped_amount() == 0)
                        line += " (equip cursed coffee cup first)";
                }
                else
                    line += ".";
                description.listAppend(line);
                
                if ($item[torch].available_amount() > 0)
                {
                    line = "";
                    if (spelunking_status.buddy.length() == 0)
                        line = "Gain a spelunking buddy.";
                    else
                        line = "Gain 60-70 gold.";
                    
                    if ($item[torch].equipped_amount() == 0)
                        line += " (equip a torch first)";
                    description.listAppend(line);
                }
            }
            else if (phase == 3)
            {
                if (!spelunking_status.altar_unlocked)
                {
                    description.listAppend("Unlock the Altar, take 10 damage.|Blocks out U.F.O.");
                }
                if (!spelunking_status.areas_unlocked[$location[The Crashed U. F. O.]] && spelunking_status.ropes >= 3 && !spelunking_status.altar_unlocked)
                    description.listAppend("Unlock the Crashed U. F. O., at the cost of three ropes.|Blocks out altar.");
                description.listAppend("Take 30 damage.");
            }
        }
        else if (l == $location[The Temple Ruins])
        {
            if (phase == 1)
            {
                crate_areas.listAppend(l);
                continue;
            }
            else if (phase == 2)
            {
                if (spelunking_status.buddy == "Resourceful Kid")
                {
                    description.listAppend("+250 gold.");
                }
                else if ($item[jetpack].available_amount() > 0)
                {
                    string line = "+250 gold.";
                    if ($item[jetpack].equipped_amount() == 0 && !($item[spring boots].equipped_amount() > 0 && $item[yellow cape].equipped_amount() > 0))
                        line += " (equip jetpack first)";
                    description.listAppend(line);
                }
                else if ($items[spring boots,yellow cape].items_missing().count() == 0)
                {
                    string line = "+250 gold.";
                    string [int] items_to_equip;
                    foreach it in $items[spring boots,yellow cape]
                    {
                        if (it.equipped_amount() == 0)
                            items_to_equip.listAppend(it);
                    }
                    if (items_to_equip.count() > 0)
                        line += " (equip " + items_to_equip.listJoinComponents(", ", "and") + " first)";
                    description.listAppend(line);
                    
                }
                else
                {
                    description.listAppend("+250 gold, lose all HP.");
                }
            }
            else if (phase == 3)
            {
                if (spelunking_status.keys > 0 && !spelunking_status.areas_unlocked[$location[The City of Goooold]])
                {
                    description.listAppend("Unlock The City of Goooold, at the cost of one key.");
                }
                else
                    description.listAppend("Take 40 damage.");
            }
        }
        else if ($locations[the snake pit,the beehive,the crashed u. f. o.] contains l)
        {
            crate_areas.listAppend(l);
            continue;
        }
        else if (l == $location[The Spider Hole])
        {
            boolean no_period = false;
            string line = "15-20 gold";
            if ($item[cursed coffee cup].available_amount() > 0)
            {
                //line += " and " + (MIN(my_maxhp() - my_hp(), 30)) + " HP.";
                line += " and restore 30 HP."; //consistency
                if ($item[cursed coffee cup].equipped_amount() == 0)
                {
                    line += " (equip the cursed coffee cup first)";
                    no_period = true;
                }
            }
            if (!no_period)
                line += ".";
            description.listAppend(line);
            
            if ($item[sturdy machete].available_amount() > 0)
            {
                if (spelunking_status.buddy.length() == 0)
                    line = "A buddy.";
                else
                    line = "30?-40 gold."; //????
                if ($item[sturdy machete].equipped_amount() == 0)
                    line += " (equip a sturdy machete first)";
                description.listAppend(line);
            }
            if ($item[torch].available_amount() > 0)
            {
                line = "30-50 gold.";
                if ($item[torch].equipped_amount() == 0)
                    line += " (equip a torch first)";
                description.listAppend(line);
            }
        }
        else if (l == $location[The Ancient Burial Ground])
        {
            tombstone_areas.listAppend(l);
            continue;
        }
        else if (l == $location[The City of Goooold])
        {
            if (spelunking_status.keys > 0)
                description.listAppend("+150 gold, at the cost of a key.");
            if (spelunking_status.bombs > 0)
                description.listAppend("+80-100 gold, at the cost of a bomb.");
            description.listAppend("+60 gold, but take 20 damage.");
        }
        entry.subentries.listAppend(ChecklistSubentryMake(l, "", description));
    }
    if (shopping_areas.count() > 0)
    {
        string [int] description;
        description.listAppend("Shopkeeper.");
        
        string [int] possible_inventory;
        possible_inventory.listAppend("bombs");
        possible_inventory.listAppend("ropes");
        possible_inventory.listAppend("a key");
        foreach it in $items[spelunking fedora,boomerang,sturdy machete,heavy pickaxe,spiked boots,spring boots,mining helmet,X-ray goggles,yellow cape,shotgun,jetpack]
        {
            if (it.available_amount() == 0)
                possible_inventory.listAppend(it);
        }
        description.listAppend("Could have " + possible_inventory.listJoinComponents(", ", "or") + ".");
        entry.subentries.listAppend(ChecklistSubentryMake(shopping_areas.listJoinComponents(", ", "or"), "", description));
    }
    if (crate_areas.count() > 0)
    {
        string [int] drops;
        drops.listAppend("3 ropes");
        drops.listAppend("3 bombs");
        foreach it in $items[heavy pickaxe,jetpack,sturdy machete,spring boots]
        {
            //seen crate give duplicate spring boots before
            drops.listAppend(it);
        }
        entry.subentries.listAppend(ChecklistSubentryMake(crate_areas.listJoinComponents(", ", "or"), "", "Crate. Gives " + drops.listJoinComponents(", ", "or") + "."));
        //Usually drops ropes/bombs?
    }
    if (tombstone_areas.count() > 0)
    {
        string [int] description;
    
        description.listAppend("20-30? gold or a skeleton buddy."); //highest seen for me is 27
        
        if ($item[heavy pickaxe].available_amount() > 0 && $item[Shotgun].available_amount() == 0)
        {
            string line = "Shotgun";
            if ($item[heavy pickaxe].equipped_amount() == 0)
                line += " (equip heavy pickaxe first)";
            line += ".";
            description.listAppend(line);
        }
        
        if ($item[x-ray goggles].available_amount() > 0 && $item[The Clown Crown].available_amount() == 0)
        {
            string line = "The Clown Crown";
            if ($item[x-ray goggles].equipped_amount() == 0)
                line += " (equip x-ray goggles first)";
            line += ".";
            description.listAppend(line);
        }
        entry.subentries.listAppend(ChecklistSubentryMake(tombstone_areas.listJoinComponents(", ", "or"), "", description));
    }
    
    
    if (very_important)
    {
        task_entries.listAppend(entry);
        string secondary_description = "Scroll up for full description.";
        ChecklistEntry pop_up_reminder_entry = ChecklistEntryMake(418, entry.image_lookup_name, "", ChecklistSubentryMake(entry.subentries[0].header, "", secondary_description), -11);
        pop_up_reminder_entry.only_show_as_extra_important_pop_up = true;
        pop_up_reminder_entry.container_div_attributes["onclick"] = "navbarClick(0, 'Tasks_checklist_container')";
        pop_up_reminder_entry.container_div_attributes["class"] = "r_clickable";
        
        task_entries.listAppend(pop_up_reminder_entry);
    }
    else
        future_task_entries.listAppend(entry);
}

string [item] SpelunkingGenerateEquipmentDescriptions(SpelunkingStatus spelunking_status)
{
    string [item] equipment_descriptions;
    
    equipment_descriptions[$item[trusty whip]] = "3-6 damage.";
    equipment_descriptions[$item[sturdy machete]] = "3-6 damage, +5 weapon damage.";
    equipment_descriptions[$item[shotgun]] = "6-12 damage, +10 ranged damage.";
    equipment_descriptions[$item[boomerang]] = "3-6 damage, delevels.";
    equipment_descriptions[$item[plasma rifle]] = "9-18 damage, +20 ranged damage.";
    
    equipment_descriptions[$item[Bananubis's Staff]] = "3-6 damage, -6 gold drops, raises a skeleton buddy";
    if (spelunking_status.buddy != "")
        equipment_descriptions[$item[Bananubis's Staff]] += " later";
    equipment_descriptions[$item[Bananubis's Staff]] += ".";
    if (spelunking_status.buddy.length() == 0)
    {
        if (spelunking_status.sacrifices < 3 && !spelunking_status.areas_unlocked[$location[the crashed u. f. o.]])
            equipment_descriptions[$item[Bananubis's Staff]] += "|Use this now if you want a buddy to sacrifice.";
        else
            equipment_descriptions[$item[Bananubis's Staff]] += "|Use this now if you want a skeleton buddy. (for +stat sacrificing or Yomama)";
    }
    
    equipment_descriptions[$item[crumbling skull]] = "Can throw for 20 damage.|Afterward, can find another.";
    equipment_descriptions[$item[8042]] = "Can throw for 30 damage.|Afterward, can find another.";
    equipment_descriptions[$item[pot]] = "2 DR, can throw for 20 damage/10 gold.";
    equipment_descriptions[$item[heavy pickaxe]] = "+5 all attributes";
    equipment_descriptions[$item[torch]] = "Deals 8-10 damage first round of combat.|Finds random bombs/ropes/gold.|Can be thrown for 100 damage.|Can be thrown at Yomama for recurring damage.";
    equipment_descriptions[$item[The Joke Book of the Dead]] = "-6 gold drops, +5 weapon damage, 5 DR.";
    equipment_descriptions[$item[cursed coffee cup]] = "-2 gold drops, restores HP after combat.";
    
    equipment_descriptions[$item[spelunking fedora]] = "+5 stats.";
    equipment_descriptions[$item[mining helmet]] = "2 DR, finds random ropes/bombs/gold.";
    equipment_descriptions[$item[X-ray goggles]] = "-5 moxie, +5 gold drops.";
    equipment_descriptions[$item[The Clown Crown]] = "-6 gold drops.";
    
    //Note: Both the yellow cape and jetpack affect both boots. How to?
    item [int] boots_available;
    foreach it in $items[spring boots,spiked boots]
    {
        if (it.available_amount() > 0)
            boots_available.listAppend(it);
    }
    
    equipment_descriptions[$item[yellow cape]] = "+5 moxie";
    if (boots_available.count() > 0)
        equipment_descriptions[$item[yellow cape]] += ", improves " + boots_available.listJoinComponents(", ", "and");
    equipment_descriptions[$item[yellow cape]] += ".";
    
    equipment_descriptions[$item[jetpack]] = "+10 moxie";
    if (boots_available.count() > 0)
        equipment_descriptions[$item[jetpack]] += ", improves " + boots_available.listJoinComponents(", ", "and");
    equipment_descriptions[$item[jetpack]] += ".";
    
    equipment_descriptions[$item[spring boots]] = "Avoids enemy attacks.";
    equipment_descriptions[$item[spiked boots]] = "Deals ";
    if ($item[jetpack].equipped_amount() > 0)
        equipment_descriptions[$item[spiked boots]] += "14-15";
    else if ($item[yellow cape].equipped_amount() > 0)
        equipment_descriptions[$item[spiked boots]] += "8-10";
    else
        equipment_descriptions[$item[spiked boots]] += "4-5";
    equipment_descriptions[$item[spiked boots]] += " damage first round of combat.";
    if ($item[jetpack].available_amount() > 0)
    {
        if ($item[jetpack].equipped_amount() == 0)
            equipment_descriptions[$item[spiked boots]] += " (equip jetpack for more)";
    }
    else if ($item[yellow cape].available_amount() > 0 && $item[yellow cape].equipped_amount() == 0)
        equipment_descriptions[$item[spiked boots]] += " (equip yellow cape for more)";
    
    return equipment_descriptions;
}

void SpelunkingGenerateEquipmentEntries(Checklist [int] checklists, SpelunkingStatus spelunking_status)
{
    /*ChecklistEntry [int] equipment_entries;

    if (true)
    {
        Checklist equipment_checklist;
        equipment_checklist = ChecklistMake("Equipment", equipment_entries);
        checklists.listAppend(equipment_checklist);
    }*/
    
    string [item] equipment_descriptions = SpelunkingGenerateEquipmentDescriptions(spelunking_status);
    
    
    item [slot][int] equipment_per_slot;
    
    foreach it in $items[trusty whip,sturdy machete,shotgun,boomerang,plasma rifle,Bananubis's Staff,crumbling skull,8042,pot,heavy pickaxe,torch,The Joke Book of the Dead,cursed coffee cup,spelunking fedora,mining helmet,X-ray goggles,The Clown Crown,yellow cape,jetpack,spring boots,spiked boots]
    {
        if (it.available_amount() == 0)
            continue;
        
        if (!(equipment_per_slot contains it.to_slot()))
        {
            item [int] blank_entries;
            equipment_per_slot[it.to_slot()] = blank_entries;
        }
        equipment_per_slot[it.to_slot()].listAppend(it);
    }
    
    slot [int] slot_evaluation_order;
    slot_evaluation_order.listAppend($slot[weapon]);
    slot_evaluation_order.listAppend($slot[off-hand]);
    slot_evaluation_order.listAppend($slot[hat]);
    slot_evaluation_order.listAppend($slot[back]);
    slot_evaluation_order.listAppend($slot[acc1]);
    foreach s in equipment_per_slot
    {
        if (!($slots[weapon,off-hand,hat,back,acc1] contains s))
            slot_evaluation_order.listAppend(s);
    }
    
    foreach key, s in slot_evaluation_order
    {
        if (!(equipment_per_slot contains s))
            continue;
        
        string slot_name = s.slot_to_plural_string().capitaliseFirstLetter();
        
        /*ChecklistEntry entry = ChecklistEntryMake(419);
        entry.subentries.listAppend(ChecklistSubentryMake(slot_name, "", ""));
        entry.should_indent_after_first_subentry = true;
        boolean have_something_to_unequip = false;*/
        
        ChecklistEntry [int] checklist_entries;
        
        foreach key2 in equipment_per_slot[s]
        {
            item it = equipment_per_slot[s][key2];
            string header = it.capitaliseFirstLetter();
            if (it.available_amount() > 1)
                header = pluralise(it);
            string description;
            
            description = equipment_descriptions[it];
            
            /*if (it.equipped_amount() == 0)
                have_something_to_unequip = true;
            
            if (entry.image_lookup_name.length() == 0)
                entry.image_lookup_name = "__item " + it;
            
            entry.subentries.listAppend(ChecklistSubentryMake(header, "", description));*/
            ChecklistEntry entry = ChecklistEntryMake(420, "__item " + it, "", ChecklistSubentryMake(header, "", description));
            if (it.equipped_amount() > 0)
            {
                entry.should_highlight = true;
                if (it.to_slot() != $slot[none])
                    entry.url = "place.php?whichplace=spelunky";
            }
            else if (it.to_slot() != $slot[none])
            {
                //this is an interesting idea, but it violates our rule that clicking guide never modifies significant state
                //in other words, guide should feel "safe" to click on
                //I mean, you should never feel safe around guide. save yourself!
                //But, it seems useful enough to be worth doing...
                entry.url = "inv_equip.php?pwd=" + my_hash() + "&which=2&action=equip&whichitem=" + it.to_int();
                //KoLmafia/sideCommand?cmd=uneffect+effect&pwd=hash
                //entry.url = "KoLmafia/sideCommand?pwd=" + my_hash() + "&cmd=equip+" + it.replace_string(" ", "+");
                //entry.url = "inventory.php?which=2";
            }
            checklist_entries.listAppend(entry);
            
        }
        /*if (have_something_to_unequip)
            entry.url = "inventory.php?which=2";
        equipment_entries.listAppend(entry);*/
        
        

        if (true)
        {
            Checklist c;
            c = ChecklistMake(slot_name, checklist_entries);
            checklists.listAppend(c);
        }
    }
}


void LimitModeSpelunkingGenerateChecklists(Checklist [int] checklists)
{
    if (limit_mode() != "spelunky")
        return;
    ChecklistEntry [int] task_entries;
    ChecklistEntry [int] optional_task_entries;
    ChecklistEntry [int] future_task_entries;
    ChecklistEntry [int] aftercore_task_entries;
    ChecklistEntry [int] resource_entries;

    if (true)
    {
        Checklist task_checklist;
        task_checklist = ChecklistMake("Tasks", task_entries);
        checklists.listAppend(task_checklist);
        
        
        Checklist optional_task_checklist;
        optional_task_checklist = ChecklistMake("Optional Tasks", optional_task_entries);
        checklists.listAppend(optional_task_checklist);
        
        Checklist future_task_checklist;
        future_task_checklist = ChecklistMake("Future Tasks", future_task_entries);
        checklists.listAppend(future_task_checklist);
        
        Checklist aftercore_task_checklist;
        aftercore_task_checklist = ChecklistMake("Aftercore Tasks", aftercore_task_entries);
        checklists.listAppend(aftercore_task_checklist);
        
        Checklist resources_checklist;
        resources_checklist = ChecklistMake("Resources", resource_entries);
        checklists.listAppend(resources_checklist);
    }
    
    string spelunking_url = "place.php?whichplace=spelunky";
    
    
    SpelunkingStatus spelunking_status = SpelunkingParseStatus();
    
    
    if (spelunking_status.turns_left == 0)
    {
        string [int] description;
        
        string [int] accomplishments;
        if (spelunking_status.gold > 0)
            accomplishments.listAppend("earned " + spelunking_status.gold + " gold");
        if (spelunking_status.sacrifices > 0)
            accomplishments.listAppend("sacrificed " + pluraliseWordy(spelunking_status.sacrifices, "noble friend", "noble friends")); //is this really an... accomplishment?
        if (accomplishments.count() > 0)
            description.listAppend("You " + accomplishments.listJoinComponents(", ", "and") + ".");
        
        task_entries.listAppend(ChecklistEntryMake(421, "__item spelunking fedora", "place.php?whichplace=spelunky&action=spelunky_quit", ChecklistSubentryMake("Ride off into the sunset", "", description)));
        return;
    }
    
    SpelunkingGenerateNCInformation(spelunking_status, task_entries, future_task_entries);
    
    
    if (my_hp() == 0)
    {
        task_entries.listAppend(ChecklistEntryMake(422, "__effect beaten up", spelunking_url, ChecklistSubentryMake("Heal", "", "Probably at your tent. (costs a turn)"), -11));
    }
    
    if ($item[jetpack].available_amount() > 0 && $item[yellow cape].equipped_amount() > 0 && !spelunking_status.noncombat_due_next_adventure)
    {
        task_entries.listAppend(ChecklistEntryMake(423, "__item jetpack", "inv_equip.php?pwd=" + my_hash() + "&which=2&action=equip&whichitem=" + $item[jetpack].to_int(), ChecklistSubentryMake("Equip jetpack", "", "More efficient than the yellow cape."), -11));
    }
    
    if (get_property("spelunkyUpgrades").contains_text("N"))
    {
        int unlocks_found = 0;
        string upgrades_string = get_property("spelunkyUpgrades");
        for i from 0 to upgrades_string.length() - 1
        {
            if (upgrades_string.char_at(i) == "Y")
                unlocks_found += 1;
        }
        
        int unlocks_remaining = clampi(9 - unlocks_found, 0, 9);
        
        int after_this_remaining = MAX(0, unlocks_remaining - 1);
        
        if (after_this_remaining > 0)
            future_task_entries.listAppend(ChecklistEntryMake(424, "__item heavy pickaxe", "", ChecklistSubentryMake("Spelunk " + pluraliseWordy(after_this_remaining, "more time", "more times") + " after this", "", "Unlock all the starting bonuses.")));
    }
    
    if (spelunking_status.altar_unlocked && spelunking_status.buddy != "")
    {
        string [int] description;
        //spelunking_status.sacrifices
        if (spelunking_status.buddy == "Resourceful Kid")
            description.listAppend("He's just a kid! Don't do it!");
        else if (spelunking_status.buddy == "Helpful Guy")
            description.listAppend("But, he's really helpful... a loyal companion at your side! Could you betray him?");
        else if (spelunking_status.buddy == "Skeleton")
        {
            description.listAppend("A skeleton probably won't mind. They're just magic, right?|Still, it is a betrayal...");
        }
        else if (spelunking_status.buddy == "Golden Monkey")
            description.listAppend("Animal sacrifice... is it really worth it?");
        else
            description.listAppend("But, will you betray your friend?");
        
        string [int] results;
        
        if (spelunking_status.sacrifices == 0)
            results.listAppend("cursed coffee cup");
        else if (spelunking_status.sacrifices == 1)
        {
            item next_item;
            if ($item[x-ray goggles].available_amount() == 0)
                next_item = $item[x-ray goggles];
            else if ($item[spiked boots].available_amount() == 0)
                next_item = $item[spiked boots];
            else if ($item[jetpack].available_amount() == 0)
                next_item = $item[jetpack];
            else
                next_item = $item[8042];
            results.listAppend(next_item);
        }
        else if (spelunking_status.sacrifices == 2)
            results.listAppend("The Joke Book of the Dead (used for unlocking Hell/fighting ghost)");
        
        
        if (spelunking_status.sacrifices == 0)
            results.listAppend("+10 to all stats");
        else if (spelunking_status.sacrifices == 1)
            results.listAppend("+5 to all stats");
        else if (spelunking_status.sacrifices >= 2)
            results.listAppend("+1 to all stats");
        
        if ($item[cursed coffee cup].available_amount() > 0)
        {
            string line = "30 HP restoration";
            if ($item[cursed coffee cup].equipped_amount() == 0)
                line += " (equip cursed coffee cup first)";
        }
        
        if ($item[Bananubis's Staff].available_amount() > 0)
            description.listAppend("Consider repeatedly summoning/sacrificing skeletons for extra stats. (Bananubis's Staff)");
        
        if (results.count() > 0)
            description.listAppend("Gives " + results.listJoinComponents(", ", "and") + ".");
        
        if (spelunking_status.sacrifices < 2)
            description.listAppend("Part of unlocking Hell."); //where else would you go?
        
        if (spelunking_status.sacrifices > 0)
            description.listAppend(pluraliseWordy(spelunking_status.sacrifices, "sacrifice", "sacrifices").capitaliseFirstLetter() + " so far.");
        optional_task_entries.listAppend(ChecklistEntryMake(425, "__item Cloaca-Cola-issue combat knife", spelunking_url, ChecklistSubentryMake("Possibly sacrifice " + spelunking_status.buddy.to_lower_case() + " at the altar", "", description)));
        //place.php?whichplace=spelunky&action=spelunky_side6
    }
    
    
    
    if ($item[the joke book of the dead].available_amount() > 0)
    {
        string url;
        string [int] description;
        string [int] tasks;
        description.listAppend("If you haven't already.");
        
        if ($item[the joke book of the dead].equipped_amount() == 0)
        {
            tasks.listAppend("after equipping " + $item[the joke book of the dead]);
            url = "inventory.php?which=2";
        }
        tasks.listAppend("click on the ghost");
        description.listAppend(tasks.listJoinComponents(", ").capitaliseFirstLetter() + ".");
        description.listAppend("Gives ten more turns on victory.");
        
        
        string [int] ideas;
        foreach it in $items[spring boots,boomerang,spelunking fedora]
        {
            if (it.equipped_amount() == 0)
                ideas.listAppend(it);
        }
        if (spelunking_status.buddy != "Skeleton")
            ideas.listAppend("skeleton");
        ideas.listAppend("ropes");
        
        
            
        description.listAppend("Defeating it involves... " + ideas.listJoinComponents(", ") + "?");
        
        optional_task_entries.listAppend(ChecklistEntryMake(426, "__item ghost trap", url, ChecklistSubentryMake("Possibly attack the ghost", "", description)));
    }
    
    if (spelunking_status.areas_unlocked[$location[the city of Goooold]] && $item[Bananubis's Staff].available_amount() == 0)
    {
        string [int] description;
        description.listAppend("Part of unlocking Hell, and the staff can give stats via sacrifices.");
        if (spelunking_status.sticky_bombs_unlocked)
            description.listAppend("Throw two bombs.");
        else
        {
            string [int] tasks;
            if ($item[spring boots].available_amount() == 0)
                tasks.listAppend("acquire spring boots");
            else if ($item[spring boots].equipped_amount() == 0)
                tasks.listAppend("equip spring boots");
            tasks.listAppend("rope until spring boots activate");
            tasks.listAppend("throw a bomb");
            tasks.listAppend("throw a bomb or attack or whatever will kill him");
            description.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + "?");
            description.listAppend("Or acquire sticky bombs.");
        }
        description.listAppend("Appears after defeating five mummies in the area.");
        optional_task_entries.listAppend(ChecklistEntryMake(427, "__item Bananubis's Staff", spelunking_url, ChecklistSubentryMake("Defeat Bananubis", "", description)));
    }
    
    if (spelunking_status.areas_unlocked[$location[LOLmec's lair]] && !spelunking_status.areas_unlocked[$location[Hell]])
    {
        //defeat LOLMec
        string [int] description;
        description.listAppend("If you haven't already.");
        if (spelunking_status.bombs < 10)
            description.listAppend("Collect ten bombs first.");
        else
        {
            string line = "Throw ten bombs.";
            if (!spelunking_status.sticky_bombs_unlocked && spelunking_status.bombs >= 20)
                line += " Or twenty.";
            description.listAppend(line);
            if (!spelunking_status.sticky_bombs_unlocked)
            {
                if (!spelunking_status.areas_unlocked[$location[the snake pit]])
                    description.listAppend("Possibly acquire sticky bombs from the spider queen.");
                    
                string [int] ideas;
                foreach it in $items[spring boots,shotgun,spelunking fedora,8042]
                {
                    if (it.equipped_amount() == 0)
                        ideas.listAppend(it);
                }
                if (spelunking_status.buddy != "Skeleton")
                    ideas.listAppend("skeleton");
                ideas.listAppend("ropes");
                
                
                    
                description.listAppend("Umm... " + ideas.listJoinComponents(", ") + "?");
            }
        }
        optional_task_entries.listAppend(ChecklistEntryMake(428, "__item LOLmec statuette", spelunking_url, ChecklistSubentryMake("Defeat LOLmec", "", description)));
    }
    
    if (spelunking_status.areas_unlocked[$location[Yomama's Throne]])
    {
        string [int] description;
        description.listAppend("If you haven't already.");
        description.listAppend("Umm... throw a bomb, throw a torch, stagger with ropes? Spring boots? Fedora?|Or defeat him another way. Skeleton buddy might help.");
        optional_task_entries.listAppend(ChecklistEntryMake(429, "__item huge gold coin", spelunking_url, ChecklistSubentryMake("Defeat Yomama", "", description)));
    }
    
    if (!spelunking_status.areas_unlocked[$location[the temple ruins]])
    {
    }
    else if (!spelunking_status.areas_unlocked[$location[Hell]] && $items[Bananubis's Staff,The Joke Book of the Dead,The Clown Crown].items_missing().count() == 0)
    {
        if (spelunking_status.keys == 0)
        {
            optional_task_entries.listAppend(ChecklistEntryMake(430, "__item Clan VIP Lounge key", "", ChecklistSubentryMake("Acquire a key", "", "For unlocking Hell.")));
        }
        else
        {
            string [int] description;
            string [int] tasks;
            string url;
            url = spelunking_url;
            
            foreach it in $items[Bananubis's Staff,The Joke Book of the Dead,The Clown Crown]
            {
                if (it.equipped_amount() == 0)
                {
                    tasks.listAppend("equip " + it);
                    url = "inventory.php?which=2";
                }
            }
            tasks.listAppend("click on LOLmec's lair");
            if (tasks.count() > 0)
                description.listAppend(tasks.listJoinComponents(", ", "then").capitaliseFirstLetter() + ".");
            description.listAppend(HTMLGenerateSpanFont("Only do this if you've defeated LOLmec already.", "red"));
            optional_task_entries.listAppend(ChecklistEntryMake(431, "__item Clan VIP Lounge key", url, ChecklistSubentryMake("Unlock Hell", "", description)));
        }
    }
    else if (!spelunking_status.areas_unlocked[$location[Hell]] && !(spelunking_status.areas_unlocked[$location[the crashed u. f. o.]]))
    {
        string [int] description;
        string [int] tasks;
        if ($item[Bananubis's Staff].available_amount() == 0)
        {
            tasks.listAppend("acquire Bananubis's Staff");
        }
        if ($item[The Joke Book of the Dead].available_amount() == 0)
        {
            tasks.listAppend("sacrifice buddies for the Joke Book of the Dead");
        }
        if ($item[x-ray goggles].available_amount() == 0)
        {
            tasks.listAppend("acquire x-ray goggles");
        }
        if ($item[The Clown Crown].available_amount() == 0)
        {
            tasks.listAppend("acquire the Clown Crown from the jungle/burial ground NCs");
        }
        if (!spelunking_status.areas_unlocked[$location[LOLmec's lair]])
            tasks.listAppend("unlock LOLmec's lair");
        tasks.listAppend("defeat LOLmec");
        if (spelunking_status.keys == 0)
            tasks.listAppend("acquire a key");
        
        description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        optional_task_entries.listAppend(ChecklistEntryMake(432, "__item handful of fire", "", ChecklistSubentryMake("Unlock Hell", "", description)));
    }
    
    if (true)
    {
        string [int] description;
        if (__setting_debug_mode && false)
        {
            //spelunkyNextNoncombat,spelunkyWinCount,spelunkyUpgrades,spelunkySacrifices
            foreach s in $strings[spelunkyStatus]
            {
                description.listAppend(s + " = \"" + get_property(s) + "\"");
            }
            description.listAppend("spelunking_status = " + spelunking_status.to_json());
        }
        
        string [int] areas_to_adventure_in;
        areas_to_adventure_in.listAppend("Mines: if the other areas are too difficult.");
        //snake pit - marginal?
        if (spelunking_status.areas_unlocked[$location[the spider hole]] && !spelunking_status.sticky_bombs_unlocked)
            areas_to_adventure_in.listAppend("The Spider Hole: to unlock sticky bombs.");
        //burial ground
        if (spelunking_status.areas_unlocked[$location[the jungle]] && $item[torch].available_amount() == 0)
            areas_to_adventure_in.listAppend("Jungle: chance a torch from tikimen. Throwing rocks works well here.");
        //beehive
        //UFO
        //ice caves - unlocking temple ruins...?
        if (spelunking_status.areas_unlocked[$location[The City of Goooold]] && $item[Bananubis's Staff].available_amount() == 0)
            areas_to_adventure_in.listAppend("City of Goooold: defeat boss for Bananubis's staff. Part of unlocking Hell.");
        //temple ruins
        if (spelunking_status.areas_unlocked[$location[the temple ruins]] && !spelunking_status.areas_unlocked[$location[lolmec's lair]])
            areas_to_adventure_in.listAppend("Temple ruins: unlock LOLmec's lair.");
        //lolmec's lair
        //yomama's lair
        if (spelunking_status.areas_unlocked[$location[hell]] && !spelunking_status.areas_unlocked[$location[yomama's throne]])
            areas_to_adventure_in.listAppend("Hell: unlock Yomama's throne after seven combats won.");
            
        if (spelunking_status.areas_unlocked[$location[the temple ruins]])
            areas_to_adventure_in.listAppend("Temple ruins: to collect gold.");
        else
            areas_to_adventure_in.listAppend("Somewhere: to collect gold.");
        if (areas_to_adventure_in.count() > 0)
            description.listAppend("Adventure in:|*" + areas_to_adventure_in.listJoinComponents("|*<hr>"));
            
        //description.listAppend("Usual combat strategy:|*Throw a bomb or rope if they're powerful (and you can afford it), then attack. Try to avoid taking damage, or heal it with a cursed coffee cup.");
        task_entries.listAppend(ChecklistEntryMake(433, "__item heavy pickaxe", spelunking_url, ChecklistSubentryMake("Spelunk!", "", description)));
    }
    
    SpelunkingGenerateEquipmentEntries(checklists, spelunking_status);
}







string [int] generateHotDogLine(string hotdog, string description, int fullness)
{
    description += " " + fullness + " full.";
    if (availableFullness() < fullness)
    {
        hotdog = HTMLGenerateSpanOfClass(hotdog , "r_future_option");
        description = HTMLGenerateSpanOfClass(description , "r_future_option");
    }
    return listMake(hotdog, description);
}


void generateDailyResources(Checklist [int] checklists)
{
	ChecklistEntry [int] resource_entries;
		
	SetsGenerateResources(resource_entries);
    QuestsGenerateResources(resource_entries);
	
	if (!get_property_boolean("_fancyHotDogEaten") && availableFullness() > 0 && __misc_state["VIP available"] && __misc_state["can eat just about anything"] && $item[Clan hot dog stand].is_unrestricted()) //too expensive to use outside a run? well, more that it's information overload
	{
		
		string name = "Fancy hot dog edible";
		string [int] description;
		string image_name = "basic hot dog";
		
        string [int][int] options;
		options.listAppend(generateHotDogLine("Optimal Dog", "Semi-rare next adventure.", 1));
        
        if (__misc_state["in run"])
        {
            options.listAppend(generateHotDogLine("Ghost Dog", "-combat, 30 turns.", 3));
            options.listAppend(generateHotDogLine("Video Game Hot Dog", "+25% item, +25% meat, pixels, 50 turns.", 3));
            options.listAppend(generateHotDogLine("Junkyard dog", "+combat, 30 turns.", 3));
            if (!__quest_state["Level 8"].finished || __quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0)
                options.listAppend(generateHotDogLine("Devil dog", "+3 cold/spooky res, 30 turns.", 3));
            if (!__quest_state["Level 9"].state_boolean["Peak Stench Completed"])
                options.listAppend(generateHotDogLine("Chilly dog", "+10ML and +3 stench/sleaze res, 30 turns.", 3));
            if (my_primestat() == $stat[muscle])
                options.listAppend(generateHotDogLine("Savage macho dog", "+50% muscle, 50 turns.", 2));
            if (my_primestat() == $stat[mysticality])
                options.listAppend(generateHotDogLine("One with everything", "+50% mysticality, 50 turns.", 2));
            if (my_primestat() == $stat[moxie])
                options.listAppend(generateHotDogLine("Sly Dog", "+50% moxie, 50 turns.", 2));
            if (__misc_state["need to level"] && __misc_state["Chateau Mantegna available"] && !$skill[Dog Tired].have_skill())
                options.listAppend(generateHotDogLine("Sleeping dog", "5 free rests/day (stats at chateau)", 2));
        }
			
        description.listAppend(HTMLGenerateSimpleTableLines(options));
		resource_entries.listAppend(ChecklistEntryMake(114, image_name, "clan_viplounge.php?action=hotdogstand", ChecklistSubentryMake(name, "", description), 5));
	}
	
		
	if (!get_property_boolean("_olympicSwimmingPoolItemFound") && __misc_state["VIP available"] && $item[Olympic-sized Clan crate].is_unrestricted())
		resource_entries.listAppend(ChecklistEntryMake(115, "__item inflatable duck", "", ChecklistSubentryMake("Dive for swimming pool item", "", "\"swim item\" in GCLI"), 5));
	if (!get_property_boolean("_olympicSwimmingPool") && __misc_state["VIP available"] && $item[Olympic-sized Clan crate].is_unrestricted())
		resource_entries.listAppend(ChecklistEntryMake(116, "__item inflatable duck", "clan_viplounge.php?action=swimmingpool", ChecklistSubentryMake("Swim in VIP pool", "50 turns", listMake("+20 ML, +30% init", "Or -combat")), 5).ChecklistEntrySetCategory("buff"));
	if (!get_property_boolean("_aprilShower") && __misc_state["VIP available"] && $item[Clan shower].is_unrestricted())
	{
		string [int] description;
		if (__misc_state["need to level"])
			description.listAppend("+mainstat gains. (50 turns)");
        
        string [int] reasons;
        if ($item[double-ice cap].available_amount() == 0)
            reasons.listAppend("nice hat");
        if ($familiar[fancypants scarecrow].familiar_is_usable() && $item[double-ice britches].available_amount() == 0)
            reasons.listAppend("scarecrow pants");
        //if (!__quest_state["Level 13"].state_boolean["past tower monsters"]) //don't think this is true
            //reasons.listAppend("situational tower killing");
        
        if (reasons.count() > 0)
            description.listAppend("Double-ice. (" + reasons.listJoinComponents(", ", "and") + ")");
        else
            description.listAppend("Double-ice.");
		
		resource_entries.listAppend(ChecklistEntryMake(117, "__item shard of double-ice", "clan_viplounge.php?action=shower", ChecklistSubentryMake("Take a shower", description), 5));
	}
    if (__misc_state["VIP available"] && get_property_int("_poolGames") <3 && $item[Clan pool table].is_unrestricted())
    {
        int games_available = 3 - get_property_int("_poolGames");
        string [int] description;
        if (__misc_state["familiars temporarily blocked"])
            description.listAppend("+50% weapon damage. (aggressively)");
        else
            description.listAppend("+5 familiar weight, +50% weapon damage. (aggressively)");
        description.listAppend("Or +50% spell damage, +10 MP regeneration. (strategically)");
        description.listAppend("Or +10% item, +50% init. (stylishly)");
		resource_entries.listAppend(ChecklistEntryMake(118, "__item pool cue", "clan_viplounge.php?action=pooltable", ChecklistSubentryMake(pluralise(games_available, "pool table game", "pool table games"), "10 turns", description), 5).ChecklistEntrySetCategory("buff"));
    }
    if (__quest_state["Level 6"].finished && !get_property_boolean("friarsBlessingReceived"))
    {
        string [int] description;
        if (!__misc_state["familiars temporarily blocked"])
        {
            description.listAppend("+Familiar experience.");
            description.listAppend("Or +30% food drop.");
        }
        else
            description.listAppend("+30% food drop.");
        description.listAppend("Or +30% booze drop.");
        boolean should_output = true;
        if (!__misc_state["in run"])
        {
            should_output = false;
        }
        if (!should_output && familiar_weight(my_familiar()) < 20 && my_familiar() != $familiar[none])
        {
            description.listClear();
            description.listAppend("+Familiar experience.");
            should_output = true;
        }
        if (should_output)
            resource_entries.listAppend(ChecklistEntryMake(119, "Monk", "friars.php", ChecklistSubentryMake("Forest Friars buff", "20 turns", description), 10).ChecklistEntrySetCategory("buff"));
    }
	
	
	
	
	
	
	if (!get_property_boolean("_madTeaParty") && __misc_state["VIP available"] && $item[Clan looking glass].is_unrestricted())
	{
        string [int] description;
        string line = "Various effects.";
        if (__misc_state["in run"] && my_path_id() != PATH_ZOMBIE_SLAYER && $item[pail].available_amount() > 0)
        {
            line = "+20ML";
            line += "|Or various effects.";
        }
        description.listAppend(line);
		resource_entries.listAppend(ChecklistEntryMake(120, "__item insane tophat", "", ChecklistSubentryMake("Mad tea party", "30 turns", description), 7).ChecklistEntrySetCategory("buff"));
	}
	
	if (true)
	{
		string url = "inventory.php?which=1";
        
        string image_name = "__item hell ramen";
		if (availableFullness() > 0)
		{
            string [int] description;
            if ($effect[Got Milk].have_effect() > 0)
                description.listAppend(pluralise($effect[Got Milk]) + " available.");
            resource_entries.listAppend(ChecklistEntryMake(121, "__item hell ramen", url, ChecklistSubentryMake(availableFullness() + " fullness", "", description), 12)).ChecklistEntryTag("consumption junction, what's your function?");
		}
		if (availableDrunkenness() >= 0 && inebriety_limit() > 0)
        {
            string title = "";
            string [int] description;
            if ($effect[ode to booze].have_effect() > 0)
                description.listAppend(pluralise($effect[ode to booze]) + " available.");
            
            if (availableDrunkenness() > 0)
                title = availableDrunkenness() + " drunkenness";
            else
                title = "Can overdrink";
            resource_entries.listAppend(ChecklistEntryMake(122, "__item gibson", url, ChecklistSubentryMake(title, "", description), 12)).ChecklistEntryTag("consumption junction, what's your function?");
        }
		if (availableSpleen() > 0)
		{
            resource_entries.listAppend(ChecklistEntryMake(123, "__item agua de vida", url, ChecklistSubentryMake(availableSpleen() + " spleen", "", ""), 12)).ChecklistEntryTag("consumption junction, what's your function?");
		}
	}
	
	if (__quest_state["Level 13"].state_boolean["king waiting to be freed"])
	{
		string [int] description;
		description.listAppend("Contains one (1) monarch.");
        description.listAppend(pluralise(my_ascensions(), "king", "kings") + " freed." + (my_ascensions() > 250 ? " Collect them all!" : ""));
        string image_name;
        image_name = "__effect sleepy";
		resource_entries.listAppend(ChecklistEntryMake(124, image_name, "place.php?whichplace=nstower", ChecklistSubentryMake("1 Prism", "", description), 10));
	}
    
    if ((get_property("sidequestOrchardCompleted") == "hippy" || get_property("sidequestOrchardCompleted") == "fratboy") && !get_property_boolean("_hippyMeatCollected"))
    {
		resource_entries.listAppend(ChecklistEntryMake(125, "__item herbs", "island.php", ChecklistSubentryMake("Meat from the hippy store", "", "~4500 free meat."), 5)); //FIXME consider shop.php?whichshop=hippy
    }
    if ((get_property("sidequestArenaCompleted") == "hippy" || get_property("sidequestArenaCompleted") == "fratboy") && !get_property_boolean("concertVisited"))
    {
        string [int] description;
        if (get_property("sidequestArenaCompleted") == "hippy")
        {
            if (!__misc_state["familiars temporarily blocked"])
                description.listAppend("+5 familiar weight.");
            description.listAppend("Or +20% item.");
            if (__misc_state["need to level"])
                description.listAppend("Or +5 stats/fight.");
        }
        else if (get_property("sidequestArenaCompleted") == "fratboy")
        {
            description.listAppend("+40% meat.");
            description.listAppend("+50% init.");
            description.listAppend("+10% all attributes.");
        }
        
        string url = "bigisland.php?place=concert";
        if (__quest_state["Level 12"].finished)
            url = "postwarisland.php?place=concert";
		resource_entries.listAppend(ChecklistEntryMake(126, "__item the legendary beat", url, ChecklistSubentryMake("Arena concert", "20 turns", description), 5).ChecklistEntrySetCategory("buff"));
    }
    
    //Not sure how I feel about this. It's kind of extraneous?
    if (get_property_int("telescopeUpgrades") > 0 && !get_property_boolean("telescopeLookedHigh") && __misc_state["in run"] && availableDrunkenness() < 0 && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING && !in_bad_moon() && my_path_id() != PATH_NUCLEAR_AUTUMN)
    {
        string [int] description;
        int percentage = 5 * get_property_int("telescopeUpgrades");
        description.listAppend("+" + (percentage == 25 ? "35% or +25" : percentage) + "% to all attributes. (10 turns)");
		resource_entries.listAppend(ChecklistEntryMake(127, "__effect Starry-Eyed", "campground.php?action=telescope", ChecklistSubentryMake("Telescope buff", "", description), 10));
    }
    
    
    if (__misc_state_int["free rests remaining"] > 0)
    {
        string [int] description;
        
        if (__misc_state["recommend resting at campsite"])
        {
            float resting_hp_percent = numeric_modifier("resting hp percent") / 100.0;
            float resting_mp_percent = numeric_modifier("resting mp percent") / 100.0;
            
            //FIXME trace down every rest effect and make this more accurate, instead of an initial guess.
            
            //If grimace or ronald is full, they double the gains of everything else.
            //This is reported as a modifier of +100% - so with pagoda, that's +200% HP
            //But, it's actually +300%, or 400% total. I could be wrong about this - my knowledge of rest mechanics is limited.
            //So, we'll explicitly check for grimace or ronald being full, then recalculate. Not great, but should work okay?
            //This is probably inaccurate in a great number of cases, due to the complication of resting.
            
            float overall_multiplier_hp = 1.0;
            float overall_multiplier_mp = 1.0;
            float bonus_resting_hp = numeric_modifier("bonus resting hp");
            float after_bonus_resting_hp = 0.0;
            int grimace_light = moon_phase() / 2;
            int ronald_light = moon_phase() % 8;
            if (grimace_light == 4)
            {
                resting_hp_percent -= 1.0;
                overall_multiplier_hp += 1.0;
            }
            if (ronald_light == 4)
            {
                resting_mp_percent -= 1.0;
                overall_multiplier_mp += 1.0;
            }
            
            if ($effect[L'instinct F&eacute;lin].have_effect() > 0) //not currently tracked by mafia. Seems to triple HP/MP gains.
            {
                overall_multiplier_hp *= 3.0;
                overall_multiplier_mp *= 3.0;
            }
            
            if ((get_campground() contains $item[gauze hammock]))
            {
                //Gauze hammock appears to be a flat addition applied after everything else, including grimace, pagoda, and l'instinct.
                //It shows up it bonus resting hp - we'll remove that, and add it back at the end.
                bonus_resting_hp -= 60.0;
                after_bonus_resting_hp += 60.0;
            }
            
            //FIXME chateau restore is different
            float rest_hp_restore = after_bonus_resting_hp + overall_multiplier_hp * (numeric_modifier("base resting hp") * (1.0 + resting_hp_percent) + bonus_resting_hp);
            float rest_mp_restore = overall_multiplier_mp * (numeric_modifier("base resting mp") * (1.0 + resting_mp_percent) + numeric_modifier("bonus resting mp"));
            description.listAppend(rest_hp_restore.floor() + " HP, " + rest_mp_restore.floor() + " MP");
            
            if ($item[pantsgiving].available_amount() > 0) //FIXME is pantsgiving intended to help at chateau?
            {
                if ($item[pantsgiving].equipped_amount() == 0)
                    description.listAppend("Wear pantsgiving for extra HP/MP.");
                if (availableFullness() > 0)
                    description.listAppend("Eat more for +" + (availableFullness() * 5) + " extra HP/MP.");
            }
        }
        else if (__misc_state_string["resting description"] == "Chateau Mantegna")
        {
            //FIXME what goes here
            if (my_path_id() == PATH_THE_SOURCE)
                description.listAppend("HP/MP.");
            else
                description.listAppend("HP/MP/stats.");
            if (my_level() < 9 && my_path_id() != PATH_THE_SOURCE)
                description.listAppend("May want to wait until level 9(?) for more stats from resting.");
            
            stat desired_stat = $stat[none];
            int [item] chateau = get_chateau();
            
            if (chateau[$item[electric muscle stimulator]] > 0)
                desired_stat = $stat[muscle];
            else if (chateau[$item[foreign language tapes]] > 0)
                desired_stat = $stat[mysticality];
            else if (chateau[$item[bowl of potpourri]] > 0)
                desired_stat = $stat[moxie];
            item [int] items_equipping = generateEquipmentToEquipForExtraExperienceOnStat(desired_stat);
            if (items_equipping.count() > 0 && __misc_state["need to level"])
                description.listAppend("Could equip " + items_equipping.listJoinComponents(", ", "or") + " for more stats.");
        }
        
		resource_entries.listAppend(ChecklistEntryMake(128, "__effect sleepy", __misc_state_string["resting url"], ChecklistSubentryMake(pluralise(__misc_state_int["free rests remaining"], "free rest", "free rests").capitaliseFirstLetter(), "", description), 10));
    }
    
    //FIXME skate park?
    
    if (my_path_id() != PATH_BEES_HATE_YOU && !get_property_boolean("guyMadeOfBeesDefeated") && get_property_int("guyMadeOfBeesCount") > 0 && (__misc_state["in aftercore"] || !__quest_state["Level 12"].state_boolean["Arena Finished"]))
    {
        //Not really worthwhile? But I suppose we can track it if they've started it, and are either in aftercore or haven't flyered yet.
        //For flyering, it's 20 turns at -25%, 25 turns at -15%. 33 turns at -5%. Not worthwhile?
        int summon_count = get_property_int("guyMadeOfBeesCount");
        
        string [int] description;
        string times = "";
        if (summon_count == 4)
            times = "One More Time.";
        else
            times = int_to_wordy(5 - summon_count) + " times.";
        description.listAppend("Speak his name " + times);
        if ($item[antique hand mirror].available_amount() == 0)
            description.listAppend("Need antique hand mirror to win. Or towerkill.");
		resource_entries.listAppend(ChecklistEntryMake(129, "__item guy made of bee pollen", $location[the haunted bathroom].getClickableURLForLocation(), ChecklistSubentryMake("The Guy Made Of Bees", "", description), 10));
    }
    
    if (stills_available() > 0)
    {
        string [int] description;
        string [int] mixables;
        if (__misc_state["can drink just about anything"] && my_path_id() != PATH_SLOW_AND_STEADY)
        {
            mixables.listAppend("neuromancer-level drinks");
        }
        mixables.listAppend("~40MP from tonic water");
        
        description.listAppend(mixables.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
        
		resource_entries.listAppend(ChecklistEntryMake(130, "Superhuman Cocktailcrafting", "shop.php?whichshop=still", ChecklistSubentryMake(pluralise(stills_available(), "still use", "still uses"), "", description), 10));
    }
    
    if (__last_adventure_location == $location[The Red Queen's Garden])
    {
        string will_need_effect = "";
        if ($effect[down the rabbit hole].have_effect() == 0)
            will_need_effect = "|Will need to use &quot;DRINK ME&quot; potion first.";
        if (get_property_int("pendingMapReflections") > 0)
            resource_entries.listAppend(ChecklistEntryMake(131, "__item reflection of a map", "place.php?whichplace=rabbithole", ChecklistSubentryMake(pluralise(get_property_int("pendingMapReflections"), "pending reflection of a map", "pending reflections of a map"), "+900% item", "Adventure in the Red Queen's garden to acquire." + will_need_effect), 0));
        if ($items[reflection of a map].available_amount() > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(132, "__item reflection of a map", "inventory.php?which=3", ChecklistSubentryMake(pluralise($item[reflection of a map]), "", "Queen cookies." + will_need_effect), 0));
        }
    }
    
    if (__misc_state["VIP available"])
    {
        if (!get_property_boolean("_lookingGlass") && $item[Clan looking glass].is_unrestricted())
        {
            resource_entries.listAppend(ChecklistEntryMake(133, "__item &quot;DRINK ME&quot; potion", "clan_viplounge.php?whichfloor=2", ChecklistSubentryMake("A gaze into the looking glass", "", "Acquire a " + $item[&quot;DRINK ME&quot; potion] + "."), 10));
        }
        //_deluxeKlawSummons?
        //_crimboTree?
        int soaks_remaining = __misc_state_int["hot tub soaks remaining"];
        if (__misc_state["in run"] && soaks_remaining > 0 && my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING && my_path_id() != PATH_VAMPIRE)
        {
            string description = "Restore all HP, removes most bad effects.";
            resource_entries.listAppend(ChecklistEntryMake(134, "__effect blessing of squirtlcthulli", "clan_viplounge.php", ChecklistSubentryMake(pluralise(soaks_remaining, "hot tub soak", "hot tub soaks"), "", description), 8));
        }
        
        
    }
    //_klawSummons?
    
    //Skill books we have used, but don't have the skill for?
    
    //soul sauce tracking?
    
    if ($item[can of rain-doh].available_amount() > 0 && $item[empty rain-doh can].available_amount() == 0 && __misc_state["in run"])
    {
        resource_entries.listAppend(ChecklistEntryMake(135, "__item can of rain-doh", "inventory.php?which=3", ChecklistSubentryMake("Can of Rain-Doh", "", "Open it!"), 0));
    }
    
    
    
    if (get_property_int("goldenMrAccessories") > 0)
    {
        //FIXME inline with hugs
        int total_casts_available = get_property_int("goldenMrAccessories") * 5;
        int casts_used = get_property_int("_smilesOfMrA");
        
        int casts_remaining = total_casts_available - casts_used;
        
        if (casts_remaining > 0)
        {
            string image_name = "__item Golden Mr. Accessory";
            if (my_id() == 1043600)
                image_name = "__item defective Golden Mr. Accessory"; //does not technically give out sunshine, but...
            resource_entries.listAppend(ChecklistEntryMake(136, image_name, "skills.php", ChecklistSubentryMake(pluralise(casts_remaining, "smile of the Mr. Accessory", "smiles of the Mr. Accessory"), "", "Give away sunshine."), 8));
        }
    }
    
    if (__misc_state["Chateau Mantegna available"] && !get_property_boolean("_chateauDeskHarvested"))
    {
        string image_name = "__item fancy calligraphy pen";
        resource_entries.listAppend(ChecklistEntryMake(137, image_name, "place.php?whichplace=chateau", ChecklistSubentryMake("Chateau desk openable", "", "Daily collectable."), 8));
    }
	
	checklists.listAppend(ChecklistMake("Resources", resource_entries));
}
void generateStrategy(Checklist [int] checklists)
{
	ChecklistEntry [int] entries;
    
    if (!__misc_state["in run"])
        return;
    
    
    //What familiar to run. spleen items
    //Turn generation.
    //How to handle combat.
    //How to restore HP.
    //Where to get MP...?
    
    
	checklists.listAppend(ChecklistMake("Strategy", entries));
}
void generateRandomMessageLocation(string [int] random_messages)
{
    if (__last_adventure_location == $location[none])
        return;
    string message = "";
    switch (__last_adventure_location)
    {
        case $location[the penultimate fantasy airship]:
            message = "insert disc 2 to continue"; break;
        case $location[a-boo peak]:
            message = "allons-y!"; break;
        case $location[twin peak]:
            message = "fire walk with me"; break;
        case $location[The Arrrboretum]:
            message = "save the planet"; break;
        case $location[the red queen's garden]:
            message = "curiouser and curiouser"; break;
        case $location[A Massive Ziggurat]:
            message = "1.21 ziggurats"; break;
        case $location[McMillicancuddy's Barn]:
            message = "dooks"; break;
        case $location[The Roman Forum]:
            message = "they go the house"; break;
        case $location[the battlefield (hippy uniform)]:
            message = "love and war"; break;
        case $location[the middle chamber]:
            message = "pyramid laundry machine"; break;
        case $location[the arid, extra-dry desert]:
            message = "can't remember your name"; break;
        case $location[outside the club]:
            message = "around the world around the world around the world around the world"; break;
        case $location[the hidden temple]:
            message = "beware of temple guards"; break;
        case $location[sonar]:
            message = "one ping only"; break;
        case $location[galley]:
            message = "hungry?"; break;
        case $location[science lab]:
            message = "poetry in motion"; break;
        case $location[fear man's level]:
        case $location[doubt man's level]:
        case $location[regret man's level]:
        case $location[anger man's level]:
            message = "<em>this isn't me</em>"; break;
        case $location[domed city of ronaldus]:
        case $location[domed city of grimacia]:
        case $location[hamburglaris shield generator]:
            message = "spaaaace!"; break;
        case $location[The Mansion of Dr. Weirdeaux]:
        case $location[The Deep Dark Jungle]:
        case $location[The Secret Government Laboratory]:
            message = "they know where you live, " + get_property("System.user.name").to_lower_case(); break;
        case $location[The castle in the clouds in the sky (ground floor)]:
        case $location[The castle in the clouds in the sky (basement)]:
        case $location[The castle in the clouds in the sky (top floor)]:
            if (my_class() == $class[disco bandit])
                message = "making castles of your disco";
            break;
        case $location[The Prince's Restroom]:
        case $location[The Prince's Dance Floor]:
        case $location[The Prince's Kitchen]:
        case $location[The Prince's Balcony]:
        case $location[The Prince's Lounge]:
        case $location[The Prince's Canapes table]:
            message = "social sabotage"; break;
        case $location[anemone mine (mining)]:
        case $location[itznotyerzitz mine (in disguise)]:
        case $location[the knob shaft (mining)]:
        case $location[The Crimbonium Mine]:
        case $location[The Velvet / Gold Mine (Mining)]:
            message = "street sneaky pete don't you call me cause I can't go"; break;
        case $location[Through the Spacegate]:
            message = "oh look! rocks!";
        case $location[noob cave]:
        	if ($location[noob cave].turns_spent >= 1000)
         		message = "find anything yet";
            else
            	message = "time to crate is zero";
        case $location[The Haunted Kitchen]:
        	if (my_level() >= 5 && my_maxhp() >= 36)
            {
            	message = HTMLGenerateSpanFont("where are the knives", "red");
            }
         	break;
    	case $location[Cobb's Knob Laboratory]:
            message = "deedee! get out of my laboratory!"; break;
        case $location[hell]:
            message = "that's a clean burning hell, I'll tell you what"; break;
        case $location[the goatlet]:
            message = "my child you are breaking my " + HTMLGenerateSpanFont("heart", "red"); break;
    }
    if (message != "")
        random_messages.listAppend(message);
}

    
void generateRandomMessageFamiliar(string [int] random_messages)
{
    string lowercase_player_name = my_name().to_lower_case().HTMLEscapeString();
    if (my_familiar() == $familiar[none])
        return;
    string message = "";
    switch (my_familiar())
    {
        case $familiar[none]:
            message = "even introverts need friends"; break;
        case $familiar[crimbo shrub]:
            if (format_today_to_string("MM") == "07")
                message = "crimbo in july"; break;
        case $familiar[black cat]:
            message = "aww, cute kitty!"; break;
        case $familiar[temporal riftlet]:
            message = "master of time and space"; break;
        case $familiar[Frumious Bandersnatch]:
            message = "frabjous"; break;
        case $familiar[Pair of Stomping Boots]:
            if (__misc_state["free runs usable"])
                message = "running away again?";
            break;
        case $familiar[baby sandworm]:
            message = "the waters of life"; break;
        case $familiar[baby bugged bugbear]:
            message = "expected }, found }&#x030b;&#x0311;&#x0300;&#x0306;&#x034a;&#x0311;&#x0314;&#x034f;&#x0331;&#x0329;&#x0320;&#x0330; &#x0323;&#x033b;&#x034a;&#x0345;f&#x031d;&#x034e;&#x0330;&#x0325;&#x0319;&#x0363;&#x0366;&#x0365;&#x030e;,&#x031c;&#x0318;&#x0316;&#x036d;&#x034b; &#x0332;&#x0349;&#x032e;&#x032d;&#x032a;&#x0323;&#x034c;&#x034b;&#x0364;&#x0309;&#x0357;&#x036a;&#x0304;&#x0315;;&#x0339;&#x033c;&#x030b;&#x0308;&#x035b;&#x034a; &#x0327;&#x0354;&#x0325;&#x0324;&#x300c;&#x0359;&#x033a;&#x033b;&#x0356;&#x032f;&#x035b;&#x0300;&#x0313;&#x030f;&#x0351;&#x0300;l&#x034d;&#x030d;&#x030d;&#x030d;&#x0351;i&#x0316;&#x0316;&#x0359;&#x0342;&#x036a;&#x036e;&#x030d; &#x0313;&#x0351;&#x0309;&#x0300;&#x0306;&#x0489;&#x0320;&#x031c;&#x035a;&#x031c;&#x0339;1&#x0336;&#x0354;&#x0329;&#x032c;&#x0326;&#x0326;&#x034d;&#x0365;7&#x035b;&#x0489;&#x032c;&#x032f;&#x0347;&#x033b;&#x0356;&#x0349;1&#x0306;&#x0311;&#x0302;&#x0352;&#x0313;&#x300d;&#x0327;&#x033c;&#x031c;&#x0339;&#x0318;&#x0355;&#x0346;&#x033e;&#x0301;&#x0346;&#x0350;&#x036f;&#x0367;"; //causes severe rendering slowdown; working as intended
            break;
        case $familiar[mechanical songbird]:
            message = "a little glowing friend"; break;
        case $familiar[nanorhino]:
            message = "write every day"; break;
        case $familiar[rogue program]:
            message = "ascends for the users"; break;
        case $familiar[O.A.F.]:
            message = "helping"; break;
        case $familiar[Bank Piggy]:
        case $familiar[Egg Benedict]:
        case $familiar[Floating Eye]:
        case $familiar[Money-Making Goblin]:
        case $familiar[Oyster Bunny]:
        case $familiar[Plastic Grocery Bag]:
        case $familiar[Snowhitman]:
        case $familiar[Vampire Bat]:
        case $familiar[Worm Doctor]:
            message = "hacker"; break;
        case $familiar[adorable space buddy]:
            message = "far beyond the stars"; break;
        case $familiar[happy medium]:
            message = "karma slave"; //what mistakes could I have made?
            break;
        case $familiar[wild hare]:
            message = "or you wouldn't have come here"; //you must be mad
            break;
        case $familiar[artistic goth kid]:
            message = "life is pain, " + lowercase_player_name; break;
        case $familiar[angry jung man]:
            message = "personal trauma"; break;
        case $familiar[unconscious collective]:
            message = "zzz"; break;
        case $familiar[dataspider]:
            message = "spiders are your friends"; break;
        case $familiar[stocking mimic]:
            message = "delicious candy"; break;
        case $familiar[cocoabo]:
            message = "flightless bird"; break;
        case $familiar[whirling maple leaf]:
            message = "canadian pride"; break;
        case $familiar[Hippo Ballerina]:
            message = "spin spin spin"; break;
        case $familiar[Mutant Cactus Bud]:
            message = "always watching"; break;
        case $familiar[ghuol whelp]:
            message = "&#x00af;\\_(&#x30c4;)_/&#x00af;"; //\_()_/
            break;
        case $familiar[bulky buddy box]:
            message = "&#x2665;&#xfe0e;"; //
            break;
        case $familiar[emo squid]:
            message = "sob"; break;
        case $familiar[fancypants scarecrow]:
            message = "the best in terms of pants"; break;
        case $familiar[jumpsuited hound dog]:
            message = "a little less conversation"; break;
        case $familiar[Gluttonous Green Ghost]:
            message = "I think he can hear you, " + lowercase_player_name; break;
        case $familiar[hand turkey]:
            message = "a rare bird"; break;
        case $familiar[reanimated reanimator]:
            message = "weird science"; break;
        case $familiar[Twitching Space Critter]:
            message = "right right right right down right agh"; break;
        case $familiar[slimeling]:
            message = "lost mother"; break;
        case $familiar[Puck Man]:
        case $familiar[Ms. Puck Man]:
            message = "&#5607; &bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;&nbsp;&bull;"; break;
        case $familiar[Lil' Barrel Mimic]:
            message = ":D"; break;
        case $familiar[pet rock]:
            message = "what if the rock's eyebrow froze that way. would anyone notice?"; break;
        case $familiar[space jellyfish]:
            message = "deer force";
            if (__quest_state["Level 13"].state_boolean["king waiting to be freed"])
            {
                int obtained = 0;
                int obtainable = 0;
                foreach it in $items[]
                {
                    if (it.quest) continue; //these disappear
                    if (it.item_amount_almost_everywhere() > 0)
                        obtained += 1;
                    obtainable += 1;
                }
                float rate = to_float(obtained) / to_float(obtainable);
                random_messages.listClear();
                message = "SEE YOU NEXT MISSION<br>your rate for collecting items is " + to_int(rate * 100) + "%";
            }
            else if (my_level() == 1 || my_turncount() <= 2)
            {
                random_messages.listClear();
                message = "the last jellyfish is in captivity<br>the kingdom is at peace";
            }
            
            break;
        case $familiar[bad vibe]:
            message = "<i>it's all your fault</i>"; break;
    }
    if (message != "")
        random_messages.listAppend(message);
}


static
{
	int __message_incremental;
}

string generateRandomMessage()
{
	string [int] random_messages;
	int current_hour = now_to_string("HH").to_int_silent();
	int current_minute = now_to_string("mm").to_int_silent();
	int minute_of_day = current_hour * 60 + current_minute;
    
    
    if (false)
    {
    	//for testing with continuous refresh mode; updates messages
    	__message_incremental += 1;
        return __message_incremental.to_string();
    }
    if (!playerIsLoggedIn())
        return "the kingdom awaits";
        
    if (__misc_state["In valhalla"])
        return "rebirth";
    
	if (__misc_state["in run"])
    {
        if (my_turncount() > 1000 && !in_bad_moon())
            random_messages.listAppend("so many turns");
        
        if (false)
            random_messages.listAppend("you are ascending perfectly, excellent work!");
        else if (my_daycount() >= 365)
            random_messages.listAppend("no king, forever");
        else if (my_daycount() >= 11)
            random_messages.listAppend("does the king even exist...?");
        else if (my_turncount() > 500 && my_daycount() == 1)
            random_messages.listAppend("you are ascending too... wait, what?");
        else if (gameday_to_int() == 7)
            random_messages.listAppend("you are ascending at a reasonable pace, could do better");
        else
            random_messages.listAppend("you are ascending too slowly, ascend faster!");
        
        string what_does_the_spreadsheet_say = "saves a turn";
        if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
            what_does_the_spreadsheet_say = "gives +fun";
        if ($item[optimal spreadsheet].equipped_amount() > 0)
            random_messages.listAppend("every spreadsheet you wear " + what_does_the_spreadsheet_say); //sure, why not?
        else
            random_messages.listAppend("every spreadsheet you make " + what_does_the_spreadsheet_say);
    }
    
    string [string] holiday_messages;
    holiday_messages["Groundhog Day"] = "it's cold out there every day";
    holiday_messages["Crimbo"] = "merry crimbo";
    if ($item[tommy gun].equipped_amount() > 0) //I believe ya, but my tommy gun don't!
    	holiday_messages["Crimbo"] = "merry crimbo, ya filthy animal";
    holiday_messages["April Fool's Day"] = "you are ascending too quickly, ascend slower!";
    holiday_messages["Valentine's Day"] = HTMLGenerateSpanFont("&#x2665;&#xfe0e;", "pink", "3.0em");
    holiday_messages["Towel Day"] = "don't panic";
    
    boolean [string] holidays_today = getHolidaysToday();
    foreach holiday in holidays_today
    {
        if (holiday_messages contains holiday)
        {
            random_messages.listAppend(holiday_messages[holiday]);
        }
    }
    
    if ($item[The One Mood Ring].equipped_amount() > 0 || $item[mood ring].equipped_amount() > 0)
    {
        string [int] moods = split_string("grateful,awake,accomplished,disappointed,enraged,tired,exhausted,amused,crushed,peaceful,energetic,listless,hyper,jubilant,hungry,sad,bewildered,alone,quixotic,recumbent,bored,excited,relaxed,lonely,curious,guilty,jealous,cheerful,depressed,stressed,infuriated,pleased,crappy,aggravated,okay,rejuvenated,apathetic,bittersweet,optimistic,exanimate,complacent,devious,rejected,blissful,discontent,sympathetic,mellow,refreshed,ecstatic,lazy,morose,dark,mischievous,bouncy,thankful,melancholy,content,drained,numb,uncomfortable,indifferent,groggy,calm,irate,determined,giggly,good,confused,anxious,relieved,mad,accepted,happy,angry,lethargic,shocked,indescribable,satisfied,gloomy,irritated,pessimistic,rushed,frustrated,surprised,annoyed,sleepy,touched,enthralled,cynical,envious,hopeful,ashamed,chipper,loved,giddy,restless", ",");
        string mood_today = moods[gameday_to_int()];
        if (mood_today != "")
            random_messages.listAppend(mood_today);
    }
    
	if (__misc_state["in run"])
    {
        random_messages.listAppend("optimal power, make up!");
        random_messages.listAppend("the faster your runs, the longer they take");
    }
    
    generateRandomMessageLocation(random_messages);

    //random_messages.listAppend(HTMLGenerateTagWrap("a", "if you're feeling stressed, play alice's army", generateMainLinkMap("aagame.php")));
    random_messages.listAppend(HTMLGenerateTagWrap("a", "if you're feeling stressed, play witchess", generateMainLinkMap("playwitchess.php?action=another")));
	random_messages.listAppend("consider your mistakes creative spading");
    
    if (hippy_stone_broken())
        random_messages.listAppend(HTMLGenerateTagWrap("a", "it's not easy having yourself a good time", generateMainLinkMap("peevpee.php")));
    
    string [item] equipment_messages;
    equipment_messages[$item[whatsian ionic pliers]] = "ionic pliers untinker to a screwdriver and a sonar-in-a-biscuit";
    equipment_messages[$item[yearbook club camera]] = "rule of thirds";
    equipment_messages[$item[happiness]] = "bang bang";
    equipment_messages[$item[mysterious silver lapel pin]] = "be seeing you";
    equipment_messages[$item[Moonthril Circlet]] = "moon tiara"; //action!
    equipment_messages[$item[numberwang]] = "simply everyone";
    equipment_messages[$item[Mark V Steam-Hat]] = "girl genius";
    equipment_messages[$item[mr. accessory]] = "you can equip mr. accessories?";
    equipment_messages[$item[white hat hacker T-shirt]] = "hack the planet";
    equipment_messages[$item[heart necklace]] = "&#x2665;&#xfe0e;"; //
    equipment_messages[$item[fleetwood chain]] = "running in the shadows";
    equipment_messages[$item[liar's pants]] = "never tell the same lie twice";
    equipment_messages[$item[detective skull]] = HTMLGenerateSpanFont("too slow ascend faster", "#ACA200"); //speakeasy password
    equipment_messages[$item[gasmask]] = "are you my mummy?";
    equipment_messages[$item[spanish fly trap]] = "around the world around the world around the world around the world";
    equipment_messages[$item[wand of nagamar]] = "levi OH sa";
    if (in_bad_moon() && my_primestat() != $stat[moxie])
        equipment_messages[$item[sneaky pete's breath spray]] = "every class a moxie class";
    foreach it in $items[twisted-up wet towel,sommelier's towel,time bandit time towel]
        equipment_messages[it] = "don't panic";
    equipment_messages[$item[pirate fledges]] = "<img src=\"images/otherimages/12x12skull.gif\" style=\"mix-blend-mode:multiply;\"><strong> oh, better far to live and die, under the brave black flag I fly! </strong><img src=\"images/otherimages/12x12skull.gif\" style=\"mix-blend-mode:multiply;\">";
    equipment_messages[lookupItem("unwrapped knock-off retro superhero cape")] = "you needed worthy opponents";
    
    foreach it in equipment_messages
    {
        if (it.equipped_amount() > 0)
        {
            random_messages.listAppend(equipment_messages[it]);
            //break;
        }
    }
	
	if (my_ascensions() == 0)
		random_messages.listAppend("welcome to the kingdom!");
    else if (my_ascensions() == 1)
        random_messages.listAppend("run, while you still have the chance!");
        
    if (__misc_state["in run"])
        random_messages.listAppend("perfect runs are overrated");
    random_messages.listAppend("math is your helpful friend");
    
    if (get_property_int("_pantsgivingCount") >= 5500)
    {
        random_messages.listAppend("Could not connect to secondary database server:2003 - Can't connect to MySQL server on '10.0.0.51' (99)");
    }
    
    if ((gameday_to_int() & 31) == 0)
        random_messages.listAppend("seek the alchemist"); //a young lady's illustrated ascension guide
    
    string [effect] effect_messages;
    
    effect_messages[$effect[consumed by anger]] = "don't ascend angry";
    effect_messages[$effect[consumed by regret]] = "wasted potential";
    effect_messages[$effect[All Revved Up]] = "vroom";
    if (my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST)
        effect_messages[$effect[Expert Timing]] = "martial arts and crafts";
    effect_messages[$effect[apathy]] = ""; //
    effect_messages[$effect[silent running]] = "an awful lot of running";
    effect_messages[$effect[Neuromancy]] = "the silver paths";
    effect_messages[$effect[Teleportitis]] = "everywhere and nowhere";
    effect_messages[$effect[Form of...Bird!]] = "fiddle fiddle fiddle";
    effect_messages[$effect[superstar]] = "&#9733;";
    effect_messages[$effect[hopped up on goofballs]] = "a massive drug deficiency";
    foreach s in $strings[Warlock\, Warstock\, and Warbarrel,Barrel of Laughs,Barrel Chested,Pork Barrel,Double-Barreled,Beer Barrel Polka]
        effect_messages[s.to_effect()] = "just let me throw a barrel at it";
    effect_messages[$effect[Meteor Showered]] = "";
    foreach e in effect_messages
    {
        if (e.have_effect() > 0 && e != $effect[none])
        {
            random_messages.listAppend(effect_messages[e]);
            break;
        }
    }
    
    
    if (__misc_state["single familiar run"])
        random_messages.listAppend("together forever");
    
    random_messages.listAppend("click click click");
    
    switch (my_path_id())
    {
        case PATH_OXYGENARIAN:
            random_messages.listAppend("the slow path"); break;
        case PATH_BEES_HATE_YOU:
            random_messages.listAppend("bzzzzzz"); break;
        case PATH_WAY_OF_THE_SURPRISING_FIST:
            random_messages.listAppend("martial arts and crafts"); break;
        case PATH_TRENDY:
            random_messages.listAppend("played out"); break;
        case PATH_AVATAR_OF_BORIS:
            random_messages.listAppend("testosterone poisoning"); break;
        case PATH_BUGBEAR_INVASION:
            random_messages.listAppend("bugbears!"); break;
        case PATH_ZOMBIE_SLAYER:
            random_messages.listAppend("consumerism metaphor"); break;
        case PATH_CLASS_ACT:
            random_messages.listAppend("try the sequel"); break;
        case PATH_AVATAR_OF_JARLSBERG:
            random_messages.listAppend("nerd"); break;
        case PATH_BIG:
            random_messages.listAppend("everything's so tiny..."); break;
        case PATH_KOLHS:
            random_messages.listAppend("did you study?"); break;
        case PATH_CLASS_ACT_2:
            random_messages.listAppend("lonely guild trainer"); break;
        case PATH_AVATAR_OF_SNEAKY_PETE:
            random_messages.listAppend("sunglasses at night"); break;
        case PATH_SLOW_AND_STEADY:
            if (!in_hardcore())
                random_messages.listAppend("infinite pulls");
            else
                random_messages.listAppend("skip a day if you like");
            break;
        case PATH_HEAVY_RAINS:
            random_messages.listAppend("survive"); break;
        case PATH_PICKY:
            if ($skill[cannelloni cannon].skill_is_usable() && !$skill[cannelloni cocoon].skill_is_usable()) //such an easy mistake...
                random_messages.listAppend("cannelloni confusion");
            else
                random_messages.listAppend("combinatorial ascension");
            break;
        case PATH_STANDARD:
            random_messages.listAppend("no past no path"); break;
        case PATH_ACTUALLY_ED_THE_UNDYING:
            random_messages.listAppend("UNDYING!"); break;
        case PATH_ONE_CRAZY_RANDOM_SUMMER:
            random_messages.listAppend("dance the mersenne twist"); break;
        case PATH_COMMUNITY_SERVICE:
            random_messages.listAppend("make the world a better place"); break;
        case PATH_AVATAR_OF_WEST_OF_LOATHING:
            random_messages.listAppend("draw"); break;
        case PATH_THE_SOURCE:
            if (my_daycount() % 2 == 0)
                random_messages.listAppend("don't think you aren't. know you aren't.");
            else
                random_messages.listAppend("it is not the spoon that ascends, it is only yourself");
            break;
        case PATH_NUCLEAR_AUTUMN:
            random_messages.listAppend("I do want to set the world on " + HTMLGenerateSpanFont("fire", "red"));
            break;
        case PATH_GELATINOUS_NOOB:
            random_messages.listAppend("you jelly?");
            break;
        case PATH_LICENSE_TO_ADVENTURE:
            random_messages.listAppend("FOR YOUR EYES ONLY");
            break;
        case PATH_LIVE_ASCEND_REPEAT:
            random_messages.listAppend("a single perfect day");
            break;
        case PATH_POCKET_FAMILIARS:
        	random_messages.listAppend("adorable slaves");
            break;
        case PATH_G_LOVER:
            random_messages.listAppend("get going, guuuurl");
            break;
        case PATH_DEMIGUISE:
            random_messages.listAppend("who are you?"); break;
        case PATH_VAMPIRE:
            random_messages.listAppend("die monster! you don't belong in this world!"); break;
        case PATH_2CRS:
            random_messages.listAppend("what happened to my inventory?"); break;
        case PATH_EXPLOSIONS:
            random_messages.listAppend("kaboooooom"); break;
        case PATH_LOKI:
            random_messages.listAppend("more lochs than scotland"); break;
        case PATH_LUIGI:
            random_messages.listAppend("look at that pale skin! he's been living in his brother's shadow too long"); break;
        case PATH_GREY_GOO:
            random_messages.listAppend("avatar of pet rock"); break;
        case PATH_ROBOT:
            random_messages.listAppend("weren't you already a robot? is this double robot?"); break;
        /*case PATH_CLASS_ACT_3:
            random_messages.listAppend("buttons for the people"); break;*/
    }
    
    if (in_ronin() && my_adventures() <= 3)
    	random_messages.listAppend("always tomorrow");
    
    random_messages.listAppend("I don't know either, sorry");
    
    string lowercase_player_name = my_name().to_lower_case().HTMLEscapeString();
        
    random_messages.listAppend(HTMLGenerateTagWrap("a", "check the wiki", mapMake("class", "r_a_undecorated", "href", "http://kol.coldfront.net/thekolwiki/index.php/Main_Page", "target", "_blank")));
    random_messages.listAppend("the RNG is only trying to " + ((random(100) == 0) ? "hurt" : "help"));
    if (__misc_state["in run"])
    {
        int choice = gameday_to_int() & 3;
        
        if (choice == 0)
            random_messages.listAppend("speed ascension is all I have left, " + lowercase_player_name);
        else if (choice == 1)
            random_messages.listAppend("let the turns go");
        else if (choice == 2)
            random_messages.listAppend("mostly made up");
        else if (choice == 3)
            random_messages.listAppend("kingdom of self loathing");
        if (my_ascensions() >= 1000)
            random_messages.listAppend("dedicated");
    }
    
    if (item_drop_modifier() <= -100.0)
        random_messages.listAppend("let go of your material posessions");
    if ($item[puppet strings].item_amount() > 0 && my_id() != 1557284)
    {
        //full puppet string support:
        string chosen_message;
        switch (gameday_to_int() % 13)
        {
            case 0: chosen_message = "%playername% is easily the most great person ever! three cheers for %playername%!"; break;
            case 1: chosen_message = "%playername% is my hero! don't you all agree?"; break;
            case 2: chosen_message = "%playername% is such a sexy beast!"; break;
            case 3: chosen_message = "%playername% is super-attractive and studly! don't you all agree?"; break;
            case 4: chosen_message = "%playername% is super-attractive and studly! just saying that name makes me feel all tingly inside!"; break;
            case 5: chosen_message = "who do I think is the best KoLer? obviously\, it's %playername%! how about a round of applause?"; break;
            case 6: chosen_message = "I wish I was as good-looking as %playername%. hip hip hooray!"; break;
            case 7: chosen_message = "I'm %playername%'s biggest fan! let's hear it for %playername%!"; break;
            case 8: chosen_message = "I've never met anyone as attractive as %playername%! how about a round of applause?"; break;
            case 9: chosen_message = "I've never met anyone as studly as %playername%! all the rest of us are totally lame in comparison!"; break;
            case 10: chosen_message = "is anyone as fabulous as %playername%? I don't think so! just saying that name makes me feel all tingly inside!"; break;
            case 11: chosen_message = "is anyone as intelligent as %playername%? I don't think so! hooray for %playername%!"; break;
            default: chosen_message = "%playername% is totally awesome! hooray for %playername%!"; break;
        }
        chosen_message = chosen_message.replace_string("%playername%", lowercase_player_name);
        random_messages.listAppend(chosen_message);
        //random_messages.listAppend(lowercase_player_name + " is totally awesome! hooray for " + lowercase_player_name + "!");
    }
	
    if (__quest_state["Level 12"].in_progress && __quest_state["Level 12"].state_int["hippies left on battlefield"] < 1000 && __quest_state["Level 12"].state_int["frat boys left on battlefield"] < 1000)
        random_messages.listAppend("playing sides");
    
	if (__iotms_usable[$item[Order of the Green Thumb Order Form]])
        random_messages.listAppend(HTMLGenerateTagWrap("a", "the forgotten friar cries himself to sleep", generateMainLinkMap("place.php?whichplace=forestvillage&amp;action=fv_friar")));
    
	if (!__misc_state["skills temporarily missing"] && !$skill[Transcendent Olfaction].skill_is_usable())
	{
        random_messages.listAppend(HTMLGenerateTagWrap("a", "visit the bounty hunter hunter sometime", generateMainLinkMap("bounty.php")));
	}
    if (__misc_state["in aftercore"])
        random_messages.listAppend(HTMLGenerateTagWrap("a", "ascension is waiting for you", generateMainLinkMap("place.php?whichplace=nstower")));
    
    if (my_adventures() == 0)
        random_messages.listAppend("nowhere left to go");
        
    if (__quest_state["Level 11"].in_progress)
        random_messages.listAppend("try not to lose your sanity");
    if (__quest_state["Level 13"].in_progress && my_path_id() != PATH_LOKI)
    {
        if (my_daycount() == 1)
            random_messages.listAppend("all the world's work in a day");
        else
            random_messages.listAppend("it'll be all over soon");
    }
        
    if (!CounterLookup("Semi-rare").CounterIsRange() && CounterLookup("Semi-rare").CounterExists() && CounterLookup("Semi-rare").exact_turns.count() > 1)
        random_messages.listAppend("superpositioned semi-rare");
    if (hippy_stone_broken() && pvp_attacks_left() > 0)
        random_messages.listAppend(HTMLGenerateTagWrap("a", "aggressive friendship", generateMainLinkMap("peevpee.php")));
    
        
    if (get_property_boolean("_warbearGyrocopterUsed"))
        random_messages.listAppend("[gyroseaten] => 109");
        
    random_messages.listAppend(HTMLGenerateTagWrap("a", "&#x266b;", mapMake("class", "r_a_undecorated", "href", "http://www.kingdomofloathing.com/radio.php", "target", "_blank")));
    
    if (__misc_state_int["free rests remaining"] > 0)
        random_messages.listAppend(HTMLGenerateTagWrap("a", "dream your life away", generateMainLinkMap(__misc_state_string["resting url"])));
    
    if (get_property_int("cinderellaScore") >= 32)
        random_messages.listAppend("mother knows best");

    if ($location[the shore\, inc. travel agency].turnsAttemptedInLocation() >= 11)
    {
        if (hippy_stone_broken())
            random_messages.listAppend("beware of shorebots");
        else
            random_messages.listAppend("under a distant shore you will find your answers");
    }
    
    if (current_hour >= 2 && current_hour <= 3)
        random_messages.listAppend("up late?");
    else if (current_hour >= 4 && current_hour <= 5)
        random_messages.listAppend("zzz...");
    else if (current_hour == 6)
        random_messages.listAppend("the dawn is your enemy");
    
    random_messages.listAppend("take chances, be courages, go exploring!");
    switch (my_class())
    {
        case $class[disco bandit]:
            random_messages.listAppend("making discos of your castles"); break;
        case $class[seal clubber]:
            random_messages.listAppend("I &#x2663;&#xfe0e; seals"); break;
        case $class[turtle tamer]:
            random_messages.listAppend("friends everywhere you go"); break;
        case $class[sauceror]:
            random_messages.listAppend("journey of the sauceror"); break;
        case $class[Snake Oiler]:
            random_messages.listAppend("ten points to slytherin"); break;
    }
    
    if (numeric_modifier("hot damage") <= 0.0 && gameday_to_int() % 4 == 0)
    	random_messages.listAppend("have you tried " + HTMLGenerateSpanFont("fire", "red"));
    
    
    if (__misc_state["Chateau Mantegna available"] && get_property_monster("chateauMonster").phylum == $phylum[fish] && !get_property_boolean("_chateauMonsterFought"))
    {
        random_messages.listAppend(HTMLGenerateTagWrap("a", "personal aquarium", generateMainLinkMap("place.php?whichplace=chateau"))); //WhiteWizard42:  feeeeesh. feesh in the waaaall
    }
    generateRandomMessageFamiliar(random_messages);
        
    if (last_monster().phylum == $phylum[penguin])
    {
        random_messages.listClear(); //sufficiently rare
        random_messages.listAppend("dood");
    }
    
    string [monster] monster_messages;
    string [monster] beaten_up_monster_messages;
    //TODO add a message for the procrastination giant
    foreach m in $monsters[The Temporal Bandit,crazy bastard,Knott Slanding,hockey elemental,Hypnotist of Hey Deze,infinite meat bug,QuickBASIC Elemental,The Master of Thieves,Baiowulf,Count Bakula,The Nuge] //Pooltergeist (Ultra-Rare)?
        monster_messages[m] = "an ultra rare! congratulations!";
    monster_messages[$monster[The Master of Thieves]] = "don't @ me";
    monster_messages[$monster[Dad Sea Monkee]] = "is always was always" + HTMLGenerateSpanFont(" is always was always", "#444444") + HTMLGenerateSpanFont(" is always was always", "#888888") + HTMLGenerateSpanFont(" is always was always", "#BBBBBB");
    
    foreach m in $monsters[Ed the Undying (1),Ed the Undying (2),Ed the Undying (3),Ed the Undying (4),Ed the Undying (5),Ed the Undying (6),Ed the Undying (7)]
        monster_messages[m] = "UNDYING!";
    foreach m in $monsters[Naughty Sorceress, Naughty Sorceress (2), Naughty Sorceress (3)]
    {
        if (holidays_today["Valentine's Day"])
            monster_messages[m] = "please be mine, sorceress";
        else
            monster_messages[m] = "she isn't all that bad";
    }
    foreach m in $monsters[Shub-Jigguwatt\, Elder God of Violence,Yog-Urt\, Elder Goddess of Hatred]
        monster_messages[m] = "strange aeons";
    monster_messages[$monster[daft punk]] = "can you feel it?";
    monster_messages[$monster[ghastly organist]] = "phantom of the opera";
    monster_messages[$monster[The Man]] = "let the workers unite";
    monster_messages[$monster[The Big Wisniewski]] = "far out";
    monster_messages[$monster[Quiet Healer]] = "...";
    monster_messages[$monster[menacing thug]] = "watch your back";
    monster_messages[$monster[sea cowboy]] = "pardon me";
    monster_messages[$monster[topiary golem]] = "almost ther... wait, golems?";
    monster_messages[$monster[The Server]] = "console cowboy";
    monster_messages[$monster[Fickle Finger of F8]] = "f/8 and be there";
    monster_messages[$monster[malevolent crop circle]] = "I want to believe";
    monster_messages[$monster[Enraged Cow]] = "moo";
    if ($item[bottle of blank-out].is_unrestricted())
        monster_messages[$monster[Claybender Sorcerer Ghost]] = "accio blank-out";
    else
        monster_messages[$monster[Claybender Sorcerer Ghost]] = "leaderboardus totalus";
    monster_messages[$monster[Whatsian Commando Ghost]] = "captain jack hotness";
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
        monster_messages[$monster[Whatsian Commando Ghost]] = "are you my mummy?";
    monster_messages[$monster[Space Tourist Explorer Ghost]] = "oh my";
    monster_messages[$monster[Battlie Knight Ghost]] = "boring conversation anyway";
    monster_messages[$monster[oil slick]] = "run more ML!";
    monster_messages[$monster[Space Marine]] = "as if it were from an old dream";
    monster_messages[$monster[Regret Man]] = "wasted potential";
    monster_messages[$monster[Principal Mooney]] = "life moves pretty fast";
    if (my_turncount() < 11)
        monster_messages[$monster[family of kobolds]] = "in a hurry?";
    monster_messages[$monster[Black Crayon Spiraling Shape]] = "be what you're like";
    monster_messages[$monster[best-selling novelist]] = "fiction to escape reality";
    monster_messages[$monster[7-Foot Dwarf Replicant]] = "it's too bad she won't live<br>but then again, who does?";
    monster_messages[$monster[The Avatar of Jarlsberg]] = "smoked cheese";
    monster_messages[$monster[giant sandworm]] = "walk without rhythm";
    monster_messages[$monster[bookbat]] = "tattered scrap of dignity";
    monster_messages[$monster[Urge to Stare at Your Hands]] = ".&#x20dd;.&#x20dd;"; //..
    if (my_path_id() == PATH_HEAVY_RAINS)
        monster_messages[$monster[pygmy bowler]] = "right into the gutter"; //come back!
    monster_messages[$monster[Ron "The Weasel" Copperhead]] = "RONALD WEASLEY! HOW DARE YOU STEAL THAT ZEPPELIN<br>" + ChecklistGenerateModifierSpan("your father's now facing an inquiry at work and it's entirely YOUR FAULT");
    monster_messages[$monster[Mr. Loathing]] = HTMLGenerateTagWrap("a", "ruuun! go! get to the towah!", generateMainLinkMap("place.php?whichplace=nstower"));
    if (my_hp() < my_maxhp())
        monster_messages[$monster[Smooth Criminal]] = "you've been hit by<br>you've been struck by<br><i>a smooth criminal</i>";
    monster_messages[$monster[demonic icebox]] = "zuul";
    monster_messages[$monster[angry mushroom guy]] = "touch fizzy, get dizzy";
    beaten_up_monster_messages[$monster[storm cow]] = "<pre>^__^            <br>(oo)\\_______    <br>(__)\\       )\\/\\<br>    ||----w |   <br>    ||     ||   </pre>";
    monster_messages[$monster[The Barrelmech of Diogenes]] = "just let me throw a barrel at it";
    //beaten_up_monster_messages[$monster[Lavalos]] = HTMLGenerateTagWrap("span", "but... the future refused to change", mapMake("onclick", "var l = new Audio('" + __lavalos_sound_data + "'); l.play();", "class", "r_clickable")); //copyright, etc
    beaten_up_monster_messages[$monster[Lavalos]] = "but... the future refused to change";
    if ($item[protonic accelerator pack].equipped_amount() > 0 && last_monster().monsterIsGhost())
        beaten_up_monster_messages[last_monster()] = "venkman makes it look easy";
    if ($effect[beaten up].have_effect() > 0 && $items[rainbow pearl earring,rainbow pearl necklace,rainbow pearl ring,vampire pearl earring,vampire pearl ring,vampire pearl necklace,freshwater pearl necklace,pearl diver's ring,pearl diver's necklace,pearl necklace].equipped_amount() > 0)
    	beaten_up_monster_messages[last_monster()] = "WHY WON'T YOU JUST LET ME DO THIS FOR YOU, ROSE?";
    if (last_monster().phylum == $phylum[demon])
	    beaten_up_monster_messages[last_monster()] = "he made the devil so much stronger than a man!";
    if (current_hour >= 5 && current_hour <= 11)
        monster_messages[$monster[Lavalos]] = "good morning, " + lowercase_player_name + "!";
    else
        monster_messages[$monster[Lavalos]] = "all life begins with nu and ends with nu";
    monster_messages[$monster[sk8 gnome]] = "he was a sk8 gnome she said see u l8 gnome";
    monster_messages[$monster[The Inquisitor]] = "nothing is up";
    monster_messages[$monster[Doc Clock]] = "your defeat will happen at " + (current_hour > 12 ? current_hour - 12 : current_hour) + ":" + current_minute + " precisely"; // + (current_hour >= 12 ? " PM" : " AM")
    monster_messages[$monster[God Lobster]] = "what a grand and intoxicating innocence"; //how can you kill a god? equip the heart of the volcano?
    monster_messages[$monster[cockroach]] = "are bug exterminators professional assassins?"; 
    
    string day_cycle;
    if (current_hour >= 5 && current_hour <= 11)
        day_cycle = "morning";
    else if (current_hour >= 12 && current_hour <= 16)
        day_cycle = "afternoon";
    else if (current_hour >= 17 && current_hour <= 20)
        day_cycle = "evening";
    else
        day_cycle = "night";
    monster_messages[$monster[Travoltron]] = now_to_string("EEEE").to_lower_case() + " " + day_cycle + " fever";
    
    if (my_daycount() == 2 && (my_adventures() == 0 || availableDrunkenness() < 0) && availableFullness() == 0 && availableDrunkenness() <= 0 && my_path_id() != PATH_OXYGENARIAN && __quest_state["Level 12"].started && !__quest_state["Level 13"].state_boolean["king waiting to be freed"] && my_path_id() != PATH_NUCLEAR_AUTUMN && my_path_id() != PATH_SLOW_AND_STEADY && !__quest_state["Level 13"].finished)
    {
        //detect failed two-day runs, and provide psychological support:
        random_messages.listClear();
        if (__quest_state["Level 13"].started)
            random_messages.listAppend("ever so close");
        else
            random_messages.listAppend("three days is fine");
    }
    
    boolean already_output_relevant_beaten_up_effect = false;
    if ((my_hp() == 0 || $effect[beaten up].have_effect() > 0) && beaten_up_monster_messages contains last_monster() && last_monster() != $monster[none])
    {
		random_messages.listClear();
        random_messages.listAppend(beaten_up_monster_messages[last_monster()]);
        already_output_relevant_beaten_up_effect = true;
    }
    else if (monster_messages contains last_monster() && last_monster() != $monster[none])
    {
		random_messages.listClear();
        random_messages.listAppend(monster_messages[last_monster()]);
    }
    
    
    if (__quest_state["Level 13"].state_boolean["king waiting to be freed"])
    {
        if (my_path_id() == PATH_ONE_CRAZY_RANDOM_SUMMER)
        {
            random_messages.listClear();
            random_messages.listAppend(HTMLGenerateTagWrap("a", "roll the dice", generateMainLinkMap("place.php?whichplace=nstower")));
        }
    }
    
    if (__misc_state_int["Basement Floor"] == 500)
    {
        random_messages.listClear();
        random_messages.listAppend(HTMLGenerateTagWrap("a", "open it!", generateMainLinkMap("basement.php")));
    }
    
    string [string] encounter_messages;
    boolean encounter_override = false;
    encounter_messages["It's Always Swordfish"] = "one two three four five";
    encounter_messages["Meet Frank"] = "don't trust the skull";
    encounter_messages["The Mirror in the Tower has the View that is True"] = "shatter the false reality";
    encounter_messages["A Tombstone"] = "peperony and chease";
    encounter_messages["Witchess Puzzles"] = "this etch a sketch is hard";
    encounter_messages["Rubbed it the Right Way"] = "desire incarnate";
	if (my_class() == $class[turtle tamer])
	{
		//The Horror... needs disambiguation
        foreach s in $strings[Nantucket Snapper,Blue Monday,Capital!,Training Day,Boxed In,Duel Nature,Slow Food,A Rolling Turtle Gathers No Moss,Slow Road to Hell,C'mere\, Little Fella,The Real Victims,Like That Time in Tortuga,Cleansing your Palette,Harem Scarum,Turtle in peril,No Man\, No Hole,Slow and Steady Wins the Brawl,Stormy Weather,Turtles of the Universe,O Turtle Were Art Thou,Allow 6-8 Weeks For Delivery,Kick the Can,Turtles All The Way Around,More eXtreme Than Usual,Jewel in the Rough,The worst kind of drowning]
            encounter_messages[s] = "friend!";
    }
    if (encounter_messages contains get_property("lastEncounter"))
    {
		random_messages.listClear();
        random_messages.listAppend(encounter_messages[get_property("lastEncounter")]);
        encounter_override = true;
    }
    
    if (__quest_state["Level 12"].in_progress && __quest_state["Level 12"].state_int["hippies left on battlefield"] == 1 && __quest_state["Level 12"].state_int["frat boys left on battlefield"] == 1)
    {
        random_messages.listClear();
        random_messages.listAppend("wossname is waiting");
    }
    
    if (my_familiar() == $familiar[Helix Fossil])
    {
        buffer generated;
        
        
        string [int] commands;
        
        string property_value = get_property("__voices");
        
        if (property_value.length() > 1) //remove sentinel
        {
            if (property_value.char_at(property_value.length() - 1) == "|")
                property_value = property_value.substring(0, property_value.length() - 1);
        }
        
        commands = property_value.split_string_alternate(",");
        
        for i from 0 to 0
        {
            string word;
            int r = random(100);
            if (r < 15)
                word = "&#11014;"; //
            else if (r < 30)
                word = "&#11015;"; //
            else if (r < 45)
                word = "&#10145;"; //
            else if (r < 60)
                word = "&#11013;"; //
            else if (r < 75)
                word = "A";// &#9398; = 
            else if (r < 95)
                word = "B"; //&#9399; = 
            else
                word = "start";
                
            
                
            commands.listAppend(word);
        }
        while (commands.count() > 6)
            remove commands[commands.listKeyForIndex(0)];
        set_property("__voices", commands.listJoinComponents(",") + "|"); //we add an ending sentinel because set_property() will remove ";" if it's at the end of the string. set_property() is not guaranteed to keep data integrity
        
        random_messages.listClear();
        
        string message = commands.listJoinComponents(" ");
        message = HTMLGenerateTagWrap("span", message, mapMake("onclick", "updatePageAndFireTimer()", "class", "r_clickable"));
        
        random_messages.listAppend(message);
    }
        
    
    
    foreach s in $strings[rainDohMonster,spookyPuttyMonster,cameraMonster,photocopyMonster,envyfishMonster,iceSculptureMonster,crudeMonster,crappyCameraMonster,romanticTarget,chateauMonster]
    {
        if (get_property_monster(s) == $monster[Quiet Healer])
        {
            random_messages.listClear();
            random_messages.listAppend("you can't bring her back");
            break;
        }
    }
    if (false)//mmg_my_bets().count() > 0)
    {
		random_messages.listClear();
		random_messages.listAppend("win some, lose some");
    }
	if ($effect[beaten up].have_effect() > 0 && limit_mode().length() == 0 && !already_output_relevant_beaten_up_effect)
	{
		random_messages.listClear();
        
        
        switch (my_path_id())
        {
            case PATH_BEES_HATE_YOU:
                random_messages.listAppend("BZZZZZZ"); break;
            case PATH_ONE_CRAZY_RANDOM_SUMMER:
                random_messages.listAppend("tick, tock"); break;
            case PATH_ACTUALLY_ED_THE_UNDYING:
                random_messages.listAppend("DYING!"); break;
            case PATH_COMMUNITY_SERVICE:
                random_messages.listAppend("no good deed goes unpunished"); break;
            case PATH_AVATAR_OF_WEST_OF_LOATHING:
                random_messages.listAppend("shucks"); break;
            case PATH_LIVE_ASCEND_REPEAT:
                random_messages.listAppend("I got you babe"); break;
            case PATH_LICENSE_TO_ADVENTURE:
                random_messages.listAppend("you only live twice"); break;
            case PATH_THE_SOURCE:
                random_messages.listAppend("not like this"); break;
            case PATH_POCKET_FAMILIARS:
                random_messages.listAppend(lowercase_player_name + "! now is not the time to use that!"); break;
            case PATH_G_LOVER:
                random_messages.listAppend("the Gs will continue until morale improves"); break;
            default:
                random_messages.listAppend("ow"); break;
        }
	}
	if (my_turncount() <= 0)
	{
		random_messages.listClear();
        if (my_path_id() == PATH_LIVE_ASCEND_REPEAT)
            random_messages.listAppend("I got you babe");
        else if (my_path_id() == PATH_POCKET_FAMILIARS)
            random_messages.listAppend("pika pika!");
        else
            random_messages.listAppend("find yourself<br>starting back");
	}
    if (limit_mode() == "Spelunky" && !encounter_override)
    {
		random_messages.listClear();
        
        if (get_property("lastEncounter") == "Spelunkrifice" && get_property("spelunkyStatus").contains_text("Buddy: "))
        {
            if (get_property("spelunkingStatus").contains_text("Resourceful Kid"))
                random_messages.listAppend("he's only a child!");
            else
                random_messages.listAppend("et tu, " + lowercase_player_name + "?");
        }
        else
            random_messages.listAppend("ascend? yes! play? no!");
    }
    if (limit_mode() == "batman" && !encounter_override)
    {
		random_messages.listClear();
        random_messages.listAppend("a superstitious, cowardly lot");
    }
    
    if (format_today_to_string("yyyyMMdd") == "20151021") //october 21st, 2015
    {
        //kept active for any time travelers
		random_messages.listClear();
        if (get_property("System.user.country.format") == "US")
            random_messages.listAppend("88 MPH<br>hey, you did it!");
        else
            random_messages.listAppend("142 km/h<br>hey, you did it!");
    }
    
    
    //Choose:
    if (random_messages.count() == 0)
        return "lack of cleverness";
	string chosen_message = "";
	//Base message off of the minute, so it doesn't cycle when the page reloads often:
	chosen_message = random_messages[minute_of_day % random_messages.count()];
    
    return chosen_message;
}


void generateImageTest(Checklist [int] checklists)
{
	ChecklistEntry [int] image_test_entries;
	KOLImagesInit();
	foreach i in __kol_images
	{
		KOLImage image = __kol_images[i];
		image_test_entries.listAppend(ChecklistEntryMake(106, i, "", ChecklistSubentryMake(i)));
		
	}
	checklists.listAppend(ChecklistMake("All images", image_test_entries));
}

void generateStateTest(Checklist [int] checklists)
{
	ChecklistEntry [int] misc_state_entries;
	ChecklistEntry [int] quest_state_entries;
    
	
    string [int] state_description;
    string [int] string_description;
    string [int] int_description;
	foreach key in __misc_state
	{
        state_description.listAppend(key + " = " + __misc_state[key]);
	}
	foreach key in __misc_state_string
	{
        string_description.listAppend(key + " = \"" + __misc_state_string[key] + "\"");
	}
	foreach key in __misc_state_int
	{
        int_description.listAppend(key + " = " + __misc_state_int[key]);
	}
	
    misc_state_entries.listAppend(ChecklistEntryMake(107, "__item milky potion", "", ChecklistSubentryMake("Boolean", "", state_description.listJoinComponents("|"))));
    misc_state_entries.listAppend(ChecklistEntryMake(108, "__item ghost thread", "", ChecklistSubentryMake("String", "", string_description.listJoinComponents("|"))));
    misc_state_entries.listAppend(ChecklistEntryMake(109, "__item handful of numbers", "", ChecklistSubentryMake("Int", "", int_description.listJoinComponents("|"))));
	
	boolean [string] names_already_seen;
	
	foreach key in __quest_state
	{
		if (names_already_seen[key])
			continue;
		names_already_seen[key] = true;
		
		QuestState quest_state = __quest_state[key];
		
		string [int] full_name_list;
		full_name_list.listAppend(key);
		
		//Look for others:
		foreach key2 in __quest_state
		{
			if (key == key2)
				continue;
			QuestState quest_state_2 = __quest_state[key2];
			
			if (QuestStateEquals(quest_state, quest_state_2))
			{
				full_name_list.listAppend(key2);
				names_already_seen[key2] = true;
			}
		}
		
		ChecklistSubentry subentry;
		
		subentry.header = listJoinComponents(full_name_list, " / " );
		if (quest_state.quest_name != "")
			subentry.entries.listAppend("Internal name: " + quest_state.quest_name);
		
		subentry.entries.listAppend("Startable: " + quest_state.startable);
		subentry.entries.listAppend("Started: " + quest_state.started);
		subentry.entries.listAppend("In progress: " + quest_state.in_progress);
		subentry.entries.listAppend("Finished: " + quest_state.finished);
		subentry.entries.listAppend("Mafia's internal step: " + quest_state.mafia_internal_step);
		
		foreach key2 in quest_state.state_boolean
		{
			subentry.entries.listAppend(key2 + ": " + quest_state.state_boolean[key2]);
		}
		foreach key2 in quest_state.state_string
		{
			subentry.entries.listAppend(key2 + ": \"" + quest_state.state_string[key2] + "\"");
		}
		foreach key2 in quest_state.state_int
		{
			subentry.entries.listAppend(key2 + ": " + quest_state.state_int[key2]);
		}
		
		quest_state_entries.listAppend(ChecklistEntryMake(110, quest_state.image_name, "", subentry));
	}
	
	
	checklists.listAppend(ChecklistMake("Misc. States", misc_state_entries));
	checklists.listAppend(ChecklistMake("Quest States", quest_state_entries));
}

void generateCounterTest(Checklist [int] checklists)
{
	ChecklistEntry [int] checklist_entries;
    
    ChecklistEntry main_entry;
    main_entry.image_lookup_name = "__item sinister ancient tablet";
    
    string [int] counter_names = CounterGetAllNames();
    
    if (counter_names.count() == 0)
        return;
    
    foreach key in counter_names
    {
        string counter_name = counter_names[key];
        Counter c = CounterLookup(counter_name);
        
        string [int] description;
        description.listAppend(c.CounterDescription());
        
        main_entry.subentries.listAppend(ChecklistSubentryMake(c.name, "", description));
    }
    
    checklist_entries.listAppend(main_entry);
    
    
	checklists.listAppend(ChecklistMake("Counters", checklist_entries));
}

buffer generateMajorMinorText(string [string][int] entries)
{
    buffer description;
    foreach zone in entries
    {
        if (description.length() > 0)
            description.append("|");
        description.append(zone);
        description.append(":|*");
        description.append(entries[zone].listJoinComponents("|*"));
    }
    return description;
}

void generateSelfDataTest(Checklist [int] checklists)
{
	ChecklistEntry [int] checklist_entries;
    //Show missing locations in locationAvailable and missing locations from clickables.
    
    string [string][int] missing_available_locations;
    string [string][int] missing_location_links_description;
    
    foreach l in $locations[]
    {
        Error unable_to_find_location;
        l.locationAvailable(unable_to_find_location);
        
        if (unable_to_find_location.was_error)
        {
            if (!(missing_available_locations contains l.zone))
                missing_available_locations[l.zone] = listMakeBlankString();
            missing_available_locations[l.zone].listAppend(l.to_string());
        }
        
        Error unable_to_find_clickable;
        l.getClickableURLForLocation(unable_to_find_clickable);
        if (unable_to_find_clickable.was_error)
        {
            if (!(missing_location_links_description contains l.zone))
                missing_location_links_description[l.zone] = listMakeBlankString();
            missing_location_links_description[l.zone].listAppend("lookup_map[\"" + l.to_string() + "\"] = \"REPLACEME\";");
        }
    }
    if (missing_available_locations.count() > 0)
    {
        buffer description = generateMajorMinorText(missing_available_locations);
        checklist_entries.listAppend(ChecklistEntryMake(111, "__item cobb's knob map", "", ChecklistSubentryMake("Missing locationAvailable() locations", "", description)));
    }
    
    
    if (missing_location_links_description.count() > 0)
    {
        buffer description = generateMajorMinorText(missing_location_links_description);
        checklist_entries.listAppend(ChecklistEntryMake(112, "__item reflection of a map", "", ChecklistSubentryMake("Missing getClickableURLForLocation() locations", "", description)));
    }
	checklists.listAppend(ChecklistMake("Self data tests", checklist_entries));
}


void generateBanishTest(Checklist [int] checklists)
{
	ChecklistEntry [int] checklist_entries;
    
    string [int][int] banish_table;
    banish_table.listAppend(listMake("<strong>Monster</strong>", "<strong>Source</strong>", "<strong>On turn</strong>", "<strong>Turn length</strong>", "<strong>Reset conditions</strong>"));
    foreach key, b in BanishesActive()
    {
        banish_table.listAppend(listMake(b.banished_monster, b.banish_source, b.turn_banished, b.banish_turn_length, b.custom_reset_conditions));
    }
    if (banish_table.count() > 1)
    {
        checklist_entries.listAppend(ChecklistEntryMake(113, "__item ice house", "", ChecklistSubentryMake("Banishes", "", HTMLGenerateSimpleTableLines(banish_table))));
    }
    
	checklists.listAppend(ChecklistMake("Banishes", checklist_entries));
}

void generateAllTests(Checklist [int] checklists)
{
    generateImageTest(checklists);
    generateStateTest(checklists);
    generateCounterTest(checklists);
    generateBanishTest(checklists);
    generateSelfDataTest(checklists);
}



/*zone values:
Bat-Cavern
Somewhere in Gotpork City
Center Park (Low Crime)
Slums (Moderate Crime)
Industrial District (High Crime)
Downtown
*/
//Bat-Investigation Progress appears to be the amount of progress you advance per fight, which upgrades with upgrades.
Record BatState
{
    string zone;
    int funds_available;
    int time_left;
    
    string [string] stats;
    boolean [string] upgrades;
    /*int hp;
    int max_hp;
    int hp_regen;*/
    //FIXME more
};

BatState __batstate;

BatState BatStateMake()
{
    BatState state;
    //Parse:
    state.zone = get_property("batmanZone");
    state.funds_available = get_property_int("batmanFundsAvailable");
    state.time_left = get_property_int("batmanTimeLeft");
    //FIXME upgrades
    
    foreach key, s in get_property("batmanStats").split_string_alternate(";")
    {
        string [int] attribution = s.split_string_alternate("=");
        if (attribution.count() != 2)
            continue;
        state.stats[attribution[0]] = attribution[1];
    }
    foreach key, s in get_property("batmanUpgrades").split_string_alternate(";")
        state.upgrades[s] = true;
    __batstate = state;
    return state;
}


static
{
	location [monster] __batfellow_bosses_to_locations;
	
	void initialiseBatfellowBosses()
	{
		__batfellow_bosses_to_locations[$monster[Kudzu]] = $location[Gotpork Conservatory of Flowers];
        __batfellow_bosses_to_locations[$monster[Mansquito]] = $location[Gotpork Municipal Reservoir];
        __batfellow_bosses_to_locations[$monster[Miss Graves]] = $location[Gotpork Gardens Cemetery];
        
        __batfellow_bosses_to_locations[$monster[The Plumber]] = $location[Gotpork City Sewers];
        __batfellow_bosses_to_locations[$monster[The Author]] = $location[Porkham Asylum];
        __batfellow_bosses_to_locations[$monster[The Mad Libber]] = $location[The Old Gotpork Library];
        
        __batfellow_bosses_to_locations[$monster[Doc Clock]] = $location[Gotpork Clock, Inc.];
        __batfellow_bosses_to_locations[$monster[Mr. Burns]] = $location[Gotpork Foundry];
        __batfellow_bosses_to_locations[$monster[The Inquisitor]] = $location[Trivial Pursuits, LLC];
	}
	initialiseBatfellowBosses();
	
}


Record BatfellowBossArea
{
    location area;
    string short_name;
    string image_name;
    string zone;
    monster boss;
    string [int] strategies;
    int [item] nc_twenty_five_progress_requirements;
    int [item] nc_fifty_progress_requirements;
    int [item] nc_reward_items;
};

BatfellowBossArea BatfellowBossAreaMake()
{
    BatfellowBossArea area;
    return area;
}

static
{
    BatfellowBossArea [location] __batfellow_bosses;
    void initialiseBatfellowBossAreas()
    {
        BatfellowBossArea area = BatfellowBossAreaMake();
        area.area = $location[Gotpork Conservatory of Flowers];
        area.short_name = "Conservatory";
        area.image_name = "sunflower face";
        area.zone = "Center Park (Low Crime)";
        area.boss = $monster[Kudzu];
        area.nc_twenty_five_progress_requirements[$item[glob of Bat-Glue]] = 1;
        area.nc_fifty_progress_requirements[$item[fingerprint dusting kit]] = 3;
        area.nc_reward_items[$item[dangerous chemicals]] = 5;
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[Gotpork Municipal Reservoir];
        area.short_name = "Reservoir";
        area.image_name = "__item personal raindrop"; //"__item ketchup hound";
        area.zone = "Center Park (Low Crime)";
        area.boss = $monster[Mansquito];
        area.nc_twenty_five_progress_requirements[$item[Bat-Aid&trade; bandage]] = 1;
        area.nc_fifty_progress_requirements[$item[ultracoagulator]] = 3;
        area.nc_reward_items[$item[kidnapped orphan]] = 5;
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[Gotpork Gardens Cemetery];
        area.short_name = "Cemetery";
        area.image_name = "__item grave robbing shovel";
        area.zone = "Center Park (Low Crime)";
        area.boss = $monster[Miss Graves];
        area.nc_twenty_five_progress_requirements[$item[bat-bearing]] = 1;
        area.nc_fifty_progress_requirements[$item[exploding kickball]] = 3;
        area.nc_reward_items[$item[incriminating evidence]] = 5;
        __batfellow_bosses[area.area] = area;
        
        
        area = BatfellowBossAreaMake();
        area.area = $location[Porkham Asylum];
        area.short_name = "Asylum";
        area.image_name = "__item jet bennie marble";
        area.zone = "Slums (Moderate Crime)";
        area.boss = $monster[The Author];
        area.nc_twenty_five_progress_requirements[$item[bat-o-mite]] = 1;
        area.nc_reward_items[$item[high-grade metal]] = 6;
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[Gotpork City Sewers];
        area.short_name = "Sewers";
        area.image_name = "__item helmet turtle";
        area.zone = "Slums (Moderate Crime)";
        area.boss = $monster[The Plumber];
        area.nc_twenty_five_progress_requirements[$item[bat-oomerang]] = 1;
        area.nc_reward_items[$item[high-grade explosives]] = 6;
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[The Old Gotpork Library];
        area.short_name = "Library";
        area.image_name = "__item very overdue library book";
        area.zone = "Slums (Moderate Crime)";
        area.boss = $monster[The Mad Libber];
        area.nc_twenty_five_progress_requirements[$item[bat-jute]] = 1;
        area.nc_reward_items[$item[high-tensile-strength fibers]] = 6;
        __batfellow_bosses[area.area] = area;
        
        
        area = BatfellowBossAreaMake();
        area.area = $location[Gotpork Clock, Inc.];
        area.short_name = "Clock";
        area.image_name = "__item borrowed time";
        area.zone = "Industrial District (High Crime)";
        area.boss = $monster[Doc Clock];
        area.nc_twenty_five_progress_requirements[$item[exploding kickball]] = 1;
        area.nc_reward_items[$item[kidnapped orphan]] = 6;
        area.nc_reward_items[$item[high-grade explosives]] = 6;
        area.strategies.listAppend("Bat-oomerang the time bandits, to prevent them from stealing time?");
        area.strategies.listAppend("Gain resources from the NC?");
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[Gotpork Foundry];
        area.short_name = "Foundry";
        area.image_name = "__item handful of fire";
        area.zone = "Industrial District (High Crime)";
        area.boss = $monster[Mr. Burns];
        area.nc_twenty_five_progress_requirements[$item[ultracoagulator]] = 1;
        area.nc_reward_items[$item[dangerous chemicals]] = 6;
        area.nc_reward_items[$item[high-grade metal]] = 6;
        area.strategies.listAppend("Gain resources from the NC?");
        __batfellow_bosses[area.area] = area;
        
        area = BatfellowBossAreaMake();
        area.area = $location[Trivial Pursuits, LLC];
        area.short_name = "Trivial Company";
        area.image_name = "__item Trivial Avocations Card: What?";
        area.zone = "Industrial District (High Crime)";
        area.boss = $monster[The Inquisitor];
        area.nc_twenty_five_progress_requirements[$item[fingerprint dusting kit]] = 1;
        area.nc_reward_items[$item[incriminating evidence]] = 6;
        area.nc_reward_items[$item[high-tensile-strength fibers]] = 6;
        area.strategies.listAppend("Gain resources from the NC?");
        __batfellow_bosses[area.area] = area;
    }
    initialiseBatfellowBossAreas();
}


void LimitModeBatfellowGenerateResources(ChecklistEntry [int] resource_entries, BatState state)
{
    if (__setting_debug_mode)
    {
        string [int] description;
        foreach s in $strings[batmanBonusInitialFunds,batmanFundsAvailable,batmanStats,batmanTimeLeft,batmanUpgrades,batmanZone]
        {
            description.listAppend(s + " = " + get_property(s));
        }
        description.listAppend("Dwayne Manor");
        resource_entries.listAppend(ChecklistEntryMake(434, "__item batarang", "", ChecklistSubentryMake("Bat-Properties", "", description), 8));
        
        resource_entries.listAppend(ChecklistEntryMake(435, "__item batarang", "", ChecklistSubentryMake("Bat-State", "", state.to_json()), 8));
    }
    
    string [item] item_descriptions;
    item_descriptions[$item[bat-oomerang]] = "Deals 20 damage, disarms foes, speeds up sewers.";
    item_descriptions[$item[bat-jute]] = "Against a monster with ten or less HP, defeats foe and increases progress that fight.|Speeds up the library.";
    item_descriptions[$item[bat-o-mite]] = "Instakill, speeds up asylum.";
    
    item_descriptions[$item[incriminating evidence]] = "Trade for armour upgrades and progress increasers.";//, which also help with the trivia company and the conservatory.";
    item_descriptions[$item[dangerous chemicals]] = "Trade for health upgrades and HP restorers.";//, which also help with the foundry and the reservoir.";
    item_descriptions[$item[kidnapped orphan]] = "Trade for attack upgrades and free instakills.";//, which also help with the clock factory and cemetary.";
    
    
    item_descriptions[$item[high-grade metal]] = "make bat-oomeranges (damages)";
    item_descriptions[$item[high-tensile-strength fibers]] = "makes bat-jutes (damages)";
    item_descriptions[$item[high-grade explosives]] = "makes bat-o-mites (kills?)";
    
    item_descriptions[$item[experimental gene therapy]] = "";
    item_descriptions[$item[ultracoagulator]] = "restores all HP, speeds up foundry and reservoir";
    item_descriptions[$item[self-defense training]] = "";
    item_descriptions[$item[fingerprint dusting kit]] = "4% progress/fight, speeds up trivia company and conservatory";
    item_descriptions[$item[confidence-building hug]] = "";
    item_descriptions[$item[exploding kickball]] = "skips monster to advance the NC, speeds up clock factory and cemetary";
    item_descriptions[$item[glob of Bat-Glue]] = "stuns for multiple rounds, speeds up conservatory";
    item_descriptions[$item[Bat-Aid&trade; bandage]] = "restores 20 HP, speeds up reservoir";
    item_descriptions[$item[bat-bearing]] = "stuns foes, deals 15 damage, speeds up cemetary";
    
    item [int][int] item_groupings;
    item_groupings.listAppend(listMake($item[bat-oomerang], $item[bat-jute], $item[bat-o-mite]));
    item_groupings.listAppend(listMake($item[incriminating evidence], $item[dangerous chemicals], $item[kidnapped orphan]));
    item_groupings.listAppend(listMake($item[high-grade metal], $item[high-tensile-strength fibers], $item[high-grade explosives]));
    
    foreach it in item_descriptions
        item_groupings.listAppend(listMake(it));
    
    /*foreach it in $items[]
    {
        if (it.available_amount() > 0)
            item_groupings.listAppend(listMake(it));
    }*/
    boolean [item] seen_items;
    foreach key in item_groupings
    {
        ChecklistEntry entry = ChecklistEntryMake(436);
        foreach key2, it in item_groupings[key]
        {
            if (seen_items[it])
                continue;
            if (it.available_amount() > 0)
            {
                seen_items[it] = true;
                string description = item_descriptions[it];
                if (item_descriptions contains it && description == "") //deliberately ignore, for the three upgrade items
                    continue;
                entry.subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", description));
                if (entry.image_lookup_name == "")
                    entry.image_lookup_name = "__item " + it;
                //resource_entries.listAppend(ChecklistEntryMake(437, "__item " + it, "", ChecklistSubentryMake(pluralise(it), "", description), 8));
            }
        }
        if (entry.subentries.count() > 0)
            resource_entries.listAppend(entry);
    }
}


void LimitModeBatfellowGeneralGenerateTasks(ChecklistEntry [int] task_entries, BatState state)
{
    if (true)
    {
        string [int] description;
        if (state.zone != "Downtown")
        {
            if (my_hp() == 0)
                description.listAppend("Go downtown, visit the hospital?");
        }
        else if (my_hp() != my_maxhp())
            description.listAppend("Visit the hospital?");
        if (description.count() > 0)
            task_entries.listAppend(ChecklistEntryMake(438, "__item bubblegum heart", "main.php", ChecklistSubentryMake("Heal", "", description), -11));
    }
    
}

void LimitModeBatfellowBossesGenerateTasks(ChecklistEntry [int] task_entries, BatState state)
{
    foreach l, area in __batfellow_bosses
    {
        if (area.zone != state.zone)
            continue;
        
        int area_progress = -1;
        int progress_remaining = clampi(100 - area_progress, 0, 100);
        
        
        string [int] description;
        if (progress_remaining > 0)
        {
            if (area_progress == -1)
                description.listAppend("?% progress remaining.");
            else
                description.listAppend(progress_remaining + "% progress remaining.");
            
            if (progress_remaining > 10)
            {
                //description.listAppend("area = " + area.to_json());
                boolean has_fifty_progress = false;
                boolean meets_fifty_progress = false;
                if (area.nc_fifty_progress_requirements.count() > 0)
                {
                    has_fifty_progress = true;
                    meets_fifty_progress = true;
                    foreach it, amount in area.nc_fifty_progress_requirements
                    {
                        if (it.available_amount() < amount)
                        {
                            meets_fifty_progress = false;
                            int remaining = MAX(0, amount - it.available_amount());
                            description.listAppend("Avoid until you have " + remaining.int_to_wordy() + " more " + (remaining > 1 ? it.plural : it) + ".|(50% progress in NC)");
                        }
                    }
                }
                if (area.nc_twenty_five_progress_requirements.count() > 0 && !(has_fifty_progress && meets_fifty_progress))
                {
                    foreach it, amount in area.nc_twenty_five_progress_requirements
                    {
                        if (it.available_amount() < amount)
                        {
                            int remaining = MAX(0, amount - it.available_amount());
                            string line = "Avoid until you have ";
                            if (has_fifty_progress && !meets_fifty_progress)
                                line = "Or until you have ";
                            line += remaining.int_to_wordy() + " more " + (remaining > 1 ? it.plural : it) + ".|(25% progress in NC)";
                            description.listAppend(line);
                        }
                    }
                }
                if (area.strategies.count() > 0)
                    description.listAppend(area.strategies.listJoinComponents("|"));
                if (area.nc_reward_items.count() > 0)
                {
                    string [int] rewards;
                    foreach it, amount in area.nc_reward_items
                    {
                        rewards.listAppend(pluralise(amount, it));
                    }
                    description.listAppend("NC reward option gives " + rewards.listJoinComponents(", ", "and") + ".");
                }
            }
            task_entries.listAppend(ChecklistEntryMake(439, area.image_name, "main.php", ChecklistSubentryMake("Fight in the " + area.short_name, "", description), 8));
        }
        else
        {
            task_entries.listAppend(ChecklistEntryMake(440, "__monster " + area.boss, "main.php", ChecklistSubentryMake("Defeat " + area.boss, "", ""), 8));
        }
        
    }
    
}

void LimitModeBatfellowJokesterGenerateTasks(ChecklistEntry [int] task_entries, BatState state)
{
    return;
}

void LimitModeBatfellowBatCavernGenerateTaskResources(ChecklistEntry [int] task_entries, ChecklistEntry [int] resource_entries, BatState state)
{
    boolean found_tasks = false;
    if (state.funds_available > 0)
    {
        string [string][string] suggested_upgrades;
        suggested_upgrades["Suit"] = {};
        suggested_upgrades["Sedan"] = {};
        suggested_upgrades["Cavern"] = {};
        //orphans,evidence,chemicals bat-sedan
        //lower combat time
        //two that decrease searching
        //glue, bearings, bat-aids after every third combat
        //orphan/chemical upgrades, but not evidence upgrades?
        suggested_upgrades["Suit"]["Improved Cowl Optics"] = "find things?";
        suggested_upgrades["Suit"]["Utility Belt First Aid Kit"] = "bandages every third combat";
        suggested_upgrades["Suit"]["Extra-Swishy Cloak"] = "prevents first hit in combat";
        suggested_upgrades["Suit"]["Hardened Knuckles"] = "double punch damage";
        suggested_upgrades["Suit"]["Steel-Toed Bat-Boots"] = "double kick damage";
        
        suggested_upgrades["Sedan"]["Rocket Booster"] = "faster travel time";
        suggested_upgrades["Sedan"]["Street Sweeper"] = "gather evidence while driving";
        suggested_upgrades["Sedan"]["Advanced Air Filter"] = "gather dangerous chemicals while driving";
        suggested_upgrades["Sedan"]["Orphan Scoop"] = "gather orphans while driving";
        suggested_upgrades["Sedan"]["Spotlight"] = "faster progress";
        suggested_upgrades["Sedan"]["Loose Bearings"] = "bearings every third combat";
        
        
        suggested_upgrades["Cavern"]["Surveillance Network"] = "faster progress";
        suggested_upgrades["Cavern"]["Glue Factory"] = "glue every third combat";
        suggested_upgrades["Cavern"]["Improved 3-D Bat-Printer"] = "cheaper bat-materials";
        suggested_upgrades["Cavern"]["Really Long Winch"] = "instant travel back home";
        suggested_upgrades["Cavern"]["Blueprints Database"] = "faster progress?";
        suggested_upgrades["Cavern"]["Transfusion Satellite"] = "restores 5 hp/fight";
        
        
        string [int] description;
        foreach type in $strings[Suit,Sedan,Cavern]
        {
            string [int] type_upgrades;
            foreach upgrade_name, upgrade_decription in suggested_upgrades[type]
            {
                if (state.upgrades contains upgrade_name)
                    continue;
                type_upgrades.listAppend(HTMLGenerateSpanOfClass(upgrade_name, "r_bold") + ": " + upgrade_decription);
            }
            if (type_upgrades.count() == 0) continue;
            description.listAppend(HTMLGenerateSpanOfClass(type, "r_bold") + ":|*" + type_upgrades.listJoinComponents("|*"));
        }
        string url;
        if (state.zone == "Bat-Cavern")
            url = "place.php?whichplace=batman_cave&action=batman_cave_rnd";
        else
            description.listAppend("Travel to the Bat-Cavern first.");
        ChecklistEntry entry = ChecklistEntryMake(441, "__item fat stacks of cash", url, ChecklistSubentryMake(pluralise(state.funds_available, "Bat-Research", "Bat-Researches"), "", description), 8);
        if (state.zone != "Bat-Cavern")
            resource_entries.listAppend(entry);
        else
        {
            task_entries.listAppend(entry);
            found_tasks = true;
        }
    }
    if (state.zone == "Bat-Cavern" && $items[high-grade metal,high-tensile-strength fibers,high-grade explosives].available_amount() > 0)
    {
        item [item] fabricator_conversions;
        fabricator_conversions[$item[high-grade metal]] = $item[bat-oomerang];
        fabricator_conversions[$item[high-tensile-strength fibers]] = $item[bat-jute];
        fabricator_conversions[$item[high-grade explosives]] = $item[bat-o-mite];
        int cost_per_conversion = 3;
        if (state.upgrades["Improved 3-D Bat-Printer"])
            cost_per_conversion = 2;
        string [int] craftables;
        foreach source, destination in fabricator_conversions
        {
            int amount_craftable = source.available_amount() / cost_per_conversion;
            if (amount_craftable > 0)
            {
                craftables.listAppend(pluralise(amount_craftable, destination));
            }
        }
        
        string [int] description;
        if (craftables.count() > 0)
            description.listAppend("Can make " + craftables.listJoinComponents(", ", "and") + ".");
        if (description.count() > 0)
        {
            task_entries.listAppend(ChecklistEntryMake(442, "__item high-grade explosives", "shop.php?whichshop=batman_cave", ChecklistSubentryMake("Bat-Fabricate", "", description), 8));
            found_tasks = true;
        }
    }
    if (!found_tasks && state.zone == "Bat-Cavern")
    {
        string [int] description;
        task_entries.listAppend(ChecklistEntryMake(443, "__item bitchin' meatcar", "place.php?whichplace=batman_cave&action=batman_cave_car", ChecklistSubentryMake("Travel somewhere", "", description), 8));
    }
    
}
void LimitModeBatfellowDowntownGenerateTasks(ChecklistEntry [int] task_entries, BatState state)
{
    if (state.zone != "Downtown")
        return;
    item evidence = $item[incriminating evidence];
    item chemicals = $item[dangerous chemicals];
    item orphans = $item[kidnapped orphan];
    boolean found_tasks = false;
    if (orphans.available_amount() > 0)
    {
        string [int] description;
        string [int] options;
        int hug_price = 3 + 3 * $item[confidence-building hug].available_amount();
        if (hug_price <= orphans.available_amount())
            options.listAppend("+1 damage upgrades");
        options.listAppend("freekill kickballs");
        description.listAppend(options.listJoinComponents(" / ").capitaliseFirstLetter() + ".");
        task_entries.listAppend(ChecklistEntryMake(444, "__item kidnapped orphan", "shop.php?whichshop=batman_orphanage", ChecklistSubentryMake("Turn in orphans", "", description), 8));
        found_tasks = true;
    }
    if (chemicals.available_amount() > 0)
    {
        string [int] description;
        string [int] options;
        int hug_price = 3 + 3 * $item[experimental gene therapy].available_amount();
        if (hug_price <= chemicals.available_amount())
            options.listAppend("+10 HP upgrades");
        options.listAppend("HP-restoring ultracoagulators");
        description.listAppend(options.listJoinComponents(" / ").capitaliseFirstLetter() + ".");
        task_entries.listAppend(ChecklistEntryMake(445, "__item " + chemicals, "shop.php?whichshop=batman_chemicorp", ChecklistSubentryMake("Turn in chemicals", "", description), 8));
        found_tasks = true;
    }
    if (evidence.available_amount() > 0)
    {
        string [int] description;
        string [int] options;
        int hug_price = 3 + 3 * $item[self-defense training].available_amount();
        if (hug_price <= evidence.available_amount())
            options.listAppend("+armour upgrades");
        options.listAppend("progress-increasing fingerprint dusting kits");
        description.listAppend(options.listJoinComponents(" / ").capitaliseFirstLetter() + ".");
        task_entries.listAppend(ChecklistEntryMake(446, "__item " + evidence, "shop.php?whichshop=batman_pd", ChecklistSubentryMake("Turn in evidence", "", description), 8));
        found_tasks = true;
    }
    if (!found_tasks && my_hp() == my_maxhp())
    {
        string [int] description;
        task_entries.listAppend(ChecklistEntryMake(447, "__item bitchin' meatcar", "place.php?whichplace=batman_downtown&action=batman_downtown_car", ChecklistSubentryMake("Travel somewhere", "", description), 8));
    }
}

void LimitModeBatfellowGenerateChecklists(Checklist [int] checklists)
{
    if (limit_mode() != "batman")
        return;

    ChecklistEntry [int] task_entries;
    ChecklistEntry [int] optional_task_entries;
    ChecklistEntry [int] future_task_entries;
    ChecklistEntry [int] resource_entries;

    if (true)
    {
        Checklist task_checklist;
        task_checklist = ChecklistMake("Bat-Tasks", task_entries);
        checklists.listAppend(task_checklist);
        
        
        Checklist optional_task_checklist;
        optional_task_checklist = ChecklistMake("Optional Bat-Tasks", optional_task_entries);
        checklists.listAppend(optional_task_checklist);
        
        Checklist future_task_checklist;
        future_task_checklist = ChecklistMake("Future Bat-Tasks", future_task_entries);
        checklists.listAppend(future_task_checklist);
        
        Checklist resources_checklist;
        resources_checklist = ChecklistMake("Bat-Resources", resource_entries);
        checklists.listAppend(resources_checklist);
    }
    
    BatState bat_state = BatStateMake();
    
    
    //task_entries.listAppend(ChecklistEntryMake(448, "__item batarang", "", ChecklistSubentryMake("Stop the Jokester", "", "Better living through violence?"), 8));
    
    LimitModeBatfellowGenerateResources(resource_entries, bat_state);
    LimitModeBatfellowGeneralGenerateTasks(task_entries, bat_state);
    
    LimitModeBatfellowBossesGenerateTasks(task_entries, bat_state);
    
    LimitModeBatfellowJokesterGenerateTasks(task_entries, bat_state);
    
    LimitModeBatfellowBatCavernGenerateTaskResources(task_entries, resource_entries, bat_state);
    LimitModeBatfellowDowntownGenerateTasks(task_entries, bat_state);
}

RegisterResourceGenerationFunction("BatfellowGenerateResource");
void BatfellowGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[replica bat-oomerang].available_amount() > 0)
    {
        int remaining = clampi(3 - get_property_int("_usedReplicaBatoomerang"), 0, 3);
        if (remaining > 0)
            resource_entries.listAppend(ChecklistEntryMake(449, "__item replica bat-oomerang", "", ChecklistSubentryMake(pluralise(remaining, "replica bat-oomerang use", "replica bat-oomerang uses"), "", "Free instakill."), 5).ChecklistEntryTag("free instakill"));
    }
    if ($item[The Jokester's Gun].available_amount() > 0 && !get_property_boolean("_firedJokestersGun"))
    {
        int importance = 0;
        string url;
        string [int] description;
        description.listAppend("Free instakill.");
        if ($item[The Jokester's Gun].equipped_amount() == 0)
        {
            string line = "Equip it";
            if (!$item[The Jokester's Gun].can_equip())
            {
                line += ", once you can. (need 50 moxie)";
                importance = 8;
            }
            else
            {
                line += " first.";
                url = generateEquipmentLink($item[the jokester's gun]);
            }
            description.listAppend(line);
        }
        else
            description.listAppend("Fire the Jokester's Gun skill in combat.");
        resource_entries.listAppend(ChecklistEntryMake(450, "__item The Jokester's Gun", url, ChecklistSubentryMake("The Jokester's Gun firing", "", description), importance).ChecklistEntryTag("free instakill"));
    }
}

void generateMisc(Checklist [int] checklists)
{
	if (__quest_state["Level 13"].state_boolean["king waiting to be freed"])
	{
		ChecklistEntry [int] unimportant_task_entries;
		string [int] king_messages;
		king_messages.listAppend("You know, whenever.");
		king_messages.listAppend("Or become the new naughty sorceress?");
		unimportant_task_entries.listAppend(ChecklistEntryMake(101, "king imprismed", "place.php?whichplace=nstower", ChecklistSubentryMake("Free the King", "", king_messages)));
		
		checklists.listAppend(ChecklistMake("Unimportant Tasks", unimportant_task_entries));
	}
	
	if (availableDrunkenness() < 0 && ($item[drunkula's wineglass].equipped_amount() == 0 || my_adventures() == 0))
	{
        //They're drunk, so tasks aren't as relevant. Re-arrange everything:
        string url;
        
        //Give them something to mindlessly click on:
        //url = "bet.php";
       if ($coinmaster[Game Shoppe].is_accessible())
            url = "aagame.php";
        
        
		Checklist task_entries = lookupChecklist(checklists, "Tasks");
		
		lookupChecklist(checklists, "Future Tasks").entries.listAppendList(lookupChecklist(checklists, "Tasks").entries);
		lookupChecklist(checklists, "Future Tasks").entries.listAppendList(lookupChecklist(checklists, "Optional Tasks").entries);
		lookupChecklist(checklists, "Future Unimportant Tasks").entries.listAppendList(lookupChecklist(checklists, "Unimportant Tasks").entries);
		
		lookupChecklist(checklists, "Tasks").entries.listClear();
		lookupChecklist(checklists, "Optional Tasks").entries.listClear();
		lookupChecklist(checklists, "Unimportant Tasks").entries.listClear();
        
        //Remove extra-important popups, because they won't work anymore:
        Checklist future_checklist = lookupChecklist(checklists, "Future Tasks");
        foreach key, c in future_checklist.entries
        {
            if (c.only_show_as_extra_important_pop_up)
                remove future_checklist.entries[key];
        }
		
        string [int] description;
        string line = "You're drunk.";
        if (__last_adventure_location == $location[Drunken Stupor])
            url = "campground.php";
        
        if (hippy_stone_broken() && pvp_attacks_left() > 0)
            url = "peevpee.php";
            
        description.listAppend(line);
        if ($item[drunkula's wineglass].available_amount() > 0 && $item[drunkula's wineglass].can_equip() && my_adventures() > 0)
        {
            description.listAppend("Or equip your wineglass.");
        }
        
        int pvp_fights_gained = numeric_modifier("pvp fights").to_int() + 10;
        int pvp_fights_after_rollover_before_caps = pvp_attacks_left() + pvp_fights_gained;
        int pvp_fights_after_rollover = MIN(pvp_fights_after_rollover_before_caps, 100);
        if (today_is_pvp_season_end())
            pvp_fights_after_rollover = 0;
        if (true)
        {
            int adventures_after_rollover = my_adventures() + 40;
            if (my_path_id() != PATH_SLOW_AND_STEADY)
                adventures_after_rollover += numeric_modifier("adventures");
            //if (get_property_boolean("_borrowedTimeUsed"))
                //adventures_after_rollover -= 20;
            adventures_after_rollover += get_property_int("extraRolloverAdventures");
            
            if (getHolidaysTomorrow()["Labr Day"] && my_path_id() != PATH_SLOW_AND_STEADY)
                adventures_after_rollover += 10;
            
            adventures_after_rollover = clampi(adventures_after_rollover, 0, 200);
            
            string [int] all_tomorrows_parties;
            all_tomorrows_parties.listAppend(pluralise(adventures_after_rollover, "adventure", "adventures")); //it should be impossible to have under twenty adventures after rollover, but why should that stop us from checking the singular case?
            if (hippy_stone_broken() && pvp_fights_after_rollover > 0)
                all_tomorrows_parties.listAppend(pluralise(pvp_fights_after_rollover, "fight", "fights"));
            
            description.listAppend("Will start with " + all_tomorrows_parties.listJoinComponents(", ", "and") + " tomorrow.");
        }
        
        int rollover_adventures_from_equipment = 0;
        foreach s in $slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3,familiar]
            rollover_adventures_from_equipment += s.equipped_item().numeric_modifier("adventures").to_int_silent();
        
        //detect if they're going to lose some turns, be nice:
        int rollover_adventures_gained = numeric_modifier("adventures").to_int_silent() + 40;
        if (get_property_boolean("_borrowedTimeUsed"))
            rollover_adventures_gained -= 20;
        int adventures_lost = (my_adventures() + rollover_adventures_gained) - 200;
        if (rollover_adventures_from_equipment == 0.0 && adventures_lost == 0 && my_path_id() != PATH_SLOW_AND_STEADY)
        {
            description.listAppend("Possibly wear +adventures gear.");
        }
        if (adventures_lost > 0)
        {
            string [int] leisure_activities;
            leisure_activities.listAppend("work out in the gym");
            leisure_activities.listAppend("craft");
            if ($item[game grid ticket].is_unrestricted())
                leisure_activities.listAppend("play arcade games");
            description.listAppend("You'll miss out on " + pluraliseWordy(adventures_lost, "adventure", "adventures") + ". Alas.|Could " + leisure_activities.listJoinComponents(", ", "or") + ".");
        }
        
        if (hippy_stone_broken())
        {
            int pvp_fights_lost = pvp_fights_after_rollover_before_caps - pvp_fights_after_rollover;//MAX(0, pvp_fights_after_rollover_before_caps - 100);
            if (pvp_fights_lost > 0 && pvp_attacks_left() > 0)
            {
                description.listAppend("Fight " + pluralise(MIN(pvp_attacks_left(), pvp_fights_lost), "time", "times") + " to avoid losing fights to rollover.");
            }
        }
        
        //this could be better (i.e. checking against current shirt and looking in inventory, etc.)
        if (my_path_id() != PATH_SLOW_AND_STEADY)
        {
            if ($item[Sneaky Pete's leather jacket (collar popped)].equipped_amount() > 0 && adventures_lost <= 0)
                description.listAppend("Could unpop your collar. (+4 adventures)");
            if ($item[Sneaky Pete's leather jacket].equipped_amount() > 0 && hippy_stone_broken())
                description.listAppend("Could pop your collar. (+4 fights)");
            if (in_ronin() && $item[resolution: be more adventurous].available_amount() > 0 && get_property_int("_resolutionAdv") < 5)
            {
                description.listAppend("Use resolution: be more adventurous.");
            }
        }
        if (in_ronin() && pulls_remaining() > 0)
        {
            description.listAppend("Don't forget your " + pluraliseWordy(pulls_remaining(), "pull", "pulls") + ".");
        }
        //FIXME resolution be more adventurous goes here
        
		task_entries.entries.listAppend(ChecklistEntryMake(102, "__item counterclockwise watch", url, ChecklistSubentryMake("Wait for rollover", "", description), -11));
        if (stills_available() > 0 && __misc_state["in run"])
        {
            string url = "shop.php?whichshop=still";
            if ($item[soda water].available_amount() == 0)
                url = "shop.php?whichshop=generalstore";
            task_entries.entries.listAppend(ChecklistEntryMake(103, "__item tonic water", url, ChecklistSubentryMake("Make " + pluralise(stills_available(), $item[tonic water]), "", listMake("Tonic water is a ~40MP restore, improved from soda water.", "Or improve drinks.")), -11));
        }
	}
}


void generateChecklists(Checklist [int] ordered_output_checklists)
{
	setUpState();
	setUpQuestState();
	
	if (__misc_state["Example mode"])
		setUpExampleState();
	
	finaliseSetUpState();
	
	Checklist [int] checklists;
    
    ChecklistCollection checklist_collection;
    
    if (limit_mode() == "spelunky")
    {
        LimitModeSpelunkingGenerateChecklists(checklists);
    }
    else if (limit_mode() == "batman")
    {
        LimitModeBatfellowGenerateChecklists(checklists);
    }
    else if (!playerIsLoggedIn())
    {
		Checklist task_entries = lookupChecklist(checklists, "Tasks");
        
        string image_name;
        image_name = "disco bandit";
		task_entries.entries.listAppend(ChecklistEntryMake(104, image_name, "", ChecklistSubentryMake("Log in", "+internet", "An Adventurer is You!"), -11));
    }
    else if (__misc_state["In valhalla"])
    {
        //Valhalla:
		Checklist task_entries = lookupChecklist(checklists, "Tasks");
        task_entries.entries.listAppend(ChecklistEntryMake(105, "astral spirit", "", ChecklistSubentryMake("Start a new life", "", listMake("Perm skills.", "Buy consumables.", "Bring along a pet."))));
    }
    else
    {
        generateDailyResources(checklists);
        
        generateTasks(checklists);
        if (__misc_state["Example mode"] || !__misc_state["in aftercore"])
        {
            //generateMissingItems(checklists);
            generatePullList(checklists);
        }
        if (__setting_debug_show_all_internal_states && __setting_debug_mode)
        {
            generateAllTests(checklists);
        }
        generateFloristFriar(checklists);
        
        
        generateStrategy(checklists);
        
        foreach key, checklist_generation_function_name in __checklist_generation_function_names
        {
            call checklist_generation_function_name(checklist_collection);
        }
        
        foreach checklist_name in __specific_checklist_1_generation_function_names
        {
            ChecklistEntry [int] checklist_entries = checklist_collection.lookup(checklist_name).entries;
            foreach key, function_name in __specific_checklist_1_generation_function_names[checklist_name]
            {
                call function_name(checklist_entries);
            }
        }
        foreach key, request in __specific_checklist_generation_requests
        {
            int argument_count = request.checklist_names.count();
            string function_name = request.function_name;
            //"call request.function_name()" will not work
            if (argument_count == 3)
            {
                call function_name(checklist_collection.lookup(request.checklist_names[0]).entries, checklist_collection.lookup(request.checklist_names[1]).entries, checklist_collection.lookup(request.checklist_names[2]).entries);
            }
            else if (argument_count == 2)
            {
                call function_name(checklist_collection.lookup(request.checklist_names[0]).entries, checklist_collection.lookup(request.checklist_names[1]).entries);
            }
            else if (argument_count == 1)
            {
                call function_name(checklist_collection.lookup(request.checklist_names[0]).entries);
            }
        }
        foreach key, function_name in __generation_function_names
        {
        	call function_name(checklist_collection);
        }
    }
    
    
    //Convert checklist_collection to checklists:
    checklists = ChecklistCollectionMergeWithLinearList(checklist_collection, checklists);
    
    generateMisc(checklists); //Last, due to drunkenness re-arranging
	
	//Remove checklists that have no entries:
	int [int] keys_to_remove;
	foreach key in checklists
	{
		Checklist cl = checklists[key];
		if (cl.entries.count() == 0)
			keys_to_remove.listAppend(key);
	}
	listRemoveKeys(checklists, keys_to_remove);
	listClear(keys_to_remove);
	
	//Go through desired output order:
	string [int] setting_desired_output_order = split_string_alternate("Tasks,Optional Tasks,Unimportant Tasks,Future Tasks,Resources,Future Unimportant Tasks,Required Items,Suggested Pulls,Florist Friar,Strategy", ",");
	foreach key in setting_desired_output_order
	{
		string title = setting_desired_output_order[key];
		//Find title in checklists:
		foreach key2 in checklists
		{
			Checklist cl = checklists[key2];
			if (cl.title == title)
			{
				ordered_output_checklists.listAppend(cl);
				keys_to_remove.listAppend(key2);
				break;
			}
		}
	}
	listRemoveKeys(checklists, keys_to_remove);
	listClear(keys_to_remove);
	
	//Add remainder:
	foreach key in checklists
	{
		Checklist cl = checklists[key];
		ordered_output_checklists.listAppend(cl);
	}
}



void outputChecklists(Checklist [int] ordered_output_checklists)
{
    if (__misc_state["in run"] && playerIsLoggedIn())
        PageWrite(HTMLGenerateDivOfClass("Day " + my_daycount() + ". " + pluralise(my_turncount(), "turn", "turns") + " played.", "r_bold"));
	if (my_path() != "" && my_path() != "None" && playerIsLoggedIn())
	{
		PageWrite(HTMLGenerateDivOfClass(my_path(), "r_bold"));
	}
    
    
    string chosen_message = generateRandomMessage();
    if (chosen_message != "")
        PageWrite(HTMLGenerateDivOfStyle(chosen_message, "padding-left:20px;padding-right:20px;"));
    PageWrite(HTMLGenerateTagWrap("div", "", mapMake("id", "extra_words_at_top")));
    

	
	
	
	if (__misc_state["Example mode"])
	{
		PageWrite("<br>");
		PageWrite(HTMLGenerateDivOfStyle("Example ascension", "text-align:center; font-weight:bold;"));
	}
    
    Checklist extra_important_tasks;
    
	//And output:
	foreach i in ordered_output_checklists
	{
		Checklist cl = ordered_output_checklists[i];
        
        if (__show_importance_bar && cl.title == "Tasks")
        {
            foreach key in cl.entries
            {
                ChecklistEntry entry = cl.entries[key];
                if (entry.importance_level <= -11)
                {
                    extra_important_tasks.entries.listAppend(entry);
                    if (entry.only_show_as_extra_important_pop_up)
                        remove cl.entries[key];
                }
                    
            }
        }
		PageWrite(ChecklistGenerate(cl));
	}
    
    if (__show_importance_bar && extra_important_tasks.entries.count() > 0)
    {
        extra_important_tasks.title = "Tasks";
        extra_important_tasks.disable_generating_id = true;
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("id", "importance_bar", "style", "z-index:3;position:fixed; top:0;width:100%;visibility:hidden;"))); //max-width:" + __setting_horizontal_width + "px;
		PageWrite(ChecklistGenerate(extra_important_tasks, false));
        
        //string background = "background: -moz-linear-gradient(top, rgba(100,100,100,1) 0%, rgba(255,255,255,0) 100%);background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(100,100,100,1)), color-stop(100%,rgba(255,255,255,0)));background: -webkit-linear-gradient(top, rgba(100,100,100,1) 0%,rgba(255,255,255,0) 100%);background: -o-linear-gradient(top, rgba(100,100,100,1) 0%,rgba(255,255,255,0) 100%);background: -ms-linear-gradient(top, rgba(100,100,100,1) 0%,rgba(255,255,255,0) 100%);background: linear-gradient(to bottom, rgba(100,100,100,1) 0%,rgba(255,255,255,0) 100%);filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#646464', endColorstr='#00ffffff',GradientType=0 );"; //this looks correct in safari, but not others
        string background = "background-image:url(" + __importance_bar_gradient + ");background-repeat:repeat-x;"; //use this gradient image, because alpha gradients are not consistent across browsers (compare black to white, 100% to zero opacity, on safari versus firefox)

        PageWrite(HTMLGenerateTagWrap("div", "", mapMake("id", "importance_bar_gradient", "style", "height:20px;transition:opacity 0.25s;opacity:0;" + background)));
        PageWrite(HTMLGenerateTagSuffix("div"));
        
    }
}





Record BadMoonAdventure
{
    int encounter_id;
    string category;
    string description;
    string conditions_to_finish;
    boolean has_additional_requirements_not_yet_met;
    location [int] locations;
};

BadMoonAdventure BadMoonAdventureMake(int encounter_id, location [int] locations, string category, string description, string conditions_to_finish, boolean has_additional_requirements_not_yet_met)
{
    BadMoonAdventure adventure;
    adventure.encounter_id = encounter_id;
    adventure.category = category;
    adventure.description = description;
    adventure.conditions_to_finish = conditions_to_finish;
    adventure.has_additional_requirements_not_yet_met = has_additional_requirements_not_yet_met;
    adventure.locations = locations;
    return adventure;
}

BadMoonAdventure BadMoonAdventureMake(int encounter_id, location l, string category, string description, string conditions_to_finish, boolean has_additional_requirements_not_yet_met)
{
    location [int] locations;
    locations.listAppend(l);
    return BadMoonAdventureMake(encounter_id, locations, category, description, conditions_to_finish, has_additional_requirements_not_yet_met);
}

void listAppend(BadMoonAdventure [int] list, BadMoonAdventure entry)
{
    int position = list.count();
    while (list contains position)
        position += 1;
    list[position] = entry;
}


/*
Categories:
DAMAGE1
DAMAGE2
ELEMENTALDAMAGE1 - +10 elemental damage, -2 DR
ELEMENTALDAMAGE2 - +20 elemental damage, -2 DR
DAMAGE_REDUCTION - +DR, -8 weapon damage
Familiar Hatchlings -
ITEM_DROP
ITEMS
meat
MEAT_DROP
RESIST1
RESIST2
SKILLS
STAT1 - +20 one stat, -5 two other stats
STAT2 - +40 one stat, -50% familiar weight
STAT3 - +50% one stat, -50% other stat
*/
static
{
    BadMoonAdventure [int] __static_bad_moon_adventures;
    BadMoonAdventure [location] __static_bad_moon_adventures_by_location;
    void initialiseStaticBadMoonAdventures()
    {
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(2, $location[The Haunted Pantry], "STAT1", "+20 myst, -5 muscle/moxie", "", false)); //FIXME is there a conditional on this?
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(3, $location[The Sleazy Back Alley], "STAT1", "+20 moxie, -5 myst/muscle", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(4, $location[Cobb's Knob Treasury], "STAT2", "+40 muscle, -50% familiar weight", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(5, $location[Cobb's Knob Kitchens], "STAT2", "+40 myst, -50% familiar weight", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(6, $location[Cobb's Knob Harem], "STAT2", "+40 moxie, -50% familiar weight", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(7, $location[Frat House], "STAT3", "+50% muscle, -50% myst", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(8, $location[Frat House In Disguise], "STAT3", "+50% muscle, -50% moxie", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(9, $location[Hippy Camp], "STAT3", "+50% myst, -50% moxie", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(10, $location[Hippy Camp In Disguise], "STAT3", "+50% myst, -50% muscle", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(11, $location[The Obligatory Pirate's Cove], "STAT3", "+50% moxie, -50% muscle", "", false));
        //12 is gone?
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(15, $location[The Haunted Kitchen], "ELEMENTALDAMAGE1", "+10 " + HTMLGenerateElementSpanDesaturated($element[hot]) + " damage, -2 DR", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(17, $location[The Haunted Library], "ELEMENTALDAMAGE1", "+10 " + HTMLGenerateElementSpanDesaturated($element[spooky]) + " damage, -2 DR", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(18, $location[Guano Junction], "ELEMENTALDAMAGE1", "+10 " + HTMLGenerateElementSpanDesaturated($element[stench]) + " damage, -2 DR", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(20, $location[The Icy Peak], "ELEMENTALDAMAGE2", "+20 " + HTMLGenerateElementSpanDesaturated($element[cold]) + " damage, ~2 HP lost/round", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(28, $location[Tower Ruins], "RESIST1", "+2 " + HTMLGenerateElementSpanDesaturated($element[spooky], "res") + ", 2x damage from stench/hot", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(32, $location[Cobb's Knob Laboratory], "ITEM_DROP", "+50% item, -5 stats/fight", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(33, $location[The Haunted Bathroom], "ITEM_DROP", "+100% item, -20 all stats", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(34, $location[The Unquiet Garves], "MEAT_DROP", "+50% meat, -50% init", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(35, $location[The VERY Unquiet Garves], "MEAT_DROP", "+200% meat, -50% item", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(38, $location[the spooky forest], "meat", "1000 meat", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(41, $location[south of the border], "meat", "4000 meat, beaten up", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(43, $location[Noob Cave], "Familiar Hatchlings", "Black cat hatchling, 14 drunkenness", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(46, $location[A Barroom Brawl], "Familiar Hatchlings", "Leprechaun hatchling, one drunkenness", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(47, $location[The Hidden Temple], "ITEMS", "Loaded dice", "", false));
        __static_bad_moon_adventures.listAppend(BadMoonAdventureMake(48, $location[The Haunted Conservatory], "Familiar Hatchlings", "Potato sprout", "", false));
    }
    initialiseStaticBadMoonAdventures();
}

//FIXME make this work in scripts that aren't guide
//We should probably have an "invalidate caches" message that happens whenever state may have changed.
//Maybe a global variable in the library that's incremented by one, and caches check themselves against that.
//Querying that variable would be through a function, so it automatically increments by one if the turncount changes.

BadMoonAdventure [int] __all_bad_moon_adventures_cache;
int __all_bad_moon_adventures_cache_on_turn = -1;
BadMoonAdventure [int] AllBadMoonAdventures()
{
    if (__all_bad_moon_adventures_cache.count() > 0 && __all_bad_moon_adventures_cache_on_turn == my_turncount())
        return __all_bad_moon_adventures_cache;
    BadMoonAdventure [int] adventures;
    
    foreach key, adventure in __static_bad_moon_adventures
    {
        adventures.listAppend(adventure);
    }
        
    adventures.listAppend(BadMoonAdventureMake(39, $location[the degrassi knoll garage], "meat", "2000 meat, -myst debuff", "finish meatcar guild quest", !QuestState("questG01Meatcar").finished));
    adventures.listAppend(BadMoonAdventureMake(40, $location[the bat hole entrance], "meat", "3000 meat, -moxie debuff", "open boss bat's lair", __quest_state["Level 4"].state_int["areas unlocked"] < 3));
    
    adventures.listAppend(BadMoonAdventureMake(1, $location[the Outskirts of Cobb's Knob], "STAT1", "+20 muscle, -5 myst/moxie", "find encryption key", $item[knob goblin encryption key].available_amount() == 0 && !$location[cobb's knob kitchens].locationAvailable()));
    adventures.listAppend(BadMoonAdventureMake(13, $location[The Haunted Billiards Room], "DAMAGE1", "+10 damage, -2 DR", "open the Haunted Library", !$location[the haunted library].locationAvailable()));
    adventures.listAppend(BadMoonAdventureMake(14, $location[The Goatlet], "ELEMENTALDAMAGE1", "+10 " + HTMLGenerateElementSpanDesaturated($element[cold]) + " damage, -2 DR", "unlock the eXtreme Slope", !$location[the extreme slope].locationAvailable()));
    //adventures.listAppend(BadMoonAdventureMake(19, $location[The Castle in the Clouds in the Sky (somewhere)], "DAMAGE2", "+20 melee damage, ~2 HP lost/round", "completed trash quest", REPLACEMEB)); //FIXME investigate this
    //adventures.listAppend(BadMoonAdventureMake(21, $location[Oasis], "ELEMENTALDAMAGE2", "+20 " + HTMLGenerateElementSpanDesaturated($element[hot]) + " damage, ~2 HP lost/round", "find worm-riding hooks", REPLACEMEB)); //??
    adventures.listAppend(BadMoonAdventureMake(22, $location[The Hole in the Sky], "ELEMENTALDAMAGE2", "+20 " + HTMLGenerateElementSpanDesaturated($element[sleaze]) + " damage, ~2 HP lost/round", "make Richard's star key", $item[richard's star key].available_amount() == 0));
    adventures.listAppend(BadMoonAdventureMake(23, $location[The Haunted Ballroom], "ELEMENTALDAMAGE2", "+20 " + HTMLGenerateElementSpanDesaturated($element[spooky]) + " damage, ~2 HP lost/round", "open Spookyraven basement", !$location[the haunted wine cellar].locationAvailable()));
    adventures.listAppend(BadMoonAdventureMake(24, $location[The Black Forest], "ELEMENTALDAMAGE2", "+20 " + HTMLGenerateElementSpanDesaturated($element[stench]) + " damage, ~2 HP lost/round", "open black market", !black_market_available()));
    adventures.listAppend(BadMoonAdventureMake(25, $location[Inside the Palindome], "RESIST1", "+2 " + HTMLGenerateElementSpanDesaturated($element[cold], "res") + ", 2x damage from hot/spooky", "defeat Dr. Awkward", !QuestState("questL11Palindome").finished));
    //adventures.listAppend(BadMoonAdventureMake(26, $location[REPLACEME], "RESIST1", "+2 " + HTMLGenerateElementSpanDesaturated($element[hot], "res") + ", 2x damage from stench/sleaze", "REASONWHYNOTREPLACEME", REPLACEMEB)); //Pot-Unlucky - UNKNOWN
    adventures.listAppend(BadMoonAdventureMake(27, $location[The Valley of Rof L'm Fao], "RESIST1", "+2 " + HTMLGenerateElementSpanDesaturated($element[sleaze], "res") + ", 2x damage from cold/spooky", "acquire facsimile dictionary", $item[facsimile dictionary].available_amount() == 0));
    adventures.listAppend(BadMoonAdventureMake(29, $location[The Arid, Extra-Dry Desert], "RESIST1", "+2 " + HTMLGenerateElementSpanDesaturated($element[stench], "res") + ", 2x damage from cold/sleaze", "need to have ultrahydrated", $effect[ultrahydrated].have_effect() > 0));
    adventures.listAppend(BadMoonAdventureMake(30, $location[the Beanbat Chamber], "RESIST2", "+1 all res, -10% stats", "plant beanstalk", !__quest_state["Level 10"].state_boolean["beanstalk grown"]));
    adventures.listAppend(BadMoonAdventureMake(31, $location[The Haunted Wine Cellar], "RESIST2", "+2 all res, -20% stats", "defeat Lord Spookyraven", !__quest_state["Level 11 Manor"].finished));
    adventures.listAppend(BadMoonAdventureMake(36, $location[8-bit realm], "DAMAGE_REDUCTION", "+4 DR, -8 damage", "acquire digital key", $item[digital key].available_amount() == 0));
    adventures.listAppend(BadMoonAdventureMake(37, $location[The Penultimate Fantasy Airship], "DAMAGE_REDUCTION", "+8 DR, -8 damage", "unlock castle", $item[s.o.c.k.].available_amount() == 0));
    QuestState white_citadel_quest = QuestState("questG02Whitecastle");
    adventures.listAppend(BadMoonAdventureMake(42, $location[whitey's grove], "meat", "5000 meat, -20% stats debuff", "finish white citadel quest? (this needs spading)", !(!white_citadel_quest.started || white_citadel_quest.finished)));
    //adventures.listAppend(BadMoonAdventureMake(45, $location[The Arid, Extra-Dry Desert], "ITEMS", "anticheese", "need to not have ultrahydrated", $effect[ultrahydrated].have_effect() == 0)); //is this still here?
    
    adventures.listAppend(BadMoonAdventureMake(44, $location[the spooky forest], "SKILLS", "Torso Awareness, -50% muscle debuff", "unlock hidden temple", !get_property_ascension("lastTempleUnlock")));
    
    __all_bad_moon_adventures_cache = adventures;
    __all_bad_moon_adventures_cache_on_turn = my_turncount();
    
    return adventures;
}
BadMoonAdventure [string][int] AllBadMoonAdventuresByCategory()
{
    BadMoonAdventure [string][int] result;
    foreach key, adventure in AllBadMoonAdventures()
    {
        if (!(result contains adventure.category))
        {
            BadMoonAdventure [int] blank;
            result[adventure.category] = blank;
        }
        result[adventure.category].listAppend(adventure);
    }
    return result;
}

BadMoonAdventure [int] BadMoonAdventuresForLocation(location l)
{
    BadMoonAdventure [int] result;
    foreach key, adventure in AllBadMoonAdventures()
    {
        foreach key, l2 in adventure.locations
        {
            if (l == l2)
            {
                result.listAppend(adventure);
                break;
            }
        }
    }
    return result;
}

RegisterTaskGenerationFunction("PathBadMoonGenerateTasks");
void PathBadMoonGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!in_bad_moon())
        return;
    if (my_turncount() == 0 && !haveSeenBadMoonEncounter(43) && $item[black kitten].available_amount() == 0 && !$familiar[black cat].have_familiar())
    {
        string [int] description;
        description.listAppend("For a black cat run. So cute!");
        description.listAppend("Adventure in the noob cave " + HTMLGenerateSpanFont("once", "red") + ".");
        description.listAppend(HTMLGenerateSpanFont("Will cost 14 drunkenness.", "red"));
        optional_task_entries.listAppend(ChecklistEntryMake(162, "__familiar black cat", "", ChecklistSubentryMake("Possibly adopt a black kitten", "", description)));
    }
    
    //Finding familiars - +item, +meat, +stats
    
    if (my_familiar() != $familiar[black cat])
    {
        if (!$familiar[blood-faced volleyball].have_familiar() && !$familiar[smiling rat].have_familiar())
        {
            string [int] description;
            string url;
            
            string [int] tasks;
            if ($item[blood-faced volleyball].available_amount() > 0)
            {
                tasks.listAppend("use blood-faced volleyball");
                url = "inventory.php?which=3";
            }
            else
            {
                int trinkets_needed = 0;
                if ($item[volleyball].available_amount() == 0)
                {
                    string line = "collect a volleyball";
                    if ($effect[bloody hand].have_effect() == 0 && $item[seal tooth].available_amount() == 0)
                    {
                        line += " and seal tooth";
                        trinkets_needed += 1;
                    }
                    line += " from the hermit";
                    tasks.listAppend(line);
                    url = "hermit.php";
                    trinkets_needed += 1;
                }
                if ($effect[bloody hand].have_effect() == 0)
                {
                    if ($item[seal tooth].available_amount() == 0 && $item[volleyball].available_amount() > 0)
                    {
                        tasks.listAppend("collect a seal tooth from the hermit");
                        url = "hermit.php";
                        trinkets_needed += 1;
                    }
                    tasks.listAppend("use seal tooth to acquire a bloody hand (ow!)");
                    if (url != "" && $item[seal tooth].available_amount() > 0)
                        url = "inventory.php?which=3";
                }
                int trinkets_missing = MAX(0, trinkets_needed - $items[worthless trinket,worthless gewgaw,worthless knick-knack].available_amount());
                if (trinkets_missing > 0)
                {
                    tasks.listPrepend("collect " + pluralise(trinkets_missing, $item[worthless trinket]) + " (use chewing gum)");
                    if ($item[chewing gum on a string].available_amount() == 0)
                        url = "shop.php?whichshop=generalstore";
                    else
                        url = "inventory.php?which=3";
                    if ($item[hermit permit].available_amount() == 0)
                    {
                        tasks.listPrepend("buy hermit permit");
                        url = "shop.php?whichshop=generalstore";
                    }
                }
                
                tasks.listAppend("use volleyball");
                if (url != "" && $item[volleyball].available_amount() > 0 && $effect[bloody hand].have_effect() > 0)
                    url = "inventory.php?which=3";
                        
                tasks.listAppend("use blood-faced volleyball");
            }
            description.listAppend(tasks.listJoinComponents(", ").capitaliseFirstLetter() + ".");
            optional_task_entries.listAppend(ChecklistEntryMake(163, "__familiar blood-faced volleyball", url, ChecklistSubentryMake("Adopt a blood-faced volleyball", "", description)));
        }
        if (!$familiar[Leprechaun].have_familiar())
        {
            string [int] description;
            string url;
            if ($item[leprechaun hatchling].available_amount() > 0)
            {
                description.listAppend("Use a leprechaun hatchling.");
                url = "inventory.php?which=3";
            }
            else if (!haveSeenBadMoonEncounter(46) && $location[a barroom brawl].locationAvailable())
            {
                description.listAppend("Find in a barroom brawl.");
                url = $location[a barroom brawl].getClickableURLForLocation();
            }
            if (description.count() > 0)
                optional_task_entries.listAppend(ChecklistEntryMake(164, "__familiar Leprechaun", url, ChecklistSubentryMake("Adopt a leprechaun", "", description), $locations[a barroom brawl]));
        }
        if (!$familiar[baby gravy fairy].have_familiar())
        {
            string [int] description;
            string [int] modifiers;
            string url;
            
            if ($item[pregnant mushroom].available_amount() > 0)
            {
                description.listAppend("Use a pregnant mushroom.");
                url = "inventory.php?which=3";
            }
            else if ($item[pregnant mushroom].creatable_amount() > 0)
            {
                description.listAppend("Create and use a pregnant mushroom.");
                url = "craft.php?mode=cook";
            }
            else
            {
                boolean need_minus_combat = false;
                if ($item[fairy gravy boat].available_amount() == 0)
                {
                    need_minus_combat = true;
                    description.listAppend("Adventure in the Haiku Dungeon for a fairy gravy boat.|Second choice in the NC.");
                    url = $location[the haiku dungeon].getClickableURLForLocation();
                }
                if ($item[Knob mushroom].available_amount() == 0)
                {
                    need_minus_combat = true;
                    description.listAppend("Find a knob mushroom somewhere.|Probably the haiku dungeon. First choice in the NC.|The cobb's knob kitchens are also an option. (?)");
                    url = $location[the haiku dungeon].getClickableURLForLocation();
                }
                if (need_minus_combat)
                    modifiers.listAppend("-combat");
            }
            
            optional_task_entries.listAppend(ChecklistEntryMake(165, "__familiar baby gravy fairy", url, ChecklistSubentryMake("Adopt a baby gravy fairy", modifiers, description)));
        }
        if (!$familiar[cocoabo].have_familiar() && $item[cocoa egg].available_amount() + $item[cocoa egg].creatable_amount() > 0)
        {
            //thanks harumph
            string [int] description;
            string url;
            if ($item[cocoa egg].available_amount() == 0)
            {
                description.listAppend("Cook two cocoa eggshell fragments together twice, then cook two large cocoa eggshell fragments together.|Then use the cocoa egg.");
                url = "craft.php?mode=cook";
            }
            else
            {
                description.listAppend("Use a cocoa egg.");
                //url = "inventory.php?which=3";
            }
            optional_task_entries.listAppend(ChecklistEntryMake(166, "__familiar cocoabo", url, ChecklistSubentryMake("Adopt a cocoabo", "", description)));
            
        }
    }
    //FIXME do we want the init semi-rare potion? it's only +100%... but, that might save a lot of turns?
}

RegisterResourceGenerationFunction("PathBadMoonGenerateResource");
void PathBadMoonGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!in_bad_moon())
        return;
    
    if (in_bad_moon() && !get_property_boolean("styxPixieVisited"))
    {
        string [int] description;
        description.listAppend("Rubdown: +25% muscle, +5 DR, +10 damage.");
        description.listAppend("Mind: +25% mysticality, +10-15 mp regen, +15 spell damage.");
        description.listAppend("Colonge: +20% items, +25% moxie, +40% meat.");
		resource_entries.listAppend(ChecklistEntryMake(167, "__effect Hella Smooth", "heydeze.php?place=styx", ChecklistSubentryMake("Styx pixie buff", "", description), 10));
    }
    
    if ($item[ghost key].available_amount() > 0 && __misc_state["in run"])
    {
        string url = "";
        if ($location[the haunted bedroom].locationAvailable())
            url = $location[the haunted bedroom].getClickableURLForLocation();
        
        string [int] description;
        
        if (__misc_state["need to level"])
        {
            string target_nightstand = "";
            if (my_primestat() == $stat[muscle])
                target_nightstand = "simple";
            else if (my_primestat() == $stat[mysticality])
                target_nightstand = "ornate";
            else if (my_primestat() == $stat[moxie])
                target_nightstand = "rustic";
            description.listAppend("? mainstat from a " + target_nightstand + " nightstand."); //wiki says 200, but I saw 87 at level nine in bad moon
        }
        description.listAppend("1000 meat from a mahogany nightstand.");
		resource_entries.listAppend(ChecklistEntryMake(168, "__item ghost key", url, ChecklistSubentryMake(pluralise($item[ghost key]), "", description), 10));
        
    }
}

void PathBadMoonGenerateCategoryChecklistEntry(BadMoonAdventure [string][int] adventures_by_category, ChecklistEntry [int] bad_moon_adventures_entries, string [int] categories, string image_name, string header, string [int] initial_d_escription)
{
    string [int][int] description_active;
    string [int][int] description_inactive;
    
    string url;
    boolean [location] relevant_locations;
    foreach key1, category in categories
    {
        foreach key2, adventure in adventures_by_category[category]
        {
            if (haveSeenBadMoonEncounter(adventure.encounter_id))
                continue;
                
            string [int] line;
            line.listAppend(adventure.locations.listJoinComponents(" / "));
            
            string line2 = adventure.description;
            
            
            boolean greyed_out = false;
            if (adventure.has_additional_requirements_not_yet_met)
            {
                line2 += ".|Need to " + adventure.conditions_to_finish + ".";
                //line = HTMLGenerateSpanFont(line, "grey");
                greyed_out = true;
            }
            else
                line2 += ".";
            line.listAppend(line2);
            
            if (!greyed_out)
            {
                boolean have_open_location = false;
                foreach key, l in adventure.locations
                {
                    if (l.locationAvailable())
                    {
                        if (url == "")
                            url = l.getClickableURLForLocation();
                        have_open_location = true;
                    }
                    /*if (__setting_debug_mode)
                    {
                        Error unable_to_find_location;
                        l.locationAvailable(unable_to_find_location);
                        if (unable_to_find_location.was_error)
                            print_html("\"" + l + "\" unknown to locationAvailable");
                        
                    }*/
                }
                if (!have_open_location)
                {
                    //line = HTMLGenerateSpanFont(line, "grey");
                    greyed_out = true;
                }
            }
            
            if (greyed_out)
            {
                foreach key, value in line
                {
                    line[key] = HTMLGenerateSpanFont(value, "grey");
                }
                description_inactive.listAppend(line);
            }
            else
            {
                foreach key, l in adventure.locations
                    relevant_locations[l] = true;
                description_active.listAppend(line);
            }
        }
    }
    string [int] description;
    
    description.listAppendList(initial_d_escription); //deja vu!
    foreach key in description_inactive
    {
        description_active.listAppend(description_inactive[key]);
    }
    if (description_active.count() + description.count() > 0)
    {
        description.listAppend(HTMLGenerateSimpleTableLines(description_active));
        bad_moon_adventures_entries.listAppend(ChecklistEntryMake(169, image_name, url, ChecklistSubentryMake(header, "", description), relevant_locations));
    }
}

void PathBadMoonGenerateCategoryChecklistEntry(BadMoonAdventure [string][int] adventures_by_category, ChecklistEntry [int] bad_moon_adventures_entries, string [int] categories, string image_name, string header)
{
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, categories, image_name, header, listMakeBlankString());
}

RegisterChecklistGenerationFunction("PathBadMoonGenerateChecklists");
void PathBadMoonGenerateChecklists(ChecklistCollection checklist_collection)
{
    if (!in_bad_moon())
        return;
    
    ChecklistEntry [int] bad_moon_adventures_entries = checklist_collection.lookup("Bad Moon Adventures").entries;
    
    
    //badMoonEncounter01 to badMoonEncounter48
    //umm... that's a lot...
    //each area has up to one encounter, but many areas may have the same encounter (frat house/hippy camp)
    
    /*
    They're all classified under different areas, though.
    
    Things to mention:
    lots of meat, -something
    +X% item, -something
    +X% meat, -something
    +2 elemental resistance, 2x damage from two other elements
    +resistance all elements, all attributes -%
    +20 mainstat, -5 other stats
    +40 mainstat, -50% familiar weight (black cat!)
    items, -something (black kitten and terrarium, Torso Awareness, anticheese (irrelevant), leprechaun, loaded dice (irrelevant), potato sprout (irrelevant?)
    
    Maybe:
    +50% stat, -50% other stat
    +20 elemental damage, -~2 damage/round (g-g-g-ghosts!)
    +10 elemental damage, -2 DR (g-g-g-ghosts!)
    
    ???:
    +DR, -8 weapon damage
    */
    
    BadMoonAdventure [string][int] adventures_by_category = AllBadMoonAdventuresByCategory();
    
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("meat"), "__item dense meat stack", "Meat");
    if (my_familiar() != $familiar[black cat])
        PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("Familiar hatchlings"), "__item Familiar-Gro&trade; Terrarium", "Familiar hatchlings");
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("ITEM_DROP"), "__item Mr. Cheeng's spectacles", "Item buffs");
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("MEAT_DROP"), "__item old leather wallet", "Meat buffs");
    
    string [int] elemental_damage_ordering = listMake("ELEMENTALDAMAGE1", "ELEMENTALDAMAGE2");
    if (my_level() >= 10)
        elemental_damage_ordering = listMake("ELEMENTALDAMAGE2", "ELEMENTALDAMAGE1"); //don't encourage the +20 buffs until later
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("RESIST1", "RESIST2"), "__item yak anorak", "Elemental resist buffs");
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, listMake("STAT2", "STAT1", "STAT3"), "__effect Phorcefullness", "Stat buffs");
    PathBadMoonGenerateCategoryChecklistEntry(adventures_by_category, bad_moon_adventures_entries, elemental_damage_ordering, "__item oversized snowflake", "Elemental damage buffs", listMake("For defeating ghosts."));
    
    if (!lookupSkill("Torso Awareness").have_skill() && !haveSeenBadMoonEncounter(44) && $location[the hidden temple].locationAvailable())
    {
        string [int] description;
        description.listAppend("Spooky forest.");
        
        if ($item[grue egg omelette].available_amount() == 0 && $item[spooky mushroom].available_amount() == 0 && ($item[strange leaflet].available_amount() == 0 || $item[grue egg].available_amount() == 0))
        {
            description.listAppend("Farm a spooky mushroom (for grue omelette) while you're there: " + listMake("Explore the stream", "March to the marsh").listJoinComponents(__html_right_arrow_character));
        }
        else
            description.listAppend("Farm spices (for spicy burritos) while you're there: " + listMake("Brave the dark thicket", "Follow the even darker path", "Take the scorched path", "Investigate the moist crater").listJoinComponents(__html_right_arrow_character));
        
        bad_moon_adventures_entries.listAppend(ChecklistEntryMake(170, "__item &quot;Humorous&quot; T-shirt", $location[the spooky forest].getClickableURLForLocation(), ChecklistSubentryMake("Torso Awareness", "", description), $locations[the spooky forest]));
    }
    
    /*
    FIXME
    "Tower Ruins" unknown to locationAvailable
    "Frat House" unknown to locationAvailable
    "Frat House In Disguise" unknown to locationAvailable
    "Hippy Camp" unknown to locationAvailable
    "Hippy Camp In Disguise" unknown to locationAvailable
    */
}

Record LBPItemInformation
{
    string image_url;
    boolean should_display_drop_current;
    string item_drop_current_information;
    string item_name;
    boolean should_display_drop_base;
    string item_drop_base_information;
    string [int] tags;
    boolean greyed_out;
};

void listAppend(LBPItemInformation [int] list, LBPItemInformation entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

buffer createItemInformationTableMethod2(int columns, LBPItemInformation [int] items_presenting, boolean want_item_minimal_display, string table_class, string table_style)
{
    buffer output_buffer;

    string [string] table_map;
    table_map = mapMake("style", "display:table;");
    if (table_style != "")
        table_map["style"] += table_style;
    if (table_class != "")
        table_map["class"] = table_class;
    output_buffer.HTMLAppendTagPrefix("div", table_map);
    
    
    foreach key, info in items_presenting
    {
        if (key % columns == 0)
        {
            if (key != 0)
            {
                output_buffer.append("</div>");
            }
            output_buffer.HTMLAppendTagPrefix("div", "style", "display:table-row;");
        }
        int image_size = 30;
        if (want_item_minimal_display)
            image_size = 15;
        
        //hack?
        float percentage = 33;
        if (columns == 2)
            percentage = 50;
        if (columns == 1)
            percentage = 100;
        
        
        int [int] image_sizes;
        string [int] image_classes;
        
        image_classes.listAppend("r_only_display_if_not_tiny"); // r_only_display_if_not_small");
        image_sizes.listAppend(image_size);
        
        //image_classes.listAppend("r_only_display_if_small");
        //image_sizes.listAppend(MIN(image_size, 20));
        
        string image_url = info.image_url;
        if (image_url.length() == 0)
        {
            image_url = "images/itemimages/confused.gif";
        }
        
        foreach key in image_sizes
        {
            int using_size = image_sizes[key];
            string image_class = image_classes[key];
            output_buffer.HTMLAppendTagPrefix("div", mapMake("style", "display:table-cell;max-width:" + using_size + ";max-height:" + using_size + ";min-width:" + using_size + ";min-height:" + using_size + ";padding-left:3px;padding-right:3px;vertical-align:middle;", "class", image_class));
            
            //Generate image:
            string [string] image_map = mapMake("src", image_url, "width", using_size, "height", using_size);
            
            image_map["style"] += "display:block;"; //removes implicit pixels around image
            if (info.greyed_out)
                image_map["style"] += "opacity:0.5;";
            image_map["alt"] = info.item_name;
            output_buffer.HTMLAppendTagPrefix("img", image_map);
            output_buffer.append("</div>");
        }
        
        
        string main_tag_style = "display:table-cell;width:" + percentage + "%;vertical-align:middle;";
        if (info.greyed_out)
            main_tag_style += "color:gray;";
        if (want_item_minimal_display)
            main_tag_style += "font-size:0.9em;";
        output_buffer.HTMLAppendTagPrefix("div", "style", main_tag_style);
        if (want_item_minimal_display)
            output_buffer.HTMLAppendTagPrefix("span", "class", "r_location_bar_background_blur_small");
        else
            output_buffer.HTMLAppendTagPrefix("span", "class", "r_location_bar_background_blur");
        
        if (info.should_display_drop_current)
        {
            output_buffer.append(info.item_drop_current_information);
            output_buffer.append(" ");
        }
        output_buffer.append(info.item_name);
        
        string [int] secondary_line;
        if (info.should_display_drop_base)
            secondary_line.listAppend(info.item_drop_base_information);
        if (info.tags.count() > 0)
            secondary_line.listAppendList(info.tags);
        
        if (secondary_line.count() > 0)
        {
            string [string] tag_map = mapMake("class", "r_cl_modifier_inline");
            if (info.greyed_out)
                tag_map["style"] += "color:gray;";
            string wrap_type = "span"; //"div";
            if (want_item_minimal_display)
                wrap_type = "span";
            else
                tag_map["style"] += "display:block;";
            
            output_buffer.HTMLAppendTagPrefix(wrap_type, tag_map);
            if (!want_item_minimal_display)
                output_buffer.HTMLAppendTagPrefix("span", "class", "r_location_bar_background_blur");
            if (want_item_minimal_display)
                output_buffer.append(" (");
            output_buffer.append(secondary_line.listJoinComponents(", "));
            if (want_item_minimal_display)
                output_buffer.append(")");
            if (!want_item_minimal_display)
                output_buffer.append("</span>");
            output_buffer.HTMLAppendTagSuffix(wrap_type);
        }
        
        output_buffer.append("</span>");
        output_buffer.append("</div>");
    }
    output_buffer.append("</div>"); //row
    output_buffer.append("</div>"); //table
    return output_buffer;
}


buffer generateItemInformationMethod2(location l, monster m, boolean try_for_minimal_display, boolean [monster] monsters_to_display_items_minimally)
{
    int number_of_slimeling_eligible_items = 0;
    foreach key, r in m.item_drops_array()
    {
        if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains r.drop.to_slot())
            number_of_slimeling_eligible_items += 1;
    }
    
    
    LBPItemInformation [int] items_presenting;
    
    foreach key, r in m.item_drops_array()
    {
        item it = r.drop;
        int base_drop_rate = r.rate;
        
        
        
        int adjusted_base_drop_rate = base_drop_rate;
        boolean drop_rate_is_actually_zero = false;
        boolean drop_rate_is_guess = false;
        
        //r-type?
        boolean item_is_conditional = r.type.contains_text("c");
        boolean item_is_stealable_accordion = r.type.contains_text("a");
        boolean item_is_pickpockable_only = r.type.contains_text("p");
        boolean item_cannot_be_pickpocketed = r.type.contains_text("n"); //FIXME use this for anything?
        boolean item_rate_is_fixed = r.type.contains_text("f");
        boolean item_is_avatar_potion = r.drop.item_type() == "avatar potion"; //r.drop.to_effect().string_modifier("Avatar") != "";
        boolean grey_out_item = false;
        if (item_is_stealable_accordion && my_class() != $class[accordion thief])
        {
            grey_out_item = true;
            adjusted_base_drop_rate = 0;
            drop_rate_is_actually_zero = true;
        }
        if (item_is_pickpockable_only && !__misc_state["can pickpocket"])
        {
            grey_out_item = true;
            adjusted_base_drop_rate = 0;
            drop_rate_is_actually_zero = true;
        }
        if (it == $item[reflection of a map] && get_property_int("pendingMapReflections") == 0)
        {
            grey_out_item = true;
            adjusted_base_drop_rate = 0;
            drop_rate_is_actually_zero = true;
        }
        if (($items[folder (red),folder (blue),folder (green),folder (magenta),folder (cyan),folder (yellow),folder (smiley face),folder (wizard),folder (space skeleton),folder (D-Team),folder (Ex-Files),folder (skull and crossbones),folder (Knight Writer),folder (Jackass Plumber),folder (holographic fractal),folder (barbarian),folder (rainbow unicorn),folder (Seawolf),folder (dancing dolphins),folder (catfish),folder (tranquil landscape),folder (owl),folder (Stinky Trash Kid),folder (sports car),folder (sportsballs),folder (heavy metal),folder (Yedi),folder (KOLHS)] contains it))
        {
            if (base_drop_rate <= 0)
            {
                base_drop_rate = 5; //assumed
                adjusted_base_drop_rate = base_drop_rate; //assumed
                drop_rate_is_guess = true;
            }
            if ($item[over-the-shoulder folder holder].equipped_amount() == 0)
            {
                grey_out_item = true;
                adjusted_base_drop_rate = 0;
                drop_rate_is_actually_zero = true;
                drop_rate_is_guess = false;
            }
        }
        
        string [int] item_drop_modifiers_to_display;
        boolean yes_it_is_actually_zero = false;
        if (adjusted_base_drop_rate > 0 && adjusted_base_drop_rate < 100)
        {

            float effective_drop_rate = adjusted_base_drop_rate;
            float item_modifier = l.item_drop_modifier_for_location();
            if (it.fullness > 0 || (__items_that_craft_food contains it))
            {
                item_modifier += numeric_modifier("Food Drop");
                item_drop_modifiers_to_display.listAppend("+food");
            }
            if (it.inebriety > 0)
            {
                item_modifier += numeric_modifier("Booze Drop");
                item_drop_modifiers_to_display.listAppend("+booze");
            }
            if (it.to_slot() == $slot[hat])
            {
                item_modifier += numeric_modifier("Hat Drop");
                item_drop_modifiers_to_display.listAppend("+hat");
            }
            if (it.to_slot() == $slot[weapon])
            {
                item_modifier += numeric_modifier("Weapon Drop");
                item_drop_modifiers_to_display.listAppend("+weapon");
            }
            if (it.to_slot() == $slot[off-hand])
            {
                item_modifier += numeric_modifier("Offhand Drop");
                item_drop_modifiers_to_display.listAppend("+offhand");
            }
            if (it.to_slot() == $slot[shirt])
            {
                item_modifier += numeric_modifier("Shirt Drop");
                item_drop_modifiers_to_display.listAppend("+shirt");
            }
            if (it.to_slot() == $slot[pants])
            {
                item_modifier += numeric_modifier("Pants Drop");
                item_drop_modifiers_to_display.listAppend("+pants");
            }
            if ($slots[acc1,acc2,acc3] contains it.to_slot())
            {
                item_modifier += numeric_modifier("Accessory Drop");
                item_drop_modifiers_to_display.listAppend("+accessory");
            }
            if (it.candy)
            {
                item_modifier += numeric_modifier("Candy Drop");
                item_drop_modifiers_to_display.listAppend("+candy");
            }
            if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains it.to_slot()) //assuming familiar equipment isn't "gear"
            {
                item_modifier += numeric_modifier("Gear Drop");
                item_drop_modifiers_to_display.listAppend("+gear");
            }
            if (it == $item[black picnic basket] && $skill[Bear Essence].have_skill())
            {
                item_modifier += 20.0 * MAX(1, get_property_int("skillLevel134"));
            }
            if (item_is_pickpockable_only)
            {
                if (__misc_state["can pickpocket"])
                    item_modifier = numeric_modifier("pickpocket chance");
                else
                    item_modifier = 0.0;
            }
            if (item_rate_is_fixed)
                item_modifier = 0.0;
            if ($locations[sweet-ade lake,Eager Rice Burrows,Gumdrop Forest] contains l)
            {
                item_modifier = 0.0;
                if (it.candy)
                    item_modifier += numeric_modifier("Candy Drop");
            }
            //FIXME pickpocketting...?
            //FIXME black cat
            
            if (my_path_id() == PATH_LIVE_ASCEND_REPEAT && !item_rate_is_fixed && !item_is_pickpockable_only && !item_is_avatar_potion && effective_drop_rate > 0.0)
            {
                //It's either 0.0 or not.
                float needed_rate = 1.0 / (2.0 * effective_drop_rate / 100.0);
                //print_html("needed_rate = " + needed_rate + " effective_drop_rate = " + effective_drop_rate);
                if (1.0 + item_modifier / 100.0 >= needed_rate)
                    effective_drop_rate = 100.0;
                else
                {
                    effective_drop_rate = 0.0;
                }
                yes_it_is_actually_zero = true;
            }
            else
                effective_drop_rate *= 1.0 + item_modifier / 100.0;
            if (my_path_id() == PATH_HEAVY_RAINS)
            {
                effective_drop_rate = clampf(floor(effective_drop_rate), 0.0, 100.0);
                float washaway_rate = l.washaway_rate_of_location();
                effective_drop_rate *= (1.0 - washaway_rate);
            }
            if (my_familiar() == $familiar[slimeling] && ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains it.to_slot()) && effective_drop_rate < 100.0)
            {
                effective_drop_rate = clampf(floor(effective_drop_rate), 0.0, 100.0);
                //number_of_slimeling_eligible_items
                float slimeling_chance = 0.0;
                if (number_of_slimeling_eligible_items > 0)
                    slimeling_chance = 1.0 / number_of_slimeling_eligible_items.to_float();
                
                int effective_familiar_weight = my_familiar().familiar_weight() + numeric_modifier("familiar weight");
                int familiar_weight_from_familiar_equipment = $slot[familiar].equipped_item().numeric_modifier("familiar weight"); //need to cancel it out
                
                float slimeling_base_drop_rate = my_familiar().numeric_modifier("item drop", effective_familiar_weight - familiar_weight_from_familiar_equipment, $slot[familiar].equipped_item());
                if ($slot[familiar].equipped_item() == $item[undissolvable contact lenses])
                    slimeling_base_drop_rate += 25.0;
                
                slimeling_chance *= adjusted_base_drop_rate.to_float() * (1.0 + slimeling_base_drop_rate / 100.0);
                effective_drop_rate += (100.0 - effective_drop_rate) * (slimeling_chance / 100.0);
            }
            //not a quest item, ???
            //if (my_familiar() == $familiar[black cat])
            
            effective_drop_rate = clampf(floor(effective_drop_rate), 0.0, 100.0);
            adjusted_base_drop_rate = effective_drop_rate;
            
            if (l.environment == "underwater") //FIXME underwater drops are complicated and I'd have to look deeply into this to verify, so we just list a ? for now
                adjusted_base_drop_rate = -1;
        }

        
        
        //FIXME implement this
        LBPItemInformation info;
        
        info.image_url = "images/itemimages/" + it.smallimage;
        if (it.smallimage.contains_text("/"))
            info.image_url = "images/" + it.smallimage;
        
        if (!grey_out_item)
        {
            if (adjusted_base_drop_rate <= 0 && !yes_it_is_actually_zero)
            {
                info.should_display_drop_current = true;
                info.item_drop_current_information = "?%";
            }
            else if (adjusted_base_drop_rate < 100 || base_drop_rate < 100)
            {
                info.should_display_drop_current = true;
                if (drop_rate_is_guess)
                    info.item_drop_current_information = adjusted_base_drop_rate + "?%";
                else
                    info.item_drop_current_information = adjusted_base_drop_rate + "%";
            }
        }
        info.item_name = it;
        if (it.available_amount() == 0)
            info.item_name = "<i>" + info.item_name + "</i>";
        
        if (base_drop_rate != adjusted_base_drop_rate && base_drop_rate > 0 && base_drop_rate < 100 && !grey_out_item)
        {
            info.should_display_drop_base = true;
            if (drop_rate_is_guess)
                info.item_drop_base_information = base_drop_rate + "?%";
            else
                info.item_drop_base_information = base_drop_rate + "%";
        }
        if (item_drop_modifiers_to_display.count() > 0)
        {
            if (info.item_drop_base_information != "")
                info.item_drop_base_information += ", ";
            info.item_drop_base_information += item_drop_modifiers_to_display.listJoinComponents(", ") + " drop";
        }
        if (item_is_conditional)
            info.tags.listAppend("conditional");
        if (item_is_pickpockable_only)
            info.tags.listAppend("pickpocket");
        if (item_rate_is_fixed)
            info.tags.listAppend("unaffected by +item");
        if (item_is_avatar_potion)
            info.tags.listAppend("avatar");
        info.greyed_out = grey_out_item;
        
        items_presenting.listAppend(info);
    }

    
    int columns = 3;
    if (items_presenting.count() % 2 == 0 && items_presenting.count() % 3 != 0 && items_presenting.count() < 8)
        columns = 2;
    if (items_presenting.count() < columns)
        columns = 1;
    
    boolean want_item_minimal_display = false;
    if (try_for_minimal_display || monsters_to_display_items_minimally[m] || monsters_to_display_items_minimally.count() > 2)
        want_item_minimal_display = true;
    
    boolean display_alternate_for_smaller_sizes = (columns == 3);
    
    buffer output_buffer;
    output_buffer.HTMLAppendTagPrefix("div", "style", "padding-left:" + (__setting_indention_width_in_em * 0.5) + "em;");
    string table_class = "";
    if (display_alternate_for_smaller_sizes)
        table_class = "r_only_display_if_not_tiny r_only_display_if_not_small";
    
    output_buffer.append(createItemInformationTableMethod2(columns, items_presenting, want_item_minimal_display, table_class, ""));
    
    if (display_alternate_for_smaller_sizes)
    {
        int maximum_columns = 2;
        if (items_presenting.count() >= 7 || monsters_to_display_items_minimally.count() >= 5) //hippy camp
            maximum_columns = 3;
        output_buffer.append(createItemInformationTableMethod2(MIN(columns, maximum_columns), items_presenting, want_item_minimal_display, "r_only_display_if_not_large r_only_display_if_not_medium r_do_not_display_if_media_queries_unsupported", "")); //font-size:0.95em;
    }
    output_buffer.append("</div>"); //container
    
    return output_buffer;
}

string generateLocationBarModifierEntries(string [int] entries_in)
{
    if (entries_in.count() == 1)
        return entries_in.listJoinComponents(", ");
    
    //Returns entries using a minimum-width algorithm designed to use two lines.
    
    string [int] entries = entries_in;
    if (!entries.listKeysMeetStrictRequirements()) //insure we can test [key + 1] and such
        entries = entries.listCopyStrictRequirements();
    
    int [int] entries_length;
    foreach key in entries
    {
        entries_length[key] = entries[key].HTMLStripTags().length();
    }
    
    int calculating_sum = 0;
    
    int smallest_length = 0;
    int smallest_length_index = -1;
    foreach key in entries
    {
        if (key == entries.count() - 1)
            continue;
        
        calculating_sum += entries_length[key];
        //If we split at the end of this entry, what will be our length?
        int line_1_length = calculating_sum;
        int line_2_length = 0;
        foreach key2 in entries
        {
            if (key2 <= key)
                continue;
            line_2_length += entries_length[key2];
        }
        int line_length = MAX(line_1_length, line_2_length);
        
        if (smallest_length_index == -1)
        {
            smallest_length = line_length;
            smallest_length_index = key;
        }
        else
        {
            if (smallest_length >= line_length)
            {
                smallest_length_index = key;
                smallest_length = line_length;
            }
        }
    }
    //Split after smallest_length:
    buffer result;
    foreach key in entries
    {
        result.append(entries[key]);
        boolean should_br = false;
        if (key == smallest_length_index)
            should_br = true;
        if (key != entries.count() - 1)
        {
            if (should_br)
                result.append(",");
            else
                result.append(", ");
        }
        if (should_br)
            result.append("<br>");
        
    }
    return result;
}


buffer generateLocationBarTable(string [int] table_entries, string [int] table_entry_urls, string [int] table_entry_styles, string [int] table_entry_classes, float [int] table_entry_width_weight, float [int] table_entry_fixed_width_percentage, string base_url)
{
    buffer bar;


    int [int] table_entry_widths;
    if (__setting_location_bar_fixed_layout)
    {
        float reserved_percentage = 0.0;
        foreach key, v in table_entry_fixed_width_percentage
            reserved_percentage += v;
        reserved_percentage = clampf(reserved_percentage, 0.0, 1.0);
    
    
        int [int] table_entry_character_length;
        foreach key in table_entries
        {
            if (table_entry_fixed_width_percentage contains key)
                continue;
            //Complicated:
            string entry = table_entries[key];
            string [int] lines = entry.split_string("<br>");
            int max_length = 0;
            foreach key2 in lines
            {
                //Remove HTML:
                string l = HTMLStripTags(lines[key2]);
                max_length = MAX(max_length, l.length());
            }
            if (table_entry_width_weight contains key)
                max_length = round(max_length.to_float() * table_entry_width_weight[key]);
            table_entry_character_length[key] = max_length;
        }
        int total_character_count = listSum(table_entry_character_length);
        int [int] proportional_character_lengths;
        foreach key in table_entry_character_length
        {
            if (table_entry_fixed_width_percentage contains key)
                continue;
            int v = table_entry_character_length[key];
            if (total_character_count != 0 && __setting_location_bar_limit_max_width)
            {
                if (v.to_float() / total_character_count.to_float() >= __setting_location_bar_max_width_per_entry)
                {
                    v = floor(total_character_count.to_float() * __setting_location_bar_max_width_per_entry);
                }
            }
            proportional_character_lengths[key] = v;
        }
        
        float remaining_percentage = 100.0 * (1.0 - reserved_percentage);
        
        int proportional_total = listSum(proportional_character_lengths);
        foreach key in table_entry_fixed_width_percentage
        {
            table_entry_widths[key] = clampf(table_entry_fixed_width_percentage[key], 0.0, 1.0) * 100.0;
        }
        foreach key in proportional_character_lengths
        {
            if (table_entry_fixed_width_percentage contains key)
                continue;
            int v = proportional_character_lengths[key];
            int width = 25;
            if (proportional_character_lengths.count() > 0)
                width = floor(remaining_percentage / proportional_character_lengths.count().to_float()); //backup
            if (proportional_total != 0)
            {
                width = v.to_float() / proportional_total.to_float() * remaining_percentage;
            }
            table_entry_widths[key] = width;
        }
    }
    
    if (table_entry_widths.listSum() > 100)
    {
        //Safety backup. Renormalize:
        int current_sum = table_entry_widths.listSum();
        foreach key in table_entry_widths
        {
            if (current_sum != 0) //not strictly necessary, will always be true (as the code currently is)
                table_entry_widths[key] = floor(table_entry_widths[key].to_float() / current_sum.to_float() * 100.0);
        }
    }
    
    
    if (true)
    {
        buffer table_style;
        table_style.append("display:table;width:100%;height:100%;text-align:center;height:" + __setting_navbar_height_in_em + "em;"); //min-height is less than ideal but works
        if (__setting_location_bar_fixed_layout)
            table_style.append("table-layout:fixed;");
        bar.HTMLAppendTagPrefix("div", "style", table_style); //
    }
    
    foreach key in table_entries
    {
        string s = table_entries[key];
        string entry_url = base_url;
        if (table_entry_urls contains key)
            entry_url = table_entry_urls[key];
        
        string [string] map;
        
        if (entry_url != "")
            map = generateMainLinkMap(entry_url);
        map["class"] += " r_location_bar_table_entry";
        if (table_entry_classes contains key)
            map["class"] += " " + table_entry_classes[key];
        if (table_entry_styles contains key)
            map["style"] += table_entry_styles[key];
        
        if (table_entry_widths contains key)
            map["style"] += "width:" + table_entry_widths[key] + "%;";
        
        if (entry_url.length() != 0)
            bar.HTMLAppendTagPrefix("a", map);
        else
            bar.HTMLAppendTagPrefix("div", map);
        
        if (table_entry_classes contains key)
            bar.append(s);
        else
            bar.HTMLAppendTagWrap("div", s, mapMake("class", "r_cl_modifier_inline", "style", "color:black;")); //r_cl_modifier_inline needs its own div due to CSS class order precedence
        if (entry_url.length() != 0)
        {
            bar.append("</a>");
        }
        else
            bar.append("</div>");
    }
    
    
    bar.HTMLAppendTagSuffix("div");
    
    
    
    return bar;
}


static
{
    boolean __manuel_available = false;
    boolean __did_check_manuel_available = false;
}

buffer generateLocationPopup(float bottom_coordinates, boolean location_bar_location_name_is_centre_aligned)
{
    buffer buf;
    location l = __last_adventure_location;
    if (!__setting_location_bar_uses_last_location && !get_property_boolean("_relay_guide_setting_ignore_next_adventure_for_location_bar") && get_property_location("nextAdventure") != $location[none])
        l = get_property_location("nextAdventure");
    if (!__setting_enable_location_popup_box)
        return buf;
    
    string transition_time = "0.5s";
    buf.HTMLAppendTagWrap("div", "", mapMake("id", "r_location_popup_blackout", "class", "r_popup_blackout_class", "style", "z-index:4;"));
    PageAddCSSClass("", "r_popup_blackout_class", "position:fixed;top:0px;width:100%;height:100%;background:rgba(0,0,0,0.5);opacity:0;pointer-events:none;visibility:hidden;");
    
    buf.HTMLAppendTagPrefix("div", mapMake("id", "r_location_popup_box", "style", "height:auto;transition:bottom " + transition_time + ";z-index:5;opacity:0;pointer-events:none;bottom:-10000px;position:fixed;", "class", "r_bottom_outer_container"));
    buf.HTMLAppendTagPrefix("div", "class", "r_bottom_inner_container", "style", "background:white;height:auto;padding-right:20px;");
    
    float [monster] appearance_rates_adjusted = l.appearance_rates_adjusted();
    float [monster] appearance_rates_next_turn = l.appearance_rates(true);
    
    string [monster] monsters_that_we_cannot_encounter;
    if ($effect[Ancient Annoying Serpent Poison].have_effect() == 0)
    {
        foreach m in $monsters[The Frattlesnake,Batsnake,Frozen Solid Snake,Burning Snake of Fire,The Snake With Like Ten Heads,Snakeleton]
        {
            monsters_that_we_cannot_encounter[m] = "not on copperhead quest";
        }
    }
    if (l == $location[the boss bat's lair])
    {
        if (l.delayRemainingInLocation() > 0)
        {
            monsters_that_we_cannot_encounter[$monster[Boss Bat]] = "on delay";
        }
    }
    else if (l == $location[the defiled niche])
    {
        int evilness = __quest_state["Level 7"].state_int["niche evilness"];
        if (evilness > 25)
        {
            monsters_that_we_cannot_encounter[$monster[gargantulihc]] = "evilness too high";
        }
        else if (evilness > 0)
        {
            monsters_that_we_cannot_encounter[$monster[senile lihc]] = "boss up";
            monsters_that_we_cannot_encounter[$monster[slick lihc]] = "boss up";
            monsters_that_we_cannot_encounter[$monster[dirty old lihc]] = "boss up";
        }
    }
    else if (l == $location[the defiled cranny])
    {
        int evilness = __quest_state["Level 7"].state_int["cranny evilness"];
        if (evilness > 25)
        {
            monsters_that_we_cannot_encounter[$monster[huge ghuol]] = "evilness too high";
        }
        else if (evilness > 0)
        {
            foreach m in $monsters[gluttonous ghuol,gaunt ghuol,swarm of ghuol whelps,big swarm of ghuol whelps,giant swarm of ghuol whelps]
                monsters_that_we_cannot_encounter[m] = "boss up";
        }
    }
    else if (l == $location[the defiled nook])
    {
        int evilness = __quest_state["Level 7"].state_int["nook evilness"];
        if (evilness > 25)
        {
            monsters_that_we_cannot_encounter[$monster[giant skeelton]] = "evilness too high";
        }
        else if (evilness > 0)
        {
            foreach m in $monsters[spiny skelelton,toothy sklelton]
                monsters_that_we_cannot_encounter[m] = "boss up";
        }
    }
    else if (l == $location[oil peak])
    {
        int oil_ml = $location[oil peak].monster_level_adjustment_for_location();
        monster correct_monster = $monster[oil slick];
        if (oil_ml < 20)
            correct_monster = $monster[oil slick];
        else if (oil_ml < 50)
            correct_monster = $monster[oil tycoon];
        else if (oil_ml < 100)
            correct_monster = $monster[oil baron];
        else if (oil_ml >= 100)
            correct_monster = $monster[oil cartel];
        foreach m in $monsters[oil slick,oil tycoon,oil baron,oil cartel]
        {
            if (m != correct_monster)
                monsters_that_we_cannot_encounter[m] = "ML based";
        }
    }
    //FIXME other defileds
    
    boolean banishes_are_possible = true;
    if ($locations[the secret government laboratory,sloppy seconds diner] contains l)
        banishes_are_possible = false;
    if (my_path_id() == PATH_LIVE_ASCEND_REPEAT)
        banishes_are_possible = false;
    
    foreach m in appearance_rates_next_turn
    {
        if (monsters_that_we_cannot_encounter contains m)// || m.is_banished())
            remove appearance_rates_next_turn[m];
    }
    //l.appearance_rates(true) doesn't seem to take into account banished monsters, so correct:
    appearance_rates_next_turn[$monster[none]] = 0.0; //ignore
    float arnt_sum = 0.0;
    foreach m, rate in appearance_rates_next_turn
    {
        if (m.is_banished() && banishes_are_possible)
            appearance_rates_next_turn[m] = MIN(appearance_rates_next_turn[m], 0.0);
        else if (rate > 0.0)
            arnt_sum += appearance_rates_next_turn[m];
    }
    if (arnt_sum != 100.0 && arnt_sum != 0.0)
    {
        float inverse = 1.0 / (arnt_sum / 100.0);
        
        foreach m, rate in appearance_rates_next_turn
        {
            if (rate > 0.0)
                appearance_rates_next_turn[m] *= inverse;
        }
    }
    
    monster [int] monster_display_order;
    boolean rates_are_equal = true;
    boolean next_rates_are_equal = true;
    float last_rate = -1.0;
    float last_next_rate = -1.0;
    foreach m in appearance_rates_adjusted
    {
        if (m == $monster[none])
            continue;
        float rate = appearance_rates_adjusted[m];
        float next_rate = appearance_rates_next_turn[m];
        if (rate <= 0.0 && l == $location[Investigating a Plaintive Telegram])
            continue;
        monster_display_order.listAppend(m);
        if (rate > 0.0 && m != $monster[none])
        {
            if (last_rate == -1.0)
                last_rate = rate;
            else if (fabs(last_rate - rate) > 0.01)
            {
                rates_are_equal = false;
            }
        }
        
        if (next_rate > 0.0 && m != $monster[none])
        {
            if (last_next_rate == -1.0)
                last_next_rate = next_rate;
            else if (fabs(last_next_rate - next_rate) > 0.01)
            {
                next_rates_are_equal = false;
            }
        }
    }
    
    boolean [monster] possible_alien_monsters;
    if (!(appearance_rates_adjusted contains last_monster())) //wandering monsters, etc
    {
        possible_alien_monsters[last_monster()] = true;
        monster_display_order.listAppend(last_monster());
    }
    
    int minimal_cutoff_monster_count = 10;
    boolean try_for_minimal_display = false;
    if (monster_display_order.count() > minimal_cutoff_monster_count)
        try_for_minimal_display = true;
    
    if (next_rates_are_equal)
    {
        //equality
        sort monster_display_order by -appearance_rates_next_turn[value];
        sort monster_display_order by -appearance_rates_adjusted[value] - (possible_alien_monsters[value] ? -100.0 : 0);
    }
    else
    {
        sort monster_display_order by -appearance_rates_adjusted[value] - (possible_alien_monsters[value] ? -100.0 : 0);
        sort monster_display_order by -appearance_rates_next_turn[value] - (possible_alien_monsters[value] ? -100.0 : 0);
    }
    int entries_displayed = 0;
    int monsters_displayed = 0;
    
    boolean can_display_as_2x = true;
    boolean spelunking = limit_mode() == "spelunky";
    
    /*if (false) //trying with it off - it feels better to use layout more effectively, rather than try to line up everything. example area: domed city of grimacia
    {
        foreach key, m in monster_display_order
        {
            int item_count_displaying = m.item_drops_array().count();
            if (item_count_displaying <= 1)
            {
            }
            else if (item_count_displaying == 2 || (item_count_displaying % 2 == 0 && item_count_displaying % 3 != 0))
            {
            }
            else
                can_display_as_2x = false;
        }
    }*/
    
    float rate_nc_cancel_multiplier = 1.0;
    if (appearance_rates_adjusted[$monster[none]] > 0.0)
    {
        float divisor = (1.0 - appearance_rates_adjusted[$monster[none]] / 100.0);
        if (divisor != 0.0)
            rate_nc_cancel_multiplier = 1.0 / divisor;
    }
    
    boolean [monster] monsters_to_display_items_minimally;
    int item_minimal_display_limit = 6;
    foreach key, m in monster_display_order
    {
        //pooltergeist has lots of items, but they're very short named
        int total_string_length = 0;
        foreach key, r in m.item_drops_array()
        {
            total_string_length += r.drop.to_string().length();
        }
        if (m.item_drops_array().count() > item_minimal_display_limit && total_string_length >= 100)
            monsters_to_display_items_minimally[m] = true;
    }
    foreach key, m in monster_display_order
    {
        string [int] fl_entries;
        string [int] fl_entry_urls;
        string [int] fl_entry_styles;
        string [int] fl_entry_classes;
        float [int] fl_entry_width_weight;
        float [int] fl_entry_fixed_width_percentage;
        
        string monster_image_url = "images/adventureimages/" + m.image;
        if (m.image.contains_text("/"))
            monster_image_url = "images/" + m.image;
        if (m.image == "toxbeast1.gif")
            monster_image_url = "images/adventureimages/toxbeast3.gif";
        if (m.image.length() == 0)
            monster_image_url = "";
        ServerImageStats monster_image_stats = ServerImageStatsOfImageURL(monster_image_url);
        float rate = appearance_rates_adjusted[m] * rate_nc_cancel_multiplier;
        float next_rate = appearance_rates_next_turn[m]; //already normalised for monsters
        if (entries_displayed > 0)
            buf.HTMLAppendTagPrefix("hr", "style", "margin:0px;");
        entries_displayed += 1;
        monsters_displayed += 1;
            
        boolean avoid_outputting_conditional = false;
        boolean monster_cannot_be_encountered = false;
        string reason_monster_cannot_be_encountered = "";
        if (m.is_banished() && banishes_are_possible)
        {
            monster_cannot_be_encountered = m.is_banished();
            reason_monster_cannot_be_encountered = "banished";
        }
        else if (monsters_that_we_cannot_encounter contains m)
        {
            monster_cannot_be_encountered = true;
            reason_monster_cannot_be_encountered = monsters_that_we_cannot_encounter[m];
        }
        else if (appearance_rates_adjusted[$monster[none]] >= 100.0 && !(possible_alien_monsters contains m))
        {
            monster_cannot_be_encountered = true;
            reason_monster_cannot_be_encountered = "no combats";
            avoid_outputting_conditional = true;
        }
        if (true)
        {
            //string style = "width:100%;display:table;padding:0.25em;z-index:7;position:relative;overflow:hidden;";
            string style = "width:100%;padding-bottom:0.1em;z-index:7;position:relative;overflow:hidden;";
            if (try_for_minimal_display)
                style += "padding-top:0.1em;";
            if (monster_cannot_be_encountered)
                style += "color:grey;";
            if (monster_image_stats.height > 100 && false) //those tall monsters like to impress
                style += "min-height:100px;";
            buf.HTMLAppendTagPrefix("div", "style", style);
        }
        if (!monster_image_url.contains_text("nopic.gif") && monster_image_url != "")
        {
            //FIXME centre image if it's small? maybe a table? more tables!
            boolean from_bottom_instead = false;
            //if ($strings[images/adventureimages/lower_b.gif,images/adventureimages/lower_k.gif,images/adventureimages/lower_h.gif,images/adventureimages/upper_q.gif,images/adventureimages/aswarm.gif,images/adventureimages/lowerm.gif,images/adventureimages/dad_machine.gif] contains monster_image_url && monster_image_stats.maximum_y_coordinate != -1 && monster_image_stats.height != -1) //dungeons of doom, dad sea monkee
                //from_bottom_instead = true;
            
            
            float max_height = 100;
            //monster_image_stats.height
            //make max_height adjust:
            float effective_height = monster_image_stats.maximum_y_coordinate - monster_image_stats.minimum_y_coordinate + 1;
            float height_fraction = 1.0;
            if (monster_image_stats.height > 0)
                height_fraction = effective_height / monster_image_stats.height.to_float();
            
            if (height_fraction > 0)
                max_height = 100.0 / height_fraction;
            
            string image_style = "position:absolute;right:0px;top:0px;max-height:" + max_height.ceil() + "px;z-index:-3;";
            if (monster_cannot_be_encountered)
                image_style += "opacity:0.1;";
            else if (last_monster() == m)
                image_style += "opacity:0.5;"; //1.0
            else if (m.attributes.contains_text("ULTRARARE"))
                image_style += "opacity:0.1;";
            else
                image_style += "opacity:0.2;"; //0.5
            if (from_bottom_instead && false) //disabled, no longer works
            {
                float location_of_first_bottom_pixel = monster_image_stats.maximum_y_coordinate;
                float margin_bottom = monster_image_stats.height - location_of_first_bottom_pixel;
                if (monster_image_stats.height != 100)
                {
                    //correct margin, as we scale images down to 100
                    float ratio = monster_image_stats.height.to_float() / 100.0;
                    if (ratio != 0.0)
                        margin_bottom /= ratio;
                }
                image_style += "bottom:0px;";
                image_style += "margin-bottom:-" + ceil(margin_bottom) + "px;";
                
            }
            else
            {
                float location_of_first_top_pixel = MAX(0, monster_image_stats.minimum_y_coordinate);
                if (monster_image_stats.height != 100 && false) //FIXME ???
                {
                    //correct margin, as we scale images down to 100
                    float ratio = monster_image_stats.height.to_float() / 100.0;
                    if (ratio != 0.0)
                        location_of_first_top_pixel /= ratio;
                }
                if (location_of_first_top_pixel > 0)
                    image_style += "margin-top:-" + location_of_first_top_pixel + "px;";
            }
            buf.HTMLAppendTagPrefix("img", mapMake("src", monster_image_url, "style", image_style, "alt", m));
        }
        
        if (true)
        {
            string style;
            float width_weight = 1.4;
            if (monster_cannot_be_encountered)
            {
                style += "text-decoration:line-through;";
                //width_weight = 1.0;
            }
            else
                style = "font-size:1.2em;";
            style += "text-align:left;padding-top:2px;";
            
            fl_entries.listAppend(m.capitaliseFirstLetter());
            fl_entry_classes[fl_entries.count() - 1] = "r_bold r_location_bar_ellipsis_entry";
            fl_entry_styles[fl_entries.count() - 1] = style;
            fl_entry_width_weight[fl_entries.count() - 1] = width_weight;
        }
        
        
        
        //FIXME handle canceling NC
        buffer rate_buffer;
        if (m.is_banished() && banishes_are_possible)
        {
            rate_buffer.append("banished");
            Banish banish_information = m.BanishForMonster();
            if (banish_information.banish_source != "")
            {
                rate_buffer.append(" by ");
                rate_buffer.append(banish_information.banish_source);
            }
            if (banish_information.custom_reset_conditions != "")
            {
                rate_buffer.append(" until ");
                rate_buffer.append(banish_information.custom_reset_conditions);
            }
            else if (banish_information.banish_turn_length == -1)
                rate_buffer.append(" forever");
            else if (banish_information.banish_turn_length > 0)
            {
                int turns_left = banish_information.BanishTurnsLeft();
                rate_buffer.append(" for ");
                rate_buffer.append(pluralise(turns_left, "more turn", "more turns"));
            }
            rate_buffer.append(" ");
            avoid_outputting_conditional = true;
        }
        else if (m.attributes.contains_text("SEMIRARE"))
        {
            rate_buffer.append("semi-rare ");
            avoid_outputting_conditional = true;
        }
        else if (m.attributes.contains_text("ULTRARARE"))
        {
            rate_buffer.append("ultra rare ");
            avoid_outputting_conditional = true;
        }
        else if (m.boss)
        {
            rate_buffer.append("boss ");
            avoid_outputting_conditional = true;
        }
        if (rate > 0 && !(m.is_banished() && banishes_are_possible) && !monster_cannot_be_encountered)
        {
            if (!rates_are_equal)
            {
                rate_buffer.append(rate.roundForOutput(0));
                rate_buffer.append("%");
            }
            if (next_rate != rate && next_rate > 0 && !next_rates_are_equal)
            {
                if (rates_are_equal)
                    rate_buffer.append("equal %");
                rate_buffer.append("<br>next ");
                
                rate_buffer.append(next_rate.roundForOutput(0));
                rate_buffer.append("%");
            }
        }
        else if (rate <= 0)
        {
            if (possible_alien_monsters contains m)
                rate_buffer.append("elsewhere");
            else if (!avoid_outputting_conditional)
                rate_buffer.append("conditional");
        }
        //seen values for rate:
        //0.0 for bosses
        //-1.0 for ultra-rares
        
        if (rate_buffer.length() > 0)
        {
            fl_entries.listAppend(rate_buffer);
        }
        if (monster_cannot_be_encountered && reason_monster_cannot_be_encountered != "banished")
        {
            fl_entries.listAppend(reason_monster_cannot_be_encountered);
        }
        
        
        
        
        
        
        int item_count_displaying = m.item_drops_array().count();
        if (item_count_displaying > 0 && try_for_minimal_display && !monster_cannot_be_encountered)
        {
            fl_entries.listAppend(pluralise(item_count_displaying, "item", "items"));
        }
        
        
        if (!monster_cannot_be_encountered)
        {
            string [int] stats_l1;
            string [int] stats_l2;
            //if (m.base_hp > 0)
                //stats_l1.listAppend(m.base_hp + " HP");
            if (m.phylum != $phylum[none] && !spelunking)
            {
                string line;
                if ($monsters[broodling seal] contains m)
                    line = "<del>cute</del><br>";
                line += m.phylum;
                if (true && m.attack_element != $element[none])
                    line = HTMLGenerateSpanOfClass(line, "r_element_" + m.attack_element + "_desaturated");
                stats_l1.listAppend(line);
            }
            /*if (m.attack_element != $element[none] && false)
            {
                stats_l2.listAppend(HTMLGenerateSpanOfClass(m.attack_element, "r_element_" + m.attack_element + "_desaturated"));
            }*/
            if (m.max_meat > 0)
            {
                float average_meat = (m.min_meat + m.max_meat) * 0.5;
                average_meat *= (1.0 + meat_drop_modifier() / 100.0);
                if (average_meat >= 25) //ignore really low amounts
                {
                    if (l.environment == "underwater") //FIXME calculate this properly
                        stats_l1.listAppend("? meat");
                    else
                        stats_l1.listAppend(average_meat.round() + " meat");
                }
            }
            if (m.base_attack > 0)
                stats_l2.listAppend(m.base_attack + " ML");
            if (spelunking)
                stats_l2.listAppend(m.base_hp + " HP");
            if ($skill[Extract Oil].have_skill())
            {
                string oil_type = lookupAWOLOilForMonster(m);
                if (oil_type != "")
                    stats_l2.listAppend(oil_type);
            }
            //if (m.raw_defense > 0)
                //stats_l2.listAppend(m.raw_defense + " def");
            if (false)
            {
                //disabled - monster_factoids_available constantly reissues server requets if we don't have a factoid on a monster
                if (!__did_check_manuel_available)
                {
                    //so, if the manuel isn't available, we incur a quest log load every time. so don't do that.
                    __manuel_available = $monster[spooky vampire].monster_factoids_available(false) > 0;
                    __did_check_manuel_available = true;
                }
                if (__manuel_available)
                {
                    int factoids_left = 3 - monster_factoids_available(m, false);
                    if (m.attributes.contains_text("ULTRARARE") || m.attributes.contains_text("NOMANUEL")) //ULTRARARE test may be superfluous
                        factoids_left = 0;
                    if (factoids_left > 0)
                        stats_l2.listAppend(factoids_left + " more fact" + (factoids_left > 1 ? "s" : ""));
                }
            }
            
            if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
            {
                int ka_dropped = m.ka_dropped();
                if (ka_dropped > 0)
                    stats_l1.listAppend(ka_dropped + " ka");
            }
            
            if (m.expected_damage() > 1 && (m.expected_damage() >= my_hp().to_float() * 0.5 || ($monsters[spider gremlin,batwinged gremlin,erudite gremlin,vegetable gremlin] contains m)) || spelunking)
            {
                string damage_text = m.expected_damage() + " dmg";
                if (m.expected_damage() >= 0.75 * my_hp())
                    damage_text = HTMLGenerateSpanOfClass(damage_text, "r_element_hot_desaturated"); //"#FC686F", "");
                stats_l2.listAppend(damage_text);
            }
            
            if (stats_l2.count() == 0 && stats_l1.count() == 2) //rebalance hack
            {
                stats_l2.listPrepend(stats_l1[1]);
                remove stats_l1[1];
            }
            if (stats_l2.count() == 1 && stats_l1.count() == 3) //rebalance hack
            {
                stats_l2.listPrepend(stats_l1[2]);
                remove stats_l1[2];
            }
            
            if (stats_l1.count() + stats_l2.count() > 0)
            {
                string line = stats_l1.listJoinComponents(" / ");
                if (stats_l2.count() > 0)
                {
                    if (stats_l1.count() > 0)
                        line += "<br>";
                    line += stats_l2.listJoinComponents(" / ");
                }
                fl_entries.listAppend(line);
                fl_entry_styles[fl_entries.count() - 1] = "text-align:right;";
                fl_entry_width_weight[fl_entries.count() - 1] = 1.4;
            }
        }
        
        //add background blur:
        if (true)
        {
            foreach key, entry in fl_entries
            {
                entry = HTMLGenerateSpanOfClass(entry, "r_location_bar_background_blur");
                fl_entries[key] = entry;
            }
        }
        if (!(m.is_banished() && banishes_are_possible))
        {
            if (fl_entries.count() == 2)
                fl_entry_fixed_width_percentage[0] = 0.60;
            else if (fl_entries.count() == 3)
            {
                fl_entry_fixed_width_percentage[0] = 0.50;
                fl_entry_fixed_width_percentage[1] = 0.2;
                fl_entry_fixed_width_percentage[2] = 0.3;
            }
            else if (fl_entries.count() == 4)
            {
                fl_entry_fixed_width_percentage[0] = 0.40;
                fl_entry_fixed_width_percentage[1] = 0.2;
                fl_entry_fixed_width_percentage[2] = 0.15;
                fl_entry_fixed_width_percentage[3] = 0.25;
            }
        }
            //remove fl_entry_fixed_width_percentage[0];
        
        buf.append(generateLocationBarTable(fl_entries, fl_entry_urls, fl_entry_styles, fl_entry_classes, fl_entry_width_weight, fl_entry_fixed_width_percentage, ""));
        
        
        if (item_count_displaying > 0 && !try_for_minimal_display && !monster_cannot_be_encountered && true)
        {
            buf.append(generateItemInformationMethod2(l, m, try_for_minimal_display,monsters_to_display_items_minimally));
        }
        
        //buf.HTMLAppendTagSuffix("div");
        buf.HTMLAppendTagSuffix("div");
        //break;
    }
    
    if (in_bad_moon())
    {
        BadMoonAdventure [int] bad_moon_adventures = BadMoonAdventuresForLocation(l);
        
        if (bad_moon_adventures.count() > 0)
        {
            foreach key, adventure in bad_moon_adventures
            {
                if (haveSeenBadMoonEncounter(adventure.encounter_id))
                    continue;
                    
                string [int] fl_entries;
                string [int] fl_entry_urls;
                string [int] fl_entry_styles;
                string [int] fl_entry_classes;
                float [int] fl_entry_width_weight;
                float [int] fl_entry_fixed_width_percentage;
                
                
                string image_style = "margin-top:1px;";
                if (adventure.has_additional_requirements_not_yet_met)
                    image_style += "opacity:0.25;";
                fl_entries.listAppend(HTMLGenerateTagPrefix("img", mapMake("src", __bad_moon_small_image_data, "style", image_style)));
                fl_entry_styles[fl_entries.count() - 1] = "text-align:right;";
                fl_entry_fixed_width_percentage[fl_entries.count() - 1] = 0.1;
                fl_entries.listAppend(adventure.description);
                fl_entry_styles[fl_entries.count() - 1] = "text-align:left;";
                if (adventure.has_additional_requirements_not_yet_met)
                    fl_entries.listAppend("Need to " + adventure.conditions_to_finish);
                
                
                buf.HTMLAppendTagPrefix("hr", "style", "margin:0px;");
                buf.append(generateLocationBarTable(fl_entries, fl_entry_urls, fl_entry_styles, fl_entry_classes, fl_entry_width_weight, fl_entry_fixed_width_percentage, ""));
            }
        }
    }
    
    
    if (false)
    {
        string [int] lines;
        string [int] lines_offscreen;
        if (false && l.parentdesc != "" && l.parentdesc != "No Category" && l.parentdesc.to_lower_case() != l.to_lower_case())
            lines.listAppend(l.parentdesc);
        if (!__misc_state["in run"] && l.turns_spent > 0)
        {
            lines.listAppend(pluralise(l.turns_spent, "turn spent", "turns spent")); //lines_offscreen
        }
        if (lines.count() + lines_offscreen.count() > 0)
        {
            if (entries_displayed >= 1)
                buf.HTMLAppendTagPrefix("hr", "style", "margin:0px;");
            string div_class = "r_cl_modifier_inline";
            string div_style = "height:1.1em;padding-top:1px;padding-bottom:1px;";
            if (location_bar_location_name_is_centre_aligned)
                div_class += " r_centre";
            else
                div_style += "padding-left:" + __setting_indention_width + ";";
            buf.HTMLAppendTagPrefix("div", "class", div_class, "style", div_style);
            buf.append(lines.listJoinComponents(" - "));
            buf.append("</div>");
            if (lines_offscreen.count() > 0)
            {
                buf.HTMLAppendTagPrefix("div", "class", "r_cl_modifier_inline", "style", "position:absolute;right:0px;top:0px;");
                buf.append(lines_offscreen.listJoinComponents(" - "));
                buf.append("</div>");
            }
            entries_displayed += 1;
        }
    }
    if (false)
    {
        string [int] fl_entries;
        string [int] fl_entry_urls;
        string [int] fl_entry_styles;
        string [int] fl_entry_classes;
        float [int] fl_entry_width_weight;
        float [int] fl_entry_fixed_width_percentage;
        
        if (false && l.parentdesc != "" && l.parentdesc != "No Category" && l.parentdesc.to_lower_case() != l.to_lower_case())
            fl_entries.listAppend(l.parentdesc);
        
        /*Error err;
        if (!l.locationAvailable(err))
        {
            if (!err.was_error)
                fl_entries.listAppend("Inaccessible"); //doesn't make any sense unless we add that one feature
        }*/
        
        if (!__misc_state["in run"] && l.turns_spent > 0)
            fl_entries.listAppend(pluralise(l.turns_spent, "turn spent", "turns spent"));
        
        boolean all_entries_blank = true;
        foreach key, entry in fl_entries
        {
            if (entry != "")
                all_entries_blank = false;
        }
        if (fl_entries.count() > 0 && !all_entries_blank)
        {
            if (entries_displayed >= 1)
                buf.HTMLAppendTagPrefix("hr", "style", "margin:0px;");
            /*if (fl_entries.count() == 2)
            {
                fl_entry_styles[1] += "text-align:right;";
            }*/
            foreach key in fl_entries
                fl_entry_styles[key] += "height:1.25em;";
                
            fl_entry_styles[0] += "text-align:left;";
            fl_entry_styles[0] += "padding-left:" + __setting_indention_width + ";";
            if (fl_entries.count() > 1)
            {
                fl_entry_styles[fl_entries.count() - 1] += "text-align:right;";
                fl_entry_styles[fl_entries.count() - 1] += "padding-right:" + __setting_indention_width + ";";
            }
            buf.append(generateLocationBarTable(fl_entries, fl_entry_urls, fl_entry_styles, fl_entry_classes, fl_entry_width_weight, fl_entry_fixed_width_percentage, ""));
            entries_displayed += 1;
            
            //output_hr_override = true;
        }
        
    }
    
    //boolean output_hr_override = false;
    
    if (entries_displayed == 0)
        return "".to_buffer();
    buf.HTMLAppendTagSuffix("div");
    //if (output_hr_override)
            //buf.append("<div style=\"position:absolute;bottom:-1px;min-height:2px;width:100%;z-index:10000;background:blue;\"></div>");
    buf.HTMLAppendTagSuffix("div");
    
    return buf;
}

buffer generateLocationBar(boolean displaying_navbar)
{
    buffer bar;
    if (!playerIsLoggedIn())
        return bar;
    location l = __last_adventure_location;
    if (!__setting_location_bar_uses_last_location && !get_property_boolean("_relay_guide_setting_ignore_next_adventure_for_location_bar") && get_property_location("nextAdventure") != $location[none]) //setting exists for ascension scripts that alter my_location() to a null value/noob cave whenever they're not adventuring somewhere specific, to avoid environment-based effects on modifiers.
        l = get_property_location("nextAdventure");
    //l = my_location();
    
    if (l == $location[none] || __misc_state["In valhalla"])
        return "".to_buffer();
    
    
    string url = l.getClickableURLForLocation();
    
    
    float [monster] monster_appearance_rates = l.appearance_rates_adjusted();
    
    
    int nc_rate = MAX(0.0, monster_appearance_rates[$monster[none]]);
    
    float location_base_ml = l.monster_level_adjustment_for_location();
    float location_base_init_penalty = monsterExtraInitForML(location_base_ml);
    if (l.locationHasPlant("Impatiens") || l.locationHasPlant("Shuffle Truffle"))
        location_base_init_penalty -= 25.0;
    
    
    float average_ml = 0.0;
    float max_init = 0.0;
    float sample_count = 0.0;
    
    boolean [location] locations_where_monsters_always_matter = $locations[the haunted bedroom];
    
    foreach m in monster_appearance_rates
    {
        if (monster_appearance_rates[m] <= 0.0 && !(locations_where_monsters_always_matter contains l)) //one-time hack, sure?
            continue;
        if (m == $monster[none])
            continue;
        average_ml += m.raw_attack + location_base_ml;
        
        if (m.raw_attack == m.base_attack && location_base_ml > 0) //scaling monsters will have equivalent base_attack and raw_attack with ML already applied.
            average_ml -= location_base_ml; //this will be slightly incorrect with plants, due to how location ML works, but fixing it is very complicated
        
        max_init = MAX(max_init, m.raw_initiative + location_base_init_penalty);
        sample_count += 1.0;
    }
    if (sample_count > 0.0)
    {
        average_ml /= sample_count;
    }
    
    float chance_of_jump = 0.0;
    chance_of_jump = clampNormalf(((100.0 - max_init) + initiative_modifier_ignoring_plants()) / 100.0);
    
    string [int] plant_data;
    
    if (__iotms_usable[$item[Order of the Green Thumb Order Form]])
    {
        string [location, 3] florist_plants = get_florist_plants();
        
        if (florist_plants contains l)
        {
            string [3] area_plants = get_florist_plants()[l];
            
            foreach key in area_plants
            {
                string plant_name = area_plants[key];
                if (plant_name.length() == 0)
                    continue;
                string plant_description = plant_name.getPlantDescription();
                
                string class_name = "";
                //Half-saturation of their original colour, to fit in with the modifier look:
                if (plant_description == "spooky attack")
                    class_name = "r_element_spooky_desaturated";
                else if (plant_description == "hot attack")
                    class_name = "r_element_hot_desaturated";
                else if (plant_description == "sleaze attack")
                    class_name = "r_element_sleaze_desaturated";
                else if (plant_description == "stench attack")
                    class_name = "r_element_stench_desaturated";
                else if (plant_description == "cold attack")
                    class_name = "r_element_cold_desaturated";
                
                if (class_name != "")
                    plant_description = HTMLGenerateSpanOfClass(plant_description, class_name);
                
                if (plant_description != "")
                    plant_data.listAppend(plant_description);
                else
                    plant_data.listAppend("Unknown");
            }
        }
        string environment_display = l.environment.capitaliseFirstLetter();
        if (l.environment == "unknown" || l.environment == "none" || l.environment == "")
        	environment_display = "Unknown";
        if (plant_data.count() == 0)// && l.environment != "unknown" && l.environment != "none" && l.environment != "")
        {
            if (l == $location[The Valley of Rof L'm Fao])
                plant_data.listAppend(l.environment.replace_string("o", "0"));
            else if (!($locations[The Prince's Restroom,The Prince's Dance Floor,The Prince's Kitchen,The Prince's Balcony,The Prince's Lounge,The Prince's Canapes table,the shore\, inc. travel agency] contains l))
                plant_data.listAppend(environment_display);
        }
    }
    
    
    /*int [location] pressure_penalties;
    pressure_penalties[$location[The Briny Deeps]] = 25;
    pressure_penalties[$location[The Brinier Deepers]] = 50;
    pressure_penalties[$location[The Briniest Deepests]] = 75;
    foreach loc in $locations[An Octopus's Garden,The Wreck of the Edgar Fitzsimmons,Madness Reef,The Mer-Kin Outpost,The Skate Park,The Coral Corral]
        pressure_penalties[loc] = 100;
    foreach loc in $locations[Mer-kin Colosseum,Mer-kin Library,Mer-kin Gymnasium,Mer-kin Elementary School]
        pressure_penalties[loc] = 150;
    foreach loc in $locations[The Marinara Trench,Anemone Mine,The Dive Bar,The Caliginous Abyss]
        pressure_penalties[loc] = 200;*/
    
    
    string custom_location_information;
    string custom_location_url;
    if (l == $location[domed city of ronaldus])
    {
        int ronald_phase = moon_phase() % 8;
        if (ronald_phase == 4)
            custom_location_information = "30% aliens";
        else if (ronald_phase < 2 || ronald_phase > 6)
            custom_location_information = "No aliens";
        else
            custom_location_information = "15% aliens";
    }
    else if (l == $location[domed city of grimacia])
    {
        int grimace_phase = moon_phase() / 2;
        if (grimace_phase == 4)
            custom_location_information = "30% aliens";
        else if (grimace_phase < 2 || grimace_phase > 6)
            custom_location_information = "No aliens";
        else
            custom_location_information = "15% aliens";
    }
    else if (l == $location[a-boo peak])
    {
        if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0)
        {
            custom_location_information = __quest_state["Level 9"].state_int["a-boo peak hauntedness"] + "% haunted";
        }
    }
    else if (l == $location[oil peak])
    {
        if (__quest_state["Level 9"].state_float["oil peak pressure"] > 0.0)
        {
            float pressure = __quest_state["Level 9"].state_float["oil peak pressure"];
            float pressure_remaining = pressure / 310.66;
            custom_location_information = round(clampNormalf(pressure_remaining) * 100.0) + "% pressure";
        }
    }
    else if (l == $location[Inside the Palindome])
    {
        if (!__quest_state["Level 11 Palindome"].state_boolean["dr. awkward's office unlocked"])
        {
            float likelyhood_of_dudes = 0.0;
            foreach m in monster_appearance_rates
            {
                if (monster_appearance_rates[m] <= 0.0)
                    continue;
                if (m == $monster[none])
                    continue;
                if (m == $monster[Bob Racecar] || m == $monster[Racecar Bob] || m == $monster[Drab Bard])
                    likelyhood_of_dudes += monster_appearance_rates[m];
            }
            custom_location_information = likelyhood_of_dudes.round() + "% dudes";
        }
    }
    else if (l == $location[the hidden bowling alley])
    {
    	int pygmy_banishes_left = clampi(11 - get_property_int("_drunkPygmyBanishes"), 0, 11);
    	if ($item[bowl of scorpions].item_amount() > 0 && !$monster[drunk pygmy].is_banished() && pygmy_banishes_left > 0)
        {
        	custom_location_information = pluralise(pygmy_banishes_left, "drunk pygmy", "drunk pygmies") + " left";
        }   
    }
    /*else if (l == $location[twin peak]) //disabled, not very useful
    {
        string [int] entries;
        
        if (!__quest_state["Level 9"].state_boolean["Peak Stench Completed"])
            entries.listAppend(HTMLGenerateSpanOfClass("room 237", "r_element_stench_desaturated"));
        if (!__quest_state["Level 9"].state_boolean["Peak Item Completed"])
            entries.listAppend("pantry");
        if (!__quest_state["Level 9"].state_boolean["Peak Jar Completed"])
            entries.listAppend("music");
        if (!__quest_state["Level 9"].state_boolean["Peak Init Completed"])
            entries.listAppend("you");
        custom_location_information = entries.generateLocationBarModifierEntries();
    }*/
    else if (l == $location[the arid\, extra-dry desert])
    {
        if (__quest_state["Level 11 Desert"].state_int["Desert Exploration"] < 100)
        {
            custom_location_information = __quest_state["Level 11 Desert"].state_int["Desert Exploration"] + "% explored";
        }
    }
    else if (l == $location[barrrney's barrr])
    {
        if (!__quest_state["Pirate Quest"].finished)
        {
            custom_location_information = pluralise(__quest_state["Pirate Quest"].state_int["insult count"], "insult", "insults");
        }
    }
    else if ($locations[Dreadsylvanian Woods,Dreadsylvanian Village,Dreadsylvanian Castle,The Slime Tube,A Maze of Sewer Tunnels,Hobopolis Town Square,Burnbarrel Blvd.,Exposure Esplanade,The Heap,The Ancient Hobo Burial Ground,The Purple Light District] contains l)
    {
        custom_location_information = "Clan logs";
        custom_location_url = "clan_raidlogs.php";
    }
    else if (l == $location[the defiled alcove])
        custom_location_information = __quest_state["Level 7"].state_int["alcove evilness"] + " evilness";
    else if (l == $location[the defiled nook])
        custom_location_information = __quest_state["Level 7"].state_int["nook evilness"] + " evilness";
    else if (l == $location[the defiled cranny])
        custom_location_information = __quest_state["Level 7"].state_int["cranny evilness"] + " evilness";
    else if (l == $location[the defiled niche])
        custom_location_information = __quest_state["Level 7"].state_int["niche evilness"] + " evilness";
    else if (l == $location[the battlefield (hippy uniform)])
        custom_location_information = pluralise(__quest_state["Level 12"].state_int["frat boys left on battlefield"], "frat boy", "frat boys");
    else if (l == $location[the battlefield (frat uniform)])
        custom_location_information = pluralise(__quest_state["Level 12"].state_int["hippies left on battlefield"], "hippy", "hippies");
    else if ($locations[The Briny Deeps,The Brinier Deepers,The Briniest Deepests,An Octopus's Garden,The Wreck of the Edgar Fitzsimmons,Madness Reef,The Mer-Kin Outpost,The Skate Park,The Coral Corral,Mer-kin Colosseum,Mer-kin Library,Mer-kin Gymnasium,Mer-kin Elementary School,The Marinara Trench,Anemone Mine,The Dive Bar,The Caliginous Abyss] contains l || (l == $location[The Ice Hole] && l != $location[none]))
    {
        Error error;
        float pressure_penalty = l.pressurePenaltyForLocation(error);
        custom_location_information = pressure_penalty.floor() + "% pressure";
        if (error.was_error)
            custom_location_information = "Unknown pressure";
        /*int pressure_penalty = MAX(0, -numeric_modifier("item drop penalty"));
        if (l == my_location())
            custom_location_information = pressure_penalty + "% pressure";
        else //numeric_modifier is location sensitive
            custom_location_information = "Unknown pressure";*/
    }
    else if ($locations[The Prince's Restroom,The Prince's Dance Floor,The Prince's Kitchen,The Prince's Balcony,The Prince's Lounge,The Prince's Canapes table] contains l)
    {
        int minutes_to_midnight = get_property_int("cinderellaMinutesToMidnight");
        if (minutes_to_midnight > 0)
            custom_location_information = pluralise(minutes_to_midnight, "minute", "minutes") + " left";
    }
    else if ($locations[Ye Olde Medievale Villagee,Portal to Terrible Parents,Rumpelstiltskin's Workshop] contains l)
    {
        int turns_left = clampi(30 - get_property_int("rumpelstiltskinTurnsUsed"), 0, 30);
        custom_location_information = pluralise(turns_left, "turn", "turns") + " left";
    }
    else if (l == $location[fernswarthy's basement])
    {
        custom_location_information = "Floor " + __misc_state_int["Basement Floor"];
    }
    else if ($locations[Your Bung Chakra,Your Guts Chakra,Your Liver Chakra,Your Nipple Chakra,Your Nose Chakra,Your Hat Chakra,Crimbo's Sack,Crimbo's Boots,Crimbo's Jelly,Crimbo's Reindeer,Crimbo's Beard,Crimbo's Hat] contains l)
    {
        string [location] property_name_for_location;
        property_name_for_location[$location[Your Bung Chakra]] = "crimbo16BungChakraCleanliness";
        property_name_for_location[$location[Your Guts Chakra]] = "crimbo16GutsChakraCleanliness";
        property_name_for_location[$location[Your Liver Chakra]] = "crimbo16LiverChakraCleanliness";
        property_name_for_location[$location[Your Nipple Chakra]] = "crimbo16NippleChakraCleanliness";
        property_name_for_location[$location[Your Nose Chakra]] = "crimbo16NoseChakraCleanliness";
        property_name_for_location[$location[Your Hat Chakra]] = "crimbo16HatChakraCleanliness";
        property_name_for_location[$location[Crimbo's Sack]] = "crimbo16SackChakraCleanliness";
        property_name_for_location[$location[Crimbo's Boots]] = "crimbo16BootsChakraCleanliness";
        property_name_for_location[$location[Crimbo's Jelly]] = "crimbo16JellyChakraCleanliness";
        property_name_for_location[$location[Crimbo's Reindeer]] = "crimbo16ReindeerChakraCleanliness";
        property_name_for_location[$location[Crimbo's Beard]] = "crimbo16BeardChakraCleanliness";
        property_name_for_location[$location[Crimbo's Hat]] = "crimbo16CrimboHatChakraCleanliness";
        
        string property_name = property_name_for_location[l];
        if (property_name != "")
        {
            custom_location_information = get_property_int(property_name) + "% clean";
        }
    }
        
    //else if (pressure_penalties contains l)
        //custom_location_information = pressure_penalties[l] + "% pressure";
    
    string [int] monster_data;
    if (false)
    {
        boolean even_appearance_rates = true;
        float last_seen_rate = -10000.0;
        foreach m in monster_appearance_rates
        {
            if (m == $monster[none])
                continue;
            float rate = monster_appearance_rates[m];
            if (rate <= 0.0)
                continue;
            if (last_seen_rate == -10000.0)
                last_seen_rate = rate;
            else if (rate != last_seen_rate)
            {
                even_appearance_rates = false;
                break;
            }
                
        }
        foreach m in monster_appearance_rates
        {
            if (m == $monster[none])
                continue;
            float rate = monster_appearance_rates[m];
            if (rate <= 0.0)
                continue;
            if (even_appearance_rates)
                monster_data.listAppend(m.to_string());
            else
                monster_data.listAppend(m.to_string() + " (" + rate.round() + "%)");
        }
    }
    
    float mpa = -1.0;
    boolean should_output_meat_drop = false;
    if (false) //disabled for the moment, still thinking about this. is it really that useful...?
    {
        float base_mpa = 0.0;
        float total_appearance = 0.0;
        foreach m in monster_appearance_rates
        {
            if (m == $monster[none])
                continue;
            float rate = monster_appearance_rates[m];
            if (rate <= 0.0)
                continue;
            
            float average_meat = (m.min_meat + m.max_meat) * 0.5;
            
            total_appearance += rate;
            base_mpa += average_meat * rate;
        }
        if (total_appearance != 0.0)
        {
            base_mpa /= total_appearance;
            mpa = base_mpa * (1.0 + meat_drop_modifier() / 100.0);
        }
        if (numeric_modifier(my_familiar(), "meat drop", familiar_weight(my_familiar()), $slot[familiar].equipped_item()) > 0.0)
            should_output_meat_drop = true;
        if (l == $location[the themthar hills])
            should_output_meat_drop = true;
    }
    
    string [int] location_data;
    string [int] location_urls;
    float [int] location_fixed_widths;
    
    if (true) //__misc_state["in run"]) //useful even in aftercore
    {
        int area_delay = l.delayRemainingInLocation();
        
        int turns_spent = l.turns_spent;
        if (area_delay > 0)
            location_data.listAppend(pluralise(area_delay, "turn", "turns") + "<br>delay");
        else if (turns_spent > 0)
            location_data.listAppend(pluralise(turns_spent, "turn", "turns"));
    }
    
    //easy list:
    //FIXME just use that test instead?
    //ashq foreach l in $locations[] if (l.appearance_rates().count() == 1 && l.appearance_rates()[$monster[none]] == 100.0) print(l);
    boolean [location] nc_blocklist = $locations[Pump Up Muscle,Pump Up Mysticality,Pump Up Moxie,The Shore\, Inc. Travel Agency,Goat Party,Pirate Party,Lemon Party,The Roulette Tables,The Poker Room,Anemone Mine (Mining),The Knob Shaft (Mining),Friar Ceremony Location,Itznotyerzitz Mine (in Disguise),The Prince's Restroom,The Prince's Dance Floor,The Prince's Kitchen,The Prince's Balcony,The Prince's Lounge,The Prince's Canapes table,Portal to Terrible Parents,fernswarthy's basement];
    
    if ((my_buffedstat($stat[moxie]) < average_ml || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE) && sample_count > 0 && __misc_state["in run"] && monster_level_adjustment() < 100)
    {
        //Init:
        //We only show this if the monsters out-moxie the player in-run. It feels as though it can easily be information overload otherwise.
        if (true)
        {
            if (chance_of_jump == 0 && false)
                location_data.listAppend("No jump");
            else
                location_data.listAppend((chance_of_jump * 100.0).round() + "% jump");
        }
        else if (true)
        {
            if (chance_of_jump <= 0.0)
                location_data.listAppend(max_init.round() + "% init<br>" + (chance_of_jump * 100.0).round() + "% jump");
            else
                location_data.listAppend((chance_of_jump * 100.0).round() + "% jump");
        }
        else if (false)
        {
            string line;
            if (chance_of_jump >= 1.0)
                line = "100% jump";
            else
                line = max_init.round() + "% init<br>" + (chance_of_jump * 100.0).round() + "% jump";
            location_data.listAppend(line);
        }
        else if (chance_of_jump < 1.0)
        {
            if (false)
                location_data.listAppend(max_init.round() + "% init<br>" + (chance_of_jump * 100.0).round() + "% jump");
            else
                location_data.listAppend((chance_of_jump * 100.0).round() + "% jump");
        }
    }
    if (nc_rate > 0.0 && !(nc_blocklist contains l))
        location_data.listAppend(nc_rate + "% NCs");
    if (custom_location_information != "")
    {
        location_data.listAppend(custom_location_information);
        if (custom_location_url != "")
            location_urls[location_data.count() - 1] = custom_location_url;
    }
    
    if (my_path_id() == PATH_HEAVY_RAINS)
    {
        boolean has_items_that_will_wash_away = false;
        
        foreach key, m in l.get_monsters()
        {
            foreach it, drop_rate in m.item_drops()
            {
                if (drop_rate == 0)
                    continue;
                if (drop_rate == 100)
                    continue;
                if (it.quest)
                    continue;
                has_items_that_will_wash_away = true;
                break;
            }
            if (has_items_that_will_wash_away)
                break;
        }
        
        if (has_items_that_will_wash_away)
        {
            //Calculate washaway chance:
            boolean unknown_washaway = false;
            int current_water_level = l.water_level_of_location();
            
            int washaway_chance = current_water_level * 5;
            if ($item[fishbone catcher's mitt].equipped_amount() > 0)
                washaway_chance -= 15; //GUESS
            
            if ($effect[Fishy Whiskers].have_effect() > 0)
            {
                //washaway_chance -= ?; //needs spading
                unknown_washaway = true;
            }
            if (unknown_washaway)
                location_data.listAppend("?% wash");
            else
                location_data.listAppend(washaway_chance + "% wash");
        }
    }
    if (mpa != -1.0 && should_output_meat_drop)
    {
        location_data.listAppend(mpa.round() + " MPA");
    }
    if (monster_data.count() > 0)
    {
        location_data.listAppend(pluralise(monster_data.count(), "monster", "monsters"));
    }
    if (my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING)
    {
        float average_coins_gained = 0.0;
        foreach m, rate in monster_appearance_rates
        {
            if (rate <= 0) continue;
            float coin_from_monster = m.ka_dropped();
            //NC should already be included in appearance rates?
            average_coins_gained += coin_from_monster * rate / 100.0;
        }
        if (average_coins_gained <= 0.0)
            location_data.listAppend("No ka");
        else
            location_data.listAppend(average_coins_gained.roundForOutput(1) + " ka");
    }
    
    boolean [location] powerleveling_locations = $locations[hamburglaris shield generator,video game level 1,video game level 2,video game level 3];
    
    if (sample_count > 0 && (__misc_state["in run"] || powerleveling_locations contains l || average_ml > my_buffedstat($stat[moxie])))
    {
        if (false)
            location_data.listAppend(average_ml.round() + " ML<br>" + (average_ml * __misc_state_float["ML to mainstat multiplier"]).round() + " " + my_primestat().to_lower_case() + "/fight");
        else
            location_data.listAppend(average_ml.round() + " ML");
    }
    
    if (in_bad_moon())
    {
        boolean bad_moon_adventure_possible_now = false;
        boolean bad_moon_adventure_possible = false;
        
        BadMoonAdventure [int] bad_moon_adventures = BadMoonAdventuresForLocation(l);
        
        if (bad_moon_adventures.count() > 0)
        {
            foreach key, adventure in bad_moon_adventures
            {
                boolean possible = !haveSeenBadMoonEncounter(adventure.encounter_id);
                if (possible)
                    bad_moon_adventure_possible = possible;
                if (!bad_moon_adventure_possible_now)
                    bad_moon_adventure_possible_now = !adventure.has_additional_requirements_not_yet_met;
            }
        }
        
        if (bad_moon_adventure_possible)
        {
            string style = "margin-top:1px;";
            if (!bad_moon_adventure_possible_now)
                style += "opacity:0.25;";
            string image_html = HTMLGenerateTagPrefix("img", mapMake("src", __bad_moon_small_image_data, "style", style)); //"images/itemimages/badmoon.gif"
            location_data.listAppend(image_html);
            location_fixed_widths[location_data.count() - 1] = 0.15; //won't display otherwise
        }
    }
    
    if (plant_data.count() > 0)
    {
        string line;
        
        line = plant_data.generateLocationBarModifierEntries();
        
        
        if (__setting_location_bar_fixed_layout)
            line = HTMLGenerateDivOfClass(line, "r_location_bar_ellipsis_entry");
        location_data.listAppend(line);
        if (l == __last_adventure_location || true)
            location_urls[location_data.count() - 1] = "place.php?whichplace=forestvillage&amp;action=fv_friar";
    }
    if (true)
    {
        //Holding containers:
        string style;
        if (!__setting_newstyle_navbars)
        {
            if (displaying_navbar)
                style += "bottom:" + __setting_navbar_height + ";";
            else
                style += "bottom:0px;";
        }
        else
        {
        	style += "position:relative;z-index:6;";
        }
        string onmouseenter_code;
        string onmouseleave_code;
        
        if (__setting_enable_location_popup_box)
        {
            onmouseenter_code = "alterLocationPopupBarVisibility(event, true);";
            onmouseleave_code = "alterLocationPopupBarVisibility(event, false);";
        }
            
        string [string] outer_containiner_map = mapMake("id", "location_bar_outer_container", "class", "r_bottom_outer_container", "style", style);
        bar.HTMLAppendTagPrefix("div", outer_containiner_map);
        
        string [string] inner_containiner_map = mapMake("id", "location_bar_inner_container", "class", "r_bottom_inner_container", "style", "background:white;");
        if (onmouseenter_code != "")
            inner_containiner_map["onmouseenter"] = onmouseenter_code;
        if (onmouseleave_code != "")
            inner_containiner_map["onmouseleave"] = onmouseleave_code;
        bar.HTMLAppendTagPrefix("div", inner_containiner_map);
    }
    
    
    
    
    
    string [int] table_entries;
    string [int] table_entry_urls;
    string [int] table_entry_styles;
    string [int] table_entry_classes;
    float [int] table_entry_width_weight;
    float [int] table_entry_fixed_width_percentage;
    if (true)
    {
        buffer style;
        if (location_data.count() > 0)
            style.append("text-align:left;");
        style.append("padding-left:" + __setting_indention_width + ";");
        //style.append("text-wrap:none;");
        //style.append("overflow:hidden;");
        //style.append("white-space:nowrap;");
        //style.append("text-overflow:clip;");

        string l_name = l.to_string();
        
        if (__setting_location_bar_fixed_layout)
            l_name = HTMLGenerateDivOfClass(l_name, "r_location_bar_ellipsis_entry");
        
        //table_entries.listAppend(HTMLGenerateTagWrap("div", l_name, mapMake("class", "r_bold", "style", style)));
        table_entries.listAppend(l_name);
        table_entry_classes[table_entries.count() - 1] = "r_bold";
        table_entry_styles[table_entries.count() - 1] = style;
        table_entry_width_weight[table_entries.count() - 1] = 1.05;
    }
    table_entries.listAppendList(location_data);
    foreach key in location_urls
    {
        table_entry_urls[key + 1] = location_urls[key];
    }
    foreach key in location_fixed_widths
    {
        table_entry_fixed_width_percentage[key + 1] = location_fixed_widths[key];
    }
    foreach key in location_data
    {
        table_entry_width_weight[key + 1] = 0.8;
    }
    
    
    
    bar.append(generateLocationBarTable(table_entries, table_entry_urls, table_entry_styles, table_entry_classes, table_entry_width_weight, table_entry_fixed_width_percentage, url));
    
    

    //bar.append("</div>");
    
    
    
    
    bar.append("</div>");
    bar.append("</div>");
    
    float bottom_coordinates = __setting_navbar_height_in_em;
    if (displaying_navbar)
        bottom_coordinates = __setting_navbar_height_in_em * 2.0;
    bar.append(generateLocationPopup(bottom_coordinates, (table_entries.count() == 1)));
    return bar;
}
//Support auto-refreshing guide while editing code:
static
{
    string __last_compile_time = "";
    __last_compile_time = now_to_string("kmsS");
}

string [string] generateAPIResponse()
{
    //35ms response time measured in-run
    string [string] result;
    
    boolean should_force_reload = false;
    
    if (should_force_reload)
    {
        result["need to reload"] = should_force_reload;
        return result;
    }
    
    //Unique identifiers to determine whether a reload is necessary:
    //All of these will be checked by the javascript.
    result["turns played"] = my_turncount();
    result["hp"] = my_hp();
    result["mp"] = my_mp();
    result["+ml"] = monster_level_adjustment();
    result["+init"] = initiative_modifier();
    result["combat rate"] = combat_rate_modifier();
    result["+item"] = item_drop_modifier();
    result["familiar"] = my_familiar().to_int();
    result["adventures remaining"] = my_adventures();
    result["meat available"] = my_meat();
    result["stills available"] = stills_available();
    result["enthroned familiar"] = my_enthroned_familiar();
    result["bjorned familiar"] = my_bjorned_familiar();
    result["pulls remaining"] = pulls_remaining();
    result["location"] = my_location();
    
    if (true)
    {
        int [effect] my_effects = my_effects();
        int total_effect_length = 0;
        foreach e in my_effects
            total_effect_length += my_effects[e];
        
        result["effect count"] = my_effects.count();
        result["total effect length"] = total_effect_length;
    }
    result["fullness available"] = availableFullness();
    result["drunkenness available"] = availableDrunkenness();
    result["spleen available"] = availableSpleen();
    result["auto attack id"] = get_auto_attack(); //for copied monsters warning, don't want that to be stale
    
    if (true)
    {
        result["equipped items"] = equipped_items().to_json();
    }
    
    if (false)
    {
        //if we need a clockwork maid? maybe?
        result["campground items"] = get_campground().to_json();
    }
    if (__iotms_usable[$item[Order of the Green Thumb Order Form]])
    {
        int plant_count = 0;
        string [location, 3] florist_plants = get_florist_plants();
        foreach l in florist_plants
        {
            foreach key in florist_plants[l]
            {
                if (florist_plants[l][key] != "")
                    plant_count+= 1;
            }
        }
        result["plant count"] = plant_count;
    }
    
    if (true)
    {
        //Before discovering get_inventory() existed, this was very intensive - 40ms API load versus 25ms, or 28ms versus 16ms;
        //With get_inventory(), maybe it won't be a problem? In-run, it's about 0.2ms.
        int item_count = 0;
        foreach it, amount in get_inventory()
            item_count += amount;
        result["item count"] = item_count;
    }
    if (true)
    {
        //When foldables change, item count does not, so we need to manually watch them:
        //FIXME probably spooky putty/etc?
        int [int] output;
        boolean [item] relevant_items_strings = lookupItemsArray($strings[deceased crimbo tree,broken champagne bottle,tinsel tights,wad of used tape,makeshift garbage shirt,flimsy hardwood scraps]);
        foreach it in relevant_items_strings
        {
            if (it.available_amount() > 0)
                output[it.to_int()] = it.available_amount();
        }
        
        result["relevant items"] = output.to_json();
    }
    /*else if (true)
    {
        //Checking every item is slow. But certain items won't trigger a reload, but need to. So:
        boolean [item] relevant_items = $items[photocopied monster,4-d camera,pagoda plans,Elf Farm Raffle ticket,skeleton key,heavy metal thunderrr guitarrr,heavy metal sonata,Hey Deze nuts,rave whistle,damp old boot,map to Professor Jacking's laboratory,world's most unappetizing beverage,squirmy violent party snack,White Citadel Satisfaction Satchel,rusty screwdriver,giant pinky ring,The Lost Pill Bottle,GameInformPowerDailyPro magazine,dungeoneering kit,Knob Goblin encryption key,dinghy plans,Sneaky Pete's key,Jarlsberg's key,Boris's key,fat loot token,bridge,chrome ore,asbestos ore,linoleum ore,csa fire-starting kit,tropical orchid,stick of dynamite,barbed-wire fence,psychoanalytic jar,digital key,Richard's star key,star hat,star crossbow,star staff,star sword,Wand of Nagamar,Azazel's tutu,Azazel's unicorn,Azazel's lollipop,smut orc keepsake box,blessed large box,massive sitar,hammer of smiting,chelonian morningstar,17-alarm saucepan,shagadelic disco banjo,squeezebox of the ages,E.M.U. helmet,E.M.U. harness,E.M.U. joystick,E.M.U. rocket thrusters,E.M.U. unit,wriggling flytrap pellet,Mer-kin trailmap,Mer-kin stashbox,Makeshift yakuza mask,Novelty tattoo sleeves,strange goggles,zaibatsu level 2 card,zaibatsu level 3 card,flickering pixel,jar of oil,bowl of scorpions,molybdenum magnet,steel lasagna,steel margarita,steel-scented air freshener,Grandma's Map,mer-kin healscroll,scented massage oil,soggy used band-aid,extra-strength red potion,red pixel potion,red potion,filthy poultice,gauze garter,green pixel potion,cartoon heart,red plastic oyster egg,Manual of Dexterity,Manual of Labor,Manual of Transmission,wet stunt nut stew,lost key,resolution: be more adventurous,sugar sheet,sack lunch,glob of Blank-Out,gaudy key,plus sign,Newbiesport&trade; tent,Frobozz Real-Estate Company Instant House (TM),dry cleaning receipt,book of matches,rock band flyers,jam band flyers,disassembled clover,continuum transfunctioner,UV-resistant compass,eyepatch,carton of astral energy drinks,astral hot dog dinner,astral six-pack,gym membership card,tattered scrap of paper,bowling ball, snow boards,reassembled blackbird,reconstituted crow,louder than bomb,odd silver coin,grimstone mask,empty rain-doh can,Lord Spookyraven's spectacles,lump of Brituminous coal,bone rattle,mer-kin knucklebone,spooky glove,steam-powered model rocketship,crappy camera,shaking crappy camera,hedge maze puzzle,ghost of a necklace,telegram from Lady Spookyraven,Lady Spookyraven's finest gown,recipe: mortar-dissolving solution,disposable instant camera,unstable fulminate,thunder thigh,aquaconda brain,lightning milk,White Citadel Satisfaction Satchel,handful of smithereens,Loathing Legion jackhammer,lynyrd skin,red zeppelin ticket,lynyrd snare,glark cable,Fernswarthy's key,bottle of G&uuml;-Gone,BURT,handful of juicy garbage,Jeff Goldblum larva,imbued seal-blubber candle,claw of the infernal seal,junk junk,sea lasso,seal tooth,worthless trinket,worthless gewgaw,worthless knick-knack,gnollish toolbox,poppy,opium grenade,talisman o' namsilat,toxic globule,yellow pixel,greek pasta spoon of peril,hellseal disguise,8042,uncapped red lava bottle,uncapped green lava bottle,uncapped blue lava bottle,capped red lava bottle,capped green lava bottle,capped blue lava bottle,insulated gold wire,little firkin,normal barrel,big tun,weathered barrel,dusty barrel,disintegrating barrel,moist barrel,rotting barrel,mouldering barrel,barnacled barrel,incriminating evidence,dangerous chemicals,kidnapped orphan,bat-oomerang,bat-jute,bat-o-mite,rad,cashew,stuffing fluffer];
        
        
        int [int] output;
        
        foreach it in relevant_items
        {
            if (it.available_amount() > 0)
                output[it.to_int()] = it.available_amount();
        }
        
        boolean [item] relevant_items_strings = lookupItemsArray($strings[cornucopia]);
        foreach it in relevant_items_strings
        {
            if (it.available_amount() > 0)
                output[it.to_int()] = it.available_amount();
        }
        
        result["relevant items"] = output.to_json();
    }*/
    
    /*if (true)
    {
        //Possibly switch to this in 17.7? It's slower by 4ms, but drastically simplifies implementation.
        //The other method is 9/10ms.
        //16ms:
        //result["mafia properties"] = get_all_properties("", false).to_json();
        //13ms:
        buffer mafia_properties;
        foreach property_name, property_value in get_all_properties("", false)
        {
            mafia_properties.append(property_value);
        }
        result["mafia properties"] = mafia_properties.to_string();
    }
    else if (true)*/
    if (true)
    {
        boolean [string] relevant_mafia_properties = $strings[merkinQuestPath,questF01Primordial,questF02Hyboria,questF03Future,questF04Elves,questF05Clancy,questG01Meatcar,questG02Whitecastle,questG03Ego,questG04Nemesis,questG05Dark,questG06Delivery,questI01Scapegoat,questI02Beat,questL02Larva,questL03Rat,questL04Bat,questL05Goblin,questL06Friar,questL07Cyrptic,questL08Trapper,questL09Topping,questL10Garbage,questL11MacGuffin,questL11Manor,questL11Palindome,questL11Pyramid,questL11Worship,questL12War,questL13Final,questM01Untinker,questM02Artist,questM03Bugbear,questM04Galaktic,questM05Toot,questM06Gourd,questM07Hammer,questM08Baker,questM09Rocks,questM10Azazel,questM11Postal,questM12Pirate,questM13Escape,questM14Bounty,questM15Lol,questS01OldGuy,questS02Monkees,sidequestArenaCompleted,sidequestFarmCompleted,sidequestJunkyardCompleted,sidequestLighthouseCompleted,sidequestNunsCompleted,sidequestOrchardCompleted,cyrptAlcoveEvilness,cyrptCrannyEvilness,cyrptNicheEvilness,cyrptNookEvilness,desertExploration,gnasirProgress,relayCounters,timesRested,currentEasyBountyItem,currentHardBountyItem,currentSpecialBountyItem,volcanoMaze1,_lastDailyDungeonRoom,seahorseName,chasmBridgeProgress,_aprilShower,lastAdventure,lastEncounter,_floristPlantsUsed,_fireStartingKitUsed,_psychoJarUsed,hiddenHospitalProgress,hiddenBowlingAlleyProgress,hiddenApartmentProgress,hiddenOfficeProgress,pyramidPosition,parasolUsed,_discoKnife,lastPlusSignUnlock,olfactedMonster,photocopyMonster,lastTempleUnlock,volcanoMaze1,blankOutUsed,peteMotorbikeCowling,peteMotorbikeGasTank,peteMotorbikeHeadlight,peteMotorbikeMuffler,peteMotorbikeSeat,peteMotorbikeTires,_petePeeledOut,_navelRunaways,_peteRiotIncited,_petePartyThrown,hiddenTavernUnlock,_dnaPotionsMade,_psychokineticHugUsed,dnaSyringe,_warbearGyrocopterUsed,questM20Necklace,questM21Dance,grimstoneMaskPath,cinderellaMinutesToMidnight,merkinVocabularyMastery,_pirateBellowUsed,questM21Dance,_defectiveTokenChecked,questG07Myst,questG08Moxie,questESpClipper,questESpGore,questESpJunglePun,questESpFakeMedium,questESlMushStash,questESlAudit,questESlBacteria,questESlCheeseburger,questESlCocktail,questESlSprinkles,questESlSalt,questESlFish,questESlDebt,_pickyTweezersUsed,_bittycar,questESpSerum,questESpOutOfOrder,_shrubDecorated,questESpEVE,questESpSmokes,questG09Muscle,_rapidPrototypingUsed,nsTowerDoorKeysUsed,_chateauDeskHarvested,lastGoofballBuy,nsChallenge1,nsChallenge2,nsContestants1,nsContestants2,nsContestants3,lastDesertUnlock,questM18Swamp,edPiece,warehouseProgress,questEStFishTrash,questEStNastyBears,questEStSocialJusticeI,questEStSocialJusticeII,questEStSuperLuber,questEStZippityDooDah,_summonAnnoyanceUsed,questEStWorkWithFood,questM24Doc,questEStGiveMeFuel,_mayoTankSoaked,_feastUsed,spelunkyNextNoncombat,spelunkySacrifices,spelunkyStatus,spelunkyUpgrades,spelunkyWinCount,_deckCardsDrawn,_glarkCableUses,_banderRunaways,questM25Armorer,pyramidBombUsed,_powerPillUses,nextAdventure,_barrelPrayer,questECoBucket,_machineTunnelsAdv,_snojoFreeFights,snojoSetting,_lastCombatStarted,batmanZone,batmanUpgrades,batmanTimeLeft,batmanStats,questLTTQuestByWire,questM26Oracle,sourceTerminalEducate1,sourceTerminalEducate2,sourceTerminalEnquiry,_sourceTerminalDigitizeUses,_sourceTerminalEnhanceUses,_sourceTerminalExtrudes,_detectiveCasesCompleted,_pottedTeaTreeUsed,lastIslandUnlock,falloutShelterChronoUsed,_timeSpinnerMinutesUsed,_lynyrdSnareUses,_noobSkillCount,_universeCalculated,_expertCornerCutterUsed,boomBoxSong,_questPartyFair,_questPartyFairQuest,_neverendingPartyFreeTurns,_latteRefillsUsed,_latteBanishUsed,_latteCopyUsed,_latteDrinkUsed,_kgbTranquilizerDartUses,banishedMonsters,lastLightsOutTurn,lastVoteMonsterTurn,_lastCombatStarted,_sausageFights,_saberMod,_saberForceMonster,_daycareRecruits,_daycareGymScavenges,_campAwayCloudBuffs,_campAwaySmileBuffs,moonTuned,zeppelinProtestors,questL11Ron,questL11Shen,questGuzzlr,_canSeekBirds,_birdOfTheDayMods,_pocketProfessorLectures,_thesisDelivered,crystalBallMonster,_feelLonelyUsed,_feelExcitementUsed,_feelPeacefulUsed,_feelEnvyUsed,_feelHatredUsed,_feelNostalgicUsed,_feelPrideUsed,_feelSuperiorUsed,_monstersMapped,mappingMonsters,retroCapeSuperhero,retroCapeWashingInstructions,shockingLickCharges,_pottedPowerPlant,backupCameraMode,_backUpUses,backupCameraReverserEnabled];
        
        if (false)
        {
            //Give full description:
            string [string] mafia_properties;
            foreach property_name in relevant_mafia_properties
            {
                mafia_properties[property_name] = get_property(property_name);
            }
            result["mafia properties"] = mafia_properties.to_json();
        }
        else
        {
            //Give partial description: (equivalent for equivalency testing)
            //65% smaller
            buffer mafia_properties;
            boolean first = true;
            foreach property_name in relevant_mafia_properties
            {
                //This could fail an update if two properties coincidentally update a certain way - i.e. "1" and "21" becoming "12" and "1" both would be "121" - but it's unlikely to happen, and the faster this is, the better.
                /*if (first)
                    first = false;
                else
                    mafia_properties.append(",");*/
                string value = get_property(property_name);
                mafia_properties.append(value);
            }
            result["mafia properties"] = mafia_properties.to_string();
        }
        result["logged in"] = playerIsLoggedIn();
    }
    if (my_path_id() == PATH_AVATAR_OF_WEST_OF_LOATHING || my_path_id() == PATH_AVATAR_OF_SNEAKY_PETE || my_path_id() == PATH_THE_SOURCE || my_path_id() == PATH_GELATINOUS_NOOB)
    {
        int skill_count = 0;
        foreach s in $skills[]
        {
            if (s.skill_is_usable())
                skill_count += 1;
        }
        result["skill_count"] = skill_count;
    }
    else if (true)
    {
        int relevant_skill_count = 0;
        foreach s in $skills[Gothy Handwave]
        {
            if (s.skill_is_usable())
                relevant_skill_count += 1;
        }
        result["relevant_skill_count"] = relevant_skill_count;
    }
    result["last compile time"] = __last_compile_time;
    
    result["monster_phylum"] = monster_phylum().to_string();
    return result;
}
buffer generateNavbar(Checklist [int] ordered_output_checklists)
{
    buffer navbar;
    
    string outer_style;
    if (!__setting_newstyle_navbars)
    	outer_style = "bottom:0px;";
    else
    	outer_style += "position:relative;z-index:6;";
    navbar.HTMLAppendTagPrefix("div", mapMake("id", "navigation_bar_outer_container", "class", "r_bottom_outer_container", "style", outer_style));
    navbar.HTMLAppendTagPrefix("div", "class", "r_bottom_inner_container", "style", "background:" + __setting_navbar_background_colour + ";");
    
    string [int] titles;
    foreach key in ordered_output_checklists
        titles.listAppend(ordered_output_checklists[key].title);
    
    if (titles.count() > 0)
    {
        int [int] each_width;
        //Calculate width of each title:
        if (__setting_navbar_has_proportional_widths)
        {
            int total_character_count = 0;
            foreach i in titles
            {
                string title = titles[i];
                int title_length = title.length();
                total_character_count += title_length;
            }
            if (total_character_count > 0)
            {
                foreach i in titles
                {
                    string title = titles[i];
                    float title_length = title.length();
                    
                    float calculating_value = (100.0 * title_length) / (to_float(total_character_count));
                    each_width[i] = floor(calculating_value);
                }					
            }
        }
        else
        {
            float remaining_width = 100.0;
            int number_done = 0;
            foreach i in titles
            {
                int shared_width = to_int(remaining_width / to_float(titles.count() - number_done));
                each_width[i] = shared_width;
                remaining_width -= shared_width;
                number_done += 1;
            }
        }
        boolean first = true;
        foreach i in titles
        {
            string title = titles[i];
            
            string onclick_javascript = "";
            
            //Cancel our usual link:
            onclick_javascript += "navbarClick(event,'" + HTMLConvertStringToAnchorID(title + " checklist container") + "')";
            
            navbar.HTMLAppendTagPrefix("a", mapMake("class", "r_a_undecorated", "href", "#" + HTMLConvertStringToAnchorID(title), "onclick", onclick_javascript));
            navbar.HTMLAppendTagPrefix("div", "class", "r_navbar_button_container", "style", "width:" + each_width[i] + "%;");
            
            //Vertical separator:
            if (first)
                first = false;
            else if (!__setting_gray_navbar)
                navbar.HTMLAppendDivOfClass("", "r_navbar_line_separator");
            
            string text_div = HTMLGenerateDivOfClass(title, "r_navbar_text");
            if (__use_table_based_layouts)
            {
                //Vertical centring with tables:
                navbar.append("<table style=\"border-spacing:0px;margin-left:auto;margin-right:auto;height:100%;\"><tr><td style=\"vertical-align:middle;\">");
                navbar.append(text_div);
                navbar.append("</td></tr></table>");
            }
            else if (true)
            {
                //Vertical centring with divs:
                //Which is to... tell the browser to act like a table.
                //Sorry.
                navbar.HTMLAppendTagPrefix("div", "style", "padding-left:1px;padding-right:1px;margin-left:auto;margin-right:auto;display:table;height:100%;min-height:" + __setting_navbar_height_in_em + "em;");
                navbar.HTMLAppendTagPrefix("div", "style", "display:table-cell;vertical-align:middle;");
                navbar.append(text_div);
                navbar.append("</div>");
                navbar.append("</div>");
            }
            else
            {
                //No vertical centring.
                navbar.append(text_div);
            }
            navbar.append("</div>");
            navbar.append("</a>");
        }
    }
    navbar.append("</div>");
    navbar.append("</div>");
    return navbar;
}
boolean __setting_resource_intra_text = true;

buffer generateResourceBar(Checklist [int] ordered_output_checklists)
{
	buffer bar;
	
    if (!playerIsLoggedIn())
        return bar;
    
    
    //Info container:
    //Use position:absolute in case the info container is too tall for the window.
    bar.append("<div style=\"position:relative;\">");
    bar.append("<div style=\"position:absolute;bottom:0px;width:100%;\">");
    //unused:
    //bar.append("<div style=\"width:100%;height:20px;opacity:0.0;\" id=\"resource_bar_info_container_shadow\"></div>");
    //bar.append("<div style=\"width:100%;height:20px;background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);\" id=\"resource_bar_info_container_shadow\"></div>");
    //bar.append("<div style=\"width:100%;height:20px;transition:opacity 0.25s;background-image:url(" + __importance_bar_gradient + ");background-repeat:repeat-x;transform:scaleY(-1);opacity:0.0;\" id=\"resource_bar_info_container_shadow\"></div>");
    
    
    bar.HTMLAppendTagWrap("div", "", mapMake("id", "r_location_popup_blackout_info_container", "class", "r_popup_blackout_class", "style", "z-index:1;"));
    
bar.append("<div style=\"background:white;width:100%;text-align:left;z-index:2;position:relative;display:flex;\" id=\"resource_bar_info_container\"></div>"); //display:none; //position:relative may break things?
    bar.append("</div>");
    bar.append("</div>");
    
    //Generate hide/show button:
    if (true)
    {
    	int size = 20; //30
    	bar.append("<div style=\"overflow:hidden;cursor:pointer;position:absolute;width:" + size + "px;height:" + size + "px;margin-top:-" + size + "px;font-size:" + (size - 2) + "px;font-weight:bold;color:" + __setting_line_colour + ";border-top:1px solid " + __setting_line_colour + ";background:white;border-right:1px solid " + __setting_line_colour + ";\" id=\"resource_bar_hide_show_button\" onclick=\"handleResourceBarClick();\">");
        bar.append("&nbsp;");
        bar.append("</div>");
    }
    //Setup:
    if (true)
    {
        //Holding containers:
        string style;
        style += "height:auto;";
        /*if (true)
            style += "bottom:" + (2 * __setting_navbar_height_in_em) + "em;";
        else
            style += "bottom:" + __setting_navbar_height + ";";*/
        
        style += "max-height:33vh;"; //overflow-y:auto; tends to show up for like one pixel. there should be a way to set a minimum threshold - one pixel doesn't matter
        //style += "transition:height 0.25s;";
        style += "transition:max-height 0.5s;";
        style += "width:100%;";
        style += "z-index:2;position:relative;";
        string onmouseenter_code;
        string onmouseleave_code;
        
            
        string [string] outer_containiner_map = mapMake("class", "", "style", style, "id", "resource_bar_outer_container");
        bar.HTMLAppendTagPrefix("div", outer_containiner_map);
        
        string [string] inner_containiner_map = mapMake("id", "resource_bar_inner_container", "class", "r_bottom_inner_container", "style", "height:auto;text-align:right;background-color:white;"); //text-align right so consumption is always bottom-right //text-align:right;
        if (onmouseenter_code != "")
            inner_containiner_map["onmouseenter"] = onmouseenter_code;
        if (onmouseleave_code != "")
            inner_containiner_map["onmouseleave"] = onmouseleave_code;
        bar.HTMLAppendTagPrefix("div", inner_containiner_map);
    }
    //Core
    
    //bar.append("stuff lol");
    boolean [string] seen_image_lookup_names_hack;
    
    
    boolean [string] tags_we_pay_attention_to = $strings[banish,free banish,daily free fight,free instakill,buff,consumption junction\, what's your function?];
    
    float [string] category_priority = {
    "":-100000,
    "consumption junction, what's your function?":-100001,
    "free instakill":120,
    "banish":109,
    "free banish":110,
    "daily free fight":100,
    "familiar":200, //fitts law this one, always upper-left
    "iotm":-9,
    "equipment":-10,
    "skill":-20,
    "combat skill":-20,
    "buff":-30,
    };
    
    //ran these choices through a deuteranomaly filter; instakills/banishes/daily free fights look like different intensities of the same colour, which is appropriate since they are very similar concepts. equipment and familiars are off somewhere else.
    //I am open to suggestions to better choices
    int [string] category_hardcoded_hues = {
    "free instakill":200,
    "banish":200 + 45,
    "free banish":200 + 45,
    "daily free fight":200 + 45*2,
    "iotm":70, //intentionally similar to equipment
    "equipment":60, //90
    "familiar":90+45,//200 + 240,
    "skill":30,
    "combat skill":30,
    "buff":30, //basically the same as skill
    };
    
    boolean [string] categories_to_not_flex = {"consumption junction, what's your function?":true};
    string [string] category_hardcoded_colours = {
    "consumption junction, what's your function?":"#FFFFFF",
    };
    
    string [string] shortened_category_names = 
    {
    	"familiar":"familiars",
    	"free instakill":"instakills",
    	"banish":"banishes",
        "free banish":"free banishes",
    	"equipment":"iotms",
    	"daily free fight":"fights",
    	"skill":"skills",
        "combat skill":"combat skills",
    	"buff":"buffs",
        "consumption junction, what's your function?":"nom noms",
    };
    
    string [string] readable_category_names = 
    {
    	"familiar":"Familiars",
    	"free instakill":"Free instakills",
    	"banish":"Banishes",
        "free banish":"Free Banishes",
    	"equipment":"Equipment",
    	"daily free fight":"Free fights",
    	"skill":"Skills",
        "combat skill":"Combat Skills",
    	"buff":"Buffs",
        "consumption junction, what's your function?":"Nom noms",
    };
    
    if (true)
    {
    	//debugging:
        foreach category, hue in category_hardcoded_hues
        {
            while (hue >= 360)
                hue -= 360;
            while (hue < 0)
                hue += 360;
            category_hardcoded_hues[category] = hue;
        }
    }
        //hues I like: 340, 245, 93, 193
    
    ChecklistEntry [string][int] output_entries;
    int total_entry_count = 0;
    foreach key, checklist in ordered_output_checklists
    {
    	//bar.append(checklist.title + ", ");
        if (checklist.title != "Resources") continue;
		sort checklist.entries by value.importance_level; //FIXME better
        foreach key2, entry in checklist.entries
        {
        	string category = "";
         
         	//Various categories.
          
            if (entry.image_lookup_name.contains_text("__familiar") && category == "") //FIXME do not if shortdesc is empty
            	category = "familiar";
            if (entry.image_lookup_name.contains_text("__skill") && category == "")
            	category = "skill";
            
            //FIXME unify with kolimage
            if (entry.image_lookup_name.stringHasPrefix("__item "))
            {
                item it = entry.image_lookup_name.substring(7).to_item();
                if (it != $item[none])
                {
                	if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains it.to_slot() && !($items[disco ball,observational glasses,inflatable duck,genie's turbane,insane tophat] contains it))
                    {
                    	if (!it.tradeable || it.historical_price() >= 10000000) //probably IOTM
	                 	   category = "equipment";
                    }
                }
                //if (it.combat) //only found double-ice in casual
                	//category = "combat item";
            }
            
         
         	if (entry.category != "")
            	category = entry.category;
         	//only combine things that are universal; we also use the tagging system for like, specific IOTMs
            if (entry.combination_tag != "" && tags_we_pay_attention_to[entry.combination_tag])
            	category = entry.combination_tag;
            
            if (category == "blank")
            	category = "";
            
            
            if (category == "" && false)
            	print_html("handle \"" + entry.image_lookup_name + "\"");
         
            if (!(output_entries contains category))
            	 output_entries[category][0] = entry;
            else
	        	output_entries[category].listAppend(entry);
            total_entry_count += 1;
        }
    }
    
    if (total_entry_count <= 0)
    {
    	buffer blank;
    	return blank;
    }
    
    string [int] category_order;
    
    foreach category in output_entries
    {
    	category_order.listAppend(category);
    }
    sort category_order by -category_priority[value];
    
    bar.append("<div id=\"flex_capacitor\" style=\"display:flex;flex-flow:row wrap;align-items:stretch;\">"); //flexbox
    //justify-content:flex-end;
    //justify-content:space-between;
    
    boolean setting_weird_flex = true;
    if (setting_weird_flex)
    {
    	//use media queries to adjust flex basis
        //I assume there's a "better" way to do this with columns? but it's hot out and I want something that works
        //maybe later
        //update: this was a terrible idea, do not
        
        bar.HTMLAppendTagPrefix("style", "type", "text/css");
        int last_minimum_width = total_entry_count * 30;
        //We go through each possibility of row counts.
        //Like if we only have one row of icons, two rows, three rows, etc.
        //Then we compute the width this would be, the entries per row, and set up media queries so CSS auto-adjusts the boxes so they are spaced evenly.
        //FIXME properly support this with regard to it not mattering anyways. How do we compute that...?
        //after 8, we reach the 1080p 33% limit
        for row_count from 1 to 8
        {
            int entries_per_row = ceiling(to_float(total_entry_count) / to_float(row_count));
            
            if (entries_per_row == 0) continue;
            string max_width_css = (100.0 / to_float(entries_per_row)) + "%";
            float percentage = to_float(row_count) / to_float(total_entry_count) * 100.0;
        	int minimum_width_for_this_row_count = entries_per_row * 30;
            
            
            //from past attempts:
            /*int suggested_pixel_size = 30;
            int total_available_width = minimum_width_for_this_row_count * row_count;
            int total_available_width_last = last_minimum_width * row_count;
            int max_suggested_pixel_size = MAX(30, ceiling(to_float(minimum_width_for_this_row_count) / to_float(entries_per_row)));*/
            
            
            //int max_suggested_pixel_size = MAX(30, floor(to_float(total_available_width_last - 1) / to_float(total_entry_count)));
            
            
            string media_query;
            if (row_count == 1)
            	media_query = "@media (min-width: " + minimum_width_for_this_row_count + "px)";
            else
            	media_query = "@media (min-width: " + minimum_width_for_this_row_count + "px) and (max-width: " + (last_minimum_width - 1) + "px)";
    		//PageAddCSSClass("div", "resource_entry", "flex-basis:" + suggested_pixel_size + "px", 0, media_query);
            //float percentage = 1.0 / to_float(entries_per_row) * 100.0;
            //percentage = to_float(total_entry_count - 1) / to_float(total_entry_count) * percentage; //slight wiggle room
            //percentage = 0.95 * percentage;
            
            
            //PageAddCSSClass("div", "resource_entry", "max-width:" + max_width + ";min-width:30px;flex-basis:" + percentage + "%;", 0, media_query);
            //we can't use the page's css classes, because those won't auto-update with our refreshing system
            bar.append(media_query);
            bar.append(" { ");
            bar.append("div.resource_entry {");
            bar.append("max-width:" + max_width_css + ";min-width:30px;flex-basis:" + percentage + "%;");
            bar.append(" } ");
            bar.append(" } ");
            
            
            //print_html(row_count + " minimum_width_for_this_row_count = " + minimum_width_for_this_row_count + " entries_per_row = " + entries_per_row + " max_suggested_pixel_size = " + max_suggested_pixel_size);
            //print_html(row_count + ", w= " + minimum_width_for_this_row_count + " tw = " + total_available_width + " max_suggested_pixel_size = " + max_suggested_pixel_size + " tec = " + total_entry_count + " percentage = " + percentage + "%");
      
            last_minimum_width = minimum_width_for_this_row_count;
        }
        bar.append("</style>");
    }
    PageAddCSSClass("div", "resource_entry", "flex-basis:30px;"); //base
    
    boolean no_break_category_lines = false; //wastes quite a bit of space; do not enable
    int next_assigned_id = 1;
    foreach key0, category in category_order
    {
    	if (false)
	    	print_html("category = \"" + category + "\" priority = " + category_priority[category]);
        
        int hue = -1;
        if (category_hardcoded_hues contains category)
        	hue = category_hardcoded_hues[category];
        string background_colour = "#FFFFFF";
        string background_colour_intense = "#DDDDDD";
        string background_colour_faded_out_alpha = "#FFFFFF";
        string background_color_slightly_transparent = "rgba(255,255,255,0.9)";
        if (category != "")
        {
        	if (category_hardcoded_colours contains category)
            {
            	background_colour = category_hardcoded_colours[category];
            }
        	else if (hue != -1)
            {
		        background_colour = "hsl(" + hue + ",100%, 90%)"; //70%, 85%
                background_colour_intense = "hsl(" + hue + ",100%, 70%)";
                background_colour_faded_out_alpha = "hsla(" + hue + ",100%, 90%, 0.0)"; 
                background_color_slightly_transparent = "hsla(" + hue + ",100%, 90%, 90%)"; 
            }
            else
            {
		        background_colour = "#DDDDDD";
                background_colour_intense = "black";
                background_colour_faded_out_alpha = "rgba(221, 221, 221, 0.0)"; 
            }
        }
        //else
            //category_background_style = "background-color:#DDDDDD;";
        if (false)
        {
        	//Black and white mode:
            //Disabled because it turns into a sea of grey.
            background_colour = "#FFFFFF";
            background_colour_intense = "#DDDDDD";
            background_colour_faded_out_alpha = "#FFFFFF";
            background_color_slightly_transparent = "rgba(255,255,255,0.9)";
            if (key0 % 2 == 1)
            {
		        background_colour = "#DDDDDD";
                background_colour_intense = "black";
                background_colour_faded_out_alpha = "rgba(221, 221, 221, 0.0)"; 
            }
        }
        string category_background_style = "";
        if (background_colour != "")
            category_background_style = "background-color:" + background_colour + ";";
            
            
        
        boolean have_overall_div = no_break_category_lines;
        string overall_div_extra_style = "";
        if (category == "consumption junction, what's your function?" && false)
        {
        	have_overall_div = true;
            overall_div_extra_style = "float:right;";
        }
        if (have_overall_div)
	        bar.append("<div style=\"display:inline-block;" + overall_div_extra_style + "\">");
         
         
        if (false)
        {
        	//failed attempt at sideways headers
            string shortened = shortened_category_names[category];
            if (shortened == "") shortened = category;
            bar.append("<div style=\"display:inline-block;width:30px;font-size:0.8em;text-align:center;" + category_background_style + "\">"); //height:calc(30px + 1.4em);
            //bar.append("<div style=\"width:15px;background-color:white;z-index:20;display:inline-block;transform:rotate(90deg);transform-origin:0 0;\">"); //width:" + (shortened.length() * 0.5) + "em;
            //bar.append(shortened);
            //bar.append("</div>");
            bar.append("</div>");
        }
         
        if (false)
        	bar.append("<span style=\"width:100%;font-size:0.8em;\">" + category + "</span><br>"); //wastes too much vertical space, requires(?) bo break lines
    	foreach key, entry in output_entries[category]
        {
            string found_shortdesc;
            string scanning_string = entry.subentries[0].header;
            if (entry.short_description != "")
            	found_shortdesc = entry.short_description;
            if (found_shortdesc == "" && scanning_string.contains_text(" to "))
            	found_shortdesc = scanning_string.group_string("([0-9]+ to [0-9]+)")[0][1].replace_string(" to ", "-");
            if (found_shortdesc == "")
	        	found_shortdesc = scanning_string.group_string("([~+-]*[0-9]+[,-]*[0-9]*[^ ]*) ")[0][1]; //[^\\(]* //allow commas
            if (entry.short_description == "blank")
            	found_shortdesc = "";

            //found_shortdesc = entry.subentries[0].header + " (" + found_shortdesc + ")";
            
            //if (found_shortdesc == "")
            	//found_shortdesc = entry.subentries[0].header.group_string("([^ ]+)")[0][1]; 
            
        	if (false && seen_image_lookup_names_hack[entry.image_lookup_name] && found_shortdesc == "") continue;
            
            string extra_style;
            if (entry.should_highlight)
            {
            	//extra_style += "box-sizing: border-box; border:1px solid black;";
                extra_style += "background: linear-gradient(to right, " + background_colour + " 0%," + background_colour_intense + " 100%);";
            }
            string float_direction = "left";
            
            int flex_grow = 1;
            if (categories_to_not_flex[category] && false) //incompatible with media queries
            	flex_grow = 0;
            string display_style = "display:inline-block;float:" + float_direction + ";";
            if (__setting_resource_intra_text)
	            display_style += "height:30px;position:relative;";
            else
	            display_style += "height:calc(30px + 1.2em);";
            display_style += "text-align:left;flex-grow:" + flex_grow + ";text-align:center;"; //width:30px;
            //flex-basis:30px;
            if (true)
            {
            	//justify-content:space-around;
            	//display_style = "display:flex;flex-flow:row wrap;flex-basis:30px;";
                //display_style = "flex-basis:30px;";
            	//display_style = "display:flex;flex-grow:1;flex-flow:row wrap;flex-basis:30px;align-items:flex-start;align-content:stretch;justify-content:space-around;";
            }
            //displayResourceBarPopupFor
            int this_resource_id = next_assigned_id; next_assigned_id += 1;
            entry.internal_processing_data["content_id"] = this_resource_id;
            foreach key2 in entry.subentries
            {
            	entry.internal_processing_data_subentry_content_id[key2] = this_resource_id;
            }
            
            string font_size = "1.0em"; //"0.8em";
            
            string [string] main_element_div_map = mapMake("style", display_style + "font-weight:bold;font-size:" + font_size + ";" + category_background_style + extra_style, "class", "resource_entry", "onmouseover", "displayResourceBarPopupFor(this);", "onmouseout", "cancelResourceBarPopup();");
            
            main_element_div_map["data-resource-id"] = this_resource_id;
            main_element_div_map["data-background-colour"] = background_colour;
            main_element_div_map["data-background-colour-faded-out-alpha"] = background_colour_faded_out_alpha;
            main_element_div_map["data-readable-category-name"] = readable_category_names[category];
            
            
            bar.HTMLAppendTagPrefix("div", main_element_div_map); 
            
        	//bar.append("<div style=\"" + display_style + "font-size:0.8em;" + category_background_style + extra_style + "\" class=\"resource_entry\">");
             //bar.append("<div style=\"" + display_style + "\">");
         
            if (entry.url != "")
            {
                string anchor_prefix_html = HTMLGenerateTagPrefix("a", mapMake("target", "mainpane", "href", entry.url, "class", "r_a_undecorated"));
                bar.append(anchor_prefix_html);
            }
         
         	//display:flex;flex-direction:column;flex-grow:1;flex-wrap:wrap;flex-basis:30px;
             //height:calc(30px + 0.8em);
         	//class=\"r_cl_l_container_highlighted\"
         
         	boolean enable_all_absolute_hack = false;
            if (enable_all_absolute_hack)
            {
                bar.append("<div style=\"position:relative;display:inline-block;vertical-align:top;\">");
                bar.append("<div style=\"position:absolute;display:inline-block;\">");   
         	}
            if (key == 0 && category != "")
            {
            	string shortened = shortened_category_names[category];
                if (shortened == "") shortened = category;
                bar.append("<div style=\"position:relative;display:inline;font-size:1.0em;font-weight:bold;visibility:hidden;\" id=\"category_" + key0 + "\">");
                bar.append("<div style=\"position:absolute;left:0px;top:calc(15px - 0.5em - 1px);background-color:white;z-index:20;padding:2px 2px 2px 2px;\">"); //width:" + (shortened.length() * 0.5) + "em;
                bar.append(shortened);
                bar.append("</div>");
                bar.append("</div>");
            }
            
            string image_name = entry.image_lookup_name;
            buffer image_cancel_html;
            if (entry.specific_image != "")
            {
            	image_name = entry.specific_image;
                if (false)
                {
                	//"tagging" - doesn't look good. we intentionally gave it a background but that looks worse
                    bar.append("<div style=\"position:relative;display:inline-block;\">");
                    bar.append("<div style=\"z-index:2;display:inline-block;position:absolute;left:15px;top:15px;" + category_background_style + "\">");
                    bar.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, Vec2iMake(15, 15), "", "mix-blend-mode:multiply;"));
                    bar.append("</div>");
                    image_cancel_html.append("</div>"); //position:relative
                }
            }
        	string image_html = KOLImageGenerateImageHTML(image_name, true, Vec2iMake(30, 30), "", "display:inline-block;mix-blend-mode:multiply;"); //float:left;
            bar.append(image_html);
            bar.append(image_cancel_html);
            
            
            
            if (found_shortdesc == "" && !__setting_resource_intra_text)
            	found_shortdesc = "&nbsp;";
            if (found_shortdesc != "")
            {
            	/*if (__setting_resource_intra_text)
                {
                	bar.append("<div style=\"position:relative;bottom:0px;\">");
                    bar.append(found_shortdesc);
                    bar.append("</div>");
                }*/
                
                string main_style = "display:inline-block;margin:0 0 0 0;width:100%;text-align:center;";
                if (__setting_resource_intra_text)
                {
                	main_style = "position:absolute;bottom:0px;";
                    if (false)
                    {
                    	main_style += "background:" + background_color_slightly_transparent + ";";
                    }
                    else
                    {
                    	main_style += "background:" + background_colour + ";";
                    }
                    string [int] font_size_for_character_count = {
                    1:"1.2em",
                    2:"1.2em",
                    3:"0.9em",
                    4:"0.85em",
                    5:"0.8em",
                    6:"0.8em",
                    7:"0.8em",
                    };
                    
                    int character_length = found_shortdesc.length();
                    if (font_size_for_character_count contains character_length)
                    {
                    	main_style += "font-size:" + font_size_for_character_count[character_length] + ";"; 
                    }
                    
                    if (false)
                    {
                    	//first appearance:
                    	main_style += "width:100%;";//text-align:right;";
                    }
                    else
                    {
                    	//second, right-aligned:
                        main_style += "right:0px;";
                        //main_style += "padding-left:0.2em;padding-top:0.1em;padding-right:0.1em;";
                        //main_style += "padding-left:0.3em;padding-top:0.2em;padding-right:0.1em;"; //rectangle
                        main_style += "padding-left:0.2em;padding-top:0.1em;padding-right:0.1em;border-radius:30%;"; //circle
                        
                    }
                }
            	bar.append("<div style=\"" + main_style + "\">");
                //bar.append("<center style=\"font-size:0.8em;color:black;\">"); //margin-top:-3px;
                //bar.append("<span style=\"margin-top:-13px;display:inline;\">");
                
                boolean relative_enabled = false;
                if (relative_enabled)
                {
                    bar.append("<div style=\"position:relative;display:inline-block;\">&nbsp;");
                    bar.append("<div style=\"position:absolute;display:inline-block;\">");
                }
            	bar.append(found_shortdesc);
                if (relative_enabled)
                {
                    bar.append("</div>");
                    bar.append("</div>");
                }
                
                //Small images don't "work" because they mix-blend into the darkness of the image.
                if (false && entry.specific_image != "")
                {
                    bar.append("<div style=\"position:relative;display:inline-block;\">");
                    bar.append(KOLImageGenerateImageHTML(entry.image_lookup_name, true, Vec2iMake(15, 15), "", "position:absolute;bottom:-3px;"));
                    bar.append("</div>");
                }
                //bar.append("</span>");
            	//bar.append("</center>");
                bar.append("</div>");
            }
            if (enable_all_absolute_hack)
            {
                bar.append("</div>");
                bar.append("</div>");
         	}
            if (entry.url != "")
                bar.append("</a>");
            bar.append("</div>");
         	seen_image_lookup_names_hack[entry.image_lookup_name] = true;   
        }
        if (have_overall_div)
        	bar.append("</div>");
        //if (category_order contains (key0 + 1))
	        //bar.append("|");
        //if (category_order contains (key0 + 1))
        	//bar.append("<div style=\"width:30px;height:calc(30px + 0.8em);display:inline-block;\"></div>");
    }
    bar.append("</div>"); //flexbox
    
    //if (no_break_category_lines)
	    //bar.append("<div style=\"float:none;\"></div>");
        
    bar.append("</div>");
    bar.append("</div>");
    return bar;
}


void setUpCSSStyles()
{
	string body_style = "";
    if (!__setting_use_kol_css)
    {
        //Base page look:
        body_style += "font-family:Arial,Helvetica,sans-serif;background-color:white;color:black;";
        PageAddCSSClass("a:link", "", "color:black;", -10);
        PageAddCSSClass("a:visited", "", "color:black;", -10);
        PageAddCSSClass("a:active", "", "color:black;", -10);
    }
    if (__setting_side_negative_space_is_dark)
        body_style += "background-color:" + __setting_dark_colour + ";";
    else
        body_style += "background-color:#FFFFFF;";
    body_style += "margin:0px;padding:0px;font-size:14px;";
    
    if (__setting_ios_appearance)
        body_style += "font-family:'Helvetica Neue',Arial, Helvetica, sans-serif;font-weight:lighter;";
    if (__setting_newstyle_navbars)
    	body_style += "overflow:hidden;";
    
    PageAddCSSClass("body", "", body_style, -11);
    
    PageAddCSSClass("body", "", "font-size:13px;", -11, __setting_media_query_medium_size);
    PageAddCSSClass("body", "", "font-size:12px;", -11, __setting_media_query_small_size);
    PageAddCSSClass("body", "", "font-size:12px;", -11, __setting_media_query_tiny_size);
    
    
    //PageAddCSSClass("body", "", "filter:brightness(85%) invert(1)  hue-rotate(180deg);", -11, "@media (prefers-color-scheme: dark)"); //welcome to moonside. disabled, because KOL is not dark mode
    
    
	PageAddCSSClass("", "r_clickable", "cursor:pointer;cursor:hand;user-select:none;-webkit-user-select:none;");
    PageAddCSSClass("", "r_clickable:hover", "background-color:" + "#CCCCCC" + ";");
	PageAddCSSClass("", "r_future_option", "color:" + __setting_unavailable_colour + ";");
	
    PageAddCSSClass("a", "r_cl_internal_anchor", "position:absolute;z-index:2;padding-top:" + __setting_navbar_height + ";display:inline-block;");
	
    PageAddCSSClass("", "r_button", "display:none;cursor:pointer;color:#7F7F7F;font-size:1.5em;");//z-index:3;position:absolute;"); //background:" + __setting_page_background_colour + ";
	
    PageAddCSSClass("div", "r_word_wrap_group", "display:inline-block;");
	
	if (true)
	{
		string hr_definition;
		hr_definition = "height: 1px; margin-top: 1px; margin-bottom: 1px; border: 0px; width: 100%;";
	
		hr_definition += "background: " + __setting_line_colour + ";";
		PageAddCSSClass("hr", "", hr_definition);
	}
	
	
    if (__setting_fill_vertical)
        PageAddCSSClass("div", "r_vertical_fill", "bottom:0;left:0;right:0;position:fixed;height:100%;margin-left:auto;margin-right:auto;");
    
    if (__setting_show_navbar)
    {
        PageAddCSSClass("div", "r_navbar_line_separator", "position:absolute;float:left;min-width:1px;min-height:" + __setting_navbar_height + ";background:" + __setting_line_colour + ";");
        PageAddCSSClass("div", "r_navbar_text", "text-align:center;font-weight:bold;font-size:.9em;");
        PageAddCSSClass("div", "r_navbar_button_container", "overflow:hidden;vertical-align:top;display:inline-block;min-height:" + __setting_navbar_height + ";");
        
        if (__setting_gray_navbar)
        {
            PageAddCSSClass("div", "r_navbar_line_separator", "display:none;");
            PageAddCSSClass("div", "r_navbar_text", "text-align:center;font-size:.9em;font-weight:normal;");
            PageAddCSSClass("div", "r_navbar_button_container", "overflow:hidden;vertical-align:top;display:inline-block;min-height:" + __setting_navbar_height + ";");
            __setting_navbar_background_colour = __setting_page_background_colour;
        }
    }
    if (!__setting_newstyle_navbars)
    	PageAddCSSClass("div", "r_bottom_outer_container", "min-height:" + __setting_navbar_height + ";position:fixed;z-index:6;width:100%;overflow:hidden;");
    else
	    PageAddCSSClass("div", "r_bottom_outer_container", "min-height:" + __setting_navbar_height + ";width:100%;overflow:hidden;");
    if (true)
    {
        //Second holding container:
        string style = "";
        //int width = __setting_horizontal_width;
        //if (!__setting_fill_vertical)
            //width -= 2;
        
        style += "margin-left:auto; margin-right:auto;font-size:1em;"; //max-width:" + width + "px;
        style += "min-height:" + __setting_navbar_height + ";";
        if (!__setting_side_negative_space_is_dark && !__setting_fill_vertical)
            style += "border-left:1px solid;border-right:1px solid;";
        style += "border-top:1px solid;border-color:" + __setting_line_colour + ";";
        PageAddCSSClass("div", "r_bottom_inner_container", style);
    }
    //PageAddCSSClass("", "r_location_bar_table_entry", "vertical-align:middle;padding-left:0.5em;display:table-cell;");
    PageAddCSSClass("", "r_location_bar_table_entry", "vertical-align:middle;padding-left:0.5em;padding-right:0.5em;display:table-cell;");
    PageAddCSSClass("", "r_location_bar_ellipsis_entry", "overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;");
    
    PageAddCSSClass("", "r_only_display_if_not_large", "");
    PageAddCSSClass("", "r_only_display_if_not_large", "display:none !important;", 0, __setting_media_query_large_size);
    
    PageAddCSSClass("", "r_only_display_if_not_medium", "");
    PageAddCSSClass("", "r_only_display_if_not_medium", "display:none !important;", 0, __setting_media_query_medium_size);
    
    PageAddCSSClass("", "r_only_display_if_not_tiny", "");
    PageAddCSSClass("", "r_only_display_if_not_tiny", "display:none !important;", 0, __setting_media_query_tiny_size);
    
    PageAddCSSClass("", "r_only_display_if_not_small", "");
    PageAddCSSClass("", "r_only_display_if_not_small", "display:none !important;", 0, __setting_media_query_small_size);
    
    PageAddCSSClass("", "r_only_display_if_small", "display:none !important;", 0, __setting_media_query_large_size);
    PageAddCSSClass("", "r_only_display_if_small", "display:none !important;", 0,__setting_media_query_medium_size);
    PageAddCSSClass("", "r_only_display_if_small", "", 0, __setting_media_query_small_size);
    PageAddCSSClass("", "r_only_display_if_small", "display:none !important;", 0,__setting_media_query_tiny_size);
    
    PageAddCSSClass("", "r_only_display_if_tiny", "display:none !important;", 0, __setting_media_query_large_size);
    PageAddCSSClass("", "r_only_display_if_tiny", "display:none !important;", 0,__setting_media_query_medium_size);
    PageAddCSSClass("", "r_only_display_if_tiny", "display:none !important;", 0, __setting_media_query_small_size);
    PageAddCSSClass("", "r_only_display_if_tiny", "", 0, __setting_media_query_tiny_size);
    
    
    PageAddCSSClass("", "r_do_not_display_if_media_queries_unsupported", "display:none;");
    PageAddCSSClass("", "r_do_not_display_if_media_queries_unsupported", "", 0, __setting_media_query_large_size);
    PageAddCSSClass("", "r_do_not_display_if_media_queries_unsupported", "", 0,__setting_media_query_medium_size);
    PageAddCSSClass("", "r_do_not_display_if_media_queries_unsupported", "", 0, __setting_media_query_small_size);
    PageAddCSSClass("", "r_do_not_display_if_media_queries_unsupported", "", 0, __setting_media_query_tiny_size);
    
    PageAddCSSClass("", "r_location_bar_background_blur", "background:rgba(255, 255, 255, 0.95);box-shadow:0px 0px 1px 2px rgba(255, 255, 255, 0.95);");
    PageAddCSSClass("", "r_location_bar_background_blur_small", "background:rgba(255, 255, 255, 0.95);box-shadow:0px 0px 0.5px 1px rgba(255, 255, 255, 0.95);");
    
    PageAddCSSClass("", "r_tooltip_outer_class", "border-bottom:1px dotted;border-color:" + __setting_line_colour + ";position:relative;");
    PageAddCSSClass("", "r_tooltip_inner_class", "background:white;border-style:solid;border-color:" + __setting_line_colour + ";border-width:1px;padding-left:1em;padding-right:1em;padding-bottom:0.25em;padding-top:0.25em;position:absolute;opacity:0;transition:visibility 0s linear 0.25s, opacity 0.25s linear;visibility:hidden;margin-top:1.5em;z-index:1000;width:60vw;white-space:normal;box-shadow:0px 0px 0px 10000px rgba(0,0,0,0.5);"); //white-space:nowrap;
    PageAddCSSClass("", "r_tooltip_inner_class_margin", "margin-top:-200px;");
    PageAddCSSClass("", "r_tooltip_outer_class:hover .r_tooltip_inner_class", "opacity:1;visibility:visible;transition-delay:0s;");
    //PageAddCSSClass("", "r_tooltip_inner_class_weve_had_one_yes_but_what_about_second_inner_class", "background:white;border-style:solid;border-color:black;border-width:1px;padding:1em;top:1.5em;");
    
    PageAddCSSClass("", "r_no_css_transition", "-webkit-transition:none !important;-moz-transition:none !important;-o-transition:none !important;-ms-transition:none !important;transition:none !important;");
    
    
    
    PageAddCSSClass("img", "", "border:0px;mix-blend-mode:multiply;");
}

RegisterResourceGenerationFunction("IOTMBarrelGodGenerateResource");
void IOTMBarrelGodGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[shrine to the Barrel god]])
        return;
    
    
    if (!get_property_boolean("_barrelPrayer"))
    {
        string [int] description;
        string [int][int] gear;
        
        if (__misc_state["can equip just about any weapon"] && !get_property_boolean("prayedForProtection"))
            gear.listAppend(listMake("Protection", "+50 ML, +100 HP, +25% muscle offhand"));
        if (!get_property_boolean("prayedForGlamour"))
            gear.listAppend(listMake("Glamour", "+50% item, ~8 MP regen, +25% myst accessory"));
        if (!get_property_boolean("prayedForVigor"))
            gear.listAppend(listMake("Vigor", "+50% init, ~15 HP regen, +25% moxie pants"));
        
        if (gear.count() > 0)
            description.listAppend("Once/ascension gear:|*" + HTMLGenerateSimpleTableLines(gear));
        string buff_description;
        if (my_class() == $class[seal clubber])
            buff_description = "+150% weapon damage";
        else if (my_class() == $class[turtle tamer])
            buff_description = "ode-to-booze type for food";
        else if (my_class() == $class[pastamancer])
            buff_description = "+90% item";
        else if (my_class() == $class[sauceror])
            buff_description = "+150% spell damage";
        else if (my_class() == $class[disco bandit])
            buff_description = "+150% ranged damage";
        else if (my_class() == $class[accordion thief])
            buff_description = "ode-to-booze type / +45% booze drops";
        
        if (buff_description != "")
            description.listAppend(buff_description.capitaliseFirstLetter() + " buff for 50 turns." + ($item[map to the Biggest Barrel].available_amount() == 0 && (my_daycount() >= 7 || !in_ronin()) ? "|Might give the map to the Biggest Barrel." : ""));
        
        resource_entries.listAppend(ChecklistEntryMake(487, "barrel god", "da.php?barrelshrine=1", ChecklistSubentryMake("Barrel worship", "", description), 8).ChecklistEntrySetCategory("equipment"));
    }
    
    if (in_ronin())
    {
        item [int] barrels_around;
        foreach it in $items[little firkin,normal barrel,big tun,weathered barrel,dusty barrel,disintegrating barrel,moist barrel,rotting barrel,mouldering barrel,barnacled barrel]
        {
            if (it.item_amount() > 0)
                barrels_around.listAppend(it);
        }
        if (barrels_around.count() > 0)
        {
            string [int] plurals;
            foreach key, it in barrels_around
            {
                plurals.listAppend(pluralise(it.item_amount(), it));
            }
            string url = "inv_use.php?pwd=" + my_hash() + "&whichitem=" + barrels_around[0].to_int() + "&choice=1";
            string [int] description;
            description.listAppend(plurals.listJoinComponents(", ", "and") + ".");
            resource_entries.listAppend(ChecklistEntryMake(488, "__item " + barrels_around[0], url, ChecklistSubentryMake("Smashable barrels", "", description), 8));
        }
    }
}
RegisterGenerationFunction("IOTMBarrelGodGenerate");
void IOTMBarrelGodGenerate(ChecklistCollection checklists)
{
    //we could suggest they defeat the barrelmech if they have the map anyways... hmm
    if ($item[map to the Biggest Barrel].available_amount() > 0 && (!$item[chest barrel].haveAtLeastXOfItemEverywhere(1) || !$item[barrelhead].haveAtLeastXOfItemEverywhere(1) || !$item[bottoms of the barrel].haveAtLeastXOfItemEverywhere(1)))
    {
        string [int] description;
        description.listAppend("Use map to the Biggest Barrel.");
        description.listAppend("To defeat him, deal up to, but not over, 150 HP/round. Otherwise, he'll heal his HP.|You'll also want healing items.");
        if ($skill[belch the rainbow].have_skill())
            description.listAppend("Could run -250 ML and cast belch the rainbow over and over, if you've upgraded that.");
        if (!in_ronin())
        {
            string line = "Could throw chipotle wasabi cilantro aioli repeatedly.";
            if ($item[chipotle wasabi cilantro aioli].item_amount() < 22)
                line += "|Acquire 22 of them first, though.";
            description.listAppend(line);
        }
        description.listAppend("Can only be fought once a day, until defeated.");
        checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(489, "barrel god", "inventory.php?ftext=map+to+the+Biggest+Barrel", ChecklistSubentryMake("Defeat the Barrelmech", "", description), 8));
    }
}
static
{
    string [item] __tea_tree_teas;
    void initialiseTeaTreeTeas()
    {
        __tea_tree_teas[$item[cuppa Activi tea]] = "adventures, stats";
        __tea_tree_teas[$item[cuppa Alacri tea]] = "+50% init";
        __tea_tree_teas[$item[cuppa Boo tea]] = "+30 spooky damage";
        __tea_tree_teas[$item[cuppa Chari tea]] = "+50% meat";
        __tea_tree_teas[$item[cuppa Craft tea]] = "crafting";
        __tea_tree_teas[$item[cuppa Cruel tea]] = "+5 fights for spleen";
        __tea_tree_teas[$item[cuppa Dexteri tea]] = "+50 moxie";
        __tea_tree_teas[$item[cuppa Feroci tea]] = "+50 muscle";
        __tea_tree_teas[$item[cuppa Flamibili tea]] = "+30 hot damage";
        __tea_tree_teas[$item[cuppa Flexibili tea]] = "+3 moxie stats/fight";
        __tea_tree_teas[$item[cuppa Frost tea]] = "+3 hot res";
        __tea_tree_teas[$item[cuppa Gill tea]] = "fishy";
        __tea_tree_teas[$item[cuppa Impregnabili tea]] = "30 DR";
        __tea_tree_teas[$item[cuppa Improprie tea]] = "+30 sleaze damage";
        __tea_tree_teas[$item[cuppa Insani tea]] = "+3 OCRS modifiers, teleporting(?)";
        __tea_tree_teas[$item[cuppa Irritabili tea]] = "+combat";
        __tea_tree_teas[$item[cuppa Loyal tea]] = "+5 familiar weight";
        __tea_tree_teas[$item[cuppa Mana tea]] = "+30 max MP, ~4 MP regen";
        __tea_tree_teas[$item[cuppa Mediocri tea]] = "+30 ML";
        __tea_tree_teas[$item[cuppa Monstrosi tea]] = "-30 ML";
        __tea_tree_teas[$item[cuppa Morbidi tea]] = "+3 spooky res";
        __tea_tree_teas[$item[cuppa Nas tea]] = "+30 stench damage";
        __tea_tree_teas[$item[cuppa Net tea]] = "+3 stench res";
        __tea_tree_teas[$item[cuppa Neuroplastici tea]] = "+3 myst stat/fight";
        __tea_tree_teas[$item[cuppa Obscuri tea]] = "-combat";
        __tea_tree_teas[$item[cuppa Physicali tea]] = "+3 muscle stats/fight";
        __tea_tree_teas[$item[cuppa Proprie tea]] = "+3 sleaze res";
        __tea_tree_teas[$item[cuppa Royal tea]] = "+1 royalty";
        __tea_tree_teas[$item[cuppa Serendipi Tea]] = "+25% item";
        __tea_tree_teas[$item[cuppa Sobrie tea]] = "-1 drunkenness";
        __tea_tree_teas[$item[cuppa Toast tea]] = "+3 cold res";
        __tea_tree_teas[$item[cuppa Twen tea]] = "+20 various stats";
        __tea_tree_teas[$item[cuppa Uncertain tea]] = "random effect";
        __tea_tree_teas[$item[cuppa Vitali tea]] = "+30 max HP, ~4 HP regen";
        __tea_tree_teas[$item[Cuppa Voraci tea]] = "+1 stomach capacity today";
        __tea_tree_teas[$item[cuppa Wit tea]] = "+50 myst";
        __tea_tree_teas[$item[cuppa Yet tea]] = "+30 cold damage";
    }
    initialiseTeaTreeTeas();
}

RegisterResourceGenerationFunction("IOTMTeaTreeGenerateResource");
void IOTMTeaTreeGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!get_property_boolean("_pottedTeaTreeUsed") && __iotms_usable[$item[potted tea tree]])
    {
        string [int] options;
        //+50% Combat Initiative?
        
        string [int][int] tea_options;
        
        
        if (__misc_state["in run"])
        {
            tea_options.listAppend(listMake("Irritabili", "+combat (30 turns)"));
            tea_options.listAppend(listMake("Obscuri", "-combat (30 turns)"));
            tea_options.listAppend(listMake("Serendipi", "+25% item (30 turns)"));
            tea_options.listAppend(listMake("Chari", "+50% meat (30 turns)"));
            tea_options.listAppend(listMake("Mediocri", "+30 ML"));
            if (!__misc_state["familiars temporarily blocked"])
                tea_options.listAppend(listMake("Loyal", "+5 familiar weight"));
            tea_options.listAppend(listMake("Craft", "Free crafts"));
            if (hippy_stone_broken())
                tea_options.listAppend(listMake("Cruel", "+5 PVP fights, spleen"));
        }
        if (inebriety_limit() > 0)
            tea_options.listAppend(listMake("Sobrie", "-1 drunkenness"));
        if (fullness_limit() > 0)
            tea_options.listAppend(listMake("Voraci", "+1 fullness capacity today"));
        
        if (!__misc_state["in run"])
        {
            tea_options.listAppend(listMake("Royal", "Mall selling, royal leaderboarding"));
            tea_options.listAppend(listMake("Gill", "Fishy (30 turns)"));
        }
        if (!__quest_state["Level 13"].state_boolean["Elemental damage race completed"] && __quest_state["Level 13"].state_string["Elemental damage race type"] != "")
        {
            //
            element type = __quest_state["Level 13"].state_string["Elemental damage race type"].to_element();
            item [element] element_tea_map;
            element_tea_map[$element[sleaze]] = $item[cuppa Improprie Tea];
            element_tea_map[$element[spooky]] = $item[cuppa Boo tea];
            element_tea_map[$element[hot]] = $item[cuppa Flamibili tea];
            element_tea_map[$element[stench]] = $item[cuppa Nas tea];
            element_tea_map[$element[cold]] = $item[cuppa Yet tea];
            
            item tea = element_tea_map[type];
            string type_class = "r_element_" + type + "_desaturated";
            if (tea != $item[none] && tea.available_amount() == 0)
                tea_options.listAppend(listMake(tea.replace_string(" tea", "").replace_string("cuppa ", "").capitaliseFirstLetter(), HTMLGenerateSpanOfClass(__tea_tree_teas[tea], type_class) + " for lair race."));
        }
        
        if (tea_options.count() > 0)
            options.listAppend(HTMLGenerateSimpleTableLines(tea_options));
        resource_entries.listAppend(ChecklistEntryMake(478, "__item potted tea tree", "campground.php?action=teatree", ChecklistSubentryMake("Tea Tree Tea", "", options), 4).ChecklistEntrySetCategory("iotm"));
    }
    
    if (__misc_state["in run"] && in_ronin())
    {
        string image_name = "";
        string url = "";
        string [int] teas_found;
        string [int] reasons_found;
        boolean one_tea_gives_effect = false;
        foreach tea, treason in __tea_tree_teas
        {
            if (tea.available_amount() == 0)
                continue;
            string shortened_tea_name = tea.replace_string("cuppa ", "").replace_string(" tea", "");
            teas_found.listAppend(pluralise(tea.available_amount(), shortened_tea_name, shortened_tea_name));
            
            reasons_found.listAppend(treason);
            if (image_name == "")
                image_name = "__item " + tea;
            if (!one_tea_gives_effect && tea.to_effect() != $effect[none])
                one_tea_gives_effect = true;
            if (tea.spleen > 0)
            {
                if (url == "")
                    url = "inventory.php?which=1";
            }
            else
                url = "inventory.php?which=3";
        }
        if (teas_found.count() > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(479, image_name, url, ChecklistSubentryMake(teas_found.listJoinComponents(", ", "and").capitaliseFirstLetter() + " tea", "", reasons_found.listJoinComponents(", ", "and").capitaliseFirstLetter() + (one_tea_gives_effect ? " (30 turns)" : "")), 8));
        }
    }
}

RegisterResourceGenerationFunction("IOTMSpeakeasyGenerateResource");
void IOTMSpeakeasyGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__misc_state["VIP available"])
        return;

    if (!(__misc_state["can drink just about anything"] && get_property_int("_speakeasyDrinksDrunk") <3 && availableDrunkenness() >= 0))
        return;
    if (!$item[clan speakeasy].is_unrestricted())
        return;
        
    //speakeasy:
    /*
        Lucky lindy - good 1-potency, gives semi-rare. crucial in zombie slayer
        Bee's Knees - awesome 2-potency, 25 turns of +100% all stats
        Sockdollager - awesome 2-potency, 25 turns of (+20 all elemental damage, +40 all elemental spell damage, +20 ranged/weapon damage, +50% weapon/spell damage, +50 spell damage
        Flivver - 20,000 meat epic 2-potency, restores mana (not useful in-run)
        Hot Socks - awesome 3-potency, 50 turns of (+2 familiar experience, +10 familiar weight, +20 familiar damage)
        Sloppy Jalopy - 100,000 meat awesome 5-potency, gives skill Hollow Leg (+1 liver capacity) for aftercore
        Phonus Balonus - +fights/+adventures
        Ish Kabibble - +3 all res, +DA/DR
    */
    int drinks_remaining = MAX(3 - get_property_int("_speakeasyDrinksDrunk"), 0);
    
    string [int][int] options;
    
    options.listAppend(listMake("<strong>Drink</strong>", "<strong>Size</strong>", "<strong>Description</strong>"));
    if (CounterLookup("Semi-rare").CounterIsRange())
        options.listAppend(listMake("Lucky Lindy", "1", "Semi-rare number"));
    
    //FIXME every drink
    //FIXME gray out drinks we can't drink at the moment (drunkenness, meat)
    
    if ($effect[1701].have_effect() == 0 && !__misc_state["familiars temporarily blocked"] && __misc_state["in run"]) //hip to the jive
    {
        string [int] description;
        description.listAppend("+10 familiar weight");
        if (familiar_weight(my_familiar()) < 20)
            description.listAppend("+2 familiar exp/fight");
        options.listAppend(listMake("Hot Socks", "3", description.listJoinComponents("|")));
    }
    
    if (!__misc_state["in run"] && !$skill[Hollow Leg].skill_is_usable())
        options.listAppend(listMake("Sloppy Jalopy", "5", "+1 liver capacity skill|Very expensive"));
    
    
    string [int] reasons_to_sockdollager;
    if (!__quest_state["Level 3"].finished)
    {
        boolean can_skip_cold = numeric_modifier("Cold Damage") >= 20.0;
        boolean can_skip_hot = numeric_modifier("Hot Damage") >= 20.0;
        boolean can_skip_spooky = numeric_modifier("Spooky Damage") >= 20.0;
        boolean can_skip_stench = numeric_modifier("Stench Damage") >= 20.0;
        if (!can_skip_cold || !can_skip_hot || !can_skip_spooky || !can_skip_stench)
            reasons_to_sockdollager.listAppend("tavern NC skipping");
    }
    
    if (!__quest_state["Level 13"].state_boolean["Elemental damage race completed"])
        reasons_to_sockdollager.listAppend("Elemental damage race");
    
    if (my_path_id() == PATH_HEAVY_RAINS && !__quest_state["Level 13"].finished)
        reasons_to_sockdollager.listAppend("fighting rain king");
    
    if (reasons_to_sockdollager.count() > 0)
        options.listAppend(listMake("Sockdollager", "2", reasons_to_sockdollager.listJoinComponents(", ", "and").capitaliseFirstLetter()));
    
    if (__misc_state["in run"] && my_meat() >= 20000)
        options.listAppend(listMake("Flivver", "2", "Epic-level drunkenness."));
    
    if (__misc_state["need to level"])
    {
        string drink_name = "";
        
        if (my_primestat() == $stat[muscle])
        {
            drink_name = "Glass of \"milk\"";
        }
        else if (my_primestat() == $stat[mysticality])
        {
            drink_name = "Cup of \"tea\"";
        }
        else if (my_primestat() == $stat[moxie])
        {
            drink_name = "Thermos of \"whiskey\"";
        }
        if (drink_name != "")
        {
            float mainstat_gain = 87.5 * (1.0 + numeric_modifier(my_primestat().to_string() + " Experience Percent") / 100.0);
            string description = mainstat_gain.roundForOutput(0) + " mainstat";
            //if (my_path_id() != PATH_SLOW_AND_STEADY)
                //description += "";
            options.listAppend(listMake(drink_name, "1", description));
        }
        
    }
    
    if (hippy_stone_broken())
    {
        options.listAppend(listMake("Phonus Balonus", "3", "+fights/+adventures"));
    }
    
    if (my_path_id() == PATH_NUCLEAR_AUTUMN)
    {
        foreach key in options
        {
            if (options[key][1].to_int_silent() > 1)
                remove options[key];
        }
    }
    
    string [int] description;
    if (options.count() > 1)
        description.listAppend(HTMLGenerateSimpleTableLines(options));
    
    if (__misc_state["in run"] || drinks_remaining > 0)
        resource_entries.listAppend(ChecklistEntryMake(593, "__item observational glasses", "clan_viplounge.php?action=speakeasy", ChecklistSubentryMake(pluralise(drinks_remaining, "speakeasy drink", "speakeasy drinks"), "", description), 8)); //the eyes of T.J. Eckleburg
    
}
record DOECSummon
{
    string [int] cards;
    string reason;
};

DOECSummon DOECSummonMake(string [int] cards, string reason)
{
    DOECSummon summon;
    summon.cards = cards;
    summon.reason = reason;
    return summon;
}

DOECSummon DOECSummonMake(string card, string reason)
{
    string [int] cards;
    cards.listAppend(card);
    return DOECSummonMake(cards, reason);
}

void listAppend(DOECSummon [int] list, DOECSummon entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

RegisterResourceGenerationFunction("IOTMDeckOfEveryCardGenerateResource");
void IOTMDeckOfEveryCardGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[Deck of Every Card].available_amount() == 0 || !$item[Deck of Every Card].is_unrestricted())
        return;
    
    int card_summons_left = clampi(15 - get_property_int("_deckCardsDrawn"), 0, 15);
    
    /*
    In-run:
    Sheep - 3 stone wool
    X - The Wheel of Fortune - +100% item for 20 turns
    [mainstat cards] - gain 500 mainstat
    XVI - The Tower - DD key
    Professor Plum - lets you make ten crimbo pies under the knoll sign. maybe useful if we have fullness over, like, twenty-five?
    Spare tire/Extra tank - something meatcar outside of knoll, might not be worth it? just summon the 10k card and buy a bus pass (ignoring... maybe surprising fist?)
    Fish DNA - acquire a free runaway in... HCO? or any path where that's relevant (not HR)
    X of Coins - X * 500 meat - if we have low meat and we've already summoned the mantle... maybe
    [three +mainstat cards] - stat test in the tower
    weapons
    
    
    
    Aftercore:
    random cards - fun!
    knife - meat farming
    Laboratory - five random potions? ???
    [monster types] - fight a random monster for factoids
    gift card - sell a draw in the mall to the needy
    IV - The Emperor - until we have outfit
    IX - The Hermit - until we have all factoids
    
    Both:
    ancestral recall / Island - if you have Ancestral Recall, indirectly gives +3 adventures. not useful in S&S
    X of Clubs - +3 PVP fights
    1952 Mickey Mantle - 10k autosell
    
    Unknown:
    X of Diamonds - X * 100 meat - never? maybe ~550 meat on average? even in run... eh...
    X of Swords - technically optimal (saw one that gave two SBIPs and an antique machete) but random
    
    
    one card/day/card limit when cheating
    */
    
    boolean in_run = __misc_state["in run"];
    
    DOECSummon [int] summons;
    
    if (in_run && (__misc_state_int["fat loot tokens needed"] > 0 || (!in_ronin() && __misc_state_int["hero keys missing"] > 0)))
        summons.listAppend(DOECSummonMake("XVI - The Tower", "Daily Dungeon key."));
    
    
    if (my_path_id() != PATH_SLOW_AND_STEADY)
    {
        if ($skill[ancestral recall].skill_is_usable())
        {
            summons.listAppend(DOECSummonMake(listMake("Ancestral Recall", "Island"), "+3 adventures via ancestral recall."));
        }
        else if (!in_run)
        {
            summons.listAppend(DOECSummonMake("Ancestral Recall", "Gives +adventure summoning skill."));
        }
    }
    
    if (hippy_stone_broken())
        summons.listAppend(DOECSummonMake("X of Clubs", "+3 PVP fights."));
    
    if (in_run)
        summons.listAppend(DOECSummonMake("X - The Wheel of Fortune", "+100% item for 20 turns."));
    
    if (in_run && __misc_state["need to level"] && my_path_id() != PATH_THE_SOURCE)
    {
        string card_name = "Cardiff";
        if (my_primestat() == $stat[muscle])
            card_name = "XXI - The World";
        else if (my_primestat() == $stat[mysticality])
            card_name = "III - The Empress";
        else if (my_primestat() == $stat[moxie])
            card_name = "VI - The Lovers";
        
        summons.listAppend(DOECSummonMake(card_name, "+" + (500 * (1.0 + numeric_modifier(my_primestat().to_string() + " Experience Percent") / 100.0)).floor() + " mainstat."));
    }
    
    if (in_run && !__quest_state["Level 8"].state_boolean["Past mine"])
    {
        int missing_ore = MAX(0, 3 - __quest_state["Level 8"].state_string["ore needed"].to_item().available_amount());
        if (missing_ore > 0)
            summons.listAppend(DOECSummonMake("Mine", "One of every ore."));
    }
    
    if (!in_run && $item[knife].available_amount() == 0)
        summons.listAppend(DOECSummonMake("Knife", "+50% meat farming weapon."));
    
    if (in_run && $items[lead pipe,rope,wrench,candlestick,knife,revolver].items_missing().count() == 6)
    {
        /*
        Important point on the +stat equipment - there's another card that gives 500 mainstat. So, if that's all you're using the weapon for, you'd need to use it for over 250 fights in a day to be worthwhile.
        You can, of course, summon both... but in that situation, there's probably a better summon instead?
        
        lead pipe - 1h club. +100% muscle, +50 HP, vanishes at rollover.
            Hmm... for muscle classes that don't have familiars? Or seal clubbers?
            +100% mainstat is a lot...
        rope - 1h whip. +2 muscle/fight, +10 familiar weight, vanishes at rollover.
            Muscle classes. Any class that has a runaway familiar. Maybe just any class that has a familiar?
         
        wrench - 1h utensil. +100% spell damage, +50 MP.
            For myst classes that don't need stats.
        candlestick - 1h wand. +2 myst/fight, +100% myst, vanishes at rollover.
            For myst classes that need stats.
        
        knife - 1h knife. +50% meat, +100% moxie, vanishes at rollover.
            For moxie classes. Even then...
            +100% mainstat is a lot...
        revolver -  1h pistol. +50% init, +2 moxie/fight, vanishes at rollover.
            For moxie classes that need stats? Ehh...
        */
        DOECSummon [int] weapon_choices;
        
        
        if (my_primestat() == $stat[muscle])
        {
            if (!($skill[summon smithsness].skill_is_usable() && my_class() == $class[seal clubber]))
                weapon_choices.listAppend(DOECSummonMake("Lead pipe", "+100% muscle, +HP club."));
            //Rope is mentioned elsewhere
        }
        if (my_primestat() == $stat[mysticality] && !$skill[summon smithsness].skill_is_usable())
        {
            weapon_choices.listAppend(DOECSummonMake("Wrench", "+100% spell damage weapon.")); //this will do more damage on average than the candlestick, so it's more worthwhile? (compare capped spells versus scaling spells - spell damage affects saucestorm, +myst doesnt')
            //Is the candlestick worth summoning?
            if (__misc_state["need to level"])
                weapon_choices.listAppend(DOECSummonMake("Candlestick", "+100% myst, +2 myst/fight weapon. (wrench may be better)"));
        }
        if (my_primestat() == $stat[moxie] && !$skill[summon smithsness].skill_is_usable())
        {
            if ($skill[tricky knifework].skill_is_usable())
                weapon_choices.listAppend(DOECSummonMake("Knife", "+50% meat, +100% moxie knife."));
            if (__misc_state["need to level"] && !$skill[tricky knifework].skill_is_usable())
                weapon_choices.listAppend(DOECSummonMake("Revolver", "+50% init, +2 moxie/fight ranged weapon.")); //ignored for DBs, because of the stat issue mentioned above
        }
        if (!__misc_state["familiars temporarily blocked"])
        {
            //is this worthwhile for non-muscle classes without free runaway familiars?
            string line;
            line = "+10 familiar weight";
            if (my_primestat() == $stat[muscle] && __misc_state["need to level"])
                line += ", +2 muscle/fight";
            line += " weapon.";
            weapon_choices.listAppend(DOECSummonMake("Rope", line));
        }
        
        foreach key, summon in weapon_choices
        {
            //FIXME combine?
            summons.listAppend(summon);
        }
    }
    
    summons.listAppend(DOECSummonMake("1952 Mickey Mantle", "Autosells for 10k."));
    
    
    if (in_run && my_path_id() != PATH_COMMUNITY_SERVICE)
    {
        int wool_needed = 0;
        if (!$location[the hidden park].locationAvailable())
        {
            wool_needed += 1;
            if ($item[the nostril of the serpent].available_amount() == 0)
                wool_needed += 1;
        }
		if ($item[stone wool].available_amount() < wool_needed)
        {
            summons.listAppend(DOECSummonMake("Sheep", "3 stone wool."));
        }
        else if ($item[stone wool].available_amount() - wool_needed <= 0 && !get_property_ascension("lastTempleAdventures") && my_path_id() != PATH_SLOW_AND_STEADY)
        {
            summons.listAppend(DOECSummonMake("Sheep", "Stone wool for +3 adventures via temple."));
        }
    }
    
    if (!in_run)
    {
        int missing_emperor_pieces = missing_outfit_components("The Emperor's New Clothes").count();
        if (missing_emperor_pieces > $item[The Emperor's dry cleaning].available_amount())
            summons.listAppend(DOECSummonMake("IV - The Emperor", "The Emperor's New Clothes outfit."));
    
        summons.listAppend(DOECSummonMake("Gift card", "Sell to the needy."));
        
        string [int][int] tooltip_table;
        tooltip_table.listAppend(listMake("II - The High Priestess", "Hippy"));
        tooltip_table.listAppend(listMake("V - The Hierophant", "Dude"));
        tooltip_table.listAppend(listMake("VII - The Chariot", "Construct"));
        tooltip_table.listAppend(listMake("XII - The Hanged Man", "Orc"));
        tooltip_table.listAppend(listMake("XIII - Death", "Undead"));
        tooltip_table.listAppend(listMake("XIV - Temperance", "Hobo"));
        tooltip_table.listAppend(listMake("XV - The Devil", "Demon"));
        tooltip_table.listAppend(listMake("XVII - The Star", "Constellation"));
        tooltip_table.listAppend(listMake("XVIII - The Moon", "Horror"));
        tooltip_table.listAppend(listMake("The Hive", "Bug"));
        tooltip_table.listAppend(listMake("Goblin Sapper", "Goblin"));
        tooltip_table.listAppend(listMake("Fire Elemental", "Elemental"));
        tooltip_table.listAppend(listMake("Unstable Portal", "Weird"));
        tooltip_table.listAppend(listMake("Werewolf", "Beast"));
        tooltip_table.listAppend(listMake("Go Fish", "Fish"));
        tooltip_table.listAppend(listMake("Plantable Greeting Card", "Plant"));
        tooltip_table.listAppend(listMake("Pirate Birthday Card", "Pirate"));
        tooltip_table.listAppend(listMake("Christmas Card", "Elf"));
        tooltip_table.listAppend(listMake("Suit Warehouse Discount Card", "Penguin"));
        tooltip_table.listAppend(listMake("Slimer Trading Card", "Slime"));
        tooltip_table.listAppend(listMake("Aquarius Horoscope", "Mer-Kin"));
        tooltip_table.listAppend(listMake("Hunky Fireman Card", "Humanoid"));

        buffer tooltip_text;
        tooltip_text.HTMLAppendTagWrap("div", "Monster Cards", mapMake("class", "r_bold r_centre", "style", "padding-bottom:0.25em;"));
        tooltip_text.append(HTMLGenerateSimpleTableLines(tooltip_table));
        
        string title = HTMLGenerateSpanOfClass(HTMLGenerateSpanOfClass(tooltip_text, "r_tooltip_inner_class r_tooltip_inner_class_margin") + "Monster card", "r_tooltip_outer_class");
        summons.listAppend(DOECSummonMake(title, "Past factoids."));
    }
    
    if (in_run && !__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "")
    {
        stat stat_race_type = __quest_state["Level 13"].state_string["Stat race type"].to_stat();
        string card_name = "Joker";
        effect relevant_effect;
        if (stat_race_type == $stat[muscle])
        {
            card_name = "XI - Strength";
            relevant_effect = to_effect("1912");
        }
        else if (stat_race_type == $stat[mysticality])
        {
            card_name = "I - The Magician";
            relevant_effect = to_effect("1911");
        }
        else if (stat_race_type == $stat[moxie])
        {
            card_name = "0 - The Fool";
            relevant_effect = to_effect("1910");
        }
        if (relevant_effect.have_effect() == 0)
            summons.listAppend(DOECSummonMake(card_name, "+200% " + stat_race_type.to_lower_case() + " for lair races. (marginal)"));
    }
    if (!in_run)
    {
        if (!haveAtLeastXOfItemEverywhere($item[talking spade], 1))
            summons.listAppend(DOECSummonMake("X of Spades", "Solve spade puzzle."));
        if (card_summons_left >= 5)
            summons.listAppend(DOECSummonMake("Random card", pluralise(card_summons_left, "luck of the draw", "lucks of the draw") + "."));
    }
    
    boolean [string] cards_already_drawn = get_property("_deckCardsSeen").split_string("\\|").listInvert();
    
    string [int][int] card_table;
    if (card_summons_left >= 5)
    {
        foreach key, summon in summons
        {
            string [int] valid_cards;
            foreach key, card in summon.cards
            {
                if (!cards_already_drawn[card])
                    valid_cards.listAppend(card);
            }
            if (valid_cards.count() == 0) continue;
            card_table.listAppend(listMake(valid_cards.listJoinComponents(" / "), summon.reason));
        }
    }
    
    if ((card_table.count() > 0 || card_summons_left < 5) && card_summons_left > 0)
    {
        string title;
		string [int] description;
        
        if (card_summons_left >= 5)
        {
            title = pluralise(card_summons_left / 5, "card drawable", "cards drawable");
        }
        else
        {
            title = pluralise(card_summons_left, "random card summon", "random card summons");
            string line = "Luck of the draw.";
            if (in_run)
                line += " (may cost turns)";
            description.listAppend(line);
        }
        
        if (card_table.count() > 0)
            description.listAppend(HTMLGenerateSimpleTableLines(card_table));
		resource_entries.listAppend(ChecklistEntryMake(504, "__item deck of every card", "inv_use.php?cheat=1&pwd=" + my_hash() + "&whichitem=8382", ChecklistSubentryMake(title, "", description), 1).ChecklistEntrySetCategory("iotm"));
    }
}
RegisterResourceGenerationFunction("IOTMHauntedDoghouseGenerateResource");
void IOTMHauntedDoghouseGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__misc_state["in run"])
        return;
    if ($item[tennis ball].available_amount() > 0 && in_ronin() && $item[tennis ball].item_is_usable())
    {
        resource_entries.listAppend(ChecklistEntryMake(523, "__item tennis ball", "", ChecklistSubentryMake(pluralise($item[tennis ball]), "", "Free run/banish."), 6).ChecklistEntryTag("free banish"));
    }
    //I, um, hmm. I guess there's not much to say. Poor lonely file, nearly empty.
}
RegisterResourceGenerationFunction("IOTMMayoClinicGenerateResource");
void IOTMMayoClinicGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (__misc_state["campground unavailable"])
        return;
    if (get_campground()[$item[portable Mayo Clinic]] == 0 || in_bad_moon())
        return;
    
    //mayoLevel
    int mayo_level = get_property_int("mayoLevel");
    
    if (availableFullness() > 0)
    {
        //stuff:
        //Mayonex - food adventures -> blood mayo (???)
        //Mayodiol -> one fullness becomes one drunkenness
        //Mayostat -> one-fullness same quality restore
        //Mayozapine -> increased stat gains
        //Mayoflex -> +1 adventure
        //Mayo Minder -> um... I guess it uses the above things for you. reminds me of buying the autorefueler in EV..
    }
    
    if (!get_property_boolean("_mayoDeviceRented"))
    {
        string [int] description;
        //sphygmayomanometer - +(20 + mayo_level)% stats
        //tomayohawk-style reflex hammer - reusable combat item. stagger, mayo-level sleaze damage
        //mayo lance - YR combat item, requires at least one blood mayo
        //miracle whip - nice day two/three equip. +50% init, +50% item, +100% meat, +100% wait, I only get one of these a run?
        
        string line = "Lasts the rest of the day. Can only choose one.";
        if (my_meat() < 2500)
            line += "|Need at least 2500 meat first.";
        description.listAppend(line);
        
        string [int][int] choices;
        
        choices.listAppend(listMake("Sphygmayomanometer", "+" + (20 + mayo_level) + "% all stats"));
        choices.listAppend(listMake("Tomayohawk-style reflex hammer", "Reusable combat item.|Staggers and deals mayo-level sleaze damage."));
        string lance_description = "Yellow ray. ";
        if (__misc_state["yellow ray available"])
            lance_description = "Shorter yellow ray. ";
        lance_description += HTMLGenerateDivOfClass("Uses up blood mayo.", "r_word_wrap_group");
        choices.listAppend(listMake("Mayo lance", lance_description));
        
        if (!get_property_boolean("mayoWhipRented") && !get_property_boolean("itemBoughtPerAscension8266") &&  my_path_id() != PATH_GELATINOUS_NOOB)
        {
            choices.listAppend(listMake("Miracle whip", "Weapon, usable " + HTMLGenerateSpanFont("once", "red") + " per run.|+50% item, +100% meat, +50% init."));
        }
        description.listAppend(HTMLGenerateSimpleTableLines(choices));
        resource_entries.listAppend(ChecklistEntryMake(563, "__item sphygmayomanometer", "campground.php?action=workshed", ChecklistSubentryMake("Mayo Device Rental", "", description), 8));
    }
    if (!get_property_boolean("_mayoTankSoaked") && __misc_state["in run"])
    {
        string [int] description;
        string [int] benefits;
        if (my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING)
            benefits.listAppend("HP restore");
        benefits.listAppend("+2 all resistance");
        description.listAppend("Gives " + benefits.listJoinComponents(", ", "and") + ".");
        resource_entries.listAppend(ChecklistEntryMake(564, "__item bubblin' chemistry solution", "campground.php?action=workshed", ChecklistSubentryMake("Mayo Tank Soak", "", description), 8));
    }
    if ($item[mayo lance].available_amount() > 0)
    {
        string url = "";
        string [int] description;
        int turns_yellow_ray_will_be = clampi(150 - get_property_int("mayoLevel") * 5, 0, 150);
        if (get_property_int("mayoLevel") == 0)
        {
            string line = "Need blood mayo to yellow ray";
            if ($effect[everything looks yellow].have_effect() > 0)
                line += " later";
            line += ".";
            if (get_property("mayoInMouth") == "")
                line += "|Use a mayo packet.";
            description.listAppend(line);
            if (availableFullness() > 0)
                url = "campground.php?action=workshed";
        }
        else
        {
            string line = pluralise(turns_yellow_ray_will_be, "turn", "turns") + " yellow ray";
            if ($effect[everything looks yellow].have_effect() > 0)
                line += " later";
            line += ". Affected by mayo level.";
            description.listAppend(line);
        }
        resource_entries.listAppend(ChecklistEntryMake(565, "__item mayo lance", url, ChecklistSubentryMake("Mayo lance", "", description), 8));
        
    }
}
void smithsnessGenerateCoalSuggestions(string [int] coal_suggestions)
{
    if (!__misc_state["in run"])
        return;
	string [item] coal_item_suggestions;
	
	if (__misc_state["can equip just about any weapon"])
	{
        if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
            coal_item_suggestions[$item[half a purse]] = "2x smithsness meat for nuns";
		coal_item_suggestions[$item[A Light that Never Goes Out]] = "2x smithsness +item";
			
			
		if (my_class() == $class[seal clubber])
			coal_item_suggestions[$item[Meat Tenderizer is Murder]] = "weapon, +2x smithsness muscle %";
		else if (my_class() == $class[turtle tamer])
			coal_item_suggestions[$item[Ouija Board, Ouija Board]] = "weapon, +2x smithsness muscle %";
		else if (my_class() == $class[pastamancer])
			coal_item_suggestions[$item[Hand that Rocks the Ladle]] = "weapon, +2x smithsness mysticality %";
		else if (my_class() == $class[sauceror])
			coal_item_suggestions[$item[Saucepanic]] = "weapon, +myst stats, +2x smithsness mysticality %";
		else if (my_class() == $class[disco bandit])
			coal_item_suggestions[$item[Frankly Mr. Shank]] = "weapon, +2x smithsness moxie %";
		else if (my_class() == $class[accordion thief])
			coal_item_suggestions[$item[Shakespeare's Sister's Accordion]] = "weapon, +2x smithsness moxie %, useful cadenza";
		//not sure I like these suggestions based off of mainstat, but...
		else if (my_primestat() == $stat[mysticality])
			coal_item_suggestions[$item[Staff of the Headmaster's Victuals]] = "weapon, +smithsnesss spell damage";
		else if (my_primestat() == $stat[muscle])
			coal_item_suggestions[$item[Work is a Four Letter Sword]] = "weapon, +2x smithsness weapon damage";
		else if (my_primestat() == $stat[moxie])
			coal_item_suggestions[$item[Sheila Take a Crossbow]] = "weapon, +smithsness initiative";
        
        string [int] sheila_reasons;
        if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"])
			sheila_reasons.listAppend("modern zmobies");
        if (!__quest_state["Level 13"].state_boolean["Init race completed"])
            sheila_reasons.listAppend("lair init race");
        if (sheila_reasons.count() > 0)
            coal_item_suggestions[$item[Sheila Take a Crossbow]] = "weapon, +smithsness initiative (useful for " + sheila_reasons.listJoinComponents(", ", "and") + ")";
			
			
	}
	coal_item_suggestions[$item[Hand in Glove]] = "lots of +ML";
	if ($item[dirty hobo gloves].available_amount() == 0)
		coal_item_suggestions[$item[Hand in Glove]] += " (need dirty hobo gloves)";
	else
		coal_item_suggestions[$item[Hand in Glove]] += " (have dirty hobo gloves)";
	if (knoll_available() || $item[maiden wig].available_amount() > 0)
		coal_item_suggestions[$item[Hairpiece On Fire]] = "+4 adventures, +5 smithness hat, +smithsness MP";
	if (knoll_available() || $item[frilly skirt].available_amount() > 0)
	{
		coal_item_suggestions[$item[Vicar's Tutu]] = "+5 smithsness pants, +smithsness HP";
		
		if (hippy_stone_broken())
			coal_item_suggestions[$item[Vicar's Tutu]] = coal_item_suggestions[$item[Vicar's Tutu]] + ", +3 PVP fights";
	}
	
	if ($skill[pulverize].skill_is_usable())
		coal_suggestions.listAppend("Smash smithed equipment for more smithereens");
	foreach it in coal_item_suggestions
	{
		int number_wanted_max = 1;
		if (it.to_slot() == $slot[weapon] && it.weapon_hands() == 1)
		{
			if ($skill[double-fisted skull smashing].skill_is_usable() && it.item_type() != "accordion")
				number_wanted_max += 1;
			if (familiar_is_usable($familiar[disembodied hand]))
				number_wanted_max += 1;
		}
		
		if (it.available_amount() >= number_wanted_max)
			continue;
		string suggestion = coal_item_suggestions[it];
		coal_suggestions.listAppend(it + ": " + suggestion);
	}
}

void smithsnessGenerateSmithereensSuggestions(string [int] smithereen_suggestions) //suggestereens
{
	smithereen_suggestions.listAppend(7014.to_item().to_string() + ": " + (__misc_state["free runs usable"] ? "free run/" : "") + "banish for 20 turns");
	
	if (__misc_state["can eat just about anything"] && availableFullness() >= 2 && my_path_id() != PATH_SLOW_AND_STEADY)
	{
		smithereen_suggestions.listAppend("Charming Flan: 2 fullness epic food<br>Miserable Pie: 2 fullness awesome food, 50 turns of +10 smithsness");
	}
		
	if (__misc_state["can drink just about anything"] && availableDrunkenness() >= 2 && my_path_id() != PATH_SLOW_AND_STEADY)
	{
		smithereen_suggestions.listAppend("Vulgar Pitcher: 2 drunkenness epic drink<br>Bigmouth: 2 drunkenness awesome drink, 50 turns of +10 smithsness");
	}
	if (!$familiar[he-boulder].familiar_is_usable())
    {
        string line = "Golden Light: Yellow ray";
        if ($effect[everything looks yellow].have_effect() > 0)
            line = HTMLGenerateSpanFont(line, "gray");
		smithereen_suggestions.listAppend(line);
    }
    
    if (__misc_state["in run"])
        smithereen_suggestions.listAppend("Handsome Devil: single-turn +100% item");
	
}

RegisterResourceGenerationFunction("IOTMSmithsnessGenerateResource");
void IOTMSmithsnessGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (__misc_state["in run"] && $item[handful of smithereens].available_amount() > 0 && in_ronin())
	{
		string [int] smithereen_suggestions;
		smithsnessGenerateSmithereensSuggestions(smithereen_suggestions);
		resource_entries.listAppend(ChecklistEntryMake(493, "__item handful of smithereens", "", ChecklistSubentryMake(pluralise($item[handful of smithereens]), "", smithereen_suggestions.listJoinComponents("<hr>")), 10));
	}
	if (__misc_state["in run"] && $item[lump of Brituminous coal].available_amount() > 0 && in_ronin())
	{
		string [int] coal_suggestions;
		smithsnessGenerateCoalSuggestions(coal_suggestions);
		resource_entries.listAppend(ChecklistEntryMake(494, "__item lump of Brituminous coal", "", ChecklistSubentryMake(pluralise($item[lump of Brituminous coal]), "", coal_suggestions.listJoinComponents("<hr>")), 10));
	}
	if ($item[flaskfull of hollow].available_amount() > 0 && $effect[Merry Smithsness].have_effect() < 25 && __misc_state["in run"])
	{
		int turns_left = $effect[Merry Smithsness].have_effect();
		string [int] details;
		details.listAppend(pluralise((turns_left + 150 * $item[flaskfull of hollow].available_amount()), "turn", "turns") + " of +25 smithsness");
		if (turns_left > 0)
			details.listAppend("Effect will run out in " + pluralise(turns_left, "turn", "turns"));
		resource_entries.listAppend(ChecklistEntryMake(495, "__item flaskfull of hollow", "inventory.php?which=3", ChecklistSubentryMake(pluralise($item[flaskfull of hollow]), "", details), 10));
	}
}


void SugarGenerateSuggestions(string [int] suggestions)
{
    if (!__misc_state["in run"])
        return;
    if ($item[sugar shield].available_amount() == 0 && $item[snow suit].available_amount() == 0)
        suggestions.listAppend("Sugar shield: +10 familiar weight equip");
    if ($item[sugar chapeau].available_amount() == 0 && !__quest_state["Level 13"].state_boolean["past tower monsters"])
        suggestions.listAppend("Sugar chapeau: +50% spell damage (tower killing)");
}

RegisterResourceGenerationFunction("IOTMSugarGenerateResource");
void IOTMSugarGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$item[sugar sheet].is_unrestricted())
        return;
    item [int] sugar_crafted_items;
    for i from 4178 to 4183
    {
        sugar_crafted_items.listAppend(i.to_item());
    }
    ChecklistSubentry [int] subentries;
    
    string image_name = "";
    
    if ($item[sugar sheet].available_amount() > 0 && __misc_state["in run"] && in_ronin())
    {
        string [int] suggestions;
        SugarGenerateSuggestions(suggestions);
        subentries.listAppend(ChecklistSubentryMake(pluralise($item[sugar sheet]), "", suggestions));
        
        image_name = "sugar sheet";
    }
    foreach key in sugar_crafted_items
    {  
        item it = sugar_crafted_items[key];
        if (it.available_amount() == 0)
            continue;
        int counter = get_property_int("sugarCounter" + it.to_int());
        if (counter == 0 && (!__misc_state["in run"] || !in_ronin())) //in aftercore, probably not as relevant
            continue;
        int combats_left = 31 - counter;
        subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", pluralise(combats_left, "combat", "combats") + " left."));
        if (image_name.length() == 0)
            image_name = it;
    }
    if (subentries.count() > 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(605, image_name, "", subentries, 10));
    }
}

RegisterResourceGenerationFunction("IOTMTomesGenerateResource");
void IOTMTomesGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (true)
	{
		ChecklistSubentry [int] subentries;		
		
		int tome_count = 0;
		
		string [skill] tome_summons_property_names;
		tome_summons_property_names[$skill[Summon Smithsness]] = "_smithsnessSummons";
		tome_summons_property_names[$skill[summon clip art]] = "_clipartSummons";
		tome_summons_property_names[$skill[Summon Sugar Sheets]] = "_sugarSummons";
		tome_summons_property_names[$skill[Summon Snowcones]] = "_snowconeSummons";
		tome_summons_property_names[$skill[Summon Stickers]] = "_stickerSummons";
		tome_summons_property_names[$skill[Summon Rad Libs]] = "_radlibSummons";
		
		int [skill] summons_available;
		foreach s in tome_summons_property_names
		{
			string property_name = tome_summons_property_names[s];
			int value = 0;
			if (s.skill_is_usable())
			{
				if (in_ronin())
					value = 3 - get_property_int("tomeSummons");
				else
					value = 3 - get_property_int(property_name);
                if (value > 0)
                {
                    tome_count += 1;
                }
			}
			summons_available[s] = value;
		}
        if (tome_count == 0)
            return;
		
        if (in_ronin())
        {
            int summons_remaining = 3 - get_property_int("tomeSummons");
            subentries.listAppend(ChecklistSubentryMake(pluralise(summons_remaining, "tome summon", "tome summons") + " remaining", "", ""));
        }
        
        
		if (summons_available[$skill[Summon Smithsness]] > 0)
		{
			string [int] description;
			
			string [int] flask_suggestions;
			
			string [int] smithereen_suggestions;
			smithsnessGenerateSmithereensSuggestions(smithereen_suggestions);
			
			
			string [int] coal_suggestions;
			smithsnessGenerateCoalSuggestions(coal_suggestions);
			
			if (true)
			{
                int merry_smithsness_currently_available = $item[flaskfull of hollow].available_amount() * 150 + $effect[merry smithsness].have_effect();
				string building_line = "+25 smithsness (150 turns)";
				if (merry_smithsness_currently_available > 0)
					building_line += " (" + merry_smithsness_currently_available + " turns currently available)";
				flask_suggestions.listAppend(building_line);
				
			}
			
            
            if (__misc_state["in run"])
            {
                description.listAppend("1 Flaskfull of Hollow" + HTMLGenerateIndentedText(flask_suggestions.listJoinComponents("<hr>")));
                description.listAppend("1 Lump of Brituminous coal" + HTMLGenerateIndentedText(coal_suggestions.listJoinComponents("<hr>")));
                description.listAppend("1 Handful of Smithereens" + HTMLGenerateIndentedText(smithereen_suggestions.listJoinComponents("<hr>")));
            }
            else
                description.listAppend("Flaskfull of Hollow, Lump of Brituminous coal, and Handful of Smithereens");

			
			string name = "The Smith's Tome";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Smithsness]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
			
		}
		if (summons_available[$skill[summon clip art]] > 0)
		{
			string [int] description;
            if (__misc_state["in run"])
            {
                if ($item[shining halo].available_amount() == 0 && __misc_state["need to level"])
                    description.listAppend("Shining halo: +3 stats/fight when unarmed");
                if ($item[frosty halo].available_amount() == 0 && $item[a light that never goes out].available_amount() == 0)
                    description.listAppend("Frosty halo: 25% items when unarmed");
                if ($item[furry halo].available_amount() == 0)
                {
                    string line = "Furry halo: +5 familiar weight when unarmed";
                    if (__misc_state["free runs available"])
                        line += " (1 free run/day)";
                    description.listAppend(line);
                }
                if ($item[time halo].available_amount() == 0 && my_daycount() <3 )
                    description.listAppend("Time halo: +5 adventures/day");
                    
                if ($item[bucket of wine].available_amount() == 0 && __misc_state["can drink just about anything"])
                {
                    if ($skill[the ode to booze].skill_is_usable())
                        description.listAppend("Bucket of wine: 28 adventures nightcap with ode");
                    else if (!get_property_ascension("hiddenTavernUnlock") && $item[ye olde meade].available_amount() == 0) //just use fog murderers or meade instead, about the same
                        description.listAppend("Bucket of wine: 18 adventures nightcap");
                }
                    
                if (__misc_state["can eat just about anything"] && __misc_state["need to level"])
                    description.listAppend("Ultrafondue: 3 fullness awesome food, +15ML for 30 adventures");
                if (true)
                {
                    string line = "Crystal skull: banish in high monster count zones";
                    if ($skill[Summon Smithsness].skill_is_usable() && !__misc_state["in aftercore"])
                        line += "|*Smith's Tome has a better one";
                    description.listAppend(line);
                }
                if ($item[borrowed time].available_amount() == 0 && !get_property_boolean("_borrowedTimeUsed") && my_daycount() > 1)
                    description.listAppend("Borrowed time: 20 adventures on last day");
                
                string [int] familiar_suggestions;
                if (familiar_is_usable($familiar[he-boulder]) && $item[quadroculars].available_amount() == 0 && !$skill[Disintegrate].have_skill())
                    familiar_suggestions.listAppend("He-Boulder 100-turn YR");
                if (familiar_is_usable($familiar[obtuse angel]) && !familiar_is_usable($familiar[Reanimated Reanimator]))
                    familiar_suggestions.listAppend("+1 angel copy");
                    
                if (familiar_suggestions.count() > 0)
                    description.listAppend("Box of familiar jacks: free familiar equipment (" + listJoinComponents(familiar_suggestions, ", ") + ")");
                else
                    description.listAppend("Box of familiar jacks: free familiar equipment");
            }
			
			string name = "Tome of Clip Art";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Clip Art]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
		}
		if (summons_available[$skill[Summon Sugar Sheets]] > 0)
		{
			string [int] description;
            
            SugarGenerateSuggestions(description);
				
			string name = "Tome of Sugar Shummoning";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Sugar Sheets]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
		}
		if (summons_available[$skill[Summon Snowcones]] > 0)
		{
			string [int] description;
			//FIXME check this
			
			string name = "Tome of Snowcone Summoning";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Snowcones]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
		}
		if (summons_available[$skill[Summon Stickers]] > 0)
		{
			string [int] description;
			//FIXME check this
			
			string name = "Scratch 'n' Sniff Sticker Tome";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Stickers]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
		}
		if (summons_available[$skill[Summon Rad Libs]] > 0)
		{
			string [int] description;
			
			//FIXME check this
			
			string name = "Tome of Rad Libs";
			if (!in_ronin())
				name = pluralise(summons_available[$skill[Summon Rad Libs]], name + " summon", name + " summons");
			subentries.listAppend(ChecklistSubentryMake(name, "", description));
		}
		
        
        ChecklistEntry entry = ChecklistEntryMake(460, "__item tome of clip art", "campground.php?action=bookshelf", subentries);
        if (in_ronin())
            entry.should_indent_after_first_subentry = true;
        entry.ChecklistEntrySetCategory("iotm");
        resource_entries.listAppend(entry);
	}
}

Record COTSuggestion
{
    string reason;
    familiar [int] familiars;
};


COTSuggestion COTSuggestionMake(string reason, familiar [int] familiars)
{
    COTSuggestion suggestion;
    suggestion.reason = reason;
    suggestion.familiars = familiars;
    
    return suggestion;
}

COTSuggestion COTSuggestionMake(string reason, familiar f)
{
    familiar [int] familiar_list;
    familiar_list.listAppend(f);
    return COTSuggestionMake(reason, familiar_list);
}

COTSuggestion COTSuggestionMake(string reason, boolean [familiar] familiars_in)
{
    familiar [int] familiars_out;
    foreach f in familiars_in
        familiars_out.listAppend(f);
    return COTSuggestionMake(reason, familiars_out);
}

void listAppend(COTSuggestion [int] list, COTSuggestion entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}


//Follows in order. If we can't find one in the first set, we check the second, then third, etc.
//This allows for supporting +25% meat, then falling back on +20%, etc.
Record COTSuggestionSet
{
    COTSuggestion [int] suggestions;
};

COTSuggestionSet COTSuggestionSetMake(COTSuggestion [int] suggestions)
{
    COTSuggestionSet suggestion_set;
    suggestion_set.suggestions = suggestions;
    
    return suggestion_set;
}

COTSuggestionSet COTSuggestionSetMake(COTSuggestion suggestion)
{
    COTSuggestionSet suggestion_set;
    suggestion_set.suggestions.listAppend(suggestion);
    
    return suggestion_set;
}

void listAppend(COTSuggestionSet [int] list, COTSuggestionSet entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}


void IOTMCOTGenerateSuggestions(string [int] description)
{
    familiar enthroned_familiar = my_enthroned_familiar();
    familiar bjorned_familiar = my_bjorned_familiar();
    //Suggest what it offers:
    COTSuggestionSet [int] suggestion_sets;
    
    boolean have_two_available = false;
    if ($item[crown of thrones].available_amount() > 0 && $item[Buddy Bjorn].available_amount() > 0)
        have_two_available = true;

    //Relevant:
    //+10ML
    suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+10 ML and +MP regen", $familiar[el vibrato megadrone])));
    //+15% item drops, or +10%
    if (true)
    {
        COTSuggestion [int] suggestions;
        suggestions.listAppend(COTSuggestionMake("+15% items", $familiars[li'l xenomorph, feral kobold]));
        suggestions.listAppend(COTSuggestionMake("+10% items", $familiars[Reassembled Blackbird,Reconstituted Crow,Oily Woim]));
        suggestion_sets.listAppend(COTSuggestionSetMake(suggestions));
    }
    //+2 moxie/muscle/mysticality stats/fight
    if (__misc_state["need to level"])
    {
        if (my_primestat() == $stat[moxie])
        {
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+2 mainstat/fight", $familiars[blood-faced volleyball,jill-o-lantern, nervous tick,mariachi chihuahua, cymbal-playing monkey,hovering skull])));
        }
        else if (my_primestat() == $stat[mysticality])
        {
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+2 mainstat/fight", $familiars[reanimated reanimator,dramatic hedgehog,cheshire bat,pygmy bugbear shaman,hovering sombrero,sugar fruit fairy, uniclops])));
        }
        else if (my_primestat() == $stat[muscle])
        {
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+2 mainstat/fight", $familiars[hunchbacked minion, killer bee, grinning turtle,chauvinist pig, baby mutant rattlesnake])));
        }
    }
    //+25% / +20% meat from monsters
    if (true)
    {
        COTSuggestion [int] suggestions;
        suggestions.listAppend(COTSuggestionMake("+25% meat", $familiars[Knob Goblin Organ Grinder,Happy Medium,Hobo Monkey]));
        suggestions.listAppend(COTSuggestionMake("+20% meat", $familiars[Dancing Frog,Psychedelic Bear,Hippo Ballerina,Attention-Deficit Demon,Piano Cat,Coffee Pixie,Obtuse Angel,Hand Turkey,Leprechaun,Grouper Groupie,Mutant Cactus Bud,Jitterbug,Casagnova Gnome]));
        suggestion_sets.listAppend(COTSuggestionSetMake(suggestions));
    }
    //+5 to familiar weight
    suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+5 familiar weight", $familiars[Gelatinous Cubeling,Pair of Ragged Claws,Spooky Pirate Skeleton,Autonomous Disco Ball,Ghost Pickle on a Stick,Misshapen Animal Skeleton,Animated Macaroni Duck,Penguin Goodfella,Barrrnacle])));
    //+20% to combat init
    if (__misc_state["in run"])
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+20% init", $familiars[Teddy Bear,Emo Squid,Evil Teddy Bear,Syncopated Turtle,Untamed Turtle,Mini-Skulldozer,Cotton Candy Carnie,Origami Towel Crane,Feather Boa Constrictor,Levitating Potato,Temporal Riftlet,Squamous Gibberer,Cuddlefish,Teddy Borg])));
    //+15% to moxie/muscle/mysticality
    if (__misc_state["in run"])
    {
        if (true)
        {
            //Either scaling monster levelling, or the NS
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+15% moxie", $familiars[Ninja Snowflake,Nosy Nose,Clockwork Grapefruit,Sabre-Toothed Lime])));
        }
        if (my_primestat() == $stat[mysticality] && __misc_state["need to level"])
        {
            //Scaling monster levelling
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+15% mysticality", $familiars[Ragamuffin Imp,Inflatable Dodecapede,Scary Death Orb,Snowy Owl,grue])));
        }
        else if (my_primestat() == $stat[muscle] && __misc_state["need to level"])
        {
            //Scaling monster levelling
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+15% muscle", $familiars[MagiMechTech MicroMechaMech,Angry Goat,Wereturtle,Stab Bat,Wind-up Chattering Teeth,Imitation Crab])));
        }
    }
    //+20%/+15%/+10% to spell damage
    //Too marginal?
    /*if (__misc_state["in run"])
    {
        COTSuggestion [int] suggestions;
        suggestions.listAppend(COTSuggestionMake("+20% spell damage", $familiar[mechanical songbird]));
        suggestions.listAppend(COTSuggestionMake("+15% spell damage", $familiars[Magic Dragonfish,Pet Cheezling,Rock Lobster]));
        suggestions.listAppend(COTSuggestionMake("+10% spell damage", $familiars[Midget Clownfish,Star Starfish,Baby Yeti,Snow Angel,Wizard Action Figure,Dataspider,Underworld Bonsai,Whirling Maple Leaf,Rogue Program,Howling Balloon Monkey]));
        suggestion_sets.listAppend(COTSuggestionSetMake(suggestions));
    }*/
    //hot wings from reanimator
    if (true)
    {
        string [int] reanimator_reasons;
        
        if (__quest_state["Pirate Quest"].state_boolean["need more hot wings"])
            reanimator_reasons.listAppend("hot wings");
        
        if (reanimator_reasons.count() > 0)
            suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake(reanimator_reasons.listJoinComponents(", ").capitaliseFirstLetter(), $familiar[reanimated reanimator])));
    }
    if (__misc_state["in run"])
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("50% block", $familiar[Mariachi Chihuahua])));
    
    //knob mushrooms from badger
    if (__misc_state["in run"] && __misc_state["can eat just about anything"])
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("Knob mushrooms", $familiar[astral badger])));
        
    boolean need_cold_res = false;
    boolean need_all_res = false;
    //At a-boo peak, but not finished with it:
    if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0 && __quest_state["Level 9"].state_boolean["bridge complete"])
        need_all_res = true;
    //Climbing the peak:
    if (__quest_state["Level 8"].state_boolean["Past mine"] && !__quest_state["Level 8"].state_boolean["Groar defeated"] && numeric_modifier("cold resistance") < 5.0)
        need_cold_res = true;
    
    if (__misc_state["in run"] && need_cold_res)
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+3 cold res", $familiar[Flaming Face])));
    if (need_cold_res && !$familiar[flaming face].have_familiar_replacement())
        need_all_res = true;
    if (__misc_state["in run"] && need_all_res)
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+2 all res", $familiars[Bulky Buddy Box,Exotic Parrot,Holiday Log,Pet Rock,Toothsome Rock])));
        
    //if (__misc_state["in run"] && availableSpleen() >= 4)
        //suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("Spleen items", $familiar[Grim Brother])));
    
    //slightly powerful:
    suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("+combat", $familiar[Grim Brother])));
    suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("-combat", $familiar[Grimstone Golem])));
    
    if (get_property_int("_grimstoneMaskDropsCrown") == 0)
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("Grimstone mask", $familiar[Grimstone Golem])));
    if (get_property_int("_grimFairyTaleDropsCrown") < 2 && !(__misc_state["in run"] && spleen_limit() == 0))
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake(pluraliseWordy(clampi(2 - get_property_int("_grimFairyTaleDropsCrown"), 0, 2), "spleen item", "spleen items").capitaliseFirstLetter(), $familiar[grim Brother])));
    
    if ($item[blackberry].available_amount() < 3 && $item[blackberry galoshes].available_amount() == 0 && __quest_state["Level 11"].mafia_internal_step < 2)
        suggestion_sets.listAppend(COTSuggestionSetMake(COTSuggestionMake("Blackberries for galoshes", $familiars[reassembled blackbird,reconstituted crow])));
    string [int][int] familiar_options;
    foreach key in suggestion_sets
    {
        boolean found_relevant = false;
        COTSuggestionSet suggestion_set = suggestion_sets[key];
        foreach key2 in suggestion_set.suggestions
        {
            //Suggest the familiar with the highest weight, under the assumption they're using it more.
            COTSuggestion suggestion = suggestion_set.suggestions[key2];
            familiar best_familiar_by_weight = $familiar[none];
            familiar second_best_familiar_by_weight = $familiar[none];
            foreach key3 in suggestion.familiars
            {
                familiar f = suggestion.familiars[key3];
                if (f == $familiar[none]) //didn't find it
                    continue;
                if (f.have_familiar_replacement())
                {
                    if ((best_familiar_by_weight != enthroned_familiar || enthroned_familiar == $familiar[none]) && (best_familiar_by_weight == $familiar[none] || f.familiar_weight() > best_familiar_by_weight.familiar_weight() || f == enthroned_familiar))
                    {
                        second_best_familiar_by_weight = best_familiar_by_weight;
                        best_familiar_by_weight = f;
                    }
                    else if (second_best_familiar_by_weight == $familiar[none] || f.familiar_weight() > second_best_familiar_by_weight.familiar_weight())
                    {
                        if (best_familiar_by_weight != f)
                            second_best_familiar_by_weight = f;
                    }
                }
            }
            if (best_familiar_by_weight != $familiar[none])
            {
                string familiar_string;
                
                familiar_string = best_familiar_by_weight;
                if ((enthroned_familiar == best_familiar_by_weight && enthroned_familiar != $familiar[none]) || (bjorned_familiar == best_familiar_by_weight && bjorned_familiar != $familiar[none]))
                    familiar_string = HTMLGenerateSpanOfClass(best_familiar_by_weight, "r_bold");
                    
                if (second_best_familiar_by_weight != $familiar[none] && have_two_available)
                    familiar_string += "|" + second_best_familiar_by_weight;
                familiar_options.listAppend(listMake(suggestion.reason, familiar_string));
                break;
            }
        }
    }
    if (familiar_options.count() > 0)
        description.listAppend(HTMLGenerateSimpleTableLines(familiar_options));
}

RegisterResourceGenerationFunction("IOTMCOTGenerateResource");
void IOTMCOTGenerateResource(ChecklistEntry [int] resource_entries)
{
	if ($item[crown of thrones].available_amount() == 0 && $item[Buddy Bjorn].available_amount() == 0)
		return;
    if (__misc_state["familiars temporarily blocked"]) //avatar paths
        return;
	string [int] description;
    
    item crown_item = $item[crown of thrones];
    if (crown_item.equipped_amount() == 0 && $item[Buddy Bjorn].available_amount() > 0)
        crown_item = $item[Buddy Bjorn];
    
    string image_name = "__item " + crown_item;
    familiar enthroned_familiar = my_enthroned_familiar();
    familiar bjorned_familiar = my_bjorned_familiar();
    
    if (($item[crown of thrones].equipped_amount() > 0 || $item[Buddy Bjorn].equipped_amount() > 0) || __misc_state["in run"])
    {
        IOTMCOTGenerateSuggestions(description);
    }
    
	if (enthroned_familiar != $familiar[none])
    {
		description.listAppend(enthroned_familiar + " enthroned.");
        //image_name = "__familiar " + enthroned_familiar.to_string();
    }
    if (bjorned_familiar != $familiar[none])
		description.listAppend(bjorned_familiar + " bjorned.");
    //FIXME my_bjorned_familiar() when 16.3
    
    string url = "familiar.php";
    if ($item[crown of thrones].equipped_amount() == 0 && $item[Buddy Bjorn].equipped_amount() == 0)
        url = "inventory.php?which=2";
        
    string header = crown_item;
    item [int] available_sources;
    
    if ($item[Buddy Bjorn].available_amount() > 0)
        available_sources.listAppend($item[Buddy Bjorn]);
    if ($item[crown of thrones].available_amount() > 0)
        available_sources.listAppend($item[crown of thrones]);
    if (available_sources.count() > 0)
        header = available_sources.listJoinComponents(", ", "and");
        
    if (description.count() > 0)
        resource_entries.listAppend(ChecklistEntryMake(503, image_name, url, ChecklistSubentryMake(header, "", description), 8));
}
RegisterResourceGenerationFunction("IOTMLibramGenerateResource");
void IOTMLibramGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (__misc_state["bookshelf accessible"])
	{
		int libram_mp_cost = nextLibramSummonMPCost();
		
		
		string [int] librams_usable;
		foreach s in __libram_skills
        {
			if (s.skill_is_usable())
				librams_usable.listAppend(s.to_string());
        }
		if (libram_mp_cost <= my_maxmp() && librams_usable.count() > 0)
		{
			ChecklistSubentry subentry;
			if (librams_usable.count() == 1)
				subentry.header = "Libram";
			else
				subentry.header = "Librams";
			subentry.header += " summonable";
			subentry.modifiers.listAppend(libram_mp_cost + "MP cost");
			
			string [int] readable_list;
			foreach key in librams_usable
			{
				string libram_name = librams_usable[key];
				if (libram_name.stringHasPrefix("Summon "))
					libram_name = libram_name.substring(7);
				readable_list.listAppend(libram_name);
			}
			
			subentry.entries.listAppend(readable_list.listJoinComponents(", ", "and") + ".");
            
            if ($skill[summon taffy].skill_is_usable() && get_property_int("_taffyYellowSummons") == 0)
            {
                float chance = powf(0.5, MAX(0, get_property_int("_taffyRareSummons") + 1));
                subentry.entries.listAppend("Could try to summon a yellow taffy. (" + (chance * 100.0).roundForOutput(1) + "% chance)");
                //_taffyYellowSummons
            }
            
			resource_entries.listAppend(ChecklistEntryMake(481, "__item libram of divine favors", "campground.php?action=bookshelf", subentry, 7).ChecklistEntrySetCategory("iotm").ChecklistEntrySetShortDescription(libram_mp_cost + "mp"));
		}
		
		
		if ($skill[summon brickos].skill_is_usable() && __misc_state["in run"])
		{
			if (get_property_int("_brickoEyeSummons") <3)
			{
				ChecklistSubentry subentry;
				subentry.header =  (3 - get_property_int("_brickoEyeSummons")) + " BRICKO&trade; eye bricks obtainable";
				subentry.entries.listAppend("Cast Summon BRICKOs libram. (" + libram_mp_cost + " mp)");
				resource_entries.listAppend(ChecklistEntryMake(482, "__item bricko eye brick", "campground.php?action=bookshelf", subentry, 9));
				
			}
		}
	}
	
	if ((__misc_state["in run"] || true) && availableDrunkenness() >= 0)
	{
		boolean [item] all_possible_bricko_fights = $items[bricko eye brick,bricko airship,bricko bat,bricko cathedral,bricko elephant,bricko gargantuchicken,bricko octopus,bricko ooze,bricko oyster,bricko python,bricko turtle,bricko vacuum cleaner];
		
		int bricko_potential_fights_available = 0;
		foreach it in $items[bricko eye brick,bricko airship,bricko bat,bricko cathedral,bricko elephant,bricko gargantuchicken,bricko octopus,bricko ooze,bricko oyster,bricko python,bricko turtle,bricko vacuum cleaner]
		{
			bricko_potential_fights_available += it.available_amount();
		}
		bricko_potential_fights_available = MIN(10 - get_property_int("_brickoFights"), bricko_potential_fights_available);
        if (!in_ronin())
            bricko_potential_fights_available = clampi(10 - get_property_int("_brickoFights"), 0, 10);
		if (bricko_potential_fights_available > 0)
		{
			ChecklistSubentry subentry;
			subentry.header = pluralise(bricko_potential_fights_available, "BRICKO&trade; fight", "BRICKO&trade; fights") + " ready";
			
			
			foreach fight in all_possible_bricko_fights
			{
				int number_available = fight.available_amount();
				if (number_available > 0)
                {
                    string line = pluralise(number_available, fight);
                    
                    if ($items[rock band flyers,jam band flyers].available_amount() > 0 && !__quest_state["Level 12"].state_boolean["Arena Finished"] && __quest_state["Level 12"].in_progress && get_property_int("flyeredML") < 10000)
                    {
                        monster m = fight.to_string().to_monster(); //is there a better way to look this up?
                        line += " (" + m.base_initiative + "% init)";
                    }
					subentry.entries.listAppend(line);
                }
			}
			
			item [int] craftable_fights;
			string [int] creatable;
			foreach fight in all_possible_bricko_fights
			{
                monster m = fight.to_string().to_monster(); //is there a better way to look this up?
				int bricks_needed = get_ingredients_fast(fight)[$item[bricko brick]];
				int monster_level = m.raw_attack;
				int number_available = creatable_amount(fight);
				if (number_available > 0)
				{
					craftable_fights.listAppend(fight);
					creatable.listAppend(pluralise(number_available, fight) + " (" + bricks_needed + " bricks, " + monster_level + "ML)");
				}
			}
			
			if (creatable.count() > 0)
            {
				//subentry.entries.listAppend("Creatable: (" + $item[bricko brick].available_amount() + " bricks available)" + HTMLGenerateIndentedText(creatable));
    			string creations_line = "(" + $item[bricko brick].available_amount() + " bricks available)" + HTMLGenerateIndentedText(creatable.listJoinComponents("<hr>"));
                
    			if (creatable.count() < 4)
                {
                	creations_line = "(" + $item[bricko brick].available_amount() + " bricks available)" + HTMLGenerateIndentedText(creatable.listJoinComponents("<hr>"));
                	subentry.entries.listAppend("Creatable: " + creations_line);
                }
                else
                {
                	creations_line = $item[bricko brick].available_amount() + " bricks available.<br><br>" + creatable.listJoinComponents("<hr>");
	                subentry.entries.listAppend(HTMLGenerateTooltip("Mouse over for all potential Bricko creations.", creations_line));
                }
            }
				
			resource_entries.listAppend(ChecklistEntryMake(483, "__item bricko brick", "inventory.php?which=3", subentry, 7)).ChecklistEntryTag("daily free fight");
		}
	}
}
void generateGardenEntry(ChecklistEntry [int] resource_entries, boolean [item] garden_source_items, boolean [item] garden_creatable_items)
{
    ChecklistSubentry [int] subentries;
    string image_name = "";
    foreach it in garden_source_items
    {
        if (it.available_amount() == 0) continue;
        if (image_name.length() == 0)
            image_name = "__item " + it;
        subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", ""));
    }
    if (subentries.count() > 0)
    {
        ChecklistSubentry subentry = subentries[subentries.count() - 1]; //hacky
        
        
        int [item] creatable_items = garden_creatable_items.creatable_items();
        string [int] output_list;
        foreach it in creatable_items
        {
            int amount = creatable_items[it];
            
            if (it.to_slot() != $slot[none] && it.available_amount() > 0) //already have one
                continue;
            output_list.listAppend(pluralise(amount, it));
        }
        if (output_list.count() > 0)
        {
            subentry.entries.listAppend("Can create " + output_list.listJoinComponents(", ", "or") + ".");
        }
        resource_entries.listAppend(ChecklistEntryMake(541, image_name, "", subentries, 8));
    }
}


RegisterResourceGenerationFunction("IOTMGardensGenerateResource");
void IOTMGardensGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!__misc_state["in run"] || !in_ronin())
        return;

    //Garden items:
    if (true)
    {
        boolean [item] garden_creatable_items;
        garden_creatable_items[$item[pumpkin juice]] = true;
        if (__misc_state["can eat just about anything"])
            garden_creatable_items[$item[pumpkin pie]] = true;
        if (__misc_state["can drink just about anything"])
            garden_creatable_items[$item[pumpkin beer]] = true;
        if (__misc_state_string["yellow ray source"] == 4766.to_item().to_string())
            garden_creatable_items[4766.to_item()] = true;
        
        generateGardenEntry(resource_entries, $items[pumpkin], garden_creatable_items);
    }
    if (true)
    {
        boolean [item] garden_creatable_items;
        if (__misc_state["can eat just about anything"])
            garden_creatable_items[$item[peppermint patty]] = true;
        if (__misc_state["can drink just about anything"])
            garden_creatable_items[$item[peppermint twist]] = true;
        if (__misc_state["free runs usable"])
            garden_creatable_items[$item[peppermint parasol]] = true;
        garden_creatable_items[$item[peppermint crook]] = true;
        generateGardenEntry(resource_entries, $items[peppermint sprout], garden_creatable_items);
    }
    if (true)
    {
        boolean [item] garden_creatable_items;
        if (__misc_state["can eat just about anything"])
            garden_creatable_items[$item[skeleton quiche]] = true;
        if (__misc_state["can drink just about anything"])
            garden_creatable_items[$item[crystal skeleton vodka]] = true;
        if (!__misc_state["mysterious island available"])
            garden_creatable_items[$item[skeletal skiff]] = true;
        if (hippy_stone_broken())
            garden_creatable_items[$item[auxiliary backbone]] = true;
        generateGardenEntry(resource_entries, $items[skeleton], garden_creatable_items);
    }
    if (true)
    {
        generateGardenEntry(resource_entries, $items[handful of barley,cluster of hops,fancy beer bottle,fancy beer label], $items[can of Br&uuml;talbr&auml;u,can of Drooling Monk,can of Impetuous Scofflaw,bottle of old pugilist,bottle of professor beer,bottle of rapier witbier,artisanal homebrew gift package]);
    }
    if (true)
    {
        boolean [item] garden_creatable_items;
        
        foreach it in $items[snow cleats,snow crab,unfinished ice sculpture,snow mobile,ice bucket,bod-ice,snow belt,ice house,ice nine]
            garden_creatable_items[it] = true;
        
        if (!__quest_state["Level 9"].state_boolean["bridge complete"])
            garden_creatable_items[$item[snow boards]] = true;
        
        if (!__quest_state["Level 4"].finished)
            garden_creatable_items[$item[snow shovel]] = true;
        
        if (__misc_state["can eat just about anything"])
            garden_creatable_items[$item[snow crab]] = true;
        if (__misc_state["can drink just about anything"])
            garden_creatable_items[$item[Ice Island Long Tea]] = true;
        if (hippy_stone_broken())
            garden_creatable_items[$item[ice nine]] = true;
        
        
        generateGardenEntry(resource_entries, $items[snow berries, ice harvest], garden_creatable_items);
    }
}
RegisterResourceGenerationFunction("IOTMPlasticVampireFangsGenerateResource");
void IOTMPlasticVampireFangsGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$item[plastic vampire fangs].is_unrestricted())
        return;
    if ($items[plastic vampire fangs,Interview With You (a Vampire)].available_amount() == 0)
        return;
    item fang_source = $item[plastic vampire fangs];
    string url = "";
    string separator = " " + __html_right_arrow_character + " ";
    if ($item[plastic vampire fangs].available_amount() == 0)
    {
        fang_source = $item[Interview With You (a Vampire)];
            url = "inventory.php?which=3";
    }
    else
    {
        url = "place.php?whichplace=town";
        if ($item[plastic vampire fangs].equipped_amount() == 0)
        {
            url = generateEquipmentLink($item[plastic vampire fangs]);
        }
    }
    
    if (!get_property_boolean("_interviewIsabella") && __misc_state["in run"] && __misc_state["need to level"])
    {
        string [int] description;
        int stats_gained = MIN(500, 4 * my_basestat(my_primestat())) * (1.0 + numeric_modifier(my_primestat().to_string() + " Experience Percent") / 100.0);
        
        description.listAppend(stats_gained + " " + my_primestat().to_lower_case() + " gained, one adventure cost.");
        if ($item[plastic vampire fangs].available_amount() == 0)
        {
            description.listAppend("Vamp out via Interview With You (a Vampire).");
        }
        else
        {
            if ($item[plastic vampire fangs].equipped_amount() == 0)
            {
                description.listAppend("Equip plastic vampire fangs, then vamp out in Seaside Town.");
            }
            else
                description.listAppend("Vamp out in Seaside Town.");
        }
        
        if (my_primestat() == $stat[muscle])
            description.listAppend("Visit Isabella's" + separator + "Drain Her.");
        else if (my_primestat() == $stat[mysticality])
            description.listAppend("Visit Isabella's" + separator + "Tell Her How You Feel" + separator + "Find Other Prey.");
        else if (my_primestat() == $stat[moxie])
            description.listAppend("Visit Isabella's" + separator + "Redirect Your Desire" + separator + "Go to the Bar.");
        
        
        resource_entries.listAppend(ChecklistEntryMake(590, "__item " + fang_source, url, ChecklistSubentryMake("Vampire stats", "", description), 5));
        
    }

    if (!__misc_state["in run"])
    {
        string [int] description;
        if ($item[plastic vampire fangs].available_amount() == 0)
        {
            description.listAppend("Vamp out via Interview With You (a Vampire).");
        }
        else
        {
            if ($item[plastic vampire fangs].equipped_amount() == 0)
            {
                description.listAppend("Equip plastic vampire fangs, then vamp out in Seaside Town.");
            }
            else
                description.listAppend("Vamp out in Seaside Town.");
        }
        
        int vamp_outs_remaining = 0;
        
        //Disabled, unless there's something useful about these to be reminded of in aftercore:
        /*if (!get_property_boolean("_interviewVlad"))
        {
            description.listAppend("Vlad's Boutique - DR or spell damage or weapon damage buff.");
            vamp_outs_remaining += 1;
        }
        if (!get_property_boolean("_interviewIsabella"))
        {
            description.listAppend("Isabella's - mainstat gain, meat.");
            vamp_outs_remaining += 1;
        }*/
        if (!get_property_boolean("_interviewMasquerade"))
        {
            string [int] masquerade_description;
            if ($item[Sword of the Brouhaha Prince].available_amount() == 0)
            {
                string [int] interview_questions = listMake("Warehouse", "Growl", "The Clash", "Motorcycle", "Lager");
                string [int] nomination = listMake("Malkovich", "Torremolinos", "Brouhaha", "Ventrilo");
                string item_name = "Sword of the Brouhaha Prince";
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            if ($item[Chalice of the Malkovich Prince].available_amount() == 0)
            {
                string [int] interview_questions = listMake("Laugh Factory", "Giggle", "Glass breaking", "Wheelbarrow", "Blood");
                string [int] nomination = listMake("Torremolinos", "Ventrilo", "Brouhaha", "Malkovich");
                string item_name = "Chalice of the Malkovich Prince";
                
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            if ($item[Sceptre of the Torremolinos Prince].available_amount() == 0)
            {
                string [int] interview_questions = listMake("Loft", "Flirty", "Mozart", "Carriage", "Absinthe");
                string [int] nomination = listMake("Malkovich", "Ventrilo", "Torremolinos", "Brouhaha");
                string item_name = "Sceptre of the Torremolinos Prince";
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            if ($item[Medallion of the Ventrilo Prince].available_amount() == 0)
            {
                string [int] interview_questions = listMake("Penthouse", "Terse", "No time", "Limo", "Espresso");
                string [int] nomination = listMake("Ventrilo", "Malkovich", "Brouhaha", "Torremolinos");
                string item_name = "Medallion of the Ventrilo Prince";
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            if (true)
            {
                string [int] interview_questions = listMake("Warehouse", "Growl", "The Clash", "Motorcycle", "Lager");
                string [int] nomination = listMake("Ventrilo", "Brouhaha", "Torremolinos", "Malkovich");
                string item_name = "Your own black heart (restores 100% HP/MP)";
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            if ($item[plastic vampire fangs].available_amount() > 0)
            {
                string [int] interview_questions = listMake("Warehouse", "Growl", "The Clash", "Motorcycle", "Lager");
                string [int] nomination = listMake("Ventrilo", "Malkovich", "Torremolinos", "Brouhaha");
                string item_name = "Interview With You (a Vampire)";
                masquerade_description.listAppend(item_name + "|*Interview: " + interview_questions.listJoinComponents(separator) + "<hr>|*Nomination order: " + nomination.listJoinComponents(separator));
            }
            //description.listAppend("The Masquerade." + HTMLGenerateIndentedText(masquerade_description));
            description.listAppendList(masquerade_description);
            vamp_outs_remaining += 1;
        }
        
        if (vamp_outs_remaining > 0)
        {
            //resource_entries.listAppend(ChecklistEntryMake(591, "__item " + fang_source, url, ChecklistSubentryMake(pluralise(vamp_outs_remaining, "vamp out", "vamp outs"), "", description), 8));
            resource_entries.listAppend(ChecklistEntryMake(592, "__item " + fang_source, url, ChecklistSubentryMake("Vampire masquerade", "", description), 8));
        }
    }
}
//_dnaPotionsMade - int, count of potions made
//dnaSyringe - int, current phylum of syringe. seems to track if it's become empty? double check
//_dnaHybrid - boolean, true if you're become a human abomination today
//r13912 or higher


string [phylum] __dna_phylum_to_description;
string [phylum] __dna_phylum_to_description_colourless;
item [phylum] __dna_phylum_to_item;
effect [phylum] __dna_phylum_to_effect;
phylum [effect] __dna_effect_to_phylum;
string [int] __dna_intrinsic_ideas;

record DNASuggestion
{
    phylum [int] phylums;
    string relevant_effect_description;
    string reason;
    boolean always_show;
};


DNASuggestion DNASuggestionMake(phylum [int] phylums, string relevant_effect_description, string reason, boolean always_show)
{
    DNASuggestion result;
    result.phylums = phylums;
    result.relevant_effect_description = relevant_effect_description;
    result.reason = reason;
    result.always_show = always_show;
    return result;
}

DNASuggestion DNASuggestionMake(phylum p, string relevant_effect_description, string reason)
{
    phylum [int] phylums;
    phylums[0] = p;
    return DNASuggestionMake(phylums, relevant_effect_description, reason, false);
}

DNASuggestion DNASuggestionMake(phylum p, string relevant_effect_description, string reason, boolean always_show)
{
    phylum [int] phylums;
    phylums[0] = p;
    return DNASuggestionMake(phylums, relevant_effect_description, reason, always_show);
}


DNASuggestion DNASuggestionMake(boolean [phylum] phylums_in, string relevant_effect_description, string reason)
{
    phylum [int] phylums;
    foreach p in phylums_in
    {
        phylums.listAppend(p);
    }
    return DNASuggestionMake(phylums, relevant_effect_description, reason, false);
}

void listAppend(DNASuggestion [int] list, DNASuggestion entry)
{
	int position = list.count();
	while (list contains position)
		position += 1;
	list[position] = entry;
}

boolean DNAHavePhylum(phylum p)
{
    if (__dna_phylum_to_effect[p].have_effect() > 0)
        return true;
    
    if (__dna_phylum_to_item[p].available_amount() > 0)
        return true;
    
    return false;
}

string DNABoldPhylumIfCurrentMonster(phylum p)
{
    if (monster_phylum() == p)
        return HTMLGenerateSpanOfClass(p.to_string(), "r_bold");
    else
        return p.to_string();
}

DNASuggestion [int] __phylum_potion_suggestions;
DNASuggestion [int] __phylum_potion_reminder_suggestions;
effect __current_dna_intrinsic = $effect[none];

RegisterInitFunction("IOTMDNAInit");
void IOTMDNAInit()
{
    if (!__iotms_usable[$item[Little Geneticist DNA-Splicing Lab]])
        return;


    //this is not a particulary good idea:
    __dna_phylum_to_description[$phylum[beast]] = "+30 weapon damage";
	__dna_phylum_to_description[$phylum[bug]] = "+25% init";
	__dna_phylum_to_description[$phylum[constellation]] = "+50% meat";
	__dna_phylum_to_description[$phylum[construct]] = "+5 familiar weight, +50 DA, +5 DR";
	__dna_phylum_to_description[$phylum[dude]] = "+10% item, +10 muscle/mysticality/moxie";
	__dna_phylum_to_description[$phylum[elemental]] = "+3 resistances";
	__dna_phylum_to_description[$phylum[elf]] = "+100% spell damage, +50% candy drops";
	__dna_phylum_to_description[$phylum[fish]] = "+10 familiar weight";
	__dna_phylum_to_description[$phylum[goblin]] = "+20% pickpocket, +50% food drops";
	__dna_phylum_to_description[$phylum[hippy]] = "+1 stat/fight, +20 max MP";
	__dna_phylum_to_description[$phylum[humanoid]] = "+20% meat, +10% muscle/mysticality/moxie";
	__dna_phylum_to_description[$phylum[horror]] = "+10% critical hit, +10% critical spell hit";
	__dna_phylum_to_description[$phylum[mer-kin]] = "+25 ML";
	__dna_phylum_to_description[$phylum[orc]] = "+1 stat/fight, +40 max HP";
	__dna_phylum_to_description[$phylum[penguin]] = "+25% item";
	__dna_phylum_to_description[$phylum[pirate]] = "+50% gear drops, +50% booze drops";
    
    
	__dna_phylum_to_description_colourless[$phylum[demon]] = "+20 hot damage / hot spell damage";
	__dna_phylum_to_description_colourless[$phylum[hobo]] = "+20 stench damage / stench spell damage";
	__dna_phylum_to_description_colourless[$phylum[plant]] = "+20 cold damage / cold spell damage";
	__dna_phylum_to_description_colourless[$phylum[slime]] = "+20 sleaze damage / sleaze spell damage";
	__dna_phylum_to_description_colourless[$phylum[undead]] = "+20 spooky damage / spooky spell damage";
    
	__dna_phylum_to_description[$phylum[demon]] = HTMLGenerateSpanOfClass(__dna_phylum_to_description_colourless[$phylum[demon]], "r_element_hot_desaturated");
	__dna_phylum_to_description[$phylum[hobo]] = HTMLGenerateSpanOfClass(__dna_phylum_to_description_colourless[$phylum[hobo]], "r_element_stench_desaturated");
	__dna_phylum_to_description[$phylum[plant]] = HTMLGenerateSpanOfClass(__dna_phylum_to_description_colourless[$phylum[plant]], "r_element_cold_desaturated");
	__dna_phylum_to_description[$phylum[slime]] = HTMLGenerateSpanOfClass(__dna_phylum_to_description_colourless[$phylum[slime]], "r_element_sleaze_desaturated");
	__dna_phylum_to_description[$phylum[undead]] = HTMLGenerateSpanOfClass(__dna_phylum_to_description_colourless[$phylum[undead]], "r_element_spooky_desaturated");
    
	__dna_phylum_to_description[$phylum[weird]] = "+4 stats/fight";
    
    foreach p in __dna_phylum_to_description
    {
        if (__dna_phylum_to_description_colourless contains p)
            continue;
        __dna_phylum_to_description_colourless[p] = __dna_phylum_to_description[p];
    }
    
    __dna_phylum_to_item[$phylum[beast]] = $item[Gene Tonic: Beast];
    __dna_phylum_to_item[$phylum[bug]] = $item[Gene Tonic: Insect];
    __dna_phylum_to_item[$phylum[constellation]] = $item[Gene Tonic: Constellation];
    __dna_phylum_to_item[$phylum[construct]] = $item[Gene Tonic: Construct];
    __dna_phylum_to_item[$phylum[demon]] = $item[Gene Tonic: Demon];
    __dna_phylum_to_item[$phylum[dude]] = $item[Gene Tonic: Dude];
    __dna_phylum_to_item[$phylum[elemental]] = $item[Gene Tonic: Elemental];
    __dna_phylum_to_item[$phylum[elf]] = $item[Gene Tonic: Elf];
    __dna_phylum_to_item[$phylum[fish]] = $item[Gene Tonic: Fish];
    __dna_phylum_to_item[$phylum[goblin]] = $item[Gene Tonic: Goblin];
    __dna_phylum_to_item[$phylum[hippy]] = $item[Gene Tonic: Hippy];
    __dna_phylum_to_item[$phylum[hobo]] = $item[Gene Tonic: Hobo];
    __dna_phylum_to_item[$phylum[horror]] = $item[Gene Tonic: Horror];
    __dna_phylum_to_item[$phylum[humanoid]] = $item[Gene Tonic: Humanoid];
    __dna_phylum_to_item[$phylum[mer-kin]] = $item[Gene Tonic: Mer-kin];
    __dna_phylum_to_item[$phylum[orc]] = $item[Gene Tonic: Orc];
    __dna_phylum_to_item[$phylum[penguin]] = $item[Gene Tonic: Penguin];
    __dna_phylum_to_item[$phylum[pirate]] = $item[Gene Tonic: Pirate];
    __dna_phylum_to_item[$phylum[plant]] = $item[Gene Tonic: Plant];
    __dna_phylum_to_item[$phylum[slime]] = $item[Gene Tonic: Slime];
    __dna_phylum_to_item[$phylum[undead]] = $item[Gene Tonic: Undead];
    __dna_phylum_to_item[$phylum[weird]] = $item[Gene Tonic: Weird];
    
    __dna_phylum_to_effect[$phylum[beast]] = $effect[Human-Beast Hybrid];
    __dna_phylum_to_effect[$phylum[bug]] = $effect[Human-Insect Hybrid];
    __dna_phylum_to_effect[$phylum[constellation]] = $effect[Human-Constellation Hybrid];
    __dna_phylum_to_effect[$phylum[construct]] = $effect[Human-Machine Hybrid];
    __dna_phylum_to_effect[$phylum[demon]] = $effect[Human-Demon Hybrid];
    __dna_phylum_to_effect[$phylum[dude]] = $effect[Human-Human Hybrid];
    __dna_phylum_to_effect[$phylum[elemental]] = $effect[Human-Elemental Hybrid];
    __dna_phylum_to_effect[$phylum[elf]] = $effect[Human-Elf Hybrid];
    __dna_phylum_to_effect[$phylum[fish]] = $effect[Human-Fish Hybrid];
    __dna_phylum_to_effect[$phylum[goblin]] = $effect[Human-Goblin Hybrid];
    __dna_phylum_to_effect[$phylum[hippy]] = $effect[Human-Hippy Hybrid];
    __dna_phylum_to_effect[$phylum[hobo]] = $effect[Human-Hobo Hybrid];
    __dna_phylum_to_effect[$phylum[horror]] = $effect[Human-Horror Hybrid];
    __dna_phylum_to_effect[$phylum[humanoid]] = $effect[Human-Humanoid Hybrid];
    __dna_phylum_to_effect[$phylum[mer-kin]] = $effect[Human-Mer-kin Hybrid];
    __dna_phylum_to_effect[$phylum[orc]] = $effect[Human-Orc Hybrid];
    __dna_phylum_to_effect[$phylum[penguin]] = $effect[Human-Penguin Hybrid];
    __dna_phylum_to_effect[$phylum[pirate]] = $effect[Human-Pirate Hybrid];
    __dna_phylum_to_effect[$phylum[plant]] = $effect[Human-Plant Hybrid];
    __dna_phylum_to_effect[$phylum[slime]] = $effect[Human-Slime Hybrid];
    __dna_phylum_to_effect[$phylum[undead]] = $effect[Human-Undead Hybrid];
    __dna_phylum_to_effect[$phylum[weird]] = $effect[Human-Weird Thing Hybrid];
    
    foreach p in __dna_phylum_to_effect
    {
        __dna_effect_to_phylum[__dna_phylum_to_effect[p]] = p;
    }
    
    
    foreach e in __dna_effect_to_phylum
    {
        if (e.have_effect() == 2147483647)
        {
            __current_dna_intrinsic = e;
            break;
        }
    }
    
    
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
    {
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[fish], "", "+10 familiar weight for statgain, parrot"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[elemental], "", "saves three turns on resistance test"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[pirate], "", "~3.3 turns saved on item test"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[construct], "", "+5 familiar weight"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[elf], "", "spell damage test"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[beast], "", "marginal?"));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[dude], "", "marginal?"));
        
        return;
    }
    
    if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"])
    {
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[bug], "", "speed up defiled alcove"));
        __phylum_potion_reminder_suggestions.listAppend(DNASuggestionMake($phylum[bug], "", "speed up defiled alcove"));
    }
    
    if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
    {
        //FIXME only suggest constellation if they've not finished HITS?
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylums[constellation,humanoid], "+meat", "nuns"));
        __phylum_potion_reminder_suggestions.listAppend(DNASuggestionMake($phylum[constellation], "+meat", "nuns"));
        __phylum_potion_reminder_suggestions.listAppend(DNASuggestionMake($phylum[humanoid], "+meat", "nuns"));
        
    }
    if (!__quest_state["Level 3"].finished)
    {
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylums[demon,hobo,plant,undead], "+elemental damage", "tavern NC skipping"));
    }
    if (!__quest_state["Level 12"].finished && (!have_outfit_components("War Hippy Fatigues") && !have_outfit_components("Frat Warrior Fatigues")) && !__misc_state["yellow ray potentially available"])
    {
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[pirate], "+50% gear drop", "war outfit?"));
    }
    if (__quest_state["Level 11 Palindome"].mafia_internal_step < 5 && $item[mega gem].available_amount() == 0 && in_hardcore() && !($skill[Check Hair].skill_is_usable() && $skill[Natural Dancer].skill_is_usable())) //avatar of sneaky pete usually can cap this easily... usually
    {
        if ($item[wet stunt nut stew].available_amount() == 0 && !(($item[bird rib].available_amount() > 0 && $item[lion oil].available_amount() > 0 || $item[wet stew].available_amount() > 0)))
        {
            __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[goblin], "+50% food drop", "Wet stunt nut stew components"));
            __phylum_potion_reminder_suggestions.listAppend(DNASuggestionMake($phylum[goblin], "+50% food drop", "Wet stunt nut stew components")); //300% drop, very important
        }
    }
    
    if (true)
    {
        string [int] reasons;
        if (!__quest_state["Level 8"].finished && numeric_modifier("cold resistance") < 5.0)
            reasons.listAppend("icy peak");
        if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0)
            reasons.listAppend("a-boo peak");
        
        if (reasons.count() > 0)
            __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[elemental], "+3 all resistance", reasons.listJoinComponents(", ", "and").capitaliseFirstLetter()));
    }
    
    if (__misc_state["in run"])
    {
        if (__current_dna_intrinsic != __dna_phylum_to_effect[$phylum[construct]] && !__misc_state["familiars temporarily blocked"])
            __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[construct], "+5 familiar weight, DR/DA", "", true));
        if (__current_dna_intrinsic != __dna_phylum_to_effect[$phylum[dude]])
            __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[dude], "+10% item", "", true));
        
        if (!__quest_state["Level 13"].state_boolean["Elemental damage race completed"])
        {
            string element_needed = __quest_state["Level 13"].state_string["Elemental damage race type"];
            DNASuggestion element_suggestion;
            string suggestion_effect = "+" + HTMLGenerateSpanOfClass(element_needed, "r_element_" + element_needed + "_desaturated") + " damage/spell damage";
            string suggestion_description = "Lair race";
            if (element_needed == "hot")
                element_suggestion = DNASuggestionMake($phylum[demon], suggestion_effect, suggestion_description, true);
            else if (element_needed == "cold")
                element_suggestion = DNASuggestionMake($phylum[plant], suggestion_effect, suggestion_description, true);
            else if (element_needed == "sleaze")
                element_suggestion = DNASuggestionMake($phylum[slime], suggestion_effect, suggestion_description, true);
            else if (element_needed == "spooky")
                element_suggestion = DNASuggestionMake($phylum[undead], suggestion_effect, suggestion_description, true);
            else if (element_needed == "stench")
                element_suggestion = DNASuggestionMake($phylum[hobo], suggestion_effect, suggestion_description, true);
            if (element_suggestion.phylums.count() > 0 && element_needed != "")
            {
                __phylum_potion_suggestions.listAppend(element_suggestion);
                __phylum_potion_reminder_suggestions.listAppend(element_suggestion);
            }
        }
    }
    else
    {
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[penguin], "", "", true));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[fish], "", "", true));
        __phylum_potion_suggestions.listAppend(DNASuggestionMake($phylum[constellation], "", "", true));
    }
    
    
    if (__current_dna_intrinsic == $effect[none])
    {
        if (!__misc_state["familiars temporarily blocked"])
        {
            if (!__misc_state["in run"] || my_path_id() == PATH_HEAVY_RAINS)
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[fish]) + " (+10 familiar weight)");
            else if ($item[grimstone mask].available_amount() > 0)
            {
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[fish]) + " (+10 familiar weight, via grimstone mask candy witch's lake)");
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[construct]) + " (+5 familiar weight)");
            }
            else
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[construct]) + " (+5 familiar weight)");
        }
        if (__misc_state["need to level"])
        {
            if ($familiar[astral badger].familiar_is_usable() || $item[astral mushroom].available_amount() > 0 || $effect[Half-Astral].have_effect() > 0 || __misc_state_int["pulls available"] > 0)
            {
                string method = "astral badger";
                if (!$familiar[astral badger].familiar_is_usable() || $item[astral mushroom].available_amount() > 0)
                    method = "astral mushroom";
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[weird]) + " (+4 stats/fight, via " + method + ")");
            }
            else if (__misc_state["sleaze airport available"])
            {
                __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[weird]) + " (+4 stats/fight, via sloppy seconds diner)");
            }
        }
        __dna_intrinsic_ideas.listAppend(DNABoldPhylumIfCurrentMonster($phylum[dude]) + " (+10% item)");
        
    }
}

RegisterResourceGenerationFunction("IOTMDNAGenerateResource");
void IOTMDNAGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (__misc_state["campground unavailable"])
        return;
    if (!__iotms_usable[$item[Little Geneticist DNA-Splicing Lab]])
        return;
    
    //Player has a genetic engineering lab installed. Let's play with our DNA!
    
    phylum syringe_phylum = getDNASyringePhylum();
    int potions_made = get_property_int("_dnaPotionsMade");
    int potions_left = MAX(0, 3 - potions_made);
    boolean became_a_genetic_monstrosity_today = get_property_boolean("_dnaHybrid");
    
    
    //Some ideas:
    //Intrinsics:
    //constructs - +5 familiar weight - also a potion option
    //weird - +4 stats/fight - hard to find without badger
    //dudes - +10% items
    
    //fish - +10 familiar weight - HCO only? possible with agua de vida, but takes at least two turns? 70% NC base, 2 NCs, need two of an NC. this is versus zero-turn +5 familiar weight...
    //mer-kin - +25 ML - fax only. even with sea access, requires wreck access
    //orcs/hippies - +1 stat/fight... ??? marginal?
    //penguins - +25% item - nowhere to be found in-run before level 11
    
    //Potions:
    //bug - +25% init - modern zmobies, potion, if we can find bugs
    //elemental - +3 all res - icy peak, a-boo, stench for twin/bats
    //constellation - +50% meat - nuns, potion
    //humanoid - +20% meat - more nuns?
    //demon - +20 hot damage - skipping tavern NC
    //hobo - +20 stench damage - skipping tavern NCs, but isn't there a better source? (the pool)
    //plant - +20 cold damage - tavern skipping, somewhat silly, song of north exists
    //undead - +20 spooky damage - tavern skipping...?
    //pirate - +50% gear drops - not sure. potion? seems like it'd be useful in a handful of places
    
    
    
    
    
    ChecklistSubentry [int] subentries;
    
    string syringe_description = "";
    boolean syringe_description_output = false;
    if (syringe_phylum != $phylum[none])
    {
        string line = "Syringe has " + syringe_phylum + "." + " (" + __dna_phylum_to_description_colourless[syringe_phylum] + ")";
        syringe_description = line;
    }
    
    if (potions_left > 0)
    {
        string [int] description;
        
        if (syringe_description != "" && !syringe_description_output)
        {
            description.listAppend(syringe_description);
            syringe_description_output = true;
        }
        
        string [int] potion_suggestion_descriptions;
        foreach key in __phylum_potion_suggestions
        {
            DNASuggestion suggestion = __phylum_potion_suggestions[key];
            
            phylum [int] needed_phylums;
            
            foreach key2 in suggestion.phylums
            {
                phylum p = suggestion.phylums[key2];
                if (!DNAHavePhylum(p) || suggestion.always_show)
                {
                    needed_phylums.listAppend(p);
                }
            }
            
            if (needed_phylums.count() > 0)
            {
                string [int] phylum_descriptions;
                string [int] output_effect_description;
                
                foreach key in needed_phylums
                {
                    phylum p = needed_phylums[key];
                    
                    phylum_descriptions.listAppend(DNABoldPhylumIfCurrentMonster(p));
                    
                    if (suggestion.relevant_effect_description.length() == 0)
                        output_effect_description.listAppend(__dna_phylum_to_description_colourless[p]);
                }
                if (suggestion.relevant_effect_description != "")
                    output_effect_description.listAppend(suggestion.relevant_effect_description);
                
                string line;
                
                line = phylum_descriptions.listJoinComponents("/");
                line += ": " + output_effect_description.listJoinComponents("/");
                if (suggestion.reason != "")
                    line += " - " + suggestion.reason;
                
                potion_suggestion_descriptions.listAppend(line);
            }
        }
        //HTMLGenerateSimpleTableLines
        if (potion_suggestion_descriptions.count() > 0)
            description.listAppend("Tonic ideas:|*" + potion_suggestion_descriptions.listJoinComponents("<hr>|*"));
        subentries.listAppend(ChecklistSubentryMake(pluralise(potions_left, "gene tonic", "gene tonics") + " creatable", "", description));
    }
    if (!became_a_genetic_monstrosity_today)
    {
        string [int] description;
        if (syringe_description != "" && !syringe_description_output)
        {
            description.listAppend(syringe_description);
            syringe_description_output = true;
        }
        
        if (__current_dna_intrinsic != $effect[none] && (__dna_effect_to_phylum contains __current_dna_intrinsic))
            description.listAppend("Currently a " + __dna_effect_to_phylum[__current_dna_intrinsic] + ". (" + __dna_phylum_to_description_colourless[__dna_effect_to_phylum[__current_dna_intrinsic]] + ")");
        
        
        if (__current_dna_intrinsic == $effect[none])
        {
            if (__dna_intrinsic_ideas.count() > 0)
                description.listAppend("Could try " + __dna_intrinsic_ideas.listJoinComponents(", ", "or") + ".");
        }
        
        subentries.listAppend(ChecklistSubentryMake("Genetic intrinsic available", "", description));
    }
    
    int importance = 5;
    
    if (potions_left == 0 && __current_dna_intrinsic != $effect[none]) //no potions, already a hybrid
        importance = 8;
    
    string image_name = "__effect Human-Human Hybrid";
    
    if (__misc_state["in run"])
    {
        foreach p in __dna_phylum_to_item
        {
            item it = __dna_phylum_to_item[p];
            if (it.available_amount() == 0)
                continue;
            if (subentries.count() == 0)
                image_name = "__item Gene Tonic: Constellation";
            subentries.listAppend(ChecklistSubentryMake(it.pluralise(), "", __dna_phylum_to_description_colourless[p]));
            
        }
    }
    
    if (subentries.count() > 0)
        resource_entries.listAppend(ChecklistEntryMake(583, image_name, "campground.php?action=workshed", subentries, importance));
    
    
}

RegisterTaskGenerationFunction("IOTMDNAGenerateTasks");
void IOTMDNAGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (__misc_state["campground unavailable"])
        return;
    if (!__iotms_usable[$item[Little Geneticist DNA-Splicing Lab]])
        return;
    
    //Reminders:
    phylum syringe_phylum = getDNASyringePhylum();
    
    
    if (get_property_int("_dnaPotionsMade") < 3)
    {
        if (syringe_phylum != $phylum[none] && !DNAHavePhylum(syringe_phylum))
        {
            //Make the resulting tonic:
            string suggestion_reason;
            
            string relevant_effect_description;
            
            
            foreach key in __phylum_potion_reminder_suggestions
            {
                DNASuggestion suggestion = __phylum_potion_reminder_suggestions[key];
                foreach key2 in suggestion.phylums
                {
                    phylum suggestion_phylum = suggestion.phylums[key2];
                    if (syringe_phylum == suggestion_phylum)
                    {
                        suggestion_reason = suggestion.reason;
                        relevant_effect_description = suggestion.relevant_effect_description;
                    }
                }
            }
            
            
            if (suggestion_reason != "")
            {
                string description = suggestion_reason.capitaliseFirstLetter() + ".";
                task_entries.listAppend(ChecklistEntryMake(584, "__effect Human-Human Hybrid", "campground.php?action=workshed", ChecklistSubentryMake("Make gene tonic for " + syringe_phylum, "", description), -11));
            }
        }
        
        
        
        if (monster_phylum() != $phylum[none] && monster_phylum() != syringe_phylum && !DNAHavePhylum(monster_phylum()))
        {
            //Syringe a monster when we find it:
            phylum p = monster_phylum();
            
            string suggestion_reason;
            
            string relevant_effect_description;
            
            
            foreach key in __phylum_potion_reminder_suggestions
            {
                DNASuggestion suggestion = __phylum_potion_reminder_suggestions[key];
                foreach key2 in suggestion.phylums
                {
                    phylum suggestion_phylum = suggestion.phylums[key2];
                    if (p == suggestion_phylum)
                    {
                        suggestion_reason = suggestion.reason;
                        relevant_effect_description = suggestion.relevant_effect_description;
                    }
                }
            }
            
            if (suggestion_reason != "")
            {
                if (relevant_effect_description.length() == 0)
                    relevant_effect_description = __dna_phylum_to_description[p];
                string description = suggestion_reason.capitaliseFirstLetter() + ".";
                description += "|" + monster_phylum().to_string().capitaliseFirstLetter() + " (" + relevant_effect_description + ")";
                task_entries.listAppend(ChecklistEntryMake(585, "__effect Human-Human Hybrid", "", ChecklistSubentryMake("Extract DNA from " + last_monster().to_string().HTMLEscapeString(), "", description), -11));
            }
        }
    }
    
    if (__current_dna_intrinsic == $effect[none] && !get_property_boolean("_dnaHybrid"))
    {
        string [int] description;
        if (__dna_intrinsic_ideas.count() > 0)
            description.listAppend("Could try " + __dna_intrinsic_ideas.listJoinComponents(", ", "or") + ".");
        optional_task_entries.listAppend(ChecklistEntryMake(586, "__effect Human-Human Hybrid", "campground.php?action=workshed", ChecklistSubentryMake("Hybridize yourself", "", description), 5));
    }
}


void IOTMPShadyPastGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    if ($item[White Dragon Fang].available_amount() == 0)
    {
        boolean can_acquire_taijijian = ($item[strange goggles].available_amount() > 0 || $item[toy taijijian].available_amount() > 0 || !in_ronin());
        if ($item[magical battery].available_amount() > 0 && can_acquire_taijijian)
        {
            description.listAppend("To make the White Dragon Fang, meatpaste together the toy taijijian with the magical battery.");
        }
    }
    
    string last_combat = $location[chinatown tenement].lastCombatInLocation();
    if ($location[chinatown tenement].combat_queue.contains_text("White Bone Demon") && description.count() == 0) //somewhat limited way of detecting that we are finished
        return;
    if ($item[Test site key].available_amount() > 0)
    {
        //Last segment:
        
        int gold_pieces_needed = MAX(0, 30 - $item[gold piece].available_amount());
        if (last_combat == "the server")
        {
            description.listAppend("Fight the White Bone Demon.");
        }
        else if (gold_pieces_needed > 0)
        {
            //at least one gold piece from a desperate gold farmer is under 21.89% drop rate
            //needs spading
            description.listAppend("Adventure in the chinatown tenement, acquire " + pluralise(gold_pieces_needed, "more gold piece", "more gold pieces") + ".");
            modifiers.listAppend("+400%? item");
            
            if (__misc_state["have olfaction equivalent"])
                modifiers.listAppend("olfact desperate gold farmer");
        }
        else
        {
            description.listAppend("Adventure in the chinatown tenement, fight the server.|Once the server's panel falls off, use the strange goggles.");
        }
    }
    else if ($item[CEO office card].available_amount() > 0)
    {
        //Use to see wheels within wheels.
        description.listAppend("Use CEO office card.");
    }
    else if ($items[makeshift yakuza mask,Novelty tattoo sleeves].items_missing().count() == 0)
    {
        //Visit the first floor.
        item [int] equip_items;
        foreach it in $items[makeshift yakuza mask,novelty tattoo sleeves]
        {
            if (it.equipped_amount() == 0)
                equip_items.listAppend(it);
        }
        if (equip_items.count() > 0 && $location[1st floor\, shiawase-mitsuhama building].turnsAttemptedInLocation() == 0)
        {
            description.listAppend("Equip " + equip_items.listJoinComponents(", ", "and") + ".");
        }
        else
        {
            description.listAppend("Adventure on the floors of the Shiawase-Mitsuhama building, acquire and use cards.");
            
            foreach it in $items[zaibatsu level 2 card, zaibatsu level 3 card]
            {
                if (it.available_amount() == 0)
                    continue;
                description.listAppend("Use " + it + ".");
            }
        }
    }
    else if ($item[strange goggles].available_amount() > 0)
    {
        //Make yakuza mask.
        if ($item[makeshift yakuza mask].available_amount() == 0)
        {
            string line = "Assemble a makeshift yakuza mask with items from the chinatown shops.";
            
            item [int] missing_parts_list = missingComponentsToMakeItem($item[makeshift yakuza mask]);
            if (missing_parts_list.count() == 0)
                line = "Assemble a makeshift yakuza mask.|(rhinoceros horn + rhinoceros horn) + (furry pink pillow + bottle of limeade)";
            else
                line += "|Missing " + missing_parts_list.listJoinComponents(", ", "and") + ".";
            
            description.listAppend(line);
        }
        if ($item[Novelty tattoo sleeves].available_amount() == 0)
        {
            description.listAppend("Buy novelty tattoo sleeves from the chinatown shops.");
        }
    }
    else if ($item[zaibatsu lobby card].available_amount() > 0)
    {
        //Triad factory.
        description.listAppend("Adventure in the sewer triad factory, defeat the Sierpinski brothers.");
        description.listAppend("Run +item for a possible magical battery.");
        modifiers.listAppend("+item");
    }
    else
    {
        //Start of quest.
        description.listAppend("Adventure in the Chinatown shops, defeat a yakuza courier.");
    }
    

	optional_task_entries.listAppend(ChecklistEntryMake(470, "chinatown", "place.php?whichplace=junggate_1", ChecklistSubentryMake("The Suspicious-Looking Guy's Shady Past", modifiers, description),$locations[chinatown shops, chinatown tenement, triad factory,1st floor\, shiawase-mitsuhama building,2nd floor\, shiawase-mitsuhama building,3rd floor\, shiawase-mitsuhama building]));
}

void IOTMPOldManGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    if ($location[The Old Man's Bathtime Adventures].lastNoncombatInLocation() == "Journey's End") //somewhat limited way of detecting that we are finished
        return;
    
    description.listAppend("Sail the seas. Try to one-hit kill the sea monsters.");
    
    if ($item[Bloodbath].available_amount() == 0)
        description.listAppend("Need to finish the area with 50+ crew to acquire Bloodbath.");
    else if ($item[ornamental sextant].available_amount() == 0)
        description.listAppend("Need to finish the area with 37+ crew to acquire ornamental sextant.");
    else if ($item[miniature deck cannon].available_amount() == 0)
        description.listAppend("Need to finish the area with [24 to 36] crew to acquire miniature deck cannon.");
    else if ($item[Foam naval trousers].available_amount() == 0)
        description.listAppend("Need to finish the area with [24 to 36] crew to acquire Foam naval trousers.");
    else if ($item[Foam commodore's hat].available_amount() == 0)
        description.listAppend("Need to finish the area with [24 to 36] crew to acquire Foam commodore's hat.");
    
    description.listAppend("Choose +crew non-combat options, add monsters if you can.");
    
    
    monster olfacted_monster = get_property_monster("olfactedMonster");
    if ($effect[on the trail].have_effect() == 0)
        olfacted_monster = $monster[none];
    boolean olfacted_relevant_monster = ($monsters[ferocious roc,giant man-eating shark,Bristled Man-O-War,The Cray-Kin,Deadly Hydra] contains olfacted_monster);
    
    if (__misc_state["have olfaction equivalent"] && !olfacted_relevant_monster)
    {
        description.listAppend("Olfact any monster that is not a fearsome giant squid.");
        modifiers.listAppend("olfaction");
    }
        
    if (my_basestat($stat[mysticality]) >= 200)
    {
        if ($item[Mesmereyes&trade; contact lenses].equipped_amount() == 0)
        {
            description.listAppend("Wear " + $item[Mesmereyes&trade; contact lenses] + ".");
        }
    }
    else
    {
        if ($item[Attorney's badge].equipped_amount() == 0)
        {
            description.listAppend("Wear " + $item[Attorney's badge] + ".");
        }
        description.listAppend("Possibly level mysticality to 200 to wear " + $item[Mesmereyes&trade; contact lenses] + ", makes this area much easier.");
    }
    
    if ($item[Young Man's Crew Sequester].available_amount() > 0)
        description.listAppend("Young Man's Crew Sequester available. (+5 crew)");
    if ($item[Young Man's Cargo Load].available_amount() > 0)
        description.listAppend("Young Man's Cargo Load available. (+4 crayons, +16 bubbles)");
    
    //very limited potato detection:
    if (my_familiar() != $familiar[levitating potato] && !(my_familiar() == $familiar[fancypants scarecrow] && ($slot[familiar].equipped_item() == $item[swashbuckling pants] || $slot[familiar].equipped_item() == $item[spangly mariachi pants]))  && !(my_familiar() == $familiar[mad hatrack] && $slot[familiar].equipped_item() == $item[spangly sombrero]))
        description.listAppend("Run a potato familiar of some kind.");
    
    
	optional_task_entries.listAppend(ChecklistEntryMake(471, "__item inflatable duck", "", ChecklistSubentryMake("The Old Man's Bathtime Adventure", modifiers, description),$locations[The Old Man's Bathtime Adventures]));
}

void IOTMPMeatGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    if ($location[The Nightmare Meatrealm].lastCombatInLocation() == "The Beefhemoth") //somewhat limited way of detecting that we are finished
        return;
        
    modifiers.listAppend("+meat");
    description.listAppend("Adventure until you find the beefhemoth, defeat him.");
    if ($items[the sword in the steak, meatcleaver].available_amount() == 0)
        description.listAppend("The Sword in the Steak is from a 0.1% likelyhood non-combat.|To find it, run away from monsters, preferrably with greatest american pants/navel ring of navel gazing.");
    if ($item[meatcleaver].available_amount() == 0 && $item[the sword in the steak].available_amount() > 0)
    {
        if (my_buffedstat($stat[muscle]) < 1000)
            description.listAppend("To pull the sword from the steak, buff muscle to 1000.");
        else
            description.listAppend("Pull the sword from the steak, adventurer.");
    }
        
        
	optional_task_entries.listAppend(ChecklistEntryMake(472, "meat", "place.php?whichplace=junggate_6", ChecklistSubentryMake("The Meatsmith's Brainspace", modifiers, description),$locations[The Nightmare Meatrealm]));
}

void IOTMPGourdGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    if ($location[the gourd!].lastCombatInLocation() == "Fnord the Unspeakable") //This should work for termination detection?
        return;
        
    modifiers.listAppend("+item?");
    description.listAppend("Adventure in the gourd.");
    if ($item[truthsayer].available_amount() == 0)
    {
        string [int] components;
        boolean [item] items_implicitly_have;
        if ($item[loose blade].available_amount() > 0)
        {
            items_implicitly_have[$item[goblin collarbone]] = true;
            items_implicitly_have[$item[sharp tin strip]] = true;
        }
        if ($item[goblin bone hilt].available_amount() > 0)
        {
            items_implicitly_have[$item[goblin collarbone]] = true;
            items_implicitly_have[$item[wad of spider silk]] = true;
        }
        if ($item[sticky sword blade].available_amount() > 0)
        {
            items_implicitly_have[$item[sharp tin strip]] = true;
            items_implicitly_have[$item[wad of spider silk]] = true;
        }
        foreach it in $items[sharp tin strip, wad of spider silk, goblin collarbone]
        {
            string line = it;
            if (it.available_amount() == 0 && !(items_implicitly_have contains it))
                line = HTMLGenerateSpanFont(line, "gray");
            components.listAppend(line);
        }
        description.listAppend("Truthsayer is (" + components.listJoinComponents(" + ") + "), found from gourd monsters.");
    }
    
        
	optional_task_entries.listAppend(ChecklistEntryMake(473, "__item gourd potion", "place.php?whichplace=junggate_2", ChecklistSubentryMake("The Gourd", modifiers, description),$locations[The gourd!]));
}

void IOTMPCrackpotGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    //Despair, rage, envy. Anger, fear, doubt, regret.
    string url = "place.php?whichplace=junggate_3";
    string image_name = "__item red pixel";
    
    boolean need_byte_sword = !($item[byte].available_amount() + $item[byte].storage_amount() > 0 || $item[flickering pixel].available_amount() + $item[flickering pixel].storage_amount() >= 8);
    
    if ($item[flickering pixel].available_amount() == 8)
    {
        description.listAppend("Use eight flickering pixels to acquire the sword, byte.");
    }
    
    string [int] bosses_remaining;
    
    if ($location[anger man's level].lastCombatInLocation() != "Anger man")
        bosses_remaining.listAppend("anger man");
    if ($location[fear man's level].lastCombatInLocation() != "Fear man")
        bosses_remaining.listAppend("fear man");
    if ($location[doubt man's level].lastCombatInLocation() != "Doubt man")
        bosses_remaining.listAppend("doubt man");
    if ($location[regret man's level].lastCombatInLocation() != "Regret man")
        bosses_remaining.listAppend("regret man");
        
    if (bosses_remaining.count() == 0 && description.count() == 0)
        return;
        
    if (__last_adventure_location == $location[anger man's level] && $location[anger man's level].lastCombatInLocation() != "Anger man")
    {
        description.listAppend("Adventure in anger man's level, defeat the boss.");
        string [int] stats_needed_to_complete_zone;
        string [int] stats_needed_for_flickering_pixel;
        foreach s in $stats[muscle, mysticality, moxie]
        {
            if (s.my_buffedstat() < 50)
            {
                stats_needed_to_complete_zone.listAppend(s.to_string().to_lower_case());
            }
            if (s.my_buffedstat() < 500)
            {
                stats_needed_for_flickering_pixel.listAppend(s.to_string().to_lower_case());
            }
        }
        
        float resistance = numeric_modifier("hot resistance");
        int resistance_needed = MAX(0, floor(25 - resistance));
        if (resistance < 25.0 && need_byte_sword)
            description.listAppend("Need " + resistance_needed + " more hot resistance for the first flickering pixel.");
        
        if (stats_needed_to_complete_zone.count() > 0)
            description.listAppend("Need 50 " + stats_needed_to_complete_zone.listJoinComponents(", ", "and") + " to pass first test.");
        if (stats_needed_for_flickering_pixel.count() > 0 && need_byte_sword)
            description.listAppend("Need 500 " + stats_needed_for_flickering_pixel.listJoinComponents(", ", "and") + " for the second flickering pixels.");
            
            
    }
    else if (__last_adventure_location == $location[fear man's level] && $location[fear man's level].lastCombatInLocation() != "Fear man")
    {
        description.listAppend("Adventure in fear man's level, defeat the boss.");
        
        //50 moxie to complete
        //300 moxie for first flickering
        //25 spooky res for second flickering
        
        if (my_buffedstat($stat[moxie]) < 50)
            description.listAppend("Need 50 total moxie pass first test.");
            
        if (my_buffedstat($stat[moxie]) < 300 && need_byte_sword)
            description.listAppend("Need 300 total moxie for the first flickering pixel.");
            
        float resistance = numeric_modifier("spooky resistance");
        int resistance_needed = MAX(0, floor(25 - resistance));
        if (resistance < 25.0 && need_byte_sword)
            description.listAppend("Need " + resistance_needed + " more spooky resistance for the second flickering pixel.");
    }
    else if (__last_adventure_location == $location[doubt man's level] && $location[doubt man's level].lastCombatInLocation() != "Doubt man")
    {
        description.listAppend("Adventure in doubt man's level, defeat the boss.");
            
        //weapon damage >= 100 to complete
        //HP > 100 to complete
        //weapon damage >= 276(?) for first flickering
        //HP >= 1000 for second flickering
        
        int weapon_damage = numeric_modifier("weapon damage").floor();
        if (weapon_damage < 100)
            description.listAppend("Need " + (100 - weapon_damage) + " more weapon damage to pass first test.");
        if (weapon_damage < 276 && need_byte_sword)
            description.listAppend("Need " + (276 - weapon_damage) + "(?) more weapon damage for the first flickering pixel.");
        
        if (my_hp() < 100)
            description.listAppend("Need 100 total HP to pass second test.");
        if (my_hp() < 1000 && need_byte_sword)
            description.listAppend("Need 1000 total HP for the second flickering pixel.");
    }
    else if (__last_adventure_location == $location[regret man's level] && $location[regret man's level].lastCombatInLocation() != "Regret man")
    {
        description.listAppend("Adventure in regret man's level, defeat the boss.");
        
        //MP >= 100 to complete
        //total elemental damage >= 50 to complete
        //MP >= 1000 for first flickering
        //total elemental damage >= 100 for second flickering
        
        if (my_mp() < 100)
            description.listAppend("Need 100 total MP to pass first test.");
        if (my_mp() < 1000 && need_byte_sword)
            description.listAppend("Need 1000 total MP for the first flickering pixel.");
        //int total_elemental_damage = numeric_modifier("cold damage") + numeric_modifier("hot damage") + numeric_modifier("sleaze damage") + numeric_modifier("spooky damage") + numeric_modifier("stench damage");
        
        //FIXME I am not sure if this is correct. How exactly does this test work?
        string [int] missing_second_test;
        string [int] missing_second_pixel_test;
        foreach e in $strings[cold,hot,sleaze,spooky,stench]
        {
            string element_html_id = "r_element_" + e;
            int damage = numeric_modifier(e + " damage").floor();
            if (damage < 50)
                missing_second_test.listAppend(HTMLGenerateSpanOfClass((50 - damage) + " more " + e, element_html_id));
            if (damage < 60)
                missing_second_pixel_test.listAppend(HTMLGenerateSpanOfClass((60 - damage) + " more " + e, element_html_id));
            
        }
        if (missing_second_test.count() > 0)
            description.listAppend("Need " + missing_second_test.listJoinComponents(", ", "and") + " damage to pass the second test.");
        if (missing_second_pixel_test.count() > 0)
            description.listAppend("Need " + missing_second_pixel_test.listJoinComponents(", ", "and") + " damage for the second flickering pixel.");
    }
    
    string await = " await.";
    if (bosses_remaining.count() == 1)
        await = " awaits.";
    if (bosses_remaining.count() > 0)
        description.listAppend(bosses_remaining.listJoinComponents(", ", "and").capitaliseFirstLetter() + await);
    else if ($item[flickering pixel].available_amount() == 8)
    {
        url = "inventory.php?which=3";
        image_name = "__item flickering pixel";
    }
    
    if (__misc_state["in run"])
        description.listAppend("(this isn't ascension relevant after you've gotten a digital key)");
        
	optional_task_entries.listAppend(ChecklistEntryMake(474, image_name, url, ChecklistSubentryMake("The Crackpot Mystic's Psychoses", modifiers, description),$locations[anger man's level, fear man's level, doubt man's level, regret man's level]));
}



void IOTMPJickGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    if ($item[sword of procedural generation].available_amount() > 0)
        return;
        
    description.listAppend("Fight skeletons.");
    description.listAppend("Make sure you have a monster manuel first; once this tower is complete, there's no way to get these factoids ever again.");
    
    //FIXME be more specific
        
	optional_task_entries.listAppend(ChecklistEntryMake(475, "__item skeleton", "", ChecklistSubentryMake("Jick's Obsessions", modifiers, description),$locations[the tower of procedurally-generated skeletons]));
}



void IOTMPArtistGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    
    foreach e in $effects[My Breakfast With Andrea,The Champion's Breakfast,Tiffany's Breakfast,Breakfast Clubbed]
    {
        if (e.have_effect() > 0)
            return;
    }
    //Let's see.
    //The way this quest works is, you find utensils in the kitchen drawer. (or the mall)
    //Then, you adventure in the grocery bag, and use a utensil on the monsters.
    //The utensil you use on the monster determines breakfast.
    
    
    description.listAppend("Make a breakfast.");
    description.listAppend("To do this, you find utensils in the kitchen drawer, and use them, in combat, on the five different foods in the grocery bag.|Which utensil you use on which food helps determine your breakfast.");
    
    
    string [int] missing_utensils;
    foreach it in $items[Artist's Butterknife of Regret,Artist's Cookie Cutter of Loneliness,Artist's Cr&egrave;me Brul&eacute;e Torch of Fury,Artist's Spatula of Despair,Artist's Whisk of Misery]
    {
        if (it.available_amount() > 0)
            continue;
        string utensil_readable_name = it.to_string().replace_string("Artist's ", "");
        
        missing_utensils.listAppend(utensil_readable_name);
    }
    
    if (missing_utensils.count() > 0)
    {
        modifiers.listAppend("+300% item");
        description.listAppend("Find utensils in the kitchen drawer, or buy in the mall.|Utensils missing:|*" + missing_utensils.listJoinComponents(", ", "and") + ".");
    }
    
    string [int] breakfasts;
    
    string breakfast_line;
    //Meat & Knife, Bread & Knife, Batter & Spatula, Eggs & Whisk, Potatoes & Knife
    breakfast_line += "My Breakfast With Andrea: (+meat)";
    breakfast_line += "|*Meat" + __html_right_arrow_character + "Butterknife";
    breakfast_line += "|*Bread" + __html_right_arrow_character + "Butterknife";
    breakfast_line += "|*Batter" + __html_right_arrow_character + "Spatula";
    breakfast_line += "|*Eggs" + __html_right_arrow_character + "Whisk";
    breakfast_line += "|*Potatoes" + __html_right_arrow_character + "Butterknife";
    breakfasts.listAppend(breakfast_line); breakfast_line = "";
    
    //Meat & Cutter, Bread & Torch, Batter & Whisk, Eggs & Torch, Potatoes & Torch
    breakfast_line += "<hr>";
    breakfast_line += "The Champion's Breakfast: (+init)";
    breakfast_line += "|*Meat" + __html_right_arrow_character + "Cookie Cutter";
    breakfast_line += "|*Bread" + __html_right_arrow_character + "Cr&egrave;me Brul&eacute;e Torch";
    breakfast_line += "|*Batter" + __html_right_arrow_character + "Whisk";
    breakfast_line += "|*Eggs" + __html_right_arrow_character + "Cr&egrave;me Brul&eacute;e Torch";
    breakfast_line += "|*Potatoes" + __html_right_arrow_character + "Cr&egrave;me Brul&eacute;e Torch";
    breakfasts.listAppend(breakfast_line); breakfast_line = "";
    
    //Meat & Spatula, Bread & Cutter, Batter & Cutter, Eggs & Spatula, Potatoes & Whisk
    breakfast_line += "<hr>";
    breakfast_line += "Tiffany's Breakfast: (+item)";
    breakfast_line += "|*Meat" + __html_right_arrow_character + "Spatula";
    breakfast_line += "|*Bread" + __html_right_arrow_character + "Cookie Cutter";
    breakfast_line += "|*Batter" + __html_right_arrow_character + "Cookie Cutter";
    breakfast_line += "|*Eggs" + __html_right_arrow_character + "Spatula";
    breakfast_line += "|*Potatoes" + __html_right_arrow_character + "Whisk";
    breakfasts.listAppend(breakfast_line); breakfast_line = "";
    
    
    //It's actually anything, but let's pick one:
    //Meat & Torch, Bread & Whisk, Batter & Knife, Eggs & Cutter, Potatoes & Spatula
    breakfast_line += "<hr>";
    breakfast_line += "Breakfast Clubbed: (+ML)";
    breakfast_line += "|*Meat" + __html_right_arrow_character + "Cr&egrave;me Brul&eacute;e Torch";
    breakfast_line += "|*Bread" + __html_right_arrow_character + "Whisk";
    breakfast_line += "|*Batter" + __html_right_arrow_character + "Butterknife";
    breakfast_line += "|*Eggs" + __html_right_arrow_character + "Cookie Cutter";
    breakfast_line += "|*Potatoes" + __html_right_arrow_character + "Spatula";
    breakfasts.listAppend(breakfast_line); breakfast_line = "";
    
    description.listAppend("There are four different breakfasts possible:" + HTMLGenerateIndentedText(breakfasts));
    
    if ($item[Ginsu&trade;].available_amount() == 0)
        description.listAppend("Making all four breakfasts in the same ascension lets you acquire the sword, " + $item[Ginsu&trade;] + ".");
        
	optional_task_entries.listAppend(ChecklistEntryMake(476, "__effect My Breakfast With Andrea", "place.php?whichplace=junggate_5", ChecklistSubentryMake("The Pretentious Artist's Obsession", modifiers, description),$locations[a kitchen drawer, a grocery bag]));
}

RegisterTaskGenerationFunction("IOTMPsychoanalyticGenerateTasks");
void IOTMPsychoanalyticGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!get_property_boolean("_psychoJarUsed"))
        return;
    //Can't detect which jar was used, so check where they've been:
    if ($locations[chinatown shops, chinatown tenement, triad factory,1st floor\, shiawase-mitsuhama building,2nd floor\, shiawase-mitsuhama building,3rd floor\, shiawase-mitsuhama building] contains __last_adventure_location)
    {
        //
        IOTMPShadyPastGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[The Old Man's Bathtime Adventures] contains __last_adventure_location)
    {
        //
        IOTMPOldManGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[The Nightmare Meatrealm] contains __last_adventure_location)
    {
        IOTMPMeatGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[The gourd!] contains __last_adventure_location)
    {
        IOTMPGourdGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[anger man's level, fear man's level, doubt man's level, regret man's level] contains __last_adventure_location)
    {
        //
        IOTMPCrackpotGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[the tower of procedurally-generated skeletons] contains __last_adventure_location)
    {
        IOTMPJickGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
    if ($locations[a kitchen drawer, a grocery bag] contains __last_adventure_location)
    {
        //
        IOTMPArtistGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    }
}
void IOTMGrimstoneHareGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    string [int] description;
    string [int] modifiers;
    
    modifiers.listAppend("mysticality");
    modifiers.listAppend("spell damage percent");
    modifiers.listAppend("spell critical percent");
    int time_remaining = $effect[hare-brained].have_effect();
    
    //FIXME deal with coldform / hotform / etc
    
    description.listAppend("Adventure on the deserted stretch of road.|Cast elemental-aligned powerful spells on vehicles.|The more damage, the faster you go.");
    
    description.listAppend("The speedy/expensive strategy is to nanorhino/ice house/batter up/pantsgiving/crystal skull/etc. banish everything that isn't an ice cream truck, and olfact ice cream trucks.|Then run coldform, buff spell damage, mysticality, and spell damage critical.|Then cast shrap.");
    
    string [string] elemental_descriptions;
    
    string [int] missing_hobopolis_spells;
    
    elemental_descriptions["hot"] = HTMLGenerateSpanOfClass("hot", "r_element_hot");
    elemental_descriptions["cold"] = HTMLGenerateSpanOfClass("cold", "r_element_cold");
    elemental_descriptions["spooky"] = HTMLGenerateSpanOfClass("spooky", "r_element_spooky");
    elemental_descriptions["stench"] = HTMLGenerateSpanOfClass("stench", "r_element_stench");
    elemental_descriptions["sleaze"] = HTMLGenerateSpanOfClass("sleaze", "r_element_sleaze");
    
    
    boolean have_shrap = $skill[shrap].skill_is_usable();
    
    if (have_shrap && $effect[hotform].have_effect() > 0)
        elemental_descriptions["hot"] = "Shrap (" + elemental_descriptions["hot"] + ")";
    else if ($skill[volcanometeor showeruption].skill_is_usable())
        elemental_descriptions["hot"] = "Volcanometeor Showeruption (" + elemental_descriptions["hot"] + ")";
    else if ($skill[Awesome Balls of Fire].skill_is_usable())
        elemental_descriptions["hot"] = "Awesome Balls of Fire (" + elemental_descriptions["hot"] + ")";
    else
        missing_hobopolis_spells.listAppend("Awesome Balls of Fire");
    
    
    if (have_shrap && $effect[coldform].have_effect() > 0)
        elemental_descriptions["cold"] = "Shrap (" + elemental_descriptions["cold"] + ")";
    else if ($skill[Snowclone].skill_is_usable())
        elemental_descriptions["cold"] = "Snowclone (" + elemental_descriptions["cold"] + ")";
    else
        missing_hobopolis_spells.listAppend("Snowclone");
    
    if (have_shrap && $effect[spookyform].have_effect() > 0)
        elemental_descriptions["spooky"] = "Shrap (" + elemental_descriptions["spooky"] + ")";
    else if ($skill[Raise Backup Dancer].skill_is_usable())
        elemental_descriptions["spooky"] = "Raise Backup Dancer (" + elemental_descriptions["spooky"] + ")";
    else
        missing_hobopolis_spells.listAppend("Raise Backup Dancer");
    
    if (have_shrap && $effect[stenchform].have_effect() > 0)
        elemental_descriptions["stench"] = "Shrap (" + elemental_descriptions["stench"] + ")";
    else if ($skill[Eggsplosion].skill_is_usable())
        elemental_descriptions["stench"] = "Eggsplosion (" + elemental_descriptions["stench"] + ")";
    else
        missing_hobopolis_spells.listAppend("Eggsplosion");
    
    
    if (have_shrap && $effect[sleazeform].have_effect() > 0)
        elemental_descriptions["sleaze"] = "Shrap (" + elemental_descriptions["sleaze"] + ")";
    else if ($skill[Grease Lightning].skill_is_usable())
        elemental_descriptions["sleaze"] = "Grease Lightning (" + elemental_descriptions["sleaze"] + ")";
    else
        missing_hobopolis_spells.listAppend("Grease Lightning");
    
    
    
    string [int][int] vehicle_descriptions;
    if (!$monster[Fire truck].is_banished())
        vehicle_descriptions.listAppend(listMake("Fire truck", elemental_descriptions["hot"]));
    if (!$monster[ice cream truck].is_banished())
        vehicle_descriptions.listAppend(listMake("ice cream truck", elemental_descriptions["cold"]));
    if (!$monster[monster hearse].is_banished())
        vehicle_descriptions.listAppend(listMake("monster hearse", elemental_descriptions["spooky"]));
    if (!$monster[sewer tanker].is_banished())
        vehicle_descriptions.listAppend(listMake("sewer tanker", elemental_descriptions["stench"]));
    if (!$monster[sketchy van].is_banished())
        vehicle_descriptions.listAppend(listMake("sketchy van", elemental_descriptions["sleaze"]));
    
    monster last_encounter = get_property_monster("lastEncounter");
    //string [int] vehicles = split_string_alternate("Fire truck,ice cream truck,monster hearse,sewer tanker,sketchy van", ",");
    monster [int] vehicles = {$monster[Fire truck],$monster[ice cream truck],$monster[monster hearse],$monster[sewer tanker],$monster[sketchy van]};
    
    foreach key in vehicles
    {
        monster vehicle = vehicles[key];
        if (vehicle == $monster[none])
            continue;
        
        if (last_encounter != vehicle)
            continue;
        
        vehicle_descriptions[key][0] = HTMLGenerateSpanOfClass(vehicle_descriptions[key][0], "r_bold");
        vehicle_descriptions[key][1] = HTMLGenerateSpanOfClass(vehicle_descriptions[key][1], "r_bold");
    }
    
    description.listAppend("Spells to cast: " + HTMLGenerateIndentedText(HTMLGenerateSimpleTableLines(vehicle_descriptions)));
    
    if (my_familiar() != $familiar[magic dragonfish])
        description.listAppend("Run magic dragonfish familiar.");
    else if ($familiar[magic dragonfish].familiar_weight() < 20)
        description.listAppend("Gain " + (20 - $familiar[magic dragonfish].familiar_weight()) + " pounds on your magic dragonfish.");
    
    if (missing_hobopolis_spells.count() > 0)
        description.listAppend("Could acquire " + missing_hobopolis_spells.listJoinComponents(", ", "or") + " from the mall.");
    
    if ($skill[frigidalmatian].skill_is_usable() && $effect[frigidalmatian].have_effect() == 0)
        description.listAppend("Could cast frigidalmatian. (expensive)");
    
    if (my_basestat($stat[mysticality]) < 400)
        description.listAppend("May want to gain " + (400 - my_basestat($stat[mysticality])) + " more mysticality.");
    
    description.listAppend(pluralise(time_remaining, "turn", "turns") + " remaining in race.");
    
    
    
    
    //$location[A Deserted Stretch of I-911]
	optional_task_entries.listAppend(ChecklistEntryMake(560, "__effect hare-brained", "place.php?whichplace=ioty2014_hare", ChecklistSubentryMake("Hare Race", modifiers, description)));
}

void IOTMGrimstoneStepmotherGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    int minutes_to_midnight = get_property_int("cinderellaMinutesToMidnight");
    if (minutes_to_midnight <= 0)
        return;
    
    //if (__misc_state["in run"] && !($locations[the prince's kitchen,the prince's balcony,the prince's lounge,the prince's canapes table,the prince's restroom,the prince's dance floor] contains __last_adventure_location) && minutes_to_midnight < 30)
        //return;
    
    int score = get_property_int("cinderellaScore");
    string [int] description;
    string [int] modifiers;
    
    
    if (minutes_to_midnight > 0)
    {
        string line;
        line = pluralise(minutes_to_midnight, "minute", "minutes") + " to midnight.";
        
        if (score > 0)
            line += " " + pluralise(score, "point", "points") + " earned.";
        
        description.listAppend(line);
    }
    
    /*
        The idea behind this solution is you want to put three items into cindy's purse.
        The first two make her ignore her hankerchief and go to the restroom - where the doctored soap gives her puffy eyes - whereupon she returns and confirms the disease rumor.
        The third is the mouse, which you confront her about. Then later she'll not have the purse at all and go to the restroom again.
        
        There are other solutions, but I don't know them. Find them! It's a fun puzzle.
    */
    
    string [int][int] minute_to_action;
    minute_to_action[30] = listMake("Lounge", "Take a cigar from the sideboard"); //I say, old chap
    minute_to_action[29] = listMake("Balcony", "Examine the flowers."); //to give to prince
    minute_to_action[28] = listMake("Canaps Table", "Give your carnation to the Prince."); //causes sneezing fit at 23, 13, 3
    minute_to_action[27] = listMake("Canaps Table", "Slip something into Cindy's purse while she's distracted", "The cigar."); //Make her leave when sneezing
    minute_to_action[26] = listMake("Balcony", "Examine the flowers."); //For doctoring
    minute_to_action[25] = listMake("Restroom", "Rub the flower on the soap."); //For 23 sneezing.
    minute_to_action[24] = listMake("Lounge", "Start a rumor about Cinderella", "Cinderella has a terrible disease."); //Points!
    minute_to_action[23] = listMake("Lounge", "Take the empty cigar box."); //Mouse trap setup. 3 points (from sneezing)
    minute_to_action[22] = listMake("Kitchen", "Inspect the kitchen pantry."); //Acquire cinnamon, notice mouse hole.
    minute_to_action[21] = listMake("Canaps Table", "Take a piece of cheese."); //Mouse trap setup.
    minute_to_action[20] = listMake("Kitchen", "Set a trap for the mouse."); //Set up mouse trap with cigar box and cheese. (if we had room, soap too, but that adds one point and there's no room - used in 31-point solution)
    minute_to_action[19] = listMake("Canaps Table", "Slip something into Cindy's purse while she's distracted", "The cinnamon."); //For 13 sneezing fit, makes her ignore hankerchief.
    minute_to_action[18] = listMake("Lounge", "Take the whiskey flask."); //To make cindy drunk. 5 points (prince hears rumor)
    minute_to_action[17] = listMake("Canaps Table", "Pour some whisky into Cindy's glass."); //Cindy's drunk - used at 16, 6, and extra points from soap.
    minute_to_action[16] = listMake("Balcony", "Examine the flowers."); //For stealing a hairpin from baronness. 6 points (16 behavior hits, she's drunk)
    minute_to_action[15] = listMake("Balcony", "Speak with the Baroness."); //First step baronness
    minute_to_action[14] = listMake("Balcony", "Ask the Baroness what troubles her."); //Makes baronness move to dance floor
    minute_to_action[13] = listMake("Dance Floor", "Give your carnation to the Baroness and steal one of her hairpins."); //Now we can steal a hairpin. 11 points (sneezing fit with disease rumor)
    minute_to_action[12] = listMake("Restroom", "Look in the medicine cabinet", "Pick the lock", "Take the bottle of syrup of ipecac."); //Which we use to pick the lock of the medicine cabinet, acquiring ipecac.
    minute_to_action[11] = listMake("Kitchen", "Dose the tray of cannoli with ipecac."); //Ipecac we use here.
    minute_to_action[10] = listMake("Restroom", "Take some soap."); //We'll be throwing it later.
    minute_to_action[9] = listMake("Canaps Table", "Offer Cindy your 'customized' cannoli."); //Makes her throw up in eight turns. (no cinnamon)
    minute_to_action[8] = listMake("Kitchen", "Take the mouse out of the trap."); //It showed up. Hello mouse.
    minute_to_action[7] = listMake("Canaps Table", "Slip something into Cindy's purse while she's distracted", "The mouse."); //Third time.
    minute_to_action[6] = listMake("Canaps Table", "Ask Cindy to loan you her handkerchief."); //Hey, is that a mouse in your purse? 13 points. (one from mouse, one from 6 behavior)
    minute_to_action[5] = listMake("Dance Floor", "Kick some soap at Cindy."); //She's on the dance floor. Let's make her dance. 15 points. (dance!)
    minute_to_action[4] = listMake("Restroom", "Take some soap."); //Dancing supplies.
    minute_to_action[3] = listMake("Dance Floor", "Kick some soap at Cindy."); //Dance. 21 points (sneezing, dance!)
    minute_to_action[2] = listMake("Restroom", "Take some soap."); //Dancing supplies.
    minute_to_action[1] = listMake("Dance Floor", "Kick some soap at Cindy."); //She throws up. Dance. 32 points. (she threw up, dance!)
    
    if (false)
    {
        //output full details for reference:
        string line;
        foreach minute in minute_to_action
        {
            string description = minute_to_action[minute];
            line = "|" + pluralise(minute, "minute", "minutes") + ":|*" + minute_to_action[minute].listJoinComponents(" > ") + line;
        }
        description.listAppend(line);
    }
    //FIXME add the other two trophies?
    
    
    //int [int] needed_points_at_spot_to_be_following_correct_path; //score isn't tracked properly, and anyways there's split score per turn
    
    /*
30	take cigar
29	flower
28	give flower to prince
27	give cigar to cindy
26	flower
25	doctor soap
24	spread rumour (disease)
23	take empty cigar box
22	inspect kitchen
21	get cheese
20	set trap
19	plant cinnamon in cindy's purse
18	get whiskey
17	pour whiskey
16	flower
15	ask baronness
14	ask baronness x2
13	steal from baronness
12	steal ipecac
11	make cannoli (mouse available)
10	get soap
9	give cindy cannoli
8	get mouse
7	plant mouse
6	ask for hankerchief
5	kick soap
4	get soap
3	kick soap
2	get soap
1	kick soap
    */
    
    boolean output_next_step = true;
    //if (needed_points_at_spot_to_be_following_correct_path contains minutes_to_midnight && score != needed_points_at_spot_to_be_following_correct_path[minutes_to_midnight]) //they're doing a different route
        //output_next_step = false;
    
    if (minute_to_action contains minutes_to_midnight && output_next_step)
    {
        description.listAppend("Next step for 32 points:|*" + minute_to_action[minutes_to_midnight].listJoinComponents(__html_right_arrow_character));
        description.listAppend("Though, this is a fun puzzle to solve on your own.");
    }
    
    //FIXME add suggestions for other two trophies (partners in crime, ending party early)
	optional_task_entries.listAppend(ChecklistEntryMake(561, "__item long-stemmed rose", "place.php?whichplace=ioty2014_cindy", ChecklistSubentryMake("The Prince's Ball", modifiers, description)));
}

void IOTMGrimstoneWolfGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //FIXME I have no idea
    return;
}

void IOTMGrimstoneWitchGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //FIXME I have no idea
    return;
}

void IOTMGrimstoneGnomeGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //FIXME I have no idea
    return;
}

RegisterTaskGenerationFunction("IOTMGrimstoneGenerateTasks");
void IOTMGrimstoneGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //grimstoneMaskPath
    //rumpelstiltskinTurnsUsed gives number of turns used getting materials. rumpelstiltskinKidsRescued gives the number of children rescued. It is likely that there are more messages than are documented on the wiki, so if some are missing and aren't parsed correctly, please put a note in the forum.
    //cinderellaMinutesToMidnight gives number of turns remaining. cinderellaScore gives the current score. Also added grimstoneMaskPath which gives the current grimstone content available, "stepmother", "wolf", "witch", "gnome" or "hare".
    
    string mask_path = get_property("grimstoneMaskPath").to_lower_case();
    
    if ($effect[hare-brained].have_effect() > 0)
        IOTMGrimstoneHareGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (mask_path == "stepmother")
        IOTMGrimstoneStepmotherGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (mask_path == "wolf")
        IOTMGrimstoneWolfGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (mask_path == "witch")
        IOTMGrimstoneWitchGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (mask_path == "gnome")
        IOTMGrimstoneGnomeGenerateTasks(task_entries, optional_task_entries, future_task_entries);
    if (mask_path == "tuxedo")
        task_entries.listAppend(ChecklistEntryMake(562, "__item long-stemmed rose", "place.php?whichplace=arcade", ChecklistSubentryMake("Believe in yourself", "", ""), -11));
}
static
{
    string [item] __machine_elf_abstractions_description;
    
    void machineElfAbstractionDescriptionsInit()
    {
        __machine_elf_abstractions_description[$item[abstraction: motion]] = "+100% init";
        __machine_elf_abstractions_description[$item[abstraction: certainty]] = "+100% item";
        __machine_elf_abstractions_description[$item[abstraction: joy]] = "+10 familiar weight";
        __machine_elf_abstractions_description[$item[abstraction: category]] = "+25% mysticality gains";
        __machine_elf_abstractions_description[$item[abstraction: perception]] = "+25% moxie gains";
        __machine_elf_abstractions_description[$item[abstraction: purpose]] = "+25% muscle gains";
    }
    machineElfAbstractionDescriptionsInit();
}

RegisterResourceGenerationFunction("IOTMMachineElfFamiliarGenerateResource");
void IOTMMachineElfFamiliarGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$familiar[machine elf].familiar_is_usable())
        return;
    
    string url = "place.php?whichplace=dmt";
    if (my_familiar() != $familiar[machine elf])
        url = "familiar.php";
    int importance = 0;
    if (!__misc_state["in run"] || !__misc_state["need to level"])
        importance = 6;
    
    ChecklistEntry entry = ChecklistEntryMake(490);
    entry.image_lookup_name = "__familiar machine elf";
    entry.url = url;
    entry.importance_level = importance;
    if (__last_adventure_location == $location[the deep machine tunnels])
        entry.should_highlight = true;
    
    
    
    
    //This test is incredibly inaccurate, because all sorts of things end up in the NC queue. (We All Wear Masks, Approach the Jellyfish, The Mad Tea Party)
    boolean duplication_nc_probably_visited = true;
    if ($location[the deep machine tunnels].noncombat_queue == "")
        duplication_nc_probably_visited = false;
    else if ($location[the deep machine tunnels].noncombatTurnsAttemptedInLocation() >= 5)
    {
        duplication_nc_probably_visited = true;
    }
    else
    {
        duplication_nc_probably_visited = false;
        //Look for known strings for the second part of the NC name:
        //The full list I've seen is:
        //Across The Universe,Backwards In Time,Forwards In Time,Into The 4th Dimension,Into The 5th Dimension,Into The 6th Dimension,Into The 7th Dimension,Into The 8th Dimension,Into The 9th Dimension,Into The Ether,Into Your Body,Into Your Consciousness,Into Your Courage,Into Your Dreams,Into Your Experience,Into Your Eye,Into Your Heart,Into Your Life,Into Your Liver,Into Your Memories,Into Your Mind,Into Your Pineal Gland,Into Your Regrets,Into Your Soul,Into Your Third Ear,Into Your Third Eye,Into Your Thoughts,Into Your Timeline,Into Your Voice,Sideways In Time
        foreach s in $strings[Across The Universe,Backwards In Time,Forwards In Time,Sideways In Time,Into The ,Into Your ]
        {
            if ($location[the deep machine tunnels].noncombat_queue.contains_text(s))
            {
                duplication_nc_probably_visited = true;
                break;
            }
        }
    }
    if (!duplication_nc_probably_visited && $location[the deep machine tunnels].turns_spent >= 5)
    {
        string [int] description;
        description.listAppend("Next" + ($location[the deep machine tunnels].turns_spent > 5 ? "(?)" : "") + " turn in the DMT. Costs a turn.");
        description.listAppend("Copy a PVPable potion, food, drink, or spleen item.");
        item [int] suggested_items;
        if (suggested_items.count() > 0)
            description.listAppend("Possibly " + suggested_items.listJoinComponents(", ", "or") + ".");
        entry.subentries.listAppend(ChecklistSubentryMake("Item duplication available", "", description));
    }
    
    
    
    int free_fights_remaining = clampi(5 - get_property_int("_machineTunnelsAdv"), 0, 5);
    if (free_fights_remaining > 0)
    {
        string [int] description;
        string [int] modifiers;
        string [int] tasks;
        if (my_familiar() != $familiar[machine elf])
        {
            tasks.listAppend("bring along your machine elf");
        }
        tasks.listAppend("adventure in the machine tunnels");
        string line = tasks.listJoinComponents(", ", "and").capitaliseFirstLetter();
        if (__misc_state["need to level"])
        {
            modifiers.listAppend("+" + my_primestat().to_lower_case());
            line += " to gain stats";
        }
        line += ".";
        description.listAppend(line);
        
        if (spleen_limit() > 0)
        {
            //abstraction: sensation -> square monster -> abstraction: motion (+100% init)
            //abstraction: thought -> triangle monster -> abstraction: certainty (+100% item)
            //abstraction: action -> circle monster -> abstraction: joy (+10 familiar weight)
            //FIXME suggest abstraction methods.
            item [item] abstraction_conversions;
            abstraction_conversions[$item[abstraction: sensation]] = $item[abstraction: motion];
            abstraction_conversions[$item[abstraction: thought]] = $item[abstraction: certainty];
            if (!__misc_state["familiars temporarily blocked"])
                abstraction_conversions[$item[abstraction: action]] = $item[abstraction: joy];
            
            monster [item] abstraction_monsters;
            abstraction_monsters[$item[abstraction: sensation]] = $monster[Performer of Actions];
            abstraction_monsters[$item[abstraction: thought]] = $monster[Perceiver of Sensations];
            abstraction_monsters[$item[abstraction: action]] = $monster[Thinker of Thoughts];
            
            string [monster] monster_descriptions;
            monster_descriptions[$monster[Performer of Actions]] = "square";
            monster_descriptions[$monster[Perceiver of Sensations]] = "triangle";
            monster_descriptions[$monster[Thinker of Thoughts]] = "circle";
            
            
            
            foreach source, result in abstraction_conversions
            {
                string result_description = __machine_elf_abstractions_description[result];
                if (result_description == "")
                    continue;
                if (source.item_amount() == 0)
                    continue;
                
                monster m = abstraction_monsters[source];
                string monster_text = monster_descriptions[m] + " monster";
                
                string line = "Throw " + source + " at " + monster_text;
                if (last_monster() == m)
                    line = HTMLGenerateSpanOfClass(line, "r_bold");
                line += " for " + result_description + " spleen potion. (50 turns)";
                
                description.listAppend(line);
            }
            if ($item[abstraction: thought].item_amount() == 0)
                description.listAppend("Possibly run the machine elf elsewhere first, for transmutable potions.");
        }
        //entry.subentries.listAppend(ChecklistSubentryMake(pluralise(free_fights_remaining, "free elf fight", "free elf fights"), modifiers, description));
        resource_entries.listAppend(ChecklistEntryMake(491, entry.image_lookup_name, entry.url, ChecklistSubentryMake(pluralise(free_fights_remaining, "free elf fight", "free elf fights"), modifiers, description)).ChecklistEntryTag("daily free fight"));
    }
    if (entry.subentries.count() > 0)
    {
        resource_entries.listAppend(entry);
    }
}

RegisterResourceGenerationFunction("IOTMMachineElfGenerateResource");
void IOTMMachineElfGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (in_ronin() && spleen_limit() > 0)
    {
        boolean [item] useful_abstractions;
        
        useful_abstractions[$item[abstraction: motion]] = true;
        useful_abstractions[$item[abstraction: certainty]] = true;
        if (!__misc_state["familiars temporarily blocked"])
            useful_abstractions[$item[abstraction: joy]] = true;
        if (__misc_state["need to level"])
        {
            if (my_primestat() == $stat[muscle])
                useful_abstractions[$item[abstraction: purpose]] = true;
            else if (my_primestat() == $stat[mysticality])
                useful_abstractions[$item[abstraction: category]] = true;
            else if (my_primestat() == $stat[moxie])
                useful_abstractions[$item[abstraction: perception]] = true;
        }
        
        string image_name = "";
		ChecklistSubentry [int] abstraction_lines;
        foreach it in useful_abstractions
        {
			if (it.available_amount() == 0 || !it.is_unrestricted())
				continue;
			string description = __machine_elf_abstractions_description[it] + ". (50 turns, one spleen)";
			if (image_name == "")
                image_name = "__item " + it;
			abstraction_lines.listAppend(ChecklistSubentryMake(pluralise(it), "",  description));
		}
		if (abstraction_lines.count() > 0)
			resource_entries.listAppend(ChecklistEntryMake(492, image_name, "inventory.php?which=1", abstraction_lines, 7));
    }
}
RegisterResourceGenerationFunction("IOTMSnojoGenerateResource");
void IOTMSnojoGenerateResource(ChecklistEntry [int] resource_entries)
{
    ChecklistEntry snojo_skill_entry;
    if ($skill[Shattering Punch].skill_is_usable())
    {
        int punches_left = clampi(3 - get_property_int("_shatteringPunchUsed"), 0, 3);
        if (punches_left > 0)
        {
            string [int] description;
            description.listAppend("Win a fight without taking a turn.");
            
            
            //if (snojo_skill_entry.image_lookup_name == "")
                //snojo_skill_entry.image_lookup_name = "__skill shattering punch";
            resource_entries.listAppend(ChecklistEntryMake(484, "__skill shattering punch", "", ChecklistSubentryMake(pluralise(punches_left, "shattering punch", "shattering punches"), "", description), 0).ChecklistEntryTag("free instakill"));
            
        }
    }
    if ($skill[Snokebomb].skill_is_usable())
    {
        int snokes_left = clampi(3 - get_property_int("_snokebombUsed"), 0, 3);
        if (snokes_left > 0)
        {
            string [int] description;
            description.listAppend("Free run/banish.");
            if (snojo_skill_entry.image_lookup_name == "")
                snojo_skill_entry.image_lookup_name = "__skill Snokebomb";
            Banish snoke_banish = BanishByName("snokebomb");
            int turns_left_of_banish = snoke_banish.BanishTurnsLeft();
            if (turns_left_of_banish > 0)
            {
                //is this relevant? we don't describe this for pantsgiving
                description.listAppend("Currently used on " + snoke_banish.banished_monster + " for " + pluralise(turns_left_of_banish, "more turn", "more turns") + ".");
            }
            //snojo_skill_entry.subentries.listAppend(ChecklistSubentryMake(pluralise(snokes_left, "snokebomb", "snokebombs"), "", description));
            resource_entries.listAppend(ChecklistEntryMake(485, "__skill snokebomb", "", ChecklistSubentryMake(pluralise(snokes_left, "snokebomb", "snokebombs"), "", description), 0).ChecklistEntryTag("free banish"));
        }
    }
    
    if (snojo_skill_entry.subentries.count() > 0)
    {
        snojo_skill_entry.importance_level = 6;
        if (!__misc_state["in run"])
            snojo_skill_entry.importance_level = 9;
        resource_entries.listAppend(snojo_skill_entry);
    }


    //Everything past here is for snojo owners:
    if (!__iotms_usable[$item[X-32-F snowman crate]])
        return;
    
    int fights_remaining = clampi(10 - get_property_int("_snojoFreeFights"), 0, 10);
    if (fights_remaining > 0)
    {
        item [stat] training_equipment_for_stat;
        training_equipment_for_stat[$stat[muscle]] = $item[training belt];
        training_equipment_for_stat[$stat[mysticality]] = $item[training legwarmers];
        training_equipment_for_stat[$stat[moxie]] = $item[training helmet];
        
        item [stat] consumable_reward_for_stat;
        consumable_reward_for_stat[$stat[muscle]] = $item[ancient medicinal herbs];
        consumable_reward_for_stat[$stat[mysticality]] = $item[ice rice];
        consumable_reward_for_stat[$stat[moxie]] = $item[iced plum wine];
        
        string [item] reward_descriptions;
        reward_descriptions[$item[training belt]] = "+25 ML accessory";
        reward_descriptions[$item[training helmet]] = "+25% item hat";
        reward_descriptions[$item[training legwarmers]] = "+5 res accessory";
        reward_descriptions[$item[ice rice]] = "epic food";
        reward_descriptions[$item[iced plum wine]] = "epic drink";
        
        
        string [int] description;
        
        string setting = get_property("snojoSetting");
        
        if (setting == "NONE" || setting == "")
        {
            description.listAppend("Visit the control console.");
        }
        
        string wins_property = "";
        stat current_stat;
        if (setting == "MUSCLE")
        {
            current_stat = $stat[muscle];
            wins_property = "snojoMuscleWins";
        }
        else if (setting == "MOXIE")
        {
            current_stat = $stat[moxie];
            wins_property = "snojoMoxieWins";
        }
        else if (setting == "MYSTICALITY")
        {
            current_stat = $stat[mysticality];
            wins_property = "snojoMysticalityWins";
        }
        
        int wins = 0;
        if (wins_property != "")
            wins = get_property_int(wins_property);
        
        
        int [string] winnings;
        if (wins_property != "")
        {
            winnings["skill scroll"] = 50;
            if (reward_descriptions[training_equipment_for_stat[current_stat]] != "")
                winnings[reward_descriptions[training_equipment_for_stat[current_stat]]] = 11;
            if (consumable_reward_for_stat[current_stat] != $item[none])
            {
                int value = ceil(wins.to_float() / 7.0) * 7;
                if (value == wins)
                    value += 7;
                winnings[consumable_reward_for_stat[current_stat].to_string()] = MAX(7, value);
            }
        }
        
        //Output in order of upcoming appearance:
        string [int] winnings_order;
        foreach winning in winnings
            winnings_order.listAppend(winning);
        sort winnings_order by winnings[value];
        
        string [int] various_winnings_upcoming;
        foreach key, winning in winnings_order
        {
            int timing = winnings[winning];
            if (wins >= timing)
                continue;
            int turns_remaining = timing - wins;
            if (turns_remaining == 1)
                various_winnings_upcoming.listAppend(winning + " next turn");
            else
                various_winnings_upcoming.listAppend(winning + " in " + pluralise(turns_remaining, "turn", "turns"));
        }
        
        if (various_winnings_upcoming.count() > 0)
            description.listAppend(various_winnings_upcoming.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        
        if (setting != "TOURNAMENT" && (!__misc_state["in run"] || wins >= 50))
        {
            //Skill scrolls:
            string [int] switchables;
            if (get_property_int("snojoMuscleWins") < 50 && setting != "MUSCLE")
                switchables.listAppend("muscle");
            if (get_property_int("snojoMoxieWins") < 50 && setting != "MOXIE")
                switchables.listAppend("moxie");
            if (get_property_int("snojoMysticalityWins") < 50 && setting != "MYSTICALITY")
                switchables.listAppend("mysticality");
            if (switchables.count() > 0)
            {
                string line = "Could switch to " + switchables.listJoinComponents(", ", "or") + " for ";
                string additional = "";
                if (wins < 50)
                    additional = "different ";
                if (switchables.count() > 1)
                    line += additional + "skill scrolls";
                else
                    line += "a " + additional + "skill scroll";
                line += ".";
                description.listAppend(line);
            }
        }
        if (__misc_state["in run"])
        {
            //Possible rewards to switch to:
            string [int] switchable_options;
            foreach s in $stats[muscle,moxie,mysticality]
            {
                if (s == current_stat)
                    continue;
                item training_equipment = training_equipment_for_stat[s];
                item consumable = consumable_reward_for_stat[s];
                
                string [int] acquirable_descriptions;
                if (training_equipment.available_amount() == 0 && my_path_id() != PATH_GELATINOUS_NOOB)
                {
                    acquirable_descriptions.listAppend("a " + reward_descriptions[training_equipment]);
                }
                if (s != $stat[muscle] && !(!__misc_state["can drink just about anything"] && s == $stat[moxie]) && !(!__misc_state["can eat just about anything"] && s == $stat[mysticality]))
                {
                    acquirable_descriptions.listAppend(reward_descriptions[consumable]);
                }
                if (acquirable_descriptions.count() > 0)
                    switchable_options.listAppend(s.to_string().to_lower_case() + " for " + acquirable_descriptions.listJoinComponents("/"));
            }
            if (switchable_options.count() > 0)
            {
                description.listAppend("Could switch to " + switchable_options.listJoinComponents(", ", "or") + ".");
            }
        }
        int importance = 6;
        if (__misc_state["in run"])
            importance = 0;
        ChecklistSubentry [int] subentries;
        subentries.listAppend(ChecklistSubentryMake(pluralise(fights_remaining, "free Snojo fight", "free Snojo fights"), "", description));
        resource_entries.listAppend(ChecklistEntryMake(486, "__item snow suit", "place.php?whichplace=snojo", subentries, importance, $locations[the x-32-f combat training snowman]).ChecklistEntryTag("daily free fight"));
    }
}


RegisterTaskGenerationFunction("IOTMTelegraphOfficeGenerateTasks");
void IOTMTelegraphOfficeGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[LT&T telegraph office deed]])
        return;
    
    
    if ($item[your cowboy boots].available_amount() == 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(594, "__item your cowboy boots", "place.php?whichplace=town_right", ChecklistSubentryMake("Acquire your cowboy boots", "", "Visit the LT&T office."), 0));
        
    }
    
    
    
    QuestState ltt_quest = QuestState("questLTTQuestByWire");
    
    if (!ltt_quest.in_progress)
        return;
    
    int difficulty = get_property_int("lttQuestDifficulty");
    int stage_count = get_property_int("lttQuestStageCount");
    string quest_name = get_property("lttQuestName");
    if (quest_name == "")
        return;
    
    //step1 - the investigation begins
    //step2 - The Investigation Continues
    //step3 - The Investigation Continues
    //step4 - boss fight
    
    int turns_completed = stage_count;
    if (ltt_quest.mafia_internal_step > 2)
        turns_completed += 10;
    if (ltt_quest.mafia_internal_step > 3)
        turns_completed += 10;
    if (ltt_quest.mafia_internal_step > 4)
        turns_completed += 10;
        //quest_name is blank when not on the quest
    int turns_remaining = clampi(29 - turns_completed, 0, 29);
    //"Missing: Many Children" - clara
    //"Wagon Train Escort Wanted" - Granny Hackleton
    //"Madness at the Mine" - unusual construct
    
    monster [string] boss_for_quest;
    
    boss_for_quest["Missing: Fancy Man"] = $monster[Jeff the Fancy Skeleton];
    boss_for_quest["Help!  Desperados!"] = $monster[Pecos Dave];
    boss_for_quest["Missing: Pioneer Daughter"] = $monster[Daisy the Unclean];
    
    boss_for_quest["Big Gambling Tournament Announced"] = $monster[Snake-Eyes Glenn];
    boss_for_quest["Haunted Boneyard"] = $monster[Pharaoh Amoon-Ra Cowtep];
    boss_for_quest["Sheriff Wanted"] = $monster[Former Sheriff Dan Driscoll];
    
    boss_for_quest["Missing: Many Children"] = $monster[Clara];
    boss_for_quest["Wagon Train Escort Wanted"] = $monster[Granny Hackleton];
    boss_for_quest["Madness at the Mine"] = $monster[unusual construct];
    
    
    
    string [int] description;
    string [int] modifiers;
    if (turns_remaining > 0)
        description.listAppend(pluraliseWordy(turns_remaining, "more turn", "more turns").capitaliseFirstLetter() + " until the boss.");
    if (turns_remaining == 0 || ltt_quest.mafia_internal_step == 5)
    {
        monster boss = boss_for_quest[quest_name];
        if (boss == $monster[none])
            description.listAppend("Defeat the boss.");
        else
            description.listAppend("Defeat " + boss + ".");
        boolean frigidalmatian_eligible = false;
        if (boss == $monster[Clara])
        {
            modifiers.listAppend("+elemental resistance");
            description.listAppend("Use high-damage spells, like shrap + snow mobile/green lantern.");
            frigidalmatian_eligible = true;
        }
        else if (boss == $monster[Granny Hackleton])
        {
            description.listAppend("Use different high-damage combat items, or frigidalmatian and attack.");
            //FIXME suggest a list of combat items to use
            frigidalmatian_eligible = true;
        }
        else if (boss == $monster[unusual construct])
        {
            description.listAppend("Each round, you have to respond with the correct shiny disc to survive. Mafia will select the correct one.|Maybe funksling with new-age hurting crystals.");
            frigidalmatian_eligible = true;
        }
        else if (boss == $monster[Jeff the Fancy Skeleton])
        {
            description.listAppend("Attack with a blunt weapon. (clubs, flails, saucepans...)");
            description.listAppend("Combat items won't work, skills are mostly blocked.");
        }
        else if (boss == $monster[Pecos Dave])
        {
            description.listAppend("Attack with multiple sources of damage.");
            if ($item[wicker slicker].available_amount() > 0 && $skill[shell up].have_skill())
            {
                if ($item[wicker slicker].equipped_amount() > 0)
                    description.listAppend("Shell up on alternate rounds?");
                else
                    description.listAppend("Equip wicker slicker and shell up on alternate rounds?");
            }
            frigidalmatian_eligible = true;
        }
        else if (boss == $monster[Daisy the Unclean])
        {
            //FIXME
        }
        else if (boss == $monster[Snake-Eyes Glenn])
        {
            description.listAppend("Immune to all but a single element type each round.|Previous round's second roll indicates which.");
        }
        else if (boss == $monster[Pharaoh Amoon-Ra Cowtep])
        {
            description.listAppend("Avoid attacking with spell damage.");
        }
        else if (boss == $monster[Former Sheriff Dan Driscoll])
        {
            description.listAppend("Acquire passive damage (glowing syringes?), attack repeatedly.");
            frigidalmatian_eligible = true;
        }
        
        if (frigidalmatian_eligible)
        {
            string [int] tasks;
            boolean frigidalmatian_obtainable = false;
            if ($effect[frigidalmatian].have_effect() > 0)
                frigidalmatian_obtainable = true;
            if ($effect[frigidalmatian].have_effect() == 0 && $skill[frigidalmatian].have_skill())
            {
                frigidalmatian_obtainable = true;
                tasks.listAppend("cast frigidalmatian");
            }
            if (frigidalmatian_obtainable && $items[rain-doh green lantern,snow mobile].equipped_amount() == 0)
            {
                if ($item[rain-doh green lantern].available_amount() > 0)
                {
                    tasks.listAppend("equip rain-doh green lantern");
                }
                else if ($items[meteorb,metal meteoroid].available_amount() > 0)
                {
                    tasks.listAppend("equip meteorb");
                }
                else if ($item[snow mobile].is_unrestricted())
                {
                    if ($item[snow mobile].available_amount() > 0)
                    {
                        tasks.listAppend("equip snow mobile");
                    }
                    else
                        tasks.listAppend("acquire and equip snow mobile");
                }
            }
            if (tasks.count() > 0)
                description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        }
    }
    
    if (false)
    {
        foreach s in $strings[lttQuestDifficulty,lttQuestStageCount,lttQuestName,questLTTQuestByWire]
            description.listAppend(s + " = " + get_property(s));
    }
    
    ChecklistEntry entry = ChecklistEntryMake(595, "__item sea cowboy hat", "inventory.php?which=3", ChecklistSubentryMake(quest_name, modifiers, description), $locations[Investigating a Plaintive Telegram]);
    if (__misc_state["in run"])
        future_task_entries.listAppend(entry);
    else
        optional_task_entries.listAppend(entry);
}

RegisterResourceGenerationFunction("IOTMTelegraphOfficeGenerateResource");
void IOTMTelegraphOfficeGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (__misc_state["in run"] && $item[Clara's bell].available_amount() > 0 && !get_property_boolean("_claraBellUsed"))
    {
        string [int] description;
        description.listAppend("Ring for a non-combat next turn, once/day.");
        
        LocationChoice [int] options;
        
        //spooky forest - unlocking the hidden temple
        //6 - advance one of the quest areas
        //7 - defiled cranny
        //8 - umm... maybe the extreme slow? unimportant?
        //9 - twin peak
        //10 - top/bottom of the castle, best place in the game(?)
        //11 - copperhead, protestors, fun hidden city exploit, hidden temple but marginal, palindome but marginal, pyramid in situations where you can't run lots of +item, poop deck, haunted billiards room, haunted bathroom
        //12 - starting the war(??)
        
        //2 - mosquito - not terribly important
        //3 - tavern - forces a skippable NC, not important
        
        if (!get_property_ascension("lastTempleUnlock"))
        {
            //options.listAppend("")
            options.listAppend(LocationChoiceMake($location[the spooky forest], "unlocking the hidden temple"));
        }
        
        if (my_path_id() == PATH_COMMUNITY_SERVICE)
        {
            foreach key in options
                remove options[key];
        }
        
        if (options.count() > 0)
        {
            description.listAppend("Suggested areas:|*" + LocationChoiceGenerateDescription(options).listJoinComponents("|*"));
        }
        
        
        resource_entries.listAppend(ChecklistEntryMake(596, "__item clara's bell", "inventory.php?which=3", ChecklistSubentryMake("Clara's Bell", "", description), 2));
    }
    
    //skills:
    //Bow-Legged Swagger -> _bowleggedSwaggerUsed
    //Bend Hell -> _bendHellUsed
    //Steely-Eyed Squint -> _steelyEyedSquintUsed
    //bend hell - double elemental damage/elemental spell damage
    if (true)
    {
        string [skill] telegraph_skill_properties;
        if (__misc_state["in run"])
        {
            telegraph_skill_properties[$skill[Bow-Legged Swagger]] = "_bowleggedSwaggerUsed";
            telegraph_skill_properties[$skill[Bend Hell]] = "_bendHellUsed";
        }
        telegraph_skill_properties[$skill[Steely-Eyed Squint]] = "_steelyEyedSquintUsed";
        
        string [skill] telegraph_skill_descriptions;
        telegraph_skill_descriptions[$skill[Bow-Legged Swagger]] = "Double +initiative and physical damage. Once/day.";
        telegraph_skill_descriptions[$skill[Bend Hell]] = "Double elemental damage/elemental spell damage. Once/day.";
        telegraph_skill_descriptions[$skill[Steely-Eyed Squint]] = "Double +item. Once/day.";
        
        string [skill] telegraph_short_descriptions = {
        $skill[bow-legged swagger]:"+init",
        $skill[Bend Hell]:"+ele",
        $skill[Steely-Eyed Squint]:"+item"};
        
        //ChecklistSubentry [int] subentries;
        foreach s, property in telegraph_skill_properties
        {
            string image_name;
            if (!s.skill_is_usable())
                continue;
            if (get_property_boolean(property))
                continue;
            
            //if (image_name == "")
                image_name = "__skill " + s;
            //subentries.listAppend(ChecklistSubentryMake(s + " castable", "", telegraph_skill_descriptions[s]));
            resource_entries.listAppend(ChecklistEntryMake(597, image_name, "skillz.php", ChecklistSubentryMake(s + " castable", "", telegraph_skill_descriptions[s]), 9).ChecklistEntryTag("telegraph skill").ChecklistEntrySetCategory("buff").ChecklistEntrySetShortDescription(telegraph_short_descriptions[s]));
        }
        //if (subentries.count() > 0)
            //resource_entries.listAppend(ChecklistEntryMake(598, image_name, "skillz.php", subentries, 9));
    }
}
RegisterResourceGenerationFunction("IOTMWitchessGenerateResource");
void IOTMWitchessGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[Witchess Set]])
        return;
    
    string image_name = "";
    ChecklistSubentry [int] subentries;
    if (get_property_int("_witchessFights") < 5)
    {
        string [int] description;
        int fights_remaining = clampi(5 - get_property_int("_witchessFights"), 0, 5);
        
        string [int][int] fight_descriptions;
        //fight_descriptions.listAppend(listMake(HTMLGenerateSpanOfClass("Piece", "r_bold"), HTMLGenerateSpanOfClass("Drop", "r_bold")));
        if (__misc_state["in run"])
        {
            //pawn - +50% init potion for moderns
            if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"] && $item[armored prawn].available_amount() == 0 && $item[armored prawn].to_effect().have_effect() == 0 && my_path_id() != PATH_G_LOVER)
            {
                fight_descriptions.listAppend(listMake("Pawn", "+50% init spleen potion."));
            }
            //rook - +ML / +stat potion
            if (my_path_id() != PATH_G_LOVER)
	            fight_descriptions.listAppend(listMake("Rook", "+25 ML/+statgain potion. (25 turns)"));
            //ox - shield
            if ($item[ox-head shield].available_amount() == 0 && my_path_id() != PATH_G_LOVER && __misc_state["can equip just about any off-hand"])
                fight_descriptions.listAppend(listMake("Ox", "+100HP, +2 all res, +8 PVP fights shield."));
            //king - club
            if ((my_path_id() == PATH_COMMUNITY_SERVICE || my_primestat() == $stat[muscle]) && $item[dented scepter].available_amount() == 0 && my_path_id() != PATH_G_LOVER && __misc_state["can equip just about any weapon"])
                fight_descriptions.listAppend(listMake("King", "+5 muscle stats/fight, +50% muscle, +50% weapon damage club."));
            //queen - -combat hat
            if ($item[very pointy crown].available_amount() == 0 && my_path_id() != PATH_G_LOVER)
                fight_descriptions.listAppend(listMake("Queen", "-combat, +5 adventures, +50% moxie, +5 moxie stats/fight hat.|Queen is exceptionally difficult to defeat, probably requiring deleveling via items" + ($skill[tricky knifework].have_skill() ? ", or maybe knife tricks" : "") + "."));
            //witch - myst broom
            if ((my_path_id() == PATH_COMMUNITY_SERVICE || my_primestat() == $stat[mysticality]) && $item[battle broom].available_amount() == 0)
                fight_descriptions.listAppend(listMake("Witch", "+5 myst stats/fight, +50% myst, +100% spell damage accessory.|Immune to spells, but not skills."));
        }
        //knight - epic food, +meat drop
        if (__misc_state["can eat just about anything"])
        {
            fight_descriptions.listAppend(listMake("Knight", "+100% meat epic food."));
        }
        //bishop - epic drink, +50% item
        if (__misc_state["can drink just about anything"] && my_path_id() != PATH_G_LOVER)
        {
            fight_descriptions.listAppend(listMake("Bishop", "+50% item epic drink."));
        }
        
        if (fight_descriptions.count() > 0)
        {
            //Bold the piece names:
            foreach key in fight_descriptions
            {
                fight_descriptions[key][0] = HTMLGenerateSpanOfClass(fight_descriptions[key][0], "r_bold");
            }
            description.listAppend(HTMLGenerateSimpleTableLines(fight_descriptions));
        }
        
        image_name = "__itemsize __monster Witchess Pawn";
        //subentries.listAppend(ChecklistSubentryMake(pluralise(fights_remaining, "witchess fight", "witchess fights"), "", description));
        resource_entries.listAppend(ChecklistEntryMake(524, image_name, "campground.php?action=witchess", ChecklistSubentryMake(pluralise(fights_remaining, "witchess fight", "witchess fights"), "", description)).ChecklistEntryTag("daily free fight"));
    }
    if (!get_property_boolean("_witchessBuff") && !__misc_state["familiars temporarily blocked"] && $effect[puzzle champ].effect_is_usable())
    {
        int familiar_weight_modifier = MAX(5, get_property_int("puzzleChampBonus"));
        if (image_name == "")
            image_name = "__effect Puzzle Champ";
        //subentries.listAppend(ChecklistSubentryMake("Witchess buff", "", "+" + familiar_weight_modifier + " familiar weight. (25 turns)"));
        resource_entries.listAppend(ChecklistEntryMake(525, image_name, "campground.php?action=witchess", ChecklistSubentryMake("Witchess buff", "", "+" + familiar_weight_modifier + " familiar weight. (25 turns)"), 4).ChecklistEntrySetCategory("buff"));
        //resource_entries.listAppend(ChecklistEntryMake(526, "__effect Puzzle Champ", "campground.php?action=witchess", ChecklistSubentryMake("Witchess buff", "", "+" + familiar_weight_modifier + " familiar weight. (25 turns)"), 4));
    }
    if (subentries.count() > 0)
        resource_entries.listAppend(ChecklistEntryMake(527, image_name, "campground.php?action=witchess", subentries, 4));
}

RegisterResourceGenerationFunction("IOTMClanFloundryGenerateResource");
void IOTMClanFloundryGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__misc_state["VIP available"] || !$item[Clan Floundry].is_unrestricted())
        return;
    if (!__misc_state["in run"])
        return;
    if (my_path_id() == PATH_G_LOVER)
    	return;
    
    //if (get_property_boolean("_floundryFabricated"))
        //return;
    foreach it in $items[bass clarinet,fish hatchet,carpe,codpiece,troutsers,tunac]
    {
        if (it.available_amount() > 0)
            return;
        if (it == $item[none])
            return;
    }
    
    string [int] description;
    
    string [int][int] equipment;
    if (__misc_state["can equip just about any weapon"])
    {
        //Bass clarinet: -10% combat, 1h ranged weapon, +100% moxie, -3 MP skill cost, +50 ranged damage, 10 white pixels
        string line = "-10% combat, +100% moxie, -3 MP skill cost, +50 ranged damage";
        if (!__quest_state["Level 13"].state_boolean["digital key used"] && ($item[digital key].available_amount() + creatable_amount($item[digital key])) == 0)
            line += ", 10 white pixels";
        equipment.listAppend(listMake("Bass clarinet", "ranged weapon", line));
        //Fish hatchet: -10% combat, 1h axe, +100% muscle, +5 familiar weight, +50 weapon damage, +5 bridge progress
        line = "-10% combat, +100% muscle, +5 familiar weight, +50 weapon damage";
        if (!__quest_state["Level 9"].state_boolean["bridge complete"])
            line += ", +5 bridge progress";
        equipment.listAppend(listMake("Fish hatchet", "weapon", line));
    }
    //Codpiece: acc, -?% combat, +100% myst, +100 max MP, +50 spell damage, 8 bubblin' crudes
    equipment.listAppend(listMake("Codpiece", "acc", "-10% combat, +100% myst, +100 max MP, +50 spell damage" + (can_interact() ? "" : ", 8 bubblin' crudes")));
    //Carpe: back, +combat, +50% myst, regen ~8 MP, +50% meat
    equipment.listAppend(listMake("Carpe", "back", "+combat, +50% meat, +50% myst, regen ~8 MP"));
    //Tunac tunac tun: +combat, shirt, +50% muscle, +25 ML, +25% item
    if (__misc_state["Torso aware"])
    {
        equipment.listAppend(listMake("Tunac", "shirt", "+combat, +25 ML, +25% item, +50% muscle"));
    }
    //Troutsers: pants, +50% moxie, +50% pickpocket, +5 all res, +11 prismatic damage
    equipment.listAppend(listMake("Troutsers", " pants", "+50% moxie, +50% pickpocket, +5 all res, +11 prismatic damage"));
    description.listAppend(HTMLGenerateSimpleTableLines(equipment));
    
    
    resource_entries.listAppend(ChecklistEntryMake(499, "__item fishy fish", "clan_viplounge.php?action=floundry", ChecklistSubentryMake("Rentable floundry equipment", "", description), 8));
}
RegisterTaskGenerationFunction("IOTMIntergnatGenerateTasks");
void IOTMIntergnatGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    
    if (!get_property_boolean("demonSummoned") && __misc_state["in run"] && !__quest_state["Level 13"].state_boolean["king waiting to be freed"] && $familiar[intergnat].familiar_is_usable() && my_path_id() != PATH_AVATAR_OF_SNEAKY_PETE)
    {
        //Should we show this if they aren't using the intergnat? ... Yes?
        //demonName12, thin black candle, scroll of ancient forbidden unspeakable evil
        string [int] reasons;
        if (!get_property("demonName12").contains_text("Neil ") && my_level() < 13) //13 is +50% init... it's kind of useful? But not worth mentioning if they don't have it by this point?
        {
            reasons.listAppend("learn demon name");
        }
        if ($item[thin black candle].available_amount() < 3)
        {
            if ($item[thin black candle].available_amount() < 2)
                reasons.listAppend("collect " + int_to_wordy(3 - $item[thin black candle].available_amount()) + " more thin black candles");
            else
                reasons.listAppend("collect One More Thin black candle");
        }
        if ($item[scroll of ancient forbidden unspeakable evil].available_amount() == 0)
        {
            reasons.listAppend("collect a scroll of ancient forbidden unspeakable evil");
        }
        if (reasons.count() > 0)
        {
            string [int] description;
            description.listAppend(reasons.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            string url = "";
            string title = "Continue running Intergnat for demon summon";
            if (my_familiar() != $familiar[intergnat])
            {
                url = "familiar.php";
                title = "Possibly run Intergnat for demon summon";
            }
            //Don't use the intergnat icon, because animation is distracting:
            optional_task_entries.listAppend(ChecklistEntryMake(505, "__item thin black candle", url, ChecklistSubentryMake(title, "", description)));
        }
    }
}

RegisterResourceGenerationFunction("IOTMIntergnatGenerateResource");
void IOTMIntergnatGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[infinite BACON machine].available_amount() > 0 && !get_property_boolean("_baconMachineUsed"))
    {
        //suggest using it:
        resource_entries.listAppend(ChecklistEntryMake(506, "__item infinite BACON machine", "inventory.php?which=3", ChecklistSubentryMake("Infinite BACON machine", "", "100 BACON/day."), 7));
    }
    if ($item[daily dungeon malware].available_amount() > 0 && __misc_state_int["fat loot tokens needed"] > 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(507, "__item daily dungeon malware", "da.php", ChecklistSubentryMake("Daily dungeon malware", "", "Use on a daily dungeon monster to gain a fat loot token."), 7));
    }
    int bacon_amount = $item[BACON].available_amount();
    if (__misc_state["in run"] && bacon_amount > 0 && in_ronin())
    {
        /*
        Viral video - YR if they don't have one.
        Print screen button - Copy, kind of unlimited use.
        Daily dungeon malware - It seems very expensive for what it does, but, we could suggest it?
        
        Gallon of milk - food, though not amazing. The debuff causes issues, but mostly just for the alcove.
        */
        coinmaster meme_shop = "Internet Meme Shop".to_coinmaster();
        if (meme_shop != $coinmaster[none])
        {
            string [item] bacon_description;
            if (!__misc_state["yellow ray available"] & $effect[everything looks yellow].have_effect() == 0 && my_path_id() != PATH_G_LOVER)
                bacon_description[$item[Viral video]] = "yellow ray";
            if (my_path_id() != PATH_G_LOVER)
	            bacon_description[$item[print screen button]] = "copies a monster";
            if (__misc_state_int["fat loot tokens needed"] > 0)
                bacon_description[$item[daily dungeon malware]] = "expensive DD token source";
            if (availableFullness() >= 15)
                bacon_description[$item[gallon of milk]] = "lazy/expensive food source. Incurs a debuff";
            
            string [int][int] table;
            foreach it, item_description in bacon_description
            {
                int bacon_cost = meme_shop.sell_price(it);
                string [int] line;
                line.listAppend(it.capitaliseFirstLetter());
                line.listAppend(bacon_cost);
                line.listAppend(item_description.capitaliseFirstLetter() + ".");
                if (bacon_cost > bacon_amount)
                {
                    foreach key in line
                    {
                        line[key] = HTMLGenerateSpanFont(line[key], "grey");
                    }
                }
                table.listAppend(line);
            }
            if (table.count() > 0)
            {
                string [int] description;
                description.listAppend(HTMLGenerateSimpleTableLines(table));
                
                resource_entries.listAppend(ChecklistEntryMake(508, "__item BACON", "shop.php?whichshop=bacon", ChecklistSubentryMake(pluralise($item[BACON]), "", description), 7));
            }
        }
    }
}
void IOTMSourceTerminalGenerateDigitiseTargets(string [int] description)
{
    string [int] potential_targets;
    if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
        potential_targets.listAppend("lobsterfrogman");
    if (__quest_state["Level 7"].state_int["alcove evilness"] > 31)
        potential_targets.listAppend("modern zmobie");
    if (!__quest_state["Level 8"].state_boolean["Mountain climbed"] && $items[ninja rope,ninja carabiner,ninja crampons].available_amount() == 0 && !have_outfit_components("eXtreme Cold-Weather Gear"))
        potential_targets.listAppend("ninja assassin");
    //FIXME witchess bishop or knight
    if (__iotms_usable[$item[Witchess Set]] && get_property_int("_witchessFights") < 5)
    {
        string [int] witchess_list;
        if (__misc_state["can eat just about anything"])
            witchess_list.listAppend("knight");
        if (__misc_state["can drink just about anything"] && my_path_id() != PATH_G_LOVER)
            witchess_list.listAppend("bishop");
        if (my_path_id() != PATH_G_LOVER)
	        witchess_list.listAppend("rook");
        potential_targets.listAppend("witchess " + witchess_list.listJoinComponents("/"));
    }
    if (potential_targets.count() > 0)
        description.listAppend("Could target a " + potential_targets.listJoinComponents(", ", "or") + ".");
    if (get_property_int("_sourceTerminalDigitizeMonsterCount") >= 2)
        description.listAppend("Could re-digitise to reset the window.");
}

RegisterTaskGenerationFunction("IOTMSourceTerminalGenerateTasks");
void IOTMSourceTerminalGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (in_bad_moon() || get_campground()[$item[Source Terminal]] == 0 || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_ZOMBIE_SLAYER)
        return;
        
    string url = "campground.php?action=terminal";
    if (my_path_id() == PATH_NUCLEAR_AUTUMN)
        url = "place.php?whichplace=falloutshelter&action=vault_term";
    string image_name = "__item source essence";
        
    ChecklistSubentry [int] subentries;
    
    boolean [string] chips = getInstalledSourceTerminalSingleChips();
    //Learn extract/a skill if we don't have one:
    boolean [skill] skills_have = getActiveSourceTerminalSkills();
    int skill_limit = 1;
    if (chips["DRAM"])
        skill_limit = 2;
    int skills_need = skill_limit - skills_have.count();
    if (skills_need > 0 && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        //FIXME this could be rewritten to suggest turbo + compress, when we have enough extractions.
        string [int] possible_skills;
        if (!skills_have[$skill[Extract]])
            possible_skills.listAppend("Extract");
        if (!skills_have[$skill[Turbo]])
            possible_skills.listAppend("Turbo");
        
        string linker = "or";
        if (skills_need > 1)
            linker = "and";
        subentries.listAppend(ChecklistSubentryMake("Learn " + pluralise(skills_need, "skill", "skills"), "", "Maybe " + possible_skills.listJoinComponents(", ", linker) + "."));
    }
    
    //Set an enquiry:
    if (get_property("sourceTerminalEnquiry") == "" && my_path_id() != PATH_G_LOVER)
    {
        //familiar - +5 familiar weight
        //monsters - +25 ML (in-run)
        //protect - +3 all res (?)
        //stats - +all stats (in-run)
        string [int][int] enquiries;
        if (!__misc_state["familiars temporarily blocked"])
            enquiries.listAppend(listMake("familiar.enq", "+5 familiar weight"));
        if (__misc_state["in run"])
        {
            enquiries.listAppend(listMake("monsters.enq", "+25 ML"));
            enquiries.listAppend(listMake("stats.enq", "+100% stats"));
        }
        string [int] description;
        
        if (chips["DIAGRAM"] && get_property_int("sourceTerminalGram") >= 10)
            description.listAppend("200 turn buff gained at rollover.");
        else //gram chips are mysterious
            description.listAppend("Buff gained at rollover.");
        foreach key in enquiries
        {
            description.listAppend(enquiries[key][0] + ": " + enquiries[key][1]);
        }
        subentries.listAppend(ChecklistSubentryMake("Set an enquiry", "", description));
    }
    //"Digitise something" like arrow something?
    if (get_property_int("_sourceTerminalDigitizeUses") == 0 && __misc_state["in run"] && my_path_id() != PATH_ZOMBIE_SLAYER && my_path_id() != PATH_LIVE_ASCEND_REPEAT && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        string [int] description;
        IOTMSourceTerminalGenerateDigitiseTargets(description);
        subentries.listAppend(ChecklistSubentryMake("Digitise a monster", "", description));
    }
    //Complicated, since we have three uses, and those are sort of resources...
    //Maybe suggest the first use, and always list in resources for the rest.
    //"Upgrade your source terminal" suggestions? Chips, essentially.
    
    if (subentries.count() > 0)
        optional_task_entries.listAppend(ChecklistEntryMake(463, image_name, url, subentries, 5));
}






RegisterGenerationFunction("IOTMSourceTerminalGenerate");
void IOTMSourceTerminalGenerate(ChecklistCollection checklists)
{
    if (in_bad_moon() || get_campground()[$item[Source Terminal]] == 0 || my_path_id() == PATH_ACTUALLY_ED_THE_UNDYING || my_path_id() == PATH_ZOMBIE_SLAYER)
        return;
        
    
    string url = "campground.php?action=terminal";
    if (my_path_id() == PATH_NUCLEAR_AUTUMN)
        url = "place.php?whichplace=falloutshelter&action=vault_term";
    string image_name = "__item source terminal";
    int importance = 5;
    
    boolean [string] chips = getInstalledSourceTerminalSingleChips();
    //sourceTerminalChips, sourceTerminalPram, sourceTerminalGram, sourceTerminalSpam
    //ChecklistSubentry [int] subentries;
    //Enhancement buffs:
    int enhancement_limit = 1;
    if (chips["CRAM"]) //CRAM chip installed
        enhancement_limit += 1;
    if (chips["SCRAM"]) //SCRAM chip installed
        enhancement_limit += 1;
    int enhancements_remaining = clampi(enhancement_limit - get_property_int("_sourceTerminalEnhanceUses"), 0, enhancement_limit);
    if (enhancements_remaining > 0)
    {
        int turn_duration = 25; //up to 100
        if (chips["INGRAM"])
            turn_duration += 25;
        turn_duration += get_property_int("sourceTerminalPram") * 5;
        turn_duration = clampi(turn_duration, 25, 100);
        string turns_description = " (" + turn_duration + " turns)";
        string [int] description;
        if (my_path_id() != PATH_G_LOVER)
	        description.listAppend("items.enh: +30% item." + turns_description);
        if (my_path_id() != PATH_G_LOVER)
	        description.listAppend("meat.enh: +60% meat." + turns_description);
        if (__misc_state["in run"] && my_path_id() != PATH_G_LOVER)
            description.listAppend("init.enh: +50% init." + turns_description);
        if (my_path_id() == PATH_G_LOVER)
            description.listAppend("damage.enh: +5 prismatic damage, only usable buff in this path." + turns_description);
        //the others are moderately boring
        //+critical hit? niche
        //+all elemental damage? useful in two places, but still niche enough to not be put here
        //substats.enh is probably less than 150 mainstat. that's not a lot... +item is much more useful
        checklists.add(C_RESOURCES, ChecklistEntryMake(464, image_name, url, ChecklistSubentryMake(pluralise(enhancements_remaining, "source enhancement", "source enhancements") + " remaining", "", description), importance).ChecklistEntryTag("source terminal").ChecklistEntrySetSpecificImage("__item Fitspiration&trade; poster").ChecklistEntrySetCategory("buff"));
    }
    
	int total_duplicate_uses_available = 1;
	if (my_path_id() == PATH_THE_SOURCE)
		total_duplicate_uses_available = 5;
	int duplicate_uses_remaining = clampi(total_duplicate_uses_available - get_property_int("_sourceTerminalDuplicateUses"), 0, total_duplicate_uses_available);
    if (my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_POCKET_FAMILIARS)
        duplicate_uses_remaining = 0;
    if (duplicate_uses_remaining > 0 && __misc_state["in run"] && my_path_id() != PATH_G_LOVER)
    {
        //Duplication of a monster:
        string [int] description;
        boolean [skill] skills_have = getActiveSourceTerminalSkills();
        
        string line = "Doubles";
        if (my_path_id() == PATH_THE_SOURCE)
            line = "Triples";
        string times = "once/day";
        if (total_duplicate_uses_available > 1)
            times = total_duplicate_uses_available.int_to_wordy() + " times/day";
        line += " item drops from a monster, " + times + ".|Makes them stronger, so be careful.";
        description.listAppend(line);
        if (!skills_have[$skill[Duplicate]])
        {
            description.listAppend("Learn with command \"educate duplicate.edu\".");
        }
        
        string [int] potential_targets;
        //FIXME grey out if the area isn't available?
        if ($item[goat cheese].available_amount() < 2 && !__quest_state["Level 8"].state_boolean["Past mine"])
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("dairy goat", $location[the goatlet]));
        if (!__quest_state["Level 11"].finished && !__quest_state["Level 11 Palindome"].finished && $item[talisman o' namsilat].available_amount() == 0 && $items[gaudy key,snakehead charrrm].available_amount() < 2)
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("gaudy pirate", $location[belowdecks]));
        if (my_path_id() == PATH_THE_SOURCE)
        {
            //5x copies
            //LFM, filthworms, evil eyes, tomb rats?, star monsters, Green Ops Soldier?
            //FIXME actually test for these
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("lobsterfrogman", $location[sonofa beach]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("filthworms", $location[the hatching chamber]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("defiled nook?", $location[the defiled nook]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("tomb rats?", $location[the middle chamber]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("hedge trimmers", $location[twin peak]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("hole-in-the-sky monsters", $location[the hole in the sky]));
            potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("green ops soldier", $location[the battlefield (frat uniform)]));
            if (in_hardcore())
                potential_targets.listAppend(HTMLGenerateFutureTextByLocationAvailability("bloopers?", $location[8-bit realm]));
            if (__iotms_usable[$item[Witchess Set]] && get_property_int("_witchessFights") < 5)
                potential_targets.listAppend("witchess bishop/knight/rooks?");
        }
        if (potential_targets.count() > 0)
            description.listAppend("Could use on a " + potential_targets.listJoinComponents(", ", "or") + ".");
        if ($item[exploding cigar].item_amount() > 0)
            description.listAppend("Use exploding cigar immediately after to win the fight.");
        string title = "Duplication castable";
        if (total_duplicate_uses_available > 1)
        {
            title = pluralise(duplicate_uses_remaining, "duplication", "duplications");
        }
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(465, image_name, url, ChecklistSubentryMake(title, "", description), importance).ChecklistEntryTag("source terminal").ChecklistEntrySetSpecificImage("__item Glenn's golden dice").ChecklistEntrySetCategory("combat skill"));
    }
    //Portscans: (the source)
    int portscans_remaining = clampi(3 - get_property_int("_sourceTerminalPortscanUses"), 0, 3);
    if (portscans_remaining > 0 && my_path_id() == PATH_THE_SOURCE)
    {
        //Should we suggest portscan outside of the source?
        //It's three scaling monsters a day, that can make one government potion/run, if optimally used in delay-burning areas. Otherwise, they're +turncount for no reason.
        //So, do we give advice that's easy to get wrong?
        
        string [int] description;
        description.listAppend("Cast to summon an agent next turn. Make sure to use it to burn delay.");
        if (my_path_id() == PATH_THE_SOURCE)
            description.listAppend("To use optimally, cast once. Then set your autoattack to portscan, and adventure in a delay-burning area.|This will chain the agents, causing them to cost a single turn.");
        if (get_property_int("sourceInterval") != 0 && my_path_id() == PATH_THE_SOURCE)
            description.listAppend("Wait a bit, this is better after an agent had just appeared.");
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(466, image_name, url, ChecklistSubentryMake(pluralise(portscans_remaining, "portscan", "portscans") + " remaining", "", description), importance).ChecklistEntryTag("source terminal").ChecklistEntrySetSpecificImage("__effect Jacked In").ChecklistEntrySetCategory("skill"));
        
    }
    //Extrudes:
    int extrudes_remaining = clampi(3 - get_property_int("_sourceTerminalExtrudes"), 0, 3);
    
    if (extrudes_remaining > 0 && my_path_id() != PATH_ZOMBIE_SLAYER && my_path_id() != PATH_POCKET_FAMILIARS && my_path_id() != PATH_G_LOVER)
    {
        int essence = $item[source essence].available_amount();
        string [int] description;
        if (__misc_state["can eat just about anything"] && my_path_id() != PATH_NUCLEAR_AUTUMN)
        {
            string line = "Food: 4 fullness epic.";
            if (essence < 10)
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);
        }
        if ((my_path_id() == PATH_LICENSE_TO_ADVENTURE || __misc_state["can drink just about anything"]) && my_path_id() != PATH_NUCLEAR_AUTUMN)
        {
            string line = "Drink: 4 inebriety epic.";
            if (__misc_state["in run"])
                line += " Useful nightcap.";
            if (essence < 10)
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);
        }
        if (!__misc_state["in run"])
        {
            //In aftercore, suggest chips we don't have. Also the shades.
            if ($item[source shades].available_amount() == 0 && essence >= 100)
                description.listAppend("Source Shades: extra essence extracted when equipped.");
            if (!$familiar[software bug].have_familiar() && essence >= 10000)
                description.listAppend("Software bug: pet rock.");
            string [int] chips_missing;
            foreach s in $strings[CRAM,DRAM,TRAM]
            {
                if (!chips[s])
                    chips_missing.listAppend(s);
            }
            if (get_property_int("sourceTerminalGram") < 10)
                chips_missing.listAppend("GRAM");
            if (get_property_int("sourceTerminalPram") < 10)
                chips_missing.listAppend("PRAM");
            if (get_property_int("sourceTerminalSpam") < 10)
                chips_missing.listAppend("SPAM");
            if (chips_missing.count() > 0)
                description.listAppend("Chip upgrades: " + chips_missing.listJoinComponents(", ", "or") + ".");
        }
        if (essence == 0 && __misc_state["in run"])
        {
            boolean have_extract_skill = true;
            if (!have_extract_skill)
                description.listAppend("Learn and use the extract skill in combat for more essence.");
            else
                description.listAppend("Use the extract skill in combat for more essence.");
        }
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(467, image_name, url, ChecklistSubentryMake(pluralise(extrudes_remaining, "source extrude", "source extrudes") + " remaining", "", description), importance).ChecklistEntryTag("source terminal").ChecklistEntrySetSpecificImage("__item browser cookie"));
    }
    //Digitise?
    int digitisations = get_property_int("_sourceTerminalDigitizeUses");
    int digitisation_limit = 1;
    if (chips["TRAM"])
        digitisation_limit += 1;
    if (chips["TRIGRAM"])
        digitisation_limit += 1;
    if (my_path_id() == PATH_ZOMBIE_SLAYER || my_path_id() == PATH_LIVE_ASCEND_REPEAT || my_path_id() == PATH_POCKET_FAMILIARS)
        digitisation_limit = 0;
    int digitisations_left = clampi(digitisation_limit - digitisations, 0, 3);
    if (digitisations_left > 0)
    {
        string [int] description;
        string monster_name = get_property("_sourceTerminalDigitizeMonster").to_lower_case();
        if (monster_name != "")
            description.listAppend("Currently set to " + monster_name + ".");
        IOTMSourceTerminalGenerateDigitiseTargets(description);
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(468, image_name, url, ChecklistSubentryMake(pluralise(digitisations_left, "digitisation", "digitisations") + " remaining", "", description), importance).ChecklistEntryTag("source terminal").ChecklistEntrySetSpecificImage("__item source essence").ChecklistEntrySetCategory("combat skill"));
    }
    //if (subentries.count() > 0)
        //resource_entries.listAppend(ChecklistEntryMake(469, image_name, url, subentries, 5));
}
RegisterTaskGenerationFunction("IOTMDetectiveSchoolGenerateTasks");
void IOTMDetectiveSchoolGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[detective school application]])
        return;
    
    //Should we always mention this in aftercore?
    //Hmm... I suppose.
    int cases_remaining = clampi(3 - get_property_int("_detectiveCasesCompleted"), 0, 3);
    if (cases_remaining > 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(530, "__item noir fedora", "place.php?whichplace=town_wrong&action=townwrong_precinct", ChecklistSubentryMake("Solve " + pluraliseWordy(cases_remaining, "more case", "more cases"), "", "Gives cop dollars."), 5));
    }
    if ($items[plastic detective badge,bronze detective badge,silver detective badge,gold detective badge].available_amount() == 0)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(531, "__item plastic detective badge", "place.php?whichplace=town_wrong&action=townwrong_precinct", ChecklistSubentryMake("Collect your Precinct badge", "", ""), 5));
        
    }
}

RegisterResourceGenerationFunction("IOTMDetectiveSchoolGenerateResource");
void IOTMDetectiveSchoolGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[detective school application]])
        return;
    
    //FIXME mention how much more they need to upgrade to the next badge?
    if (__misc_state["in run"] && in_ronin())
    {
        int cop_dollars_have = $item[cop dollar].available_amount();
        if (cop_dollars_have > 0)
        {
            string [int] description;
            
            string [int] buyables;
            
            string [int] ml_types_can_eat_drink;
            if (__misc_state["can eat just about anything"])
                ml_types_can_eat_drink.listAppend("food");
            if (__misc_state["can drink just about anything"])
                ml_types_can_eat_drink.listAppend("drink");
            if (ml_types_can_eat_drink.count() > 0 && cop_dollars_have >= 4)
                buyables.listAppend(ml_types_can_eat_drink.listJoinComponents("/"));
            if (cop_dollars_have >= 10)
            {
                buyables.listAppend("a -combat potion (50 turns)");
            }
            if (buyables.count() > 0)
                description.listAppend("Buy " + buyables.listJoinComponents(", ", "or") + ".");
            resource_entries.listAppend(ChecklistEntryMake(532, "__item cop dollar", "shop.php?whichshop=detective", ChecklistSubentryMake(pluralise($item[cop dollar]), "", description), 7));
        }
    }
}
//Extra data on monsters.
//We use the convention that $element[none] is physical.
record MonsterData
{
    //An example: Battlie Knight Ghost attack with both hot and physical.
    //Useful to know when calculating Shoot Ghost.
    boolean [element] basic_attack_elements;
    boolean is_protonic_ghost;
    float shoot_ghost_hp_attack_percentage;
};


static
{
    MonsterData [monster] __monster_data;
    
    void initialiseMonsterData()
    {
        foreach m in $monsters[]
        {
            MonsterData blank;
            __monster_data[m] = blank;
        }
        
        //Now, hardcoded:
        //Attack elements:
        __monster_data[$monster[Battlie Knight Ghost]].basic_attack_elements = $elements[hot, none];
        __monster_data[$monster[Claybender Sorcerer Ghost]].basic_attack_elements = $elements[spooky, none];
        __monster_data[$monster[Dusken Raider Ghost]].basic_attack_elements = $elements[sleaze,none];
        __monster_data[$monster[Space Tourist Explorer Ghost]].basic_attack_elements = $elements[sleaze,cold,hot,none];
        __monster_data[$monster[Whatsian Commando Ghost]].basic_attack_elements = $elements[sleaze,none];
        
        __monster_data[$monster[The ghost of Ebenoozer Screege]].basic_attack_elements = $elements[spooky];
        __monster_data[$monster[The ghost of Lord Montague Spookyraven]].basic_attack_elements = $elements[stench];
        __monster_data[$monster[The ghost of Waldo the Carpathian]].basic_attack_elements = $elements[hot];
        __monster_data[$monster[The Icewoman]].basic_attack_elements = $elements[cold];
        __monster_data[$monster[The ghost of Jim Unfortunato]].basic_attack_elements = $elements[sleaze];
        __monster_data[$monster[The ghost of Sam McGee]].basic_attack_elements = $elements[hot];
        __monster_data[$monster[Emily Koops\, a spooky lime]].basic_attack_elements = $elements[spooky];
        __monster_data[$monster[the ghost of Monsieur Baguelle]].basic_attack_elements = $elements[hot];
        __monster_data[$monster[The ghost of Vanillica "Trashblossom" Gorton]].basic_attack_elements = $elements[stench];
        __monster_data[$monster[the ghost of Oily McBindle]].basic_attack_elements = $elements[sleaze];
        __monster_data[$monster[boneless blobghost]].basic_attack_elements = $elements[spooky];
        __monster_data[$monster[The ghost of Richard Cockingham]].basic_attack_elements = $elements[spooky];
        __monster_data[$monster[The Headless Horseman]].basic_attack_elements = $elements[spooky];
        
        __monster_data[$monster[chalkdust wraith]].basic_attack_elements = $elements[none];
        __monster_data[$monster[plaid ghost]].basic_attack_elements = $elements[none,sleaze];
        
        //Protonic:
        foreach m in $monsters[The ghost of Ebenoozer Screege, Emily Koops\, a spooky lime, the ghost of Monsieur Baguelle, The ghost of Lord Montague Spookyraven, The ghost of Waldo the Carpathian, The Icewoman, The ghost of Jim Unfortunato, The ghost of Sam McGee, The ghost of Vanillica "Trashblossom" Gorton, the ghost of Oily McBindle, boneless blobghost, The ghost of Richard Cockingham, The Headless Horseman]
            __monster_data[m].is_protonic_ghost = true;
        //We think each protonic monster uses a different HP multiplier.
        //Emily and Jim, for instance, do way more damage than everyone else.
        //It starts at monster ID 1946, which has 40%, and counts up by 5%. So the actual formula is:
        //percentage = 0.05 * (monster_id - 1946) + 0.4
        __monster_data[$monster[boneless blobghost]].shoot_ghost_hp_attack_percentage = 0.45;
        __monster_data[$monster[the ghost of Monsieur Baguelle]].shoot_ghost_hp_attack_percentage = 0.5;
        __monster_data[$monster[The ghost of Ebenoozer Screege]].shoot_ghost_hp_attack_percentage = 0.65;
        __monster_data[$monster[The ghost of Vanillica "Trashblossom" Gorton]].shoot_ghost_hp_attack_percentage = 0.75;
        __monster_data[$monster[The ghost of Waldo the Carpathian]].shoot_ghost_hp_attack_percentage = 0.9;
        __monster_data[$monster[Emily Koops\, a spooky lime]].shoot_ghost_hp_attack_percentage = 0.95;
        
        //These are from historical logs:
        __monster_data[$monster[the ghost of Oily McBindle]].shoot_ghost_hp_attack_percentage = 0.4; //sleaze
        __monster_data[$monster[The Headless Horseman]].shoot_ghost_hp_attack_percentage = 0.55; //spooky
        __monster_data[$monster[The Icewoman]].shoot_ghost_hp_attack_percentage = 0.60; //cold
        __monster_data[$monster[The ghost of Lord Montague Spookyraven]].shoot_ghost_hp_attack_percentage = 0.70; //stench
        __monster_data[$monster[The ghost of Sam McGee]].shoot_ghost_hp_attack_percentage = 0.8; //hot
        __monster_data[$monster[The ghost of Richard Cockingham]].shoot_ghost_hp_attack_percentage = 0.85; //spooky
        __monster_data[$monster[The ghost of Jim Unfortunato]].shoot_ghost_hp_attack_percentage = 1.0; //sleaze
        
    }
    initialiseMonsterData();
}

//Calculations:
float expectedDamageFromGhostAfterCastingShootGhost(monster m)
{
    if (!m.attributes.contains_text("GHOST")) //no ghost
        return 0;
    /*
        Our guess for how shoot ghost works:
        After you cast it, the ghost will always hit you. It still uses its regular attacks, with corresponding elements, but always deals a percentage of your maximum HP as damage. Your resistances, DA, and DR apply, as per usual.
        Approximate full formula:
        damage = (maximum_hp * ghost_specific_multiplier - DR) * resistance * DA
        Each ghost has a specific multiplier. We're assuming non-protonic ghosts are 30%. But I've only checked a few. The protonic ones vary.
        Oh, and then the monster does 84 damage instead of 80 and you have nooo idea why and you get beaten up.
    */
    float percentage_multiplier = 0.3;
    if (__monster_data[m].is_protonic_ghost)
    {
        //Different ghosts have different multipliers:
        percentage_multiplier = 0.5;
        if (__monster_data[m].shoot_ghost_hp_attack_percentage != 0.0)
            percentage_multiplier = __monster_data[m].shoot_ghost_hp_attack_percentage;
    }
    float expected_damage = ceil(my_maxhp() * percentage_multiplier);
    //Apply DR, resistance, and DA, in that order:
    //We saw 2940 when we expected 2939. But then we saw 2939. So maybe these ceils do or do not happen. Or it's random rounding.
    //Same with expected 4119, obtained 4120 and 4119. Fixed that by switching the order of resistance and damage absorption. So maybe resistance is applied before DA, then rrounded at each step...?
    expected_damage = ceil(expected_damage - numeric_modifier("Damage Reduction"));
    //Umm... something to note: Battlie Knight Ghosts will attack with hot damage, even though they're spooky aligned.
    //Plus, they might just attack with physical damage.
    //So, we need to know what types of damage each ghost does.
    expected_damage = MAX(1, expected_damage);
    if (__monster_data[m].basic_attack_elements.count() > 0 && !(__monster_data[m].basic_attack_elements contains $element[none]))
    {
        //They do elemental attacks only. Probably a protonic ghost.
        float minimum_damage_seen = expected_damage;
        //Go through each element:
        foreach e in __monster_data[m].basic_attack_elements
        {
        	float resistance = numeric_modifier(e + " resistance");
            if (m == $monster[The ghost of Jim Unfortunato]) //this is a guess
            	resistance -= 2.0;
            if (m == $monster[The ghost of Waldo the Carpathian]) //this is a guess
                resistance -= 1.0;
            if (m == $monster[The ghost of Lord Montague Spookyraven]) //this is wrong, but I don't know what's correct
            	resistance -= 1.0;
            //FIXME suspect others are the same
            resistance = MAX(0, resistance);
            
            float resistance_percent = resistanceLevelToResistancePercent(resistance);//elemental_resistance(e);
            float damage = MAX(1, ceil(expected_damage * (1.0 - resistance_percent / 100.0)));
            if (damage < minimum_damage_seen)
                minimum_damage_seen = damage;
        }
        expected_damage = minimum_damage_seen;
    }
    expected_damage = ceil(expected_damage * (1.0 - damage_absorption_percent() / 100.0));
    return MAX(1, ceil(expected_damage));
}

RegisterTaskGenerationFunction("IOTMProtonicAcceleratorPackGenerateTasks");
void IOTMProtonicAcceleratorPackGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //Quest:
    if (QuestState("questPAGhost").in_progress || get_property("ghostLocation") != "")
    {
        int priority = 0;
        if (__misc_state["in run"])
            priority = -1;
        location ghost_location = get_property_location("ghostLocation");
        monster ghost = __protonic_monster_for_location[ghost_location];
        float ml_in_location = ghost_location.monster_level_adjustment_for_location();
        string title = "Defeat the ghost in " + ghost_location;
        string [int] description;
        string [int] modifiers;
        string url = ghost_location.getClickableURLForLocation();
        description.listAppend("Won't cost a turn.");
        if ($item[protonic accelerator pack].equipped_amount() > 0)
        {
            float expected_damage = ghost.expectedDamageFromGhostAfterCastingShootGhost();
            float hp_needed = expected_damage * 3;
            
            //FIXME initial hit damage
            //don't know if expected_damage() will be correct, it isn't always
            float initial_hit_damage = ghost.expected_damage();
            float elemental_ml_damage = 0.0;
            if (ml_in_location >= 26.0 && ghost.defense_element != $element[none])
            {
                //[Monster Attack] * MIN( ( [Bonus ML] - 25 ) / 500 , 1 / 2 )
                //FIXME range. 1.1?
                elemental_ml_damage = 1.1 * ghost.base_attack * min(0.5, (ml_in_location - 25.0) / 500.0);
                elemental_ml_damage *= 1.0 - elemental_resistance(ghost.defense_element) / 100.0;
                elemental_ml_damage = ceil(elemental_ml_damage);
            }
            hp_needed += elemental_ml_damage + initial_hit_damage;
            
            if (hp_needed >= my_maxhp())
            {
                description.listAppend(HTMLGenerateSpanFont("Do not cast \"shoot ghost\", you won't survive.", "red"));
                if (ml_in_location <= 50)
                    description.listAppend("Or stun the monster for multiple rounds, and cast \"shoot ghost\" three times, then \"trap ghost\".");
            }
            else if (hp_needed >= my_hp())
            {
                description.listAppend(HTMLGenerateSpanFont("Restore HP", "red") + " to cast \"shoot ghost\".");
                if (ml_in_location <= 50)
                    description.listAppend("Or stun the monster for multiple rounds, and cast \"shoot ghost\" three times, then \"trap ghost\".");
            }
            else
            {
                description.listAppend("Cast \"shoot ghost\" three times, then \"trap ghost\".");
            }
            description.listAppend("After casting \"shoot ghost\", the ghost will deal " + expected_damage.to_int() + " damage/round.");
        }
        item [int] items_to_equip;
        if ($item[protonic accelerator pack].equipped_amount() == 0 && $item[protonic accelerator pack].available_amount() > 0)
        {
            //Strictly speaking, they don't need the pack equipped to fight the monster, but they won't be able to trap it and get the item.
            url = generateEquipmentLink($item[protonic accelerator pack]);
            items_to_equip.listAppend($item[protonic accelerator pack]);
        }
        if (ghost_location == $location[inside the palindome] && $item[Talisman o' Namsilat].equipped_amount() == 0)
        {
            if ($item[Talisman o' Namsilat].available_amount() == 0)
            {
                priority = 10;
                description.listAppend("Need Talisman o' Namsilat first.");
            }
            else
            {
                url = generateEquipmentLink($item[talisman o' namsilat]);
                items_to_equip.listAppend($item[talisman o' namsilat]);
            }
        }
        if (ghost_location == $location[the skeleton store] && !ghost_location.locationAvailable())
        {
            //bone with a price tag on it
            if (my_path_id() == PATH_NUCLEAR_AUTUMN)
            {
                if ($item[bone with a price tag on it].available_amount() > 0)
                {
                    url = "inventory.php?which=3"; //FIXME guess
                    description.listAppend("Use the bone with a price tag on it to unlock the store.");
                }
            }
            else
            {
                url = "shop.php?whichshop=meatsmith&action=talk";
                description.listAppend("Talk to the meatsmith and start his quest.");
            }
        }
        if (ghost_location == $location[The Overgrown Lot] && !ghost_location.locationAvailable())
        {
            //bone with a price tag on it
            if (my_path_id() == PATH_NUCLEAR_AUTUMN)
            {
                if ($item[map to a hidden booze cache].available_amount() > 0)
                {
                    url = "inventory.php?which=3"; //FIXME guess
                    description.listAppend("Use the map to a hidden booze cache to unlock the store.");
                }
            }
            else
            {
                url = "shop.php?whichshop=doc&action=talk";
                description.listAppend("Talk to Doc Galaktik and start his quest.");
            }
        }
        if (ghost_location == $location[Madness Bakery] && !ghost_location.locationAvailable())
        {
            //bone with a price tag on it
            if (my_path_id() == PATH_NUCLEAR_AUTUMN)
            {
                if ($item[hypnotic breadcrumbs].available_amount() > 0)
                {
                    url = "inventory.php?which=3"; //FIXME guess
                    description.listAppend("Use the hypnotic breadcrumbs to unlock the store.");
                }
            }
            else
            {
                url = "shop.php?whichshop=armory&action=talk";
                description.listAppend("Talk to Armorer and start his quest.");
            }
        }
        
        if (items_to_equip.count() > 0)
            description.listAppend("Equip the " + items_to_equip.listJoinComponents(", ", "and") + " first.");
        
        element [location] elements_to_resist;
        elements_to_resist[$location[Cobb's Knob Treasury]] = $element[spooky];
        elements_to_resist[$location[The Haunted Conservatory]] = $element[stench];
        elements_to_resist[$location[The Haunted Gallery]] = $element[hot];
        elements_to_resist[$location[The Haunted Kitchen]] = $element[cold];
        elements_to_resist[$location[The Haunted Wine Cellar]] = $element[sleaze];
        elements_to_resist[$location[The Icy Peak]] = $element[hot];
        elements_to_resist[$location[Inside the Palindome]] = $element[spooky];
        elements_to_resist[$location[Madness Bakery]] = $element[hot];
        elements_to_resist[$location[The Old Landfill]] = $element[stench];
        elements_to_resist[$location[The Overgrown Lot]] = $element[sleaze];
        elements_to_resist[$location[The Skeleton Store]] = $element[spooky];
        elements_to_resist[$location[The Smut Orc Logging Camp]] = $element[spooky];
        elements_to_resist[$location[The Spooky Forest]] = $element[spooky];
        
        if (elements_to_resist contains ghost_location)
            modifiers.listAppend(HTMLGenerateSpanOfClass("+" + elements_to_resist[ghost_location] + " resist", "r_element_" + elements_to_resist[ghost_location]));
            
        if (ghost_location != $location[none])
            optional_task_entries.listAppend(ChecklistEntryMake(558, "__item protonic accelerator pack", url, ChecklistSubentryMake(title, modifiers, description), priority));
    }
}


RegisterResourceGenerationFunction("IOTMProtonicAcceleratorPackGenerateResource");
void IOTMProtonicAcceleratorPackGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[protonic accelerator pack].available_amount() == 0)
        return;
    
    if (!get_property_boolean("_streamsCrossed") &&__misc_state["in run"] && my_path_id() != PATH_G_LOVER)
    {
        string [int] description;
        string url = "showplayer.php?who=2807390"; //ProtonicBot is a real bot that will steal your turtle mechs at the first sign of defiance.
        description.listAppend("+20% stats for 10 turns.");
        if ($item[protonic accelerator pack].equipped_amount() == 0)
        {
            url = generateEquipmentLink($item[protonic accelerator pack]);
            description.listAppend("Equip the protonic accelerator pack first.");
        }
        resource_entries.listAppend(ChecklistEntryMake(559, "__item protonic accelerator pack", url, ChecklistSubentryMake("Stream crossing", "", description), 8).ChecklistEntrySetCategory("buff"));
    }
}
RegisterResourceGenerationFunction("IOTMTimeSpinnerGenerateResource");
void IOTMTimeSpinnerGenerateResource(ChecklistEntry [int] resource_entries)
{
    //Warn about eating if they're low on turns - you can't use the time spinner when you're out of adventures.
    if ($item[Time-Spinner].available_amount() == 0)
        return;
    if (my_path_id() == PATH_G_LOVER)
    	return;
    int minutes_left = clampi(10 - get_property_int("_timeSpinnerMinutesUsed"), 0, 10);
    if (minutes_left <= 0)
        return;
    
    string [int] description;
    
    if (minutes_left >= 3)
    {
        //Recent fight - 3 minutes - fight something past. Umm... hmm... same as any monster you copy? Though with restrictions. Plus olfaction-lite in NA.
        int amount = minutes_left / 3;
        description.listAppend(HTMLGenerateSpanOfClass(pluralise(amount, "recent fight", "recent fights"), "r_bold") + ": Re-fight a monster this ascension.");
        //Delicious meal - 3 minutes
        if (__misc_state["can eat just about anything"] && availableFullness() > 0)
        {
            description.listAppend(HTMLGenerateSpanOfClass(pluralise(amount, "meal", "meals"), "r_bold") + ": Re-eat something else today.");
        }
    }
    //Way back in time - 1 minute, stats, costs a turn(?)
    if (minutes_left >= 2)
    {
        //Visit the far future - 2 minutes, star-trek mini-game, lets you replicate things. Script fodder.
        if (!get_property_boolean("_timeSpinnerReplicatorUsed"))
        {
            string [int] options;
            if (__misc_state["can eat just about anything"] && availableFullness() > 0)
                options.listAppend("epic food");
            if (__misc_state["can drink just about anything"] && availableDrunkenness() > 0)
                options.listAppend("drink");
            if (!in_ronin())
                options.listAppend("something to sell");
            if (my_path_id() == PATH_GELATINOUS_NOOB && !$skill[Pathological Greed].have_skill() && $item[shot of Kardashian Gin].available_amount() == 0)
            {
                options.listAppend("Kardashian Gin for +meat skill");
            }
            if (options.count() == 0)
                options.listAppend("item");
            description.listAppend(HTMLGenerateSpanOfClass("Future", "r_bold") + ": once/day " + options.listJoinComponents(" / ") + ".");
        }
    }
    //Play a time prank - 1 minute, heart
    
    resource_entries.listAppend(ChecklistEntryMake(579, "Hourglass", "inv_use.php?whichitem=9104&pwd=" + my_hash(), ChecklistSubentryMake(pluralise(minutes_left, "Time-Spinner minute", "Time-Spinner minutes"), "", description), 4).ChecklistEntrySetCategory("equipment"));
}
RegisterResourceGenerationFunction("IOTMThanksgardenGenerateResource");
void IOTMThanksgardenGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__misc_state["in run"])
        return;
    
    item turkey_blaster = $item[turkey blaster];
    item stuffing_fluffer = $item[stuffing fluffer];
    item cashew = $item[cashew];
    item cornucopia = $item[cornucopia];
    
    ChecklistSubentry [int] subentries;
    string url;
    string image_name;
    
    
    
    if (cornucopia.available_amount() > 0 && in_ronin())
    {
        string [int] description;
        description.listAppend("Open for thanksgarden food.");
        if (image_name == "")
            image_name = "__item cornucopia";
        if (url == "")
            url = "inventory.php?which=3";
        subentries.listAppend(ChecklistSubentryMake(pluralise(cornucopia), "", description));
    }
    int cashew_amount = cashew.available_amount();
    if (cashew_amount > 0 && in_ronin())
    {
        string [int] description;
        string [int] options;
        //so creatable_amount() is weird, so we perform the calculation ourselves
        /*
        > ash $item[cashew].available_amount()

        Returned: 13

        > ash $item[turkey blaster].creatable_amount()

        Returned: 0
        */
        if (my_path_id() != PATH_NUCLEAR_AUTUMN && spleen_limit() > 0 && $item[cashew].available_amount() >= 3)
            options.listAppend(HTMLGreyOutTextUnlessTrue(pluralise($item[cashew].available_amount() / 3, $item[turkey blaster]) + " to burn delay", cashew_amount >= 3));
        if (!__quest_state["Level 12"].finished)
            options.listAppend(HTMLGreyOutTextUnlessTrue(pluralise($item[cashew].available_amount() / 3, $item[stuffing fluffer]) + " for the war", cashew_amount >= 3));
        if (my_path_id() != PATH_NUCLEAR_AUTUMN && fullness_limit() > 0)
            options.listAppend("various foods");
        if (__quest_state["Level 7"].state_boolean["alcove needs speed tricks"] && $item[gravy boat].available_amount() == 0)
            options.listAppend(HTMLGreyOutTextUnlessTrue("gravy boat for the cyrpt (somewhat marginal)", cashew_amount >= 3));
        if (options.count() > 0)
            description.listAppend("Could make into " + options.listJoinComponents(", ", "or") + ".");
        
        string [int] foods_we_can_make;
        
        if (image_name == "")
            image_name = "__item cashew";
        if (url == "")
            url = "shop.php?whichshop=thankshop";
        subentries.listAppend(ChecklistSubentryMake(pluralise(cashew), "", description));
    }
    
    if (turkey_blaster.available_amount() > 0 && my_path_id() != PATH_NUCLEAR_AUTUMN)
    {
        string [int] description;
        int uses_left = clampi(3 - get_property_int("_turkeyBlastersUsed"), 0, 3);
        int pre_spleen_uses_left = uses_left;
        uses_left = MIN(uses_left, availableSpleen() / 2);
        
        string [int] delay_areas;
        foreach l in $locations[the outskirts of cobb's knob,the spooky forest,The Castle in the Clouds in the Sky (Ground Floor),the haunted gallery,the haunted bathroom,the haunted ballroom,the boss bat's lair]
        {
            if (l.delayRemainingInLocation() > 1)
                delay_areas.listAppend(l);
        }
        
        description.listAppend("Will burn five turns of delay in the last area you've adventured.");
        if (delay_areas.count() > 0)
            description.listAppend("Suggested areas:|*" + delay_areas.listJoinComponents(", ", "and") + ".");
        if (uses_left == 0)
        {
            if (pre_spleen_uses_left > 0)
                description.listAppend("Cannot use any more today; no spleen room.");
            else
                description.listAppend("Cannot use any more today.");
        }
        else
            description.listAppend("Can use " + pluraliseWordy(uses_left, "more time", "more times") + " today.");
        
        
        if (image_name == "")
            image_name = "__item turkey blaster";
        if (url == "")
            url = "inventory.php?which=1";
        subentries.listAppend(ChecklistSubentryMake(pluralise(turkey_blaster), "", description));
    }
    if (!__quest_state["Level 12"].finished && __quest_state["Level 12"].state_int["frat boys left on battlefield"] > 0 && __quest_state["Level 12"].state_int["hippies left on battlefield"] > 0 && stuffing_fluffer.available_amount() > 0)
    {
        string [int] description;
        description.listAppend("Clears out level twelve armies. Use before adventuring on the battlefield.");
        
        if (image_name == "")
            image_name = "__item stuffing fluffer";
        if (url == "")
            url = "inventory.php?which=3";
        subentries.listAppend(ChecklistSubentryMake(pluralise(stuffing_fluffer), "", description));
    }
    
    
    if (subentries.count() > 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(550, image_name, url, subentries, 4));
    }
    
}

RegisterTaskGenerationFunction("IOTMThanksgardenGenerateTasks");
void IOTMThanksgardenGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    int delay_limit = 4;
    if (get_property_int("_turkeyBlastersUsed") < 3 && availableSpleen() >= 2 && $item[turkey blaster].available_amount() + $item[turkey blaster].creatable_amount() > 0 && get_property_location("lastAdventure").delayRemainingInLocation() >= delay_limit)
    {
        string url = "";
        if ($item[turkey blaster].available_amount() > 0)
            url = "inventory.php?which=1";
        else
            url = "shop.php?whichshop=thankshop";
        location last_location = get_property_location("lastAdventure");
        string [int] description;
        description.listAppend("Save " + MIN(5, last_location.delayRemainingInLocation()) + " turns in " + last_location + ".");
        if (my_level() < 4)
            description.listAppend("Reach level four first.");
        boolean allow = true;
        if ($locations[the penultimate fantasy airship,the hidden office building,the hidden apartment building] contains last_location)
            allow = false;
        if (allow)
            task_entries.listAppend(ChecklistEntryMake(551, "__item turkey blaster", url, ChecklistSubentryMake("Chew turkey blaster", "", description), -11));
    }
}
RegisterResourceGenerationFunction("IOTMGingerbreadCityGenerateResource");
void IOTMGingerbreadCityGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($skill[Ceci N'Est Pas Un Chapeau].have_skill() && !get_property_boolean("_ceciHatUsed") && my_basestat($stat[moxie]) >= 150 && __misc_state["in run"])
    {
        //Umm... I guess?
        //It doesn't seem amazing in aftercore, so we're not displaying it? Is that the right decision?
        //Almost all of its enchantments are better on other hats. And you can't choose which one you get, so it'd just be annoying the user.
        resource_entries.listAppend(ChecklistEntryMake(570, "__skill Ceci N'Est Pas Un Chapeau", "skillz.php", ChecklistSubentryMake("Ceci N'Est Pas Un Chapeau", "", "Random enchantment hat, 300MP."), 10));
    }
    
    if ($skill[Gingerbread Mob Hit].skill_is_usable())
    {
        if (!get_property_boolean("_gingerbreadMobHitUsed"))
        {
            string [int] description;
            description.listAppend("Combat skill, win a fight without taking a turn.");
            //FIXME replace with a better image
            resource_entries.listAppend(ChecklistEntryMake(571, "__familiar Penguin Goodfella", "", ChecklistSubentryMake("Gingerbread mob hit", "", description), 0).ChecklistEntryTag("free instakill"));
            
        }
    }
    
    //http://kol.coldfront.net/thekolwiki/index.php/A_GingerGuide_to_Gingerbread_City
    
    //Things to acquire/unlock:
    //Studying in the library, which lets you acquire the seven-day sugar raygun.
    //Unlocking various areas.
    //Chocolate puppy.
    //Moneybag
    //gingerbread pistol
    //chocolate pocketwatch
    //Two skills...?
    //Laying track (does this reset on ascension...?) for a briefcase with lots of sprinkles...?
    //Studying train schedules for ???
    //Gingerbread Best outfit components.
    //Um... candy crowbar -> breaking in? Do you ever do this in run? No, I think?
    //Counterfeit city to sell.
    //Gingerbread cigarette to sell.
    //Chocolate sculpture to sell.
    //Gingerbread gavel
    //More...?
    if ($locations[Gingerbread Industrial Zone,Gingerbread Train Station,Gingerbread Sewers,Gingerbread Upscale Retail District] contains __last_adventure_location)
    {
        //Show details:
        /*
        Unlocks:
            gingerAdvanceClockUnlocked
            gingerRetailUnlocked 
            gingerSewersUnlocked 
            gingerExtraAdventures - +10 adventures in area
        
        gingerSubwayLineUnlocked
        
        _gingerBiggerAlligators - a born liverpooler
        _gingerbreadMobHitUsed - used once/day free kill
        gingerNegativesDropped
        gingerTrainScheduleStudies - times studied the schedule
        gingerDigCount - times went digging at the train station
        gingerLawChoice - times studied law
        gingerMuscleChoice - times laid track
        */
        //There's no per-turn tracker for this area.
    }
}

RegisterTaskGenerationFunction("IOTMSpaceJellyfishGenerateTasks");
void IOTMSpaceJellyfishGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!$familiar[space jellyfish].familiar_is_usable())
        return;
    if (!get_property_boolean("_seaJellyHarvested") && my_level() >= 11 && !__misc_state["sea access blocked"])
    {
        string url = "place.php?whichplace=thesea&action=thesea_left2";
        string [int] description;
        if (!QuestState("questS01OldGuy").started)
        {
            url = "oldman.php";
            description.listAppend("Visit the old man first.");
        }
        else if (my_familiar() != $familiar[space jellyfish])
        {
            url = "familiar.php";
            description.listAppend("Bring along your space jellyfish first.");
        }
        description.listAppend("Once/day.");
        optional_task_entries.listAppend(ChecklistEntryMake(599, "__familiar space jellyfish", url, ChecklistSubentryMake("Harvest sea jelly", "", description)));
    }
}


RegisterResourceGenerationFunction("IOTMSpaceJellyfishGenerateResource");
void IOTMSpaceJellyfishGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$familiar[space jellyfish].familiar_is_usable())
        return;
    
    ChecklistEntry entry = ChecklistEntryMake(600);
	entry.url = "";
	entry.image_lookup_name = "__familiar space jellyfish";
    entry.importance_level = 5;
    
    //_spaceJellyfishDrops
    //_hotJellyUses
    if (my_familiar() != $familiar[space jellyfish])
    {
        entry.url = "familiar.php";
    }
    
    int [int] percent_chance_at_use = {
        0:100,
        1:50,
        2:33,
        3:25,
        4:20,
        5:5,
        6:5,
        7:5,
        8:5,
        9:5,
        10:5,
    	11:5,
        12:5,
        13:5,
        14:5,
    };
    //FIXME spade rest
    
    if (__misc_state["in run"] && spleen_limit() > 0)
    {
        /*
        hot - free run/banish
        spooky - YR with no cooldown
        stench - clara's bell, more or less
        
        The other two aren't too useful in-run.
        */
        if (get_property_int("_hotJellyUses") > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(601, "__item hot jelly", "", ChecklistSubentryMake(pluralise(get_property_int("_hotJellyUses"), "breathe out", "breathe outs"), "", "Cast Breathe Out. Free run/banish.")).ChecklistEntryTag("free banish"));
        }
        
        string [item] jelly_descriptions;
        //jelly_descriptions[$item[hot jelly]] = "Free run/banish.";
        jelly_descriptions[$item[spooky jelly]] = "YR with no cooldown.";
        jelly_descriptions[$item[stench jelly]] = "Forces non-combat.";
        foreach it, desc in jelly_descriptions
        {
            if (it.available_amount() > 0 && in_ronin())
            {
                entry.subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", desc));
            }
        }
        
        if ($item[hot jelly].available_amount() > 0 && in_ronin())
            resource_entries.listAppend(ChecklistEntryMake(602, "__item hot jelly", "", ChecklistSubentryMake(pluralise($item[hot jelly]), "", "Chew for free run/banish.")).ChecklistEntryTag("free banish"));
        
        
        
        int extractions = get_property_int("_spaceJellyfishDrops");
        string [int] description;
        string line = "Extract jelly against elemental monsters.";
        if (percent_chance_at_use contains extractions)
            line += "|" + percent_chance_at_use[extractions] + "% chance of success.";
        
        //Should we list common areas to find these?
        //Spooky is defiled alcove. Hot is the level six quest. Stench is level twelve, i.e. level never before you need it.
        line += "|*" + HTMLGenerateSpanOfClass("Stench", "r_bold r_element_stench_desaturated") + " - forces non-combat";
        if (!__quest_state["Level 12"].finished)
            line += " (try hippies)";
        line += "|*" + HTMLGenerateSpanOfClass("Spooky", "r_bold r_element_spooky_desaturated") + " - YR with no cooldown";
        if (!__quest_state["Level 7"].finished)
            line += " (try cyrpt)";
        line += "|*" + HTMLGenerateSpanOfClass("Hot", "r_bold r_element_hot_desaturated") + " - free run/banish";
        if (!__quest_state["Level 12"].finished)
            line += " (try friars)";
        description.listAppend(line);
        if (availableDrunkenness() >= 0)
            entry.subentries.listAppend(ChecklistSubentryMake(pluralise(extractions, "jelly extraction", "jelly extractions"), "", description));
    }
    
    
    if (entry.subentries.count() > 0)
        resource_entries.listAppend(entry);
}
RegisterTaskGenerationFunction("IOTMTunnelOfLoveGenerateTasks");
void IOTMTunnelOfLoveGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    //FIXME whatever these end up being named:
    if (!__iotms_usable[$item[heart-shaped crate]])
        return;
    if (get_property_boolean("_loveTunnelUsed"))
        return;
    
    string [int] description;
    //equipment: LOV Eardigan (+25% muscle exp, +25 ML), LOV Epaulettes (+25% myst exp), LOV Earrings (+25% moxie exp, +50% meat, +3 all res)
    //50-turn buffs: Lovebotamy (10 stats/fight), Open Heart Surgery (+10 familiar weight), Wandering Eye Surgery (+50% item)
    //item: boomerang (arrow), toy dart gun (???), chocolate (adventures), flowers (???), elephant (???), TOAST! (toasty!)
    
    description.listAppend("Three free fights. Attack, spell, and pickpocket respectively for elixirs.");
    if (my_path_id() == PATH_GELATINOUS_NOOB)
        description.listAppend("Equipment choice unimportant.");
    else
    {
    	string [int] equipment_choices;
        equipment_choices.listAppend(HTMLBoldIfTrue("Eardigan", my_primestat() == $stat[muscle] && __misc_state["in run"] && my_level() < 13) + " (+25% muscle exp, +25 ML)");
        if (my_path_id() != PATH_G_LOVER)
	        equipment_choices.listAppend(HTMLBoldIfTrue("Epaulettes", my_primestat() == $stat[mysticality] && __misc_state["in run"] && my_level() < 13) + " (+25% myst exp)");
        equipment_choices.listAppend(HTMLBoldIfTrue("Earrings", (my_primestat() == $stat[moxie] && __misc_state["in run"] && my_level() < 13) || __misc_state["in aftercore"] || my_level() >= 13) + " (+25% moxie exp, +50% meat, +3 all res)");
        description.listAppend("Equipment choice:|*" + equipment_choices.listJoinComponents(", ", "or"));
    }
    string [int] buff_choices;
    if (my_path_id() != PATH_G_LOVER)
    	buff_choices.listAppend("+10 stats/fight");
    buff_choices.listAppend("+10 familiar weight");
    buff_choices.listAppend("+50% item");
    description.listAppend("Buff choice: (50 turns)|*" + buff_choices.listJoinComponents(", ", "or"));
    
    string [int] usable_items;
    if (my_path_id() != PATH_LIVE_ASCEND_REPEAT)
        usable_items.listAppend("single-use wandering copier");
    usable_items.listAppend("chat hearts");
    if (my_path_id() != PATH_SLOW_AND_STEADY && my_path_id() != PATH_G_LOVER)
        usable_items.listAppend("chocolate (adventures)");
    if ($familiar[space jellyfish].familiar_is_usable())
        usable_items.listAppend("toast");
    description.listAppend("Item choice:|*" + usable_items.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
    
    optional_task_entries.listAppend(ChecklistEntryMake(580, "__item pink candy heart", "place.php?whichplace=town_wrong", ChecklistSubentryMake("Take a love trip", "", description)));
}

RegisterResourceGenerationFunction("IOTMTunnelOfLoveGenerateResource");
void IOTMTunnelOfLoveGenerateResource(ChecklistEntry [int] resource_entries)
{
    //mostly the boomerang
    //what does sokka throw? a boomeraang!
    
    if (__misc_state["in run"] && in_ronin())
    {
        /*item enamorang = $item[LOV Enamorang];
        if (enamorang.available_amount() > 0)
        {
            resource_entries.listAppend(ChecklistEntryMake(581, "__item LOV Enamorang", "", ChecklistSubentryMake(pluralise(enamorang), "", "Copies the monster once as an arrow."), 5));
            
        }*/
        item chocolate = $item[LOV Extraterrestrial Chocolate];
        if (chocolate.available_amount() > 0 && my_path_id() != PATH_SLOW_AND_STEADY)
        {
            //FIXME list other chocolates?
            resource_entries.listAppend(ChecklistEntryMake(582, "__item LOV Extraterrestrial Chocolate", "", ChecklistSubentryMake(pluralise(chocolate), "", "Adventures!"), 5));
            
        }
    }
}

RegisterResourceGenerationFunction("IOTMSpacegateGenerateResource");
void IOTMSpacegateGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[Spacegate access badge]])
        return;
    if (!get_property_boolean("_spacegateVaccine") && my_path_id() != PATH_G_LOVER)
    {
        boolean rainbow_unlocked = get_property_boolean("spacegateVaccine1"); //+3 all res
        boolean broad_spectrum_unlocked = get_property_boolean("spacegateVaccine2"); //+50% all stats
        boolean emotional_unlocked = get_property_boolean("spacegateVaccine3"); //+30 ML
        
        string [int] options;
        if (emotional_unlocked)
            options.listAppend("+30 ML");
        if (broad_spectrum_unlocked)
            options.listAppend("+50% stats");
        if (rainbow_unlocked)
            options.listAppend("+3 all res");
        
        boolean missing_one = !rainbow_unlocked || !broad_spectrum_unlocked || !emotional_unlocked;
        if (missing_one && $item[spacegate research].available_amount() > 0)
            options.listAppend("unlock additional vaccines");
        if (options.count() > 0)
        {
            string [int] description;
            description.listAppend("30 turns, once/day.|" + options.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
            
            resource_entries.listAppend(ChecklistEntryMake(603, "__item plus sign", "place.php?whichplace=spacegate&action=sg_vaccinator", ChecklistSubentryMake("Vaccination", "", description), 8).ChecklistEntrySetCategory("buff"));
        }
    }
    if (__misc_state["in run"] && my_primestat() == $stat[moxie] && __misc_state["need to level"] && get_property("_spacegatePlanetName") == "")
    {
        //Dial TFHSXKK:
        string [int] description;
        description.listAppend("Dial TFHSXKK, and skip every adventure until you reach Paradise Under a Strange Sun.|Will give 1000 stats and cost a turn. Not strictly optimal.");
        resource_entries.listAppend(ChecklistEntryMake(604, "__item portable spacegate", "place.php?whichplace=spacegate&action=sg_Terminal", ChecklistSubentryMake("Spacegate dial", "", description), 8));
    }
}
RegisterResourceGenerationFunction("IOTMNewYouGenerateResource");
void IOTMNewYouGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (__misc_state["in run"] && in_ronin())
    {
        string [item] affirmation_effects;
        string [item] affirmation_combat_uses;
        affirmation_effects[$item[Daily Affirmation: Adapt to Change Eventually]] = "+4 stats/fight, +50% init";
        if (!__misc_state["need to level"])
            affirmation_effects[$item[Daily Affirmation: Adapt to Change Eventually]] = "+50% init";
        affirmation_effects[$item[Daily Affirmation: Always be Collecting]] = "+50% item, +100% meat";
        affirmation_effects[$item[Daily Affirmation: Be a Mind Master]] = "+100% spell damage, 15 MP regen";
        affirmation_effects[$item[Daily Affirmation: Be Superficially interested]] = "-combat / +combat (togglable)";
        affirmation_effects[$item[Daily Affirmation: Keep Free Hate in your Heart]] = "+30 ML";
        affirmation_effects[$item[Daily Affirmation: Think Win-Lose]] = "+50% all stats";
        affirmation_effects[$item[Daily Affirmation: Work For Hours a Week]] = "+5 familiar weight, 15 HP regen";
        if (__misc_state["familiars temporarily blocked"])
            affirmation_effects[$item[Daily Affirmation: Work For Hours a Week]] = "15 HP regen";
        
        
        affirmation_combat_uses[$item[Daily Affirmation: Adapt to Change Eventually]] = "reroll monster"; //monster change
        affirmation_combat_uses[$item[Daily Affirmation: Always be Collecting]] = "duplicate item drops";
        affirmation_combat_uses[$item[Daily Affirmation: Be a Mind Master]] = "banish for 80 turns";
        if (!__misc_state["have reusable olfaction equivalent"])
            affirmation_combat_uses[$item[Daily Affirmation: Be Superficially interested]] = "olfact weakly";
        if (hippy_stone_broken())
            affirmation_combat_uses[$item[Daily Affirmation: Keep Free Hate in your Heart]] = "gain 3 PVP fights";
        affirmation_combat_uses[$item[Daily Affirmation: Think Win-Lose]] = "instakill";
        affirmation_combat_uses[$item[Daily Affirmation: Work For Hours a Week]] = "earn some meat";
        
        ChecklistEntry entry = ChecklistEntryMake(496);
        foreach it in affirmation_effects
        {
            if (it.item_amount() == 0) continue;
            if (!it.item_is_usable()) continue;
            if (!it.to_effect().effect_is_usable()) continue;
            if (entry.image_lookup_name == "")
                entry.image_lookup_name = "__item " + it;
            string combat_text = "";
            if (affirmation_combat_uses[it] != "")
                combat_text = "Or throw in combat to " + affirmation_combat_uses[it] + ".";
            ChecklistSubentry subentry = ChecklistSubentryMake(pluralise(it), "100 turns, " + affirmation_effects[it], combat_text);
            if (it == $item[Daily Affirmation: Think Win-Lose])
            {
            	resource_entries.listAppend(ChecklistEntryMake(497, "__item " + it, "", subentry).ChecklistEntryTag("free instakill"));
            }
            else if (it == $item[Daily Affirmation: Be a Mind Master])
            {
                resource_entries.listAppend(ChecklistEntryMake(498, "__item " + it, "", subentry).ChecklistEntryTag("free banish"));
            }
            else
	            entry.subentries.listAppend(subentry);
        }
        if (entry.subentries.count() > 0)
        {
            entry.url = "inventory.php?which=3";
            entry.importance_level = 6;
            resource_entries.listAppend(entry);
        }
    }
}
RegisterResourceGenerationFunction("IOTMKGBriefcaseGenerateResource");
void IOTMKGBriefcaseGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[kremlin's greatest briefcase]]) return;
    ChecklistEntry entry = ChecklistEntryMake(509);
    entry.image_lookup_name = "__item Kremlin's Greatest Briefcase";
    entry.importance_level = 5;
    entry.url = "place.php?whichplace=kgb";
    if (get_property_int("_kgbTranquilizerDartUses") < 3 && my_path_id() != PATH_POCKET_FAMILIARS)
    {
        string [int] description;
        description.listAppend("Free run/banishes for twenty turns.|Use the KGB tranquilizer dart skill in-combat.");
        if ($item[kremlin's greatest briefcase].equipped_amount() == 0)
        {
            description.listAppend("Equip the briefcase first.");
            //entry.url = "inventory.php?which=2";
        }
        resource_entries.listAppend(ChecklistEntryMake(510, "__item Kremlin's Greatest Briefcase", entry.url, ChecklistSubentryMake(pluralise(3 - get_property_int("_kgbTranquilizerDartUses"), "briefcase dart", "briefcase darts"), "", description)).ChecklistEntryTag("free banish"));
    }
    int clicks_remaining = clampi(22 - get_property_int("_kgbClicksUsed"), 0, 22);
    if (clicks_remaining > 0)
    {
        string [int] description;
        description.listAppend("All sorts of things. Buffs, martinis, cigars!");
        
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(clicks_remaining, "click", "clicks"), "", description));
    }
    if (entry.subentries.count() > 0)
        resource_entries.listAppend(entry);
}




RegisterTaskGenerationFunction("IOTMAsdonMartinGenerateTasks");
void IOTMAsdonMartinGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[Asdon martin keyfob]])
        return;
    //BanishIsActive
    //FIXME test get_fuel() in point release
    if (!BanishIsActive("Spring-Loaded Front Bumper") && __misc_state["in run"] && (my_path_id() != PATH_POCKET_FAMILIARS || (__iotms_usable[$item[source terminal]] && __iotms_usable[$item[FantasyRealm membership packet]])))
    {
    	string description = "Banish" + (__misc_state["free runs usable"] ? "/free run" : "") + ", ";
     
     	string fuel = "costs 50 fuel.";
     	if (get_fuel() < 50)
        {
        	description += HTMLGenerateSpanFont(fuel, "red");
         	description += "|" + HTMLGenerateSpanFont("Fuel up to 50 first.", "red");   
        }
        else
            description += fuel;
		if (my_path_id() == PATH_POCKET_FAMILIARS)
			description += "|In FantasyRealm, where you can extract for consumables.";
        task_entries.listAppend(ChecklistEntryMake(515, "__item Asdon Martin keyfob", "campground.php?action=fuelconvertor", ChecklistSubentryMake("Cast Spring-Loaded Front Bumper", "", description), -11));
    }
}

RegisterResourceGenerationFunction("IOTMAsdonMartinGenerateResource");
void IOTMAsdonMartinGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[Asdon martin keyfob]])
        return;
    ChecklistEntry entry = ChecklistEntryMake(516);
    entry.importance_level = 0;
    if (__misc_state["in run"] && in_ronin())
    {
        item [int] fuelables = asdonMartinGenerateListOfFuelables();
        if (fuelables.count() > 0)
        {
            string [int] fuelables_extended;
            string [int] fuelables_extended_part_2;
            foreach key, fuelable in fuelables
            {
                int creatable_amount = fuelable.creatable_amount();
                string line;
                line = " (";
                line += (fuelable.averageAdventuresForConsumable() * (creatable_amount + fuelable.item_amount())).round();
                if (fuelable.item_amount() == 0)
                {
                    if (fuelable.craft_type() == "Summon Clip Art") continue;
                    line += ", ";
                    boolean first = true;
                    foreach it, amount in fuelable.get_ingredients_fast()
                    {
                        if (first)
                            first = false;
                        else
                            line += " + ";
                        if (amount > 1)
                            line += amount + " ";
                        line += it;
                    }
                }
                line += ")";
                line = fuelable.to_string() + HTMLGenerateSpanOfClass(line, "r_cl_modifier_inline");
                
                string desired_colour = "";
                if (fuelable.quality == "EPIC")
                    desired_colour = "blueviolet";
                else if (fuelable.quality == "awesome")
                    desired_colour = "blue";
                else if (fuelable.quality == "good")
                    desired_colour = "green";
                else if (fuelable.quality == "crappy")
                    desired_colour = "#999999";
                boolean cannot_consume_anyways = false;
                if (!__misc_state["can eat just about anything"] && fuelable.fullness > 0)
                    cannot_consume_anyways = true;
                if (!__misc_state["can drink just about anything"] && fuelable.inebriety > 0 && !(my_path_id() == PATH_LICENSE_TO_ADVENTURE && fuelable.image == "martini.gif"))
                    cannot_consume_anyways = true;
                if (!fuelable.is_unrestricted())
                    cannot_consume_anyways = true;
                if (cannot_consume_anyways)
                    desired_colour = "#999999";
                if (desired_colour != "")
                    line = HTMLGenerateSpanFont(line, desired_colour);
                if (key >= 0 && true)
                {
                    fuelables_extended_part_2.listAppend(line);
                    //break;
                }
                else
                    fuelables_extended.listAppend(line);
            }
            string [int] description;
            if (fuelables_extended_part_2.count() > 0)
            {
                //fuelables_extended.listAppend("(...)");
                int estimated_margin = fuelables_extended_part_2.count() * 1.2;
                fuelables_extended.listAppend(HTMLGenerateSpanOfClass(HTMLGenerateTagWrap("span", fuelables_extended_part_2.listJoinComponents("<br>"), mapMake("class", "r_tooltip_inner_class r_tooltip_inner_class_margin", "style", "margin-top:-" + estimated_margin + "em;margin-left:-5em;")) + "Fuel list.", "r_tooltip_outer_class") + ($item[loaf of soda bread].creatable_amount() > 0 ? "|Or create and feed loaf of soda breads." : ""));
            }
            else if ($item[loaf of soda bread].creatable_amount() > 0)
                description.listAppend("Or create and feed loaf of soda breads.");
            //description.listAppend(HTMLGenerateSpanOfClass(HTMLGenerateTagWrap("span",HTMLGenerateSimpleTableLines(table, false), mapMake("class", "r_tooltip_inner_class  r_tooltip_inner_class_margin", "style", "margin-top:-" + estimated_margin + "em;margin-left:-5em;")) + "Costs one spleen and two candies.", "r_tooltip_outer_class"));
            //description.listAppend("Could fuel with:|*" + fuelables_extended.listJoinComponents("|*", ""));
            description.listAppend(fuelables_extended.listJoinComponents("|*", ""));
            entry.subentries.listAppend(ChecklistSubentryMake(get_fuel() + " Fuel", "", description));
            if (entry.url == "")
                entry.url = "campground.php?action=fuelconvertor";
            if (entry.image_lookup_name == "")
                entry.image_lookup_name = "__item Asdon Martin keyfob";
        }
    }
    if (!get_property_boolean("_missileLauncherUsed") && my_path_id() != PATH_POCKET_FAMILIARS && my_path_id() != PATH_G_LOVER)
    {
        if (entry.image_lookup_name == "")
            entry.image_lookup_name = "__skill asdon martin: missile launcher";
        if (entry.url == "")
            entry.url = "campground.php?action=workshed";
        string fuel_costs = "Costs 100 fuel";
        if (get_fuel() < 100)
        	fuel_costs = HTMLGenerateSpanFont(fuel_costs, "red");
		resource_entries.listAppend(ChecklistEntryMake(517, "__item Asdon Martin keyfob", "campground.php?action=workshed", ChecklistSubentryMake("Asdon Missile", "", fuel_costs + ", instakill + YR-equivalent.")).ChecklistEntryTag("free instakill"));
        //entry.subentries.listAppend(ChecklistSubentryMake("Asdon Missile", "", fuel_costs + ", instakill + YR-equivalent."));
    }
    if (BanishIsActive("Spring-Loaded Front Bumper"))
    {
        Banish b = BanishByName("Spring-Loaded Front Bumper");
        int turns_left = b.banish_turn_length - (my_turncount() - b.turn_banished);
        
        if (turns_left > 0 && turns_left <= 30)
        {
            entry.subentries.listAppend(ChecklistSubentryMake(pluralise(turns_left, "turn", "turns") + " to next asdon bumper", "", "Banish/runaway."));
            if (entry.image_lookup_name == "")
                entry.image_lookup_name = "__item Asdon Martin keyfob";
        }
        if (entry.url == "")
            entry.url = "campground.php?action=workshed";
    }
    if (entry.subentries.count() > 0)
    {
        resource_entries.listAppend(entry);
    }
}



string [int] generateUsefulPlacesToRerollMonsters()
{
	string [int] useful_places;
    if (spleen_limit() > 0 && $familiar[space jellyfish].familiar_is_usable() && get_property_int("_spaceJellyfishDrops") < 4 && my_path_id() != PATH_LIVE_ASCEND_REPEAT)
    {
        string line = "stench monster area";
        if ($location[Pirates of the Garbage Barges].locationAvailable())
            line += " (garbage pirates)";
        line += " - extract stench jelly repeatedly, with the space jellyfish";
        useful_places.listAppend(line);
    }
    if (!__quest_state["Level 11 Palindome"].finished && get_property_int("palindomeDudesDefeated") < 5)
        useful_places.listAppend("inside the palindome");
    if (!__quest_state["Level 11 Manor"].finished && __quest_state["Level 11 Manor"].mafia_internal_step < 4 && $items[wine bomb, unstable fulminate].available_amount() == 0)
        useful_places.listAppend("haunted laundry room / haunted wine cellar");
    useful_places.listAppend("anywhere you olfact and get the wrong monster" + (($item[time-spinner].available_amount() > 0) ? ", unless time-spinning" : ""));
    return useful_places;
}


//_macrometeoriteUses
//_meteorShowerUses
RegisterResourceGenerationFunction("IOTMMeteorLoreGenerateResource");
void IOTMMeteorLoreGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$skill[Meteor Lore].have_skill())
        return;
    if (!__misc_state["in run"]) return;
    if (my_path_id() == PATH_G_LOVER) return;
    
    ChecklistEntry entry = ChecklistEntryMake(518);
    entry.image_lookup_name = "__skill Meteor Lore";
    entry.importance_level = 3;
    if (get_property_int("_macrometeoriteUses") < 10)
    {
        int macrometeorite_uses_remaining = clampi(10 - get_property_int("_macrometeoriteUses"), 0, 10);
        string [int] description;
        description.listAppend("Reroll a monster to another in the area.");
        
        string [int] useful_places = generateUsefulPlacesToRerollMonsters();
        
        if (useful_places.count() > 0 && my_path_id() != PATH_COMMUNITY_SERVICE)
            description.listAppend("Reroll:|*-" + useful_places.listJoinComponents("|*-"));
        
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(macrometeorite_uses_remaining, "macrometeorite", "macrometeorites"), "", description));
    }
    if (get_property_int("_meteorShowerUses") < 5 && !__misc_state["familiars temporarily blocked"])
    {
        int meteor_shower_uses_remaining = clampi(5 - get_property_int("_meteorShowerUses"), 0, 5);
        
        string [int] description;
        description.listAppend("+200% weapon/spell damage, +20 familiar weight, for a single fight.");
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(meteor_shower_uses_remaining, "meteor shower", "meteor showers"), "", description));
    }
    if ($item[metal meteoroid].available_amount() > 0 && in_ronin())
    {
        string [int] description;
        description.listAppend("Craft into useful equipment.");
        
        string [item] item_descriptions;
        item_descriptions[$item[meteorb]] = "spell damage x2, like a lantern";
        item_descriptions[$item[meteorthopedic shoes]] = "+5 adventures/day, +30% init, +15% moxie";
        item_descriptions[$item[asteroid belt]] = "+10 ML, deflects attacks";
        //shooting morning star - 15% muscle tower test
        //meteorthopedic shoes - 15% moxie tower test
        //meteortarboard - 15% myst tower test
        if (!__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "")
        {
            
            stat stat_race_type = __quest_state["Level 13"].state_string["Stat race type"].to_stat();
            if (stat_race_type == $stat[muscle])
                item_descriptions[$item[shooting morning star]] = "+15% muscle for tower test";
            else if (stat_race_type == $stat[mysticality])
                item_descriptions[$item[meteortarboard]] = "+15% myst for tower test";
        }
        string [int] items;
        foreach it, desc in item_descriptions
        {
            if (it.available_amount() == 0)
                items.listAppend(it + " (" + desc + ")");
        }
        if (items.count() > 0)
            description.listAppend("Could make " + items.listJoinComponents(", ", "or") + ".");
        if ($item[metal meteoroid].item_amount() > 0)
            entry.url = "inv_use.php?pwd=" + my_hash() + "&whichitem=9516";
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise($item[metal meteoroid]), "", description));
    }
    
    if (entry.subentries.count() > 0)
        resource_entries.listAppend(entry);
}
RegisterResourceGenerationFunction("IOTMGenieBottleGenerateResource");
void IOTMGenieBottleGenerateResource(ChecklistEntry [int] resource_entries)
{
    if ($item[genie bottle].item_amount() + $item[pocket wish].item_amount() == 0) return;
    
    int wishes_left = 0;
    if (__misc_state["in run"] && in_ronin())
        wishes_left += $item[pocket wish].item_amount();
    if ($item[genie bottle].item_amount() > 0 && my_path_id() != PATH_BEES_HATE_YOU)
        wishes_left += clampi(3 - get_property_int("_genieWishesUsed"), 0, 3);
    string [int] description;
    
    if (wishes_left > 0)
    {
        string url = "inv_use.php?pwd=" + my_hash() + "&whichitem=9529";
        if ($item[genie bottle].item_amount() == 0 || get_property_int("_genieWishesUsed") >= 3)
            url = "inv_use.php?pwd=" + my_hash() + "&whichitem=9537";
        
        string potential_monsters = SFaxGeneratePotentialFaxes(true, $monsters[ninja snowman assassin,modern zmobie,giant swarm of ghuol whelps, screambat]).listJoinComponents("|<hr>");
        if (potential_monsters != "")
	        description.listAppend("Could fight a monster:<br>" + potential_monsters);
        resource_entries.listAppend(ChecklistEntryMake(462, "__item genie bottle", url, ChecklistSubentryMake(pluralise(wishes_left, "wish", "wishes"), "", description), 1));
    }
}
RegisterTaskGenerationFunction("IOTMHorseryGenerateTasks");
void IOTMHorseryGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[Horsery contract]]) return;
    if (get_property("_horsery") == "" && my_meat() >= 500)
    {
        optional_task_entries.listAppend(ChecklistEntryMake(451, "__item magical pony: Spectrum Dash", "place.php?whichplace=town_right&action=town_horsery", ChecklistSubentryMake("Bring along a horse!", "", "Probably the dark horse.")));
        
    }
}

RegisterResourceGenerationFunction("IOTMXOSkeletonGenerateResource");
void IOTMXOSkeletonGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$familiar[XO Skeleton].familiar_is_usable()) return;
	
	
	
	int hugs_remaining = clampi(11 - get_property_int("_xoHugsUsed"), 0, 11);
	
	ChecklistEntry entry = ChecklistEntryMake(538);
	entry.image_lookup_name = "__familiar xo skeleton";
	entry.importance_level = 3;
	if (my_familiar() != $familiar[XO Skeleton])
		entry.url = "familiar.php";
	
	
	if ((my_familiar() == $familiar[XO Skeleton] || __misc_state["in run"]) && hugs_remaining > 0)
	{
		string [int] description;
  		description.listAppend("Instantly v-pocket an item.");
    	if (__misc_state["in run"] && my_path_id() != PATH_COMMUNITY_SERVICE)
     	{
      		string [int] options;
        	if (!__quest_state["Level 12"].finished && get_property("sidequestOrchardCompleted") == "none" && !($effect[Filthworm Guard Stench].have_effect() > 0 || $item[Filthworm royal guard scent gland].available_amount() > 0))      
        		options.listAppend("filthworms");
         	if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && !QuestState("questM20Necklace").finished)
	            options.listAppend("banshee librarian (killing jar)");
            if (get_property_int("hiddenApartmentProgress") < 7 || get_property_int("hiddenOfficeProgress") < 7)
	            options.listAppend("pygmy witch lawyer (short writs)");
            if (!have_outfit_components("Swashbuckling Getup"))
	            options.listAppend("obligatory pirate's cove (outfit)");
            if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] >= 90)
	            options.listAppend("Whatsian Commando Ghost (ghost free runaway)");
        	if (options.count() > 0)
         		description.listAppend(options.listJoinComponents(", ").capitaliseFirstLetter() + ", etc.");            
      	}            
		entry.subentries.listAppend(ChecklistSubentryMake(pluralise(hugs_remaining, "hug", "hugs"), "", description));
	}
	
	if (__misc_state["in run"] && in_ronin())
	{
        int xes = $item[9543].available_amount();
        int os = $item[9544].available_amount();
        
        //two Os: pair of candy glasses (10 adventures of +50% item)
        //Hide-rox cookie: 3 os, 1-size food, myst tower test
        //jug of booze: 3 xes, 1-size booze, moxie tower test
        //glyph of athleticism: 5 Os, 1-size spleen, muscle tower test
        //bridge truss: 23 xes, 15 bridge progress, takes forever to acquire
		
		string header;
        string [int] description;
		if (xes > 0)
  	      header += pluralise(xes, "X", "Xes");
        if (os > 0)
        {
        	if (header != "")
         		header += ", ";
            header += pluralise(os, "O", "Os");
        }
        
        boolean [string] options;
        
        options["pair of candy glasses: +50% item (10 turns)"] = (os >= 2);
        if (!__quest_state["Level 9"].state_boolean["bridge complete"] && my_path_id() != PATH_COMMUNITY_SERVICE)
        {
        	int turns_left = (23 - xes) * 9 - get_property_int("xoSkeleltonXProgress");
            string line = "bridge truss: half a bridge"; 
            if (turns_left > 0)
            	line += ", " + pluralise(turns_left, "combat", "combats") + " to get";
	        options[line] = (xes >= 23);
        }
        if (!__quest_state["Level 13"].state_boolean["Stat race completed"])
        {
        	stat stat_race_type = __quest_state["Level 13"].state_string["Stat race type"].to_stat();
         	//if (stat_race_type == $stat[muscle])
        }
        foreach option, available in options
        {
        	string line = option;
         	if (!available)
          		line = HTMLGenerateSpanFont(line, "gray");
            description.listAppend(line);            
        }
        
        entry.subentries.listAppend(ChecklistSubentryMake(header, "", description));
	}
	
	if (entry.subentries.count() > 0)
		resource_entries.listAppend(entry);
}

RegisterTaskGenerationFunction("IOTMPortablePantogramGenerateTasks");
void IOTMPortablePantogramGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!__iotms_usable[$item[portable pantogram]]) return;
	if ($item[pantogram pants].available_amount() > 0) return;
	
    if (my_path_id() == PATH_BEES_HATE_YOU) return;
	string [int] description;
	
	
	string [int][int] slot_options;
	for i from 1 to 5
		slot_options[i] = listMakeBlankString();
    
    //Slot 1: muscle, myst, moxie. Tower stat test, then muscle.
    if (__misc_state["in run"] && !__quest_state["Level 13"].state_boolean["Stat race completed"] && __quest_state["Level 13"].state_string["Stat race type"] != "")
    	slot_options[1].listAppend(__quest_state["Level 13"].state_string["Stat race type"]);
    else if (__misc_state["in run"])
    	slot_options[1].listAppend("muscle");
	//Slot 2: Resistance. Cold? Spooky?
	if (__misc_state["in run"])
	{
		if (my_path_id() == PATH_COMMUNITY_SERVICE)
            slot_options[2].listAppend("hot resistance");
        else if (!__quest_state["Level 9"].state_boolean["bridge complete"])
            slot_options[2].listAppend("sleaze resistance"); //bridge building
        else
	    	slot_options[2].listAppend("spooky resistance"); //a-boo peak, and slightly more useful than cold resistance
    }
	//Slot 3: drops of blood (+40 HP). -3 MP to use skills is nice, I guess? but it takes a baconstone
	if (__misc_state["in run"])
		slot_options[3].listAppend("drops of blood (+40 HP)");
	if ($item[baconstone].available_amount() > 0 && __misc_state["in run"])
		slot_options[3].listAppend("baconstone (-3 MP to use skills)");
	//Slot 4:
	if ($item[taco shell].npc_price() > 0)
		slot_options[4].listAppend("taco shell (+30% meat)");
    if (($item[porquoise].npc_price() > 0 && __misc_state["in run"]) || can_interact())
        slot_options[4].listAppend("porquoise (+60% meat)");
    if (my_path_id() == PATH_COMMUNITY_SERVICE)
    {
        slot_options[4].listAppend("your hopes (+20 weapon damage)");
        slot_options[4].listAppend("your dreams (+20% spell damage)");
    }
	if (__misc_state["in run"])
	{
	}
	else
	{
        slot_options[4].listAppend("tiny dancer (+30% item)");
	}
	//slot_options[4].listAppend("???");
	//Slot 5:
    slot_options[5].listAppend("some self-respect (-combat)");
    if (my_path_id() != PATH_COMMUNITY_SERVICE)
    	slot_options[5].listAppend("some self-control (+combat)");
    if (!__misc_state["in run"])
    	slot_options[5].listAppend("ten-leaf clover (hilarious items)");
    if ($item[bar skin].available_amount() > 0 && __misc_state["in run"])
    	slot_options[5].listAppend("bar skin (+50% init)");
	
	foreach slot_id in slot_options
	{
		if (slot_options[slot_id].count() == 0) continue;
		description.listAppend(slot_options[slot_id].listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
	}
    optional_task_entries.listAppend(ChecklistEntryMake(573, "__item portable pantogram", "inv_use.php?pwd=" + my_hash() + "&whichitem=9573", ChecklistSubentryMake("Summon pants", "", description), 1));
}

RegisterGenerationFunction("IOTMGarbageToteGenerate");
void IOTMGarbageToteGenerate(ChecklistCollection checklists)
{
	if (!$item[January's Garbage Tote].have()) return;
	boolean [item] relevant_items;
	if (get_property_int("garbageTreeCharge") > 0)
		relevant_items[$item[deceased crimbo tree]] = true;
    if (get_property_int("garbageShirtCharge") > 0 && __misc_state["Torso aware"])
        relevant_items[$item[makeshift garbage shirt]] = true;
    if (get_property_int("garbageChampagneCharge") > 0)
        relevant_items[$item[broken champagne bottle]] = true;
    relevant_items[$item[tinsel tights]] = true;
    relevant_items[$item[wad of used tape]] = true;
	if (relevant_items.available_amount() == 0)
	{
		string [int] description;
        if (my_level() < 13 && get_property_int("garbageShirtCharge") > 0 && __misc_state["Torso aware"])
        {
            description.listAppend("Makeshift garbage shirt (double statgain for " + pluralise(get_property_int("garbageShirtCharge"), "more turn", "more turns") + ".)");
        }
        else if (my_level() < 13)
        	description.listAppend("Tinsel tights (+25 ML)");
        description.listAppend("Wad of used tape (+15% item, +30% meat)");
        if (get_property_int("garbageChampagneCharge") > 0)
        	description.listAppend("Broken champagne bottle (double +item for " + pluralise(get_property_int("garbageChampagneCharge"), "more turn", "more turns") + ".)");
        
        
        checklists.add(C_OPTIONAL_TASKS, ChecklistEntryMake(552, "__item January's Garbage Tote", "inv_use.php?pwd=" + my_hash() + "&whichitem=9690", ChecklistSubentryMake("Collect a garbage tote item", "", description), 1));
	}
	
	
	//resources:
	
	string [item] item_effect_description;
	string [item] item_charge_property;
	
	if (__misc_state["Torso aware"])
		item_charge_property[$item[makeshift garbage shirt]] = "garbageShirtCharge";
    item_charge_property[$item[broken champagne bottle]] = "garbageChampagneCharge";
    item_charge_property[$item[deceased crimbo tree]] = "garbageTreeCharge";
    
    
    if (__misc_state["Torso aware"])
	    item_effect_description[$item[makeshift garbage shirt]] = "Doubles statgain";
    item_effect_description[$item[broken champagne bottle]] = "Doubles +item";
    item_effect_description[$item[deceased crimbo tree]] = "Absorbs damage";
	
	foreach it, property_name in item_charge_property
	{
        int charge = get_property_int(property_name);
        boolean have = it.available_amount() > 0;
        if (!have && charge == 0) continue;
        if (!have && !($items[makeshift garbage shirt,broken champagne bottle] contains it)) continue;
        string title;
        string [int] description;
        string url = generateEquipmentLink(it);
        if (charge > 0)
        {
            title = pluralise(charge, "charge", "charges") + " of " + it;
            description.listAppend(item_effect_description[it] + "." + (!have ? " Not active." : ""));
        }
        else
        {
        	title = HTMLGenerateSpanFont("No charges of " + it, "red");
            description.listAppend("Switch out for something else.");
            url = "inv_use.php?pwd=" + my_hash() + "&whichitem=9690";
        }   
        checklists.add(C_RESOURCES, ChecklistEntryMake(553, "__item " + it, url, ChecklistSubentryMake(title, "", description), 8).ChecklistEntryTag("garbage tote"));
	}
}


RegisterGenerationFunction("IOTMZutaraGenerate");
void IOTMZutaraGenerate(ChecklistCollection checklists)
{
    if (!__misc_state["VIP available"] || !$item[Clan Carnival Game].is_unrestricted())
        return;
    if (!get_property_boolean("_clanFortuneBuffUsed"))
    {
    	string [int] description;
        if (!__misc_state["familiars temporarily blocked"] && __misc_state["in run"])
        	description.listAppend(HTMLGenerateSpanOfClass("Susie:", "r_bold") + " +5 familiar weight, +familiar experience."); //only show in-run, because, like... +5 familiar weight for one hundred turns is not likely to pay out compared to hagnk/meatsmith in aftercore.
        if (my_path_id() != PATH_G_LOVER)
	        description.listAppend(HTMLGenerateSpanOfClass("Hagnk:", "r_bold") + " +50% item/booze/food.");
        if (my_path_id() != PATH_G_LOVER)
	        description.listAppend(HTMLGenerateSpanOfClass("Meatsmith:", "r_bold") + " +100% meat, +50% gear drop.");
        
        if (__misc_state["in run"])
        {
        	if (my_primestat() == $stat[muscle] || my_path_id() == PATH_COMMUNITY_SERVICE)
	            description.listAppend(HTMLGenerateSpanOfClass("Gunther:", "r_bold") + " +5 muscle stats/fight, +100% muscle, +50% HP.");
            if (my_primestat() == $stat[moxie] || my_path_id() == PATH_COMMUNITY_SERVICE)
            	description.listAppend(HTMLGenerateSpanOfClass("Gorgonzola:", "r_bold") + " +5 myst stats/fight, +100% myst, +50% MP.");
            //always show moxie, since I'm sure that +50% init will be super important to someone. maybe they have a bad lair test?
            if (my_path_id() != PATH_G_LOVER)
	            description.listAppend(HTMLGenerateSpanOfClass("Shifty:", "r_bold") + " +5 moxie stats/fight, +100% moxie, +50% init.");
        }
        checklists.add(C_RESOURCES, ChecklistEntryMake(587, "__item genie's turbane", "clan_viplounge.php?preaction=lovetester", ChecklistSubentryMake("Fortune buff (100 turns)", "", description), 8).ChecklistEntryTag("zutara").ChecklistEntrySetCategory("buff").ChecklistEntrySetShortDescription("blank"));
    }
    if (get_property_int("_clanFortuneConsultUses") < 3)
    {
        string [int] description;
        checklists.add(C_RESOURCES, ChecklistEntryMake(588, "__item genie's turbane", "clan_viplounge.php?preaction=lovetester", ChecklistSubentryMake(pluralise(3 - get_property_int("_clanFortuneConsultUses"), "fortune clan consult", "fortune clan consults"), "", description), 8).ChecklistEntryTag("zutara"));
    }
}
RegisterGenerationFunction("IOTMNeverendingPartyGenerate");
void IOTMNeverendingPartyGenerate(ChecklistCollection checklists)
{
    if (!__iotms_usable[$item[Neverending Party invitation envelope]])
        return;
    //Quest suggestions:
    //_partyHard (boolean), _questPartyFair (Quest), _questPartyFairProgress (integer?), _questPartyFairQuest (string? - "partiers", )
    
    QuestState quest_state = QuestState("_questPartyFair");
    //_questPartyFair is "" instead of unstarted if they didn't start it.
    if (quest_state.in_progress)
    {
        string quest_name = get_property("_questPartyFairQuest");
        //strange - went from "unstarted" to "step1" when accepting the partiers quest
        boolean party_hard = get_property_boolean("_partyHard");
        int [int] progress_split;
        foreach key, v in get_property("_questPartyFairProgress").split_string(" ")
        {
        	if (v == "") continue;
            progress_split.listAppend(v.to_int());
        }
        int progress = progress_split[0];
        
        string [int] modifiers;
        string [int] description;
        string url = "place.php?whichplace=town_wrong";
        boolean finished = false;
        if (party_hard && !$item[PARTY HARD T-shirt].equipped())
        {
            description.listAppend(HTMLGenerateSpanFont("Equip the PARTY HARD T-shirt.", "red"));
            url = generateEquipmentLink($item[PARTY HARD T-shirt]);
        }
        //partiers - progress starts at 50 in not-hard
        if (quest_name == "partiers")
        {
            if (progress > 0)
            {
            	description.listAppend(pluralise(progress, "partier", "partiers") + " remain.");
                if ($item[intimidating chainsaw].available_amount() == 0)
                {
                	description.listAppend("Collect the intimidating chainsaw.|" + listMake("Investigate the basement", "Grab the chainsaw").listJoinComponents(__html_right_arrow_character));
                }
                else if ($item[intimidating chainsaw].equipped_amount() == 0)
                {
                	description.listAppend(HTMLGenerateSpanFont("Equip the intimidating chainsaw.", "red"));
                    url = generateEquipmentLink($item[intimidating chainsaw]);
                }
                if ($item[jam band bootleg].item_amount() > 0)
                {
                    description.listAppend("Pop in the bootleg.|" + listMake("Head Upstairs", "Pop a bootleg in the stereo").listJoinComponents(__html_right_arrow_character));
                }
                else if (!in_ronin())
                {
                    description.listAppend("Buy a jam band bootleg in the mall?");
                }
                if ($item[Purple Beast energy drink].item_amount() > 0)
                {
                    description.listAppend("Pour the energy drink into the pool.|" + listMake("Go to the back yard", "Pour Purple Beast into the pool").listJoinComponents(__html_right_arrow_character));
                }
                else if (!in_ronin())
                {
                    description.listAppend("Buy a Purple Beast energy drink in the mall?");
                }
            }
            else
            {
            	finished = true;
            }
        }
        else if (quest_name == "booze")
        {
            //unremarkable duffel bag gives item; from jock
            
            if (quest_state.mafia_internal_step < 2)
            {
                description.listAppend("Talk to Gerald.|" + listMake("Go to the back yard", "Find Gerald").listJoinComponents(__html_right_arrow_character));
            }
            else
            {
            	int amount_needed = progress_split[0];
                item item_needed = progress_split[1].to_item();
                if (item_needed == $item[none])
                {
                	description.listAppend("Unknown item needed.");
                }
                else if (item_needed.item_amount() < amount_needed)
                {
                	description.listAppend("Need to collect " + amount_needed + " " + item_needed + ".");
                    description.listAppend("Can collect from unremarkable duffel bags, from the jock.");
                    modifiers.listAppend("olfact jock");
                }
                else
                    description.listAppend("Talk to Gerald.|" + listMake("Go to the back yard", "Give Gerald the booze").listJoinComponents(__html_right_arrow_character));
            }
        }
        else if (quest_name == "food")
        {
            //van key gives item; from burnout
            
            if (quest_state.mafia_internal_step < 2)
            {
                description.listAppend("Talk to Geraldine.|" + listMake("Check out the kitchen", "Talk to the woman").listJoinComponents(__html_right_arrow_character));
            }
            else
            {
                int amount_needed = progress_split[0];
                item item_needed = progress_split[1].to_item();
                
                if (item_needed == $item[none])
                {
                    description.listAppend("Unknown item needed.");
                }
                else if (item_needed.item_amount() < amount_needed)
                {
                    description.listAppend("Need to collect " + amount_needed + " " + item_needed + ".");
                    description.listAppend("Can collect from van keys, from the burnout.");
                    modifiers.listAppend("olfact burnout");
                }
                else
                	description.listAppend("Talk to Geraldine again.|" + listMake("Check out the kitchen", "Give Geraldine the snacks").listJoinComponents(__html_right_arrow_character));
            }
        }
        else if (quest_name == "trash")
        {
            if (true)
            {
            	modifiers.listAppend("+200% item");
                //Progress on this quest seems to be bugged - starts at zero, doesn't change unless we look at the quest log.
                //description.listAppend("Progress: " + progress);
                description.listAppend("Run +200% item.");
                if ($item[gas can].item_amount() > 0)
                {
                    description.listAppend(listMake("Check out the kitchen", "Burn some trash").listJoinComponents(__html_right_arrow_character));
                }
                else if (!in_ronin())
                {
                    description.listAppend("Buy a gas can in the mall?");
                }
            }
            else
            {
            	finished = true;
            }
        }
        else if (quest_name == "woots")
        {
            if (progress < 100)
            {
                description.listAppend(progress + " out of 100 megawoots.");
                //equip cosmetic football
                if ($item[cosmetic football].available_amount() == 0 && !in_ronin())
                {
                    description.listAppend("Buy the cosmetic football in the mall?");
                }
                if ($item[cosmetic football].available_amount() > 0 && $item[cosmetic football].equipped_amount() == 0)
                {
                    description.listAppend(HTMLGenerateSpanFont("Equip the cosmetic football.", "red"));
                    url = generateEquipmentLink($item[cosmetic football]);
                }
                //very small red dress
                if ($item[very small red dress].item_amount() > 0)
                {
                    description.listAppend(listMake("Head upstairs", "Toss the red dress on the lamp").listJoinComponents(__html_right_arrow_character));
                }
                else if (!in_ronin())
                {
                    description.listAppend("Buy a very small red dress in the mall?");
                }
                //electronics kit
                if ($item[electronics kit].item_amount() > 0)
                {
                    description.listAppend(listMake("Investigate the basement", "Modify the living room lights").listJoinComponents(__html_right_arrow_character));
                }
                else if (!in_ronin())
                {
                    description.listAppend("Buy a electronics kit in the mall?");
                }
            }
            else
            	finished = true;
        }
        else if (quest_name == "dj")
        {
            if (progress > 0)
            {
                modifiers.listAppend("+meat");
                modifiers.listAppend("olfact jocks");
                modifiers.listAppend("banish burnouts");
                description.listAppend(progress + " meat remaining.");
                description.listAppend("Run +meat, olfact jocks, banish burnouts.");
                if (my_buffedstat($stat[moxie]) >= 300)
                {
                    description.listAppend("Open the safe.|" + listMake("Head upstairs", "Crack the safe").listJoinComponents(__html_right_arrow_character));
                }
                else
                {
                	description.listAppend("Possibly buff to 300 moxie?");
                    modifiers.listAppend("300 moxie");
                }
            }
            else
            	finished = true;
        }
        else if (quest_name == "")
        {
        }
        else
            description.listAppend("Unhandled quest \"" + quest_name + "\"");
        if (finished)
        {
        	description.listAppend("Visit the party one last time to finish the quest.");
        }
        checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(528, "__item party hat", url, ChecklistSubentryMake("Neverending Party Quest", modifiers, description), 8, $locations[The Neverending Party]));
    }
}

RegisterResourceGenerationFunction("IOTMNeverendingPartyGenerateResource");
void IOTMNeverendingPartyGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[Neverending Party invitation envelope]])
        return;
    
    int free_fights_left = clampi(10 - get_property_int("_neverendingPartyFreeTurns"), 0, 10);
    if (QuestState("_questPartyFair").finished)
    	free_fights_left = 0;
    string [int] modifiers;
    string [int] description;
    modifiers.listAppend("+meat");
    
    if (free_fights_left >= 2)
    {
        if (__misc_state["need to level"])
        {
            string [int] directions;
            if (my_primestat() == $stat[muscle])
            {
                directions.listAppend("Kitchen");
                directions.listAppend("Muscle spice");
            }
            else if (my_primestat() == $stat[mysticality])
            {
                directions.listAppend("Upstairs");
                directions.listAppend("Read the tomes");
            }
            else if (my_primestat() == $stat[moxie])
            {
                directions.listAppend("Basement");
                directions.listAppend("Use the hair gel");
            }
            description.listAppend("Experience buff: " + directions.listJoinComponents(__html_right_arrow_character) + ".");
        }
        if (__misc_state["in run"])
            description.listAppend("ML buff: " + listMake("Backyard", "Candle wax").listJoinComponents(__html_right_arrow_character));
    }
    if (free_fights_left > 0)
	    resource_entries.listAppend(ChecklistEntryMake(529, "__item party hat", "place.php?whichplace=town_wrong", ChecklistSubentryMake(pluralise(free_fights_left, "free party fight", "free party fights"), modifiers, description), $locations[The Neverending Party]).ChecklistEntryTag("daily free fight"));
    
}

RegisterResourceGenerationFunction("IOTMGodLobsterGenerateResource");
void IOTMGodLobsterGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$familiar[god lobster].familiar_is_usable()) return;
	int free_fights_left = clampi(3 - get_property_int("_godLobsterFights"), 0, 3);
	
	if (free_fights_left == 0) return;
	string url = "familiar.php";
	if ($familiar[god lobster] == my_familiar())
		url = "";
  
    string [int] description;
    //This is so complicated.
	
	item [int] equipment_order;
	equipment_order.listAppend($item[God Lobster's Scepter]);
    equipment_order.listAppend($item[God Lobster's Ring]);
    equipment_order.listAppend($item[God Lobster's Rod]);
    equipment_order.listAppend($item[God Lobster's Robe]);
    equipment_order.listAppend($item[God Lobster's Crown]);
    
    item [item] equipment_to_next_reward;
    equipment_to_next_reward[$item[none]] = $item[God Lobster's Scepter];
    equipment_to_next_reward[$item[God Lobster's Scepter]] = $item[God Lobster's Ring];
    equipment_to_next_reward[$item[God Lobster's Ring]] = $item[God Lobster's Rod];
    equipment_to_next_reward[$item[God Lobster's Rod]] = $item[God Lobster's Robe];
    equipment_to_next_reward[$item[God Lobster's Robe]] = $item[God Lobster's Crown];
    equipment_to_next_reward[$item[God Lobster's Crown]] = $item[none];
	
	string [item] equipment_to_boon_description;
	equipment_to_boon_description[$item[none]] = "40 mp/adv / +20 MP";
    equipment_to_boon_description[$item[God Lobster's Scepter]] = "+10 stats/fight";
    equipment_to_boon_description[$item[God Lobster's Ring]] = "-combat";
    equipment_to_boon_description[$item[God Lobster's Rod]] = "+combat";
    equipment_to_boon_description[$item[God Lobster's Robe]] = "+1 all res / +20 DA / +3 DR";
    equipment_to_boon_description[$item[God Lobster's Crown]] = "doubles food statgain";
    
    
    string [item] equipment_to_equipment_effect_description;
    equipment_to_equipment_effect_description[$item[God Lobster's Scepter]] = "half-weight fairy/leprechaun";
    equipment_to_equipment_effect_description[$item[God Lobster's Ring]] = "sombrero statgain";
    equipment_to_equipment_effect_description[$item[God Lobster's Rod]] = "restore HP/MP after combat";
    equipment_to_equipment_effect_description[$item[God Lobster's Robe]] = "blocking potato";
    equipment_to_equipment_effect_description[$item[God Lobster's Crown]] = "full-weight fairy";
    
    float [item] equipment_to_mainstat_multiplier;
    equipment_to_mainstat_multiplier[$item[none]] = 1.5;
    equipment_to_mainstat_multiplier[$item[God Lobster's Scepter]] = 1.65;
    equipment_to_mainstat_multiplier[$item[God Lobster's Ring]] = 1.85;
    equipment_to_mainstat_multiplier[$item[God Lobster's Rod]] = 2.17;
    equipment_to_mainstat_multiplier[$item[God Lobster's Robe]] = 2.62;
    equipment_to_mainstat_multiplier[$item[God Lobster's Crown]] = 3.0;
	
	
	item current_familiar_equipment = $familiar[god lobster].familiar_equipped_equipment();
	
	string [int] current_rewards;
	//[next equipment], [effect], [experience]
	
	current_rewards.listAppend(equipment_to_boon_description[current_familiar_equipment] + " effect (33 turns)");
	if (__misc_state["need to level"])
	{
        float statgain = equipment_to_mainstat_multiplier[current_familiar_equipment] * my_basestat(my_primestat()) * (1.0 + numeric_modifier(my_primestat() + " experience percent") / 100.0);
        current_rewards.listAppend(round(statgain) + " mainstat gain");
    }
    
    if (equipment_to_next_reward[current_familiar_equipment] != $item[none] && equipment_to_next_reward[current_familiar_equipment].available_amount() == 0)
         current_rewards.listAppend("a " + equipment_to_next_reward[current_familiar_equipment].replace_string("God Lobster's", "").to_lower_case());
	
	if (current_rewards.count() > 0)
		description.listAppend("Can choose between " + current_rewards.listJoinComponents(", ", "or") + ".");
	
	string [int] other_equipment_to_switch_to;
	foreach it in equipment_to_boon_description
	{
		if (it.available_amount() == 0) continue;
        if (it == current_familiar_equipment) continue;
        //FIXME write this
        other_equipment_to_switch_to.listAppend(it + " (" + equipment_to_equipment_effect_description[it] + " and " + equipment_to_boon_description[it] + " obtainable effect)");
	}
	
	if (other_equipment_to_switch_to.count() > 0)
		description.listAppend("Could switch equipment to " + other_equipment_to_switch_to.listJoinComponents(", ", "or") + ".");
	
    resource_entries.listAppend(ChecklistEntryMake(578, "__familiar god lobster", url, ChecklistSubentryMake(pluralise(free_fights_left, "free God Lobster fight", "free God Lobster fights"), "", description)).ChecklistEntryTag("daily free fight"));
}

RegisterTaskGenerationFunction("IOTMBoomBoxGenerateTasks");
void IOTMBoomBoxGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!$item[SongBoom&trade; BoomBox].have()) return;
	
	string song = get_property("boomBoxSong");
	int changes_left = get_property_int("_boomBoxSongsLeft"); //the boys are back in town, eleven times. everyone will love it
	
	if (song == "" && changes_left > 0)
	{
        string [int] description;
        if (!__quest_state["Level 7"].finished && my_path_id() != PATH_COMMUNITY_SERVICE)
        	description.listAppend("Eye of the Giger: Nightmare Fuel for the cyrpt.");
        if (fullness_limit() > 0)
	        description.listAppend("Food Vibrations: extra adventures from food" + (__misc_state["in run"] ? ", +30% food drop" : "") + ".");
        description.listAppend("Total Eclipse of Your Meat: extra meat, +30% meat.");
        
        
        optional_task_entries.listAppend(ChecklistEntryMake(606, "__item SongBoom&trade; BoomBox", "inv_use.php?pwd=" + my_hash() + "&whichitem=9919", ChecklistSubentryMake("Set BoomBox song", "", description), 8));
	}
}

RegisterResourceGenerationFunction("IOTMCatBurglarGenerateResource");
void IOTMCatBurglarGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$familiar[cat burglar].familiar_is_usable()) return;
	
	int charges_left = CatBurglarChargesLeftToday();
	if (charges_left > 0)
	{
		string [int] description;
  		string url = "familiar.php";
        if (my_familiar() == $familiar[cat burglar])
        	url = "main.php?heist=1";
  		//rusty hedge trimmers
        //bowling ball
        //cigarette lighter, if they're doing zeppelin
        //scent glands, but only if they don't xoxoxoxo
        //green smoke bomb
        //There are also certainly even more options.
        description.listAppend("Obtains one item from a recent fight.");
        string [int] options;
        if (__misc_state["in run"] && my_path_id() != PATH_COMMUNITY_SERVICE)
        {
        	if ($item[bowling ball].available_amount() < 5 && get_property_int("hiddenBowlingAlleyProgress") < 7)
            {
            	//FIXME count bowling balls correctly and maybe test the overall quest
                options.listAppend("Bowling ball, from the hidden bowling alley.");
            }
            if (get_property_int("twinPeakProgress") != 15 && $item[rusty hedge trimmers].available_amount() < 4)
            {
            	//FIXME test trimmers against amount needed
                options.listAppend("Rusty hedge trimmers, from the twin peak.");
            }
            if (!__quest_state["Level 12"].finished && get_property("sidequestOrchardCompleted") == "none")
            {
            	options.listAppend("Green smoke bomb, from the war.");
            	if (!$familiar[XO Skeleton].familiar_is_usable())
                	options.listAppend("Scent glands, from the filthworms quest.");
            }
            if ($location[A Mob of Zeppelin Protesters].turns_spent > 0 && get_property_int("zeppelinProtestors") < 80 && $item[talisman o' namsilat].available_amount() == 0 && QuestState("questL11Ron").mafia_internal_step < 3)
            {
                options.listAppend("Cigarette lighters, from the zeppelin protesters.");
            }
            if ($item[talisman o' namsilat].available_amount() == 0 && !have_outfit_components("Swashbuckling Getup"))
            {
            	options.listAppend("Pirate outfit.");
            }
            
            if ($item[S.O.C.K.].available_amount() == 0)
            {
                string [int] airship_stealables;
                foreach it in $items[mohawk wig,amulet of extreme plot significance]
                {
                	if (it.available_amount() == 0)
                    	airship_stealables.listAppend(it);
                }
                if (airship_stealables.count() > 0)
                	options.listAppend(airship_stealables.listJoinComponents(", ", "and").capitaliseFirstLetter() + ", from the airship.");
            }
            if (__quest_state["Level 4"].state_int["areas unlocked"] + $item[sonar-in-a-biscuit].available_amount() < 3)
            	options.listAppend("Sonar-in-a-biscuit, from the bat hole.");
            if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && !__quest_state["Level 11 Desert"].state_boolean["Killing Jar Given"] && $item[killing jar].available_amount() == 0 && !($location[The Haunted Gallery].locationAvailable() && !$location[The Haunted Library].locationAvailable()))
            	options.listAppend("Killing jar, from the haunted library.");
            if (!have_outfit_components("Knob Goblin Elite Guard Uniform") && !have_outfit_components("Knob Goblin Harem Girl Disguise") && !__quest_state["Level 5"].finished)
            	options.listAppend("Harem girl outfit, if you can't reach +400% item.");
            //if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0 && $item[a-boo clue].available_amount() < 3)
                //options.listAppend("A-boo clues, from the A-Boo peak?");
        }
        if (options.count() > 0)
        	description.listAppend("Could steal:|*-" + options.listJoinComponents("|*-"));
          
        resource_entries.listAppend(ChecklistEntryMake(477, "__familiar Cat Burglar", url, ChecklistSubentryMake(pluralise(charges_left, "heist", "heists"), "", description), 1));      
	}
}


RegisterTaskGenerationFunction("IOTMBastilleBattalionGenerateTasks");
void IOTMBastilleBattalionGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if ($item[Bastille Battalion control rig].available_amount() == 0) return;
	
	if ($item[Draftsman's driving gloves].available_amount() > 0 || $item[Nouveau nosering].available_amount() > 0 || $item[Brutal brogues].available_amount() > 0) return;
	
	string [int] description;
	string url = "inv_use.php?pwd=" + my_hash() + "&whichitem=9928";
	
	//FIXME suggest the right configuration
	if ($item[Bastille Battalion control rig].storage_amount() > 0)
	{
        url = "storage.php?which=3";
        description.listAppend("Free pull from Hagnk's.");
	}
	//FIXME in the future, we might want to suggest options for them. We haven't, because it's a lot of space, especially the equipment.
	string [int] suggested_configuration;
	if (__misc_state["need to level"])
	{
		int stats_gained = ceil(250 * (1.0 + numeric_modifier(my_primestat() + " experience percent") / 100.0));
		if (my_primestat() == $stat[muscle])
        {
            description.listAppend(HTMLGenerateSpanOfClass("Babar", "r_bold") + ": " + stats_gained + " muscle stats.");
            suggested_configuration.listAppend("Babar");
        }
        else if (my_primestat() == $stat[mysticality])
        {
        	description.listAppend(HTMLGenerateSpanOfClass("Barbarian Barbecue", "r_bold") + ": " + stats_gained + " mysticality stats.");
            suggested_configuration.listAppend("Barbarian Barbecue");
        }
        else if (my_primestat() == $stat[moxie])
        {
            description.listAppend(HTMLGenerateSpanOfClass("Barbershop", "r_bold") + ": " + stats_gained + " moxie stats.");
            suggested_configuration.listAppend("Barbershop");
        }
	}
	string [int] accessories;
	accessories.listAppend(HTMLGenerateSpanOfClass("Accessory:", "r_bold"));
    accessories.listAppend(HTMLGenerateSpanOfClass("Brutalist", "r_bold") + ": +50% muscle, +50% weapon damage, +8 familiar weight, +4 muscle stats/fight.");
    accessories.listAppend(HTMLGenerateSpanOfClass("Draftsman", "r_bold") + ": +50% myst, +50% spell damage, +8 adventures/day, +4 myst stats/fight.");
    accessories.listAppend(HTMLGenerateSpanOfClass("Art Nouveau", "r_bold") + ": +50% moxie, +25% item, +25 HP/MP, +4 moxie stats/fight.");
    description.listAppend(accessories.listJoinComponents("|*"));
    
    string [int] buffs;
    buffs.listAppend(HTMLGenerateSpanOfClass("Buff:", "r_bold") + " (100 turns)");
    buffs.listAppend(HTMLGenerateSpanOfClass("Cannon", "r_bold") + ": +25 muscle, +10% critical hit, ~15 HP/adventure.");
    buffs.listAppend(HTMLGenerateSpanOfClass("Catapult", "r_bold") + ": +25 myst, +10% spell critical hit, ~7.5 MP/adventure.");
    buffs.listAppend(HTMLGenerateSpanOfClass("Gesture", "r_bold") + ": +25 moxie, +25% init, +25% meat.");
    description.listAppend(buffs.listJoinComponents("|*"));
    
    if (!in_ronin())
    {
    	//+adventures in aftercore
        suggested_configuration.listAppend("Draftsman");
    }
    else if (my_primestat() == $stat[muscle])
    {
    	suggested_configuration.listAppend("Brutalist");
    }
    else if (my_primestat() == $stat[mysticality])
    {
        suggested_configuration.listAppend("Draftsman");
    }
    else if (my_primestat() == $stat[moxie])
    {
        suggested_configuration.listAppend("Art Nouveau");
    }
    
    if (!in_ronin())
        suggested_configuration.listAppend("Gesture");
    else
    	suggested_configuration.listAppend("Catapult");
    
    description.listAppend("Suggested configuration: " + HTMLGenerateSpanOfClass(suggested_configuration.listJoinComponents(" / "), "r_bold") + ".");
	
	optional_task_entries.listAppend(ChecklistEntryMake(545, "__item Bastille Battalion control rig", url, ChecklistSubentryMake("Collect Bastille rewards", "", description), 8));
}

RegisterResourceGenerationFunction("IOTMLatteGenerateResource");
void IOTMLatteGenerateResource(ChecklistEntry [int] resource_entries)
{
	if ($item[latte lovers member's mug].available_amount() == 0) return;
	if (!__misc_state["can equip just about any off-hand"]) return;
	
	int refills_remaining = clampi(3 - get_property_int("_latteRefillsUsed"), 0, 3);
	boolean banish_used = get_property_boolean("_latteBanishUsed");
	boolean copy_used = get_property_boolean("_latteCopyUsed"); //more of an olfact than a copy
	boolean drink_used = get_property_boolean("_latteDrinkUsed");
	
	int banishes_available = refills_remaining + (!banish_used ? 1 : 0);
    int copies_available = refills_remaining + (!copy_used ? 1 : 0);
    
    string url;
    boolean latte_needs_equipping = false;
    if ($item[latte lovers member's mug].equipped_amount() == 0)
    {
    	url = generateEquipmentLink($item[latte lovers member's mug]);
        latte_needs_equipping = true;
    }
    if (banishes_available > 0)
    {
    	string banish_url = url;
    	string [int] description;
     	description.listAppend("Free run/banish." + (latte_needs_equipping ? " Equip latte first." : "") + "|Throw Latte on Opponent in combat.");
         
        if (banish_used)
        {
        	banish_url = "main.php?latte=1";
        	description.listAppend(HTMLGenerateSpanFont("Must refill latte first.", "red"));
        }
        resource_entries.listAppend(ChecklistEntryMake(533, "__item latte lovers member's mug", banish_url, ChecklistSubentryMake(pluralise(banishes_available, "latte banish", "latte banishes"), "", description), 0).ChecklistEntryTag("free banish").ChecklistEntrySetSpecificImage("__skill Throw Latte on Opponent"));
    }
    
    ChecklistEntry entry = ChecklistEntryMake(534);
    entry.image_lookup_name = "__item latte lovers member's mug";
    entry.url = "main.php?latte=1";
    
    if (refills_remaining > 0)
    {
        string [int] description;
        if (!banish_used && __misc_state["in run"])
            description.listAppend(HTMLGenerateSpanFont("Use banish first.", "red"));
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(refills_remaining, "latte refill", "latte refills"), "", description));
    }
    if (copies_available > 0)
    {
        string [int] description;
        description.listAppend("Offer Latte to Opponent in combat.");
        if (copy_used)
        {
            description.listAppend(HTMLGenerateSpanFont("Must refill latte first.", "red"));
        }
        if ($skill[Transcendent Olfaction].have_skill())
        	description.listAppend("Stack with Transcendent Olfaction.");
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(copies_available, "latte olfaction", "latte olfactions"), "", description));
    }
    if (!drink_used && my_path_id() != PATH_VAMPIRE)
    {
        entry.subentries.listAppend(ChecklistSubentryMake("Gulp Latte available", "", "Restores half your HP and MP. Cast in combat."));
    }
    entry.ChecklistEntrySetAbridgedHeader("Latte lovers member's mug");
    if (entry.subentries.count() > 0)
    	resource_entries.listAppend(entry);
}

//Throw your voting boot:
RegisterTaskGenerationFunction("IOTMVotingBootGenerateTasks");
void IOTMVotingBootGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[voter registration form]]) return;
    
    if ($item[&quot;I Voted!&quot; sticker].available_amount() == 0 || false)
    {
    	//Vote!
        string [int] description;
        if (in_ronin())
	        description.listAppend("Gives special modifiers, and unlocks three free fights to burn delay.");
        else
            description.listAppend("Gives special modifiers.");
        optional_task_entries.listAppend(ChecklistEntryMake(574, "__item &quot;I Voted!&quot; sticker", "place.php?whichplace=town_right&action=townright_vote", ChecklistSubentryMake("Vote!", "", description), 8));
    }
    
    if ($item[&quot;I Voted!&quot; sticker].available_amount() == 0) return;
    if (total_turns_played() % 11 == 1 && get_property_int("lastVoteMonsterTurn") < total_turns_played() && get_property_int("_voteFreeFights") < 3)
    {
    	string url = "";
        string [int] description;
        if ($item[&quot;I Voted!&quot; sticker].equipped_amount() == 0)
        {
        	description.listAppend(HTMLGenerateSpanFont("Equip the I Voted! sticker first.", "red"));
            url = generateEquipmentLink($item[&quot;I Voted!&quot; sticker]);
        }
        description.listAppend("Free fight that burns delay.");
        location [int] possible_locations = generatePossibleLocationsToBurnDelay();
        if (possible_locations.count() > 0)
        {
            description.listAppend("Adventure in " + possible_locations.listJoinComponents(", ", "or") + " to burn delay.");
            if (url == "")
                url = possible_locations[0].getClickableURLForLocation();
        }
        monster fighting_monster = get_property_monster("_voteMonster");
        string title = "Fight voting monster";
        if (fighting_monster != $monster[none])
        	title += " " + fighting_monster;
        task_entries.listAppend(ChecklistEntryMake(575, "__item &quot;I Voted!&quot; sticker", url, ChecklistSubentryMake(title, "", description), -11));
    }
    if (get_property_int("_voteFreeFights") < 3 && !(total_turns_played() % 11 == 1 && get_property_int("lastVoteMonsterTurn") < total_turns_played()))
    {
    	int turns_left = 11 - (((total_turns_played() % 11) - 1 + 11) % 11);
        
        optional_task_entries.listAppend(ChecklistEntryMake(576, "__item &quot;I Voted!&quot; sticker", "", ChecklistSubentryMake("Voting monster after " + pluralise(turns_left, "More Turn", "more turns") + "", "", "Free fight to burn delay with."), 10));
    }
    if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5 && get_property_int("_voteFreeFights") >= 3 && total_turns_played() % 11 == 1 && get_property_int("lastVoteMonsterTurn") < total_turns_played() && $skill[meteor lore].have_skill() && get_property_int("_macrometeoriteUses") < 10 && !CounterLookup("portscan.edu").CounterWillHitNextTurn() && $location[Sonofa Beach].locationAvailable())
    {
        string title = "Lobsterfrogman voting macrometeorite trick time";
        string [int] description;
        string url = "";
        monster fighting_monster = get_property_monster("_voteMonster");
        if ($item[&quot;I Voted!&quot; sticker].equipped_amount() == 0)
        {
            description.listAppend(HTMLGenerateSpanFont("Equip the I Voted! sticker first.", "red"));
            url = generateEquipmentLink($item[&quot;I Voted!&quot; sticker]);
        }
        description.listAppend("Adventure in the sonofa beach, macrometeorite the " + (fighting_monster == $monster[none] ? "voting monster" : fighting_monster.to_string()) + ", and you'll get a lobsterfrogman.");
        task_entries.listAppend(ChecklistEntryMake(577, "__item &quot;I Voted!&quot; sticker", url, ChecklistSubentryMake(title, "", description), -11));
    	
    }
}

/*RegisterResourceGenerationFunction("IOTMVotingBootGenerateResource");
void IOTMVotingBootGenerateResource(ChecklistEntry [int] resource_entries)
{
	
    if ($item[&quot;I Voted!&quot; sticker].available_amount() == 0) return;
    
    if (get_property_int("_voteFreeFights") < 3 && !(total_turns_played() % 11 == 1 && get_property_int("lastVoteMonsterTurn") < total_turns_played()))
    {
    	
    }
}*/
RegisterTaskGenerationFunction("IOTMBoxingDaycareGenerateTasks");
void IOTMBoxingDaycareGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!__iotms_usable[$item[Boxing Day care package]]) return;
	//collect nap consumable
    ChecklistEntry entry = ChecklistEntryMake(607);
    entry.url = "place.php?whichplace=town_wrong&action=townwrong_boxingdaycare";
    entry.image_lookup_name = "__item orange boxing gloves";
    entry.importance_level = 8;
	if (!get_property_boolean("_daycareNap"))
	{
        entry.subentries.listAppend(ChecklistSubentryMake("Take a daycare nap", "", "Gives a consumable."));
	}
	//scavenge once
	if (get_property_int("_daycareGymScavenges") == 0 && __misc_state["need to level"])
	{
        entry.subentries.listAppend(ChecklistSubentryMake("Scavenge for daycare equipment", "", "Statgain."));
	}
    else if (get_property_int("_daycareRecruits") < 1 && __misc_state["in run"] && $skill[Army of Toddlers].skill_is_usable() && __misc_state["need to level"] && my_meat() >= 100)
    {
        entry.subentries.listAppend(ChecklistSubentryMake("Recruit at the boxing daycare?", "", "100 meat, benefits army of toddlers statgain."));
    }
	if (entry.subentries.count() > 0)
	{
        optional_task_entries.listAppend(entry);
	}
}

RegisterResourceGenerationFunction("IOTMBoxingDaycareGenerateResource");
void IOTMBoxingDaycareGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!__iotms_usable[$item[Boxing Day care package]]) return;
	//buffs
	if (!get_property_boolean("_daycareSpa"))
	{
		string [int] description;
        if (in_ronin())
        {
        	description.listAppend("+200% muscle, +15 ML");
            description.listAppend("+200% moxie, +50% init");
            description.listAppend("+200% myst, +25% item");
            description.listAppend("+100 HP, +50 MP, +25 DR, +~8 MP regen, +~15 HP regen");
        }
        else
            description.listAppend("+200% myst, +25% item");
		resource_entries.listAppend(ChecklistEntryMake(608, "__item orange boxing gloves", "place.php?whichplace=town_wrong&action=townwrong_boxingdaycare", ChecklistSubentryMake("Boxing daycare buff (100 turns)", description), 5).ChecklistEntryTag("boxing daycare").ChecklistEntrySetShortDescription("blank").ChecklistEntrySetCategory("buff"));
	}
	if (hippy_stone_broken() && !get_property_boolean("_daycareFights") && !__misc_state["in run"])
	{
		string [int] description;
        description.listAppend("Costs one adventure. Spar.");
        
        int toddler_number = get_property_int("daycareToddlers"); 
        if (toddler_number <= 2)
        	description.listAppend("Should recruit first.");
        int fights_gained = clampi(2 * toddler_number.to_string().length(), 2, 11); //log/ln not available in mafia, use strings
        //description.listAppend("+" + fights_gained + " fights.");
        resource_entries.listAppend(ChecklistEntryMake(609, "__item orange boxing gloves", "place.php?whichplace=town_wrong&action=townwrong_boxingdaycare", ChecklistSubentryMake("+" + fights_gained + " Boxing daycare PVP fights", description), 5).ChecklistEntryTag("boxing daycare").ChecklistEntrySetShortDescription("+" + fights_gained));
		
	}
	if (__misc_state["in run"] && $skill[Army of Toddlers].skill_is_usable() && !get_property_boolean("_armyToddlerCast") && __misc_state["need to level"])
	{
		string [int] description;
        //is this mainstat or what
        float total_statgain = sqrt(get_property_int("daycareToddlers"));// * (1.0 + numeric_modifier(my_primestat() + " experience percent") / 100.0);
        float [stat] split_statgain = {$stat[muscle]:total_statgain * 0.25, $stat[mysticality]:total_statgain * 0.25, $stat[moxie]:total_statgain * 0.25};
        split_statgain[my_primestat()] = total_statgain * 0.5;
        foreach s, v in split_statgain
        {
        	split_statgain[s] = v * (1.0 + numeric_modifier(s + " experience percent") / 100.0);
        }
        string [int] stats_out;
        stats_out.listAppend(split_statgain[$stat[muscle]].roundForOutput(0));
        stats_out.listAppend(split_statgain[$stat[mysticality]].roundForOutput(0));
        stats_out.listAppend(split_statgain[$stat[moxie]].roundForOutput(0));
        
        description.listAppend("50 MP, gain " + stats_out.listJoinComponents(" / ") + " stats.");
        if (split_statgain[my_primestat()] < 3.0 || get_property_int("daycareToddlers") <= 2)
        	description.listAppend("Might want to recruit first.");
        resource_entries.listAppend(ChecklistEntryMake(610, "__skill Army of Toddlers", "", ChecklistSubentryMake("Army of Toddlers castable", description), 5).ChecklistEntryTag("boxing daycare"));
		
	}
}
RegisterTaskGenerationFunction("IOTMKramcoSausageOMaticGenerateTasks");
void IOTMKramcoSausageOMaticGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (!$item[Kramco Sausage-o-Matic&trade;].have()) return;
    if (!__misc_state["can equip just about any off-hand"]) return;
    
    if (!__misc_state["in run"]) return;
    //If goblin is up, display reminder:
    KramcoSausageFightInformation fight_information = KramcoCalculateSausageFightInformation();
    if (fight_information.turns_to_next_guaranteed_fight == 0 && my_path_id() != PATH_LIVE_ASCEND_REPEAT && __misc_state["in run"])
    {
        
        string url = "";
        string [int] description;
        string title = "Fight sausage goblin ";
        if ($item[Kramco Sausage-o-Matic&trade;].equipped_amount() == 0)
        {
            description.listAppend(HTMLGenerateSpanFont("Equip the Kramco Sausage-o-Matic&trade; first.", "red"));
            url = generateEquipmentLink($item[kramco sausage-o-matic&trade;]);
        }
        description.listAppend("Free fight that burns delay.");
        location [int] possible_locations = generatePossibleLocationsToBurnDelay();
        if (possible_locations.count() > 0)
        {
            description.listAppend("Adventure in " + possible_locations.listJoinComponents(", ", "or") + " to burn delay.");
            if (url == "")
                url = possible_locations[0].getClickableURLForLocation();
        }
        task_entries.listAppend(ChecklistEntryMake(566, "__item Kramco Sausage-o-Matic&trade;", url, ChecklistSubentryMake(title, "", description), -11));
    }
    int sausages_eaten = get_property_int("_sausagesEaten");
    if ($item[magical sausage].have() && sausages_eaten < 23 && __misc_state["can eat just about anything"])
    {
    	string title;
        string description;
        title = "Eat " + pluralise(MIN($item[magical sausage].available_amount(), 23 - sausages_eaten), "magical sausage", "magical sausages");
        description = "+1 adventure each.";
        optional_task_entries.listAppend(ChecklistEntryMake(567, "__item magical sausage", "inventory.php?which=1", ChecklistSubentryMake(title, "", description), 8));
    }
}

RegisterResourceGenerationFunction("IOTMKramcoSausageOMaticGenerateResource");
void IOTMKramcoSausageOMaticGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!$item[Kramco Sausage-o-Matic&trade;].have()) return;
    if (!__misc_state["can equip just about any off-hand"]) return;
	
	if (my_path_id() == PATH_LIVE_ASCEND_REPEAT) return;
    ChecklistEntry entry = ChecklistEntryMake(568);
    entry.image_lookup_name = "__item Kramco Sausage-o-Matic&trade;";
    entry.url = "inventory.php?action=grind";
    entry.url = generateEquipmentLink($item[Kramco Sausage-o-Matic&trade;]);
    entry.importance_level = -2;
    
    
    string [int] main_description;
    string main_title = "Kramco Sausage-o-Matic&trade; fights";
    
    KramcoSausageFightInformation fight_information = KramcoCalculateSausageFightInformation();
    
    
    
    
    if (fight_information.turns_to_next_guaranteed_fight == 0)
    {
	    main_title = "Sausage goblin fight now";
     	entry.ChecklistEntrySetShortDescription("now");   
    }
    else
    	main_title = pluralise(fight_information.turns_to_next_guaranteed_fight, "turn", "turns") + " until next guaranteed sausage goblin fight";
    if (fight_information.turns_to_next_guaranteed_fight > 0)
    {
	    main_description.listAppend(round(fight_information.probability_of_sausage_fight * 100.0) + "% chance of goblin fight this turn.");
        
        //too confusing to switch
        //if (fight_information.turns_to_next_guaranteed_fight >= my_adventures() || fight_information.turns_to_next_guaranteed_fight >= 50)
	     	//entry.ChecklistEntrySetShortDescription(round(fight_information.probability_of_sausage_fight * 100.0) + "%");   
    }
    main_description.listAppend("Does not cost a turn, burns delay.");
       
    int fights_so_far = get_property_int("_sausageFights");
    if (fights_so_far > 0)
	    main_description.listAppend("Fought " + pluralise(fights_so_far, "goblin", "goblins") + " so far.");
     
     
	
	if (fight_information.turns_to_next_guaranteed_fight > 0)
	{
		string second_stage = "if you keep the grinder equipped";
        if (!$item[Kramco Sausage-o-Matic&trade;].equipped())
        	second_stage = "if you equip and keep on the grinder";
		main_description.listAppend("~" + fight_information.average_turns_to_next_sausage_fight_if_continually_equipped.roundForOutput(1) + " turns to encounter a goblin, " + second_stage + ".");
    }
    
    entry.subentries.listAppend(ChecklistSubentryMake(main_title, "", main_description));
	if ($item[magical sausage casing].available_amount() > 0 && __misc_state["in run"])
	{
        //FIXME
        string [int] sausage_description;
        int sausages_made = get_property_int("_sausagesMade");
        int meat_cost = 111 * (sausages_made + 1);
        sausage_description.listAppend("+1 adventures each.");
        sausage_description.listAppend("Currently costs " + meat_cost + " meat to make one.");
    	entry.subentries.listAppend(ChecklistSubentryMake(pluralise($item[magical sausage casing].available_amount(), "magical sausage", "magical sausages") + " creatable", "", sausage_description));
	}
	
	
	resource_entries.listAppend(entry);
	
	
    //resource_entries.listAppend(ChecklistEntryMake(569, "__item Kramco Sausage-o-Matic&trade;", "", ChecklistSubentryMake(title, "", "Free run/banish."), 6));
}
RegisterGenerationFunction("IOTMLilDoctorBagGenerate");
void IOTMLilDoctorBagGenerate(ChecklistCollection checklists)
{
    if (!$item[Lil' Doctor&trade; bag].have()) return;
    //Quest:
    
    if (QuestState("questDoctorBag").in_progress)
    {
    	item required_item = get_property_item("doctorBagQuestItem");
    	location target_location = get_property_location("doctorBagQuestLocation");
     
     	string [int] description;
        description.listAppend("Adventure in " + target_location + ". Free runs/delay burning helps.");
        if (required_item.item_amount() == 0)
        	description.listAppend("Acquire a " + required_item + " first.");
     
     	description.listAppend("Reward is marginal.");
        checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(554, "__item Lil' Doctor&trade; bag", target_location.getClickableURLForLocation(), ChecklistSubentryMake("Lil' Doctor quest", "", description), 11, locationToLocationMap(target_location)));   
    }
    
	//Otoscope: +200% item
    int otoscopes_left = clampi(3 - get_property_int("_otoscopeUsed"), 0, 3);
    if (otoscopes_left > 0 && __misc_state["in run"])
    {
        string url;
        string [int] description;
        description.listAppend("+200% item for one turn, cast in combat.");
        
        url = generateEquipmentLink($item[Lil' Doctor&trade; bag]);
        if ($item[Lil' Doctor&trade; bag].equipped_amount() == 0)
        {
            description.listAppend("Equip the Lil'l Doctor bag first.");
        }
        //if (snojo_skill_entry.image_lookup_name == "")
            //snojo_skill_entry.image_lookup_name = "__skill shattering punch";
        checklists.add(C_RESOURCES, ChecklistEntryMake(555, "__item Lil' Doctor&trade; bag", url, ChecklistSubentryMake(pluralise(otoscopes_left, "otoscope", "otoscopes"), "", description), 8).ChecklistEntrySetSpecificImage("__skill otoscope"));
    }
	//Chest X-Ray: instakill
    int instakills_left = clampi(3 - get_property_int("_chestXRayUsed"), 0, 3);
    if (instakills_left > 0)
    {
    	string url;
        string [int] description;
        description.listAppend("Win a fight without taking a turn.");
        
        url = generateEquipmentLink($item[Lil' Doctor&trade; bag]);
        if ($item[Lil' Doctor&trade; bag].equipped_amount() == 0)
        {
        	description.listAppend("Equip the Lil'l Doctor bag first.");
        }
        //if (snojo_skill_entry.image_lookup_name == "")
            //snojo_skill_entry.image_lookup_name = "__skill shattering punch";
        checklists.add(C_RESOURCES, ChecklistEntryMake(556, "__item Lil' Doctor&trade; bag", url, ChecklistSubentryMake(pluralise(instakills_left, "chest x-ray", "chest x-rays"), "", description), 0).ChecklistEntryTag("free instakill").ChecklistEntrySetSpecificImage("__skill chest x-ray"));
        
    }
	//Reflex Hammer: Banish
    int banishes_left = clampi(3 - get_property_int("_reflexHammerUsed"), 0, 3);
    if (banishes_left > 0)
    {
        string url;
        string [int] description;
        description.listAppend("Free run/banish.");
        Banish banish_entry = BanishByName("Reflex Hammer");
        int turns_left_of_banish = banish_entry.BanishTurnsLeft();
        if (turns_left_of_banish > 0)
        {
            //is this relevant? we don't describe this for pantsgiving
            description.listAppend("Currently used on " + banish_entry.banished_monster + " for " + pluralise(turns_left_of_banish, "more turn", "more turns") + ".");
        }
        url = generateEquipmentLink($item[Lil' Doctor&trade; bag]);
        if ($item[Lil' Doctor&trade; bag].equipped_amount() == 0)
        {
            description.listAppend("Equip the Lil'l Doctor bag first.");
        }
        checklists.add(C_RESOURCES, ChecklistEntryMake(557, "__item Lil' Doctor&trade; bag", url, ChecklistSubentryMake(pluralise(banishes_left, "reflex hammer", "reflex hammers"), "", description), 0).ChecklistEntryTag("free banish").ChecklistEntrySetSpecificImage("__skill reflex hammer"));
    }
}
RegisterTaskGenerationFunction("IOTMMaySaberPartyGenerateTasks");
void IOTMMaySaberPartyGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if ($item[Fourth of May Cosplay Saber].available_amount() == 0) return;
    if (!__misc_state["can equip just about any weapon"]) return;
    if (get_property_int("_saberMod") == 0)
    {
    	string [int] options;
        if (in_ronin())
        {
	        options.listAppend("Regen ~17 MP/adventure.");
        	options.listAppend("+20 ML.");
        	options.listAppend("+3 all resistances.");
        }
        options.listAppend("+10 familiar weight.");
        
    	string [int] description;
        if (options.count() > 1)
	        description.listAppend("Choose one of:|*" + options.listJoinComponents("|*"));
        else
        	description.listAppend(options.listJoinComponents("|"));
        optional_task_entries.listAppend(ChecklistEntryMake(500, "__item Fourth of May Cosplay Saber", "main.php?action=may4", ChecklistSubentryMake("Modify your lightsaber", "", description), 8));
    }
    monster saber_monster = get_property_monster("_saberForceMonster");
    if (saber_monster != $monster[none] && get_property_int("_saberForceMonsterCount") > 0)
    {
    	string [int] description;
        int fights_left = clampi(get_property_int("_saberForceMonsterCount"), 0, 3);
        string url = "";
        location [int] possible_appearance_locations = saber_monster.getPossibleLocationsMonsterCanAppearInNaturally().listInvert();
        
        description.listAppend("Will appear when you adventure in " + possible_appearance_locations.listJoinComponents(", ", "or") + ".");
        if (possible_appearance_locations.count() > 0)
        	url = possible_appearance_locations[0].getClickableURLForLocation(); 
        optional_task_entries.listAppend(ChecklistEntryMake(501, "__monster " + saber_monster, url, ChecklistSubentryMake("Fight " + pluralise(fights_left, "more " + saber_monster, "more " + saber_monster + "s"), "", description), -1));
    }
}

RegisterResourceGenerationFunction("IOTMMaySaberGenerateResource");
void IOTMMaySaberGenerateResource(ChecklistEntry [int] resource_entries)
{
	if ($item[Fourth of May Cosplay Saber].available_amount() == 0) return;
    if (!__misc_state["can equip just about any weapon"]) return;
	if (get_property_int("_saberForceUses") < 5)
	{
		int uses_remaining = clampi(5 - get_property_int("_saberForceUses"), 0, 5);
		string url = generateEquipmentLink($item[Fourth of May Cosplay Saber]);
        string [int] description;
        description.listAppend("Use the force skill in combat, which lets you:");
        description.listAppend("Banish a monster for thirty turns.");
        description.listAppend("Make the monster appear 3x times in the zone.");
        description.listAppend("Or collect all* their items.");
        if (my_path_id() == PATH_COMMUNITY_SERVICE && $skill[Meteor Lore].have_skill())
        {
        	description.listAppend("Bonus! Use Meteor Shower + lightsaber skill to save a bunch of turns on weapon damage/spell damage/familiar weight tests.");
        }
        //description.listAppend("Choose one of:|*" + options.listJoinComponents("|*"));
        resource_entries.listAppend(ChecklistEntryMake(502, "__item Fourth of May Cosplay Saber", url, ChecklistSubentryMake(pluralise(uses_remaining, "force use", "forces uses"), "", description), 0));
		
	}
	
}

RegisterResourceGenerationFunction("IOTMVampireCloakGenerateResource");
void IOTMVampireCloakGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$item[vampyric cloake].have())
		return;
    if (!(__misc_state["in run"] && in_ronin())) return;
    
    int uses_left = clampi(10 - get_property_int("_vampyreCloakeFormUses"), 0, 10);
    if (uses_left > 0 && my_path_id() != PATH_POCKET_FAMILIARS)
	{
		string [int] skills;
        skills.listAppend("Wolf: +50% muscle, +50% meat");
        skills.listAppend("Mist: +2 all res");
        skills.listAppend("Bat: +50% item");
        
        string url = generateEquipmentLink($item[vampyric cloake]);
		string [int] description;
        description.listAppend("In-combat cast one of the Become skills, to gain a buff for that fight:|*" + skills.listJoinComponents("|*"));
        resource_entries.listAppend(ChecklistEntryMake(589, "__item vampyric cloake", url, ChecklistSubentryMake(pluralise(uses_left, "vampyric skill use", "vampyric skill uses"), "", description), 5));
    }
}

RegisterResourceGenerationFunction("IOTMBeachCombGenerateResource");
void IOTMBeachCombGenerateResource(ChecklistEntry [int] resource_entries)
{
	if ($item[beach comb].available_amount() == 0) return;
	int free_walks_left = clampi(11 - get_property_int("_freeBeachWalksUsed"), 0, 11);
	if (free_walks_left > 0)
	{
		boolean [int] beach_heads_used = get_property("_beachHeadsUsed").stringToIntIntList(",").listInvert();
        
        string [int] description;
        string [int] buffs;
        
        string [int] elemental_buffs;
        boolean in_run = __misc_state["in run"];
        if (!beach_heads_used[1])
        	elemental_buffs.listAppend(HTMLGenerateSpanOfClass("Hot-Headed", "r_element_hot"));
        if (!beach_heads_used[2])
            elemental_buffs.listAppend(HTMLGenerateSpanOfClass("Cold as Nice", "r_element_cold"));
        if (!beach_heads_used[3])
            elemental_buffs.listAppend(HTMLGenerateSpanOfClass("A Brush with Grossness", "r_element_stench"));
        if (!beach_heads_used[4])
            elemental_buffs.listAppend(HTMLGenerateSpanOfClass("Does It Have a Skull In There??", "r_element_spooky"));
        if (!beach_heads_used[5])
            elemental_buffs.listAppend(HTMLGenerateSpanOfClass("Oiled\, Slick", "r_element_sleaze"));
        
        if (elemental_buffs.count() > 0 && in_run)
            buffs.listAppend("<strong>" + elemental_buffs.listJoinComponents(" / ") + ":</strong> +3 X resistance, +15 X damage, +15 X spell damage.");
        if (!beach_heads_used[6] && in_run)
        	buffs.listAppend("<strong>Lack of Body-Building:</strong> +50% muscle, +25% weapon damage."); //<strong> hah
        if (!beach_heads_used[7] && in_run)
            buffs.listAppend("<strong>We're All Made of Starfish:</strong> +50% myst, +25% spell damage.");
        if (!beach_heads_used[8] && in_run)
            buffs.listAppend("<strong>Pomp & Circumsands:</strong> +50% moxie, +25% ranged damage.");
        if (!beach_heads_used[9] && in_run)
            buffs.listAppend("<strong>Resting Beach Face:</strong> +50% init.");
        if (!beach_heads_used[10])
            buffs.listAppend("<strong>Do I Know You From Somewhere?:</strong> +5 familiar weight.");
        if (!beach_heads_used[11] && in_run)
            buffs.listAppend("<strong>You Learned Something Maybe!:</strong> +5 stats/fight.");
        
        if (buffs.count() > 0)
	        description.listAppend("Buffs:<hr>" + buffs.listJoinComponents("<hr>"));
        if (free_walks_left >= 10)
        	description.listAppend((description.count() > 0 ? "Or collect" : "Collect") + " a bunch of items? (10 walks)");
        description.listAppend("Or farm the beach.");
        resource_entries.listAppend(ChecklistEntryMake(544, "__item beach comb", "main.php?comb=1", ChecklistSubentryMake(pluralise(free_walks_left, "beach comb", "beach combs"), "", description), 3).ChecklistEntrySetCategory("buff")); //moving it over to buff from equipment. we thought about doing the same to powerful glove, but no
    }
}

RegisterResourceGenerationFunction("IOTMGetawayCampsiteGenerateResource");
void IOTMGetawayCampsiteGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!__iotms_usable[$item[Distant Woods Getaway Brochure]]) return;
	
	item firewood = $item[stick of firewood];
	int cloud_buffs_left = clampi(1 - get_property_int("_campAwayCloudBuffs"), 0, 1);
    int smile_buffs_left = clampi(3 - get_property_int("_campAwaySmileBuffs"), 0, 3);
    
    if (cloud_buffs_left > 0)// && $effect[That's Just Cloud-Talk, Man].have_effect() == 0)
    {
    	string [int] description;
        description.listAppend("Large +stat buff. Gaze at the stars.");
        if (firewood.have() || $item[campfire smoke].have())
        	description.listAppend("If you don't see it, you could make and use campfire smoke, first.");
        resource_entries.listAppend(ChecklistEntryMake(535, "__item Newbiesport&trade; tent", "place.php?whichplace=campaway", ChecklistSubentryMake("Cloud-talk buff obtainable", "", description), 0).ChecklistEntryTag("getaway campsite").ChecklistEntrySetCategory("buff").ChecklistEntrySetSpecificImage("__effect That's Just Cloud-Talk, Man"));
    }
    if (smile_buffs_left > 0)// && $effect[That's Just Cloud-Talk, Man].have_effect() == 0)
    {
        resource_entries.listAppend(ChecklistEntryMake(536, "__item Newbiesport&trade; tent", "place.php?whichplace=campaway", ChecklistSubentryMake(pluralise(smile_buffs_left, "smile buff", "smile buffs") + " obtainable", "", "Various minor effects. Gaze at the stars."), 5).ChecklistEntryTag("getaway campsite").ChecklistEntrySetCategory("buff").ChecklistEntrySetSpecificImage("__effect Smile of the " + my_sign()));
    }
    if (firewood.have() && __misc_state["in run"])
    {
    	string [int] description;
     
        string [int] various_options;
        if (__misc_state["can eat just about anything"])
        	various_options.listAppend("food");
        if (firewood.available_amount() >= 5 && my_path_id() != PATH_GELATINOUS_NOOB)
        {
            if (!$item[whittled tiara].have())
            	various_options.listAppend("whittled tiara for +elemental damage");
            if (!$item[whittled shorts].have())
                various_options.listAppend("whittled shorts for +2 all res");
            if (!$item[whittled flute].have())
                various_options.listAppend("whittled flute for +25% meat");
            if (firewood.available_amount() >= 10)
            {
            	if (!$item[whittled bear figurine].have() && !__misc_state["familiars temporarily blocked"])
                    various_options.listAppend("whittled bear figurine for +5 familiar weight");
                if (!$item[whittled owl figurine].have())
                    various_options.listAppend("whittled owl figurine for +20 ML");
                if (!$item[whittled fox figurine].have())
                    various_options.listAppend("whittled fox figurine figurine for +50% init");
            }
            if (firewood.available_amount() >= 100 && !$item[whittled walking stick].have())
                various_options.listAppend("whittled walking stick for a bunch of stuff");
        }
        if (various_options.count() > 0)
        	description.listAppend(various_options.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
        resource_entries.listAppend(ChecklistEntryMake(537, "__item Newbiesport&trade; tent", "shop.php?whichshop=campfire", ChecklistSubentryMake(pluralise(firewood), "", description), 5).ChecklistEntryTag("getaway campsite").ChecklistEntrySetSpecificImage("__item " + firewood));
    }
}

//moonTuned
RegisterResourceGenerationFunction("IOTMRuneSpoonGenerateResource");
void IOTMRuneSpoonGenerateResource(ChecklistEntry [int] resource_entries)
{
	item spoon = $item[hewn moon-rune spoon];
	if (!spoon.have() && spoon.closet_amount() == 0) return;
	
	if (!get_property_boolean("moonTuned"))
	{
		stat [string] stat_for_sign = 
        {
        	"Mongoose":$stat[Muscle],
            "Wallaby":$stat[Mysticality],
            "Vole":$stat[Moxie],
            
            "Platypus":$stat[Muscle],
            "Opossum":$stat[Mysticality],
            "Marmot":$stat[Moxie],
            
            "Wombat":$stat[Muscle],
            "Blender":$stat[Mysticality],
            "Packrat":$stat[Moxie],
        };
		string [string] signs = 
        {
            "Mongoose":"+20% physical damage, knoll access, and free smithing",
            "Wallaby":"+20% spell damage, knoll access, and free smithing",
            "Vole":"+20% init, knoll access, and free smithing",
            
            "Platypus":"+5 familiar weight and canadia access",
            "Opossum":"+5 adventures/day from food and canadia access",
        	"Marmot":"+1 extra clover/day and canadia access",
            
            "Wombat":"+20% meat and gnome access",
            "Blender":"+5 adventures/day from drinks and gnome access",
            "Packrat":"+10% item and gnome access",
            
        };
        boolean [string] signs_to_output_as_ideas = $strings[Marmot,Platypus,Opossum,Blender,Packrat];
        
        if (!__misc_state["in run"])
        	signs_to_output_as_ideas = $strings[Platypus,Opossum,Wombat,Blender,Packrat];
        boolean our_sign_is_currently_good_for_stats = stat_for_sign[my_sign()] == my_primestat();
		string [int] description;
        description.listAppend("Use the hewn moon-rune spoon. Lets you switch to any other moon sign.");
        if ($strings[Mongoose,Wallaby,Vole] contains my_sign())
        {
        	string [int] todo;
        	if (!__misc_state["desert beach available"])
        		todo.listAppend("assemble a bitchin' meatcar");
            if (!have_outfit_components("Bugbear Costume"))
                todo.listAppend("buy a bugbear costume");
            if (todo.count() > 0)
            	description.listAppend("May want to " + todo.listJoinComponents(", ", "and") + " before switching signs.");
        }
        string [int] options;
        
        foreach sign, desc in signs
        {
        	if (my_sign() == sign) continue;
            if (!signs_to_output_as_ideas[sign]) continue;
            if (sign == "Platypus" && __misc_state["familiars temporarily blocked"]) continue;
            if (sign == "Opossum" && (!__misc_state["can eat just about anything"] || my_path_id() == PATH_SLOW_AND_STEADY)) continue;
            if (sign == "Blender" && (!__misc_state["can drink just about anything"] || my_path_id() == PATH_SLOW_AND_STEADY)) continue;
        	boolean this_sign_is_good_for_mainstat_gain = stat_for_sign[sign] == my_primestat();
            string line = "<strong>" + sign + "</strong>: " + desc + ".";
            if (!this_sign_is_good_for_mainstat_gain && __misc_state["need to level"] && __misc_state["in run"])
            	line += " <strong>Won't</strong> give mainstat gains.";
            else if (this_sign_is_good_for_mainstat_gain && __misc_state["need to level"] && __misc_state["in run"])
            	line += " <strong>Will</strong> give mainstat gains."; 
        	options.listAppend(line);
        }
        
        description.listAppend("Currently " + my_sign() + ": " + signs[my_sign()] + ".");
        if (options.count() > 0)
	        description.listAppend("Ideas:|*" + options.listJoinComponents("<hr>"));
        
        string url = "inv_use.php?whichitem=10254&pwd=" + my_hash();
        if (!spoon.have() && spoon.closet_amount() > 0)
        	url = "closet.php?which=2";
		resource_entries.listAppend(ChecklistEntryMake(461, "__item " + spoon, url, ChecklistSubentryMake("Moon sign tunable", "", description), 10));
	}
}

RegisterGenerationFunction("IOTMPocketProfessorGenerate");
void IOTMPocketProfessorGenerate(ChecklistCollection checklists)
{
	if (!$familiar[pocket professor].familiar_is_usable()) return;
	/*
	Three lectures:
	-velocity: devels monster, gives stats. should we even mention it...?
	-mass: increases item drops?
	-relativity: chained combat, can burn delay in areas with >= 2 delay or more
	
	"%fn, deliver your thesis!" is available when the pocket professor has >= 400 experience (20lb). Removes 200 experience, gives 2-11 adventures depending on monster HP.
	
	The wiki's explanation of the memory chip seems... complex? Like, it seems to imply that it isn't just a flat +2 lectures, instead doing Strange Things that somehow involve memory of when you used the memory chip? I suppose I should ask erosionseeker, the editor.
     */
     
    //_pocketProfessorLectures
    
    //X lectures, description
    //Thesis delivery?
    //Handle (astral pet sweater on professor) -> (memory chip)
    
    int pocket_professor_lectures_property_value = get_property_int("_pocketProfessorLectures");
    int familiar_weight_for_next_lecture = pocket_professor_lectures_property_value * pocket_professor_lectures_property_value + 1;
    if ($item[Pocket Professor memory chip].have())
    	familiar_weight_for_next_lecture = MAX(1, (pocket_professor_lectures_property_value - 2) * (pocket_professor_lectures_property_value - 2) + 1); //is this right?
    
    //familiar_equipped_equipment(my_familiar()).numeric_modifier("familiar weight")
    
    //How to handle this calculation?
    //numeric_modifier("familiar weight"); gives the familiar weight - base weight
    //(also the feast)
    //$item[hypodermic needle].numeric_modifier("familiar weight") is 5.0. does it affect numeric_modifier("familiar weight")
    //int familiar_weight_from_familiar_equipment = $slot[familiar].equipped_item().numeric_modifier("familiar weight");
    
    //effective_familiar_weight
    int estimated_professor_weight = -1;
    if (my_familiar() == $familiar[pocket professor])
    {
    	estimated_professor_weight = $familiar[pocket professor].effective_familiar_weight() + numeric_modifier("familiar weight");
        if ($item[Pocket Professor memory chip].have())
        {
        	item current_familiar_equipped_equipment = $familiar[pocket professor].familiar_equipped_equipment();
            /*if (current_familiar_equipped_equipment != $item[Pocket Professor memory chip])
            {
            	estimated_professor_weight -= current_familiar_equipped_equipment.numeric_modifier("familiar weight"); 
            }*/
        }
    }
    else
    {
    	estimated_professor_weight = $familiar[pocket professor].effective_familiar_weight() + numeric_modifier("familiar weight");
        item current_familiar_equipped_equipment = my_familiar().familiar_equipped_equipment();
        if (current_familiar_equipped_equipment == my_familiar().familiar_equipment()) //Test if its bonus is limited to this familiar. Note: is this always true? bugbear?
        {
        	estimated_professor_weight -= current_familiar_equipped_equipment.numeric_modifier("familiar weight"); 
        }
        //we can't have the familiar weight if we're chipping
        else if ($familiar[pocket professor].familiar_equipped_equipment() == $item[Pocket Professor memory chip])
        {
        	estimated_professor_weight -= current_familiar_equipped_equipment.numeric_modifier("familiar weight");
        }
        if (false)
        {
        	//this was going to be code for like, let's say you have the astral pet sweater in inventory, but your current familiar didn't have it equipped
            //add that to the estimate
            //but, that would be confusing because it isn't what you have right now, at this moment, if you switch over
            //so no
            int current_familiar_equipped_equipment_familiar_weight_increase = current_familiar_equipped_equipment.numeric_modifier("familiar weight");
            if (false)
            {
            	boolean [item] specialised_equipment;
            	foreach f in $familiars[]
                {
                	specialised_equipment[f.familiar_equipment()] = true;
                }
                foreach it in $items[]
                {
                    if (it.to_slot() != $slot[familiar]) continue;
                    if (specialised_equipment[it]) continue;
                    if (it.numeric_modifier("familiar weight") == 0) continue;
                    print_html(it + ": " + it.numeric_modifier("familiar weight")); 
                }
            }
        }
    }
    
    int lectures_estimated_weight_can_support = floor(sqrt(estimated_professor_weight - 1)) + 1;
    int base_lectures_estimated_weight_can_support = lectures_estimated_weight_can_support;
    
    if ($familiar[pocket professor].familiar_equipped_equipment() == $item[Pocket Professor memory chip])
    	lectures_estimated_weight_can_support += 2;
    
    int next_lecture_weight = -1;
    int weight_to_next_lecture = -1;
    string lecture_title = "";
    string shortdesc = "";
	string [int] description;
	boolean can_lecture_now = false;
    if (lectures_estimated_weight_can_support > pocket_professor_lectures_property_value)
    {
    	int lectures_left = lectures_estimated_weight_can_support - pocket_professor_lectures_property_value;
        shortdesc = lectures_left;
        if (my_familiar() != $familiar[pocket professor])
        	lecture_title += "~";
        lecture_title += pluralise(lectures_left, "Pocket Professor lecture", "Pocket Professor lectures");
        can_lecture_now = true;
        next_lecture_weight = base_lectures_estimated_weight_can_support * base_lectures_estimated_weight_can_support + 1;
        weight_to_next_lecture = next_lecture_weight - estimated_professor_weight;
    }
    else
    {
    	//FIXME handle memory chip here
        weight_to_next_lecture = familiar_weight_for_next_lecture - estimated_professor_weight;
        lecture_title = "+" + weight_to_next_lecture + "lb to next Pocket Professor Lecture";
        description.listAppend(familiar_weight_for_next_lecture + "lb total.");
    }
    string monster_detail = ""; //"|*They did the mash.";
    
    if ($item[Kramco Sausage-o-Matic&trade;].have())
    	monster_detail += "|*Combines well with Kramco.";
    description.listAppend("<strong>Relativity</strong>: Creates a chained combat; useful for copying monsters or burning delay with free monsters." + monster_detail);
    description.listAppend("<strong>Mass</strong>: Triple items dropped from monster.");
    
    string last_monster_velocity_info = "";
    monster last_monster = last_monster();
    if (last_monster != $monster[none])
    {
    	float v = clampi(0.1 * last_monster.base_attack + 0.33 * estimated_professor_weight, 0, 150);
        last_monster_velocity_info = "|*Maybe ~" + v.round() + " " + my_primestat().to_lower_case() + " substats.";
    }
    description.listAppend("<strong>Velocity</strong>: Delevels + mainstats from weight/monster attack." + last_monster_velocity_info);
    
    if (can_lecture_now)
    	description.listAppend("+" + weight_to_next_lecture + "lb (" + next_lecture_weight + "lb total) for more lectures.");
    else
    	description.listAppend("Increase familiar weight for more lectures.");
    //If we don't have enough weight, display how much weight the professor needs until next lecture.
    
	string url = "";
	if (my_familiar() != $familiar[pocket professor])
		url = "familiar.php";
	
	if ($item[Pocket Professor memory chip].have() && $item[Pocket Professor memory chip].can_equip() && $familiar[pocket professor].familiar_equipped_equipment() != $item[Pocket Professor memory chip])
	{
		description.listAppend(HTMLGenerateSpanFont("Equip the Pocket Professor memory chip.", "red"));
	}
	checklists.add(C_RESOURCES, ChecklistEntryMake(511, "__familiar Pocket Professor", url, ChecklistSubentryMake(lecture_title, "", description), -1).ChecklistEntryTag("Pocket Professor").ChecklistEntrySetShortDescription(shortdesc));
	
	if (!get_property_boolean("_thesisDelivered") && $familiar[Pocket Professor].experience >= 400)
	{
		string [int] description;
        string adventure_detail;
        if (last_monster != $monster[none])
        {
        	//from wiki:
        	//min(2*floor(monster HP^0.25),11)
            float v = clampi(floor(powf(last_monster.base_attack, 0.25)), 2, 11);
            adventure_detail = "|*Maybe ~" + v.round() + " adventures.";
        }
        description.listAppend("Gives extra adventures from monster attack, and reduces the professor's experience by 200. (-6lb)" + adventure_detail);
        checklists.add(C_RESOURCES, ChecklistEntryMake(512, "__familiar Pocket Professor", url, ChecklistSubentryMake("Thesis delivery", "", description), -1).ChecklistEntryTag("Pocket Professor").ChecklistEntrySetShortDescription("thesis"));
	}
}

RegisterResourceGenerationFunction("IOTMEightDaysAweekPillKeeperGenerateResource");
void IOTMEightDaysAweekPillKeeperGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$item[Eight Days a Week Pill Keeper].have()) return;
	
	
	boolean first_one_is_free = !get_property_boolean("_freePillKeeperUsed");
	if (first_one_is_free || availableSpleen() >= 3)
	{
		string [int] description;
        description.listAppend("<strong>Surprise Me</strong>: force semi-rare next turn.");
        description.listAppend("<strong>Sneakisol</strong>: Next adventure will be a non-combat.");
		description.listAppend("<strong>Explodinall</strong>: yellow ray monster, next fight you win.");
        
        string [int] marginals;
		marginals.listAppend("<strong>Extendicillin</strong>: double next potion's effect length.");
        marginals.listAppend("<strong>Rainbowolin</strong>: +4 all res buff. (30 turns)");
        marginals.listAppend("<strong>Hulkien</strong>: +100% all stats buff. (30 turns).");
        marginals.listAppend("<strong>Fidoxene</strong>: +familiar weight buff, up to 20lb base. (30 turns)");
        description.listAppend("Marginal:|*" + marginals.listJoinComponents("|*"));
        //description.listAppend("<strong>Telecybin</strong>: teleportitis."); //technically optimal if you want to unlock the DoD
        //generateEquipmentLink($item[eight days a week pill keeper])
        string short_desc = "";
		if (first_one_is_free)
        {
        	description.listAppend("First one's free.");
         	short_desc = "free";
        }
        else
        {
        	description.listAppend("Costs three spleen.");
         	short_desc = "3spn";
        }
         
        resource_entries.listAppend(ChecklistEntryMake(547, "__item eight days a week pill keeper", "main.php?eowkeeper=1", ChecklistSubentryMake("Pill keeper", "", description), 4).ChecklistEntrySetShortDescription(short_desc));   
	}
}
RegisterGenerationFunction("IOTMRedNosedSnapperGenerate");
void IOTMRedNosedSnapperGenerate(ChecklistCollection checklists)
{
	familiar snapper_familiar = lookupFamiliar("Red-Nosed Snapper");
	if (!snapper_familiar.have_familiar() || __misc_state["familiars temporarily blocked"]) return;
	
	
	//List all(?) combat items
	//Relevant...
	
	
	
	boolean [phylum] blocked_phylums_for_inventory_display = $phylums[penguin,goblin,orc];
	//boolean [phylum] allowed_phylums_for_always_inventory_display = $phylums[dude, horror];
	string [phylum] phylum_reward_description =
	{
		$phylum[none]:"nothing",
        $phylum[orc]:"booze (12.5 adventures)",
        $phylum[constellation]:"yellow ray combat item",
        $phylum[dude]:"free banish combat item",
        $phylum[horror]:"free kill combat item",
        $phylum[plant]:"restore HP combat item",
        $phylum[goblin]:"food (12 adventures)",
        $phylum[beast]:"+5 cold res potion (20 turns)",
        $phylum[demon]:"+5 hot res potion (20 turns)",
        $phylum[elf]:"+50% candy drop potion (20 turns)",
        $phylum[hippy]:"+5 strench res potion (20 turns)",
        $phylum[mer-kin]:"+30% underwater item drop potion (20 turns)",
        $phylum[slime]:"+5 sleaze res potion (20 turns)",
        $phylum[undead]:"+5 spooky res potion (20 turns)",
        $phylum[bug]:"+100% HP, ~9 HP/adv regen spleen item (60 turns)",
        $phylum[construct]:"+150% init spleen item (30 turns)",
        $phylum[elemental]:"+50% max MP, ~4 MP/adv spleen item (60 turns)",
        $phylum[fish]:"Fishy effect - spleen item (30 turns)",
        $phylum[hobo]:"+100% meat drop spleen item (60 turns)",
        $phylum[humanoid]:"+50% muscle exp spleen item (30 turns)",
        $phylum[pirate]:"+50% moxie exp spleen item (30 turns)",
        $phylum[weird]:"+50% myst exp spleen item (30 turns)",
        $phylum[penguin]:"500 meat",
	};
	
	item [phylum] phylum_reward_item =
	{
        $phylum[orc]:lookupItem("boot flask"),
        $phylum[constellation]:lookupItem("micronova"),
        $phylum[dude]:lookupItem("human musk"),
        $phylum[horror]:lookupItem("powdered madness"),
        $phylum[plant]:lookupItem("goodberry"),
        $phylum[goblin]:lookupItem("guffin"),
        $phylum[beast]:lookupItem("patch of extra-warm fur"),
        $phylum[demon]:lookupItem("infernal snowball"),
        $phylum[elf]:lookupItem("peppermint syrup"),
        $phylum[hippy]:lookupItem("organic potpourri"),
        $phylum[mer-kin]:lookupItem("Mer-kin eyedrops"),
        $phylum[slime]:lookupItem("extra-strength goo"),
        $phylum[undead]:lookupItem("unfinished pleasure"),
        $phylum[bug]:lookupItem("a bug's lymph"),
        $phylum[construct]:lookupItem("industrial lubricant"),
        $phylum[elemental]:lookupItem("livid energy"),
        $phylum[fish]:lookupItem("fish sauce"),
        $phylum[hobo]:lookupItem("beggin' cologne"),
        $phylum[humanoid]:lookupItem("vial of humanoid growth hormone"),
        $phylum[pirate]:lookupItem("Shantix"),
        $phylum[weird]:lookupItem("non-Euclidean angle"),
        $phylum[penguin]:lookupItem("envelope full of Meat"),
	};
	
	
	
	phylum [int] phylum_display_order =
	{
        $phylum[dude],
        $phylum[horror],
        $phylum[humanoid],
        $phylum[pirate],
        $phylum[weird],
        $phylum[hobo],
        $phylum[constellation],
        
        $phylum[orc],
        $phylum[plant],
        $phylum[goblin],
        $phylum[beast],
        $phylum[demon],
        $phylum[elf],
        $phylum[hippy],
        $phylum[mer-kin],
        $phylum[slime],
        $phylum[undead],
        $phylum[bug],
        $phylum[construct],
        $phylum[elemental],
        $phylum[fish],
        $phylum[penguin],
	};
	
	string url;
	
	if (my_familiar() == snapper_familiar)
		url = "familiar.php?action=guideme&pwd=" + my_hash();
    else
    	url = "familiar.php";
	string title = "Red-Nosed Snapper";
	string [int] description;
	
	//Show current zone info
	
	phylum current_phylum = get_property("redSnapperPhylum").to_phylum();
	int progress = get_property_int("redSnapperProgress");
	int remaining = clampi(11 - progress, 0, 11);
	location current_location = my_location();
	int musk_uses_remaining = clampi(3 - get_property_int("_humanMuskUses"), 0, 3);
	int madness_uses_remaining = clampi(5 - get_property_int("_powderedMadnessUses"), 0, 5);
	
	
	phylum_reward_description[$phylum[dude]] = "free banish combat item (" + musk_uses_remaining + " free today)";
    phylum_reward_description[$phylum[horror]] = "free kill combat item (" + madness_uses_remaining + " free today)";
	
	monster [phylum][int] current_monsters_by_phylum;
    int total_monster_count = 0;
    if (current_location != $location[none])
    {
        foreach m, rate in current_location.appearance_rates(true)
        {
        	if (rate <= 0.0) continue;
            
            
            current_monsters_by_phylum[m.phylum][current_monsters_by_phylum[m.phylum].count()] = m;
            total_monster_count += 1;
        }
    }
	
	if (current_phylum != $phylum[none])
	{
		description.listAppend("Tracking phylum " + current_phylum + "; " + remaining + " remaining.");
        
        description.listAppend("Rewards " + phylum_reward_item[current_phylum] + ".|*" + phylum_reward_description[current_phylum] + ".");
        
        if (current_monsters_by_phylum[current_phylum].count() > 0)
        {
        	float current_phylum_appearance_rate = 0.0;
            if (total_monster_count != 0)
            	current_phylum_appearance_rate = to_float(current_monsters_by_phylum[current_phylum].count()) / to_float(total_monster_count);
                
            description.listAppend((current_phylum_appearance_rate * 100.0).round() + "% appearance rate in " + current_location);
        	//line += "|*Potential encounters: " + current_monsters_by_phylum[current_phylum].listJoinComponents(", ", "or") + ".";
        }
	}
	
	
	
	
	//Item table will not layout properly as a popup; discarded.
	//string [int][int] item_table;
	//item_table.listAppend(listMake("<strong>Phylum</strong>", "<strong>Reward item</strong>", "<strong>Description</strong>"));
	
	buffer item_table_description;
	boolean first = true;
	foreach key, p in phylum_display_order
	{
		item reward_item = phylum_reward_item[p];
		string reward_item_description = phylum_reward_description[p];
        
        if (first)
        	first = false;
        else
	        item_table_description.append("<hr>");
        item_table_description.append("<strong>" + p + "</strong> - " + reward_item);
        //item_table_description.append("<br>" + reward_item);
        item_table_description.append(HTMLGenerateDivOfClassAndStyle(reward_item_description, "r_indention", "F"));
        
        /*string [int] line;
        line.listAppend(p.to_string().capitaliseFirstLetter());
        line.listAppend(reward_item);
        line.listAppend(reward_item_description);
        
        item_table.listAppend(line);*/
	}
	
	//string item_table_description = HTMLGenerateSimpleTableLines(item_table);
	
	description.listAppend(HTMLGenerateTooltip("Mouse over for all dropped items.", item_table_description.to_string()));
	
	
    checklists.add(C_RESOURCES, ChecklistEntryMake(548, "__familiar Red-Nosed Snapper", url, ChecklistSubentryMake(title, "", description), 1)).ChecklistEntryTag("Red-Nosed Snapper").ChecklistEntrySetCategory("familiar").ChecklistEntrySetShortDescription(remaining);
    
    
    //boolean display_everything = in_ronin();
    if (in_ronin())
    {
    	foreach p, reward_item in phylum_reward_item
        {
        	if (blocked_phylums_for_inventory_display[p]) continue;
        	if (reward_item.available_amount() == 0) continue;
            //if (!display_everything && !allowed_phylums_for_always_inventory_display[p]) continue;
            checklists.add(C_RESOURCES, ChecklistEntryMake(549, "__item " + reward_item, "", ChecklistSubentryMake(pluralise(reward_item), "", phylum_reward_description[p]), 1)).ChecklistEntryTag("Red-Nosed Snapper").ChecklistEntrySetCategory("familiar");
            
        }
    }
	
}
string [int] convertMafiaModifierStringToOurStyle(string modifier_string)
{
	string [int] modifiers;
    foreach key, s in modifier_string.split_string(", ")
    {
        if (s == "") continue;
        string [int] line = s.split_string(": ");
        if (line.count() == 2)
        {
            string value = line[1];
            string modifier = line[0].to_lower_case();
            
            string [string] short_name_for_modifiers = {
            "muscle percent":"muscle",
            "mysticality percent":"mysticality",
            "moxie percent":"moxie",
            "item drop":"item",
            "food drop":"food",
            "damage absorption":"DA",
            "damage reduction":"DR",
            "combat rate":"combat",
            };
            
            if (modifier == "muscle percent" || modifier == "mysticality percent" || modifier == "moxie percent" || modifier == "item drop" || modifier == "food drop" || modifier == "combat rate")
            {
                value += "%";
            }
            if (short_name_for_modifiers contains modifier)
                modifier = short_name_for_modifiers[modifier];
            modifiers.listAppend(value + " " + modifier);
        }
        else
            modifiers.listAppend(s);
    }
	return modifiers;
}

RegisterResourceGenerationFunction("IOTMBirdADayCalendarGenerateResource");
void IOTMBirdADayCalendarGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$item[bird-a-day calendar].have()) return;
	
	//_birdOfTheDay: unknown
	//_birdOfTheDayMods: 
	//_birdsSoughtToday: unknown
	//_canSeekBirds: boolean
	
	int birds_sought_today = get_property_int("_birdsSoughtToday");
	int skill_mp_cost = 5 * powi(2, birds_sought_today);
	string bird_of_the_day = get_property("_birdOfTheDay");
	
	if (true)
	{
    	string [int] modifiers;
        if (bird_of_the_day != "")
	        modifiers = convertMafiaModifierStringToOurStyle(get_property("_birdOfTheDayMods"));
    	string [int] description;
        string url = "skillz.php";
        if (modifiers.count() == 0)
        	modifiers.listAppend("Unknown");
        description.listAppend(modifiers.listJoinComponents(", ") + " buff. (10 turns, " + skill_mp_cost + " mp)");
        if (!get_property_boolean("_canSeekBirds"))
        {
        	description.listAppend("Use your bird-a-day calendar first.");
            url = "inventory.php?which=3&ftext=bird-a-day+calendar";
        }
        
        if (birds_sought_today == 6 && bird_of_the_day != get_property("yourFavoriteBird"))
        {
        	description.listAppend(HTMLGenerateSpanFont("Warning: casting this skill again will make it your favourite bird, which stays across ascension.", "red"));
        }
        	
        resource_entries.listAppend(ChecklistEntryMake(539, "__skill " + $skill[Seek out a bird], url, ChecklistSubentryMake("Seek out a Bird", "", description), 5).ChecklistEntryTag("bird-a-day calendar").ChecklistEntrySetCategory("buff").ChecklistEntrySetShortDescription(skill_mp_cost + "mp"));
	}
	//_favoriteBirdVisited: boolean
	//yourFavoriteBird: string, name
	//yourFavoriteBirdMods: what the birds does. format: "Moxie Percent: +75, Spooky Resistance: +2, Item Drop: +20, Damage Absorption: +100, Damage Reduction: 5"
	
	//thought about putting this in skills.ash, but it's here instead
    if ($skill[Visit your Favorite Bird].skill_is_usable() && !get_property_boolean("_favoriteBirdVisited"))
    {
    	string [int] modifiers = convertMafiaModifierStringToOurStyle(get_property("yourFavoriteBirdMods"));
    	string [int] description;
        description.listAppend(modifiers.listJoinComponents(", ") + " buff. (20 turns)");
        resource_entries.listAppend(ChecklistEntryMake(540, "__skill Visit your Favorite Bird", "skillz.php", ChecklistSubentryMake("Visit your favourite bird", "", description), 5).ChecklistEntryTag("bird-a-day calendar").ChecklistEntrySetCategory("buff"));
    }
}
	
	



RegisterResourceGenerationFunction("IOTMPowerfulGloveGenerateResource");
void IOTMPowerfulGloveGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (!$item[powerful glove].have()) return;
	
	int battery_left = clampi(100 - get_property_int("_powerfulGloveBatteryPowerUsed"), 0, 100);
	
	if (battery_left >= 5)
	{
		//invisible avatar - -10% combat rate
        //shrink enemy - should we even bother to mention this? reduces a single foe's HP/attack/def by 50%, I am not sure this is useful anywhere except maaaaaybe the war boss and duriel?
        //triple size - +200% stats for twenty adventures
        
        string [int] description;
        
        if (battery_left >= 10)
        {
            //replace enemy - macrometeorite reroll
            string [int] useful_places = generateUsefulPlacesToRerollMonsters();
        	description.listAppend("<strong>Replace enemy</strong>:|Reroll a monster in combat, -10 energy:|*-" + useful_places.listJoinComponents("|*-"));
        }
        
        description.listAppend("<strong>Invisible avatar</strong>: -10% combat rate buff. (10 adv, -5 energy)");
        description.listAppend("<strong>Triple size</strong>: +200% all stats buff. (20 adv, -5 energy)");
        
        string url = "skillz.php";
        if (!$item[powerful glove].equipped())
        {
        	url = generateEquipmentLink($item[powerful glove]);
            description.listAppend("Equip first to use.");
        }
        resource_entries.listAppend(ChecklistEntryMake(480, "__item powerful glove", url, ChecklistSubentryMake(battery_left + " Powerful Glove energy", "", description), 2));
	}
}
//bad
/*RegisterTaskGenerationFunction("IOTMBetterShroomsAndGardensGenerateTasks");
void IOTMBetterShroomsAndGardensGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (!(get_campground() contains $item[packet of mushroom spores])) return;
	
	int fights = get_property_int("_mushroomGardenFights");
	int fight_limit = 1;
	if (my_path_id() == PATH_LUIGI)
		fight_limit = 5;
    int fights_left = clampi(0, fight_limit - fights, fight_limit);
    
    if (fights_left > 0)
    {
    	string title = "Fight in your mushroom garden";
    	string [int] description;
        if (fights_left > 1)
        	description.listAppend(fights_left + " free fights left.");
        else
        	description.listAppend("Free fight.");
        description.listAppend("Pick the mushroom afterwards.");
        if (!__misc_state["in run"]) //rewards do not seem practical in-run
        	description.listAppend("Or fertilise it for long-term rewards.");
        
        optional_task_entries.listAppend(ChecklistEntryMake(611, "__item colossal free-range mushroom", "campground.php", ChecklistSubentryMake(title, "", description), 8));
    }
}*/

RegisterGenerationFunction("IOTMBetterShroomsAndGardensGenerate");
void IOTMBetterShroomsAndGardensGenerate(ChecklistCollection checklists)
{
	if (get_campground()[$item[packet of mushroom spores]] == 0) return;
	
	int max_fights = 1;
	if (my_path_id() == PATH_LUIGI)
		max_fights = 5;
    int fights_left = clampi(max_fights - get_property_int("_mushroomGardenFights"), 0, max_fights);
    if (fights_left > 0)
    {
    	string title = "Free mushroom fight";
        if (fights_left > 1)
        	title = pluralise(fights_left, "mushroom fight", "mushroom fights");
        string description;
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(612, "__item immense free-range mushroom", "campground.php", ChecklistSubentryMake(title, "", description), 4).ChecklistEntryTag("daily free fight"));
    }
    if (!get_property_boolean("_mushroomGardenVisited") && fights_left <= 0)
    {
    	string title = "Pick mushroom garden";
        string description = "Or fertilise it for long-term rewards";
        checklists.add(C_OPTIONAL_TASKS, ChecklistEntryMake(613, "__item immense free-range mushroom", "campground.php", ChecklistSubentryMake(title, "", description), 4));
    	
    }
}




RegisterResourceGenerationFunction("IOTMBetterShroomsAndGardensGenerateResource");
void IOTMBetterShroomsAndGardensGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (in_ronin())
	{
		item [int] mushrooms;
        foreach it in $items[free-range mushroom,plump free-range mushroom,bulky free-range mushroom,giant free-range mushroom,immense free-range mushroom,colossal free-range mushroom]
        {
        	if (!it.have()) continue;
        	mushrooms.listAppend(it);
        }
        //we would use ChecklistEntryTag here, except I am not sure if it's stable and I only want the last entry to have the description
        ChecklistSubentry [int] subentries;
        string image_name;
        foreach key, it in mushrooms
        {
        	if (image_name == "") image_name = "__item " + it;
        	string [int] description;
            if (key == mushrooms.count() - 1)
            	description.listAppend("Use for mushroom filets.");
            subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", description));
        	//resource_entries.listAppend(ChecklistEntryMake(614, "__item " + it, "campground.php", ChecklistSubentryMake(pluralise(it), "", description), 8).ChecklistEntryTag("using shroom and garden item"));
        }
        if (subentries.count() > 0)
        	resource_entries.listAppend(ChecklistEntryMake(615, image_name, "inventory.php?which=3&ftext=mushroom", subentries, 8));
    }
}
RegisterGenerationFunction("IOTMGuzzlrTabletGenerate");
void IOTMGuzzlrTabletGenerate(ChecklistCollection checklists)
{
	if (!$item[guzzlr tablet].have()) return;
	
	QuestState guzzlr_quest_state = QuestState("questGuzzlr"); 
	if (guzzlr_quest_state.in_progress)
	{
        location target_location = get_property_location("guzzlrQuestLocation");
        string target_item_string = get_property("guzzlrQuestBooze");
        item target_item = target_item_string.to_item();
        
    	if (target_item_string == "special personalized cocktail")
     		target_item = $item[Guzzlr cocktail set];
        
        string target_item_description = target_item;
        boolean have_target_item = target_item.item_amount() > 0;
        
        if (target_item == $item[Guzzlr cocktail set])
        {
        	boolean [item] potential_drinks = $items[Steamboat,Ghiaccio Colada,Nog-on-the-Cob,Sourfinger,Buttery Boy];
            have_target_item = false;
            foreach it in potential_drinks
            {
            	if (it.item_amount() > 0)
             	{
                	target_item = it;
                    target_item_description = target_item;
                    have_target_item = true;
                    break;
                }
            }
            if (!have_target_item)
            {
            	target_item_description = potential_drinks.listInvert().listJoinComponents(", ", "or");
            }
        }
        
        string [int] description;
        
        description.listAppend("Adventure in " + target_location + " to deliever a " + target_item + ".");
        if (target_item != $item[none] && !have_target_item)
        	description.listAppend(HTMLGenerateSpanFont("Acquire a " + target_item_description + " first.", "red"));
        
        
        boolean [item] all_relevant_items = $items[Guzzlr pants,Guzzlr shoes];
        
        boolean [item] items_to_equip;
        foreach it in all_relevant_items
        {
        	if (!it.equipped() && it.have())
         		items_to_equip[it] = true;   
        }
        
        if (items_to_equip.count() > 0)
        	description.listAppend(HTMLGenerateSpanFont("Equip " + items_to_equip.listInvert().listJoinComponents(", ", "and") + " first.", "red"));
        checklists.add(C_AFTERCORE_TASKS, ChecklistEntryMake(456, "__item guzzlr tablet", target_location.getClickableURLForLocation(), ChecklistSubentryMake("Guzzlr quest", "", description), 8, locationToLocationMap(target_location)));
	}
	//I think "_guzzlrPlatinumDeliveries" will tell you how many deliveries you started today
	//did a platinum from the previous day, _guzzlrPlatinumDeliveries was zero, started a new one today, went up to one 
	if (!guzzlr_quest_state.started && get_property_int("_guzzlrPlatinumDeliveries") == 0 && get_property_int("guzzlrGoldDeliveries") >= 5)
	{
        checklists.add(C_OPTIONAL_TASKS, ChecklistEntryMake(457, "__item guzzlr tablet", "inventory.php?tap=guzzlr", ChecklistSubentryMake("Start platinum guzzlr quest", "", "Daily collectable."), 8));
	}
}

int IOTMEmotionChipCastsLeft(string [skill] skill_property_names, skill s)
{
	string property_name = skill_property_names[s];
	if (property_name == "") return 0;
	
	string property_value = get_property(property_name);
	if (property_value == "") return 0; //unsupported
	
	return clampi(3 - property_value.to_int(), 0, 3);
}

RegisterGenerationFunction("IOTMEmotionChipGenerate");
void IOTMEmotionChipGenerate(ChecklistCollection checklists)
{
	if (my_path_id() == PATH_AVATAR_OF_BORIS) return; //probably a lot of these
	if (!lookupSkill("Emotionally Chipped").have_skill())
	{
		if (lookupItem("spinal-fluid-covered emotion chip").have())
        {
        	string [int] description;
            description.listAppend("Use spinal-fluid-covered emotion chip.");
            if (my_path_id() != PATH_NONE)
	            description.listAppend("Unless that's impossible this path. (needs spading?)");
        	checklists.add(C_OPTIONAL_TASKS, ChecklistEntryMake(452, "__item spinal-fluid-covered emotion chip", "inventory.php?which=3", ChecklistSubentryMake("Acquire Emotionally Chipped skill", "", description), 9));
        }
		return;
    }

	
	/*
	Buffs: (20 turns)
	Feel Lonely - -5% combat
	Feel Excitement - +25 all stats
	Feel Peaceful - +2 all res, +10DR, +100 DA
	
	
	Combat:
	Feel Envy - drop all items
	Feel Hatred - banish (50 turns)
	Feel Nostalgic - gives drops from last monster in next fight - feelNostalgicMonster (feelsNostalgicMonster is in defaults but it's not the one updated)
	Feel Pride - triple stat gains in fight
	Feel Superior - main use: +3 PVP fights/day deal damage, gives PVP fight if killing blow. easiest method: use against crates with +0 ML (thanks boesbert)
	
	Ignored by Guide:
	Feel Disappointed: I will never live with disappointment!
	Feel Lost: +30 stats/fight +60% item is nice but doesn't work in adventure.php
	Feel Nervous - passive damage
    */
	string [skill] skill_property_names = {
	//lookupSkill("Feel Disappointed"):"_feelDisappointedUsed",
	lookupSkill("Feel Lonely"):"_feelLonelyUsed",
	lookupSkill("Feel Excitement"):"_feelExcitementUsed",
	lookupSkill("Feel Peaceful"):"_feelPeacefulUsed",
	
	lookupSkill("Feel Envy"):"_feelEnvyUsed",
	lookupSkill("Feel Hatred"):"_feelHatredUsed",
	lookupSkill("Feel Nostalgic"):"_feelNostalgicUsed",
	lookupSkill("Feel Pride"):"_feelPrideUsed",
	lookupSkill("Feel Superior"):"_feelSuperiorUsed",
	//lookupSkill("Feel Lost"):"_feelLostUsed",
	//lookupSkill("Feel Nervous"):"_feelNervousUsed",
	};
	
	boolean [skill] skills_that_are_buffs
	{
	lookupSkill("Feel Lonely"):true,
	lookupSkill("Feel Excitement"):true,
	lookupSkill("Feel Peaceful"):true,
	};
	
	
	monster nostalgic_monster = get_property_monster("feelNostalgicMonster");
	string [skill] skill_descriptions
	{
	lookupSkill("Feel Lonely"):"-5% combat. (20 turns)",
	lookupSkill("Feel Excitement"):"+25 all stats. (20 turns)",
	lookupSkill("Feel Peaceful"):"+2 all res, +DR/DA. (20 turns)",
	
	
	lookupSkill("Feel Envy"):"Drop all items next combat.",
	lookupSkill("Feel Hatred"):"Free run/banish monster for fifty turns.",
	lookupSkill("Feel Nostalgic"):"Give all drops from the last " + nostalgic_monster + " fight.",
	lookupSkill("Feel Pride"):"Triple stat gains next fight",
	lookupSkill("Feel Superior"):"",
	};
	
	string [skill] skill_url;
	
	boolean [skill] skills_to_skip_output;
	
	if (!hippy_stone_broken())
		skills_to_skip_output[lookupSkill("Feel Superior")] = true;
    else
    {
    	string description;
        description = "Gives +1 PVP fight each, if used properly. (last 20% monster health)|Try it against crates in the noob cave"; //thanks boesbert
        if (numeric_modifier("Monster Level") > 0)
        {
        	description += ", after lowering your +monster level to zero";
        }
        description += ".";
        skill_descriptions[lookupSkill("Feel Superior")] = description;
        skill_url[lookupSkill("Feel Superior")] = $location[noob cave].getClickableURLForLocation();
    }
    
    if (nostalgic_monster == $monster[none])
    {
		skills_to_skip_output[lookupSkill("Feel Nostalgic")] = true;
    }
    if (!in_ronin())
    {
		skills_to_skip_output[lookupSkill("Feel Lonely")] = true;
		skills_to_skip_output[lookupSkill("Feel Excitement")] = true;
		skills_to_skip_output[lookupSkill("Feel Peaceful")] = true;
  
  		skills_to_skip_output[lookupSkill("Feel Pride")] = true;
    }
	
	
	//Buffs:
    foreach s in skill_descriptions
    {
        if (skills_to_skip_output[s]) continue;
        int casts_left = IOTMEmotionChipCastsLeft(skill_property_names, s);
        if (casts_left == 0) continue;
        string description = skill_descriptions[s];
        
        string url;
        if (skills_that_are_buffs[s])
        {
        	url = "skillz.php";
        }
        
        if (skill_url contains s)
        	url = skill_url[s];
        
        int priority = 1;
        if (s == lookupSkill("Feel Hatred"))
        	priority = 0;
        
        ChecklistEntry entry = ChecklistEntryMake(453, "__skill " + s, url, ChecklistSubentryMake(pluralise(casts_left, "cast", "casts") + " of " + s, "", description), priority);
        if (skills_that_are_buffs[s])
        {
        	entry.ChecklistEntrySetCategory("buff");
            entry.ChecklistEntryTag("emotion chip buff");
        }
        else if (s.combat)
        {
        	entry.ChecklistEntrySetCategory("combat skill");
            entry.ChecklistEntryTag("emotion chip combat");
        }
        else
        {
        	entry.ChecklistEntryTag("emotion chip");
        }
        
        if (s == lookupSkill("Feel Hatred"))
        {
        	entry.ChecklistEntryTag("free banish");
        	entry.ChecklistEntrySetCategory("free banish");
        }
        checklists.add(C_RESOURCES, entry);
    }

}

RegisterGenerationFunction("IOTMMiniatureCrystalBallGenerate");
void IOTMMiniatureCrystalBallGenerate(ChecklistCollection checklists)
{
	item crystal_ball = lookupItem("miniature crystal ball");
	if (!crystal_ball.have() || __misc_state["familiars temporarily blocked"]) return;
	
	
	
	monster next_monster = get_property_monster("crystalBallMonster");
	location next_location = get_property_location("crystalBallLocation");
	string [int] description;
	
	boolean is_equipped = crystal_ball.equipped();
	if (!is_equipped)
		description.listAppend("Equip to predict the next monster fought in zone.");
    else
    	description.listAppend("Predicts the next monster fought in zone.");
	
	
	string image_name = "__item miniature crystal ball";
	
	string url = "familiar.php";
	
	if (next_monster != $monster[none])
	{
		string line = "Next monster is <strong>" + next_monster + "</strong> in " + next_location + ".";
        string warning;
        if (!is_equipped)
        {
        	warning = HTMLGenerateSpanFont("|Will not appear unless miniature crystal ball is equipped.", "red");
            if (crystal_ball.item_amount() == 0)
            {
            	//Find the familiar:
                //FIXME: only use familiars we have? but static is badhere I think..
                foreach f in $familiars[]
                {
                	if (f.familiar_equipped_equipment() == crystal_ball)
                    {
                    	warning += "|*Currently held by " + f + ".";
                    	break;
                    }
                }
            }
        }
        else
        {
        	url = next_location.getClickableURLForLocation();
        }
		description.listAppend(line);
        description.listAppend(warning);
        
        //Debate here: should the popup be item size?
        //Pros: the smaller size makes it take up less space, and it is a pop up. On retina displays, looks good.
        //Minuses: the "normal" size looks much nicer on non-retina displays, more "recognisable."
        //For now, regular size. This is important info we want to draw attention to.
        string popup_image_name = "__half __monster " + next_monster;
        image_name = "__monster " + next_monster;
        
  
  
  
  		string popup_header = next_monster.capitaliseFirstLetter();
        string popup_description = "Next adventure in " + next_location + ".";
        popup_description += warning;
  		checklists.add(C_TASKS, ChecklistEntryMake(513, popup_image_name, url, ChecklistSubentryMake(popup_header, "", popup_description), -11));
    }
	
	//tried inventory.php?which=2&ftext=miniature+crystal+ball but mafia's tracking with familiar equipment in inventory.php is wonky?
	checklists.add(C_RESOURCES, ChecklistEntryMake(514, image_name, url, ChecklistSubentryMake("Minature crystal ball", "", description), 1));
}


RegisterGenerationFunction("IOTMMelodramedaryGenerate");
void IOTMMelodramedaryGenerate(ChecklistCollection checklists)
{
	familiar melodramedary = lookupFamiliar("Melodramedary");
	if (!melodramedary.have_familiar() || __misc_state["familiars temporarily blocked"]) return;
	
	item melodramedary_helmet = lookupItem("dromedary drinking helmet");
	/*-desert
	-han on hoth
	-whatever else this does
	-spit:
	spit on me: +100% weapon/spell damage, +100% all stats (community service alert)
	spit on them: doubles the amount of items dropped
	*/
	
	boolean avoid_adding_main = false;
	
	int spit_level = get_property_int("camelSpit"); //starts at 100
	
	string title;// = spit_level + " Melodramedary spit";
	string [int] description;
	string url_main;
	string short_desc;
	
	if (my_familiar() != melodramedary)
	{
        url_main = "familiar.php";
        description.listAppend("Bring melodramedary along.");
	}
	if (spit_level < 100)
	{
		float spit_per_combat = 3.33;
        if (melodramedary.familiar_equipped_equipment() == melodramedary_helmet)
        {
        	spit_per_combat += 3.33 * 0.3;
        }
        else if (melodramedary_helmet.available_amount() > 0 && melodramedary_helmet.can_equip())
        {
        	description.listAppend("Should equip the dromedary drinking helmet.");
        }
        if (spit_level == 0 && my_familiar() != melodramedary)
        	avoid_adding_main = true;
        float remaining_spit = 100 - spit_level;
        
        float remaining_turns = remaining_spit / spit_per_combat;
        
        int estimated_turns = remaining_turns.floor();
        title = pluralise(estimated_turns, "combat", "combats") + " until melodramedary skill";
		//description.listAppend(pluralise(remaining_turns.round(), "turn", "turns") + " to next use.");
  
  		short_desc = estimated_turns.to_string();
    }
    else
    {
    	title = "Melodramedary combat skill ready";
        short_desc = "now";
    	string target_text;
     
     	string [int] targets;
        //FIXME write this
        if (targets.count() > 0)
	        target_text = "|Potential Targets:|*-" + targets.listJoinComponents("|*-");
    	description.listAppend(melodramedary.name + ", spit on me: +100% weapon/spell damage/stats buff. (15 turns)");
        description.listAppend(melodramedary.name + ", spit on them: doubles all items dropped from combat. " + target_text);
    }
	if (!avoid_adding_main)
		checklists.add(C_RESOURCES, ChecklistEntryMake(458, "__familiar Melodramedary", url_main, ChecklistSubentryMake(title, "", description), 1)).ChecklistEntryTag("Melodramedary").ChecklistEntrySetCategory("familiar").ChecklistEntrySetShortDescription(short_desc);
	
	//There might not be any tracking for this?
	if (lookupItem("Fourth of May Cosplay Saber").have() && !get_property_boolean("_tauntaunTaunted") && false)
	{
		string url = "inventory.php?which=2";
		int cold_level = clampi(melodramedary.familiar_weight(), 1, 20);
  
  		string [int] tauntaun_description;
        tauntaun_description.listAppend("+" + cold_level + " cold res. (10 turns)");
        tauntaun_description.listAppend("Will reset Melodramedary familiar weight.");
        string [int] tasks;
        if (!lookupItem("Fourth of May Cosplay Saber").equipped())
        {
        	tasks.listAppend("equip Fourth of May Cosplay Saber");
        }
        if (my_familiar() != melodramedary)
        {
        	url = "familiar.php";
        	tasks.listAppend("change familiar to Melodramedary");
        }
        if (tasks.count() > 0)
        	tauntaun_description.listAppend(tasks.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
        checklists.add(C_RESOURCES, ChecklistEntryMake(459, "__familiar Melodramedary", url, ChecklistSubentryMake("Melodramedary buff", "", tauntaun_description), 1)).ChecklistEntryTag("Melodramedary");
	}
}
RegisterGenerationFunction("IOTMComprehensiveCartographyGenerate");
void IOTMComprehensiveCartographyGenerate(ChecklistCollection checklists)
{
	if (!lookupSkill("Comprehensive Cartography").skill_is_usable()) return;
	
	
	int monster_maps_remaining = clampi(3 - get_property_int("_monstersMapped"), 0, 3);
	
	
	boolean currently_mapping_monsters = get_property_boolean("mappingMonsters");
	
	if (monster_maps_remaining > 0)
	{
		string title = pluralise(monster_maps_remaining, "Map the Monster", "Map the Monsters");
        string [int] description;
        description.listAppend("Allows picking which monster to encounter next adventure.");
        if (currently_mapping_monsters)
        	description.listAppend("Skill is up; choice will appear next adventure");
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(454, "__skill Map the Monsters", "skillz.php", ChecklistSubentryMake(title, "", description), 0)).ChecklistEntrySetCategory("skill");
	}
	
	if (currently_mapping_monsters)
	{
		string title = "Monster Map Active";
        string [int] description;
        description.listAppend("Pick a monster to fight, when you adventure.");
        checklists.add(C_TASKS, ChecklistEntryMake(455, "__skill Map the Monsters", "main.php", ChecklistSubentryMake(title, "", description), -11));
	}
	
	//FIXME other half: the special adventures. have we seen them yet? how should we output this?
	//billiards room especially
}

RegisterGenerationFunction("IOTMRetroSuperheroCapeGenerate");
void IOTMRetroSuperheroCapeGenerate(ChecklistCollection checklists)
{
	item cape = lookupItem("unwrapped knock-off retro superhero cape");
	if (!cape.have()) return;
	
	
	/*
	List the current name because that is a nightmare to deal with when in the inventory.
	-suggestion in L7 code
     */
     
    string superhero_major = get_property("retroCapeSuperhero"); //Valid values: "vampire", "heck", or "robot"
    string superhero_minor = get_property("retroCapeWashingInstructions"); //Valid values: "hold", "thrill", "kiss", or "kill"
    string image_name = "__item unwrapped knock-off retro superhero cape";
    string url = "inventory.php?action=hmtmkmkm";
    
    string title = "Superhero Cape";
    string [int] description;
    
    
    string [string][string] various_cape_effects =
    {
    	"vampire":{"hold":"+3 all res.",
        	"thrill":"+3 muscle stats/fight.",
        	"kiss":"20% HP drain combat skill, once/fight. (Smooch of the Daywalker)",
        	"kill":"Anti-undead combat skill, removes extra Cyrpt evil. (Slay the Dead)"},
         
    	"heck":{"hold":"Three-round stun at fight start.",
        	"thrill":"+3 myst stats/fight.",
        	"kiss":"Yellow-Ray combat skill. (Unleash the Devil's Kiss)",
        	"kill":"Doubles your spell damage as spooky."},
         
    	"robot":{"hold":"20% monster attack reduction combat skill, once/fight. (Deploy Robo-Handcuffs)",
        	"thrill":"+3 moxie stats/fight.",
        	"kiss":"Sleaze damage combat skill, reusable. (Blow a Robo-Kiss)",
        	"kill":"Critical hit combat skill, gun-only, once/fight. (Precision Shot)"},
         
    };
    string [string] intrinsic_cape_effect =
    {
    	"vampire":"+30% muscle, +50 HP",
    	"heck":"+30% myst, +50 MP",
    	"robot":"+30% moxie, +25 HP/MP",
    };
    
    
    string [string] full_superhero_names =
    {
    	"vampire":"Vampire Slicer",
    	"heck":"Heck General",
    	"robot":"Robot Police",
    };
    
    
    string cape_name = "Contessa"; //the true patron cape of all speed ascenders. mine is dragon!
    if (superhero_major == "vampire")
    	cape_name = "Vampire Slicer trench cape";
    else if (superhero_major == "heck")
    	cape_name = "Heck General cloak";
    else if (superhero_major == "robot")
    	cape_name = "Robot Police cape";
    else
    	cape_name = "unwrapped knock-off retro superhero cape";
     
    title = cape_name + " (Superhero Cape)";
    
    //FIXME image? it would require direct URL
     
    string current_effect_description = various_cape_effects[superhero_major][superhero_minor];
    
    if (current_effect_description != "")
    {
    	description.listAppend("Now: " + current_effect_description);
    }
    
    
    if (cape.equipped_amount() == 0)
    {
    	//Weirdly, ftext uses actual item name, not display name.
    	//url = "inventory.php?which=2&ftext=" + cape_name.replace_string(" ", "+");
     	url = "inventory.php?which=2&ftext=unwrapped+knock-off+retro+superhero+cape";
    }
    
    if ($effect[everything looks yellow].have_effect() == 0 && !(superhero_major == "heck" && superhero_minor == "kiss"))
    {
    	description.listAppend("Could switch over to Heck General/Kiss for a yellow-ray.");
    }
    
    if (superhero_major == "vampire" && superhero_minor == "kill")
    {
    	string [int] tasks;
        if (!cape.equipped())
        {
        	tasks.listAppend("equip the cape");
        }
        if ($slot[weapon].equipped_item().item_type() != "sword")
        {
        	tasks.listAppend("equip a sword in your mainhand");
        }
        if ($effect[Iron Palms].have_effect() != 0)
        {
        	tasks.listAppend("cast iron palm technique");
        }
        if (tasks.count() > 0)
        	description.listAppend("To use the skill, " + HTMLGenerateSpanFont(tasks.listJoinComponents(", ", "and"), "red") + ".");
    }
    
    //description.listAppend("Currently named \"" + cape_name + "\" in inventory."); //too wordy, moved to title
    
    buffer cape_effects_buf;
    
    boolean first = true;
    foreach iterating_cape_major in $strings[vampire,heck,robot]
    {
    	if (first)
        	first = false;
        else
        	cape_effects_buf.append("<hr>");
    	cape_effects_buf.append("<strong style=\"font-size:1.5em;\">");
        cape_effects_buf.append(full_superhero_names[iterating_cape_major].capitaliseFirstLetter());
        cape_effects_buf.append("</strong>");
        if (iterating_cape_major == superhero_major)
        	cape_effects_buf.append(" (current)");
        cape_effects_buf.append("<div class=\"r_indention\">");
        cape_effects_buf.append(intrinsic_cape_effect[iterating_cape_major]);
        cape_effects_buf.append(".");
        cape_effects_buf.append("<hr></div>");
        
        
    	//foreach iterating_cape_minor in various_cape_effects[iterating_cape_major]
     
     	string [int][int] subtable;
        foreach iterating_cape_minor in $strings[hold,thrill,kiss,kill]
        {
        	string effect_description = various_cape_effects[iterating_cape_major][iterating_cape_minor];
            
            string [int] subtable_line;
            subtable_line.listAppend("<strong>" + iterating_cape_minor.capitaliseFirstLetter() + "</strong>");
            string secondary_line = effect_description + ".";
            if (iterating_cape_major == superhero_major && iterating_cape_minor == superhero_minor)
                secondary_line += " (current)";
            subtable_line.listAppend(secondary_line);
            subtable.listAppend(subtable_line);
            /*continue;
            
            cape_effects_buf.append("<div class=\"r_indention\">");
            cape_effects_buf.append("<strong>");
            cape_effects_buf.append(iterating_cape_minor.capitaliseFirstLetter());
            cape_effects_buf.append(" Me</strong>: ");
            
        	cape_effects_buf.append(effect_description);
            if (iterating_cape_major == superhero_major && iterating_cape_minor == superhero_minor)
                cape_effects_buf.append(" (current)");
            
            
            cape_effects_buf.append("</div>");*/
        }
        
        cape_effects_buf.append("<div class=\"r_indention\">");
        cape_effects_buf.append(HTMLGenerateSimpleTableLines(subtable));
        cape_effects_buf.append("</div>");
    }
    
    description.listAppend(HTMLGenerateTooltip("Mouse over for full cape effects.", cape_effects_buf.to_string()));
    
    
    
    
    checklists.add(C_RESOURCES, ChecklistEntryMake(572, image_name, url, ChecklistSubentryMake(title, "", description), 1)).ChecklistEntrySetCategory("equipment").ChecklistEntrySetAbridgedHeader("Superhero cape");
    
}

RegisterGenerationFunction("IOTMSpinmasterLatheGenerate");
void IOTMSpinmasterLatheGenerate(ChecklistCollection checklists)
{
	if (!lookupItem("SpinMaster&trade; lathe").have()) return;
	if (!get_property_boolean("_spinmasterLatheVisited"))
	{
        checklists.add(C_OPTIONAL_TASKS, ChecklistEntryMake(542, "__item SpinMaster&trade; lathe", "inventory.php?which=3&ftext=SpinMaster&amp;trade;+lathe", ChecklistSubentryMake("Collect SpinMaster&trade; hardwood", "", "Use your SpinMaster&trade; lathe."), 1));
	}
	
	item hardwood = lookupItem("flimsy hardwood scraps");
	
	if (true)
	{
		string [int] description;
        //Show options:
        string [item] creations_descriptions = {
	        lookupItem("beechwood blowgun"):"+100% ranged damage, +25 moxie, +5 moxie stat/fight, disappears<hr>Poison Dart combat skill once/fight (50% HP + zeno damage)",
	        lookupItem("birch battery"):"+100 MP, ~17MP regen, disappears",
	        lookupItem("ebony epee"):"+100% weapon damage, +25 muscle, +5 muscle stat/fight, disappears<hr>Disarming Thrust combat skill once/fight (reduces ~30% monster attack)",
	        lookupItem("maple magnet"):"Collects rare wood, +100 HP, +50% weapon drop, +50% acc drop, disappears",
	        lookupItem("weeping willow wand"):"+100% spell damage, +25 myst, +5 myst stat/fight, disappears<hr>Barrage of Tears combat skill once/fight (physical/spooky damage, 25% monster HP each)",
            
	        lookupItem("hemlock helm"):"+100% muscle, +30 ML, +5 fights/day",
	        lookupItem("balsam barrel"):"+50% stats, +15% item, 15 HP/MP regen",
	        lookupItem("purpleheart \"pants\""):"+100% moxie, +50% init, +5 adv/day",
	        lookupItem("wormwood wedding ring"):"+100% myst, +50% meat, +30 spooky damage/spell damage, +3 spooky res",
	        lookupItem("redwood rain stick"):"+20% item (20 turns)",
	        lookupItem("drippy diadem"):"Protects against The Drip",
        };
        
        item [int] display_order =
        {
            lookupItem("beechwood blowgun"),
            lookupItem("birch battery"),
            lookupItem("ebony epee"),
            lookupItem("maple magnet"),
            lookupItem("weeping willow wand"),
            lookupItem("hemlock helm"),
            lookupItem("balsam barrel"),
            lookupItem("purpleheart pants"),
            lookupItem("wormwood wedding ring"),
            lookupItem("redwood rain stick"),
            lookupItem("drippy diadem"),
        };
        string [item] location_to_farm_item_components = {
	        lookupItem("hemlock helm"):"Dreadsylvanian Woods",
	        lookupItem("balsam barrel"):"The Smut Orc Logging Camp",
	        lookupItem("purpleheart \"pants\""):"The Purple Light District",
	        lookupItem("wormwood wedding ring"):"The Worm Wood",
	        lookupItem("redwood rain stick"):"The Jungles of Ancient Loathing",
	        lookupItem("drippy diadem"):"The Dripping Trees",
        };
        item [item] secondary_components = {
	        lookupItem("hemlock helm"):lookupItem("Dreadsylvanian hemlock"),
	        lookupItem("balsam barrel"):lookupItem("sweaty balsam"),
	        lookupItem("purpleheart \"pants\""):lookupItem("purpleheart logs"),
	        lookupItem("wormwood wedding ring"):lookupItem("wormwood stick"),
	        lookupItem("redwood rain stick"):lookupItem("ancient redwood"),
	        lookupItem("drippy diadem"):lookupItem("Dripwood slab"),
        };
        boolean have_hardwood = hardwood.have();
        foreach key, it in display_order
        {
            if (!(secondary_components contains it))
            {
            	//hardwood:
                if (!__misc_state["in run"])
                	continue;
                if (!have_hardwood)
	            	continue;
            }
            
            int amount_needed = 1;
            //assumption: weapon_hands() always returns zero for non-weapons
            if (it.weapon_hands() == 1)
            {
            	amount_needed = maximumSimultaneous1hWeaponsEquippable();
            }
            if (it.available_amount() >= amount_needed) continue;
            
            
        	string item_description = creations_descriptions[it];
            string base_description = it.getBasicItemDescription();
            string line = "<strong>" + it.capitaliseFirstLetter() + "</strong>: " + base_description + "|*" + item_description;
            
            
        	if (secondary_components contains it && secondary_components[it].available_amount() == 0)
            {
            	if (in_ronin())
                {
                	continue;
                }
                else
                {
                	if (location_to_farm_item_components contains it)
                    	line += "|*Collect wood components in " + location_to_farm_item_components[it] + (!lookupItem("maple magnet").equipped() ? " with the maple magnet equipped" : "") + ".";
                	line = HTMLGenerateSpanFont(line, "grey");
                }
            }
        	description.listAppend(line);
        }
        if (description.count() > 0)
        {
        	checklists.add(C_RESOURCES, ChecklistEntryMake(543, "__item " + hardwood, "shop.php?whichshop=lathe", ChecklistSubentryMake(pluralise(hardwood), "", description), 5));
        }
	}
}

RegisterGenerationFunction("IOTMCargoCultistShortsGenerate");
void IOTMCargoCultistShortsGenerate(ChecklistCollection checklists)
{
	item cultist_shorts = lookupItem("Cargo Cultist Shorts");
	if (!cultist_shorts.have()) return;
	
	if (!get_property_boolean("_cargoPocketEmptied"))
	{
		string [int] description;
        
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(546, "__item Cargo Cultist Shorts", "inventory.php?action=pocket", ChecklistSubentryMake("Cargo Cultist Shorts pocket", "", description), 1));
	}
}

//
RegisterGenerationFunction("IOTMPottedPowerPlantGenerate");
void IOTMPottedPowerPlantGenerate(ChecklistCollection checklists)
{
	//_pottedPowerPlant, shockingLickCharges
	
	if (lookupItem("potted power plant").have() && mafiaIsPastRevision(20657))
	{
        int plant_picks_remaining = 0;
		string [int] plant_pick_state = get_property("_pottedPowerPlant").split_string_alternate(",");
        foreach key, pick in plant_pick_state
        {
        	if (pick == "") continue;
            if (pick == "0") continue;
            if (is_integer(pick)) plant_picks_remaining += 1;
        }
        if (plant_pick_state.count() == 0)
        	plant_picks_remaining = 7; //guess
        if (plant_picks_remaining > 0)
        {
            checklists.add(C_RESOURCES, ChecklistEntryMake(519, "__item potted power plant", "inv_use.php?pwd=" + my_hash() + "&whichitem=10738", ChecklistSubentryMake(pluralise(plant_picks_remaining, "potted power plant pick", "potted power plant picks"), "", ""), 2)).ChecklistEntryTag("Potted Power Plant");
        }
	}
	if (in_ronin())
	{
        string [item] battery_descriptions = {
        	lookupItem("battery (AAA)"):"+50% spell damage, regen ~7MP/adv (30 turns), 30 MP",
        	lookupItem("battery (AA)"):"+50% spell damage, +50% init, regen ~7MP/adv (30 turns), 40 MP",
        	lookupItem("battery (D)"):"+50% spell damage, +50% init, +3 stats/fight, regen ~7MP/adv (30 turns), 50 MP",
        	lookupItem("battery (9-Volt)"):"1 freekill charge, +50% spell damage, +50% init, +3 stats/fight, regen ~7MP/adv (30 turns), 60 MP",
        	lookupItem("battery (lantern)"):"1 freekill charge, +100% item, +50% spell damage, +50% init, +3 stats/fight, regen ~7MP/adv (30 turns), 70 MP",
        	lookupItem("battery (car)"):"1 freekill charge, +100% item, +100% meat, +50% spell damage, +50% init, +3 stats/fight, regen ~7MP/adv (30 turns), 80 MP",
        };
        if (my_path_id() == PATH_ROBOT)
        {
        	battery_descriptions[lookupItem("battery (AAA)")] += ", 15 energy";
        	battery_descriptions[lookupItem("battery (AA)")] += ", 20 energy";
        	battery_descriptions[lookupItem("battery (D)")] += ", 25 energy";
        	battery_descriptions[lookupItem("battery (9-Volt)")] += ", 30 energy";
        	battery_descriptions[lookupItem("battery (lantern)")] += ", 35 energy";
        	battery_descriptions[lookupItem("battery (car)")] += ", 40 energy";
        }
        string [int] creatables;
        string url = "inventory.php?which=3&ftext=battery";
        foreach it, item_description in battery_descriptions
        {
        	if (it.have())
            {
                checklists.add(C_RESOURCES, ChecklistEntryMake(520, "__item " + it, url, ChecklistSubentryMake(pluralise(it), "", item_description), 2)).ChecklistEntryTag("Potted Power Plant");
            }
            int creatable_amount = it.creatable_amount();
            if (creatable_amount > 0)
            {
            	creatables.listAppend("<strong>" + pluralise(creatable_amount, it) + "</strong>: " + item_description);
            }
        }
        if (creatables.count() > 0)
        {
            checklists.add(C_RESOURCES, ChecklistEntryMake(521, "__item potted power plant", url, ChecklistSubentryMake("Creatable batteries", "", creatables), 2)).ChecklistEntryTag("Potted Power Plant");
        }
	}
	int shocking_lick_charges = get_property_int("shockingLickCharges");
	if (shocking_lick_charges > 0)
	{
        checklists.add(C_RESOURCES, ChecklistEntryMake(522, "__skill Shocking Lick", "", ChecklistSubentryMake(pluralise(shocking_lick_charges, "Shocking Lick", "Shocking Licks"), "", "Free instakill."), 1).ChecklistEntryTag("free instakill"));
	}
}

RegisterGenerationFunction("IOTMBackupCameraGenerate");
void IOTMBackupCameraGenerate(ChecklistCollection checklists)
{
	item camera = lookupItem("backup camera");
	if (!camera.have()) return;
	
    
    int times_backed_up = get_property_int("_backUpUses");
    int backup_limit = 11;
    if (my_path_id() == PATH_ROBOT) //from reports
    	backup_limit = 16;
    int backups_left = MAX(0, backup_limit - times_backed_up);
    if (backups_left > 0)
    {
		string [int] description;
        string url = "";
        
        monster lm = last_monster();
        string last_monster_description = lm;
        if (lm == $monster[none])
        	last_monster_description = "a monster";
        
        
        description.listAppend("Fight " + last_monster_description + " in another zone.|Burns delay.");
        description.listAppend("In combat, cast Back-Up to your Last Enemy.");
        
        
        if (!camera.equipped())
        {
            url = "inventory.php?which=2&ftext=backup+camera";
            description.listAppend("Equip the backup camera first.");
        }
        string title = pluralise(backups_left, "camera backup", "camera backups");
    	checklists.add(C_RESOURCES, ChecklistEntryMake(616, "__item backup camera", url, ChecklistSubentryMake(title, "", description), 1)).ChecklistEntryTag("backup camera").ChecklistEntrySetAbridgedHeader(title);
    }
	
	if (true)
	{
		string [int] description;
        string url = "";
        if (!camera.equipped())
            url = "inventory.php?which=2&ftext=backup+camera";
        else
        	url = "inventory.php?which=2";
            
        string camera_mode = get_property("backupCameraMode"); //meat,
        
        string [string] camera_mode_descriptions =
        {
        	"meat":"+50% meat",
            "init":"+100% init",
            "ml":"+" + min(50, my_level() * 3) + " ML",
        };
        
        
        if (camera_mode_descriptions contains camera_mode)
        	description.listAppend(camera_mode_descriptions[camera_mode] + " enchantment.");
         
        string [int] other_options;
        foreach mode_name, mode_description in camera_mode_descriptions
        {
        	if (mode_name == camera_mode) continue;
            other_options.listAppend(mode_description);
        }
        description.listAppend("Could switch to " + other_options.listJoinComponents(", ", "or") + ".");
        
        if (!get_property_boolean("backupCameraReverserEnabled"))
        	description.listAppend("You may want to enable the reverser in the mode settings.");
        
        checklists.add(C_RESOURCES, ChecklistEntryMake(617, "__item backup camera", url, ChecklistSubentryMake("Backup Camera", "", description), 1)).ChecklistEntryTag("backup camera");
    }
    
}

RegisterTaskGenerationFunction("PathActuallyEdtheUndyingGenerateTasks");
void PathActuallyEdtheUndyingGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING) return;
    
    int skills_available = MIN(15, my_level()) - MIN(15, my_level()) / 3 + get_property_int("edPoints"); //assumption
    
    skills_available = MIN(21, skills_available);
    
    int skills_have = 0;
    foreach s in lookupSkillsInt($ints[17000,17001,17002,17003,17004,17005,17006,17007,17008,17009,17010,17011,17012,17013,17014,17015,17016,17017,17018,17019,17020])
    {
        if (s.skill_is_usable())
            skills_have += 1;
    }
    //FIXME describe what the next three skills do...?
    
    if (skills_available > skills_have)
    {
        string image_name = "__skill wisdom of thoth";
        string [int] description;
        description.listAppend("At least " + pluraliseWordy(skills_available - skills_have, "skill", "skills") + " available.");
        
        skill [int] desired_skill_order;
        
        if (get_property_int("edPoints") >= 5 && get_property("sleazeAirportAlways").to_boolean())
        {
            desired_skill_order.listAppend($skill[Fist of the Mummy]);
            desired_skill_order.listAppend($skill[Howl of the Jackal]);
            desired_skill_order.listAppend($skill[Roar of the Lion]);
            desired_skill_order.listAppend($skill[Prayer of Seshat]);
            desired_skill_order.listAppend($skill[Wisdom of Thoth]);
            desired_skill_order.listAppend($skill[Power of Heka]);
            desired_skill_order.listAppend($skill[Hide of Sobek]);
            desired_skill_order.listAppend($skill[Blessing of Serqet]);
            desired_skill_order.listAppend($skill[Shelter of Shed]);
            desired_skill_order.listAppend($skill[Bounty of Renenutet]);
            
            
            desired_skill_order.listAppend($skill[Storm of the Scarab]);
            desired_skill_order.listAppend($skill[Purr of the Feline]);
            desired_skill_order.listAppend($skill[Lash of the Cobra]);
            desired_skill_order.listAppend($skill[Wrath of Ra]);
            
            desired_skill_order.listAppend($skill[Curse of the Marshmallow]);
            desired_skill_order.listAppend($skill[Curse of Indecision]);
            desired_skill_order.listAppend($skill[Curse of Yuck]);
            desired_skill_order.listAppend($skill[Curse of Heredity]);
            desired_skill_order.listAppend($skill[Curse of Fortune]);
            desired_skill_order.listAppend($skill[Curse of Vacation]);
            
            desired_skill_order.listAppend($skill[Curse of Stench]);
        }
        else
        {
            desired_skill_order.listAppend($skill[Fist of the Mummy]);
            desired_skill_order.listAppend($skill[Prayer of Seshat]);
            desired_skill_order.listAppend($skill[Wisdom of Thoth]);
            desired_skill_order.listAppend($skill[Power of Heka]);
            desired_skill_order.listAppend($skill[Hide of Sobek]);
            desired_skill_order.listAppend($skill[Blessing of Serqet]);
            desired_skill_order.listAppend($skill[Shelter of Shed]);
            desired_skill_order.listAppend($skill[Bounty of Renenutet]);
            
            
            desired_skill_order.listAppend($skill[Howl of the Jackal]);
            desired_skill_order.listAppend($skill[Roar of the Lion]);
            desired_skill_order.listAppend($skill[Storm of the Scarab]);
            desired_skill_order.listAppend($skill[Purr of the Feline]);
            desired_skill_order.listAppend($skill[Lash of the Cobra]);
            desired_skill_order.listAppend($skill[Wrath of Ra]);
            
            desired_skill_order.listAppend($skill[Curse of the Marshmallow]);
            desired_skill_order.listAppend($skill[Curse of Indecision]);
            desired_skill_order.listAppend($skill[Curse of Yuck]);
            desired_skill_order.listAppend($skill[Curse of Heredity]);
            desired_skill_order.listAppend($skill[Curse of Fortune]);
            desired_skill_order.listAppend($skill[Curse of Vacation]);
            
            desired_skill_order.listAppend($skill[Curse of Stench]);
        }
        skill [int] suggestions;
        foreach key, s in desired_skill_order
        {
            if (s.have_skill())
                continue;
            suggestions.listAppend(s);
            if (suggestions.count() >= skills_available - skills_have)
                break;
        }
        description.listAppend("Maybe " + suggestions.listJoinComponents(", ", "and") + ".");
        optional_task_entries.listAppend(ChecklistEntryMake(197, image_name, "place.php?whichplace=edbase&action=edbase_book", ChecklistSubentryMake("Buy Undying skills", "", description), 11));
    }
    
    if (my_level() >= 13 && QuestState("questL13Final").finished)
    {
        if ($item[7965].available_amount() > 0 || $item[2334].available_amount() > 0) //holy macguffins
        {
            string [int] description;
            description.listAppend("Finishes the path.");
            if (availableSpleen() > 0)
                description.listAppend("May want to fill your " + availableSpleen() + " extra spleen first.");
            task_entries.listAppend(ChecklistEntryMake(198, "Pyramid", "place.php?whichplace=edbase&action=edbase_altar", ChecklistSubentryMake("Put back the Holy MacGuffin", "", description), -10));
        }
        else
        {
            //tutorial.php
            string [int] modifiers;
            string [int] description;
            string url = "tutorial.php";
            
            if (!$monster[warehouse janitor].is_banished())
                modifiers.listAppend("banish janitor");
            
            description.listAppend("Adventure in the Secret Government Warehouse, use the items you find.");
            
            int progress_remaining = clampi(40 - get_property_int("warehouseProgress"), 0, 40);
            if ($item[warehouse inventory page].available_amount() > 0 && $item[warehouse map page].available_amount() > 0)
            {
                description.listClear();
                description.listAppend("Use warehouse inventory page.");
                url = "inventory.php?which=3";
            }
            else if (progress_remaining > 0)
            {
                if ($skill[Lash of the Cobra].have_skill())
                {
                    description.listAppend("Use lash of the cobra on the clerk and guard.");
                }
                else
                {
                    modifiers.listAppend("+item");
                }
            }
            string [int] items_available;
            foreach it in $items[warehouse inventory page,warehouse map page]
            {
                if (it.available_amount() > 0)
                    items_available.listAppend(pluraliseWordy(it));
            }
            if (items_available.count() > 0)
            {
                description.listAppend(items_available.listJoinComponents(", ", "and").capitaliseFirstLetter() + " available.");
            }
            
            string line;// = pluraliseWordy(progress_remaining, "remaining aisle", "remaining aisles").capitaliseFirstLetter() + ".";
            if (progress_remaining <= 0)
                line += "MacGuffin next turn";
            else
                line += "Fight " + progress_remaining + " more combats";
            if (progress_remaining > 1)
            {
                int page_pairs_remaining = ceil(progress_remaining.to_float() / 8.0);
                
                /*string [int] bring_me_the_red_pages;
                
                int first_value = -1;
                boolean identical_twins = false;
                foreach it in $items[warehouse inventory page,warehouse map page]
                {
                    int pages_remaining = page_pairs_remaining - it.available_amount();
                    if (pages_remaining > 0)
                    {
                        if (first_value == -1)
                            first_value = pages_remaining;
                        else if (first_value == pages_remaining)
                        {
                            identical_twins = true;
                            bring_me_the_red_pages.listAppend(it);
                            continue;
                        }
                        bring_me_the_red_pages.listAppend(pluraliseWordy(pages_remaining, it));
                    }
                }
                
                if (identical_twins)
                    line += bring_me_the_red_pages.listJoinComponents("/");
                else
                    line += bring_me_the_red_pages.listJoinComponents(", ", "and");*/
                    
                line += " or collect ";
                line += pluraliseWordy(page_pairs_remaining, "more page pair", "more page pairs");
            }
            line += ".";
            description.listAppend(line);
            
            task_entries.listAppend(ChecklistEntryMake(199, "__item 2334", url, ChecklistSubentryMake("Retrieve the Holy MacGuffin", modifiers, description), $locations[The Secret Council Warehouse]));
        }
    }
}

RegisterResourceGenerationFunction("PathActuallyEdtheUndyingGenerateResource");
void PathActuallyEdtheUndyingGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (my_path_id() != PATH_ACTUALLY_ED_THE_UNDYING) return;
    item ka = $item[Ka coin];
    if (ka.available_amount() > 0)
    {
        string [int] description;
        
        string [int][int] ka_table;
        
        int haunches_edible = clampi(availableSpleen() / 5, 0, 7);
        if (haunches_edible > $item[mummified beef haunch].available_amount())
        {
            int haunches_want = haunches_edible - $item[mummified beef haunch].available_amount();
            //15 ka coin
            string name;
            if (haunches_want > 1)
                name = pluralise(haunches_want, $item[mummified beef haunch]);
            else
                name = "mummified beef haunch";
            ka_table.listAppend(listMake(name, 15, "best spleen consumable"));
        }
        if ($item[linen bandages].available_amount() == 0 && $item[cotton bandages].available_amount() == 0 && $item[silk bandages].available_amount() == 0)
        {
            //linen bandages, 1 ka coin
            ka_table.listAppend(listMake("linen bandages", 1, "when beaten up outside a fight"));
        }
        
        //seven talisman of Renenutet (1 ka coin)
        //talisman of Horus (5 ka coin, +combat)
        int talismen_of_horus_wanted = 0;
        if (!__quest_state["Level 8"].state_boolean["Mountain climbed"])
            talismen_of_horus_wanted += 2;
        if (!__quest_state["Level 12"].state_boolean["Lighthouse Finished"] && $item[barrel of gunpowder].available_amount() < 5)
            talismen_of_horus_wanted += 2;
        if ($item[pirate fledges].available_amount() == 0 && $item[talisman o' namsilat].available_amount() == 0)
            talismen_of_horus_wanted += 2;
        if (talismen_of_horus_wanted == 0) //where else do you need +combat? pirate's cove?
            talismen_of_horus_wanted = 1;
        if ($item[talisman of Horus].available_amount() < talismen_of_horus_wanted)
        {
            ka_table.listAppend(listMake("talisman of Horus", 5, "+combat potion"));
        }
        ka_table.listAppend(listMake("talisman of Renenutet", 1, "+lots item for one combat"));
        //body upgrades:
        string [int][int] skill_upgrade_order;
        skill_upgrade_order.listAppend(listMake("Extra Spleen", 5, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Another Extra Spleen", 10, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Yet Another Extra Spleen", 15, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Still Another Extra Spleen", 20, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Replacement Stomach", 30, "+5 stomach")); //fortune cookie
        skill_upgrade_order.listAppend(listMake("Just One More Extra Spleen", 25, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Okay Seriously, This is the Last Spleen", 30, "+5 spleen"));
        skill_upgrade_order.listAppend(listMake("Replacement Liver", 30, "can drink"));
        skill_upgrade_order.listAppend(listMake("Upgraded Legs", 10, "+50% init"));
        skill_upgrade_order.listAppend(listMake("More Legs", 20, "+50% init"));
        skill_upgrade_order.listAppend(listMake("Elemental Wards", 10, "+1 all res"));
        skill_upgrade_order.listAppend(listMake("More Elemental Wards", 20, "+2 all res"));
        skill_upgrade_order.listAppend(listMake("Tougher Skin", 10, "+100 DA"));
        skill_upgrade_order.listAppend(listMake("Even More Elemental Wards", 30, "+3 all res"));
        skill_upgrade_order.listAppend(listMake("Upgraded Spine", 20, "+50% moxie"));
        skill_upgrade_order.listAppend(listMake("Upgraded Arms", 20, "+50% muscle"));
        skill_upgrade_order.listAppend(listMake("Armor Plating", 10, "+10 DR")); //marginal
        //skill_upgrade_order.listAppend(listMake("Bone Spikes", 20));
        //skill_upgrade_order.listAppend(listMake("Arm Blade", 20));
        //skill_upgrade_order.listAppend(listMake("Healing Scarabs")); //only useful if it prevents beaten up from non-combats?
        
        foreach key in skill_upgrade_order
        {
            string [int] l = skill_upgrade_order[key];
            skill s = l[0].lookupSkill();
            int ka_cost = l[1].to_int_silent();
            string reason = l[2];
            if (s == $skill[none])
                break;
            if (s.have_skill()) continue;
            
            
            /*string line = "Could upgrade your body with " + s + ".";
            if (ka_cost > ka.available_amount())
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);*/
            ka_table.listAppend(listMake(s, ka_cost, reason));
            break;
        }
        
        if (ka_table.count() > 0)
        {
            foreach key in ka_table
            {
                int ka_needed = ka_table[key][1].to_int_silent();
                if (ka_needed > ka.available_amount())
                {
                    foreach key2 in ka_table[key]
                    {
                        ka_table[key][key2] = HTMLGenerateSpanFont(ka_table[key][key2], "grey");
                    }
                }
            }
            description.listAppend(HTMLGenerateSimpleTableLines(ka_table));
        }
        
        string url = "";
        string [int] places_to_farm_ka;
        if (getHolidaysToday()["Halloween"])
        {
            places_to_farm_ka.listAppend("trick or treating");
            url = "place.php?whichplace=town";
        }
        if (__misc_state["spooky airport available"])
        {
            places_to_farm_ka.listAppend("laboratory on conspiracy island");
            if (url.length() == 0) url = $location[the secret government laboratory].getClickableURLForLocation();
        }
        if (__misc_state["hot airport available"])
        {
            places_to_farm_ka.listAppend("smooch army HQ");
            if (url.length() == 0) url = $location[The SMOOCH Army HQ].getClickableURLForLocation();
        }
        if (__misc_state["mysterious island available"] && !__quest_state["Level 12"].in_progress && my_level() < 9) //we test if we're under level 9 and the level 12 quest isn't in progress. maybe they ate a lot of hot dogs. it could happen!
        {
            places_to_farm_ka.listAppend("hippy camp");
            if (url.length() == 0) url = $location[hippy camp].getClickableURLForLocation();
        }
        if (!__misc_state["mysterious island available"] && my_basestat($stat[mysticality]) < 40)
        {
            places_to_farm_ka.listAppend("sleazy back alley (last resort)");
        }
        
        if (places_to_farm_ka.count() > 0)
            description.listAppend("Could farm ka in the " + places_to_farm_ka.listJoinComponents(", ", "or") + ".");
        
        resource_entries.listAppend(ChecklistEntryMake(200, "__item ka coin", url, ChecklistSubentryMake(ka.pluralise(), "", description), 6));
    }
    
    if (true)
    {
        ChecklistSubentry [int] subentries;
        string image_name = "";
        string [item] path_relevant_items;
        
        path_relevant_items[$item[talisman of Renenutet]] = "+lots% item in a single combat";
        path_relevant_items[$item[talisman of Horus]] = "+lots% combat potion";
        path_relevant_items[$item[ancient cure-all]] = "SGEEA-equivalent?";
        foreach s in $strings[linen bandages,cotton bandages,silk bandages]
        {
            if (lookupItem(s).available_amount() > 0)
            {
                path_relevant_items[lookupItem(s)] = "heal at zero HP";
                break;
            }
        }
        foreach it, reason in path_relevant_items
        {
            if (it.available_amount() > 0)
            {
                subentries.listAppend(ChecklistSubentryMake(pluralise(it), "", reason.capitaliseFirstLetter() + "."));
                if (image_name.length() == 0)
                    image_name = "__item " + it;
            }
        }
        if (subentries.count() > 0)
            resource_entries.listAppend(ChecklistEntryMake(201, image_name, "", subentries, 6));
    }
    
    if ($skill[Lash of the cobra].have_skill())
    {
        int lashes_remaining = 30 - get_property_int("_edLashCount");
        if (lashes_remaining > 0)
        {
            string [int] description;
            string [int] stealables;
            //Stuff:
            //snake +ML
            //badge of authority (HC)
            //warehouse
            //barret, aerith
            //pygmy witch lawyers
            //filthworms
            //war hippy drill sergeant
            //war outfit (if wrath of ra not available)
            //pirate outfit? specific monsters left
            //hot wings from p imp / g imp
            //beanbats (if unlocked, else batrats/ratbats, else guano junction)
            //skeletons in the nook
            //topiary animals in twin peak
            //dusken raider ghost (if oil needed)
            //oil cartel(?)
            if (stealables.count() > 0)
                description.listAppend("Steals a random item:|*" + stealables.listJoinComponents("|*"));
            else
                description.listAppend("Steals a random item.");
                
            resource_entries.listAppend(ChecklistEntryMake(202, "__item cool whip", "", ChecklistSubentryMake(pluralise(lashes_remaining, "lash", "lashes") + " of the cobra left", "", description), 6));
        }
    }
}
boolean PathJarlsbergGenerateStaff(ChecklistEntry entry, item staff, string property_name, string description, boolean always_output)
{
    if (staff.available_amount() == 0)
        return false;
    
    
    int uses_remaining = MAX(0, 5 - get_property_int(property_name));
    if (uses_remaining > 0 || always_output)
    {
        string title;
        title = staff;
        if (uses_remaining != 0)
        {
            title = uses_remaining + " " + staff.to_string().replace_string("Staff of the ", "");
            if (staff == $item[Staff of the Standalone Cheese])
            {
                if (uses_remaining == 1)
                    title += " staff banish";
                else
                    title += " staff banishes";
            }
            else
            {
                if (uses_remaining == 1)
                    title += " use";
                else
                    title += " uses";
            }
        }
            //description = pluraliseWordy(uses_remaining, "use remains", "uses remain").capitaliseFirstLetter() + ".|" + description;
        entry.subentries.listAppend(ChecklistSubentryMake(title, "", description));
        if (entry.image_lookup_name == "")
            entry.image_lookup_name = "__item " + staff;
        return true;
    }
    return false;
}


RegisterResourceGenerationFunction("PathJarlsbergGenerateResource");
void PathJarlsbergGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_AVATAR_OF_JARLSBERG)
		return;
    
	ChecklistEntry entry = ChecklistEntryMake(183);
	entry.url = "";
	entry.image_lookup_name = "";
    
    
    //wizard staff:
    //Show uses:
    //_jiggleCheesedMonsters split by |
    
    PathJarlsbergGenerateStaff(entry, $item[Staff of the All-Steak], "_jiggleSteak", "+300% items.", false);
    
    if (true)
    {
        string olfacted_monster = get_property("_jiggleCreamedMonster");
        boolean always_output = false;
        string cream_line = "Monster olfaction";
        if (olfacted_monster != "")
        {
            always_output = true;
            cream_line += "|Following a " + olfacted_monster.HTMLEscapeString() + ".";
        }
        PathJarlsbergGenerateStaff(entry, $item[Staff of the Cream of the Cream], "_jiggleCream", cream_line, always_output);
    }
    if (true)
    {
        //I must capture the avatar (of jarlsberg) to regain my honor
        string [int] banished_monsters = split_string_alternate(get_property("_jiggleCheesedMonsters"), "\\|");
        boolean always_output = false;
        string cheese_line = "";
        if (get_property("_jiggleCheesedMonsters") != "")
        {
            cheese_line += "Monsters banished: " + banished_monsters.listJoinComponents(", ", "and").HTMLEscapeString() + ".";
            always_output = true;
        }
        
    	ChecklistEntry entry2;
        boolean should_add = PathJarlsbergGenerateStaff(entry2, $item[Staff of the Standalone Cheese], "_jiggleCheese", cheese_line, always_output);
        entry2.ChecklistEntryTag("banish");
        if (should_add)
	        resource_entries.listAppend(entry2);
    }
    PathJarlsbergGenerateStaff(entry, $item[Staff of the Staff of Life], "_jiggleLife", "Restores all HP.", false);
    
    if (entry.subentries.count() > 0)
        resource_entries.listAppend(entry);
}


RegisterResourceGenerationFunction("PathSneakyPeteGenerateResource");
void PathSneakyPeteGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_AVATAR_OF_SNEAKY_PETE)
		return;
    
    
	ChecklistEntry entry = ChecklistEntryMake(148);
	entry.url = "";
	entry.image_lookup_name = "";
    entry.importance_level = 1;
    
    if (true)
    {
        int total_free_peel_outs_available = 10;
        if (get_property("peteMotorbikeTires") == "Racing Slicks")
            total_free_peel_outs_available += 20;
        
        int free_peel_outs_available = MAX(0, total_free_peel_outs_available - get_property_int("_petePeeledOut"));
        
        if ($skill[Peel Out].skill_is_usable() && free_peel_outs_available > 0)
        {
            string [int] description;
            
            boolean is_banish = false;
            if (get_property("peteMotorbikeMuffler") == "Extra-Smelly Muffler")
            {
                description.listAppend("Free runaway/banish in-combat.");
                is_banish = true;
            }
            else
                description.listAppend("Free runaway in-combat.");
            
            if (entry.image_lookup_name.length() == 0)
                entry.image_lookup_name = "__skill Easy Riding";
        
        	ChecklistSubentry subentry = ChecklistSubentryMake(pluralise(free_peel_outs_available, "peel out", "peel outs"), "10 MP/cast", description);
            if (is_banish)
            	resource_entries.listAppend(ChecklistEntryMake(149, "__skill Easy Riding", "", subentry).ChecklistEntryTag("free banish"));
            else
	            entry.subentries.listAppend(subentry);
        }
    }
    
    if ($skill[Fix Jukebox].skill_is_usable() && get_property_int("_peteJukeboxFixed") < 3)
    {
        int uses_remaining = MAX(0, 3 - get_property_int("_peteJukeboxFixed"));
        
        string [int] description;
        description.listAppend("+300% item, one combat.");
        description.listAppend("+10 audience love.");
        
        if (entry.image_lookup_name.length() == 0)
            entry.image_lookup_name = "__effect jukebox hero";
        
        string [int] targets;
        //banshee, a batrat for sonar, harem girl (contested), burly sidekick, quiet healer, filthworms, f'c'le without natural dancer, a-boo clues
        if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"] && !__quest_state["Level 11 Desert"].state_boolean["Killing Jar Given"] && $item[killing jar].available_amount() == 0)
            targets.listAppend("Haunted Library - Banshee - Killing Jar to speed up desert exploration.");
        if (__quest_state["Level 4"].state_int["areas unlocked"] + $item[sonar-in-a-biscuit].available_amount() < 3)
            targets.listAppend("Batrat/Ratbat - Sonar-in-a-biscuit.");
        
        if (!have_outfit_components("Knob Goblin Elite Guard Uniform") && !have_outfit_components("Knob Goblin Harem Girl Disguise") && !__quest_state["Level 5"].finished)
            targets.listAppend("Harem Girl - disguise for quest. (20% drop)");
        
		if (!__quest_state["Level 10"].finished && $item[mohawk wig].available_amount() == 0 && $item[s.o.c.k.].available_amount() == 0)
			targets.listAppend("Burly Sidekick (Mohawk wig) - speed up top floor of castle.");
        if ($item[amulet of extreme plot significance].available_amount() == 0 && !__quest_state["Level 10"].finished && !$location[The Castle in the Clouds in the Sky (Ground floor)].locationAvailable() && $item[s.o.c.k.].available_amount() == 0)
			targets.listAppend("Quiet Healer (amulet of extreme plot significance) - speed up castle basement.");
		if (!__quest_state["Level 12"].state_boolean["Orchard Finished"])
			targets.listAppend("Filthworms.");
            
        if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0 && $item[a-boo clue].available_amount() < 3)
            targets.listAppend("A-Boo Peak - a-boo clues. (15% drop)");
        
        if (targets.count() > 0)
            description.listAppend("Potential targets:|*" + targets.listJoinComponents("<hr>|*"));
        
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(uses_remaining, "jukebox fix", "jukebox fixes"), "25 MP", description));
    }
    
    if ($skill[Jump Shark].skill_is_usable() && get_property_int("_peteJumpedShark") < 3)
    {
        int uses_remaining = MAX(0, 3 - get_property_int("_peteJumpedShark"));
        
        string [int] description;
        description.listAppend((10 * my_level()) + " muscle/mysticality/moxie. (increases with level)");
        description.listAppend("+10 audience hate.");
        
        if (entry.image_lookup_name.length() == 0)
            entry.image_lookup_name = "__skill jump shark";
        entry.subentries.listAppend(ChecklistSubentryMake(pluralise(uses_remaining, "shark jump", "shark jumps"), "25 MP", description));
    }
    
    
    if (entry.subentries.count() > 0)
        resource_entries.listAppend(entry);
}

RegisterTaskGenerationFunction("PathSneakyPeteGenerateTasks");
void PathSneakyPeteGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_AVATAR_OF_SNEAKY_PETE)
		return;
    
    
    if (true)
    {
        string [int] parts_not_upgraded;
        int motorcycle_upgrades_have = 0;
        
        foreach s in $strings[peteMotorbikeTires,peteMotorbikeGasTank,peteMotorbikeHeadlight,peteMotorbikeCowling,peteMotorbikeMuffler,peteMotorbikeSeat]
        {
            if (get_property(s) != "")
                motorcycle_upgrades_have += 1;
            else
                parts_not_upgraded.listAppend(s);
        }
        int motorcycle_upgrades_available = MIN(6, my_level() / 2);
        
        if (motorcycle_upgrades_have < motorcycle_upgrades_available)
        {
            string [int] description;
            description.listAppend(pluralise(motorcycle_upgrades_available - motorcycle_upgrades_have, "upgrade", "upgrades") + " available.");
            
            string [int] upgrades;
            foreach key in parts_not_upgraded
            {
                string property_name = parts_not_upgraded[key];
                
                string name = "";
                string [int] options;
                
                if (property_name == "peteMotorbikeSeat")
                {
                    name = "Seat";
                    
                    options.listAppend("regenerate 5-6 HP/MP");
                    options.listAppend("find meat after combat (marginal)");
                    options.listAppend("-30 ML (harmful)");
                }
                else if (property_name == "peteMotorbikeCowling")
                {
                    name = "Cowling";
                    if (__quest_state["Level 7"].state_int["alcove evilness"] > 26 || __quest_state["Level 7"].state_int["cranny evilness"] > 26 || __quest_state["Level 7"].state_int["niche evilness"] > 26 || __quest_state["Level 7"].state_int["nook evilness"] > 26)
                        options.listAppend("faster cyrpt");
                    if (__quest_state["Level 12"].finished)
                        options.listAppend("passive +damage/round");
                    else
                        options.listAppend("passive +damage/round and +3 war kills");
                    options.listAppend("+5 stats/fight");
                }
                else if (property_name == "peteMotorbikeGasTank")
                {
                    name = "Gas tank";
                
                    if (!knoll_available() && !__misc_state["desert beach available"])
                        options.listAppend("desert beach access");
                    if (!__misc_state["mysterious island available"])
                        options.listAppend("mysterious island access");
                    options.listAppend("+50% combat initiative");
                }
                else if (property_name == "peteMotorbikeHeadlight")
                {
                    name = "Headlight";
                    
                    if ($skill[Flash Headlight].skill_is_usable())
                    {
                        options.listAppend("yellow ray from flash headlight");
                        options.listAppend("prismatic damage from flash headlight");
                    }
                    else
                    {
                        options.listAppend("yellow ray (need flash headlight)");
                        options.listAppend("prismatic damage (need flash headlight)");
                    }
                    if (!__quest_state["Level 11 Desert"].state_boolean["Desert Explored"])
                        options.listAppend("+2% desert exporation");
                }
                else if (property_name == "peteMotorbikeMuffler")
                {
                    name = "Muffler";
                    if ($skill[Rev Engine].skill_is_usable())
                    {
                        options.listAppend("+combat% from rev engine");
                        options.listAppend("-combat% from rev engine");
                    }
                    else
                    {
                        options.listAppend("+X% combat from rev engine (need skill)");
                        options.listAppend("-X% combat from rev engine (need skill)");
                    }
                    if ($skill[Peel Out].skill_is_usable())
                        options.listAppend("peel out banishes");
                    else
                        options.listAppend("peel out banishes (need skill)");
                }
                else if (property_name == "peteMotorbikeTires")
                {
                    name = "Tires";
                    if ($skill[Peel Out].skill_is_usable())
                        options.listAppend("extra free runs with peel out");
                    else
                        options.listAppend("extra free runs (need peel out)");
                    if ($skill[Pop Wheelie].skill_is_usable())
                        options.listAppend("pop wheelie does more damage");
                    else
                        options.listAppend("pop wheelie does more damage (need skill)");
                    
                    if (!__quest_state["Level 8"].state_boolean["Mountain climbed"])
                        options.listAppend("near-instant level 8 quest completion");
                }
                
                if (name != "")
                {
                    upgrades.listAppend(HTMLGenerateSpanOfClass(name, "r_bold") + " - " + options.listJoinComponents(", ", "or").capitaliseFirstLetter() + ".");
                    //upgrades.listAppend(HTMLGenerateSpanOfClass(name, "r_bold") + "|*" + options.listJoinComponents("|*"));
                }
            }
            description.listAppendList(upgrades);


            optional_task_entries.listAppend(ChecklistEntryMake(150, "__skill Easy Riding", "main.php?action=motorcycle", ChecklistSubentryMake("Upgrade your bike", "", description), 11));
            
        }
    }
    
    if ($skill[Check Mirror].skill_is_usable())
    {
        boolean have_intrinsic = false;
        foreach s in $strings[1553,Pompadour,Cowlick,Fauxhawk]
        {
            effect e = s.lookupEffect();
            if (e == $effect[none])
            {
                have_intrinsic = true; //can't track
                continue;
            }
            if (e.have_effect() == 2147483647)
                have_intrinsic = true;
        }
        if (!have_intrinsic)
        {
            string [int] description;
            
            description.listAppend("One adventure cost for an intrinsic.");
            string [int] options;
            options.listAppend("+3 all resistances (slicked-back do)");
            options.listAppend("+3 stats/fight (best, pompadour)");
            if (my_audience() >= 20)
                options.listAppend("+50% meat (cowlick)");
            else
                options.listAppend(HTMLGenerateSpanFont("+50% meat (requires 20 love)", "grey"));
            if (my_audience() <= -20)
                options.listAppend("+50% init (fauxhawk)");
            else
                options.listAppend(HTMLGenerateSpanFont("+50% init (requires 20 hate)", "grey"));
                
            //description.listAppend("Potential options:|*|*|*+|*");
            description.listAppend("Potential options:|*" + options.listJoinComponents("|*"));
            optional_task_entries.listAppend(ChecklistEntryMake(151, "__skill Check Mirror", "skills.php", ChecklistSubentryMake("Check mirror", "", description), 11));
        }
    }
    int audience_max = 30;
    if ($item[Sneaky Pete's leather jacket].equipped_amount() > 0 || $item[Sneaky Pete's leather jacket (collar popped)].equipped_amount() > 0)
    {
        audience_max = 50;
    }
    if ($skill[Throw Party].skill_is_usable() && my_audience() == audience_max && !get_property_boolean("_petePartyThrown"))
        task_entries.listAppend(ChecklistEntryMake(152, "__item party hat", "skills.php", ChecklistSubentryMake("Throw a party!", "", "Drinks."), -11));
    if ($skill[Incite Riot].skill_is_usable() && my_audience() == -audience_max && !get_property_boolean("_peteRiotIncited"))
        task_entries.listAppend(ChecklistEntryMake(153, "__item fire", "skills.php", ChecklistSubentryMake("Incite a riot", "", "Breaking the law, breaking the law."), -11));
    
    //sneakyPetePoints first
    int skills_available = MIN(30, MIN(15, my_level()) + get_property_int("sneakyPetePoints"));
    
    int skills_have = 0;
    //foreach s in $skills[Catchphrase,Mixologist,Throw Party,Fix Jukebox,Snap Fingers,Shake It Off,Check Hair,Cocktail Magic,Make Friends,Natural Dancer,Rev Engine,Born Showman,Pop Wheelie,Rowdy Drinker,Peel Out,Easy Riding,Check Mirror,Riding Tall,Biker Swagger,Flash Headlight,Insult,Live Fast,Incite Riot,Jump Shark,Animal Magnetism,Smoke Break,Hard Drinker,Unrepentant Thief,Brood,Walk Away From Explosion]
    foreach s in lookupSkillsInt($ints[15027,15019,15012,15028,15001,15007,15017,15008,15016,15004,15020,15025,15031,15021,15024,15023,15009,15002,15010,15015,15013,15011,15018,15014,15006,15026,15005,15003,15032,15030])
    {
        if (s.skill_is_usable())
            skills_have += 1;
    }
    
    if (skills_available > skills_have)
    {
        string [int] description;
        description.listAppend("At least " + pluraliseWordy(skills_available - skills_have, "skill", "skills") + " available.");
        optional_task_entries.listAppend(ChecklistEntryMake(154, "__skill Natural Dancer", "da.php?place=gate3", ChecklistSubentryMake("Buy Sneaky Pete skills", "", description), 11));
    }
}

RegisterResourceGenerationFunction("PathAvatarOfWestOfLoathingGenerateResource");
void PathAvatarOfWestOfLoathingGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING && !($classes[snake oiler,beanslinger,cow puncher] contains my_class()))
		return;
    
    //Oils:
    string image_name = "";
    ChecklistSubentry [int] subentries;
    
    if ($skill[Extract Oil].have_skill())
    {
        int oils_extracted = get_property_int("_oilExtracted");
        int oils_remaining = clampi(15 - oils_extracted, 0, 15);
        if (oils_extracted < 15)
        {
            string description;
            if (oils_extracted >= 5)
            {
                int percentage_left = clampi(100 - (oils_extracted - 5) * 10, 0, 100);
                description = percentage_left + "% chance.";
            }
            item monster_oil_type = lookupAWOLOilForMonster(last_monster());
            if (monster_oil_type != $item[none])
            {
                if (description != "")
                    description += " ";
                description += monster_oil_type.capitaliseFirstLetter() + " against " + last_monster() + ".";
            }
            if (image_name == "")
                image_name = "__item Snake oil";
            subentries.listAppend(ChecklistSubentryMake(pluralise(oils_remaining, "extractable oil", "extractable oils"), "", description));
        }
    }
    float [int] subentries_sort_value;
    
    string [item] tonic_descriptions;
    tonic_descriptions[$item[Eldritch oil]] = "craftable";
    tonic_descriptions[$item[Unusual oil]] = "+50% item (20 turns), craftable";
    tonic_descriptions[$item[Skin oil]] = "+100% moxie (20 turns), craftable";
    tonic_descriptions[$item[Snake oil]] = "+venom/medicine, craftable";
    
    tonic_descriptions[$item[patent alacrity tonic]] = "+100% init (20 turns)"; //eldritch + unusual
    tonic_descriptions[$item[patent sallowness tonic]] = "+30 ML (50 turns)"; //eldritch + skin
    tonic_descriptions[$item[patent avarice tonic]] = "+50% meat (30 turns)"; //skin + unusual
    tonic_descriptions[$item[patent invisibility tonic]] = "-15% combat (30 turns)"; //eldritch + snake
    tonic_descriptions[$item[patent aggression tonic]] = "+15% combat (30 turns)"; //unusual + snake
    tonic_descriptions[$item[patent preventative tonic]] = "+3 all res (30 turns)"; //skin + snake
    
    foreach it in tonic_descriptions
    {
        if (it.available_amount() == 0 && it.creatable_amount() == 0)
            continue;
        
        string description = tonic_descriptions[it];
        if (image_name == "")
            image_name = "__item " + it;
        string name;
        if (it.available_amount() > 0)
            name = pluralise(it);
        if (it.creatable_amount() > 0)
        {
            if (it.available_amount() != 0)
                name += " (" + it.creatable_amount() + " craftable)";
            else
                name = pluralise(it.creatable_amount(), "craftable " + it, "craftable " + it.plural);
        }
        if (it.available_amount() == 0)
        {
            subentries_sort_value[subentries.count()] = 1.0;
            name = HTMLGenerateSpanFont(name, "grey");
            description = HTMLGenerateSpanFont(description, "grey");
        }
        else
        {
            subentries_sort_value[subentries.count()] = 0.0;
        }
        subentries.listAppend(ChecklistSubentryMake(name, "", description));
    }
    sort subentries by subentries_sort_value[index];
    if (subentries.count() > 0)
        resource_entries.listAppend(ChecklistEntryMake(176, image_name, "", subentries, 2));
    
    
    //Should we display beancannon in aftercore? I guess we could suggest a cheap source of it...? Maybe another time.
    if ($skill[Beancannon].have_skill() && in_ronin())
    {
        string [int] banish_sources;
        int banish_count = 0;
        int equipped_amount = 0;
        foreach it in __beancannon_source_items
        {
            if (it.available_amount() == 0)
                continue;
            banish_count += it.available_amount();
            string description = it;
            if (it.available_amount() > 1)
                description = it.pluralise();
            equipped_amount += it.equipped_amount();
            banish_sources.listAppend(description);
        }
        if (banish_count > 0 || !in_ronin())
        {
            string [int] description;
            if (banish_sources.count() > 0)
                description.listAppend("From " + banish_sources.listJoinComponents(", ", "and").capitaliseFirstLetter() + ".");
            string url = "";
            if (equipped_amount == 0)
            {
                description.listAppend("Equip one before banishing.");
                url = "inventory.php?which=2";
            }
            string title = pluralise(banish_count, "beancannon banish", "beancannon banishes");
            if (!in_ronin())
                title = "Beancannon banishes";
            resource_entries.listAppend(ChecklistEntryMake(177, "__skill beancannon", url, ChecklistSubentryMake(title, "", description), 8).ChecklistEntryTag("banish"));
        }
    }
    
    if ($skill[Long Con].have_skill() && get_property_int("_longConUsed") < 5)
    {
        int uses_remaining = clampi(5 - get_property_int("_longConUsed"), 0, 5);
        string [int] description;
        string line = "Olfaction.";
        description.listAppend(line);
        resource_entries.listAppend(ChecklistEntryMake(178, "__effect Greaser Lightnin'", "", ChecklistSubentryMake(pluralise(uses_remaining, "long con", "long cons") + " remaining", "", description), 8));
    }
}


RegisterTaskGenerationFunction("PathAvatarOfWestOfLoathingGenerateTasks");
void PathAvatarOfWestOfLoathingGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_AVATAR_OF_WEST_OF_LOATHING)
		return;
    string skill_url;
    ChecklistSubentry [int] skill_subentries;
    
    int [class] class_points;
    class_points[my_class()] = my_level();
    class_points[$class[Cow Puncher]] += get_property_int("awolPointsCowpuncher");
    class_points[$class[Beanslinger]] += get_property_int("awolPointsBeanslinger");
    class_points[$class[Snake Oiler]] += get_property_int("awolPointsSnakeoiler");
    
    item [class] tale_for_class;
    tale_for_class[$class[Cow Puncher]] = $item[tales of the west: Cow Punching];
    tale_for_class[$class[Beanslinger]] = $item[Tales of the West: Beanslinging];
    tale_for_class[$class[Snake Oiler]] = $item[Tales of the West: Snake Oiling];
    
    boolean [class] have_advanced_skills_for_class;
    if ($skill[Unleash Cowrruption].have_skill() || $skill[[18008]Hard Drinker].have_skill() || $skill[Walk: Cautious Prowl].have_skill())
        have_advanced_skills_for_class[$class[Cow Puncher]] = true;
    if ($skill[Beancannon].have_skill() || $skill[Prodigious Appetite].have_skill() || $skill[Walk: Prideful Strut].have_skill())
        have_advanced_skills_for_class[$class[Beanslinger]] = true;
    if ($skill[Long Con].have_skill() || $skill[Tolerant Constitution].have_skill() || $skill[Walk: Leisurely Amble].have_skill())
        have_advanced_skills_for_class[$class[Snake Oiler]] = true;
    float priority = 0;
    foreach c in class_points
    {
        int total_points_available = class_points[c];
        if (total_points_available == 0)
            continue;
        
        int class_skills_learned = 0;
        foreach key, s in __skills_by_class[c]
        {
            if (s.have_skill())
                class_skills_learned += 1;
        }
        if (class_skills_learned >= 10)
            continue;
        
        int skills_left_to_learn = total_points_available - class_skills_learned;
        if (skills_left_to_learn <= 0)
            continue;
        
        int limit = 7; //theoretically, they might be unable to learn the advanced skills, so only make this a priority if we're under that or know we have advanced skills
        if (have_advanced_skills_for_class[c])
            limit = 10;
        if (class_skills_learned < limit)
            priority = -11;
        item tale = tale_for_class[c];
        
        string title = "Learn a " + c + " skill";
        if (skills_left_to_learn > 1)
            title = "Learn " + skills_left_to_learn.int_to_wordy() + " " + c + " skills";
        if (skill_url == "")
        {
            skill_url = "inv_use.php?pwd=" + my_hash() + "&whichitem=" + tale.to_int();
        }
        skill_subentries.listAppend(ChecklistSubentryMake(title, "", "Use " + tale + "."));
    }
    
    if (skill_subentries.count() > 0)
    {
        task_entries.listAppend(ChecklistEntryMake(179, "__item tales of the west: beanslinging", skill_url, skill_subentries, priority));
    }
    
    if (my_class() == $class[Cow Puncher] && $item[corrupted marrow].available_amount() > 0 && $item[corrupted marrow].to_effect().have_effect() < 100 && in_ronin())
    {
        task_entries.listAppend(ChecklistEntryMake(180, "__effect Cowrruption", "inventory.php?which=3", ChecklistSubentryMake("Use corrupted marrow", "", "+200% weapon damage/spell damage"), -11));
    }
}


RegisterTaskGenerationFunction("PathBugbearInvasionGenerateTasks");
void PathBugbearInvasionGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_BUGBEAR_INVASION)
		return;
    if (!__misc_state["in run"])
        return;
    
    
    //task_entries.listAppend(ChecklistEntryMake(184, "bugbear", "place.php?whichplace=bugbearship", ChecklistSubentryMake("Bugbears!", "", "I have no idea.")));
    
    /*
        Properties:
        statusEngineering
        statusGalley
        statusMedbay
        statusMorgue
        statusNavigation
        statusScienceLab
        statusSonar
        statusSpecialOps
        statusWasteProcessing
        mothershipProgress
        
        Possible values for status:
        [number] - Number of biodata collected.
        unlocked - area unlocked, but floor not open in mothership...?
        open - area unlocked, area available
        cleared - maybe?
        
        mothershipProgress: 0 at start
        1 when unlocked science lab, morgue, and special ops
        2 when unlocked engineering, navigation, galley
        3 when unlocked bridge
        
    */
    //Let's see... first you need a key-o-tron to access the mothership.
    //With that, you can collect biometric data for each area.
    //Then there's mothershipProgress for each zone and tasks for each zone.
    
    boolean defiled_nook_open = true;
    if (get_property_int("cyrptNookEvilness") == 0 && __quest_state["Level 7"].started)
        defiled_nook_open = false;
    
    location [int] location_evaluation_order;
    location_evaluation_order.listAppend($location[Medbay]);
    location_evaluation_order.listAppend($location[Waste Processing]);
    location_evaluation_order.listAppend($location[Sonar]);
    location_evaluation_order.listAppend($location[Science Lab]);
    location_evaluation_order.listAppend($location[Morgue]);
    location_evaluation_order.listAppend($location[Special Ops]);
    location_evaluation_order.listAppend($location[Engineering]);
    location_evaluation_order.listAppend($location[Navigation]);
    location_evaluation_order.listAppend($location[Galley]);
    
        
    string [location] property_names_for_areas;
    property_names_for_areas[$location[Engineering]] = "statusEngineering"; //does not seem to track battlesuit types fought
    property_names_for_areas[$location[Galley]] = "statusGalley";
    property_names_for_areas[$location[Medbay]] = "statusMedbay";
    property_names_for_areas[$location[Morgue]] = "statusMorgue";
    property_names_for_areas[$location[Navigation]] = "statusNavigation";
    property_names_for_areas[$location[Science Lab]] = "statusScienceLab";
    property_names_for_areas[$location[Sonar]] = "statusSonar";
    property_names_for_areas[$location[Special Ops]] = "statusSpecialOps";
    property_names_for_areas[$location[Waste Processing]] = "statusWasteProcessing";
    
    string [location] image_name_for_location;
    image_name_for_location[$location[Engineering]] = "__monster " + $monster[liquid metal bugbear];
    image_name_for_location[$location[Galley]] = "__monster " + $monster[trendy bugbear chef];
    image_name_for_location[$location[Medbay]] = "__monster " + $monster[anesthesiologist bugbear];
    image_name_for_location[$location[Morgue]] = "__monster " + $monster[bugbear mortician];
    image_name_for_location[$location[Navigation]] = "__monster " + $monster[N-space Virtual Assistant];
    image_name_for_location[$location[Science Lab]] = "__monster " + $monster[bugbear scientist];
    image_name_for_location[$location[Sonar]] = "__monster " + $monster[batbugbear];
    image_name_for_location[$location[Special Ops]] = "__monster " + $monster[Black Ops Bugbear];
    image_name_for_location[$location[Waste Processing]] = "__monster " + $monster[scavenger bugbear];
    
    
    string [location] printable_names_for_areas;
    printable_names_for_areas[$location[Engineering]] = "the engineering room";
    printable_names_for_areas[$location[Galley]] = "the galley";
    printable_names_for_areas[$location[Medbay]] = "the medbay";
    printable_names_for_areas[$location[Morgue]] = "the morgue";
    printable_names_for_areas[$location[Navigation]] = "the navigation room";
    printable_names_for_areas[$location[Science Lab]] = "the science lab";
    printable_names_for_areas[$location[Sonar]] = "the sonar room";
    printable_names_for_areas[$location[Special Ops]] = "the special ops room";
    printable_names_for_areas[$location[Waste Processing]] = "the waste processing room";
    
    int [location] minimum_mothership_progress_for_area;
    minimum_mothership_progress_for_area[$location[Engineering]] = 2;
    minimum_mothership_progress_for_area[$location[Galley]] = 2;
    minimum_mothership_progress_for_area[$location[Navigation]] = 2;
    minimum_mothership_progress_for_area[$location[Morgue]] = 1;
    minimum_mothership_progress_for_area[$location[Science Lab]] = 1;
    minimum_mothership_progress_for_area[$location[Special Ops]] = 1;
    minimum_mothership_progress_for_area[$location[Medbay]] = 0;
    minimum_mothership_progress_for_area[$location[Sonar]] = 0;
    minimum_mothership_progress_for_area[$location[Waste Processing]] = 0;
    
    if ($item[key-o-tron].available_amount() == 0)
    {
        if ($item[key-o-tron].creatable_amount() > 0)
        {
            task_entries.listAppend(ChecklistEntryMake(185, "__item key-o-tron", "inv_use.php?pwd=" + my_hash() + "&whichitem=5683", ChecklistSubentryMake("Create key-o-tron", "", "Use 5 BURTs."), -11));
        }
        else
        {
            string url = "";
            int burts_needed = clampi(5 - $item[BURT].available_amount(), 0, 5);
            string [int] description;
            description.listAppend("To make a key-o-tron.");
            
            string [int] source_locations_available;
            string [int] source_locations_unavailable;
            //Possible areas:
            
            boolean [location] unavailable_locations_to_show = $locations[The Sleazy Back Alley,The Spooky Forest,cobb's knob Laboratory,The Defiled Nook,Lair of the Ninja Snowmen,The Penultimate Fantasy Airship,The Haunted Gallery,The Battlefield (Frat Uniform)];
            
            boolean [location] relevant_locations = $locations[The Sleazy Back Alley,The Spooky Forest,The Bat Hole Entrance,The Batrat and Ratbat Burrow,Guano Junction,The Beanbat Chamber,cobb's knob Laboratory,Lair of the Ninja Snowmen,The Penultimate Fantasy Airship,The Haunted Gallery,The Battlefield (Frat Uniform),The Orcish Frat House (Bombed Back to the Stone Age),The Hippy Camp (Bombed Back to the Stone Age)].makeConstantLocationArrayMutable();  //FIXME the battlefield (hippy uniform)?
            relevant_locations[$location[the very unquiet garves]] = true;
            
            if (defiled_nook_open)
                relevant_locations[$location[the defiled nook]] = true;
            else
                relevant_locations[$location[The VERY Unquiet Garves]] = true;
            
            //FIXME always URL in areas we have olfacted...?
            foreach l in relevant_locations
            {
                string place = l.to_string();
                
                if (!l.locationAvailable())
                {
                    if (unavailable_locations_to_show contains l)
                        source_locations_unavailable.listAppend(HTMLGenerateSpanFont(place, "grey"));
                }
                else
                {
                    source_locations_available.listAppend(place);
                    string place_url = l.getClickableURLForLocation();
                    if (place_url.length() != 0)
                        url = place_url;
                }
            }
            string line = "Places to collect them:|*" + source_locations_available.listJoinComponents("|*");
            if (source_locations_unavailable.count() > 0)
                line += "|*" + source_locations_unavailable.listJoinComponents("|*");
            description.listAppend(line);
            
            task_entries.listAppend(ChecklistEntryMake(186, "__item key-o-tron", url, ChecklistSubentryMake("Collect " + int_to_wordy(burts_needed) + " more BURT" + ((burts_needed) > 1 ? "s" : ""), "", description)));
        }
    }
    else
    {
        //
        location [location][int] locations_relevant_to_acquire_biodata;
        int [location] biodata_amount_needed_for_area;
        
        
        biodata_amount_needed_for_area[$location[Engineering]] = 9;
        biodata_amount_needed_for_area[$location[Galley]] = 9;
        biodata_amount_needed_for_area[$location[Medbay]] = 3;
        biodata_amount_needed_for_area[$location[Morgue]] = 6;
        biodata_amount_needed_for_area[$location[Navigation]] = 9;
        biodata_amount_needed_for_area[$location[Science Lab]] = 6;
        biodata_amount_needed_for_area[$location[Sonar]] = 3;
        biodata_amount_needed_for_area[$location[Special Ops]] = 6;
        biodata_amount_needed_for_area[$location[Waste Processing]] = 3;
        
        monster [location] bugbears_to_hunt_for_location;
        
        bugbears_to_hunt_for_location[$location[Engineering]] = $monster[Battlesuit Bugbear Type];
        bugbears_to_hunt_for_location[$location[Galley]] = $monster[trendy bugbear chef];
        bugbears_to_hunt_for_location[$location[Medbay]] = $monster[hypodermic bugbear];
        bugbears_to_hunt_for_location[$location[Morgue]] = $monster[bugaboo];
        bugbears_to_hunt_for_location[$location[Navigation]] = $monster[ancient unspeakable bugbear];
        bugbears_to_hunt_for_location[$location[Science Lab]] = $monster[bugbear scientist];
        bugbears_to_hunt_for_location[$location[Sonar]] = $monster[batbugbear];
        bugbears_to_hunt_for_location[$location[Special Ops]] = $monster[Black Ops Bugbear];
        bugbears_to_hunt_for_location[$location[Waste Processing]] = $monster[scavenger bugbear];
        
        foreach l in property_names_for_areas
        {
            locations_relevant_to_acquire_biodata[l] = listMakeBlankLocation();
        }
        
        locations_relevant_to_acquire_biodata[$location[waste processing]].listAppend($location[the sleazy back alley]);
        locations_relevant_to_acquire_biodata[$location[Medbay]].listAppend($location[the Spooky Forest]);
        locations_relevant_to_acquire_biodata[$location[Sonar]].listAppend($location[The Bat Hole Entrance]);
        locations_relevant_to_acquire_biodata[$location[Sonar]].listAppend($location[The Batrat and Ratbat Burrow]);
        locations_relevant_to_acquire_biodata[$location[Sonar]].listAppend($location[Guano Junction]);
        locations_relevant_to_acquire_biodata[$location[Sonar]].listAppend($location[The Beanbat Chamber]);
        
        locations_relevant_to_acquire_biodata[$location[Science Lab]].listAppend($location[cobb's knob laboratory]);
        
        
        locations_relevant_to_acquire_biodata[$location[Special Ops]].listAppend($location[Lair of the Ninja Snowmen]);
        locations_relevant_to_acquire_biodata[$location[Engineering]].listAppend($location[The Penultimate Fantasy Airship]);
        locations_relevant_to_acquire_biodata[$location[Navigation]].listAppend($location[The Haunted Gallery]);
        
        if (!__quest_state["Level 12"].finished)
        {
            locations_relevant_to_acquire_biodata[$location[Galley]].listAppend($location[The Battlefield (Frat Uniform)]);
        }
        else
        {
            //FIXME determine which side won
            locations_relevant_to_acquire_biodata[$location[Galley]].listAppend($location[The Orcish Frat House (Bombed Back to the Stone Age)]);
            locations_relevant_to_acquire_biodata[$location[Galley]].listAppend($location[The Hippy Camp (Bombed Back to the Stone Age)]);
        }
        
        if (defiled_nook_open)
            locations_relevant_to_acquire_biodata[$location[Morgue]].listAppend($location[the defiled nook]);
        else
            locations_relevant_to_acquire_biodata[$location[Morgue]].listAppend($location[The VERY Unquiet Garves]);
        
        string url = "";
        boolean do_not_override_url = false;
        
        string [int] description;
        boolean [location] relevant_locations;
        foreach l, biodata_needed in biodata_amount_needed_for_area
        {
            string biodata_have_string = get_property(property_names_for_areas[l]);
            if (!biodata_have_string.is_integer())
                continue;
            int biodata_have = biodata_have_string.to_int_silent();
            if (biodata_have >= biodata_needed)
                continue;
            int biodata_remaining = MAX(0, biodata_needed - biodata_have);
            
            //FIXME check if we have an area open
            location [int] areas_we_can_adventure_in;
            foreach key, l2 in locations_relevant_to_acquire_biodata[l]
            {
                areas_we_can_adventure_in.listAppend(l2);
                relevant_locations[l2] = true;
                
                string this_url = l2.getClickableURLForLocation();
                if (this_url != "" && !do_not_override_url && l2.locationAvailable())
                    url = this_url;
                if ($effect[on the trail].have_effect() > 0 && get_property_monster("olfactedMonster") == bugbears_to_hunt_for_location[l])
                {
                    do_not_override_url = true;
                }
            }
            if (areas_we_can_adventure_in.count() > 0 && l.turns_spent == 0)
            {
                
                boolean tracking_works = true;
                if ($locations[the Penultimate Fantasy Airship,Lair of the Ninja Snowmen] contains l && biodata_remaining == biodata_needed)
                    tracking_works = false;
                boolean at_least_one_area_open = false;
                foreach key, l in areas_we_can_adventure_in
                {
                    if (l.locationAvailable())
                        at_least_one_area_open = true;
                }
                string line;
                line += "Fight " + int_to_wordy(biodata_remaining);
                
                if (!tracking_works)
                    line += " total ";
                else
                    line += " more ";
                line += bugbears_to_hunt_for_location[l] + " in";
                
                if (areas_we_can_adventure_in.count() == 1)
                {
                    line += " " + areas_we_can_adventure_in.listJoinComponents("") + ".";
                    line += "|Unlocks " + l + ".";
                }
                else
                {
                    line += ": |*" + areas_we_can_adventure_in.listJoinComponents("|*");
                    line += "|*<hr>Unlocks " + l + ".";
                }
                if (!tracking_works)
                    line += "|Umm... unless you already did that. (no tracking)";
                if (!at_least_one_area_open)
                    line = HTMLGenerateSpanFont(line, "grey");
                description.listAppend(line);
            }
        }
        if (description.count() > 0)
        {
            if ($item[crayon shavings].available_amount() > 0)
                description.listPrepend($item[crayon shavings].available_amount().int_to_wordy().capitaliseFirstLetter() + " crayon shavings available for copying bugbears.");
            if ($item[bugbear detector].available_amount() > 0 && $item[bugbear detector].equipped_amount() == 0)
                description.listPrepend(HTMLGenerateSpanFont("Equip bugbear detector first.", "red"));
            task_entries.listAppend(ChecklistEntryMake(187, "__item software glitch", url, ChecklistSubentryMake("Collect biodata", "", description), relevant_locations));
        }
    }
    int mothership_progress = get_property_int("mothershipProgress");
    
    if (true)
    {
        ChecklistEntry entry = ChecklistEntryMake(188);
        entry.url = "place.php?whichplace=bugbearship";
        entry.image_lookup_name = "bugbear";
        foreach key, l in location_evaluation_order
        {
            string property_name = property_names_for_areas[l];
            if (get_property(property_name) != "open" && !(get_property(property_name).is_integer() && l.turns_spent > 0))
                continue;
                
            if (mothership_progress < minimum_mothership_progress_for_area[l])
                continue;
            if (entry.image_lookup_name == "bugbear" && image_name_for_location[l] != "")
                entry.image_lookup_name = image_name_for_location[l];
                
            string [int] modifiers;
            string [int] description;
            if (l == $location[medbay])
            {
                modifiers.listAppend("olfact anesthesiologist bugbear");
                description.listAppend("Fight anesthesiologist bugbears to summon and defeat the robo-surgeon.");
                description.listAppend("Banishes won't help...?");
            }
            else if (l == $location[sonar])
            {
                modifiers.listAppend("-combat");
                description.listAppend("Run -combat, look for the machine.");
                description.listAppend("Set Pinging machine to 2.");
                description.listAppend("Set Whurming machine to 4.");
                description.listAppend("Set Boomchucking machine to 8.");
            }
            else if (l == $location[waste processing])
            {
                if ($item[bugbear communicator badge].available_amount() > 0)
                {
                    if ($item[bugbear communicator badge].equipped_amount() == 0)
                    {
                        description.listAppend("Equip the bugbear communicator badge.");
                    }
                    else
                    {
                        description.listAppend("Adventure once to finish the area.");
                    }
                }
                else
                {
                    modifiers.listAppend("olfact creepy eye-stalk tentacle monster");
                    modifiers.listAppend("+item");
                    description.listAppend("Acquire and use handfuls of juicy garbage.");
                    if ($item[handful of juicy garbage].available_amount() > 0)
                    {
                        task_entries.listAppend(ChecklistEntryMake(189, "__item handful of juicy garbage", "inventory.php?which=3", ChecklistSubentryMake("Use handful of juicy garbage", "", "Might find a bugbear communicator badge."), -11));
                    }
                }
            }
            else if (l == $location[science lab])
            {
                //FIXME want tracking for scientists trapped
                modifiers.listAppend("+item");
                description.listAppend("Collect quantum nanopolymer spider webs from spiderbugbears, use them on the poor innocent scientists.");
                if ($item[quantum nanopolymer spider web].available_amount() > 0)
                    description.listAppend(pluraliseWordy($item[quantum nanopolymer spider web]).capitaliseFirstLetter() + " available.");
            }
            else if (l == $location[morgue])
            {
                //FIXME want tracking of parts
                if ($item[bugbear autopsy tweezers].available_amount() > 0)
                    modifiers.listAppend("-combat");
                if ($item[bugbear autopsy tweezers].available_amount() < 5)
                {
                    if (!$monster[bugaboo].is_banished())
                        modifiers.listAppend("banish bugaboos OR olfact bugbear morticians");
                    description.listAppend("Collect bugbear autopsy tweezers from bugbear morticians.");
                }
                
                if ($item[bugbear autopsy tweezers].available_amount() > 0)
                    description.listAppend("Run -combat to use the tweezers on the choice adventure.");
            }
            else if (l == $location[special ops])
            {
                boolean [item] relevant_equipment = $items[fire,uv monocular,rain-doh green lantern,fluorescent lightbulb];
                item [int] items_to_equip;
                foreach it in relevant_equipment
                {
                    if (it.available_amount() > 0 && it.equipped_amount() == 0)
                        items_to_equip.listAppend(it);
                }
                if (items_to_equip.count() > 0)
                    description.listAppend(HTMLGenerateSpanFont("Equip your " + items_to_equip.listJoinComponents(", ", "and") + ".", "red"));
                if ($item[uv monocular].available_amount() == 0 && $item[uv monocular].creatable_amount() > 0)
                    description.listAppend("Could create the UV Monocular with your BURTs.");
                
                description.listAppend("Search in darkness.");
                
                if ($item[flaregun].available_amount() > 0)
                    description.listAppend("Shoot a flare in the choice adventure if you haven't.");
            }
            else if (l == $location[Engineering])
            {
                //FIXME want tracking on liquid metal bugbears
                modifiers.listAppend("+item");
                if (!$monster[Battlesuit Bugbear Type].is_banished())
                {
                    modifiers.listAppend("banish " + $monster[Battlesuit Bugbear Type]);
                }
                description.listAppend("Collect drone self-destruct chips from drones, use them on liquid metal bugbears.");
                if ($item[drone self-destruct chip].available_amount() > 0)
                    description.listAppend(pluraliseWordy($item[drone self-destruct chip]).capitaliseFirstLetter() + " available.");
            }
            else if (l == $location[Navigation])
            {
                if ($effect[N-Spatial vision].have_effect() > 0)
                {
                    string method_to_remove = "";
                    //FIXME write this
                    if ($skill[disco nap].skill_is_usable() && $skill[adventurer of leisure].skill_is_usable())
                        method_to_remove = "disco nap.";
                    else if ($item[bugbear purification pill].available_amount() > 0)
                        method_to_remove = "bugbear purification pill.";
                    else if ($item[bugbear purification pill].creatable_amount() > 0)
                        method_to_remove = "bugbear purification pill. (make from BURTs)";
                    else if ($item[soft green echo eyedrop antidote].available_amount() > 0)
                        method_to_remove = "soft green echo eyedrop antidote. (probably not worth it)";
                    
                    if (method_to_remove != "")
                        description.listAppend("Remove N-Spatial vision with " + method_to_remove);
                    else
                        description.listAppend("Avoid adventuring here until N-Spatial vision is gone.");
                }
                else
                {
                    if (!$monster[ancient unspeakable bugbear].is_banished())
                    {
                        modifiers.listAppend("banish ancient unspeakable bugbears OR olfact n-space virtual assistants"); //zero space. Zee-roh spaa ce. Spac-uh.
                    }
                    description.listAppend("Defeat ~ten total N-space assistants.");
                }
            }
            else if (l == $location[Galley])
            {
                //FIXME tracking ML defeated, cavebugbear attack
                modifiers.listAppend("+ML");
                if (!$monster[trendy bugbear chef].is_banished())
                {
                    modifiers.listAppend("banish trendy bugbear chefs OR olfact angry cavebugbears");
                }
                description.listAppend("Defeat 5k ML worth of angry cavebugbears.");
                if ($item[pacification grenade].creatable_amount() + $item[pacification grenade].available_amount() > 0)
                    description.listAppend("Can " + ($item[pacification grenade].available_amount() == 0 ? "make and " : "") + "throw a pacification grenade if they become too difficult.");
            }
            
            entry.subentries.listAppend(ChecklistSubentryMake("Clear " + printable_names_for_areas[l], modifiers, description));
            if ($locations[Medbay,Waste Processing,Sonar,Science Lab,Morgue,Special Ops,Engineering,Navigation,Galley] contains __last_adventure_location)
                entry.should_highlight = true;
        }
        if (entry.subentries.count() > 0)
            task_entries.listAppend(entry);
    }
    
    if (mothership_progress >= 3)
    {
        //
        boolean other_quests_completed = true;
        for i from 2 to 12
        {
            if (!__quest_state["Level " + i].finished)
                other_quests_completed = false;
        }
        if (other_quests_completed && my_level() >= 13)
        {
            if ($item[jeff goldblum larva].available_amount() == 0)
            {
                //hacky:
                task_entries.listAppend(ChecklistEntryMake(190, "council", "place.php?whichplace=town", ChecklistSubentryMake("Visit the Council of Loathing", "", "Obtain Jeff Goldblum larva.")));
            }
            else
            {
                //no tracking for bridge captain defeated?
                task_entries.listAppend(ChecklistEntryMake(191, "bugbear", "place.php?whichplace=bugbearship", ChecklistSubentryMake("Fight the Bugbear Captain", "", listMake("On the bridge.", "Then free the king. Maybe."))));
            }
        }
    }
}

RegisterResourceGenerationFunction("PathBugbearInvasionGenerateResource");
void PathBugbearInvasionGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_BUGBEAR_INVASION)
		return;
    if (!__misc_state["in run"])
        return;
    if ($item[crayon shavings].available_amount() > 0)
    {
		resource_entries.listAppend(ChecklistEntryMake(192, "__item crayon shavings", "", ChecklistSubentryMake(pluralise($item[crayon shavings].available_amount(), "crayon shaving copy", "crayon shaving copies") + " available", "", "Bugbears only.")));
    }
    if ($item[BURT].available_amount() > 0)
    {
        string [int] description;
        
        string [item] item_reason;
        item_reason[$item[pacification grenade]] = "trades speed for survivability in the galley";
        item_reason[$item[key-o-tron]] = "collects biodata";
        item_reason[$item[bugbear detector]] = "find the elusive creature";
        item_reason[$item[uv monocular]] = "useful in special ops";
        item_reason[$item[bugbear purification pill]] = "removes a negative effect";
        if (get_property("statusNavigation") != "cleared" && !($skill[disco nap].skill_is_usable() && $skill[adventurer of leisure].skill_is_usable()))
            item_reason[$item[bugbear purification pill]] += " (useful in Navigation)";
        item [int] relevant_items;
        relevant_items.listAppend($item[bugbear purification pill]);
        if (get_property("statusGalley") != "cleared")
            relevant_items.listAppend($item[pacification grenade]);
        relevant_items.listAppend($item[key-o-tron]);
        relevant_items.listAppend($item[bugbear detector]);
        if (get_property("statusSpecialOps") != "cleared")
            relevant_items.listAppend($item[uv monocular]);
        
        int [item] amount_wanted;
        amount_wanted[$item[pacification grenade]] = -1;
        
        foreach key, it in relevant_items
        {
            if (it.available_amount() > 0 && amount_wanted[it] != -1)
                continue;
            string line = it + " - ";
            line += item_reason[it] + ".";
            
            if (it.creatable_amount() == 0)
                line = HTMLGenerateSpanFont(line, "grey");
            description.listAppend(line);
        }
		resource_entries.listAppend(ChecklistEntryMake(193, "__item BURT", "inv_use.php?pwd=" + my_hash() + "&whichitem=5683", ChecklistSubentryMake(pluralise($item[BURT]) + " available", "", description), 8));
    }
}
RegisterTaskGenerationFunction("PathCommunityServiceGenerateTasks");
void PathCommunityServiceGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_path_id() != PATH_COMMUNITY_SERVICE)
        return;
    if (!__misc_state["in run"])
        return;
    boolean [item] blocklist;
    
    /*string [int] service_display_order = {0:"Coil Wire",
    1:"",
    2:"",
    3:"",
    4:"",
    5:"",
    6:"",
    7:"",
    8:"",
    9:"",
    10:""
    };*/
    boolean [string] services_performed = listInvert(get_property("csServicesPerformed").split_string_alternate(","));
    string [int] choice_id_order = {
        "Coil Wire", //flat
        "Donate Blood",
        "Feed The Children (But Not Too Much)",
        "Build Playground Mazes",
        "Feed Conspirators",
        "Breed More Collies",
        "Reduce Gazelle Population",
        "Make Sausage",
        "Be a Living Statue",
        "Make Margaritas",
        "Clean Steam Tunnels"
    };
    //the spreadsheet we were using does +item before the stat tests, but I'm moving it after them, because cold-filtered water is ten turns, and the +item test doesn't give anything that helps with stats
    //and technically, muscle gives bag of grain
    string [int] service_display_order = {
    	"Coil Wire", //flat
        "Feed The Children (But Not Too Much)", //muscle
        "Feed Conspirators", //moxie
        "Donate Blood", //hp
        "Build Playground Mazes", //myst
        "Make Margaritas", //item/booze
        "Reduce Gazelle Population", //melee
        "Make Sausage", //spell
        "Clean Steam Tunnels", //hot res
        "Breed More Collies", //familiar weight
        "Be a Living Statue", //-combat
    };
    /*string [string] service_names_to_property = {"Donate Blood":"REPLACEME"
    	"Feed The Children (But Not Too Much)":"Muscle",
        "Build Playground Mazes":"Mysticality",
        "Feed Conspirators":"Moxie",
        "Breed More Collies":"Familiar Weight",
        "Reduce Gazelle Population":"REPLACEME",
        "Make Sausage":"REPLACEME",
        "Be a Living Statue":"REPLACEME",
        "Make Margaritas":"REPLACEME",
        "Clean Steam Tunnels":"Hot Resistance",
    };*/
    //None, HP, muscle, mysticality, moxie, familiar weight, melee damage, spell damage, noncombat, booze drop, hot res
    //list in ideal order to finish the path as you are(?)
    int REPLACEME = 10000;
    foreach key, service_name in service_display_order
    {
    	string [int] modifiers;
        string [int] description;
        int turns = PathCommunityServiceEstimateTurnsTakenForTask(service_name);
        string service_lookup_name = service_name;
        if (service_lookup_name == "Feed The Children (But Not Too Much)")
        	service_lookup_name = "Feed The Children";
        if (services_performed[service_lookup_name]) continue;
        
        boolean [string] numeric_modifiers;
        string short_test_description;
        boolean prefer_negative = false;
        string image_name = "";
        if (service_name == "Donate Blood")
        {
        	image_name = "__item blood-drive sticker";
        	modifiers.listAppend("HP");
            modifiers.listAppend("muscle");
            short_test_description = "HP";
        	numeric_modifiers = $strings[Buffed HP Maximum,Maximum HP,Muscle,Muscle Percent];
        }
        else if (service_name == "Coil Wire")
        {
            image_name = "__item a ten-percent bonus";
        }
        else if (service_name == "Make Margaritas")
        {
            image_name = "__item emergency margarita";
            modifiers.listAppend("item");
            modifiers.listAppend("booze drop");
            short_test_description = "item drop, booze drop";
            numeric_modifiers = $strings[Item Drop,Booze Drop];
        }
        else if (service_name == "Feed The Children (But Not Too Much)" || service_name == "Build Playground Mazes" || service_name == "Feed Conspirators")
        {
        	stat using_stat;
            if (service_name == "Feed The Children (But Not Too Much)")
            {
            	using_stat = $stat[muscle];
                image_name = "__item bag of grain";
            }
            else if (service_name == "Build Playground Mazes")
            {
                using_stat = $stat[mysticality];
                image_name = "__item pocket maze";
            }
            else if (service_name == "Feed Conspirators")
            {
                using_stat = $stat[moxie];
                image_name = "__item shady shades";
            }
            modifiers.listAppend("+" + using_stat);
            short_test_description = using_stat;
            numeric_modifiers[using_stat.to_string()] = true;
            numeric_modifiers[using_stat + " Percent"] = true;
            int basestat = my_basestat(using_stat);
            boolean relevant_thrall_active = false;
            if (my_thrall() == $thrall[Elbow Macaroni] && using_stat == $stat[muscle])
            {
            	basestat = my_basestat($stat[mysticality]);
                relevant_thrall_active = true;
            }
            if (my_thrall() == $thrall[Penne Dreadful] && using_stat == $stat[moxie])
            {
                basestat = my_basestat($stat[mysticality]);
                relevant_thrall_active = true;
            }
            
            turns = 60 - (my_buffedstat(using_stat) - basestat) / 30;
            if (turns > 1)
            {
                //turns saved = (buffed - base) / 30
                //60 = (buffed - base) / 30
                //1800 = buffed - base
                //buffed = 1800 + base
                int needed_buffed_stat = 1800 + basestat;
                float percentage = to_float(needed_buffed_stat - my_buffedstat(using_stat)) / to_float(basestat) * 100.0;
                description.listAppend("Need to buff " + using_stat + " to " + needed_buffed_stat + " (+" + (needed_buffed_stat - my_buffedstat(using_stat)) + " / +" + percentage.round() + "% from here)");
                if (relevant_thrall_active)
                {
                }
                else if (using_stat != $stat[mysticality] && my_primestat() == $stat[mysticality] && $item[oil of expertise].to_effect().have_effect() == 0)
                {
                	description.listAppend("Possibly use oil of expertise to equalise basestats." + ($items[cherry,oil of expertise].available_amount() == 0 ? "|Can get a cherry from novelty tropical skeleton in the skeleton store. Run +234% item." : ""));
                    if (my_class() == $class[pastamancer]) description.listAppend("Or use pastamancer thralls.");
                }
            }
        }
        else if (service_name == "Reduce Gazelle Population")
        {
            image_name = "__item weird gazelle steak";
            modifiers.listAppend("+weapon damage, +weapon damage percent");
            short_test_description = "melee damage, melee damage percent";
            numeric_modifiers = $strings[Weapon Damage,Weapon Damage Percent];
            if ($skill[Bow-Legged Swagger].have_skill() && $effect[Bow-Legged Swagger].have_effect() == 0 && !get_property_boolean("_bowleggedSwaggerUsed"))
            {
            	description.listAppend("Cast Bow-Legged Swagger for twice effectiveness.");
            }
        }
        else if (service_name == "Make Sausage")
        {
            image_name = "__item sausage without a cause";
            modifiers.listAppend("+spell damage, +spell damage percent");
            short_test_description = "spell damage";
            numeric_modifiers = $strings[Spell Damage,Spell Damage Percent];
        }
        else if (service_name == "Clean Steam Tunnels")
        {
            image_name = "__item vintage smart drink";
        	//FIXME red
            modifiers.listAppend("+hot resistance");
            short_test_description = "hot resistance";
            numeric_modifiers = $strings[Hot Resistance];
        }
        else if (service_name == "Breed More Collies")
        {
            image_name = "__item squeaky toy rose";
            modifiers.listAppend("+familiar weight");
            short_test_description = "familiar weight";
            numeric_modifiers = $strings[Familiar Weight];
        }
        else if (service_name == "Be a Living Statue")
        {
            image_name = "__item silver face paint";
            modifiers.listAppend("-combat");
            short_test_description = "-combat";
            numeric_modifiers = $strings[Combat Rate];
            prefer_negative = true;
        }
        
        turns = clampi(turns, 1, 60);
        if (short_test_description != "")
	        description.listAppend("Buff " + short_test_description + ".");
        
        
        
        
        description.listAppend(pluralise(turns, "turn", "turns") + ".");
        task_entries.listAppend(ChecklistEntryMake(173, image_name, "council.php", ChecklistSubentryMake(service_name, modifiers, description)));
    }
    //equaliser potions
    /*if (true)
    {
        item [int] hp_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Buffed HP Maximum", 150.0, blocklist); //what a strange lookup name
        item [int] hp_potions_2 = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Maximum HP", 150.0, blocklist); //something else?
        
        item [int] muscle_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Muscle", 0.0, blocklist);
        item [int] muscle_percent_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier("Muscle Percent", 0.0, blocklist);
        
        
        string [int] relevant_potions_output;
        foreach key, it in hp_potions
        {
            relevant_potions_output.listAppend(it + " (+" + it.to_effect().numeric_modifier("Buffed HP Maximum").roundForOutput(0) + ")");
        }
        
        task_entries.listAppend(ChecklistEntryMake(174, "__item helmet turtle", "council.php", ChecklistSubentryMake("Perform HP service", "+hp", relevant_potions_output.listJoinComponents(", ", "and"))));
    }
    
    
    foreach s in $strings[Buffed HP Maximum,Muscle,Muscle Percent,Moxie,Moxie Percent,Mysticality,Mysticality Percent,Weapon Damage,Weapon Damage Percent,spell damage, spell damage percent,Combat Rate,hot resistance]
    {
        item [int] relevant_potions = ItemFilterGetPotionsCouldPullToAddToNumericModifier(s, -100000.0, blocklist); //what a strange lookup name
        string [int] relevant_potions_output;
        foreach key, it in relevant_potions
        {
            relevant_potions_output.listAppend(it + " (+" + it.to_effect().numeric_modifier(s).roundForOutput(0) + ")");
        }
        task_entries.listAppend(ChecklistEntryMake(175, "__item helmet turtle", "council.php", ChecklistSubentryMake("Perform " + s + " service", "", relevant_potions_output.listJoinComponents(", ", "and"))));
    }*/
}

RegisterTaskGenerationFunction("PathHeavyRainsGenerateTasks");
void PathHeavyRainsGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_HEAVY_RAINS)
		return;
    
    item thunder_item = $item[thunder thigh];
    item rain_item = $item[aquaconda brain];
    item lightning_item = $item[lightning milk];
    
    boolean [item] all_skill_items;
    all_skill_items[thunder_item] = true;
    all_skill_items[rain_item] = true;
    all_skill_items[lightning_item] = true;
    
    if (thunder_item.available_amount() + rain_item.available_amount() + lightning_item.available_amount() > 0)
    {
        //Let's learn skills:
        skill [item][int] skills_for_item;
        
        skills_for_item[thunder_item] = listMakeBlankSkill();
        skills_for_item[rain_item] = listMakeBlankSkill();
        skills_for_item[lightning_item] = listMakeBlankSkill();
        
        skills_for_item[thunder_item].listAppend($skill[Thunder Clap]);
        skills_for_item[thunder_item].listAppend($skill[Thundercloud]);
        skills_for_item[thunder_item].listAppend($skill[Thunder Bird]);
        skills_for_item[thunder_item].listAppend($skill[Thunderheart]);
        skills_for_item[thunder_item].listAppend($skill[Thunderstrike]);
        skills_for_item[thunder_item].listAppend($skill[Thunder Down Underwear]);
        skills_for_item[thunder_item].listAppend($skill[Thunder Thighs]);
        
        skills_for_item[rain_item].listAppend($skill[Rain Man]);
        skills_for_item[rain_item].listAppend($skill[Rainy Day]);
        skills_for_item[rain_item].listAppend($skill[Make it Rain]);
        skills_for_item[rain_item].listAppend($skill[Rain Dance]);
        skills_for_item[rain_item].listAppend($skill[Rainbow]);
        skills_for_item[rain_item].listAppend($skill[Rain Coat]);
        skills_for_item[rain_item].listAppend($skill[Rain Delay]);
        
        skills_for_item[lightning_item].listAppend($skill[Lightning Strike]);
        skills_for_item[lightning_item].listAppend($skill[Clean-Hair Lightning]);
        skills_for_item[lightning_item].listAppend($skill[Ball Lightning]);
        skills_for_item[lightning_item].listAppend($skill[Sheet Lightning]);
        skills_for_item[lightning_item].listAppend($skill[[16025]Lightning Bolt]);
        skills_for_item[lightning_item].listAppend($skill[Lightning Rod]);
        skills_for_item[lightning_item].listAppend($skill[Riding the Lightning]);
        
        string [skill] description_for_skill;
        
        description_for_skill[$skill[Thunder Clap]] = "Turn-costing banish. (lasts 40 turns, no stats, no items, no meat)";
        description_for_skill[$skill[Thundercloud]] = "Water depth increasing effect";
        description_for_skill[$skill[Thunderheart]] = "+100% HP, surviving";
        description_for_skill[$skill[Thunderstrike]] = "Monster stunning";
        description_for_skill[$skill[Thunder Thighs]] = "Thunder regen, passive";
        description_for_skill[$skill[Thunder Bird]] = "Monster deleveling";
        if (in_hardcore())
            description_for_skill[$skill[Thunder Down Underwear]] = "safety pants (if you want to)";
        
        
        description_for_skill[$skill[Rain Man]] = "Fax any monster repeatedly";
        description_for_skill[$skill[Rainy Day]] = "Water depth increasing effect";
        if (!__quest_state["Level 12"].state_boolean["Nuns Finished"])
            description_for_skill[$skill[Make it Rain]] = "+300% meat for a single turn (nuns)";
        description_for_skill[$skill[Rain Dance]] = "+20% item effect";
        description_for_skill[$skill[Rain Delay]] = "passive, +3 resist all";
        
        description_for_skill[$skill[Lightning Strike]] = "Kills monster, gain stats/drops, makes adventure not use a turn (effective free run/hipster)";
        description_for_skill[$skill[Ball Lightning]] = "Yellow ray (100 turn cooldown)";
        description_for_skill[$skill[Riding the Lightning]] = "passive, +100% max MP";
        
        
        description_for_skill[$skill[Sheet Lightning]] = "+100% spell damage effect";
        //description_for_skill[$skill[Thunder Down Underwear]] = "Summon once/day pants: +100 DA/HP, HP regen";
        //description_for_skill[$skill[Rain Coat]] = "Summons once/day shirt: +40% init, +10% item, +2 resist all";
        //description_for_skill[$skill[Lightning Rod]] = "Summons once/day weapon: +200% spell damage";
        
        
        int [item] available_skills_for_item;
        int [item] max_available_skills_for_item;
        
        foreach it in skills_for_item
        {
            foreach key in skills_for_item[it]
            {
                skill s = skills_for_item[it][key];
                if (s.skill_is_usable())
                    continue;
                max_available_skills_for_item[it] += 1;
                available_skills_for_item[it] = MIN(max_available_skills_for_item[it], it.available_amount());
            }
        }
        
        //available_skills_for_item[thunder_item] = 7;
        //available_skills_for_item[rain_item] = 7;
        //available_skills_for_item[lightning_item] = 7;
        
        
        string [int] description;
        
        string [int] available_skill_types;
        
        string [int] items_to_use_description;
        
        string [item] item_to_typename;
        item_to_typename[thunder_item] = "thunder";
        item_to_typename[rain_item] = "rain";
        item_to_typename[lightning_item] = "lightning";
        
        string url = "";
        string [item] item_to_url;
        
        item_to_url[thunder_item] = "inv_use.php?which=3&whichitem=7648&pwd=" + my_hash();
        item_to_url[rain_item] = "inv_use.php?which=3&whichitem=7647&pwd=" + my_hash();
        foreach it in all_skill_items
        {
            if (available_skills_for_item[it] > 0)
            {
                available_skill_types.listAppend(item_to_typename[it]);
                items_to_use_description.listAppend(pluralise(available_skills_for_item[it], it));
                
                if (url.length() == 0)
                    url = item_to_url[it];
            }
        }
        
        url = "inventory.php?which=3"; //mafia won't remove the skill glands quite properly (needs to happen when you click the NC option, not at inv_use.php)
        
        description.listAppend("Use " + items_to_use_description.listJoinComponents(", ", "and") + ".");
        
        
        foreach it in all_skill_items
        {
            if (available_skills_for_item[it] == 0)
                continue;
            
            int other_count = 0;
            string [int] relevant_descriptions;
            foreach key in skills_for_item[it]
            {
                skill s = skills_for_item[it][key];
                if (s.skill_is_usable())
                    continue;
                if (!(description_for_skill contains s))
                {
                    other_count += 1;
                    continue;
                }
                relevant_descriptions.listAppend(s + ": " + description_for_skill[s]);
            }
            if (other_count > 0)
            {
                if (relevant_descriptions.count() > 0)
                    relevant_descriptions.listAppend("Or " + pluraliseWordy(other_count, "other skill", "other skills") + ".");
                else
                    relevant_descriptions.listAppend(pluraliseWordy(other_count, "possible skill", "possible skills").capitaliseFirstLetter() + ".");
            }
            
            description.listAppend(HTMLGenerateSpanOfClass(item_to_typename[it].capitaliseFirstLetter() + ":", "r_bold") + HTMLGenerateIndentedText(relevant_descriptions.listJoinComponents("<hr>")));
        }
        
        if (available_skill_types.count() > 0)
            task_entries.listAppend(ChecklistEntryMake(144, "__familiar personal raincloud", url, ChecklistSubentryMake("Learn " + available_skill_types.listJoinComponents(", ", "and") + " skills", "", description), -10));
    }
}

RegisterResourceGenerationFunction("PathHeavyRainsGenerateResource");
void PathHeavyRainsGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_HEAVY_RAINS)
		return;
    
    //resource_entries.listAppend(ChecklistEntryMake(145, "__item gym membership card", "inventory.php?which=3", ChecklistSubentryMake(pluralise($item[gym membership card]), "", description), importance_level_item));
    
    
    int fishbone_amount = $item[freshwater fishbone].available_amount();
    
    if (fishbone_amount >= 5) //only show if there's something to buy
    {
        int [item] fishbone_item_costs;
        string [item] fishbone_item_descriptions;
        
        //Are these worth suggesting?
        //fishbone_item_descriptions[$item[fishbone facemask]] = "-30 ML";
        //fishbone_item_costs[$item[fishbone facemask]] = 5;
        //fishbone_item_descriptions[$item[fishbone fins]] = "survivability";
        //fishbone_item_costs[$item[fishbone fins]] = 20;
        
        fishbone_item_descriptions[$item[fishbone bracers]] = "+100% spell damage";
        fishbone_item_costs[$item[fishbone bracers]] = 5;
        
        
        fishbone_item_descriptions[$item[fishbone corset]] = "-water depth";
        fishbone_item_costs[$item[fishbone corset]] = 10;
        
        
        fishbone_item_descriptions[$item[fishbone kneepads]] = "+60% init";
        fishbone_item_costs[$item[fishbone kneepads]] = 15;
        
        fishbone_item_descriptions[$item[fishbone catcher's mitt]] = "-washaway";
        fishbone_item_costs[$item[fishbone catcher's mitt]] = 30;
        
        string [int] description;
        foreach it in fishbone_item_costs
        {
            if (it == $item[none])
                continue;
            int cost = fishbone_item_costs[it];
            
            
            int amount_needed = 1;
            if (it.to_slot() == $slot[acc1] || it.to_slot() == $slot[acc2] || it.to_slot() == $slot[acc3])
                amount_needed = 3;
                
            int creatable = 0;
            if (fishbone_item_costs[it] != 0)
                creatable = MIN(amount_needed, fishbone_amount / fishbone_item_costs[it]);
            
            if (it.available_amount() >= amount_needed || creatable == 0)
                continue;
            int amount_to_make = MIN(creatable, amount_needed - it.available_amount());
            
            description.listAppend(pluralise(amount_to_make, it) + ": " + fishbone_item_descriptions[it]);
        }
        resource_entries.listAppend(ChecklistEntryMake(146, "__item freshwater fishbone", "shop.php?whichshop=fishbones", ChecklistSubentryMake(pluralise($item[freshwater fishbone]), "", description), 7));
    }
    
    if ($item[catfish whiskers].available_amount() > 0)
    {
        //should we add in area suggestions?
        resource_entries.listAppend(ChecklistEntryMake(147, "__item catfish whiskers", "inventory.php?which=3", ChecklistSubentryMake(pluralise($item[catfish whiskers]), "", "40 turns of -washaway"), 7));
    }
}

RegisterTaskGenerationFunction("PathKOLHSGenerateTasks");
void PathKOLHSGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_KOLHS)
		return;
    
    item [string][int] items_wanted_in_classes;
    effect [string] relevant_intrinsic;
    items_wanted_in_classes["Art Class"] = listMakeBlankItem();
    relevant_intrinsic["Art Class"] = $effect[greaser lightnin'];
    items_wanted_in_classes["Art Class"].listAppend($item[quasireligious sculpture]);
    items_wanted_in_classes["Art Class"].listAppend($item[Sticky clay homunculus]);
    items_wanted_in_classes["Art Class"].listAppend($item[Modeling claymore]);
    items_wanted_in_classes["Art Class"].listAppend($item[Giant eraser]);
    
    items_wanted_in_classes["Shop Class"] = listMakeBlankItem();
    relevant_intrinsic["Shop Class"] = $effect[Jamming with the Jocks];
    items_wanted_in_classes["Shop Class"].listAppend($item[miniature suspension bridge]);
    items_wanted_in_classes["Shop Class"].listAppend($item[world's most dangerous birdhouse]);
    items_wanted_in_classes["Shop Class"].listAppend($item[deathchucks]);
    if ($skill[Spirit of Rigatoni].have_skill() && my_primestat() == $stat[mysticality])
        items_wanted_in_classes["Shop Class"].listAppend($item[Staff of the Lunch Lady]);
    
    items_wanted_in_classes["Chemistry Class"] = listMakeBlankItem();
    items_wanted_in_classes["Chemistry Class"].listAppend($item[grains of salt]);
    items_wanted_in_classes["Chemistry Class"].listAppend($item[Dirty stinkbomb]);
    items_wanted_in_classes["Chemistry Class"].listAppend($item[Sodium pentasomething]);
    items_wanted_in_classes["Chemistry Class"].listAppend($item[superwater]);
    items_wanted_in_classes["Chemistry Class"].listAppend($item[Yellowcake bomb]);
    
    string [item] class_item_description;
    class_item_description[$item[giant eraser]] = "free runaway";
    class_item_description[$item[grains of salt]] = "+3 adventures from a food";
    class_item_description[$item[Dirty stinkbomb]] = "banisher";
    class_item_description[$item[Sodium pentasomething]] = "+20 ML for 20 turns potion";
    class_item_description[$item[superwater]] = "50 turns of ultrahydrated";
    class_item_description[$item[Yellowcake bomb]] = "75-turn yellow-ray";
    class_item_description[$item[quasireligious sculpture]] = "-4.5 evil in cyrpt";
    class_item_description[$item[Sticky clay homunculus]] = "monster copier without daily limit";
    class_item_description[$item[Modeling claymore]] = "clears battlefield a bit";
    class_item_description[$item[miniature suspension bridge]] = "10 planks for the chasm bridge";
    class_item_description[$item[world's most dangerous birdhouse]] = "instakill";
    class_item_description[$item[deathchucks]] = "free banisher";
    class_item_description[$item[Staff of the Lunch Lady]] = "chefstaff";
        
    ChecklistSubentry subentry;
    subentry.header = "Kingdom of Loathing High School";
    
    int adventures_used = get_property_int("_kolhsAdventures");
    int adventures_remaining = 40 - adventures_used;
    int bell_ring_ring_ring = get_property_int("_kolhsSavedByTheBell");
    int ring_ring_ring_ring_left = 3 - bell_ring_ring_ring;
    int priority = 0;
    if (adventures_remaining > 0)
    {
        priority = -11;
        if ($effect[jamming with the jocks].have_effect() == 0 && $effect[greaser lightnin'].have_effect() == 0 && $effect[Nerd is the Word].have_effect() == 0)
            subentry.entries.listAppend("Acquire intrinsic in halls - use a moxie, muscle, or mysticality combat skill.");
        if ($effect[jamming with the jocks].have_effect() > 0)
            subentry.entries.listAppend("Adventure in shop class.");
        if ($effect[greaser lightnin'].have_effect() > 0)
            subentry.entries.listAppend("Adventure in art class.");
        if ($effect[Nerd is the Word].have_effect() > 0)
            subentry.entries.listAppend("Adventure in chemistry class.");
        subentry.entries.listAppend(pluralise(adventures_remaining, "adventure", "adventures") + " left in school.");
    }
    else if (ring_ring_ring_ring_left > 0)
    {
        subentry.entries.listAppend(pluralise(ring_ring_ring_ring_left, "bell ring", "bell rings") + " left.");
        if ($item[Yearbook Club Camera].available_amount() == 0)
            subentry.entries.listAppend("Could acquire a yearbook camera. (Yearbook Club)");
        else if (get_property_boolean("yearbookCameraPending") && my_daycount() > 1)
            subentry.entries.listAppend("Could turn yesterday's photograph... if you took it yesterday...");
        
        subentry.entries.listAppend("Choir club for a +100% meat, +50% item buff.|It's important to sing every day!");
        
        if (__misc_state["need to level"])
        {
            if (my_primestat() == $stat[muscle])
            {
                subentry.entries.listAppend("Gym - 50 turns of +2 mainstat/fight.");
            }
            else if (my_primestat() == $stat[mysticality])
            {
                subentry.entries.listAppend("Undead Poets Society - 50 turns of +2 mainstat/fight.");
            }
            else if (my_primestat() == $stat[moxie])
            {
                subentry.entries.listAppend("Bleachers - 50 turns of +2 mainstat/fight.");
            }
        }
        
        string class_can_make_things_in;
        boolean [item] potential_items_creatable;
        string [item] creatable_item_descriptions;
        if ($effect[jamming with the jocks].have_effect() > 0)
        {
            class_can_make_things_in = "Shop Class";
        }
        if ($effect[greaser lightnin'].have_effect() > 0)
        {
            class_can_make_things_in = "Art Class";
        }
        if ($effect[Nerd is the Word].have_effect() > 0)
        {
            class_can_make_things_in = "Chemistry Class";
        }
        if (class_can_make_things_in != "")
        {
            string [int] sorts_of_things;
            foreach key, it in items_wanted_in_classes[class_can_make_things_in]
            {
                if (it.creatable_amount() > 0)
                {
                    string line = pluralise(it.creatable_amount(), it);
                    if (class_item_description contains it)
                        line += " - " + class_item_description[it] + ".";
                    sorts_of_things.listAppend(line);
                }
            }
            string line = class_can_make_things_in + " - make all sorts of things";
            if (sorts_of_things.count() > 0)
                line += ":|*" + sorts_of_things.listJoinComponents("|*");
            else
                line += ".";
            subentry.entries.listAppend(line);
        }
    }
    
    if (adventures_remaining <= 0)
    {
        if ($item[Yearbook Club Camera].available_amount() > 0 && !get_property_boolean("yearbookCameraPending") && get_property("yearbookCameraTarget") != "" && get_property_int("yearbookCameraUpgrades") < 21)
        {
            string line = "Could take a picture of a " + get_property("yearbookCameraTarget") + "."; //"mine worker" is a seen value
            if ($item[Yearbook Club Camera].equipped_amount() == 0)
                line += "|Equip the yearbook club camera first.";
            subentry.entries.listAppend(line);
        }
    }
    
    if (subentry.entries.count() > 0)
        task_entries.listAppend(ChecklistEntryMake(142, "high school", "place.php?whichplace=KOLHS", listMake(subentry), priority, $locations[the hallowed halls, shop class, chemistry class, art class]));
    
    
    foreach it in $items[can of the cheapest beer,bottle of fruity &quot;wine&quot;,single swig of vodka]
    {
        if (it.available_amount() > 0 && my_inebriety() < 8) //is this eight or nine or
        {
            int importance = -11;
            string [int] description;
            description.listAppend("Next one won't show up until you do.");
            if (get_campground()[$item[portable mayo clinic]] > 0)
            {
                importance = -10;
                description.listAppend("Or drink via the mayo clinic.");
            }
            task_entries.listAppend(ChecklistEntryMake(143, "__item " + it, "", ChecklistSubentryMake("Drink " + it, "", description), importance));
            break;
        }
    }
}
//Some simple suggestions for this forgotten path:
RegisterResourceGenerationFunction("PathWOTSFGenerateResource");
void PathWOTSFGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_WAY_OF_THE_SURPRISING_FIST)
		return;
	//Meat:
	if (have_outfit_components("Knob Goblin Harem Girl Disguise") && !get_property_boolean("_treasuryHaremMeatCollected") && locationAvailable($location[Cobb's Knob Barracks]))
	{
		resource_entries.listAppend(ChecklistEntryMake(194, "meat", "cobbsknob.php", ChecklistSubentryMake("Cobb's Knob treasury meat", "", "Wear harem girl disguise, adventure once for 500 meat."), 5));
	}
	//Skills:
	string [int] fist_teaching_properties = split_string_alternate("fistTeachingsBarroomBrawl,fistTeachingsBatHole,fistTeachingsConservatory,fistTeachingsFratHouse,fistTeachingsFunHouse,fistTeachingsHaikuDungeon,fistTeachingsMenagerie,fistTeachingsNinjaSnowmen,fistTeachingsPokerRoom,fistTeachingsRoad,fistTeachingsSlums", ",");
	location [string] teaching_properties_to_locations;
	teaching_properties_to_locations["fistTeachingsBarroomBrawl"] = $location[A Barroom Brawl];
	teaching_properties_to_locations["fistTeachingsBatHole"] = $location[The Bat Hole Entrance];
	teaching_properties_to_locations["fistTeachingsConservatory"] = $location[The Haunted Conservatory];
	teaching_properties_to_locations["fistTeachingsFratHouse"] = $location[Frat House];
	teaching_properties_to_locations["fistTeachingsFunHouse"] = $location[The "Fun" House];
	teaching_properties_to_locations["fistTeachingsHaikuDungeon"] = $location[The Haiku Dungeon];
	teaching_properties_to_locations["fistTeachingsMenagerie"] = $location[Cobb's Knob Menagerie\, Level 2];
	teaching_properties_to_locations["fistTeachingsNinjaSnowmen"] = $location[Lair of the Ninja Snowmen];
	teaching_properties_to_locations["fistTeachingsPokerRoom"] = $location[The Poker Room];
	teaching_properties_to_locations["fistTeachingsRoad"] = $location[The Road to the White Citadel];
	teaching_properties_to_locations["fistTeachingsSlums"] = $location[Pandamonium Slums];
	
	string [int] missing_areas;
	foreach key in fist_teaching_properties
	{
		string property = fist_teaching_properties[key];
		if (!get_property_boolean(property))
		{
			location place = teaching_properties_to_locations[property];
			missing_areas.listAppend(place.HTMLGenerateFutureTextByLocationAvailability());
		}
	}
	if (missing_areas.count() > 0)
		resource_entries.listAppend(ChecklistEntryMake(195, "__item Teachings of the Fist", "", ChecklistSubentryMake("Teachings of the Fist", "", "Found in " + missing_areas.listJoinComponents(", ", "and") + "."), 5));
		
}
RegisterTaskGenerationFunction("PathTheSourceGenerateTasks");
void PathTheSourceGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_THE_SOURCE)
		return;
    
    /*
    questM26Oracle
    sourceOracleTarget
    sourceAgentsDefeated
    sourceEnlightenment
    sourcePoints
    */
    
    int enlightenment = get_property_int("sourceEnlightenment");
    int learned_skill_count = 0;
    foreach s in $skills[Overclocked,Bullet Time,True Disbeliever,Code Block,Disarmament,Big Guns,Humiliating Hack,Source Kick,Reboot,Restore,Data Siphon]
    {
        if (s.have_skill())
            learned_skill_count += 1;
    }
    if (enlightenment > 0 && learned_skill_count < 11)
    {
        string [int] description;
        
        skill [int] desired_skill_order;
        if (get_property_int("sourcePoints") < 3) //once you have three, you can always go the hack-siphon-kick route
            desired_skill_order.listAppend($skill[Big Guns]); //tons of damage
        desired_skill_order.listAppend($skill[Humiliating Hack]); //delevel a bunch
        desired_skill_order.listAppend($skill[Data Siphon]); //restore MP from attacks
        desired_skill_order.listAppend($skill[Source Kick]); //also a lot of damage...?
        desired_skill_order.listAppend($skill[Overclocked]); //+init
        
        desired_skill_order.listAppend($skill[Restore]); //restore HP
        desired_skill_order.listAppend($skill[Bullet Time]); //dodge 3 ranged
        desired_skill_order.listAppend($skill[True Disbeliever]); //dodge 3 hack
        desired_skill_order.listAppend($skill[Code Block]); //dodge 3 melee
        
        desired_skill_order.listAppend($skill[Disarmament]); //something
        desired_skill_order.listAppend($skill[Reboot]); //removes latency
        desired_skill_order.listAppend($skill[Big Guns]); //tons of damage
        
        foreach key, s in desired_skill_order
        {
            if (!s.have_skill())
            {
                description.listAppend("Maybe " + s + " next.");
                break;
            }
        }
        
        task_entries.listAppend(ChecklistEntryMake(158, "ringing phone", "place.php?whichplace=manor1&action=manor1_sourcephone_ring", ChecklistSubentryMake("Learn source skill", "", description), -11));
    }
    
    if (enlightenment + learned_skill_count < 11)
    {
        boolean later = false;
        string title = "";
        string [int] description;
        string url = "";
        string target = get_property("sourceOracleTarget");
        location target_location = target.to_location();
        if ($item[no spoon].available_amount() > 0)
        {
            title = "Return to the Oracle";
            url = "place.php?whichplace=town_wrong&action=townwrong_oracle";
        }
        else if (target == "" || !QuestState("questM26Oracle").started)
        {
            title = "Visit the Oracle";
            url = "place.php?whichplace=town_wrong&action=townwrong_oracle";
            string line = "If you want another source skill.";
            if (learned_skill_count > 0)
                line += " (have " + learned_skill_count + " so far.)";
            description.listAppend(line);
        }
        else if (target_location != $location[none])
        {
            title = "Oracle Quest";
            url = target_location.getClickableURLForLocation();
            if (!target_location.locationAvailable())
            {
                later = true;
                title += " later";
                if (target_location == $location[the skeleton store])
                {
                    later = false;
                    title = "Start the skeleton store quest";
                    description.listAppend("Visit the meatsmith.");
                    url = "shop.php?whichshop=meatsmith&action=talk";
                }
                else if (target_location == $location[madness bakery])
                {
                    later = false;
                    title = "Start the madness bakery quest";
                    description.listAppend("Visit the Armory and Leggery.");
                    url = "shop.php?whichshop=armory&action=talk";
                }
                else if (target_location == $location[the overgrown lot])
                {
                    later = false;
                    title = "Start the Galaktik quest";
                    description.listAppend("Visit Doc Galaktik.");
                    url = "shop.php?whichshop=doc&action=talk";
                }
                description.listAppend("Unlock " + target_location + " first.");
            }
            else
            {
                description.listAppend("Adventure in " + target_location + ".");
                description.listAppend("No spoon unappears after eleven combat turns.");
            }
        }
        
        if (title != "")
        {
            ChecklistEntry entry = ChecklistEntryMake(159, "__item cookie cookie", url, ChecklistSubentryMake(title, "", description), -1);
            if (target_location != $location[none] && target_location == __last_adventure_location)
                entry.should_highlight = true;
            if (later)
                future_task_entries.listAppend(entry);
            else
                optional_task_entries.listAppend(entry);
        }
    }
    
    int source_interval = get_property_int("sourceInterval");
    if (source_interval == 200 || source_interval == 400)
    {
        string [int] description;
        CopiedMonstersGenerateDescriptionForMonster("source agent", description, true, false);
        
        task_entries.listAppend(ChecklistEntryMake(160, "__item software glitch", "", ChecklistSubentryMake("Source agent now or soon", "", description), -11));
    }
    else if (source_interval > 0)
    {
        string [int] description;
        int turns = (source_interval - 400) / 200;
        if (get_property_int("sourceAgentsDefeated") > 0)
            description.listAppend(pluralise(get_property_int("sourceAgentsDefeated"), "agent", "agents") + " defeated so far.");
        if (QuestState("questM26Oracle").in_progress)
            description.listAppend("Oracle quests won't advance the counter.");
        optional_task_entries.listAppend(ChecklistEntryMake(161, "__item software glitch", "", ChecklistSubentryMake("Source agent after ~" + pluralise(turns, "won combat", "won combats"), "", description)));
    }
}

RegisterResourceGenerationFunction("PathTheSourceGenerateResource");
void PathTheSourceGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_THE_SOURCE)
		return;
}

RegisterTaskGenerationFunction("PathZombieSlayerGenerateTasks");
void PathZombieSlayerGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_ZOMBIE_SLAYER)
		return;
    //zombiePoints is the number of points "permed" on the character, not how many they have at the moment
    //Let's see.. I think this means we can infer how many points they have to spend, right? You start with zombiePoints + 1, then gain one for each level you have, minus how many hunter brains you have, minus whether you've fought the right hunter yet... but, we can't know that information. Hmm. So, no, no reminder. Alas.
    //We could, however, suggest they eat a hunter brain.
    //ashq string out; foreach s in $skills[] if (s.class == $class[zombie master]) out += ", " + s; print(out);
    if ($item[hunter brain].available_amount() > 0 && availableFullness() >= 1)
    {
        int zombie_skills_have = 0;
        foreach s in $skills[Infectious Bite, Bite Minion, Lure Minions, Undying Greed, Hunter's Sprint, Insatiable Hunger, Devour Minions, Indefatigable, Skullcracker, Neurogourmet, Ravenous Pounce, Distracting Minion, Plague Claws, Flesh Mob, Elemental Obliviousness, Vigor Mortis, Virulence, Bilious Burst, Unyielding Flesh, Corpse Pile, Howl of the Alpha, Summon Minion, Zombie Chow, Smash & Graaagh, Scavenge, Meat Shields, Summon Horde, His Master's Voice, Ag-grave-ation, Disquiet Riot, Zombie Maestro, Recruit Zombie]
        {
            if (s.have_skill())
                zombie_skills_have += 1;
        }
        if (zombie_skills_have < 30)
        {
            //probably should suggest eat X hunter brains but
            optional_task_entries.listAppend(ChecklistEntryMake(171, "__item hunter brain", "inventory.php?which=1", ChecklistSubentryMake("Eat a hunter brain", "", "Gain a skill point."), -1));
        }
    }
    
}

RegisterResourceGenerationFunction("PathZombieSlayerGenerateResource");
void PathZombieSlayerGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_ZOMBIE_SLAYER)
		return;
    
    if ($item[right bear arm].available_amount() > 0 && $item[left bear arm].available_amount() > 0)
    {
        int bear_hugs_remaining = clampi(10 - get_property_int("_bearHugs"), 0, 10);
        
        if (bear_hugs_remaining > 0)
        {
            string url;
            string [int] description;
            description.listAppend("Converts monster to zombies. Ideally, use against group monsters.");
            string [int] items_to_equip;
            foreach it in $items[right bear arm,left bear arm]
            {
                if (it.equipped_amount() == 0)
                    items_to_equip.listAppend(it);
            }
            if (items_to_equip.count() > 0)
            {
                url = "inventory.php?which=2";
                description.listAppend("Equip " + items_to_equip.listJoinComponents(", ", "and") + ".");
            }
            resource_entries.listAppend(ChecklistEntryMake(172, "__item right bear arm", url, ChecklistSubentryMake(pluralise(bear_hugs_remaining, "bear hug", "bear hugs"), "", description), 8));
            
        }
    }
}

RegisterTaskGenerationFunction("PathNuclearAutumnGenerateTasks");
void PathNuclearAutumnGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_NUCLEAR_AUTUMN)
		return;
    string url = "place.php?whichplace=falloutshelter";
    
    ChecklistSubentry [int] subentries;
    
    if (get_property_int("falloutShelterLevel") >= 2 && (my_turncount() >= 50 || get_property_boolean("falloutShelterChronoUsed")))
    {
        if ($item[Rad-Pro (1 oz.)].to_effect().have_effect() <= 1 && my_meat() >= 500 && $item[lead umbrella].equipped_amount() == 0)
        {
            url = "shop.php?whichshop=vault1";
            if ($item[Rad-Pro (1 oz.)].available_amount() > 0)
                url = "inventory.php?which=1"; //FIXME
            subentries.listAppend(ChecklistSubentryMake("Use rad-pro", "", "Protect from radiation."));
        }
    }
    
    if (get_property_int("falloutShelterLevel") >= 8 && !get_property_boolean("falloutShelterCoolingTankUsed"))
    {
        subentries.listAppend(ChecklistSubentryMake("Use cooling tank", "", "Gain 300 rads."));
    }
    if (get_property_int("falloutShelterLevel") >= 5 && !get_property_boolean("falloutShelterChronoUsed"))
    {
        subentries.listAppend(ChecklistSubentryMake("Use chronodynamics laboratory", "", "Increase rads gained."));
    }
    if (get_property_int("falloutShelterLevel") >= 4 && $item[wrist-boy].available_amount() == 0 && my_meat() >= 5000)
    {
        subentries.listAppend(ChecklistSubentryMake("Acquire wrist-boy", "", "Unlocks buff records."));
        url = "shop.php?whichshop=vault2";
    }
    
    if (subentries.count() > 0)
        task_entries.listAppend(ChecklistEntryMake(203, "__item rad", url, subentries, 0));
}

RegisterResourceGenerationFunction("PathNuclearAutumnGenerateResource");
void PathNuclearAutumnGenerateResource(ChecklistEntry [int] resource_entries)
{
	if (my_path_id() != PATH_NUCLEAR_AUTUMN)
		return;
    
    item rad = $item[rad];
    if (rad.available_amount() > 0)
    {
        
        int [skill] skill_rad_cost;
        
        foreach s in $skills[Boiling Tear Ducts,Projectile Salivary Glands,Translucent Skin,Skunk Glands,Throat Refrigerant,Internal Soda Machine]
            skill_rad_cost[s] = 30;
        foreach s in $skills[Steroid Bladder,Magic Sweat,Flappy Ears,Self-Combing Hair,Intracranial Eye,Mind Bullets,Extra Kidney,Extra Gall Bladder]
            skill_rad_cost[s] = 60;
        foreach s in $skills[Extra Muscles,Adipose Polymers,Metallic Skin,Hypno-Eyes,Extra Brain,Squid Glands,Extremely Punchable Face,Magnetic Ears,Firefly Abdomen,Bone Springs]
            skill_rad_cost[s] = 90;
        foreach s in $skills[Sucker Fingers,Backwards Knees]
            skill_rad_cost[s] = 120;
        
        string [skill] skill_descriptions;
        skill_descriptions[$skill[Extra Gall Bladder]] = "+100% adventures from food";
        skill_descriptions[$skill[Extra Kidney]] = "+100% Adventures from booze";
        skill_descriptions[$skill[Internal Soda Machine]] = "Restore MP for meat";
        skill_descriptions[$skill[Squid Glands]] = "-10% combat buff";
        skill_descriptions[$skill[Steroid Bladder]] = "+50% muscle buff";
        skill_descriptions[$skill[Extra Muscles]] = "+50% muscle passive";
        skill_descriptions[$skill[Self-Combing Hair]] = "+50% moxie buff";
        skill_descriptions[$skill[Hypno-Eyes]] = "+50% moxie passive";
        skill_descriptions[$skill[Intracranial Eye]] = "+50% myst buff";
        skill_descriptions[$skill[Extra Brain]] = "+50% myst passive";
        skill_descriptions[$skill[Extremely Punchable Face]] = "+30 ML buff";
        skill_descriptions[$skill[Magnetic Ears]] = "15% item buff";
        skill_descriptions[$skill[Sucker Fingers]] = "15% item passive";
        skill_descriptions[$skill[Firefly Abdomen]] = "+10% combat buff";
        skill_descriptions[$skill[Throat Refrigerant]] = "Cold damage spell";
        skill_descriptions[$skill[Flappy Ears]] = "+2 all res buff";
        skill_descriptions[$skill[Metallic Skin]] = "+2 all res passive";
        skill_descriptions[$skill[Bone Springs]] = "+20% init buff";
        skill_descriptions[$skill[Backwards Knees]] = "+20% init passive";
        skill_descriptions[$skill[Magic Sweat]] = "+100 DA, +10 DR buff";
        skill_descriptions[$skill[Adipose Polymers]] = "+100 DA, +10 DR passive";
        skill_descriptions[$skill[Mind Bullets]] = "stunning spell";
        
        skill [int] desired_skill_order;
        
        desired_skill_order.listAppend($skill[Extra Gall Bladder]); //Passive - +100% adventures from food
        desired_skill_order.listAppend($skill[Extra Kidney]); //Passive - +100% Adventures from booze
        desired_skill_order.listAppend($skill[Internal Soda Machine]); //Passive - Spend 20 meat to recover 10 MP
        
        desired_skill_order.listAppend($skill[Squid Glands]); //-10% combat rate buff
        if (my_primestat() == $stat[muscle])
        {
            desired_skill_order.listAppend($skill[Steroid Bladder]); //Buff - +50% Muscle
            desired_skill_order.listAppend($skill[Extra Muscles]); //Passive - +50% Muscle
        }
        else if (my_primestat() == $stat[moxie])
        {
            desired_skill_order.listAppend($skill[Self-Combing Hair]); //Buff - +50% Moxie
            desired_skill_order.listAppend($skill[Hypno-Eyes]); //Passive - +50% Moxie
        }
        else if (my_primestat() == $stat[Mysticality])
        {
            desired_skill_order.listAppend($skill[Intracranial Eye]); //Buff - +50% Mysticality
            desired_skill_order.listAppend($skill[Extra Brain]); //Passive - +50% Mysticality
        }
        
        desired_skill_order.listAppend($skill[Extremely Punchable Face]); //+30 ML buff
        desired_skill_order.listAppend($skill[Magnetic Ears]); //15% item buff
        desired_skill_order.listAppend($skill[Sucker Fingers]); //15% item passive
        desired_skill_order.listAppend($skill[Firefly Abdomen]); //+10% combat rate buff
        
        desired_skill_order.listAppend($skill[Throat Refrigerant]); //Combat - Cold damage
        desired_skill_order.listAppend($skill[Flappy Ears]); //Buff - +2 resistance to all elements
        desired_skill_order.listAppend($skill[Metallic Skin]); //Passive - +2 resistance to all elements
        
        
        desired_skill_order.listAppend($skill[Bone Springs]); //+20% init buff
        desired_skill_order.listAppend($skill[Backwards Knees]); //+20% init passive
        
        desired_skill_order.listAppend($skill[Magic Sweat]); //Buff - Damage Absorption +100 - Damage Reduction: 10
        desired_skill_order.listAppend($skill[Adipose Polymers]); //Passive - Damage Absorption +100 - Damage Reduction: 10
        desired_skill_order.listAppend($skill[Mind Bullets]); //Combat - Stuns opponent
        desired_skill_order.listAppend($skill[Self-Combing Hair]); //Buff - +50% Moxie
        desired_skill_order.listAppend($skill[Hypno-Eyes]); //Passive - +50% Moxie
        desired_skill_order.listAppend($skill[Steroid Bladder]); //Buff - +50% Muscle
        desired_skill_order.listAppend($skill[Extra Muscles]); //Passive - +50% Muscle
        desired_skill_order.listAppend($skill[Intracranial Eye]); //Buff - +50% Mysticality
        desired_skill_order.listAppend($skill[Extra Brain]); //Passive - +50% Mysticality
        
        //desired_skill_order.listAppend($skill[Boiling Tear Ducts]); //Combat - Hot damage
        //desired_skill_order.listAppend($skill[Projectile Salivary Glands]); //Combat - Sleaze damage
        //desired_skill_order.listAppend($skill[Translucent Skin]); //Combat - Spooky damage
        //desired_skill_order.listAppend($skill[Skunk Glands]); //Combat - Stench damage
        
        string [int] description;
        
        boolean [skill] already_displayed_skill;
        foreach key, s in desired_skill_order
        {
            if (s.have_skill())
                continue;
            if (($skills[Magnetic Ears,Sucker Fingers,Extremely Punchable Face,Firefly Abdomen,Bone Springs,Squid Glands,Backwards Knees] contains s) && get_property_int("falloutShelterLevel") < 6) //not yet
                continue;
            if (already_displayed_skill[s])
                continue;
            already_displayed_skill[s] = true;
            string line = s + ": " + skill_descriptions[s];
            if (skill_rad_cost[s] > $item[rad].available_amount())
                line = HTMLGenerateSpanFont(line, "gray");
            description.listAppend(line);
        }
        
		resource_entries.listAppend(ChecklistEntryMake(204, "__item rad", "shop.php?whichshop=mutate", ChecklistSubentryMake(pluralise(rad) + " available", "", description), 8));
    }
    if (get_property_int("falloutShelterLevel") >= 3 && !get_property_boolean("_falloutShelterSpaUsed"))
    {
        //FIXME sync with above
    }
}
static
{
    item [skill][int] __gelatinous_items_that_give_skill;
    
    string [int] __gelatinous_skill_ids_to_descriptions {23001:"+1 hot res", 23002:"+1 hot res", 23003:"+2 hot res", 23004:"+2 hot res", 23005:"+3 hot res", 23006:"+1 cold res", 23007:"+1 cold res", 23008:"+2 cold res", 23009:"+2 cold res", 23010:"+3 cold res", 23011:"+1 stench res", 23012:"+1 stench res", 23013:"+2 stench res", 23014:"+2 stench res", 23015:"+3 stench res", 23016:"+1 spooky res", 23017:"+1 spooky res", 23018:"+2 spooky res", 23019:"+2 spooky res", 23020:"+3 spooky res", 23021:"+1 sleaze res", 23022:"+1 sleaze res", 23023:"+2 sleaze res", 23024:"+2 sleaze res", 23025:"+3 sleaze res", 23026:"+30 DA", 23027:"+40 DA", 23028:"+50 DA", 23029:"+60 DA", 23030:"+70 DA", 23031:"+5 DR", 23032:"+5 DR", 23033:"+10 DR", 23034:"+10 DR", 23035:"+20 DR", 23036:"+10% init", 23037:"+20% init", 23038:"+30% init", 23039:"+40% init", 23040:"+50% init", 23041:"+3 stats/fight", 23042:"+3 stats/fight", 23043:"+5 stats/fight", 23044:"+5 stats/fight", 23045:"+7 stats/fight", 23046:"+1 adv/absorbed item", 23047:"+1 adv/absorbed item", 23048:"+2 adv/absorbed item", 23049:"+2 adv/absorbed item", 23050:"+3 adv/absorbed item", 23051:"+5 stats/absorbed item", 23052:"+10 stats/absorbed item", 23053:"+15 stats/absorbed item", 23054:"+20 stats/absorbed item", 23055:"+25 stats/absorbed item", 23056:"+20% HP", 23057:"+30% HP", 23058:"+40% HP", 23059:"+50% HP", 23060:"+100% HP", 23061:"+20% MP", 23062:"+30% MP", 23063:"+40% MP", 23064:"+50% MP", 23065:"+100% MP", 23066:"+20% item", 23067:"+20% item", 23068:"+30% item", 23069:"+40% item", 23070:"+50% item", 23071:"+10% pickpocket", 23072:"+20% pickpocket", 23073:"+30% pickpocket", 23074:"+40% pickpocket", 23075:"+50% pickpocket", 23076:"+30% meat", 23077:"+40% meat", 23078:"+50% meat", 23079:"+60% meat", 23080:"+70% meat", 23081:"+5 muscle", 23082:"+10 muscle", 23083:"+15 muscle", 23084:"+20 muscle", 23085:"+25 muscle", 23086:"+5 myst", 23087:"+10 myst", 23088:"+15 myst", 23089:"+20 myst", 23090:"+25 myst", 23091:"+5 moxie", 23092:"+10 moxie", 23093:"+15 moxie", 23094:"+20 moxie", 23095:"+25 moxie", 23096:"+7 damage", 23097:"+9 damage", 23098:"+11 damage", 23099:"+13 damage", 23100:"+15 damage", 23101:"+3 Hot Damage", 23102:"+5 Hot Damage", 23103:"+7 Hot Damage", 23104:"+9 Hot Damage", 23105:"+11 Hot Damage", 23106:"+3 Cold Damage", 23107:"+5 Cold Damage", 23108:"+7 Cold Damage", 23109:"+9 Cold Damage", 23110:"+11 Cold Damage", 23111:"+3 Stench Damage", 23112:"+5 Stench Damage", 23113:"+7 Stench Damage", 23114:"+9 Stench Damage", 23115:"+11 Stench Damage", 23116:"+3 Spooky Damage", 23117:"+5 Spooky Damage", 23118:"+7 Spooky Damage", 23119:"+9 Spooky Damage", 23120:"+11 Spooky Damage", 23121:"+3 Sleaze Damage", 23122:"+5 Sleaze Damage", 23123:"+7 Sleaze Damage", 23124:"+9 Sleaze Damage", 23125:"+11 Sleaze Damage", 23301:"-combat buff", 23302:"-combat buff", 23303:"-combat buff", 23304:"+combat buff", 23305:"+combat buff", 23306:"+combat buff"};
    int [int] __gelatinous_evaluation_order {0:23301, 1:23302, 2:23303, 3:23304, 4:23305, 5:23306, 6:23046, 7:23047, 8:23048, 9:23049, 10:23050, 11:23051, 12:23052, 13:23053, 14:23054, 15:23055, 16:23041, 17:23042, 18:23043, 19:23044, 20:23045, 21:23066, 22:23067, 23:23068, 24:23069, 25:23070, 26:23076, 27:23077, 28:23078, 29:23079, 30:23080, 31:23026, 32:23027, 33:23028, 34:23029, 35:23030, 36:23031, 37:23032, 38:23033, 39:23034, 40:23035, 41:23036, 42:23037, 43:23038, 44:23039, 45:23040, 46:23056, 47:23057, 48:23058, 49:23059, 50:23060, 51:23061, 52:23062, 53:23063, 54:23064, 55:23065, 56:23071, 57:23072, 58:23073, 59:23074, 60:23075, 61:23001, 62:23002, 63:23003, 64:23004, 65:23005, 66:23006, 67:23007, 68:23008, 69:23009, 70:23010, 71:23011, 72:23012, 73:23013, 74:23014, 75:23015, 76:23016, 77:23017, 78:23018, 79:23019, 80:23020, 81:23021, 82:23022, 83:23023, 84:23024, 85:23025, 86:23081, 87:23082, 88:23083, 89:23084, 90:23085, 91:23086, 92:23087, 93:23088, 94:23089, 95:23090, 96:23091, 97:23092, 98:23093, 99:23094, 100:23095, 101:23096, 102:23097, 103:23098, 104:23099, 105:23100, 106:23101, 107:23102, 108:23103, 109:23104, 110:23105, 111:23106, 112:23107, 113:23108, 114:23109, 115:23110, 116:23111, 117:23112, 118:23113, 119:23114, 120:23115, 121:23116, 122:23117, 123:23118, 124:23119, 125:23120, 126:23121, 127:23122, 128:23123, 129:23124, 130:23125};
    
    int [int] __gelatinous_skill_raw_modifier_number {23001:1, 23002:1, 23003:2, 23004:2, 23005:3, 23006:1, 23007:1, 23008:2, 23009:2, 23010:3, 23011:1, 23012:1, 23013:2, 23014:2, 23015:3, 23016:1, 23017:1, 23018:2, 23019:2, 23020:3, 23021:1, 23022:1, 23023:2, 23024:2, 23025:3, 23026:30, 23027:40, 23028:50, 23029:60, 23030:70, 23031:5, 23032:5, 23033:10, 23034:10, 23035:20, 23036:10, 23037:20, 23038:30, 23039:40, 23040:50, 23041:3, 23042:3, 23043:5, 23044:5, 23045:7, 23046:1, 23047:1, 23048:2, 23049:2, 23050:3, 23051:5, 23052:10, 23053:15, 23054:20, 23055:25, 23056:20, 23057:30, 23058:40, 23059:50, 23060:100, 23061:20, 23062:30, 23063:40, 23064:50, 23065:100, 23066:20, 23067:20, 23068:30, 23069:40, 23070:50, 23071:10, 23072:20, 23073:30, 23074:40, 23075:50, 23076:30, 23077:40, 23078:50, 23079:60, 23080:70, 23081:5, 23082:10, 23083:15, 23084:20, 23085:25, 23086:5, 23087:10, 23088:15, 23089:20, 23090:25, 23091:5, 23092:10, 23093:15, 23094:20, 23095:25, 23096:7, 23097:9, 23098:11, 23099:13, 23100:15, 23101:3, 23102:5, 23103:7, 23104:9, 23105:11, 23106:3, 23107:5, 23108:7, 23109:9, 23110:11, 23111:3, 23112:5, 23113:7, 23114:9, 23115:11, 23116:3, 23117:5, 23118:7, 23119:9, 23120:11, 23121:3, 23122:5, 23123:7, 23124:9, 23125:11};
}
void initialiseGelatinousStatics()
{
    if (__gelatinous_items_that_give_skill.count() > 0)
        return;
    foreach it in $items[]
    {
        if (!it.item_is_pvp_stealable() && !(it.gift && it.discardable) && !($items[interesting clod of dirt,dirty bottlecap,discarded button] contains it)) continue;
        
		if ($slots[hat,weapon,off-hand,back,shirt,pants,acc1,acc2,acc3] contains it.to_slot()) //familiar equipment fine
			continue;
		if ($items[map to Madness Reef,map to the Marinara Trench,map to Anemone Mine,map to the Dive Bar,map to the Skate Park, glass of &quot;milk&quot;, cup of &quot;tea&quot;, thermos of &quot;whiskey&quot;, Lucky Lindy, Bee's Knees, Sockdollager, Ish Kabibble, Hot Socks, Phonus Balonus, Flivver, Sloppy Jalopy] contains it) //'
			continue;
        
        int lookup = it.descid.to_int_silent() % 125 + 23001;
        int item_id = it.to_int();
        //Hardcoded:
        if (item_id == 9353)
            lookup = 23302;
        else if (item_id == 9349)
            lookup = 23304;
        else if (item_id == 9357)
            lookup = 23301;
        else if (item_id == 9359)
            lookup = 23306;
        else if (item_id == 9361)
            lookup = 23305;
        else if (item_id == 9354)
            lookup = 23303;
        skill s = lookup.to_skill();
        if (!(__gelatinous_items_that_give_skill contains s))
            __gelatinous_items_that_give_skill[s] = listMakeBlankItem();
        __gelatinous_items_that_give_skill[s].listAppend(it);
    }
    
    
}


RegisterTaskGenerationFunction("PathGelatinousNoobGenerateTasks");
void PathGelatinousNoobGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_GELATINOUS_NOOB)
		return;
    
    int total_absorptions = 2 + MIN(13, my_level());
    int absorptions_used = get_property_int("_noobSkillCount");
    //int absorptions_used = my_absorbs(); //FIXME next point release, 17.7
    int absorptions_left = total_absorptions - absorptions_used;
    if (absorptions_left > 0)
    {
        initialiseGelatinousStatics();
        string [int] description;
        
        
        if (true)
        {
            boolean [item] blocklist;
            
            if (__quest_state["Level 9"].state_int["peak tests remaining"] > 0)
                blocklist[$item[rusty hedge trimmers]] = true;
            if ($item[goat cheese].available_amount() <= 3 && !__quest_state["Level 8"].state_boolean["Past mine"])
            {
                blocklist[$item[goat cheese]] = true;
                blocklist[$item[goat cheese pizza]] = true;
            }
            foreach it in $items[print screen button,spooky-gro fertilizer,cuppa obscuri tea]
                blocklist[it] = true;
            if (__quest_state["Pirate Quest"].state_boolean["hot wings relevant"] && $item[hot wing].available_amount() <= 3)
                blocklist[$item[hot wing]] = true;
                
            //Collect a list for each grouping:
            
            int [int][int] first_level_group_evaluation_indices;
            for grouping_index from 23125 to 23001 by -5
            {
                int [int] group_indices;
                for i from grouping_index to grouping_index - 4 by -1
                {
                    group_indices.listAppend(i);
                }
                first_level_group_evaluation_indices[grouping_index] = group_indices;
            }
            first_level_group_evaluation_indices[23301] = listMake(23303, 23302, 23301);
            first_level_group_evaluation_indices[23304] = listMake(23306, 23305, 23304);
            
            string [int][int] grouping_to_relevant_items;
            
            skill [int][int] grouping_to_group_skills;
            skill [int] grouping_to_relevant_items_skill;
            boolean [int] grouping_should_grey_out;
            //for grouping_index from 23125 to 23001 by -5
            foreach grouping_index in first_level_group_evaluation_indices
            {
                int [int] group_indices = first_level_group_evaluation_indices[grouping_index];
                
                skill [int] group_skills;
                //for i from grouping_index to grouping_index - 4 by -1
                foreach key2, i in group_indices
                {
                   skill s = i.to_skill();
                   if (s.have_skill()) continue;
                    group_skills.listAppend(s);
                }
                //print_html("group_skills = " + group_skills.to_json());
                grouping_to_group_skills[grouping_index] = group_skills;
                //The ideal here is, we want to find a list of items for the best skill in the group.
                //If that's not possible, we do the second best skill, etc. We also list the best pull, but only if it's relevant
                item pullable_item = $item[none];
                item [int] relevant_items;
                boolean on_first = true;
                foreach key, s in group_skills
                {
                    if (key > 0)
                        on_first = false;
                    foreach key2, it in __gelatinous_items_that_give_skill[s]
                    {
                        if (blocklist contains it)
                            continue;
                        if (it.available_amount() == 0 && it.creatable_amount() == 0 && (it.npc_price() == 0 || it.npc_price() > my_meat()))
                        {
                            if (pulls_remaining() > 0 && !it.gift && key == 0 && it.is_unrestricted())
                            {
                                if (pullable_item == $item[none] || (it.historical_price() < pullable_item.historical_price() && it.historical_price() > 0))
                                    pullable_item = it;
                            }
                            continue;
                        }
                        relevant_items.listAppend(it);
                    }
                    if (relevant_items.count() > 0)
                    {
                        grouping_to_relevant_items_skill[grouping_index] = s;
                        break;
                    }
                }
                boolean should_grey_out = false;
                if (grouping_to_relevant_items_skill[grouping_index] == $skill[none])
                {
                    grouping_to_relevant_items_skill[grouping_index] = group_skills[0];
                    should_grey_out = true;
                }
                grouping_should_grey_out[grouping_index] = should_grey_out;
                string [int] relevant_items_out;
                //sort relevant_items by (value.historical_price() <= 0 ? 999999999 : value.historical_price());
                //NPC price is more relevant in-run, since cost of acquisition.
                sort relevant_items by (value.npc_price() > 0 ? value.npc_price() : (value.historical_price() <= 0 ? 999999999 : value.historical_price()));
                if (relevant_items[0].npc_price() > 0 && relevant_items[0].npc_price() <= 1000) //something cheap and obtainable? ignore the rest
                {
                    //examples: fermenting powder, herbs, pickled egg
                    relevant_items_out.listAppend(relevant_items[0]);
                }
                else
                {
                    foreach key, it in relevant_items
                    {
                        if (key > 2) break;
                        relevant_items_out.listAppend(it);
                    }
                }
                if (pulls_remaining() > 0 && (!on_first || relevant_items.count() == 0) && pullable_item != $item[none])
                {
                    string line = pullable_item + " (pull";
                    if (!should_grey_out)
                        line += " for +" + __gelatinous_skill_raw_modifier_number[group_skills[0].to_int()];
                    line += ")";
                    line = HTMLGenerateSpanFont(line, "gray");
                    relevant_items_out.listPrepend(line);
                }
                grouping_to_relevant_items[grouping_index] = relevant_items_out;
            }
            
            foreach key, s_id in __gelatinous_evaluation_order
            {
                if (s_id % 5 != 0 && s_id != 23301 && s_id != 23304) continue;
                skill s = s_id.to_skill();
                int grouping_index = s_id;
                
                string [int] relevant_items = grouping_to_relevant_items[grouping_index];
                skill [int] group_skills = grouping_to_group_skills[grouping_index];
                skill relevant_items_skill = grouping_to_relevant_items_skill[grouping_index];
                
                //print_html("s = " + s + " group_skills = " + group_skills.to_json() + ", relevant_items = " + relevant_items.to_json());
                
                //description.listAppend(relevant_items_skill + ": " + __gelatinous_skill_ids_to_descriptions[relevant_items_skill.to_int()]);
                string extra_data;
                if ($familiar[robortender].familiar_is_usable())
                {
                    phylum [int] phylums_to_run_against;
                    if (grouping_index == 23301)
                    {
                        if (!$skill[bendable knees].have_skill() && $item[bottle of gregnadigne].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[humanoid]);
                        if (!$skill[retractable toes].have_skill() && $item[cocktail mushroom].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[goblin]);
                        if (!$skill[ink gland].have_skill() && $item[shot of granola liqueur].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[hippy]);
                    }
                    if (grouping_index == 23304)
                    {
                        if (!$skill[frown muscles].have_skill() && $item[bottle of novelty hot sauce].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[demon]);
                        if (!$skill[anger glands].have_skill() && $item[limepatch].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[pirate]);
                        if (!$skill[powerful vocal chords].have_skill() && $item[baby oil shooter].available_amount() == 0)
                            phylums_to_run_against.listAppend($phylum[orc]);
                    }
                    if (phylums_to_run_against.count() > 0)
                        extra_data += "Run robortender against " + phylums_to_run_against.listJoinComponents(", ", "and");
                }
                
                string line = HTMLGenerateSpanOfClass(__gelatinous_skill_ids_to_descriptions[relevant_items_skill.to_int()], "r_bold");
                if (relevant_items.count() > 0 || extra_data != "")
                {
                    if (relevant_items.count() > 0)
                        line += ": " + relevant_items.listJoinComponents(", ", "or");
                    if (extra_data != "")
                        line += "|*" + extra_data;
                    line += ".";
                    if (grouping_should_grey_out[grouping_index])
                        line = HTMLGenerateSpanFont(line, "gray");
                    description.listAppend(line);
                }
                
            }
            description.listAppend("Or equipment, for their buffs." + (combat_rate_modifier() > -25 ? "|*Bram's choker, ring of conflict, duonoculars, rusted shootin' iron, or red shoe especially." : ""));
            if ($skill[Large Intestine].have_skill())
                description.listAppend("Or potted cactus, for +5 adventures.");
            //foreach s in __gelatinous_items_that_give_skill
            /*foreach key, s_id in __gelatinous_evaluation_order
            {
                skill s = s_id.to_skill();
                if (s.have_skill()) continue;
                
                string [int] relevant_items;
                item pullable_item = $item[none];
                boolean should_grey_out = false;
                foreach key, it in __gelatinous_items_that_give_skill[s]
                {
                    if (blocklist contains it)
                        continue;
                    if (it.available_amount() == 0 && it.creatable_amount() == 0 && (it.npc_price() == 0 || it.npc_price() > my_meat()))
                    {
                        if (pulls_remaining() > 0 && !it.gift)
                        {
                            if (pullable_item == $item[none] || (it.historical_price() < pullable_item.historical_price() && it.historical_price() > 0))
                                pullable_item = it;
                        }
                        continue;
                    }
                    relevant_items.listAppend(it);
                }
                if (pullable_item != $item[none] && relevant_items.count() == 0)
                {
                    if (relevant_items.count() == 0)
                        should_grey_out = true;
                    relevant_items.listAppend(HTMLGenerateSpanFont(pullable_item + " (pull)", "gray"));
                }
                string line = HTMLGenerateSpanOfClass(__gelatinous_skill_ids_to_descriptions[s.to_int()], "r_bold");
                if (relevant_items.count() > 0)
                    line += ": " + relevant_items.listJoinComponents(", ", "or") + ".";
                else
                    should_grey_out = true;
                if (should_grey_out)
                    line = HTMLGenerateSpanFont(line, "gray");
                description.listAppend(line);
            }*/
        }
        optional_task_entries.listAppend(ChecklistEntryMake(181, "__familiar Gelatinous Cubeling", "inventory.php", ChecklistSubentryMake("Absorb " + pluralise(absorptions_left, "item", "items"), "", description), -1));
    }
    
    if ($familiar[Robortender].have_familiar())
    {
    
        string url = "";
        
        if (my_familiar() != $familiar[Robortender])
            url = "familiar.php";
        phylum [int] phylums_to_run_against;
        location [int] suggested_locations;
        string [int] matchup_type;
        boolean have_minus = false;
        boolean have_plus = false;
        if (!$skill[bendable knees].have_skill() && $item[bottle of gregnadigne].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[humanoid]);
            suggested_locations.listAppend($location[the old landfill]);
            matchup_type.listAppend("-");
            have_minus = true;
        }
        if (!$skill[retractable toes].have_skill() && $item[cocktail mushroom].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[goblin]);
            suggested_locations.listAppend($location[the outskirts of cobb's knob]);
            matchup_type.listAppend("-");
            have_minus = true;
        }
        if (!$skill[ink gland].have_skill() && $item[shot of granola liqueur].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[hippy]);
            suggested_locations.listAppend($location[hippy camp]);
            matchup_type.listAppend("-");
            have_minus = true;
        }
        if (!$skill[frown muscles].have_skill() && $item[bottle of novelty hot sauce].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[demon]);
            suggested_locations.listAppend($location[the dark heart of the woods]);
            matchup_type.listAppend("+");
            have_plus = true;
        }
        if (!$skill[anger glands].have_skill() && $item[limepatch].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[pirate]);
            suggested_locations.listAppend($location[the obligatory pirate's cove]);
            matchup_type.listAppend("+");
            have_plus = true;
        }
        if (!$skill[powerful vocal chords].have_skill() && $item[baby oil shooter].available_amount() == 0)
        {
            phylums_to_run_against.listAppend($phylum[orc]);
            suggested_locations.listAppend($location[frat house]);
            matchup_type.listAppend("+");
            have_plus = true;
        }
            
        string [int] skill_types;
        if (have_minus)
            skill_types.listAppend("-combat");
        if (have_plus)
            skill_types.listAppend("+combat");
        string [int] description;
        description.listAppend("Collect components for " + skill_types.listJoinComponents(", ", "and") + " skills.");
        if (suggested_locations.count() > 0)
        {
            string [int] locations_out;
            foreach key, l in suggested_locations
            {
                locations_out.listAppend(l + " (" + matchup_type[key] + ")");
            }
            description.listAppend("Could look in " + locations_out.listJoinComponents(", ", "and") + ".");
            if (url == "")
                url = suggested_locations[0].getClickableURLForLocation();
        }
        if (phylums_to_run_against.count() > 0)
        {
            string [int] phylums_out;
            foreach key, p in phylums_to_run_against
            {
                phylums_out.listAppend(p + " (" + matchup_type[key] + ")");
            }
            optional_task_entries.listAppend(ChecklistEntryMake(182, "__familiar Robortender", url, ChecklistSubentryMake("Run robortender against " + phylums_out.listJoinComponents(", ", "and"), "", description), 5));
        }
    }
}
RegisterTaskGenerationFunction("PathLicenseToAdventureGenerateTasks");
void PathLicenseToAdventureGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    if (my_path_id() != PATH_LICENSE_TO_ADVENTURE)
        return;
    if ($item[Victor's Spoils].available_amount() > 0 && !get_property_boolean("_victorSpoilsUsed"))
    {
        task_entries.listAppend(ChecklistEntryMake(155, "__item victor's spoils", "inventory.php?which=3", ChecklistSubentryMake("Use Victor's Spoils", "", "Gives eleven adventures."), 3));
    }
    
    int lair_progress = get_property_int("_villainLairProgress");
    if (lair_progress < 999) //revision is a guess
    {
        //_villainLairColorChoiceUsed, _villainLairDoorChoiceUsed, _villainLairSymbologyChoiceUsed
        //_villainLairCanLidUsed, _villainLairFirecrackerUsed, _villainLairWebUsed
        string [int] description;
        string [int] modifiers;
        description.listAppend("Prevents disavowed debuff. Costs quite a few turns, though, so consider skipping if you're leaderboarding.");
        description.listAppend("Progress: " + lair_progress + " minions.");
        
        if (!get_property_boolean("bondSymbols") && get_property_boolean("_villainLairSymbologyChoiceUsed"))
            description.listAppend("May want to learn LI-11's Universal Symbology Guide first, saves fifteen turns.");
        
        item [int] items_to_throw;
        if (!get_property_boolean("_villainLairCanLidUsed") && $item[razor-sharp can lid].item_amount() > 0)
            items_to_throw.listAppend($item[razor-sharp can lid]);
        if (!get_property_boolean("_villainLairFirecrackerUsed"))
        {
            if ($item[Knob Goblin firecracker].item_amount() > 0)
                items_to_throw.listAppend($item[Knob Goblin firecracker]);
            else if (!$location[cobb's knob barracks].locationAvailable())
                description.listAppend("Farm a Knob Goblin Firecracker from the Outskirts of Cobb's Knob first, but only while you're still on that quest.");
        }
        if (!get_property_boolean("_villainLairWebUsed") && $item[spider web].item_amount() > 0)
            items_to_throw.listAppend($item[spider web]);
        if ($item[can of Minions-Be-Gone].item_amount() > 0)
            description.listAppend("Use " + pluralise($item[can of Minions-Be-Gone]) + ".");
        
        if (items_to_throw.count() > 0)
            description.listAppend("Use " + items_to_throw.listJoinComponents(", ", "and") + " in combat at the lair.");
        
        if (lair_progress >= 5 && (!get_property_boolean("_villainLairColorChoiceUsed") || !get_property_boolean("_villainLairDoorChoiceUsed") || !get_property_boolean("_villainLairSymbologyChoiceUsed")))
        {
            //I think there might be an in-game bug here? Someone noted seeing an NC first turn, even though CDMspading has it at five minions minimum?
            modifiers.listAppend("-combat");
            description.listAppend("Run -combat to speed up acquiring choices.");
        }
        task_entries.listAppend(ChecklistEntryMake(156, "__item victor's spoils", "", ChecklistSubentryMake("Adventure in the Villain's Lair", modifiers, description), 3, $locations[Super Villain's Lair]));
    }
    
    int social_capital_available = licenseToAdventureSocialCapitalAvailable();
    if (social_capital_available > 0)
    {
        int bond_points = get_property_int("bondPoints");
        string [int] description;
        
        //FIXME bond_points values are guesses
        if (!get_property_boolean("bondJetpack") && social_capital_available >= 3)
        {
            description.listAppend("Short-Range Jetpack: saves quite a few turns");
        }
        if (!get_property_boolean("bondSymbols") && social_capital_available >= 3)
        {
            description.listAppend("Universal Symbology Guide: if you're doing the lairs");
        }
        if (!get_property_boolean("bondBridge") && social_capital_available >= 3 && bond_points >= 3)
        {
            description.listAppend("Portable Pocket Bridge: speeds up level nine quest");
        }
        if (!get_property_boolean("bondWar") && social_capital_available >= 3 && bond_points >= 5)
        {
            description.listAppend("Trained Sniper, Felicity Snuggles: speeds up war");
        }
        if (!get_property_boolean("bondItem3") && social_capital_available >= 4 && bond_points >= 7)
        {
            description.listAppend("Electromagnetic Ring: +30% item");
        }
        if (!get_property_boolean("bondDrunk2") && social_capital_available >= 3)
        {
            description.listAppend("Soberness Injection Pen: +2 max drunkenness");
        }
        if (!get_property_boolean("bondDrunk1") && social_capital_available >= 2)
        {
            description.listAppend("Belt-Implanted Still: +1 max drunkenness");
        }
        if (!get_property_boolean("bondItem2") && social_capital_available >= 2)
        {
            description.listAppend("Sticky Climbing Gloves: +20% item");
        }
        if (!get_property_boolean("bondAdv") && social_capital_available >= 1)
        {
            description.listAppend("Super-Accurate Spy Watch: +11 adventures/rollover");
        }
        if (!get_property_boolean("bondMartiniTurn") && social_capital_available >= 1)
        {
            description.listAppend("Exotic Bartender, Barry L. Eagle: +1 adv/drink");
        }
        if (!get_property_boolean("bondItem1") && social_capital_available >= 1)
        {
            description.listAppend("Master Art Thief, Sly Richard: +10% item");
        }
        if (!get_property_boolean("bondInit") && social_capital_available >= 1)
        {
            description.listAppend("Jet-Powered Skis: +30% init");
        }
        if (!get_property_boolean("bondSpleen") && social_capital_available >= 5 && $item[astral energy drink].available_amount() >= 2 && bond_points >= 9)
        {
            description.listAppend("Robo-Speen: Consume two AEDs in a day.");
        }
            
            
        optional_task_entries.listAppend(ChecklistEntryMake(157, "__item briefcase", "place.php?whichplace=town_right&action=town_bondhq", ChecklistSubentryMake("Spend " + social_capital_available + " social capital", "", description), 3));
    }
}

RegisterResourceGenerationFunction("PathGLoverGenerateResource");
void PathGLoverGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (my_path_id() != PATH_G_LOVER)
        return;
	
	item g = $item[9909];
	if (g.available_amount() > 0)
	{
		string [int] description;
        if (__quest_state["Level 9"].state_int["a-boo peak hauntedness"] > 0 && !__quest_state["Level 9"].finished && $items[a-boo glue,glued a-boo clue].available_amount() * 30 < __quest_state["Level 9"].state_int["a-boo peak hauntedness"])
  		description.listAppend("A-Boo glue: lets you use one a-boo clue.");
		if (!__quest_state["Level 9"].state_boolean["Peak Jar Completed"] && !__quest_state["Level 9"].finished && $item[jar of oil].available_amount() == 0 && g.available_amount() >= 3)
	        description.listAppend("Crude oil congealer: lets you create a jar of oil.");
        description.listAppend("Food, drink, +100% spleen item for fifty turns.");
		resource_entries.listAppend(ChecklistEntryMake(196, "__item g", "shop.php?whichshop=glover", ChecklistSubentryMake(pluralise(g) + " available", "", description), 3));
	}
}

RegisterResourceGenerationFunction("PathExplosionsGenerateResource");
void PathExplosionsGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (my_path_id() != PATH_EXPLOSIONS)
        return;
    item isotopes = $item[rare Meat isotope];
    if (isotopes.have())
    {
    	string [int] description;
        int isotope_amount = isotopes.available_amount();
        if (isotope_amount >= 5)
        {
        	description.listAppend("<strong>Space chowder</strong> - for eating or hippy-fighting war.");
            description.listAppend("<strong>Space wine</strong> - for drinking or frat-fighting war.");
        }
        if (isotope_amount >= 10 && !$item[antique accordion].have() && my_class() != $class[accordion thief])
            description.listAppend("<strong>antique accordion</strong> - casting AT buffs.");
        if (isotope_amount >= 20 && availableSpleen() > $item[lucky pill].available_amount())
            description.listAppend("<strong>lucky pill</strong> - extra clovers, super useful.");
        if (isotope_amount >= 25 && !$item[signal jammer].have())
            description.listAppend("<strong>signal jammer</strong> - deals with those troublesome wandering skeletons. Equipped this in non-delay-burning areas.");
        if (isotope_amount >= 25 && !$item[space shield].have() && ($item[digital key].have() || $item[white pixel].available_amount() >= 30))
            description.listAppend("<strong>space shield</strong> - wear this everywhere that is adventure.php, prevents invader bullets");
            
        
        //if (isotope_amount >= 10 && !$item[low-pressure oxygen tank].have())
            //description.listAppend("<strong>low-pressure oxygen tank</strong> - prevents HP damage at end of fight, but you probably want to ignore this.");
            
        resource_entries.listAppend(ChecklistEntryMake(141, "__item rare Meat isotope", "shop.php?whichshop=exploathing", ChecklistSubentryMake(pluralise(isotopes), "", description), 5));
    }
}
RegisterTaskGenerationFunction("PathLowKeyGenerateTasks");
void PathLowKeyGenerateTasks(ChecklistEntry [int] task_entries, ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
	if (my_path_id() != PATH_LOKI) //I've never met this man in my life
		return;
    location [item] key_locations = {
    $item[Anchovy can key]:$location[The Haunted Pantry],
    $item[Weremoose key]:$location[Cobb's Knob Menagerie, Level 2],
    $item[Treasure chest key]:$location[Belowdecks],
    $item[Batting cage key]:$location[The Bat Hole Entrance],
    $item[F'c'le sh'c'le k'y]:$location[The F'c'le],
    $item[Actual skeleton key]:$location[The Skeleton Store],
    $item[Cactus key]:$location[The Arid, Extra-Dry Desert],
    $item[Music Box Key]:$location[The Haunted Nursery],
    $item[Ice Key]:$location[The Icy Peak],
    $item[Knob treasury key]:$location[Cobb's Knob Treasury],
    $item[Demonic key]:$location[Pandamonium Slums],
    $item[Scrap metal key]:$location[The Old Landfill],
    $item[Deep-fried key]:$location[Madness Bakery],
    $item[Peg key]:$location[The Obligatory Pirate's Cove],
    $item[Knob labinet key]:$location[Cobb's Knob Laboratory],
    $item[Knob shaft skate key]:$location[The Knob Shaft],
    $item[Discarded bike lock key]:$location[The Overgrown Lot],
    $item[Clown car key]:$location[The "Fun" House],
    $item[Rabbit's foot key]:$location[The Dire Warren],
    $item[Key sausage]:$location[Cobb's Knob Kitchens],
    $item[Black rose key]:$location[The Haunted Conservatory],
    $item[10549]:$location[South of the Border],
    $item[Kekekey]:$location[The Valley of Rof L'm Fao],
    };
    //clown car key,batting cage key,10549,knob labinet key,weremoose key,peg key,kekekey,rabbit's foot key,knob shaft skate key,ice key,anchovy can key,cactus key,f'c'le sh'c'le k'y,treasure chest key,demonic key,key sausage,knob treasury key,scrap metal key,black rose key,music box key,actual skeleton key,deep-fried key,discarded bike lock key
    
    //FIXME suggest starting the three quests
	boolean [item] keys_we_need;
	
	boolean need_keys = QuestState("questL13Final").mafia_internal_step <= 6;
	
    string [int] keys_used = split_string_alternate(get_property("nsTowerDoorKeysUsed"), ",");
    boolean [string] keys_used_inverted = keys_used.listInvert();
	if (need_keys)
	{
        foreach key, l in key_locations
        {
        	//if (debug) keys_we_need[key] = true;
            if (key == $item[none]) continue;
            if (key.have()) continue;
            if (keys_used_inverted[key.to_string()]) continue;
            keys_we_need[key] = true;
        }
	}
	
    foreach key in keys_we_need
	{
		location l = key_locations[key];
        boolean location_available = l.locationAvailable();
        if ($locations[Barrrney's Barrr,The F'c'le,The Poop Deck,Belowdecks] contains l && (have_outfit_components("Swashbuckling Getup") || $item[pirate fledges].have())) //need to improve the locationAvailable API to distinguish between "could adventure there, with equipment" and "can adventure there right this second"
        	location_available = true;
        
        string title = "Adventure in " + l;
        
        if (!location_available)
        	title = HTMLGenerateSpanFont(title, "grey");
        
        int turns_left = clampi(12 - l.turns_spent, 0, 12);
        
        ChecklistSubentry subentry = ChecklistSubentryMake(title, "", "");
        
        //per-zone:
        if (!location_available)
        {
        	if (l == $location[The "Fun" House])
         	   subentry.entries.listAppend("Unlock by " + (!guild_store_available() ? "unlocking your guild and " : "") + "completing the first part of the nemesis quest.");
            else if (l == $location[The Bat Hole Entrance])
            	subentry.entries.listAppend("Unlock by starting the level 4 quest.");
            else if (l == $location[South of the Border])
            	subentry.entries.listAppend("Unlock by opening the desert.");
            else if (l == $location[Cobb's Knob Laboratory])
            	subentry.entries.listAppend("Unlock by completing the level 5 quest.");
            else if (l == $location[Cobb's Knob Menagerie\, Level 2])
            	subentry.entries.listAppend("Unlock by collecting the menagerie key from Knob Goblin Very Mad Scientist in cobb's knob laboratory.");
            else if (l == $location[The Obligatory Pirate's Cove])
            	subentry.entries.listAppend("Unlock by unlocking the mysterious island.");
            else if (l == $location[The Valley of Rof L'm Fao])
            	subentry.entries.listAppend("Unlock by finishing the level 9 quest.");
            else if (l == $location[The Dire Warren])
            	subentry.entries.listAppend("This should be unlocked. If you are seeing this message, it is in error. Which means someone will see it eventually. Congrats!");
            else if (l == $location[The Knob Shaft])
            	subentry.entries.listAppend("Unlock by ... has anyone ever been here before? I'm not sure it's a real place, let me check the wiki|I think they made it up, but you can unlock it by completing the level 5 quest.");
            else if (l == $location[The Icy Peak])
            	subentry.entries.listAppend("Unlock during the level 8 quest.");
            else if (l == $location[The Arid\, Extra-Dry Desert])
            	subentry.entries.listAppend("Unlock during the level 11 quest.");
            else if (l == $location[The F'c'le])
            	subentry.entries.listAppend("Unlock by completing the pirate quest.");
            else if (l == $location[Belowdecks])
            	subentry.entries.listAppend("Unlock by reading the level 11 diary and adventuring on the poop deck.");
            else if (l == $location[Pandamonium Slums])
            	subentry.entries.listAppend("Unlock by finishing the level 6 quest.");
            else if (l == $location[Cobb's Knob Kitchens])
            	subentry.entries.listAppend("Unlock during the level 5 quest.");
            else if (l == $location[Cobb's Knob Treasury])
            	subentry.entries.listAppend("Unlock during the level 5 quest.");
            else if (l == $location[The Old Landfill])
            	subentry.entries.listAppend("Unlock by speaking to the hippy in the distant woods.");
            else if (l == $location[The Haunted Conservatory] || l == $location[The Haunted Pantry])
            	subentry.entries.listAppend("Unlock by reading... a note you got from the mail? I think?");
            else if (l == $location[The Haunted Nursery])
            	subentry.entries.listAppend("Unlock by completing the manor quest.");
            else if (l == $location[The Skeleton Store])
            	subentry.entries.listAppend("Unlock by talking to the meat smith in town.");
            else if (l == $location[Madness Bakery])
            	subentry.entries.listAppend("Unlock by talking to the Armorer and Leggerer's.");
            else if (l == $location[The Overgrown Lot])
            	subentry.entries.listAppend("Unlock by talking to Doc Galaktik.");
        }
        else
        {
            if (turns_left <= 1)
                subentry.entries.listAppend("Key next turn.");
            else
            {
                subentry.entries.listAppend(pluralise(turns_left, "turn", "turns") + " until key.");
                if (__misc_state["free runs available"])
                    subentry.modifiers.listAppend("free runs");
                if (__misc_state["have hipster"])
                    subentry.modifiers.listAppend(__misc_state_string["hipster name"]);
            }
                
            if ($locations[Barrrney's Barrr,The F'c'le,The Poop Deck,Belowdecks,The Obligatory Pirate's Cove] contains l)
            {
                if (QuestState("questL12War").mafia_internal_step == 2)
                {
                	subentry.entries.listAppend("Finish the war first.");
                }
                if (l != $location[The Obligatory Pirate's Cove] && !($item[pirate fledges].equipped() || is_wearing_outfit("Swashbuckling Getup")))
                {
                	if ($item[pirate fledges].have())
	                	subentry.entries.listAppend("Equip the pirate fledges first.");
                    else if (have_outfit_components("Swashbuckling Getup"))
	                	subentry.entries.listAppend("Equip the swashbuckling getup first.");
                    else
	                	subentry.entries.listAppend("Find the swashbuckling getup first.");
                }
            }
        }
        
        
        
        task_entries.listAppend(ChecklistEntryMake(205, "__item Asdon Martin keyfob", l.getClickableURLForLocation(), subentry, 8).ChecklistEntryTag("low key summer path"));
    }      
}


void runMain()
{
	if (false)
	{
		//Minimal mode, for testing performance.
		write("you are ascending too slowly, ascend faster!"); return;
    }
    write(" "); //mafia will return a 404 if we write nothing (i.e. when setting user preferences). I suppose we should always write an API response or something
	string [string] form_fields = form_fields();
	//print_html("relay_Guide.ash, form_fields = " + form_fields.to_json()); 
	if (form_fields["API status"] != "")
	{
        string [string] api_response = generateAPIResponse();
        write(api_response.to_json());
        return;
	}
    
	boolean output_body_tag_only = false;
	if (form_fields["body tag only"] != "")
	{
		output_body_tag_only = true;
	}
    else if (form_fields["set user preferences"] != "")
    {
    	//In this case, every other key=value is set in our own preference tracking.
        //this design is kind of wonky, don't like it - the implicit "everything else"
        processSetUserPreferences(form_fields);
        return;
    }
    //else if (form_fields.count() > 0)
        //print_html("Form fields: " + form_fields.to_json());
	
    
    locationCompatibilityInit();
	PageInit();
	ChecklistInit();
	setUpCSSStyles();
	
	
	Checklist [int] ordered_output_checklists;
	generateChecklists(ordered_output_checklists);
	
    string guide_title = "Guide";
    if (limit_mode() == "batman")
        guide_title = "Bat-Guide";
	
	PageSetTitle(guide_title);
	
    if (__setting_use_kol_css)
        PageWriteHead(HTMLGenerateTagPrefix("link", mapMake("rel", "stylesheet", "type", "text/css", "href", "/images/styles.css")));
        
    PageWriteHead(HTMLGenerateTagPrefix("meta", mapMake("name", "viewport", "content", "width=device-width")));
	
	
	
	
	
	boolean resource_bar_open = PreferenceGetBoolean("resource bar open");
	string using_relay_filename = __relay_filename;
    if (__relay_filename.to_lower_case() == "relay_guide.ash")
    	using_relay_filename = __relay_filename;
	
	string guide_init_code = "GuideParachuteInit(); GuideInit('" + using_relay_filename + "'," + __setting_horizontal_width + "," + resource_bar_open + ", '" + __version + "');";
	
    PageSetBodyAttribute("onload", guide_init_code); //not escaped
    
    boolean drunk = $item[beer goggles].equipped_amount() > 0;
    
    if (drunk)
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "-webkit-filter:blur(4.0px) brightness(1.01);"))); //FIXME make this animated
        
    boolean buggy = (my_familiar() == $familiar[software bug] || $item[iShield].equipped_amount() > 0);
    if (buggy)
    {
        //Ideally we'd want to layer over a mosaic filter, giving a Cinepak look, but pixel manipulation techniques are limited in HTML.
        string chosen_font;
        //chosen_font = "'Comic Sans MS', cursive, sans-serif;"; //DO NOT USE
        //chosen_font = "'Courier New', Courier, monospace;";
        chosen_font = "'Helvetica Neue',Arial, Helvetica, sans-serif;font-weight:300;";
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "font-family:" + chosen_font)));
        //PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "")));
        //
    }
    
    buffer various_bar_buffer;
    boolean displaying_navbar = false;
	if (__setting_show_navbar)
	{
		if (ordered_output_checklists.count() > 1)
			displaying_navbar = true;
	}
	
    if (true)
    {
        buffer resource_bar = generateResourceBar(ordered_output_checklists);
        various_bar_buffer.append(resource_bar);
    }
    if (__setting_show_location_bar)
    {
        buffer location_bar = generateLocationBar(displaying_navbar);
        various_bar_buffer.append(location_bar);
    }
	if (displaying_navbar)
	{
        buffer navbar = generateNavbar(ordered_output_checklists);
        various_bar_buffer.append(navbar);
	}
    
    
    
    
    if (true)
    {
        //Buttons.
        //position:absolute holding container, so we can absolutely position these, absolutely:
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "position:absolute;" + "width:100%;"))); //max-width:" + max_width_setting + "px;"
        
        int button_size = 16;
        int vertical_button_spacing = button_size / 2;
        string [string] base_image_map;
        base_image_map["width"] = button_size;
        base_image_map["height"] = button_size;
        base_image_map["class"] = "r_button";
        
        
        //Left side:
        string [string] image_map = mapCopy(base_image_map);
        image_map["src"] = __close_image_data;
        image_map["onclick"] = "buttonCloseClicked(event)";
        image_map["style"] = "left:5px;top:5px;position:fixed;z-index:4;";
        image_map["id"] = "button_close_box";
        image_map["alt"] = "Close";
        image_map["title"] = image_map["alt"];
        PageWrite(HTMLGenerateTagPrefix("img", image_map));
        
        PageWrite("</div>");
        
        
        string spacing_div = "<span style=\"width:1em;height:1px;\"> </span>";
        
        
        //Right side:
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "position:absolute;" + "right:20px;top:3px;z-index:5;")));
        
        image_map = mapCopy(base_image_map);
        image_map["src"] = __new_window_image_data;
        image_map["id"] = "button_new_window";
        image_map["onclick"] = "buttonNewWindowClicked(event)";
        //image_map["style"] = "right:5px;top:5px;";
        //image_map["style"] = "top:5px;right:" + (button_size * 2 + vertical_button_spacing * 1) + "px;";
        image_map["alt"] = "Open in new window";
        image_map["title"] = image_map["alt"];
        PageWrite(HTMLGenerateTagPrefix("img", image_map));
        
        PageWrite(spacing_div);
        image_map = mapCopy(base_image_map);
        image_map["src"] = __left_arrow_image_data;
        image_map["id"] = "button_arrow_right_left";
        image_map["onclick"] = "buttonRightLeftClicked(event)";
        //image_map["style"] = "right:5px;top:30px;";
        //image_map["style"] = "top:5px;right:" + (button_size * 3 + vertical_button_spacing * 2) + "px;";
        image_map["alt"] = "Show chat pane";
        image_map["title"] = image_map["alt"];
        PageWrite(HTMLGenerateTagPrefix("img", image_map));
        
        image_map = mapCopy(base_image_map);
        image_map["src"] = __right_arrow_image_data;
        image_map["id"] = "button_arrow_right_right";
        image_map["onclick"] = "buttonRightRightClicked(event)";
        //image_map["style"] = "right:5px;top:30px;";
        //image_map["style"] = "top:5px;right:" + (button_size * 3 + vertical_button_spacing * 2) + "px;";
        image_map["alt"] = "Hide chat pane";
        image_map["title"] = image_map["alt"];
        PageWrite(HTMLGenerateTagPrefix("img", image_map));
        
        
        
        if (true)
        {
        	PageWrite(spacing_div);
            image_map = mapCopy(base_image_map);
            image_map["src"] = __refresh_image_data;
            image_map["id"] = "button_refresh";
            image_map["onclick"] = "document.location.reload(true)";
            //image_map["style"] = "right:5px;top:5px;";
            //image_map["style"] = "top:5px;right:" + (button_size * 1 + vertical_button_spacing * 1) + "px;";
            image_map["alt"] = "Refresh";
            image_map["title"] = image_map["alt"];
            PageWrite(HTMLGenerateTagPrefix("img", image_map));
        }
        PageWrite("</div>");
    }
    
    
    if (__setting_newstyle_navbars)
    	__setting_fill_vertical = false;
    
    
    
    if (__setting_newstyle_navbars)
    {
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("class", "r_centre", "style", "display:flex;flex-direction:column;height:100vh;")));
    }
    if (!__setting_newstyle_navbars)
    	PageWrite(various_bar_buffer);
	

	int max_width_setting = __setting_horizontal_width;
	string main_holder_extra_style;
	if (__setting_newstyle_navbars)
		main_holder_extra_style = "flex-grow:1;flex-shrink:1;overflow-x:hidden;overflow-y:auto;";
    main_holder_extra_style += "width:100%;";
	
	
    
    
    
	PageWrite(HTMLGenerateTagPrefix("div", mapMake("id", "main_content_holder", "class", "r_centre", "style", main_holder_extra_style))); //centre holding container //"max-width:" + max_width_setting + "px;"
    if (true)
    {
        //Holding container:
        string style = "";
        style += "padding-top:5px;padding-bottom:0.25em;"; //max-width:" + max_width_setting + "px;
        if (!__setting_fill_vertical)
            style += "background-color:" + __setting_page_background_colour + ";";
        if (!__setting_side_negative_space_is_dark && !__setting_fill_vertical)
        {
            style += "border:1px solid;border-top:0px;border-bottom:1px solid;";
            style += "border-color:" + __setting_line_colour + ";";
        }
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", style)));
    }
    
    if (true)
    {
    	//showhide mouseover popup:
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "position:relative;")));
        PageWrite(HTMLGenerateTagWrap("div", "", mapMake("id", "showhide_mouseover_popup", "class", "showhide_mouseover_popup_class" )));
        PageWrite("</div>"); //showhide_mouseover_popup container
    }
    
	PageWrite(HTMLGenerateSpanOfStyle(guide_title, "font-weight:bold; font-size:1.5em"));
	
	outputChecklists(ordered_output_checklists);
	
    
    if (true)
    {
        //Gray text at the bottom:
        string line;
        line = HTMLGenerateTagWrap("span", "<br>Automatic refreshing disabled.", mapMake("id", "refresh_status"));
        line += HTMLGenerateTagWrap("a", "<br>Written by Ezandora.", generateMainLinkMap("showplayer.php?who=1557284"));
        line += "<br>" + __version;
        
        PageWrite(HTMLGenerateDivOfStyle(line, "font-size:0.777em;color:gray;"));
        
        /*if (false)
        {
        	boolean method_1_enabled = false;
            //Hacky layout, sorry:
            string [string] image_map;
            int size = 12;
            if (!method_1_enabled)
            {
            	size = 16;
            }
            image_map["width"] = size;
            image_map["height"] = size;
            image_map["class"] = "r_button";
            image_map["src"] = __refresh_image_data;
            image_map["id"] = "button_refresh";
            image_map["onclick"] = "document.location.reload(true)";
            if (method_1_enabled)
	            image_map["style"] = "position:relative;top:-12px;right:3px;visibility:visible;";
            else
	            image_map["style"] = "position:relative;visibility:visible;";
            image_map["alt"] = "Refresh";
            image_map["title"] = image_map["alt"];
            if (method_1_enabled)
	            PageWrite(HTMLGenerateDivOfStyle(HTMLGenerateTagPrefix("img", image_map), "width:100%;text-align:right;height:0px;")); //max-height:0px;
            else
            	PageWrite(HTMLGenerateDivOfStyle(HTMLGenerateTagPrefix("img", image_map), "position:fixed;right:" + (16) + "px;top:5px;z-index:1000;"));
        }*/
    }
    boolean matrix_enabled = false;
    if (my_path_id() == PATH_THE_SOURCE || $familiars[dataspider,Baby Bugged Bugbear] contains my_familiar())
    {
        matrix_enabled = !PreferenceGetBoolean("matrix disabled");
        if (true)
        {
            //We support disabling this feature, largely because it causes someone's browser to crash. Probably bad RAM.
            //I personally consider that to be a path-appropriate feature, but...
            string [string] image_map;
            image_map["width"] = "16";
            image_map["height"] = "16";
            image_map["class"] = "r_button";
            image_map["id"] = "button_refresh";
            image_map["style"] = "position:relative;top:-16px;left:3px;visibility:visible;";
            if (matrix_enabled)
            {
                image_map["src"] = __red_pill_image;
                image_map["onclick"] = "setMatrixStatus(true)";
                image_map["alt"] = "Matrix enabled";
            }
            else
            {
                image_map["src"] = __blue_pill_image;
                image_map["onclick"] = "setMatrixStatus(false)";
                image_map["alt"] = "Matrix disabled";
            }
            image_map["title"] = image_map["alt"];
            PageWrite(HTMLGenerateDivOfStyle(HTMLGenerateTagPrefix("img", image_map), "width:100%;text-align:left;")); //max-height:0px;
        }
    }
    
	PageWrite("</div>");
	PageWrite("</div>");
	
	if (!__setting_newstyle_navbars)
	{
        if (displaying_navbar) //in-div spacing at bottom for navbar
            PageWrite(HTMLGenerateDivOfStyle("", "min-height:" + (__setting_navbar_height_in_em - 0.05) + "em;"));
        if (__setting_show_location_bar) //in-div spacing at bottom for location bar
            PageWrite(HTMLGenerateDivOfStyle("", "min-height:" + (__setting_navbar_height_in_em - 0.05) + "em;"));
    }
    if (__setting_fill_vertical)
    {
        PageWrite(HTMLGenerateTagWrap("div", "", mapMake("class", "r_vertical_fill", "style", "z-index:-1;background-color:" + __setting_page_background_colour + ";"))); //Color fill //max-width:" + __setting_horizontal_width + "px;"
        PageWrite(HTMLGenerateTagWrap("div", "", mapMake("class", "r_vertical_fill", "style", "z-index:-11;border-left:1px solid;border-right:1px solid;border-color:" + __setting_line_colour + ";width:" + (__setting_horizontal_width) + "px;"))); //Vertical border lines, empty background
    }
    PageWriteHead("<script type=\"text/javascript\" src=\"GuideBrowserSide.js\"></script>");
    PageWriteHead("<script type=\"text/javascript\">function GuideParachuteInit() { if (typeof GuideInit !== 'function') { document.getElementById('extra_words_at_top').innerHTML = '<H1>Reinstall Guide</H1><H3>Installation is corrupted, missing javascript file GuideBrowserSide.js</H3>Functionality is limited.'}}</script>"); //mafia bug; we renamed a javascript file in a past release, and mafia will not always install a new file, silently breaking an installation
    
    if (matrix_enabled)
    {
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "opacity:0;visibility:hidden;background:black;position:fixed;top:0;left:0;z-index:303;width:100%;height:100%;", "id", "matrix_canvas_holder", "onclick", "matrixStopAnimation();", "onmousemove", "matrixStopAnimation();")));
        PageWrite(HTMLGenerateTagWrap("canvas", "", mapMake("width", "1", "height", "1", "id", "matrix_canvas", "style", "")));
        PageWrite("</div>");
        PageWrite(HTMLGenerateTagPrefix("img", mapMake("src", __matrix_glyphs, "id", "matrix_glyphs", "style", "display:none;")));
    }
    
    if (drunk)
        PageWrite("</div>");
    if (buggy)
        PageWrite("</div>");
        
        
    if (__setting_newstyle_navbars)
    {
        PageWrite(HTMLGenerateTagPrefix("div", mapMake("style", "")));
    	PageWrite(various_bar_buffer);
        PageWrite("</div>");
        PageWrite("</div>"); //main flexbox container
    }
    
    if (output_body_tag_only)
    	write(PageGenerateBodyContents());
    else
		PageGenerateAndWriteOut();
}

void main()
{
	__relay_filename = __FILE__;
    runMain();
}