name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby: [ '2.6.x', '2.5.x', '2.4.x', '2.3.x' ]
    steps:
    - uses: actions/checkout@master
    - name: Set up Ruby
      uses: actions/setup-ruby@v1
      with:
        version: ${{ matrix.ruby }}
    - name: Install dependencies
      run: |
        # As of 3 Jan 2019, Travis defaults to bundler 2.0 - https://docs.travis-ci.com/user/languages/ruby/#bundler-20
        # Linguist still requires Bundler 1.x due to Licensed.
        gem uninstall -v '>= 2' -ax bundler || true
        gem install bundler -v '< 2'
        # Fetch all commits/refs needed to run our tests.
        git fetch origin master:master v2.0.0:v2.0.0 test/attributes:test/attributes test/master:test/master
        # Replace SSH links to submodules by HTTPS links.
        sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
        # Fetch all grammar submodules
        git submodule init
        git submodule sync --quiet
        script/fast-submodule-update
        # Install Linguist gem dependencies
        bundle install --jobs 4 --retry 3 --without debug
    - name: Run tests
      run: bundle exec rake
    - name: Check Licenses
      run: script/licensed status
